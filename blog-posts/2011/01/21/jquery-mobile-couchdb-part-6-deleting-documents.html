
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2011/01/21/jquery-mobile-couchdb-part-6-deleting-documents/" title="Permanent link to jQuery Mobile + CouchDB: Part 6 – Deleting Documents" rel="bookmark" rev="post-344">jQuery Mobile + CouchDB: Part 6 – Deleting Documents</a></h1>
	
	<div class="entry-content full-content">
		<p>In my <a href="http://custardbelly.com/blog/?p=332" target="_blank">previous article</a>, I addressed adding documents to a <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database using the <em>jquery.couch</em> plugin along with a form within the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework. If you have been following along (and have been using with the application that is being built) that database might be filling up with album documents by now… but with no way to remove them!</p>
<p><em>“Why, late on Friday night, did I ever think I needed to catalog Starship’s ‘Knee Deep in the Hoopla’ as ‘my saving grace’?!”</em></p>
<p>… is one thing that you may say to yourself because there is currently no way to delete a document from the application we have built within this series. However, we have come to the final piece in basic document operations: the <strong>D</strong> in <strong>CRUD</strong>. Sit back down. I know it is exciting, but I have a lot of long-winded explanations to write so get ready.</p>
<p>In this article I am going to address adding the ability to delete a document from a <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database. While doing so, I will lightly cover the role that dialogs play in <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> and, in the end, hack it to present a <strong>dialog</strong> (our delete confirmation dialog) as an <strong>external page</strong> styled as a <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> dialog.</p>
<p><strong>In the following examples, I will assume that you have been following along from previous posts and will present updates to existing code.</strong></p>
<h2>Deleting Documents</h2>
<p>Before we just dive into adding a <strong>Delete</strong> button somewhere, let’s first think about its context within the application itself. If you have been following along with the previous posts, we have essentially 4 pages in our application:</p>
<ul>
<li>Home – Displays the full list of album documents.</li>
<li>Add Album – Provides form to an album document.</li>
<li>View Album – Displays information from the album document.</li>
<li>Edit Album – Provides form to edit the information on an album document.</li>
</ul>
<p>From this set of pages we can remove <strong>Home</strong> and <strong>Add Album</strong> as candidates to present a <strong>Delete</strong> button associated with a single document, as they have multiple and no album targets, respectively. So, that leaves us with <strong>View Album</strong> and <strong>Edit Album</strong>. A case can definitely be made that a <strong>Delete</strong> button should be available from the <strong>Edit Album</strong> page, but I think it would start to get crowded on that page with <strong>Save</strong>, <strong>Cancel</strong> and <strong>Delete</strong>… furthermore, it might be confusing to the User what <strong>Cancel</strong> actually referred to; cancel delete? cancel edit? I think the <strong>Delete</strong> button is much more suited to live alongside the <strong>Edit</strong> button in the <strong>View Album</strong> page.</p>
<p>So we know where the <strong>Delete</strong> button is going to reside. The role of the <strong>Delete</strong> button is to open a confirmation <strong>Dialog</strong> so the user can confirm their intent on deleting an album document, or deny it; they may have accidentally hit that button. Now an architectural decision needs to be addressed as to how to present this <strong>Delete</strong> dialog… should we have it as an internal page within the <em>album view</em> page that is served up from our <strong>show function</strong> in <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a>, or should it be an external page completely self manageable?</p>
<p>We can make a case for internal with obvious reasons being that a <em>delete dialog</em> is associated with a single document with which you want to perform an operation and our <em>album view</em> page represents a single album document. We also don’t necessarily need the <em>dialog page</em> to be accessed outside of the flow of the application. Meaning, it is not a requirement that the <em>delete dialog</em> is exposed to any user without having to open the application and select an album from the list. </p>
<p>So an <strong>internal</strong> dialog page might be a good fit, and in most cases I might push for it. Unfortunately, the current state of <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> makes the case for an external dialog page an easy one. If we were to add a dialog page to the <em>album view</em> <strong>template</strong> served up from our <strong>show function</strong> for an album, the elements would be all screwed up. I do not know if by design that is expected or if it is just a by-product of the templating and dynamic <strong>DOM</strong> that external pages provides. Either way, things get screwy adding a dialog page along side another page in an external <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page. So external dialog page, ahoy!</p>
<p>Wow, if you read that whole ramble, I am flattered and I hope it made sense. If you didn’t, i dont blame you; more code less talk.</p>
<h2>Delete Dialog</h2>
<p>We are going to create an <strong>external dialog page</strong> to present the user the ability to cancel out of the action or confim that they would like to delete the album document from the database. Now, typically when working with the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework, a dialog is assigned for a page anchor link with the <strong>data-rel</strong> attribute value set to “<em>dialog</em>“. For example:</p>
<div><pre><div class="line number1 index0 alt2"><code class="xml plain">&lt;</code><code class="xml keyword">a</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"_show/album-delete/12345"</code> <code class="xml color1">data-icon</code><code class="xml plain">=</code><code class="xml string">"minus"</code> <code class="xml color1">data-rel</code><code class="xml plain">=</code><code class="xml string">"dialog"</code><code class="xml plain">&gt;Delete&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;</code></div></pre></div>
<p>In essence, this attribute not only is responsible for the look-and-feel of the page, but also is an indicator that the <strong>url location</strong> should not be updated when the dialog page is loaded in the <strong>DOM</strong>. Makes sense – you shouldn’t have to hit back to get out of a dialog (though <strong>Android</strong> throws that use-case out the window with its context menus, which i think is still intuitive… but whatever).</p>
<p>But… we can’t do that. We need to use the <strong>$.mobile</strong>.<em>changePage</em>() method to present the delete dialog page from the album view page. The main reason being relative page locations in relation to <strong>show function</strong> requests. Basically we would have to invoke the <strong>show function</strong> to allow for the <em>delete dialog</em> to be presented using a relative path out of the current <em>album view</em> page. An updated example for our application would look like:</p>
<div><pre><div class="line number1 index0 alt2"><code class="xml plain">&lt;</code><code class="xml keyword">a</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"../../_show/album-delete/12345"</code> <code class="xml color1">data-icon</code><code class="xml plain">=</code><code class="xml string">"minus"</code> <code class="xml color1">data-rel</code><code class="xml plain">=</code><code class="xml string">"dialog"</code><code class="xml plain">&gt;Delete&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;</code></div></pre></div>
<p>To me, very ugly and not the correct way to enable this functionality. Furthermore, if we think back to how we implemented the <em>album view</em> page, we decided to clear the page from the <strong>DOM</strong> after navigating away from it. Essentially, within this context, showing the dialog would wipe the <strong>DOM</strong> of the <em>album view</em> page and when we choose to either confirm or deny or cancel deletion of the document, we would be returned to a blank page due to the inherent behaviour assigned to the role of a dialog in <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> (ie. the previous page is not loaded again using <strong>$.mobile</strong>.<em>changePage</em>()). Not ideal.</p>
<p>So we’ll just create an external <em>delete dialog</em> maintaining the look and feel by applying styles manually (instead of having the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework parse the <strong>DOM</strong> and apply them intrinsically). That way we can also encapsulate the logic used in deleting a document from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database using a <em>view-controller</em> associated with the dialog page.</p>
<h3>Delete Dialog show function</h3>
<p>With our minds made up on externalizing the <strong>Delete Dialog</strong> page, we’ll continue on with how we have made all our pages in this series. First up the <strong>show function</strong>. With your favorite text editor open, create a new document called <em>album-delete.js</em> in the /shows directory of your couchapp application folder (for me that is <em>/Documents/workspace/custardbelly/couchdb/albums</em>). Add the following script and save:</p>
<p><em>/shows/album-delete.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">function</code><code class="jscript plain">(doc, req) {</code></div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">Mustache = require(</code><code class="jscript string">"vendor/couchapp/lib/mustache"</code><code class="jscript plain">);</code></div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">stash = {</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">artist: doc.artist,</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">title : doc.title,</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document: doc._id</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">Mustache.to_html(</code><code class="jscript keyword">this</code><code class="jscript plain">.templates.albumdelete, stash, </code><code class="jscript keyword">this</code><code class="jscript plain">.templates.partials.albumdelete);</code></div><div class="line number9 index8 alt2"><code class="jscript plain">}</code></div></pre></div>
<p>Very similar to our other <strong>show function</strong>s for the view and edit pages, with just a little less information about the document in the <strong>stash</strong>. We’ve also got our template and partials declared in the <a href="https://github.com/janl/mustache.js/" target="_blank">Mustache</a> <em>to_html</em>() call, so let’s go ahead and create those.</p>
<h3>Delete Dialog template</h3>
<p>As I mentioned earlier, since our dialog is external and will be presented using <strong>$.mobile</strong>.<em>changePage</em>( ) we loose some niceties of styling pages as dialogs within the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework. As such, we are going to roll-up our sleeves and apply some classes and styles directly inline to fake the appearance of the delete album page as a dialog.</p>
<p>With you favorite text editor open, create and save the following mark-up as <em>albumdelete.html</em> in the <em>/templates</em> directory:</p>
<p><em>/templates/albumdelete.html</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"page"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albumdelete"</code> <code class="xml color1">data-backbtn</code><code class="xml plain">=</code><code class="xml string">"false"</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-dialog ui-body-a"</code><code class="xml plain">&gt;</code></div><div class="line number2 index1 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-header ui-bar-a ui-corner-top ui-overlay-shadow"</code><code class="xml plain">&gt;</code></div><div class="line number3 index2 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">h1</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-title"</code><code class="xml plain">&gt;Delete Album?&lt;/</code><code class="xml keyword">h1</code><code class="xml plain">&gt;</code></div><div class="line number4 index3 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">a</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"dialogCloseButton"</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#"</code> <code class="xml color1">data-icon</code><code class="xml plain">=</code><code class="xml string">"delete"</code> <code class="xml color1">data-iconpos</code><code class="xml plain">=</code><code class="xml string">"notext"</code> <code class="xml color1">style</code><code class="xml plain">=</code><code class="xml string">"left: 15px; top: .4em; position: absolute;"</code><code class="xml plain">&gt;Close&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;</code></div><div class="line number5 index4 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number6 index5 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"content"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"dialogContent"</code> <code class="xml color1">data-identity</code><code class="xml plain">=</code><code class="xml string">"{{document}}"</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-body-c ui-corner-bottom ui-overlay-shadow"</code><code class="xml plain">&gt;</code></div><div class="line number7 index6 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">p</code><code class="xml plain">&gt;Are you sure you want to delete {{artist}}, {{title}}?&lt;/</code><code class="xml keyword">p</code><code class="xml plain">&gt;</code></div><div class="line number8 index7 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">a</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"dialogCancelButton"</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"button"</code> <code class="xml color1">data-theme</code><code class="xml plain">=</code><code class="xml string">"a"</code><code class="xml plain">&gt;no&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;</code></div><div class="line number9 index8 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">a</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"dialogConfirmButton"</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"button"</code> <code class="xml color1">data-theme</code><code class="xml plain">=</code><code class="xml string">"c"</code><code class="xml plain">&gt;yes&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;</code></div><div class="line number10 index9 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number11 index10 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"footer"</code> <code class="xml plain">/&gt;</code></div><div class="line number12 index11 alt1"><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number13 index12 alt2"><code class="xml plain">{{&gt;scripts}}</code></div></pre></div>
<p>When you request to load an external page into the <strong>DOM</strong>, that page – or rather, i should say, the root <strong>div</strong> with the <strong>data-role</strong> value of <em>page</em> – is actually wrapped in another parent <strong>div</strong> with the <strong>data-role</strong> removed and transfered to the wrapping <strong>div</strong>. So keep that in the back of your mind as we will need to a little more pixel pushing in the <em>view-controller</em>. For now, understand that this mark-up is going to be wrapped by a <strong>div</strong>, and the page role of this page will be removed. </p>
<p>Now, in order to style the content of our page as a <strong>dialog</strong>, we explicitly set the root <strong>div</strong> <strong>class</strong> to <em>ui-dialog</em> which just throws in some margins to present more of a self contained box (like a dialog), and <em>ui-body-a</em> essentially being a base style for color and font treatments. </p>
<p>You may also notice the <strong>data-backbtn</strong> attribute thrown in there. I have rarely gotten it to work for an <strong>external page</strong> in the current stable release of <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> (1.0a2), but i threw it in there and crossed my fingers. In any event, we’ll handle the no back button issue manually, as we only want to display a close button just like all other default dialogs do in <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a>. </p>
<p>First step in that process: get rid of the <strong>header</strong>. You may notice that the first <strong>div</strong> in the children is not assigned a <strong>data-role</strong> of <em>header</em> or any other value. Instead, i peaked inside the <strong>JS</strong> and <strong>CSS</strong> of the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework and assigned in-line the <strong>class</strong> declarations given to a header in the context of a dialog. These classes are responsible for the colorization, size and corner-roundedness (not getting any spell-checking squigglies on that word!) of the <strong>div</strong>, which houses a custom <strong>Close</strong> button. Just as I went through and found the classes assigned to a <strong>header</strong> in a dialog, I went and found the specific styles given to the <strong>Close</strong> button that is added to the <strong>DOM</strong> inherently in <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> when a dialog is present. I have also done the same for the content, finishing the look-and-feel off with a different background color and bottom rounded corners.</p>
<p>This will look relatively just like any other dialog that is created/modified within the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework (at the current release, at least!). However, the background will not grow with its parent size (will be wrapped in a <strong>div</strong>), so the background treatment assigned to this page will not flow to the size of the page in the browser. To do that we’ll do some <a href="http://jquery.com/" target="_blank">jQuery</a> wizardry in the <em>view-controller</em> for this <em>delete dialog page</em>. In order to get there, let’s create our <strong>partial</strong> for this <strong>template</strong>.</p>
<p>With you favorite text editor open, create a file named <em>scripts.html</em>, add the following mark-up, and save it in <em>/templates/partials/albumdelete</em>:</p>
<p><em>/templates/partials/albumdelete/script.html</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="xml plain">&lt;</code><code class="xml keyword">script</code> <code class="xml color1">src</code><code class="xml plain">=</code><code class="xml string">"../../script/album-delete-dialog.js"</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">script</code><code class="xml plain">&gt;</code></div></pre></div>
<p>If you haven’t been following along in the series, this partial is just an organizational thing for me. I may be a little anal about where my code resides, and adding the <strong>JavaScript</strong> within the <strong>script</strong> declaration is totally acceptable; i just like having my scripts all in one place in a project.</p>
<p>OK. With that set, let’s get on to creating the <em>view-controller</em> for the <em>delete dialog page</em>.</p>
<h3>Delete Dialog View-Controller</h3>
<p>Before we jump in and create the script, let’s just make sure we are on the same page for the functionality of our <em>delete dialog page</em>. Like most dialogs, it presents the ability to confirm an action or cancel out of that action. So those are two pieces of functionality we need to implement in our <em>view-controller</em> for the page, with the confirmation being a <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> transaction. Actually… i think that is about it. Aside from some custom styling we will do in order for the page to be in full, it should be some smooth sailing. I am going to assume that you have been following along in the series and won’t go into the breadth of how the <em>view-controller</em> behaves, but rather the methods which we will implement on it.</p>
<p>With your favorite text editor open, create a new file called <em>album-delete-dialog.js</em>, add the following <strong>JavaScript</strong> and save in <em>/_attachments/script</em>:</p>
<p><em>/_attachments/script/album-delete-dialog.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">AlbumDeleteDialogController = </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleDialogViewHide()</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#dialogCloseButton"</code><code class="jscript plain">).die( </code><code class="jscript string">"click"</code><code class="jscript plain">, handleClose );</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#dialogCancelButton"</code><code class="jscript plain">).die( </code><code class="jscript string">"click"</code><code class="jscript plain">, handleClose );</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#dialogConfirmButton"</code><code class="jscript plain">).die( </code><code class="jscript string">"click"</code><code class="jscript plain">, handleDelete );</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#dialogContent"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">dialogCache =&nbsp; $(document.getElementById(</code><code class="jscript string">"_show/album-delete/"</code> <code class="jscript plain">+ docId));</code></div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">dialogCache.unbind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, handleDialogViewHide );</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">dialogCache.empty();</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">dialogCache.remove();</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleDialogView()</code></div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number18 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Watch for bound hide of page to clear from cache.</code></div><div class="line number19 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#dialogContent"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number20 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">dialogPage = $(document.getElementById(</code><code class="jscript string">"_show/album-delete/"</code> <code class="jscript plain">+ docId));</code></div><div class="line number21 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">dialogPage.bind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, handleDialogViewHide );</code></div><div class="line number22 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number23 index22 alt2">&nbsp;</div><div class="line number24 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleClose( event )</code></div><div class="line number25 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number26 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">event.preventDefault();</code></div><div class="line number27 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#dialogContent"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number28 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.mobile.changePage( </code><code class="jscript string">"_show/album/"</code> <code class="jscript plain">+ docId, </code><code class="jscript string">"slide"</code><code class="jscript plain">, </code><code class="jscript keyword">true</code><code class="jscript plain">, </code><code class="jscript keyword">true</code> <code class="jscript plain">);</code></div><div class="line number29 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">false</code><code class="jscript plain">;</code></div><div class="line number30 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number31 index30 alt2">&nbsp;</div><div class="line number32 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleDelete( event )</code></div><div class="line number33 index32 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number34 index33 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">event.preventDefault();</code></div><div class="line number35 index34 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#dialogContent"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number36 index35 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// First open doc based on ID in order to get full document.</code></div><div class="line number37 index36 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$db.openDoc( docId, {</code></div><div class="line number38 index37 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( document ) {</code></div><div class="line number39 index38 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Then use the opened doc as reference to remove.</code></div><div class="line number40 index39 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$db.removeDoc( document, {</code></div><div class="line number41 index40 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number42 index41 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.mobile.changePage( </code><code class="jscript string">"#home"</code><code class="jscript plain">, </code><code class="jscript string">"slide"</code><code class="jscript plain">, </code><code class="jscript keyword">true</code><code class="jscript plain">, </code><code class="jscript keyword">true</code> <code class="jscript plain">);</code></div><div class="line number43 index42 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number44 index43 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number45 index44 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">alert( </code><code class="jscript string">"Could not remove document with id: "</code> <code class="jscript plain">+ docId );</code></div><div class="line number46 index45 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number47 index46 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number48 index47 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number49 index48 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number50 index49 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">alert( </code><code class="jscript string">"Could not find document with id: "</code> <code class="jscript plain">+ docId );</code></div><div class="line number51 index50 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number52 index51 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number53 index52 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">false</code><code class="jscript plain">;</code></div><div class="line number54 index53 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number55 index54 alt2">&nbsp;</div><div class="line number56 index55 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">{</code></div><div class="line number57 index56 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">initialize: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number58 index57 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#dialogCloseButton"</code><code class="jscript plain">).live( </code><code class="jscript string">"click"</code><code class="jscript plain">, handleClose );</code></div><div class="line number59 index58 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#dialogCancelButton"</code><code class="jscript plain">).live( </code><code class="jscript string">"click"</code><code class="jscript plain">, handleClose );</code></div><div class="line number60 index59 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#dialogConfirmButton"</code><code class="jscript plain">).live( </code><code class="jscript string">"click"</code><code class="jscript plain">, handleDelete);</code></div><div class="line number61 index60 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Do pagebefore so when it is shown, it is filled correctly.</code></div><div class="line number62 index61 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).live( </code><code class="jscript string">"pagebeforeshow"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number63 index62 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).die( </code><code class="jscript string">"pagebeforeshow"</code> <code class="jscript plain">);</code></div><div class="line number64 index63 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#dialogContent"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number65 index64 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">dialogPage = $(document.getElementById(</code><code class="jscript string">"_show/album-delete/"</code> <code class="jscript plain">+ docId));</code></div><div class="line number66 index65 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">dialog = $(</code><code class="jscript string">"#albumdelete"</code><code class="jscript plain">);</code></div><div class="line number67 index66 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">h = parseFloat(dialogPage.innerHeight());</code></div><div class="line number68 index67 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">h -= ( parseFloat(dialog.css(</code><code class="jscript string">"border-top-width"</code><code class="jscript plain">)) + parseFloat(dialog.css(</code><code class="jscript string">"border-bottom-width"</code><code class="jscript plain">)) );</code></div><div class="line number69 index68 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// define the height based on innerHeight of wrapping parent page and the border styles applied to a dialog.</code></div><div class="line number70 index69 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">dialog.css( </code><code class="jscript string">"height"</code><code class="jscript plain">, h + </code><code class="jscript string">"px"</code> <code class="jscript plain">);</code></div><div class="line number71 index70 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number72 index71 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).live( </code><code class="jscript string">"pageshow"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number73 index72 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).die( </code><code class="jscript string">"pageshow"</code> <code class="jscript plain">);</code></div><div class="line number74 index73 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">handleDialogView();</code></div><div class="line number75 index74 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number76 index75 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number77 index76 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number78 index77 alt1"><code class="jscript plain">}();</code></div><div class="line number79 index78 alt2">&nbsp;</div><div class="line number80 index79 alt1"><code class="jscript keyword">function</code> <code class="jscript plain">handleDialogReady()</code></div><div class="line number81 index80 alt2"><code class="jscript plain">{</code></div><div class="line number82 index81 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">AlbumDeleteDialogController.initialize();</code></div><div class="line number83 index82 alt2"><code class="jscript plain">}</code></div><div class="line number84 index83 alt1"><code class="jscript plain">$().ready( handleDialogReady )</code></div></pre></div>
<p>That might be a lot to digest all at once, but it has the same functionality as the other <em>view-controllers</em> we have created in this series. Essentially, It manages the removal of the page from the <strong>DOM</strong> on navigation away. A user will be navigated to the previous – <em>album view</em> – page on cancel/close or be taken to the <strong>#home</strong> page with the updated list of albums after confirmation of delete and success of the transaction from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance. Let’s take a closer look on how that is done:</p>
<p><em>/_attachments/script/album-delete-dialog.js</em></p>
<div><pre><div class="line number32 index0 alt1"><code class="jscript keyword">function</code> <code class="jscript plain">handleDelete( event )</code></div><div class="line number33 index1 alt2"><code class="jscript plain">{</code></div><div class="line number34 index2 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">event.preventDefault();</code></div><div class="line number35 index3 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#dialogContent"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number36 index4 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// First open doc based on ID in order to get full document.</code></div><div class="line number37 index5 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$db.openDoc( docId, {</code></div><div class="line number38 index6 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( document ) {</code></div><div class="line number39 index7 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Then use the opened doc as reference to remove.</code></div><div class="line number40 index8 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$db.removeDoc( document, {</code></div><div class="line number41 index9 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number42 index10 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.mobile.changePage( </code><code class="jscript string">"#home"</code><code class="jscript plain">, </code><code class="jscript string">"slide"</code><code class="jscript plain">, </code><code class="jscript keyword">true</code><code class="jscript plain">, </code><code class="jscript keyword">true</code> <code class="jscript plain">);</code></div><div class="line number43 index11 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number44 index12 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number45 index13 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">alert( </code><code class="jscript string">"Could not remove document with id: "</code> <code class="jscript plain">+ docId );</code></div><div class="line number46 index14 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number47 index15 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number48 index16 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number49 index17 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number50 index18 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">alert( </code><code class="jscript string">"Could not find document with id: "</code> <code class="jscript plain">+ docId );</code></div><div class="line number51 index19 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number52 index20 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number53 index21 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">false</code><code class="jscript plain">;</code></div><div class="line number54 index22 alt1"><code class="jscript plain">}</code></div></pre></div>
<p>We first grab the document id assigned to the <strong>data-identity</strong> attribute of the content <strong>div</strong> and use that to open the document from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database using the declared <strong>$db</strong> instance on the <em>index.html</em> (of which this page is loaded into). On success of opening the document, we make a request to remove it from the database using the <em>removeDoc</em>() method from the <em>jquery.couch</em> plugin. Upon success of removal from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database, we then navigate back to the <strong>#home</strong> page where the list is updated accordingly to reflect the removal of the album document.</p>
<p>Now the fun part! In order to have the original <strong>div</strong> (assigned the <strong>data-role</strong> of <em>page</em> in our <strong>template</strong>) fill its background to its wrapping parent (assigned by <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> upon load of external page) we need to do some <a href="http://jquery.com/" target="_blank">jQuery</a> to grab the dimensions of the wrapping page <strong>div</strong> and the assigned styles on the dialog to reset the dimensions of the dialog to fill its background to the page.</p>
<p><em>/_attachments/script/album-delete-dialog.js</em></p>
<div><pre><div class="line number62 index0 alt1"><code class="jscript comments">// Do pagebefore so when it is shown, it is filled correctly.</code></div><div class="line number63 index1 alt2"><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).live( </code><code class="jscript string">"pagebeforeshow"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number64 index2 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).die( </code><code class="jscript string">"pagebeforeshow"</code> <code class="jscript plain">);</code></div><div class="line number65 index3 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#dialogContent"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number66 index4 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">dialogPage = $(document.getElementById(</code><code class="jscript string">"_show/album-delete/"</code> <code class="jscript plain">+ docId));</code></div><div class="line number67 index5 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">dialog = $(</code><code class="jscript string">"#albumdelete"</code><code class="jscript plain">);</code></div><div class="line number68 index6 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">h = parseFloat(dialogPage.innerHeight());</code></div><div class="line number69 index7 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">h -= ( parseFloat(dialog.css(</code><code class="jscript string">"border-top-width"</code><code class="jscript plain">)) + parseFloat(dialog.css(</code><code class="jscript string">"border-bottom-width"</code><code class="jscript plain">)) );</code></div><div class="line number70 index8 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// define the height based on innerHeight of wrapping parent page and the border styles applied to a dialog.</code></div><div class="line number71 index9 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">dialog.css( </code><code class="jscript string">"height"</code><code class="jscript plain">, h + </code><code class="jscript string">"px"</code> <code class="jscript plain">);</code></div><div class="line number72 index10 alt1"><code class="jscript plain">});</code></div></pre></div>
<p>The <strong>dialogPage</strong> is the parent <strong>div</strong> for the external <em>delete dialog page</em> (the <strong>template</strong> previously created in this article). As mentioned before that is created and wrapped around the external page inherently within the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework when the page is loaded into the <strong>DOM</strong>. </p>
<p>That wrapping parent is assigned the <strong>id</strong> of the url location shown in the <strong>hash</strong>, and is accessed using <em>getElementById</em>(). There might be some other tricks to access that div using <strong>class*=’ui-page’</strong>. It is also assigned a <strong>class</strong> of <em>ui-page-active</em>, but that is only after it has been shown. Since we assign a handler for <em>pagebeforeshow</em>, that class has yet to be assigned so we can’t access it that way using <a href="http://jquery.com/" target="_blank">jQuery</a>. Listening and assigning these property during the <em>pagebeforeshow</em> event also has the added benefit of sizing the dialog background correctly before the user sees it.</p>
<p>Alright. So we have faked our external page to be presented as a dialog normally shown through the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework by assigning the <strong>data-rel</strong> on a page link. Now we have to go about modifying the code so we can show it…</p>
<h2>Modifying Album View Page</h2>
<p>Way back in the beginning of this article before i started yammering on about this and that, we resolved that the <strong>Delete</strong> button should be an additional UI piece to the album view page. If you have been following along in this series, we added the <strong>Edit</strong> button a couple articles back to the <em>album view</em> page. It was represented by a <strong>p</strong> element with the <strong>data-role</strong> of <em>button</em> and positioned vertically below the document information fields. Quite ugly, but reasonable for the time.</p>
<p>To get into more of a consistant look and feel, we are going to add a navigation bar to the <em>album view</em> page, just as we have done for the <strong>#home</strong> page in the last article. The <strong>navbar</strong> for the <em>album view</em> page will consists of two buttons – <strong>Edit</strong> and <strong>Delete</strong> – and we’ll also throw in some styling to give them unique enough color treatments.</p>
<p>In your favorite text editor, open the <em>/templates/album.html</em> document and make the following modifications:</p>
<p><em>/templates/album.html</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"page"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albumview"</code> <code class="xml color1">data-position</code><code class="xml plain">=</code><code class="xml string">"inline"</code> <code class="xml color1">data-back</code><code class="xml plain">=</code><code class="xml string">"true"</code><code class="xml plain">&gt;</code></div><div class="line number2 index1 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"header"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albumheader"</code><code class="xml plain">&gt;</code></div><div class="line number3 index2 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">h1</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"albumtitle"</code><code class="xml plain">&gt;{{title}}&lt;/</code><code class="xml keyword">h1</code><code class="xml plain">&gt;</code></div><div class="line number4 index3 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">a</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#home"</code> <code class="xml color1">data-icon</code><code class="xml plain">=</code><code class="xml string">"grid"</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-btn-right"</code><code class="xml plain">&gt;Home&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;</code></div><div class="line number5 index4 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number6 index5 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"content"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albumcontent"</code> <code class="xml color1">data-identity</code><code class="xml plain">=</code><code class="xml string">"{{document}}"</code><code class="xml plain">&gt;</code></div><div class="line number7 index6 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">h2</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"artist"</code><code class="xml plain">&gt;{{artist}}&lt;/</code><code class="xml keyword">h2</code><code class="xml plain">&gt;</code></div><div class="line number8 index7 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">p</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"title"</code><code class="xml plain">&gt;{{title}}&lt;/</code><code class="xml keyword">p</code><code class="xml plain">&gt;</code></div><div class="line number9 index8 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">p</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"description"</code><code class="xml plain">&gt;{{description}}&lt;/</code><code class="xml keyword">p</code><code class="xml plain">&gt;</code></div><div class="line number10 index9 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number11 index10 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"falseFooter"</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-bar-a ui-footer ui-footer-fixed ui-fixed-inline fade"</code> <code class="xml color1">role</code><code class="xml plain">=</code><code class="xml string">"content"</code> <code class="xml color1">data-position</code><code class="xml plain">=</code><code class="xml string">"fixed"</code><code class="xml plain">&gt;</code></div><div class="line number12 index11 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"navbar"</code><code class="xml plain">&gt;</code></div><div class="line number13 index12 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">ul</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-grid-a"</code><code class="xml plain">&gt;</code></div><div class="line number14 index13 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">li</code><code class="xml plain">&gt;&lt;</code><code class="xml keyword">a</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"deleteButton"</code> <code class="xml color1">data-icon</code><code class="xml plain">=</code><code class="xml string">"minus"</code><code class="xml plain">&gt;Delete&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">li</code><code class="xml plain">&gt;</code></div><div class="line number15 index14 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">li</code><code class="xml plain">&gt;&lt;</code><code class="xml keyword">a</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"editButton"</code> <code class="xml color1">data-icon</code><code class="xml plain">=</code><code class="xml string">"gear"</code> <code class="xml color1">data-theme</code><code class="xml plain">=</code><code class="xml string">"b"</code><code class="xml plain">&gt;Edit&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">li</code><code class="xml plain">&gt;</code></div><div class="line number16 index15 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">ul</code><code class="xml plain">&gt;</code></div><div class="line number17 index16 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number18 index17 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number19 index18 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"footer"</code> <code class="xml color1">data-position</code><code class="xml plain">=</code><code class="xml string">"fixed"</code> <code class="xml plain">/&gt;</code></div><div class="line number20 index19 alt1"><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number21 index20 alt2"><code class="xml plain">{{&gt;scripts}}</code></div></pre></div>
<p>We got rid of the previous <strong>Edit</strong> button element and added it to a list of buttons in a <strong>navbar</strong>. Alongside the <strong>Edit</strong> button, we have added the <strong>Delete</strong> button. We also added some icons and applied a theme to the <strong>Edit</strong> button to give it a blue color so as to be immediately distinguishable from an action to delete the album document.</p>
<p>You may notice that we actually did not add the <strong>navbar</strong> to the <strong>footer</strong> as we did for the home page. The reason being that there is a bug in the current stable release for <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> that screwed up the layout if we did that. <em>Even though I have mentioned bugs in the jQuery Mobile framework, the beauty is we can easily work around most of them by either faking the HTML mark-up or using jQuery to modify properties; that is always a win in my book.</em> So we created a false footer and assigned it the classes that would normally be assigned to a footer from the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework, and with a <strong>data-position</strong> of <em>fixed</em>, it should always appear at the bottom of the page (it won’t really, but we will modify the <em>view-controller</em> to put it there). </p>
<p>Now, we needed to leave the <strong>footer</strong> tag in this template because, you guessed it, a bug in <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a>. If we omitted that <strong>footer</strong> on an external document, the <em>ready</em> event is never fired – bad news. So we threw it in with a <strong>data-position</strong> of <em>fixed</em> so it is always at the bottom. Woohoo! Our page has been updated. Let’s wired up some operations so we can show our <em>delete album dialog</em>.</p>
<h3>Modifying Album View-Controller</h3>
<p>Before we get into this, i must profess that we are going to do something gross. I don’t particularly like it, but it is a fast and cheap way to get the result we want. Let’s get into it and see if i can dig myself out…</p>
<p>In your favorite text editor, open the <em>/_attachments/script/album-page.js</em> document and make the following modifications:</p>
<p><em>/_attachments/script/album-page.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">AlbumPageController = </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">/* RIPPED FROM jquerymobile-1.0a2.js */</code></div><div class="line number4 index3 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">getOffsetTop(ele)</code></div><div class="line number5 index4 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number6 index5 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">top = 0;</code></div><div class="line number7 index6 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code> <code class="jscript plain">(ele)</code></div><div class="line number8 index7 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number9 index8 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">op = ele.offsetParent, body = document.body;</code></div><div class="line number10 index9 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">top = ele.offsetTop;</code></div><div class="line number11 index10 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">while</code> <code class="jscript plain">(ele &amp;&amp; ele != body)</code></div><div class="line number12 index11 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number13 index12 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">top += ele.scrollTop || 0;</code></div><div class="line number14 index13 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code> <code class="jscript plain">(ele == op)</code></div><div class="line number15 index14 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number16 index15 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">top += op.offsetTop;</code></div><div class="line number17 index16 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">op = ele.offsetParent;</code></div><div class="line number18 index17 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number19 index18 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">ele = ele.parentNode;</code></div><div class="line number20 index19 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number21 index20 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number22 index21 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">top;</code></div><div class="line number23 index22 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number24 index23 alt1 highlighted">&nbsp;</div><div class="line number25 index24 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">setTop(el){</code></div><div class="line number26 index25 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">fromTop = $(window).scrollTop(),</code></div><div class="line number27 index26 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">thisTop = getOffsetTop(el[0]), </code><code class="jscript comments">// el.offset().top returns the wrong value on iPad iOS 3.2.1, call our workaround instead.</code></div><div class="line number28 index27 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">thisCSStop = el.css(</code><code class="jscript string">'top'</code><code class="jscript plain">) == </code><code class="jscript string">'auto'</code> <code class="jscript plain">? 0 : parseFloat(el.css(</code><code class="jscript string">'top'</code><code class="jscript plain">)),</code></div><div class="line number29 index28 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">screenHeight = window.innerHeight,</code></div><div class="line number30 index29 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">thisHeight = el.outerHeight(),</code></div><div class="line number31 index30 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">useRelative = el.parents(</code><code class="jscript string">'.ui-page:not(.ui-page-fullscreen)'</code><code class="jscript plain">).length,</code></div><div class="line number32 index31 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">relval;</code></div><div class="line number33 index32 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( el.is(</code><code class="jscript string">'.ui-header-fixed'</code><code class="jscript plain">) ){</code></div><div class="line number34 index33 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">relval = fromTop - thisTop + thisCSStop;</code></div><div class="line number35 index34 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( relval &lt; thisTop){ relval = 0; }</code></div><div class="line number36 index35 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">el.css(</code><code class="jscript string">'top'</code><code class="jscript plain">, ( useRelative ) ? relval : fromTop);</code></div><div class="line number37 index36 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number38 index37 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">else</code><code class="jscript plain">{</code></div><div class="line number39 index38 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">//relval = -1 * (thisTop - (fromTop + screenHeight) + thisCSStop + thisHeight);</code></div><div class="line number40 index39 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">//if( relval &gt; thisTop ){ relval = 0; }</code></div><div class="line number41 index40 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">relval = fromTop + screenHeight - thisHeight - (thisTop - thisCSStop);</code></div><div class="line number42 index41 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">el.css(</code><code class="jscript string">'top'</code><code class="jscript plain">, ( useRelative ) ? relval : fromTop + screenHeight - thisHeight );</code></div><div class="line number43 index42 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number44 index43 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number45 index44 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">/* END RIPPED FROM jquerymobile-1.0a2.js */</code></div><div class="line number46 index45 alt1">&nbsp;</div><div class="line number47 index46 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleView()</code></div><div class="line number48 index47 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number49 index48 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">setTop( $(</code><code class="jscript string">"#falseFooter"</code><code class="jscript plain">) );</code></div><div class="line number50 index49 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#editButton"</code><code class="jscript plain">).live( </code><code class="jscript string">"click"</code><code class="jscript plain">, handleEdit );</code></div><div class="line number51 index50 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#deleteButton"</code><code class="jscript plain">).live( </code><code class="jscript string">"click"</code><code class="jscript plain">, handleDelete );</code></div><div class="line number52 index51 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Watch for bound hide of page to clear from cache.</code></div><div class="line number53 index52 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumcontent"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number54 index53 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">albumPage = $(document.getElementById(</code><code class="jscript string">"_show/album/"</code> <code class="jscript plain">+ docId));</code></div><div class="line number55 index54 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">albumPage.bind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, handlePageViewHide );</code></div><div class="line number56 index55 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number57 index56 alt2">&nbsp;</div><div class="line number58 index57 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleEdit( event )</code></div><div class="line number59 index58 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number60 index59 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Prevent default link event.</code></div><div class="line number61 index60 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">event.preventDefault();</code></div><div class="line number62 index61 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Access document id from data-identity.</code></div><div class="line number63 index62 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumcontent"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number64 index63 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Change page.</code></div><div class="line number65 index64 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.mobile.changePage( </code><code class="jscript string">"_show/album-edit/"</code> <code class="jscript plain">+ docId, </code><code class="jscript string">"flip"</code><code class="jscript plain">, </code><code class="jscript keyword">false</code><code class="jscript plain">, </code><code class="jscript keyword">true</code> <code class="jscript plain">);</code></div><div class="line number66 index65 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">false</code><code class="jscript plain">;</code></div><div class="line number67 index66 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number68 index67 alt1">&nbsp;</div><div class="line number69 index68 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleDelete( event )</code></div><div class="line number70 index69 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number71 index70 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Prevent default link event.</code></div><div class="line number72 index71 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">event.preventDefault();</code></div><div class="line number73 index72 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Access document id from data-identity.</code></div><div class="line number74 index73 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumcontent"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number75 index74 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Change page.</code></div><div class="line number76 index75 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.mobile.changePage( </code><code class="jscript string">"_show/album-delete/"</code> <code class="jscript plain">+ docId, </code><code class="jscript string">"slideup"</code><code class="jscript plain">, </code><code class="jscript keyword">false</code><code class="jscript plain">, </code><code class="jscript keyword">false</code> <code class="jscript plain">);</code></div><div class="line number77 index76 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">false</code><code class="jscript plain">;</code></div><div class="line number78 index77 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number79 index78 alt2">&nbsp;</div><div class="line number80 index79 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handlePageViewHide()</code></div><div class="line number81 index80 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number82 index81 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#editButton"</code><code class="jscript plain">).die( </code><code class="jscript string">"click"</code><code class="jscript plain">, handleEdit );</code></div><div class="line number83 index82 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#deleteButton"</code><code class="jscript plain">).die( </code><code class="jscript string">"click"</code><code class="jscript plain">, handleDelete );</code></div><div class="line number84 index83 alt1">&nbsp;</div><div class="line number85 index84 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumcontent"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number86 index85 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">albumPageCache =&nbsp; $(document.getElementById(</code><code class="jscript string">"_show/album/"</code> <code class="jscript plain">+ docId));</code></div><div class="line number87 index86 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">albumPageCache.unbind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, handlePageViewHide );</code></div><div class="line number88 index87 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">albumPageCache.empty();</code></div><div class="line number89 index88 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">albumPageCache.remove();</code></div><div class="line number90 index89 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number91 index90 alt2">&nbsp;</div><div class="line number92 index91 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">{</code></div><div class="line number93 index92 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">initialize : </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number94 index93 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).live( </code><code class="jscript string">"pageshow"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number95 index94 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).die( </code><code class="jscript string">"pageshow"</code> <code class="jscript plain">);</code></div><div class="line number96 index95 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">handleView();</code></div><div class="line number97 index96 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number98 index97 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number99 index98 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number100 index99 alt1"><code class="jscript plain">}();</code></div><div class="line number101 index100 alt2">&nbsp;</div><div class="line number102 index101 alt1"><code class="jscript keyword">function</code> <code class="jscript plain">handlePageViewReady()</code></div><div class="line number103 index102 alt2"><code class="jscript plain">{</code></div><div class="line number104 index103 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">AlbumPageController.initialize();</code></div><div class="line number105 index104 alt2"><code class="jscript plain">}</code></div><div class="line number106 index105 alt1"><code class="jscript plain">$().ready( handlePageViewReady );</code></div></pre></div>
<p>You notice those first two methods? Yeah, i just copied and pasted them from the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> script. They are private methods of the “<em>fixedHeaderFooter</em>” plugin of the framework. We needed them to position our false footer <strong>navbar</strong>, so i ripped ‘em. Wait! Don’t leave. I am not happy about it either. Hopefully they will be exposed utilities in a later release of the framework, or we could go about creating our own so they are accessible outside of this page, but for now you gotta do what you gotta do.</p>
<p>Upon show of the page we use those methods to position the false footer <strong>navbar</strong> at the bottom. Sure, in the real world a client – our rather your team since you know about it! – would log a bug, but we’re just having fun right? I hope so.</p>
<p>The other modification was to wire up the <strong>Delete</strong> button to show the <em>delete album dialog</em> page we previously created. We employed the same operations we have done throughout this series to navigating to a page: access the document <strong>id</strong> and call <strong>$.mobile</strong>.<em>changePage</em>() to serve up the filled template form <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a>. Done and done. Let’s get all <strong>Salt-N-Pepa</strong> up in here and Push It.</p>
<h3>Deployment</h3>
<p>We modified our application to have the ability to delete an album document from the database by adding a new <em>delete dialog</em> page and updating the UI of the album view page. With these changes saved, we can now push to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database using the <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> utility. Open a terminal and navigate to the directory where you create your <strong>CouchApp</strong> applications (for me that is <em>/Documents/workspace/custardbelly/couchdb</em> and in there i have a folder named <em>albums</em> which is the <strong>CouchApp</strong> application directory for these examples). Enter the following command to push the changes to the <strong>CouchDB</strong> instance:</p>
<div><pre><div class="line number1 index0 alt2"><code class="bash plain">couchapp push albums http:</code><code class="bash plain">//127</code><code class="bash plain">.0.0.1:5984</code><code class="bash plain">/albums</code></div></pre></div>
<p>If all was successful and you now go to <a href="http://127.0.0.1:5984/albums/_design/albums/index.html" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html</a>. Select an album from the the list on the landing page, and click the <strong>Delete</strong> button from the <em>album view</em> page. Choose to delete, cancel or close and you should be navigated to the correct page: <strong>#home</strong> if delete, album view if cancel/close. These updated and new pages should look somewhat like the following:</p>
<p><em>updated album view</em><br>
<img src="http://www.custardbelly.com/blog/images/couchapp_album_view2.png"></p>
<p><em>delete album dialog</em><br>
<img src="http://www.custardbelly.com/blog/images/couchapp_delete_dialog.png"></p>
<h3>Conclusion</h3>
<p>In this article, we finished off having the basic operations for handling documents in our application. We can now create, read, update and delete documents from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database. Along the way, we covered a few ways to hack things together for an application utilizing the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework; some were work-arounds due to bugs, some were just design decisions. In any event, I hope it was informative if not fun.</p>
<p>Next up: I am wavering between authentication or attachments… you’ll have to wait and see!</p>
<p><em>[Note] This post was written against the following software versions:</em><br>
<strong>CouchDB </strong>– 1.0.1<br>
<strong>CouchApp</strong> – 0.7.2<br>
<strong>jQuery</strong> – 1.4.4<br>
<strong>jQuery Mobile</strong> – 1.0a2<br>
<em>If you have found this post and any piece has moved forward, hopefully the examples are still viable/useful. I will not be updating the examples in this post in parellel with updates to any of the previously mentioned software, unless explicitly noted.</em></p>
<p><strong>Articles in this series:</strong></p>
<ol>
<li><a href="http://custardbelly.com/blog/?p=244" target="_blank">Getting Started</a></li>
<li><a href="http://custardbelly.com/blog/?p=278" target="_blank">Displaying a page detail of a single album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=297" target="_blank">Templates and Mustache</a></li>
<li><a href="http://custardbelly.com/blog/?p=318" target="_blank">Displaying an editable page of an album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=332" target="_blank">Creating and Adding an album document.</a></li>
<li><a href="http://custardbelly.com/blog/?p=344" target="_blank">Deleting an album document</a></li>
<li><a href="http://custardbelly.com/blog/?p=360" target="_blank">Authorization and Validation – Part 1</a></li>
<li><a href="http://custardbelly.com/blog/?p=394">Authorization and Validation – Part 2</a></li>
</ol>
<p><a href="http://custardbelly.com/downloads/couchapp/jqm_couchdb_albums.zip">Full source for albums couchapp here.</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/couchdb/" title="View all posts in CouchDB" rel="category tag">CouchDB</a>,  <a href="http://custardbelly.com/blog/category/jquery/" title="View all posts in jquery" rel="category tag">jquery</a>,  <a href="http://custardbelly.com/blog/category/jquery-mobile/" title="View all posts in jquery-mobile" rel="category tag">jquery-mobile</a>.</p>
	
	

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">–</span> <abbr class="published" title="2011-01-21T11:38">January 21, 2011</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-344-target"></div>
	<div class="clear"></div>
	
	