
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii/" title="Permanent link to The Making of a Test-Driven Grocery List Application in JS: Part III" rel="bookmark" rev="post-636">The Making of a Test-Driven Grocery List Application in JS: Part III</a></h1>
	
	<div class="entry-content full-content">
		<p><em>This is the third installment in a series of building a Test-Driven Grocery List application using <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> and <a href="http://requirejs.org" target="_blank">RequireJS</a>. To learn more about the intent and general concept of the series please visit <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i/">The Making of a Test-Driven Grocery List Application in JavaScript: Part I</a></em><br>
—</p>
<h1>Introduction</h1>
<p>In the <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii/">previous article</a>, I addressed adding the first feature to the <strong>Grocery List</strong> application: <em>Add Item</em>. Trying my best to adhere to the TDD/BDD philosophy, a story and a couple scenarios were drummed up prior to implementation development using language similar to that described in <a href="http://dannorth.net/introducing-bdd/" target="_blank">Dan Worth’s Introducing BDD article</a>. Once passing, the code written within the test was moved to its own file(s) with dependencies updated in the specs and tests run again to confirm passing against the implementations.</p>
<p>I will take the same approach in adding a new feature in this article: <em>Mark-Off Item</em>. </p>
<p>I suspect, however, that I may actually end up creating stories for more of what can be considered <em>integration</em>. Since the last post, I stumbled upon a <a href="http://chrismdp.com" target="_blank">great blog from Chris Parsons</a> that covers BDD (with a bend toward Cucumber), and in particular the article <a href="http://chrismdp.com/2012/11/the-integration-testing-trap/" target="_blank">Cucumber: the integration test trap</a> provided some great insight into the difference between acceptance and integration testing. In the previous article, I suppose more of what was done could be considered acceptance testing. Some implementation details are testing against in the <em>Add-Item</em> feature (for instance, the item API on the list-controller), but I sort of threw in extra code and UX/UI implementation details at the end just so I could make sure the code was actually usable in a real-life scenario. At the time, I felt that writing specs for the integration of features – what i consider more fine-grained in testing that an element is added to the DOM upon an API call – would muddle down the intent of this series. I might take back that assumption. That may lead to longer posts… you have been forewarned <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley"> </p>
<h1>Mark-Off Feature</h1>
<p>There are basically 3 states to an item in the grocery store: </p>
<ol>
<li>unpossessed</li>
<li>unpurchased</li>
<li>owned</li>
</ol>
<p>Once owned… well it either gets eaten or is freed into the wild – through those seemingly impenetrable automatic doors of unpurchased state, into the world of natural lighting. As well, prior to own-ed-ship, the item is in limbo as to whether or not it can reach that state – it might be placed back on the shelf to be forever unpossessed again. (You don’t want me to go over the possessed state.) Not unlike the life a a loaf of bread in a store, so too are the states of the grocery list items of the <strong>Grocery List</strong> application.</p>
<p>By adding an item – the feature completed in the <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i/">previous article</a> – a User has essentially identified an item not in possession, with the end goal of being owned. As a User of the application, we want to be able to denote the item as being in possession, but not purchased. The unpurchased state will notify other Users of the list that it no longer needs to be obtained. However, it will still be allowed to be unmarked and back to unpossessed – say if someone got <strong>Miracle Whip</strong> mayo instead of <strong>Helmann’s</strong> (whole ‘nother argument).</p>
<p>So we have essentially defined the feature for this post in the series: being able to mark and unmark an item added to the grocery list.</p>
<p><em>// story</em><br>
—<br>
<strong>Story:</strong> Item is marked off on grocery list</p>
<p><strong>In order to</strong> remember what items have already made it to the cart<br>
<strong>As a</strong> grocery shopper<br>
<strong>I want to</strong> mark an item as being attained on the grocery list.<br>
—</p>
<p>Similarly, since the item will still be available from the <strong>Grocer List</strong> application and only considered marked off, we could write up another story of being able to unmark an item from the list. For brevity’s sake, I should probably do that and if we were actually incorporating DSLs and tools that would facilitate in BDD testing, I probably would. But for the sake of this article, we’ll leave that as an added scenario to this feature.</p>
<p><em>// spec</em><br>
—<br>
<strong>Scenario 1:</strong> Item is marked off on grocery list<br>
<strong>Given</strong> a user has saved an item to the list<br>
<strong>When</strong> she requests to mark off the item<br>
<strong>Then</strong> the item is presented differently to the user, denoting in possession<br>
<strong>And</strong> the item is not removed from the list<br>
—</p>
<p>Okay. I’ll admit. The desired outcome from that scenario is a little vague. But the scenarios I am writing – as discussed before, after having read <a href="http://chrismdp.com/2012/11/the-integration-testing-trap/" target="_blank">this article from Chris Parsons</a> – are more loosely acceptance criteria. As a developer, it makes me squirm a little because I know there is much more that can be described in this scenario, especially as it pertains to UI and UX. Aspects such as those can be considered more as integration points and I may circle back for more scenarios involving more of what we, as developers, are affirming in our tests (ie, design and functionality).</p>
<p>Anyway, undoing as well:</p>
<p><em>// spec</em><br>
—<br>
<strong>Scenario 2:</strong> Item is un-marked off on grocery list<br>
<strong>Given</strong> a user has saved an item to the list<br>
<strong>And</strong> she has marked off an item<br>
<strong>When</strong> she requests to un-mark off the item<br>
<strong>Then</strong> the item is presented to the user as not being in possession<br>
<strong>And</strong> the item is not removed from the list<br>
—</p>
<p>Basically, we are defining an item of the <strong>Grocery List</strong> application as a toggle control. Now, I can sum that up in a tiny single sentence and wave my hand, but I think we will find that there is a lot more to that statement as we start writing our tests and ultimately will change the design of the application – fo the better, I hope!</p>
<h2>Test</h2>
<p>To start, the story in question and described above adds to the API of the <em>list-controller</em> we defined and created in the <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii" target="_blank">previous article</a>. The <em>list-controller</em> will need to expose a way to mark off an item that is saved to the list, and a way to unmark an item that was previously marked. As I see it, that’s two new methods – let’s call them <em>markOffItem</em> and <em>unmarkOffItem</em>. Let’s flesh them out and their signatures in a new spec for this feature:</p>
<p><em>/test/jasmine/spec/markitem.spec.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">define([</code><code class="jscript string">'script/controller/list-controller'</code><code class="jscript plain">], </code><code class="jscript keyword">function</code><code class="jscript plain">(listController) {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">describe(</code><code class="jscript string">'User Requests to mark-off existing item'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">name = </code><code class="jscript string">'apples'</code><code class="jscript plain">,</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">savedItem,</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">markOffSpy,</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">unmarkOffSpy;</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">beforeEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">listController.createNewItem();</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">listController.editFocusedItem(name);</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">listController.saveFocusedItem();</code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">savedItem = listController.itemList[listController.itemList.length-1];</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">markOffSpy = spyOn(listController, </code><code class="jscript string">"markOffItem"</code><code class="jscript plain">).andCallThrough();</code></div><div class="line number18 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">unmarkOffSpy = spyOn(listController, </code><code class="jscript string">"unmarkOffItem"</code><code class="jscript plain">).andCallThrough();</code></div><div class="line number19 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number20 index19 alt1">&nbsp;</div><div class="line number21 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">...</code></div><div class="line number22 index21 alt1">&nbsp;</div><div class="line number23 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">afterEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number24 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">savedItem = undefined;</code></div><div class="line number25 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">markOffSpy.reset();</code></div><div class="line number26 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">unmarkOffSpy.reset();</code></div><div class="line number27 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">listController.itemList = [];</code></div><div class="line number28 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">listController.editableItem = undefined;</code></div><div class="line number29 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number30 index29 alt1">&nbsp;</div><div class="line number31 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number32 index31 alt1">&nbsp;</div><div class="line number33 index32 alt2"><code class="jscript plain">});</code></div></pre></div>
<p>I wanted to start off this test example with just showing to setup and teardown for the feature as it introduces the concept of spies. The <em>beforeEach()</em> of the above specification suite starts off similarly to the other spec we created for the <em>Add Item</em> feature – create, edit and save an item on the <em>list-controller</em>. Following that, and specifically on line 17 and 18, we create spies for the API modifications we are making on the <em>list-controller</em> in order to add the <em>Mark Off Item</em> feature – <em>markOffItem()</em> and <em>unmarkOffItem()</em>. Spies, in as far as they are used in this instance, are essentially wrappers on a function that can record invocation calls and provide another API to facilitate in affirming expectations of how a method should be used. If you are unfamiliar with spies, both <a href="https://github.com/pivotal/jasmine/wiki/Spies" target="_blank">Jasmine</a> and <a href="http://sinonjs.org/docs/#spies" target="_blank">Sinon</a> have some great documentation.</p>
<p>The spies are defined to “call through” to the function implementation on the <em>list-controller</em>, as well. This will allow for the benefit of recording invocation and defining expectations of the actual implementation. Before we get into the real implementation, let’s take a look at the first spec for this test – marking off an item:</p>
<p><em>/test/jasmine/spec/markitem.spec.js</em></p>
<div><pre><div class="line number21 index0 alt2"><code class="jscript plain">it(</code><code class="jscript string">'should denote item as being in possession'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number22 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">previouslySavedItem = savedItem,</code></div><div class="line number23 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">savedItemID = savedItem.id,</code></div><div class="line number24 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">savedItemSpy = sinon.spy();</code></div><div class="line number25 index4 alt2">&nbsp;</div><div class="line number26 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">savedItemSpy(previouslySavedItem);</code></div><div class="line number27 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">listController.markOffItem(savedItemID);</code></div><div class="line number28 index7 alt1">&nbsp;</div><div class="line number29 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">// spy expectations.</code></div><div class="line number30 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">expect(markOffSpy).toHaveBeenCalled();</code></div><div class="line number31 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">expect(markOffSpy).toHaveBeenCalledWith(savedItemID);</code></div><div class="line number32 index11 alt1">&nbsp;</div><div class="line number33 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">// model expectations.</code></div><div class="line number34 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">expect(previouslySavedItem.hasOwnProperty(</code><code class="jscript string">'marked'</code><code class="jscript plain">)).toBe(</code><code class="jscript keyword">true</code><code class="jscript plain">);</code></div><div class="line number35 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">expect(previouslySavedItem.marked).toBe(</code><code class="jscript keyword">true</code><code class="jscript plain">);</code></div><div class="line number36 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">// OR &gt;</code></div><div class="line number37 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">sinon.assert.calledWith(savedItemSpy, sinon.match.hasOwn(</code><code class="jscript string">'marked'</code><code class="jscript plain">, </code><code class="jscript keyword">true</code><code class="jscript plain">));</code></div><div class="line number38 index17 alt1"><code class="jscript plain">});</code></div></pre></div>
<p>With this spec, we are affirming the signature of <em>markOffItem()</em> method on the <em>list-controller</em>, as well as revealing the need for modifications to the attributes on the model of a grocery list item. I wanted to highlight how the <em>markOffSpy()</em> is being used in expectations, and – though not technically needed – also maybe provide some intrigue (hopefully not confusion) in using spies from <a href="http://sinonjs.org" target="_blank">SinonJS</a> as well.</p>
<p>The following expectations, taken from the above spec, facilitate more in describing how <em>listController.markOffItem()</em> is to be used in the application, particularly that the method should be called with only one argument and that being an ID of an item from the list :</p>
<div><pre><div class="line number30 index0 alt1"><code class="jscript plain">expect(markOffSpy).toHaveBeenCalled();</code></div><div class="line number31 index1 alt2"><code class="jscript plain">expect(markOffSpy).toHaveBeenCalledWith(savedItemID);</code></div></pre></div>
<p>Some may say that such expectations are superfluous, and in some ways I do agree. Essentially, this line already defines its usage:</p>
<div><pre><div class="line number27 index0 alt2"><code class="jscript plain">listController.markOffItem(savedItemID);</code></div></pre></div>
<p>If the test didn’t cough at that line, that we can relatively assume the expectations called into question. To each his own, however. In fact, part of me thinks I should go <em>even more</em> overboard – ensuring only one argument was called, that it was of the same type as the id attribute on the model, etc. Anyway, after the expectations on the spy, we verify an update to the model on an attribute we have yet to define as well. From this test, we have defined it as being a boolean value and accessible on the <em>marked</em> property. I included a spy created using <a href="http://sinonjs.org" target="_blank">SinonJS</a> as well, just to show off it’s capabilities and compare and contrast testing on the new attribute of the model:</p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">previouslySavedItem = savedItem,</code></div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">savedItemSpy = sinon.spy();</code></div><div class="line number3 index2 alt2"><code class="jscript plain">savedItemSpy(previouslySavedItem);</code></div><div class="line number4 index3 alt1"><code class="jscript plain">...</code></div><div class="line number5 index4 alt2"><code class="jscript plain">sinon.assert.calledWith(savedItemSpy, sinon.match.hasOwn(</code><code class="jscript string">'marked'</code><code class="jscript plain">, </code><code class="jscript keyword">true</code><code class="jscript plain">));</code></div></pre></div>
<p>A spy is created on the model object, and after marking it off through the <em>list-controller</em> API, it is verified as being of type boolean and value of true using a sinon assert. Neat stuff. In this case, I probably would have just stuck with the <strong>Jasmine</strong> expectations, but I wanted to show you the power of <strong>SinonJS</strong> as it can provide a more robust testing API.</p>
<p>Rambling on. There’s still two other specifications we need to cover in this suite:</p>
<p><em>/test/jasmine/spec/markitem.spec.js</em></p>
<div><pre><div class="line number40 index0 alt1"><code class="jscript plain">it(</code><code class="jscript string">'should retain the item in the grocery list'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number41 index1 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">listController.markOffItem(savedItem.id);</code></div><div class="line number42 index2 alt1">&nbsp;</div><div class="line number43 index3 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">expect(listController.itemList.length).toBe(1);</code></div><div class="line number44 index4 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">expect(listController.itemList.indexOf(savedItem)).toBe(0);</code></div><div class="line number45 index5 alt2"><code class="jscript plain">});</code></div><div class="line number46 index6 alt1">&nbsp;</div><div class="line number47 index7 alt2"><code class="jscript plain">it(</code><code class="jscript string">'should have marked-off item available to unmark-off'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number48 index8 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">previouslySavedItem = savedItem,</code></div><div class="line number49 index9 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">savedItemID = savedItem.id;</code></div><div class="line number50 index10 alt1">&nbsp;</div><div class="line number51 index11 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">listController.markOffItem(savedItem.id);</code></div><div class="line number52 index12 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">listController.unmarkOffItem(savedItem.id);</code></div><div class="line number53 index13 alt2">&nbsp;</div><div class="line number54 index14 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">// stubbed expectations.</code></div><div class="line number55 index15 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">expect(unmarkOffSpy).toHaveBeenCalled();</code></div><div class="line number56 index16 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">// model expectations.</code></div><div class="line number57 index17 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">expect(previouslySavedItem.marked).not.toBe(</code><code class="jscript keyword">true</code><code class="jscript plain">);</code></div><div class="line number58 index18 alt1"><code class="jscript plain">});</code></div></pre></div>
<p>These specs define the expectations of the list remaining unmodified when marking off an item, and that the model is updated appropriately when unmarking off an item through the <em>list-controller</em> API, respectively. </p>
<p><small><br>
[note]<br>
<em>I am using Array.prototype.indexOf in the first spec from the previous example. That didn’t make <a href="https://developer.mozilla.org/en-US/docs/JavaScript/New_in_JavaScript/1.6" target="_blank">an appearance until JavaScript 1.6</a> and as such is not implemented in some older browsers (i have no &lt;3 for IE&lt;9). As I mentioned in the first article of this series, I am taking for granted that the application will be viewed on modern browsers, and in particular modern mobile browsers.</em><br>
</small></p>
<h3>Failing</h3>
<p>If you added this spec to the spec runner like so:</p>
<p><em>/test/jasmine/specrunner.html</em></p>
<div><pre><div class="line number34 index0 alt1 highlighted"><code class="jscript plain">require( [</code><code class="jscript string">'spec/newitem.spec.js'</code><code class="jscript plain">, </code><code class="jscript string">'spec/markitem.spec.js'</code><code class="jscript plain">], </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number35 index1 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">jasmineEnv = jasmine.getEnv(),</code></div><div class="line number36 index2 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">...</code></div><div class="line number37 index3 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">jasmineEnv.execute();</code></div><div class="line number38 index4 alt1"><code class="jscript plain">});</code></div></pre></div>
<p>&gt; it will fail. miserably. But that’s okay! That’s expected. Spies require an actual implementation on the object you are spying, and if you recall from the first spec described, we actually request a call through on the implementation in order to verify expected functionality. </p>
<p>Let’s get to the <em>list-controller</em> and <em>grocery-ls-item</em> model, as those are the two items addressed in the latest spec suite as needing modifications to pass.</p>
<h2>Implementation</h2>
<p>In our Mark Off Item spec suite, we identified two additions to the API of the list-controller. Those methods are:</p>
<ul>
<li>+ markOffItem( itemID )</li>
<li>+ unmarkOffItem( itemID )</li>
</ul>
<p>The first instinct is to just add these to the <em>list-controller</em> object and add an internal method that traverses the held <em>itemList</em> array to locate models that have the passed <em>itemID</em> value. Not a bad instinct, and something of the following would get the tests passing:</p>
<p><em>/script/controller/list-controller.js</em></p>
<div><pre><div class="line number64 index0 alt1"><code class="jscript plain">markOffItem: </code><code class="jscript keyword">function</code><code class="jscript plain">(itemID) {</code></div><div class="line number65 index1 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">item = findItemByID(itemID, </code><code class="jscript keyword">this</code><code class="jscript plain">.itemList),</code></div><div class="line number66 index2 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">renderer = findRendererByItem(item, $itemList.children());</code></div><div class="line number67 index3 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">item.marked = </code><code class="jscript keyword">true</code><code class="jscript plain">;</code></div><div class="line number68 index4 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">$(renderer).css(</code><code class="jscript string">'text-decoration'</code><code class="jscript plain">, </code><code class="jscript string">'line-through'</code><code class="jscript plain">);</code></div><div class="line number69 index5 alt2"><code class="jscript plain">},</code></div><div class="line number70 index6 alt1"><code class="jscript plain">unmarkOffItem: </code><code class="jscript keyword">function</code><code class="jscript plain">(itemID) {</code></div><div class="line number71 index7 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">item = findItemByID(itemID, </code><code class="jscript keyword">this</code><code class="jscript plain">.itemList),</code></div><div class="line number72 index8 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">renderer = findRendererByItem(item, $itemList.children());</code></div><div class="line number73 index9 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">item.marked = </code><code class="jscript keyword">false</code><code class="jscript plain">;</code></div><div class="line number74 index10 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">$(renderer).css(</code><code class="jscript string">'text-decoration'</code><code class="jscript plain">, </code><code class="jscript string">'none'</code><code class="jscript plain">);</code></div><div class="line number75 index11 alt2"><code class="jscript plain">}</code></div></pre></div>
<p><em>&gt; where findByItemID() locates the model associated with the itemID within the itemList array and findRendererByItem() locates the DOM element associated with the model.</em></p>
<p>If you were to run that, the tests would pass. Well, technically, if you left that bit in there where a <a href="http://sinonjs.org" target="_blank">SinonJS</a> spy was asserting on the model, it would not pass. But if you took that out, all green. Even without modifying the <em>grocery-ls-item</em> model… such is the dynamic nature of JavaScript. For brevities sake, let’s add the marked property to the Object.defineProperties object upon creation of a new model:</p>
<p><em>/script/model/grocery-ls-item.js</em></p>
<div><pre><div class="line number3 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">properties = </code><code class="jscript keyword">function</code><code class="jscript plain">(id) {</code></div><div class="line number4 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">{</code></div><div class="line number5 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"id"</code><code class="jscript plain">: {</code></div><div class="line number6 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">value: id,</code></div><div class="line number7 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">writable: </code><code class="jscript keyword">false</code><code class="jscript plain">,</code></div><div class="line number8 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">enumerable: </code><code class="jscript keyword">true</code></div><div class="line number9 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number10 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"name"</code><code class="jscript plain">: {</code></div><div class="line number11 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">value: </code><code class="jscript string">''</code><code class="jscript plain">,</code></div><div class="line number12 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">writable: </code><code class="jscript keyword">true</code><code class="jscript plain">,</code></div><div class="line number13 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">enumerable: </code><code class="jscript keyword">true</code></div><div class="line number14 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number15 index12 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"marked"</code><code class="jscript plain">: {</code></div><div class="line number16 index13 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">value: </code><code class="jscript keyword">false</code><code class="jscript plain">,</code></div><div class="line number17 index14 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">writable: </code><code class="jscript keyword">true</code><code class="jscript plain">,</code></div><div class="line number18 index15 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">enumerable: </code><code class="jscript keyword">true</code></div><div class="line number19 index16 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number20 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number21 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">};</code></div></pre></div>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_iii_1.png" alt="passing mark-off item spec"><br>
<img src="http://custardbelly.com/blog/images/tdd_js/part_iii_app_1.png" alt="grocery list app with mark off"></p>
<p><strong>Tagged</strong>: 0.1.3 <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.3" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.3</a></p>
<h2>Before you leave!</h2>
<p>I am not satisfied with the current state of the <em>list-controller</em>; it has far too much responsibility in managing list item renderers and models and lacks the finer details to properly keep the 1:1 relationship that renderers have to their models. We could just throw more code in there, more tests and let it grow into this gross beast, but I really think it is up for a good refactor.</p>
<p>So, that is what I have planned for the next article. We’ll refactor the <em>list-controller</em> to have less responsibility in managing each <em>grocery-ls-item</em> model and pass that off to a new <em>list-item-controller</em>. In fact, I already have started upon such a refactor and had included most of it in this article, but I felt it was getting too long (as usual) and taking away from the <em>Mark Off Item</em> feature presented here.</p>
<p>Until then, you have passing tests and a functioning <strong>Grocery List</strong> application to play with if you <a href="https://github.com/bustardcelly/grocery-ls" target="_blank">check it out of the repo</a>.</p>
<p>—</p>
<h1>Link Dump</h1>
<h2>Post Series</h2>
<p><a href="https://github.com/bustardcelly/grocery-ls">grocery-ls github repo</a><br>
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i" target="_blank">Part I – Introduction</a><br>
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii">Part II – Feature: Add Item</a><br>
<a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii">Part III – Feature: Mark-Off Item</a><br>
<a href="http://custardbelly.com/blog/2012/12/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-iv">Part IV – Feature: List-Item-Controller</a><br>
<a href="http://custardbelly.com/blog/2012/12/31/the-making-of-a-test-driven-grocery-list-application-in-js-part-v/">Part V – Feature: List-Controller Refactoring</a><br>
<a href="http://custardbelly.com/blog/2013/01/08/the-making-of-a-test-driven-grocery-list-application-in-js-part-vi/" target="_blank">Part VI – Back to Passing</a><br>
<a href="http://custardbelly.com/blog/2013/01/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-vii/">Part VII – Remove Item</a><br>
<a href="http://custardbelly.com/blog/2013/01/22/the-making-of-a-test-driven-grocery-list-application-part-viii/">Part VIII – Bug Fixing</a><br>
<a href="http://custardbelly.com/blog/2013/02/15/the-making-of-a-test-driven-grocery-list-application-in-js-part-ix/">Part IX – Persistence</a><br>
<a href="http://custardbelly.com/blog/2013/03/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-x/">Part X – It Lives!</a></p>
<h2>Reference</h2>
<p><a href="http://tddjs.com/" target="_blank">Test-Driven JavaScript Development by Christian Johansen</a><br>
<a href="http://dannorth.net/introducing-bdd/" target="_blank">Introducing BDD by Dan North</a><br>
<a href="http://chrismdp.com/2012/11/the-integration-testing-trap/" target="_blank">Cucumber: the integration test trap by Crhis Parsons</a><br>
Testing spies for <a href="https://github.com/pivotal/jasmine/wiki/Spies">Jasmine</a> and <a href="http://sinonjs.org/docs/#spies">Sinon</a><br>
<a href="http://requirejs.org/" target="_blank">RequireJS</a><br>
<a href="https://github.com/amdjs/amdjs-api/wiki/AMD" target="_blank">AMD</a><br>
<a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a><br>
<a href="http://sinonjs.org/" target="_blank">Sinon</a><br>
<a href="https://github.com/derickbailey/jasmine.async" target="_blank">Jasmine.Async</a><br>
the <a href="http://www.flickr.com/photos/unitzeroone/4721521533/">infamous</a> <a href="http://bit-101.com">eye-roller</a> </p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/javascript/" title="View all posts in JavaScript" rel="category tag">JavaScript</a>,  <a href="http://custardbelly.com/blog/category/requirejs/" title="View all posts in RequireJS" rel="category tag">RequireJS</a>,  <a href="http://custardbelly.com/blog/category/grocery-ls/" title="View all posts in grocery-ls" rel="category tag">grocery-ls</a>,  <a href="http://custardbelly.com/blog/category/jasmine/" title="View all posts in jasmine" rel="category tag">jasmine</a>,  <a href="http://custardbelly.com/blog/category/unit-testing/" title="View all posts in unit-testing" rel="category tag">unit-testing</a>.</p>
	
	

	<!--/by-line-->

	<div id="post-comments-636-target"></div>
	<div class="clear"></div>
	
	