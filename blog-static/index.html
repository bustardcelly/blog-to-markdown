<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
<head profile="http://gmpg.org/xfn/11">
	<title>todd anderson</title>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	
	<link rel="alternate" type="application/rss+xml" href="http://custardbelly.com/blog/feed/" title="todd anderson latest posts" />
	<link rel="alternate" type="application/rss+xml" href="http://custardbelly.com/blog/comments/feed/" title="todd anderson latest comments" />
	<link rel="pingback" href="http://darko.liquidweb.com/~custardb/blog/xmlrpc.php" />
		<link rel='archives' title='March 2013' href='http://custardbelly.com/blog/2013/03/' />
	<link rel='archives' title='February 2013' href='http://custardbelly.com/blog/2013/02/' />
	<link rel='archives' title='January 2013' href='http://custardbelly.com/blog/2013/01/' />
	<link rel='archives' title='December 2012' href='http://custardbelly.com/blog/2012/12/' />
	<link rel='archives' title='November 2012' href='http://custardbelly.com/blog/2012/11/' />
	<link rel='archives' title='March 2012' href='http://custardbelly.com/blog/2012/03/' />
	<link rel='archives' title='February 2012' href='http://custardbelly.com/blog/2012/02/' />
	<link rel='archives' title='November 2011' href='http://custardbelly.com/blog/2011/11/' />
	<link rel='archives' title='October 2011' href='http://custardbelly.com/blog/2011/10/' />
	<link rel='archives' title='September 2011' href='http://custardbelly.com/blog/2011/09/' />
	<link rel='archives' title='July 2011' href='http://custardbelly.com/blog/2011/07/' />
	<link rel='archives' title='June 2011' href='http://custardbelly.com/blog/2011/06/' />
	<link rel='archives' title='March 2011' href='http://custardbelly.com/blog/2011/03/' />
	<link rel='archives' title='February 2011' href='http://custardbelly.com/blog/2011/02/' />
	<link rel='archives' title='January 2011' href='http://custardbelly.com/blog/2011/01/' />
	<link rel='archives' title='December 2010' href='http://custardbelly.com/blog/2010/12/' />
	<link rel='archives' title='November 2010' href='http://custardbelly.com/blog/2010/11/' />
	<link rel='archives' title='October 2010' href='http://custardbelly.com/blog/2010/10/' />
	<link rel='archives' title='September 2010' href='http://custardbelly.com/blog/2010/09/' />
	<link rel='archives' title='August 2010' href='http://custardbelly.com/blog/2010/08/' />
	<link rel='archives' title='May 2010' href='http://custardbelly.com/blog/2010/05/' />
	<link rel='archives' title='April 2010' href='http://custardbelly.com/blog/2010/04/' />
	<link rel='archives' title='March 2010' href='http://custardbelly.com/blog/2010/03/' />
	<link rel='archives' title='September 2009' href='http://custardbelly.com/blog/2009/09/' />
	<link rel='archives' title='April 2009' href='http://custardbelly.com/blog/2009/04/' />
	<link rel='archives' title='March 2009' href='http://custardbelly.com/blog/2009/03/' />
	<link rel='archives' title='January 2009' href='http://custardbelly.com/blog/2009/01/' />
	<link rel='archives' title='December 2008' href='http://custardbelly.com/blog/2008/12/' />
	<link rel='archives' title='November 2008' href='http://custardbelly.com/blog/2008/11/' />
	<link rel='archives' title='September 2008' href='http://custardbelly.com/blog/2008/09/' />
	<link rel='archives' title='August 2008' href='http://custardbelly.com/blog/2008/08/' />
	<link rel='archives' title='July 2008' href='http://custardbelly.com/blog/2008/07/' />
	<link rel='archives' title='May 2008' href='http://custardbelly.com/blog/2008/05/' />
	<link rel='archives' title='April 2008' href='http://custardbelly.com/blog/2008/04/' />
	<link rel='archives' title='February 2008' href='http://custardbelly.com/blog/2008/02/' />
	<link rel='archives' title='October 2007' href='http://custardbelly.com/blog/2007/10/' />
	<link rel='archives' title='August 2007' href='http://custardbelly.com/blog/2007/08/' />
	<link rel='archives' title='April 2007' href='http://custardbelly.com/blog/2007/04/' />
	<link rel='archives' title='January 2007' href='http://custardbelly.com/blog/2007/01/' />
	<link rel='archives' title='December 2006' href='http://custardbelly.com/blog/2006/12/' />
	<link rel='archives' title='September 2006' href='http://custardbelly.com/blog/2006/09/' />
	<link rel='archives' title='August 2006' href='http://custardbelly.com/blog/2006/08/' />
	<link rel='archives' title='July 2006' href='http://custardbelly.com/blog/2006/07/' />
	<link rel='archives' title='June 2006' href='http://custardbelly.com/blog/2006/06/' />
	<link rel='archives' title='May 2006' href='http://custardbelly.com/blog/2006/05/' />
	<link rel='archives' title='April 2006' href='http://custardbelly.com/blog/2006/04/' />
	<link rel='archives' title='March 2006' href='http://custardbelly.com/blog/2006/03/' />
	<link rel='archives' title='February 2006' href='http://custardbelly.com/blog/2006/02/' />
	<link rel='archives' title='January 2006' href='http://custardbelly.com/blog/2006/01/' />
	<link rel='archives' title='November 2005' href='http://custardbelly.com/blog/2005/11/' />
	<link rel='archives' title='October 2005' href='http://custardbelly.com/blog/2005/10/' />
	<link rel='archives' title='September 2005' href='http://custardbelly.com/blog/2005/09/' />
	<link rel='archives' title='August 2005' href='http://custardbelly.com/blog/2005/08/' />
	<link rel='archives' title='July 2005' href='http://custardbelly.com/blog/2005/07/' />
	<link rel='archives' title='June 2005' href='http://custardbelly.com/blog/2005/06/' />
	
	<link rel="stylesheet" type="text/css" media="screen" href="http://darko.liquidweb.com/~custardb/blog/wp-content/themes/carrington-blog/css/css.php" />

	<!--[if lt IE 8]>
		<link rel="stylesheet" href="http://darko.liquidweb.com/~custardb/blog/wp-content/themes/carrington-blog/css/ie.css" type="text/css" media="screen" />
	<![endif]-->
	
	<!--[if lt IE 7]>
		<script type="text/javascript" src="http://darko.liquidweb.com/~custardb/blog/wp-content/themes/carrington-blog/js/iepngfix_tilebg.js"></script>
		<script type="text/javascript">
			var CFCT_BLANKIMG = 'http://darko.liquidweb.com/~custardb/blog/wp-content/themes/carrington-blog/img/ie/blank.gif';
		</script>
		<style type="text/css" media="screen">
			/* IE6 PNG fix */
			img,
			#header .wrapper,
			#footer .wrapper{
				behavior: url(http://darko.liquidweb.com/~custardb/blog/wp-content/themes/carrington-blog/css/iepngfix.htc);
			}
		</style>
		<link rel="stylesheet" href="http://darko.liquidweb.com/~custardb/blog/wp-content/themes/carrington-blog/css/ie6.css" type="text/css" media="screen" />
	<![endif]-->
	
	<script type='text/javascript' src='http://darko.liquidweb.com/~custardb/blog/wp-includes/js/swfobject.js?ver=2.1'></script>
<script type='text/javascript' src='http://darko.liquidweb.com/~custardb/blog/wp-includes/js/jquery/jquery.js?ver=1.3.2'></script>
<script type='text/javascript' src='http://darko.liquidweb.com/~custardb/blog/wp-content/themes/carrington-blog/js/carrington.js?ver=1.0'></script>
<script type='text/javascript' src='http://darko.liquidweb.com/~custardb/blog/wp-content/themes/carrington-blog/carrington-core/lightbox/thickbox.js?ver=1.0'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://darko.liquidweb.com/~custardb/blog/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://darko.liquidweb.com/~custardb/blog/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='todd anderson' href='http://custardbelly.com/blog' />
<meta name="generator" content="WordPress 2.8" />

<!-- all in one seo pack 1.5.6 [-1,-1] -->
<meta name="keywords" content="javascript, unit testing, bdd, tdd, test-driven, application, web application, grocery list, todd anderson,madmin, js, javascript, node, nodejs, toddanderson, infrared5, requirejs, ria, rest, restful uri, uri, require, facade, javascript facade, micro-library, micro-libraries, dependency injection, phantomjs, qunit, build system, javascript workflow, devleopment workflow, webstack, web development,todd, anderson, knockoutjs, jquery, massroute,todd anderson, flex, flex 4, actionscript, deferred content, defaultproperty, dojo, amd, module, dojo.require, dojo.delcare, dojo.provide, jquery mobile, massdot, mbta,ane, flex 4.5, flex sdk, air, air 3, air native extension, adobe, adobe air,flex, linked list, contentloader, bitmapimage,jquery mobile, flash and the city, progressive enhancement, jquery ui, jquery plugin, jquery widget, couchdb, couchapp, futon,jquery, couch, todd, authorization, authorisation, validation, validate_doc_update,as3flobile, flex containers, actionscript 3, scrollviewport, jquerymobile, mobile, jquery.couch, show function, document, jquery page,jquerymobile,couchdb,mustache,couchapp,clear jquery mobile page cache" />
<link rel="canonical" href="index.html" />
<!-- /all in one seo pack -->

<link rel="stylesheet" href="http://darko.liquidweb.com/~custardb/blog/wp-content/plugins/wp-syntax/wp-syntax.css" type="text/css" media="screen" />

<script type="text/javascript" charset="utf-8">

	/**
	 * Courtesy of Kimili Flash Embed - Version 2.0.1
	 * by Michael Bester - http://kimili.com
	 */

	(function(){
		try {
			// Registering Statically Published SWFs
			swfobject.registerObject("fm_ViewStackExample_1376435495","10.0.0");
		} catch(e) {}
	}())
</script>

<link rel="stylesheet" type="text/css" media="screen" href="http://darko.liquidweb.com/~custardb/blog/wp-content/themes/carrington-blog/carrington-core/lightbox/css/thickbox.css" />
		
<script type="text/javascript">
var CFCT_URL = "http://custardbelly.com/blog";
var CFCT_AJAX_LOAD = true;
</script>
	
<script type="text/javascript">
tb_pathToImage = "http://darko.liquidweb.com/~custardb/blog/wp-content/themes/carrington-blog/carrington-core/lightbox/img/loadingAnimation.gif";
jQuery(function($) {
	$("a.thickbox").each(function() {
		var url = $(this).attr("rel");
		var post_id = $(this).parents("div.post").attr("id");
		$(this).attr("href", url).attr("rel", post_id);
	});
});
</script>
		<meta id="syntaxhighlighteranchor" name="syntaxhighlighter-version" content="3.1.1" />
	<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-29061897-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</head>

<body>
	<div id="page">
		<div id="top"><a class="accessibility" href="index.html#content">Skip to content</a></div>
		<hr class="lofi" />
		<div id="header" class="section">
			<div class="wrapper">
				<strong id="blog-title"><a href="index.html" rel="home">todd anderson</a></strong>
				<p id="blog-description">it&#039;s a long story</p>
				<div id="navigation">
					<ul class="nav clearfix">
						<li class="page_item page-item-38"><a href="http://custardbelly.com/blog/about/" title="about">about</a></li>
<li class="page_item page-item-127"><a href="http://custardbelly.com/blog/as3couchdb/" title="as3couchdb">as3couchdb</a></li>
<li class="page_item page-item-180"><a href="http://custardbelly.com/blog/as3flobile/" title="as3flobile">as3flobile</a></li>
<li class="page_item page-item-39"><a href="http://custardbelly.com/blog/contact/" title="contact">contact</a></li>
<li class="page_item page-item-661"><a href="http://custardbelly.com/blog/grocery-ls/" title="grocery-ls">grocery-ls</a></li>
<li class="page_item page-item-426"><a href="http://custardbelly.com/blog/jqm-couchdb/" title="jQM + CouchDB">jQM + CouchDB</a></li>
<li class="page_item page-item-508"><a href="http://custardbelly.com/blog/massroute-js/" title="massroute-js">massroute-js</a></li>
<li class="page_item page-item-444"><a href="http://custardbelly.com/blog/presentations/" title="presentations">presentations</a></li>
 
					</ul>
				</div><!-- #navigation -->
			</div><!-- .wrapper -->
		</div><!-- #header -->
		<div id="sub-header" class="section">
			<div class="wrapper">
				
<form method="get" id="cfct-search" action="index.html" onsubmit="location.href=this.action+'search/'+encodeURIComponent(this.s.value).replace(/%20/g, '+'); return false;">
	<div>
		<input type="text" id="cfct-search-input" name="s" value="" size="15" />
		<input type="submit" name="submit_button" value="Search" />
	</div>
</form>				<div id="all-categories">
					<strong id="all-categories-title">Categories:</strong>
					<ul class="nav clearfix">
							<li class="cat-item cat-item-12"><a href="http://custardbelly.com/blog/category/air/" title="View all posts filed under AIR">AIR</a>
</li>
	<li class="cat-item cat-item-41"><a href="http://custardbelly.com/blog/category/amd/" title="View all posts filed under AMD">AMD</a>
</li>
	<li class="cat-item cat-item-27"><a href="http://custardbelly.com/blog/category/android/" title="View all posts filed under Android">Android</a>
</li>
	<li class="cat-item cat-item-9"><a href="http://custardbelly.com/blog/category/apollo/" title="Apollo!">Apollo</a>
</li>
	<li class="cat-item cat-item-5"><a href="http://custardbelly.com/blog/category/as3/" title="View all posts filed under AS3">AS3</a>
</li>
	<li class="cat-item cat-item-24"><a href="http://custardbelly.com/blog/category/as3couchdb/" title="View all posts filed under as3couchdb">as3couchdb</a>
</li>
	<li class="cat-item cat-item-26"><a href="http://custardbelly.com/blog/category/as3flobile/" title="View all posts filed under as3flobile">as3flobile</a>
</li>
	<li class="cat-item cat-item-29"><a href="http://custardbelly.com/blog/category/as3flobile-android/" title="View all posts filed under as3flobile-android">as3flobile-android</a>
</li>
	<li class="cat-item cat-item-15"><a href="http://custardbelly.com/blog/category/astro/" title="View all posts filed under Astro">Astro</a>
</li>
	<li class="cat-item cat-item-8"><a href="http://custardbelly.com/blog/category/beer/" title="View all posts filed under Beer!">Beer!</a>
</li>
	<li class="cat-item cat-item-11"><a href="http://custardbelly.com/blog/category/books/" title="View all posts filed under Books">Books</a>
</li>
	<li class="cat-item cat-item-31"><a href="http://custardbelly.com/blog/category/burrito/" title="View all posts filed under Burrito">Burrito</a>
</li>
	<li class="cat-item cat-item-16"><a href="http://custardbelly.com/blog/category/conferences/" title="View all posts filed under Conferences">Conferences</a>
</li>
	<li class="cat-item cat-item-25"><a href="http://custardbelly.com/blog/category/couchdb/" title="View all posts filed under CouchDB">CouchDB</a>
</li>
	<li class="cat-item cat-item-38"><a href="http://custardbelly.com/blog/category/dojo/" title="View all posts filed under dojo">dojo</a>
</li>
	<li class="cat-item cat-item-2"><a href="http://custardbelly.com/blog/category/flash/" title="View all posts filed under Flash">Flash</a>
</li>
	<li class="cat-item cat-item-35"><a href="http://custardbelly.com/blog/category/flash-and-the-city/" title="View all posts filed under Flash and the City">Flash and the City</a>
</li>
	<li class="cat-item cat-item-19"><a href="http://custardbelly.com/blog/category/flash-on-tap/" title="View all posts filed under flash on tap">flash on tap</a>
</li>
	<li class="cat-item cat-item-4"><a href="http://custardbelly.com/blog/category/flash8/" title="View all posts filed under Flash8">Flash8</a>
</li>
	<li class="cat-item cat-item-10"><a href="http://custardbelly.com/blog/category/flex/" title="View all posts filed under Flex">Flex</a>
</li>
	<li class="cat-item cat-item-22"><a href="http://custardbelly.com/blog/category/flex-4/" title="View all posts filed under Flex 4">Flex 4</a>
</li>
	<li class="cat-item cat-item-32"><a href="http://custardbelly.com/blog/category/flex-4-5/" title="View all posts filed under Flex 4.5">Flex 4.5</a>
</li>
	<li class="cat-item cat-item-30"><a href="http://custardbelly.com/blog/category/flex-runtime-css/" title="View all posts filed under flex-runtime-css">flex-runtime-css</a>
</li>
	<li class="cat-item cat-item-17"><a href="http://custardbelly.com/blog/category/flextasks/" title="View all posts filed under FlexTasks">FlexTasks</a>
</li>
	<li class="cat-item cat-item-1"><a href="http://custardbelly.com/blog/category/general/" title="View all posts filed under General">General</a>
</li>
	<li class="cat-item cat-item-50"><a href="http://custardbelly.com/blog/category/grocery-ls/" title="View all posts filed under grocery-ls">grocery-ls</a>
</li>
	<li class="cat-item cat-item-13"><a href="http://custardbelly.com/blog/category/infrared5/" title="View all posts filed under Infrared5">Infrared5</a>
</li>
	<li class="cat-item cat-item-51"><a href="http://custardbelly.com/blog/category/jasmine/" title="View all posts filed under jasmine">jasmine</a>
</li>
	<li class="cat-item cat-item-37"><a href="http://custardbelly.com/blog/category/javascript/" title="View all posts filed under JavaScript">JavaScript</a>
</li>
	<li class="cat-item cat-item-33"><a href="http://custardbelly.com/blog/category/jquery/" title="View all posts filed under jquery">jquery</a>
</li>
	<li class="cat-item cat-item-34"><a href="http://custardbelly.com/blog/category/jquery-mobile/" title="View all posts filed under jquery-mobile">jquery-mobile</a>
</li>
	<li class="cat-item cat-item-45"><a href="http://custardbelly.com/blog/category/jshint/" title="View all posts filed under JSHint">JSHint</a>
</li>
	<li class="cat-item cat-item-40"><a href="http://custardbelly.com/blog/category/knockoutjs/" title="View all posts filed under knockoutjs">knockoutjs</a>
</li>
	<li class="cat-item cat-item-53"><a href="http://custardbelly.com/blog/category/madmin/" title="View all posts filed under madmin">madmin</a>
</li>
	<li class="cat-item cat-item-28"><a href="http://custardbelly.com/blog/category/massroute/" title="View all posts filed under MassRoute">MassRoute</a>
</li>
	<li class="cat-item cat-item-39"><a href="http://custardbelly.com/blog/category/massroute-js/" title="View all posts filed under massroute-js">massroute-js</a>
</li>
	<li class="cat-item cat-item-47"><a href="http://custardbelly.com/blog/category/micro-library/" title="View all posts filed under micro-library">micro-library</a>
</li>
	<li class="cat-item cat-item-3"><a href="http://custardbelly.com/blog/category/music/" title="View all posts filed under Music">Music</a>
</li>
	<li class="cat-item cat-item-18"><a href="http://custardbelly.com/blog/category/muwl/" title="View all posts filed under MUWL">MUWL</a>
</li>
	<li class="cat-item cat-item-36"><a href="http://custardbelly.com/blog/category/native-extension-for-adobe-air/" title="View all posts filed under Native Extension for Adobe AIR">Native Extension for Adobe AIR</a>
</li>
	<li class="cat-item cat-item-52"><a href="http://custardbelly.com/blog/category/node/" title="View all posts filed under node">node</a>
</li>
	<li class="cat-item cat-item-43"><a href="http://custardbelly.com/blog/category/phantomjs/" title="View all posts filed under PhantomJS">PhantomJS</a>
</li>
	<li class="cat-item cat-item-14"><a href="http://custardbelly.com/blog/category/prana/" title="View all posts filed under Prana">Prana</a>
</li>
	<li class="cat-item cat-item-44"><a href="http://custardbelly.com/blog/category/qunit/" title="View all posts filed under QUnit">QUnit</a>
</li>
	<li class="cat-item cat-item-46"><a href="http://custardbelly.com/blog/category/r-js/" title="View all posts filed under r.js">r.js</a>
</li>
	<li class="cat-item cat-item-6"><a href="http://custardbelly.com/blog/category/red5/" title="View all posts filed under Red5">Red5</a>
</li>
	<li class="cat-item cat-item-42"><a href="http://custardbelly.com/blog/category/requirejs/" title="View all posts filed under RequireJS">RequireJS</a>
</li>
	<li class="cat-item cat-item-49"><a href="http://custardbelly.com/blog/category/unit-testing/" title="View all posts filed under unit-testing">unit-testing</a>
</li>
	<li class="cat-item cat-item-7"><a href="http://custardbelly.com/blog/category/webhost/" title="View all posts filed under Westhost">Westhost</a>
</li>
					</ul>
				</div><!-- #list-categories -->
			</div><!-- .wrapper -->
		</div><!--#sub-header-->
		<hr class="lofi" />
		<div id="main" class="section">
			<div class="wrapper">
<div id="content">
<div id="post-content-823" class="post-823 post hentry category-amd category-javascript category-requirejs category-grocery-ls category-jasmine full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2013/03/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-x/" title="Permanent link to The Making of a Test-Driven Grocery List Application in JS: Part X" rel="bookmark" rev="post-823">The Making of a Test-Driven Grocery List Application in JS: Part X</a></h1>
	
	<div class="entry-content full-content">
		<p><em>This is the tenth installment in a series of building a Test-Driven Grocery List application using <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> and <a href="http://requirejs.org" target="_blank">RequireJS</a>. To learn more about the intent and general concept of the series please visit <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i/">The Making of a Test-Driven Grocery List Application in JavaScript: Part I</a></em><br />
&#8212;</p>
<h2>Introduction</h2>
<p>When we last left, we properly modified <code>list-controller</code> to support event notification upon change to its collection as well as created a <code>storage-service</code> communication layer with <code>localStorage</code>. That gave us some great passing tests, but nothing to show off as the service was not integrated into the <strong>Grocery List</strong> application. In this article, we&#8217;ll do just that, but&#8230;</p>
<h2>Before we hook up list-controller events to storage-service operations&#8230;</h2>
<p>We need a way to supply the <code>list-controller</code> with the stored items. The <code>list-controller</code> has a <code>createNewItem()</code> method, but no methods to provide a previously created item. Since we are not burdening the <code>list-controller</code> in communicating with the <code>storage-service</code> directly, we&#8217;ll need to open up the API to allow items to be added &#8211; at least at the onset.</p>
<h3>Tests</h3>
<p>First we&#8217;ll include all our tests in our <em>specrunner</em> again as changes to <code>list-controller</code> may impact tests across multiple specs. And while we are poking around, let&#8217;s add a spec suite for <code>setItems()</code> on the <code>list-controller</code> and watch it fail:</p>
<p><em>/test/jasmine/spec/list-controller.spec.js</em></p>
<pre class="brush: jscript; first-line: 0; title: ;" title="">
describe('setItems()', function() {

  var itemOne = modelFactory.create(),
      itemTwo = modelFactory.create();

  beforeEach( function() {
    itemOne.name = 'apples';
    itemTwo.name = 'oranges';
    listController.setItems([itemOne, itemTwo]);
  });

  afterEach( function() {
    listController.getItemList().removeAll();
  });

  it('should fill list with provided items', function() {
    var items = listController.getItemList();
    expect(items.itemLength()).toEqual(2);
    expect(items.getItemAt(0)).toBe(itemOne);
    expect(items.getItemAt(1)).toBe(itemTwo);
  });

});
</pre>
<p>This simple first spec tells us that an array of items can be provided to the <code>list-controller</code> using <code>setItems()</code> and should be accessible by its collection. And we fail with no surprises:<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_17.png" alt="Failing on setItems of list-controller" /></p>
<h3>list-controller modification</h3>
<p>Throughout this series I have employed a quasi-<a href="http://coderetreat.org/facilitating/activities/tdd-as-if-you-meant-it" target="_blank"><em>&#8220;TDD as if you mean it&#8221;</em></a> approach when creating new components and modifying the API on existing ones. With this modification to the <code>list-controller</code>, I am going to stick to getting the tests to pass by modifying the <code>list-controller</code> directly as I feel it is going to get a little more involved and will require some refactoring that would be better suited by focusing on true implementation.</p>
<p>With that said, let&#8217;s modify <code>list-controller</code> to get that new spec passing:</p>
<p><em>/script/controller/list-controller.js</em></p>
<pre class="brush: jscript; first-line: 19; highlight: [46,47,48]; title: ;" title="">
listController = {
  $view: undefined,
  getItemList: function() {
    return collection;
  },
  getRendererFromItem: function(item) {
    var i = rendererList.itemLength(),
        renderer;
    while( --i &gt; -1 ) {
      renderer = rendererList.getItemAt(i);
      if(renderer.model === item) {
        return renderer;
      }
    }
    return undefined;
  },
  createNewItem: function() {
    var model = modelFactory.create();
    collection.addItem(model);
    return model;
  },
  removeItem: function(item) {
    return collection.removeItem(item);
  },
  setView: function(view) {
    this.$view = (view instanceof $) ? view : $(view);
  },
  setItems: function(items) {
    collection = collectionFactory.create(items);
  }
};
</pre>
<p>Well, that was easy enough!<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_18.png" alt="Passing on setItems() of list-controller" /></p>
<h3>Tests</h3>
<p>Not so fast&#8230; I think our single spec may be deceiving our expectations. Let&#8217;s add a few more and make sure we are on the right path. To start, we expect changes to these new models to propagate events when it is modified &#8211; such as in the work we have done previously.</p>
<p><em>/test/jasmine/spec/list-controller.spec.js</em></p>
<pre class="brush: jscript; first-line: 62; title: ;" title="">
async.it('should dispatch events of property-change from provided items', function(done) {
  var items = listController.getItemList(),
      itemOne = items.getItemAt(0);
  $(listController).on('save-item', function(event) {
    $(listController).off('save-item');
    expect(event.item).toBe(itemOne);
    done();
  });
  itemOne.marked = true;
});
</pre>
<p>This spec tells us that changes to an item should be notified through the <code>list-controller</code> &#8211; basically the work we had done previously in getting the <code>list-controller</code> to dispatch events related to its underlying collection so as to be captured by observing parties.<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_19.png" alt="Failing on async timeout of event from item" /></p>
<p>This test actually reveals some refactoring that is required within the <code>list-controller</code>. In essence, creating a new collection from the provided items in <code>setItems()</code> is not enough to have the application work as expected &#8211; each individual item needs to be managed by a <code>list-item-controller</code> which responds and notifies of changes accordingly. We had previously paired an item with a item controller within the <code>collection-change</code> event handler of the collection in <code>list-controller</code>:</p>
<p><em>/script/controller/list-controller.js</em></p>
<pre class="brush: jscript; first-line: 51; title: ;" title="">
(function assignCollectionHandlers($collection) {

  var EventKindEnum = collectionFactory.collectionEventKind,
      isValidValue = function(value) {
        return value &amp;&amp; (value.hasOwnProperty('length') &amp;&amp; value.length &gt; 0);
      };

  $collection.on('collection-change', function(event) {
    var model,
        itemController,
        $itemController,
        $itemView;
    switch( event.kind ) {
      case EventKindEnum.ADD:
        $itemView = $('&lt;li&gt;');
        model = event.items.shift();
        itemController = itemControllerFactory.create($itemView, model);
        $itemController = $(itemController);

        $itemView.appendTo(listController.$view);
        rendererList.addItem(itemController);
        $(listController).trigger(createSaveEvent(model));
        itemController.state = itemControllerFactory.state.EDITABLE;

        $itemController.on('remove', function(event) {
          listController.removeItem(model);
        });
        $itemController.on('commit', function(event) {
          if(!isValidValue(model.name)) {
            listController.removeItem(model);
          }
          else {
            $(listController).trigger(createSaveEvent(model));
          }
        });
        break;
      case EventKindEnum.REMOVE:
        model = event.items.shift();
        itemController = listController.getRendererFromItem(model),
        $itemController = $(itemController);

        if(itemController) {
          $itemView = itemController.parentView;
          $itemView.remove();
          itemController.dispose();
          $itemController.off('remove');
          $itemController.off('commit');
          rendererList.removeItem(itemController);
          $(listController).trigger(createRemoveEvent(model));
        }
        break;
      case EventKindEnum.RESET:
        break;
    }
  });

}($(collection)));
</pre>
<p>That <a href="http://benalman.com/news/2010/11/immediately-invoked-function-expression/" target="_blank">IIFE</a> was run in the module prior to returning the <code>list-controller</code> instance. Now, we could just copy that code from the <code>EventKindEnum.ADD</code> case and shove it into <code>setItems()</code>, applying it to each item in a loop, but that wouldn&#8217;t be very efficient, not to mention a cry-inducing solution for anyone (including yourself) which need to revisit your code.</p>
<h3>list-controller refactor</h3>
<p>I think we are going to have to get rid of this <strong>IIFE</strong>, but let&#8217;s do that modification in piecemeal; first, let&#8217;s strip out the item management when added to a collection:</p>
<p><em>/script/controller/list-controller.js</em></p>
<pre class="brush: jscript; first-line: 17; highlight: [19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42]; title: ;" title="">
var collection = collectionFactory.create(),
    rendererList = collectionFactory.create(),
    manageItemInList = function(item, listController) {
      var $itemView = $('&lt;li&gt;'),
          itemController = itemControllerFactory.create($itemView, item),
          $itemController = $(itemController),
          isValidValue = function(value) {
            return value &amp;&amp; (value.hasOwnProperty('length') &amp;&amp; value.length &gt; 0);
          };

      $itemView.appendTo(listController.$view);
      rendererList.addItem(itemController);

      $itemController.on('remove', function(event) {
        listController.removeItem(item);
      });
      $itemController.on('commit', function(event) {
        if(!isValidValue(item.name)) {
          listController.removeItem(item);
        }
        else {
          $(listController).trigger(createSaveEvent(item));
        }
      });
      return itemController;
    },
    listController = {
      $view: undefined,
      ...
    };
</pre>
<p>Most of what was held in the <code>EventKindEnum.ADD</code> case of the <code>collection-change</code> handler has been moved to its own function expression &#8211; <code>manageItemInList()</code>. If we look at how this case is modified we see that we have left state initialization and event dispatching:</p>
<p><em>/script/controller/list-controller.js</em></p>
<pre class="brush: jscript; first-line: 85; title: ;" title="">
case EventKindEnum.ADD:
  model = event.items.shift();
  itemController = manageItemInList(model, listController);
  itemController.state = itemControllerFactory.state.EDITABLE;
  $(listController).trigger(createSaveEvent(model));
  break;
</pre>
<p>When an item is added to the collection and the list-controller is notified, it creates a new <code>list-item-controller</code> using <code>manageItemInList()</code>, sets the controller&#8217;s state to <code>EDITABLE</code> and notifies of its addition. The last two operations are of note, as they only pertain to <em>new</em> additions to the collection &#8211; we don&#8217;t want such things for existing items being added to the list from <code>setItems()</code>.</p>
<p><em>/script/controller/list-controller.js</em></p>
<pre class="brush: jscript; first-line: 70; highlight: [71,72,73,74]; title: ;" title="">
setItems: function(items) {
  var i, length = items.length;
  collection = collectionFactory.create();
  for( i = 0; i &lt; length; i++ ) {
    manageItemInList(items[i], this);
    collection.addItem(items[i]);
  }
}
</pre>
<p>Now if we run the tests again:<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_20.png" alt="Passing on modifications to item management in list-controller" /></p>
<p>Passing! </p>
<h3>Tests</h3>
<p>I don&#8217;t think we are out of the woods yet, however&#8230; Let&#8217;s continue to add more expectations about setting the collection through <code>setItems() </code>on <code>list-controller</code>:</p>
<p><em>/test/jasmine/spec/list-controller.spec.js</em></p>
<pre class="brush: jscript; first-line: 75; title: ;" title="">
async.it('should dispatch event of remove-item from collection', function(done) {
  $(listController).on('remove-item', function(event) {
    $(listController).off('remove-item');
    expect(event.item).toBe(itemOne);
    done();
  });
  listController.removeItem(itemOne);
});
</pre>
<p>This test ensures that the <code>list-controller</code> should still be responding to and notifying of changes to the new collection created through <code>setItems()</code> just as it should if the <code>list-controller</code> was only being instructed to modify the collection through calls to <code>createNewItem()</code>.</p>
<h3>list-controller refactoring</h3>
<p>To save you some time in downloading more images, believe me when I tell you I just put us back in <span style="color: red;">red</span> <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  The reason being that dang <code>assignCollectionHandlers</code> <a href="http://benalman.com/news/2010/11/immediately-invoked-function-expression/" target="_blank">IIFE</a>. The collection that is created in <code>setItems()</code> is not being observed. The <strong>IIFE</strong> to assign events handlers is only run upon load of the module and only targets the collection instantiated in its declaration. In other words, any new collections will not be observed.</p>
<p>I say we move that <strong>IIFE</strong> out into its own expression:</p>
<p><em>/script/controller/list-controller.js</em></p>
<pre class="brush: jscript; first-line: 17; highlight: [19]; title: ;" title="">
var collection = collectionFactory.create(),
    rendererList = collectionFactory.create(),
    assignCollectionHandlers = function($collection) {
      var EventKindEnum = collectionFactory.collectionEventKind;
      $collection.on('collection-change', function(event) {
        var model,
            itemController,
            $itemController,
            $itemView;
        switch( event.kind ) {
          case EventKindEnum.ADD:
            model = event.items.shift();
            itemController = manageItemInList(model, listController);
            itemController.state = itemControllerFactory.state.EDITABLE;
            $(listController).trigger(createSaveEvent(model));
            break;
          case EventKindEnum.REMOVE:
            model = event.items.shift();
            itemController = listController.getRendererFromItem(model),
            $itemController = $(itemController);

            if(itemController) {
              $itemView = itemController.parentView;
              $itemView.remove();
              itemController.dispose();
              $itemController.off('remove');
              $itemController.off('commit');
              rendererList.removeItem(itemController);
              $(listController).trigger(createRemoveEvent(model));
            }
            break;
          case EventKindEnum.RESET:
            break;
        }
      });
    },
    manageItemInList = function(item, listController) {
      // implementation removed to reduce noise
    },
    listController = {
      // implementation removed to reduce noise
    }
</pre>
<p>We basically took what was the named <code>assignCollectionHandlers</code> <strong>IIFE</strong> and added it to the variable declarations within the <code>list-controller</code> module. That changes the code between those declarations and the return of the <code>listController</code> instance to:</p>
<p><em>/script/controller/list-controller.js</em></p>
<pre class="brush: jscript; first-line: 17; highlight: [29]; title: ;" title="">
var collection = collectionFactory.create(),
    rendererList = collectionFactory.create(),
    assignCollectionHandlers = function($collection) {
      // implementation removed to reduce noise
    },
    manageItemInList = function(item, listController) {
      // implementation removed to reduce noise
    },
    listController = {
      // implementation removed to reduce noise
    };

assignCollectionHandlers($(collection));

return listController;
</pre>
<p>With those changes we are still failing on the last spec we created, but more importantly we have not caused any other tests to fail!<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_21.png" alt="Still failing, but failing well!" /></p>
<p>Let&#8217;s get that last spec to pass:</p>
<p><em>/script/controller/list-controller.js</em></p>
<pre class="brush: jscript; first-line: 104; highlight: [110]; title: ;" title="">
setItems: function(items) {
  var i, length = items.length;
  collection = collectionFactory.create();
  for( i = 0; i &lt; length; i++ ) {
    manageItemInList(items[i], this);
    collection.addItem(items[i]);
  }
  assignCollectionHandlers($(collection));
}
</pre>
<p>Hurrah!<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_22.png" alt="Passing again!" /></p>
<p>Tagged <strong>0.1.13</strong>: <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.13" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.13</a></p>
<h2>Hooking it all together</h2>
<p>We have created our <code>storage-service</code> to communicate with <code>localStorage</code>, modified <code>list-controller</code> to dispatch events and accept initial items for its collection and all our tests are still passing! It&#8217;s a wonderous feeling. Now let&#8217;s get to actually hooking them up so that the <code>storage-service</code> is told how to handle changes to the list by responding to <code>list-controller</code> events.</p>
<p>Normally, in such situations I would create another component to the application that would serve as an mediator for such integration, receiving events from <code>list-controller</code> and invoking the <code>storage-service</code>. Naturally, that would also call for more tests in assuring that the mediator did its job correctly. I am not going to do that here. This is a small application meant for our own personal use and this series has gotten quite long; I don&#8217;t want to scare you away by adding more dependencies, but I would encourage you to do so on your own if you feel so&#8230;. just don&#8217;t forget the tests!</p>
<p>I think modifying the main JavaScript file (<em>/script/grocery-ls.js</em>) that defines the module dependencies and initializes the <strong>Grocery List</strong> application is fine enough for the task at hand:</p>
<p><em>/script/grocery-ls.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [12,15,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34]; title: ;" title="">
(function(window, require) {

  require.config({
    baseUrl: &quot;.&quot;,
    paths: {
      &quot;lib&quot;: &quot;./lib&quot;,
      &quot;script&quot;: &quot;./script&quot;,
      &quot;jquery&quot;: &quot;./lib/jquery-1.8.3.min&quot;
    }
  });

  require( ['jquery', 'script/controller/list-controller', 'script/service/storage-service'],
            function($, listController, storageService) {

    var $listController = $(listController);
    listController.setView($('section.groceries ul'));

    storageService.getItems().then(function(items) {
      listController.setItems(items);
    });
    $listController.on('save-item', function(event) {
      storageService.saveItem(event.item).then(function(item) {
        console.log('Item saved! ' + item.name);
      }, function(error) {
        console.log('Item not saved: ' + error)
      });
    });
    $listController.on('remove-item', function(event) {
      storageService.removeItem(event.item).then(function(item) {
        console.log('Item removed! ' + item.name);
      }, function(error) {
        console.log('Item not removed: ' + error);
      });
    });
    $('#add-item-button').on('click', function(event) {
      listController.createNewItem();
    });

  });

}(window, requirejs));
</pre>
<p>Just a slight modification to the main file. We added <code>storage-service</code> as an initial dependency, request and supply stored items to the list-controller and respond to <code>save-item</code> and <code>remove-item</code> events, forwarding actions along to the <code>storage-service</code> appropriately.</p>
<p>If we run the application now, we can add, mark-off, remove items from the list. Same as before, but now, if we refresh the page, items and their state a persisted!</p>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_ix_27.png" alt="Grocery list application" /></p>
<p><small>It may look a little different than your if you have been following along in the code. I added some nice styling and committed it to the repo.</small></p>
<p>Tagged <strong>0.2.0</strong> : <a href="https://github.com/bustardcelly/grocery-ls/tree/0.2.0" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.2.0</a></p>
<h2>Conclusion</h2>
<p>We have completed our <strong>Grocery List</strong> application and have it fully tested (well, hopefully <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> ). We now have a grocery list that we can curate and is persisted in the browser. It should be noted that it is not persistent across browser<strong>s</strong>, plural &#8211; so make sure to open it in the same browser on your mobile device when creating the list and shopping. I am most likely going to whip up a little server to persist the list remotely, but am not going to document that in this series. It may end up in the <a href="https://github.com/bustardcelly/grocery-ls">github repo</a> eventually, however, so keep an eye out.</p>
<p>Thanks for sticking around in this long series (<em>ten parts!</em>) of building an application by trying to adhere to <strong>TDD</strong>. I may have gone off course here and there, but I hope it was informative in any way.</p>
<p>Cheers!</p>
<p>&#8212;-</p>
<h1>Link Dump</h1>
<h2>Reference</h2>
<p><a href="http://tddjs.com/" target="_blank">Test-Driven JavaScript Development by Christian Johansen</a><br />
<a href="http://dannorth.net/introducing-bdd/" target="_blank">Introducing BDD by Dan North</a><br />
<a href="http://cumulative-hypotheses.org/2011/08/30/tdd-as-if-you-meant-it/">TDD as if you Meant it by Keith Braithwaite</a><br />
<a href="http://requirejs.org/" target="_blank">RequireJS</a><br />
<a href="https://github.com/amdjs/amdjs-api/wiki/AMD" target="_blank">AMD</a><br />
<a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a><br />
<a href="http://sinonjs.org/" target="_blank">Sinon</a><br />
<a href="https://github.com/derickbailey/jasmine.async" target="_blank">Jasmine.Async</a></p>
<h2>Post Series</h2>
<p><a href="https://github.com/bustardcelly/grocery-ls">grocery-ls github repo</a><br />
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i" target="_blank">Part I &#8211; Introduction</a><br />
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii">Part II &#8211; Feature: Add Item</a><br />
<a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii">Part III &#8211; Feature: Mark-Off Item</a><br />
<a href="http://custardbelly.com/blog/2012/12/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-iv">Part IV &#8211; Feature: List-Item-Controller</a><br />
<a href="http://custardbelly.com/blog/2012/12/31/the-making-of-a-test-driven-grocery-list-application-in-js-part-v/">Part V &#8211; Feature: List-Controller Refactoring</a><br />
<a href="http://custardbelly.com/blog/2013/01/08/the-making-of-a-test-driven-grocery-list-application-in-js-part-vi/" target="_blank">Part VI &#8211; Back to Passing</a><br />
<a href="http://custardbelly.com/blog/2013/01/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-vii/">Part VII &#8211; Remove Item</a><br />
<a href="http://custardbelly.com/blog/2013/01/22/the-making-of-a-test-driven-grocery-list-application-part-viii/">Part VIII &#8211; Bug Fixing</a><br />
<a href="http://custardbelly.com/blog/2013/02/15/the-making-of-a-test-driven-grocery-list-application-in-js-part-ix/">Part IX &#8211; Persistence</a><br />
<a href="http://custardbelly.com/blog/2013/03/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-x/">Part X &#8211; It Lives!</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/amd/" title="View all posts in AMD" rel="category tag">AMD</a>,  <a href="http://custardbelly.com/blog/category/javascript/" title="View all posts in JavaScript" rel="category tag">JavaScript</a>,  <a href="http://custardbelly.com/blog/category/requirejs/" title="View all posts in RequireJS" rel="category tag">RequireJS</a>,  <a href="http://custardbelly.com/blog/category/grocery-ls/" title="View all posts in grocery-ls" rel="category tag">grocery-ls</a>,  <a href="http://custardbelly.com/blog/category/jasmine/" title="View all posts in jasmine" rel="category tag">jasmine</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2013/03/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-x/#comments" rev="post-823"  title="Comment on The Making of a Test-Driven Grocery List Application in JS: Part X">1 comment</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2013-03-06T07:15">March 6, 2013</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-823-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-777" class="post-777 post hentry category-amd category-javascript category-requirejs category-grocery-ls category-jasmine category-unit-testing full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2013/02/15/the-making-of-a-test-driven-grocery-list-application-in-js-part-ix/" title="Permanent link to The Making of a Test-Driven Grocery List Application in JS: Part IX" rel="bookmark" rev="post-777">The Making of a Test-Driven Grocery List Application in JS: Part IX</a></h1>
	
	<div class="entry-content full-content">
		<p><em>This is the ninth installment in a series of building a Test-Driven Grocery List application using <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> and <a href="http://requirejs.org" target="_blank">RequireJS</a>. To learn more about the intent and general concept of the series please visit <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i/">The Making of a Test-Driven Grocery List Application in JavaScript: Part I</a></em><br />
&#8212;</p>
<h1>Introduction</h1>
<p>In the <a href="http://custardbelly.com/blog/2013/01/22/the-making-of-a-test-driven-grocery-list-application-part-viii/" target="_blank">previous article</a>, we pretty much wrapped up all the user-based functionality and ended with a working <strong>Grocery List</strong> application that we could start using. There is one little snag though&#8230; no persistance. If you made this gloriously elaborate list that detailed everything you needed at the store, then closed the browser and reopened it, the list was gone! That will not do.</p>
<p>There are many factors and paradigms to consider in choosing the level of persistence when it comes to handling session and user based applications. Without introducing a discussion about authentication, when approaching the integration persistence you have to take into account system-based vs user-based persistence, client-side vs server-side storage, and &#8211; nowadays, more commonly &#8211; the cross pollination of the two: <a href="http://en.wikipedia.org/wiki/Occasionally_connected_computing" target="_blank">occasional-connectivity</a>. (<em>not to mention browser support in all this</em>) We won&#8217;t be getting into all of that <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  We&#8217;ll be using the <code>localStorage</code> of today&#8217;s modern browser.</p>
<p>The intent of this article in the series is to implement client-side, browser-based persistence for the <strong>Grocery List</strong> application. It would be nice to store our list remotely so it can be accessed by all browsers on all devices, but I feel it would introduce too many new libraries, software and concepts to this series. I will most likely add it personally after this series is over, and I invite you to as well &#8211; keeping in mind to do it using TDD <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  The most I can offer at this point, is to keep the code we will write clean enough to support such future endeavours.</p>
<h1>What Tests to Modify to Get Us There?</h1>
<p>Good question. Let&#8217;s first think about what actions will prompt an update to the list in storage. Actually, if we look at the feature specs we have created throughout this series and separated out into the <code>/feature</code> directory itself, we pretty much have all the defined actions that will trigger an update to the stored list:<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_1.png" alt="Spec listing" /></p>
<p>All of these features are a result from interacting with the <code>list-controller</code>. My first inkling is to add responsibility to the <code>list-controller</code> so that, along with the other operations it handles in list management, it communicates with a service layer to update the <strong>Grocery List</strong> in storage. However, I think that would add too much burden on the <code>list-controller</code> and, when taking into account that requirements around storage may change, the introduction of such complexity into the <code>list-controller</code> may quickly make our tests feel chaotic.</p>
<p>As such, I propose that we should start off with the expectation that the <code>list-controller</code> will notify of its underlying collection having been modified, not only upon its change in length, but of the items within the collection, as well. We can then capture those events and forward them on to whichever service implementation we have without having to pass that dependency into the <code>list-controller</code> and burdening it with such communication.</p>
<h2>New Expectation for Add Item</h2>
<p>To start, let&#8217;s add a quick spec to the <em>Add Item</em> feature that defines an expectation from the <code>list-controller</code> to notify when an item has been added:</p>
<p><em>/test/jasmine/spec/feature/additem.spec.js</em></p>
<pre class="brush: jscript; first-line: 45; title: ;" title="">
async.it('should dispatch a save-item event', function(done) {
  var newItem;

  $(listController).on('save-item', function(event) {
    expect(event.item).not.toBeUndefined();
    $(listController).off('save-item');
    done();
  });
  newItem = listController.createNewItem();
});
</pre>
<p>In creating this expectation, we have also begun to define the actual make-up of the event we intend to receive: the event type being <code>save-item</code> and the access of the <code>item</code> that was saved.</p>
<p>Run it and we are red, as expected:<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_2.png" alt="Failing test on add item event response" /></p>
<p>Taking what we have defined as our expectation when an item is added, we&#8217;ll modify the list-controller to get this passing. First we&#8217;ll add a factory method to generate <code>save-item</code> events:</p>
<p><em>/script/controller/list-controller.js</em></p>
<pre class="brush: jscript; first-line: 5; title: ;" title="">
function createSaveEvent(item) {
  var event = $.Event('save-item');
  event.item = item;
  return event;
}
</pre>
<p>Fairly straight-forward and similar to other event factory methods declared previously in this series. Since we are addressing an expectation of event notification on add of item, we know where in the list-controller we can add that dispatch &#8211; in response to the addition of an item on the collection:</p>
<p><em>/script/controller/list-controller.js</em></p>
<pre class="brush: jscript; first-line: 61; highlight: [63]; title: ;" title="">
$itemView.appendTo(listController.$view);
rendererList.addItem(itemController);
$(listController).trigger(createSaveEvent(model));
itemController.state = itemControllerFactory.state.EDITABLE;
</pre>
<p>Back in business.<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_3.png" alt="Passing test on add item event response" /></p>
<h2>New Expectation for Remove Item</h2>
<p>Let&#8217;s quickly just do a similar modification to the <code>list-controller</code> with regards to the <em>Remove Item</em> feature. First we&#8217;ll append a spec in the <em>removeitem.spec</em> suite with an expectation of being notified on <code>remove-item</code>:</p>
<p><em>/test/jasmine/spec/feature/removeitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 30; title: ;" title="">
async.it('should dispatch a remove-item event', function(done) {
  var removedItem;

  $(listController).on('remove-item', function(event) {
    expect(event.item).not.toBeUndefined();
    $(listController).off('remove-item');
    done();
  });
  removedItem = listController.removeItem(groceryItem);
});
</pre>
<p>Sparing you another image of the specrunner turning <span style='color: red;'>red</span>, that will fail with the timeout that we saw before. We&#8217;ll fix that up by adding a trigger in the removal of an item from the collection handler in <code>list-controller</code>. First with the addition of a factory method for the <code>remove-item</code> event:</p>
<p><em>/script/controller/list-controller.js</em></p>
<pre class="brush: jscript; first-line: 11; title: ;" title="">
function createRemoveEvent(item) {
  var event = $.Event('remove-item');
  event.item = item;
  return event;
}
</pre>
<p>And then with an additional line to the <code>remove</code> response on the collection:</p>
<p><em>/script/controller/list-controller.js</em></p>
<pre class="brush: jscript; first-line: 81; highlight: [93]; title: ;" title="">
case EventKindEnum.REMOVE:
  model = event.items.shift();
  itemController = listController.getRendererFromItem(model),
  $itemController = $(itemController);

  if(itemController) {
    $itemView = itemController.parentView;
    $itemView.remove();
    itemController.dispose();
    $itemController.off('remove');
    $itemController.off('commit');
    rendererList.removeItem(itemController);
    $(listController).trigger(createRemoveEvent(model));
  }
break;
</pre>
<p>Run the tests, and we are back to passing:<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_4.png" alt="Passing on removal event from list-controller" /></p>
<h2>New Expectation for Save Item</h2>
<p>Sort of repetitive, but we are on a roll&#8230; let&#8217;s go through the similar process to ensure that a notification for <code>save-item</code> is dispatched when the user has modified its name and committed it to the list &#8211; the <em>Save Item</em> feature we added in the <a href="http://custardbelly.com/blog/2013/01/22/the-making-of-a-test-driven-grocery-list-application-part-viii/" target="_blank">last article</a>.</p>
<p><em>/test/jasmine/spec/feature/saveitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 79; title: ;" title="">
async.it('should dispatch a save-item event', function(done) {

  $(listController).on('save-item', function(event) {
    expect(event.item).toEqual(item);
    $(listController).off('save-item');
    done();
  });

  item.name = itemName;
  itemRenderer.state = itemControllerFactory.state.UNEDITABLE;
});
</pre>
<p>That&#8217;ll put us in the <span style="color: red;">red</span> with the same old timeout issue. Getting back to green, we&#8217;ll trigger the <code>save-item</code> event upon committal of the item to the list, which if you remember &#8211; and is described in the test &#8211; is in response to the <code>list-item-controller</code> notifying of change to the item model:</p>
<p><em>/test/jasmine/spec/feature/list-controller.js</em></p>
<pre class="brush: jscript; first-line: 75; highlight: [79,80,81]; title: ;" title="">
$itemController.on('commit', function(event) {
  if(!isValidValue(model.name)) {
    listController.removeItem(model);
  }
  else {
    $(listController).trigger(createSaveEvent(model));
  }
});
</pre>
<p>Back to green!<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_5.png" alt="Passing on commital of item form list-item-controller" /></p>
<p>The amount of those little dots just keeps growing. Makes you feel all warm inside. Cherish that, &#8217;cause it will go away&#8230;</p>
<h3>Hold Up</h3>
<p>Just stepping back, it may seem a little odd that we are calling <code>save-item</code> when we add and commit the item to the list; after all they are the same item, we do we need to notify on save multiple times? The reason being is that upon any modification to an item &#8211; including its existence &#8211; the store needs to be modified. We haven&#8217;t gotten into the service layer for storage yet, but it will be abstracted out that a response from save-item will be internally handled as whether to append the item (from add) or to update an item already existant (from commit). Until we get to that service layer implementation for <code>localStorage</code>, we&#8217;ll go about setting expectations of <code>save-item</code> notification on modification to an item.</p>
<p>Which actually brings up a good point&#8230; what about marking off an item? We will need to notify on change of an item being marked off, as well.</p>
<h2>New Expectation for Mark-Off Item</h2>
<p>We tackled the <em>Mark-Off Item</em> feature a <a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii/" target="_blank">while back</a> in this series. Just a quick refresher on the story:</p>
<p><em>// story</em><br />
—<br />
<strong>Story</strong>: Item is marked off on grocery list</p>
<p><strong>In order to</strong> remember what items have already made it to the cart<br />
<strong>As a</strong> grocery shopper<br />
<strong>I want to</strong> mark an item as being attained on the grocery list.<br />
—</p>
<p>We implemented the feature, and upon user press of the item while in non-edit mode, it toggles its <code>marked</code> property on the model and updates the UI to add or remove a <del datetime="2013-02-01T10:32:47+00:00">strikethrough</del> on the label.</p>
<p>We&#8217;ve got a spec suite for the <em>Mark-Off Item</em> feature already, so we&#8217;ll append an expectation for <code>save-item</code> to it just as we have done with the other feature specs in this article:</p>
<p><em>/test/jasmine/spec/feature/markitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 44; title: ;" title="">
async.it('should dispatch a save-item event', function(done) {

   var timeout = setTimeout(function() {
     clearTimeout(timeout);
     $(listController).off('save-item');
   }, jasmine.DEFAULT_TIMEOUT_INTERNAL);

  $(listController).on('save-item', function(event) {
    expect(event.item).toBe(item);
    $(listController).off('save-item');
    done();
  });

  item.marked = true;
});
</pre>
<p>&#8230; and that will bring us back to <span style="color: red;">failing</span>.<br />
<small>The <code>timeout</code> placed in there is just to ensure that listener(s) to the <code>save-item</code> event are removed regardless of the async test timing out.</small></p>
<p>The resolution to the issue is a trickier one than those of the previous in this article, however. Currently the <code>list-item-controller</code> is the only component that actually concerned with this change in marked status. It is not concerned with notifying any other party of the change to its model. The model does, however, notify of any property changes. I see two ways in which we can get back to <span style="color: green;">passing</span>:</p>
<ol type="a">
<li>Assign a handler for <code>property-change</code> on model when it is first created and returned from <code>listController.createNewItem()</code></li>
<li>Dispatch a <code>commit</code> event from <code>list-item-controller</code> on change to <code>marked</code> property on the underlying model</li>
</ol>
<p>While both options will most likely get us where we need to be, the former adds additional management to the <code>list-controller</code>; its already listening in on <code>commit</code> from its <code>list-item-controller</code> instance, so modifying the <code>list-item-controller</code> to notify of change to the <code>marked</code> property seems to be the path of least resistance.</p>
<p>We had previously set up the <code>commit</code> notification on response from leaving the <code>EDITABLE</code> state of the <code>list-item-controller</code>:</p>
<p><em>/script/controller/list-item-controller.js</em></p>
<pre class="brush: jscript; first-line: 45; title: ;" title="">
// append state-based item.
if(event.newState === stateEnum.UNEDITABLE) {
  controller.parentView.append(controller.$uneditableView);
  controller.save();
}
</pre>
<p>That implementation got us to passing previously in which we described the expectation of a user committing an item to the list with a valid name (un-empty string). Our issue at hand is to also invoke the <code>save()</code> method on <code>list-item-controller</code> when the <code>marked</code> property is modified. In thinking about it now, while the committal of an item is tied to the change of state, it runs a validation on the <code>name</code> property to ensure that the item can be added/kept in the collection &#8211; so, in actuality <code>commit</code> can be tied to property updates to the item model.</p>
<p>As such, let&#8217;s remove line <code>48</code> from the above snippet and insert the invocation of <code>save()</code> to the handler in <code>list-item-controller</code> for <code>property-change</code> on the model:</p>
<p><em>/script/controller/list-item-controller.js</em></p>
<pre class="brush: jscript; first-line: 102; highlight: [105]; title: ;" title="">
$(this.model).on('property-change', (function(controller) {
  return function(event) {
    handlePropertyChange.call(null, controller, event);
    controller.save();
  };
}(this)));
</pre>
<p>Run the specrunner again&#8230;<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_5_fail.png" alt="We broke it" /></p>
<p>&#8230; and we broke it <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_sad.gif' alt=':(' class='wp-smiley' /> </p>
<p>The reason for those <span style="color: red;">X</span>&#8217;s is due to the logic we have held in <code>list-controller</code> on save of an item: it checks it&#8217;s <code>name</code> property and removes it from the list if considered an invalid value &#8211; which an empty string is.</p>
<p>I sense some modification to such logic in the future, but for now we can get the tests back to passing by providing a <code>name</code> property value to the created item in our mark-item spec:</p>
<p>/tests/jasmine/spec/feature/markitem.spec.js</p>
<pre class="brush: jscript; first-line: 9; highlight: [11]; title: ;" title="">
beforeEach( function() {
  item = listController.createNewItem();
  item.name = 'apples';
});
</pre>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_ix_6.png" alt="Passing on model property update" /></p>
<p>We&#8217;re green!</p>
<p>Tagged <strong>0.1.13</strong>: <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.13" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.13</a></p>
<h3>Settle Down</h3>
<p>We have verified our expectations of <code>save-item</code> and <code>remove-item</code> events being dispatched from <code>list-controller</code> &#8211; new and model updates issuing the former, removal issuing the later. The work we have done was to separate concerns and not burden the <code>list-controller</code> itself with service communication for persisting the <strong>Grocery List</strong> items across browser sessions, but we have yet to address the actual service layer implementation that will take all these notifications.</p>
<h2>Storage Service</h2>
<p>The <code>storage-service</code> will provide a service layer for communication with storage &#8211; whether that be remote or local. It will serve as a facade to an existing storage of grocery list items persisted somewhere other than the current application session. For the purposes of this article, that persistence layer is going to be the <code>localStorage</code> of the browser.</p>
<p>While fleshing out the storage service and its API, we&#8217;ll <em>loosely</em> use the technique of <a href="http://coderetreat.org/facilitating/activities/tdd-as-if-you-meant-it" target="_blank">&#8216;TDD as if you meant it&#8217;</a>. I say <em>loosely</em> in part because to fully do it and explain each step would be a lot of noise for this article; the main practice point to take away &#8211; and I hope I express &#8211; is that the component you are testing is actually being built while you make the expectations for it pass.</p>
<h3>Tests</h3>
<p>To start, we&#8217;ll create a bare-bones module for our service layer:</p>
<p><em>/script/service/storage-service</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define(['jquery'], function($) {

  var store = {};
  return store;

});
</pre>
<p>And let&#8217;s create the beginnings of our test:</p>
<p><em>/test/jasmine/spec/storage-service.spec.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define(['jquery', 'script/service/storage-service', 'script/model/grocery-ls-item'],
        function($, store, modelFactory) {

  describe('Grocery List storage-service', function() {

    describe('getItems()', function() {

      it('should return of type array', function() {
        expect(false).toEqual(true);
      });

      it('should return array of grocery-ls-item types', function() {
        expect(false).toEqual(true);
      });

    });

  });

});
</pre>
<p>In the test we have set up some tests for the <code>getItems()</code> method for the service. Prior to any implementation, it should be known that communication with the <code>storage-service</code> will be considered asynchronous &#8211; meaning all operations will return a <a href="http://api.jquery.com/category/deferred-object/" target="_blank">jQuery Deferred</a>. This will abstract out the storage proxy that will be employed by the <code>storage-service</code> and will respond in an asynchronous manner regardless of whether the store is immediately accessible &#8211; as in the case of <code>localStorage</code> &#8211; or remote.</p>
<p><small>Truthfully, in practice, I should only do one tests at a time, but we are testing the expectations for access of the same item listing; to save you from reading the ramblings of adding another test, I declared them both at the start.</small></p>
<p>Let&#8217;s stub out the API and start testing and building the <code>storage-service</code>:</p>
<p><em>/test/jasmine/spec/storage-service.spec.js</em></p>
<pre class="brush: jscript; first-line: 6; highlight: [8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,31,32,36,37]; title: ;" title="">
describe('getItems()', function() {

  var items,
      itemOne = modelFactory.create(),
      itemTwo = modelFactory.create(),
      async = new AsyncSpec(this);

  async.beforeEach( function(done) {
    var deferred = $.Deferred(),
        getStub = sinon.stub().returns(deferred);

    deferred.resolve([itemOne, itemTwo]);
    store.getItems = getStub;

    store.getItems().then(function(list) {
      items = list;
      done();
    });
  });

  afterEach( function() {
    //
  });

  it('should return of type array', function() {
    expect(Array.isArray(items)).toEqual(true);
    expect(items.length).toEqual(2);
  });

  it('should return array of grocery-ls-item types', function() {
    expect(items[0]).toBe(itemOne);
    expect(items[1]).toBe(itemTwo);
  });

});
</pre>
<p>In the <code>beforeEach()</code>, we&#8217;re using anonymous stubs from <a href="http://sinonjs.org/" target="_blank">SinonJS</a>, which allow us to stub out methods that may not necessarily already exist on an object. I have used it previously in this series, but we&#8217;ll be using it pretty much exclusively while we stub out the API for the <code>storage-service</code>.</p>
<p>Staying true to our idea that the service will provide an asynchronous communication layer, <code>getItems()</code> returns a deferred which has resolved to a listing of two <code>grocery-ls-item</code> instances in our tests.</p>
<p>Sometimes when working with a single feature, I like to isolate it out from my tests for a bit. Here is what the specrunner reports with running just <strong>storage-service.spec</strong>:<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_7.png" alt="Passing on succss of getItems() in service" /></p>
<p>We could move that implementation to <code>storage-service</code> module now, but we are sort of in a <a href="http://en.wikipedia.org/wiki/Chicken_or_the_egg" target="_blank">chicken-or-the-egg</a> scenario. We&#8217;ve canned the resolved <code>grocery-ls-item</code> list in the test, but how does the list get filled up in an actual scenario for <code>storage-service</code>? It&#8217;s an excellent question, and something I often puzzle myself with. I mean, we&#8217;ll need a <code>saveItem()</code> method no doubt in order to add items to the store. But shouldn&#8217;t that method now be stubbed out in a new test? And how do I test that <code>saveItem()</code> works without <code>getItems()</code> being already tested and verified? I could go in circles&#8230;</p>
<p>Let&#8217;s just stub out an <code>saveItem()</code> method on <code>storage-service</code> and, afterward, set expectations in another spec suite:</p>
<p><em>/test/jasmine/spec/storage-service.spec.js</em></p>
<pre class="brush: jscript; first-line: 13; highlight: [14,15,18,19,20,21,23,26,27]; title: ;" title="">
async.beforeEach( function(done) {
  var call = 0,
      tempList = [],
      deferred = $.Deferred(),
      getStub = sinon.stub().returns(deferred),
      saveStub = sinon.stub().callsArgOn(0, store),
      appendItem = function() {
        tempList.push((call++%2 === 0) ? itemOne : itemTwo);
      };

  store.saveItem = saveStub;
  store.getItems = getStub;

  store.saveItem(appendItem);
  store.saveItem(appendItem);
  store.getItems().then(function(list) {
    items = list;
    done();
  });
  deferred.resolve(tempList);
});
</pre>
<p>With these modifications, we have assigned an anonymous stub &#8211; <code>saveStub</code> &#8211; as the <code>saveItem</code> method on the <code>store</code> and specified that the function-local <code>appendItem</code> method should be invoked, appending items to the list prior to each of our tests. </p>
<p>A little more work in setup and slightly unrealistic in telling of the arguments to be given to <code>saveItem()</code>, but it kept us on green without having to hard code the result; it&#8217;s a litte truer to life than the previous setup, and still passes:</p>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_ix_7.png" alt="Passing on succss of getItems() in service" /></p>
<h3>Implementation</h3>
<p>Alright, so I think we should move this out to <code>storage-service</code> now and trash the stubbing in the test &#8211; we&#8217;ve got our expectations:</p>
<p><em>/script/service/storage-service.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define(['jquery'], function($) {

  var itemCache = [],
      store = {
        saveItem: function(item) {
          var deferred = $.Deferred();
          itemCache[itemCache.length] = item;
          return deferred.resolve(item);
        },
        getItems: function() {
          var deferred = $.Deferred();
          deferred.resolve(itemCache);
          return deferred;
        }
      };

  return store;

});
</pre>
<p><em>/test/jasmine/spec/storage-service.spec.js</em></p>
<pre class="brush: jscript; first-line: 6; title: ;" title="">
describe('getItems()', function() {

  var items,
      itemOne = modelFactory.create(),
      itemTwo = modelFactory.create(),
      async = new AsyncSpec(this);

  async.beforeEach( function(done) {
    store.saveItem(itemOne);
    store.saveItem(itemTwo);
    store.getItems().then(function(value) {
      items = value;
      done();
    });
  });

  afterEach( function() {
    //
  });

  it('should return of type array', function() {
    expect(Array.isArray(items)).toEqual(true);
    expect(items.length).toEqual(2);
  });

  it('should return array of grocery-ls-item types', function() {
    expect(items[0]).toBe(itemOne);
    expect(items[1]).toBe(itemTwo);
  });

});
</pre>
<p>Run that, and we are still green!<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_7.png" alt="Passing on succss of getItems() in service" /></p>
<h3>Tests</h3>
<p>Now that we can verify that <code>saveItem()</code> is working enough for our <code>getItem</code> spec, let&#8217;s properly set the expectations for <code>saveItem</code>, as well, in our tests:</p>
<p><em>/test/jasmine/spec/storage-service.spec.js</em></p>
<pre class="brush: jscript; first-line: 0; title: ;" title="">
describe('saveItem()', function() {

  var itemOne = modelFactory.create(),
      itemTwo = modelFactory.create(),
      async = new AsyncSpec(this);

  beforeEach( function() {
    store.saveItem(itemOne);
  });

  afterEach( function() {
    //
  });

  async.it('should be grow the length of items', function(done) {
    store.getItems().then( function(items) {
      expect(items.length).toEqual(1);
      done();
    });
  });

});
</pre>
<p>Simple enough. Back to the specrunner:<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_8.png" alt="Failing on saveItem of storage-service" /></p>
<p>Oh noes! Our expectation is that the length of items is only 1. We have only specified one addition of an item in the setup&#8230; where did the length of 5 come from!? Put down the abacus &#8211; there are better things to throw. But before that, I have an explanation: we haven&#8217;t been cleaning up. We have let <code>afterEach()</code> just quietly be invoked without a job to do.</p>
<p>To do just enough in getting our tests pass, we can update the <code>afterEach()</code> declarations in each spec suite to the following:</p>
<pre class="brush: jscript; title: ;" title="">
async.afterEach( function(done) {
  store.getItems().then(function(items) {
    items.length = 0;
    done();
  });
});
</pre>
<p>That will get us back to passing:<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_9.png" alt="Passing on saveItem spec." /></p>
<p>I am not particularly fond of that solution, however. Mainly because I think it conveys a usage of the API on <code>storage-service</code> that I would not condone: directly mutating the underlying list of <code>storage-service</code> from another party. </p>
<p>I&#8217;m not gonna get crazy with the lock-down and privacy of properties and start introducing the latest-and-greatest framework that tries to tout that they really are just a library all in the attempt to stop someone from directly accessing the underlying array of items on <code>storage-service</code>. If some developers gonna go crazy and do so, hopefully we can find it in more tests later or they can look at our tests as a guideline of how to do what they want. </p>
<p>As such, I think we should add a method to <code>storage-service</code> that simply allows for emptying the list. First the expectation:</p>
<p><em>/test/jasmine/spec/storage-service.spec.js</em></p>
<pre class="brush: jscript; first-line: 61; title: ;" title="">
describe('empty()', function() {

  var itemOne = modelFactory.create(),
      itemTwo = modelFactory.create(),
      async = new AsyncSpec(this);

  beforeEach( function() {
    store.saveItem(itemOne);
    store.saveItem(itemTwo);
  });

  afterEach( function() {
    store.empty();
  });

  async.it('should be appended to the list of items', function(done) {
    store.empty().then( function(items) {
      expect(items.length).toEqual(0);
      done();
    });
  });

});
</pre>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_ix_10.png" alt="Failing on empty()" /></p>
<p><em>/script/service/storage-service.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [15,16,17,18,19,20]; title: ;" title="">
define(['jquery'], function($) {

  var itemCache = [],
      store = {
        saveItem: function(item) {
          var deferred = $.Deferred();
          itemCache[itemCache.length] = item;
          return deferred.resolve(item);
        },
        getItems: function() {
          var deferred = $.Deferred();
          deferred.resolve(itemCache);
          return deferred;
        },
        empty: function() {
          var deferred = $.Deferred();
          itemCache.length = 0;
          deferred.resolve(itemCache);
          return deferred;
        }
      };

  return store;
});
</pre>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_ix_11.png" alt="Passing on empty()" /></p>
<p>Alright! We are passing expectations on three parts of the API for <code>storage-service</code>. Now let&#8217;s think of what else we need&#8230; I think only a <code>removeItem()</code> method will suffice. In working as we have previously in this article &#8211; stubbing out methods to be added to the <code>storage-service</code> implementation &#8211; we can add a spec suite for <code>removeItem()</code> such as the following:</p>
<p><em>/test/jasmine/spec/storage-service.spec.js</em></p>
<pre class="brush: jscript; first-line: 85; title: ;" title="">
describe('removeItem()', function() {

  var items,
      itemOne = modelFactory.create(),
      itemTwo = modelFactory.create(),
      async = new AsyncSpec(this),
      deferred = $.Deferred(),
      removeItemFromList = function() {
        deferred.resolve(items.splice(0, 1));
      };

  async.beforeEach( function(done) {
    var removeItemStub = sinon.stub().returns(deferred).callsArgOn(0, store);

    store.saveItem(itemOne);
    store.saveItem(itemTwo);
    store.removeItem = removeItemStub;
    store.getItems().then( function(value) {
      items = value;
      done();
    });
  });

  afterEach( function() {
    store.empty();
  });

  async.it('should shorten length of the list', function(done) {
    store.removeItem(removeItemFromList).then( function(item) {
      store.getItems().then( function(items) {
        expect(items.length).toEqual(1);
        done();
      });
    });
  });

});
</pre>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_ix_12.png" alt="Passing on initial removeItem()" /></p>
<p>I think there are more expectations to assert for the <code>removeItem()</code> spec suite, but for now we are passing and we&#8217;ll move the implementation over to <code>storage-service</code>:</p>
<p><em>/script/service/storage-service.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [10,11,12,13,14,15,16,17,18,19,20]; title: ;" title="">
define(['jquery'], function($) {

  var itemCache = [],
      store = {
        saveItem: function(item) {
          var deferred = $.Deferred();
          itemCache[itemCache.length] = item;
          return deferred.resolve(item);
        },
        removeItem: function(item) {
          var deferred = $.Deferred(),
              itemIndex = itemCache.indexOf(item),
              removedItem;

          if(itemIndex &gt; -1) {
            itemCache.splice(itemIndex, 1);
            removedItem = item;
          }
          return deferred.resolve(removedItem);
        },
        getItems: function() {
          var deferred = $.Deferred();
          deferred.resolve(itemCache);
          return deferred;
        },
        empty: function() {
          var deferred = $.Deferred();
          itemCache.length = 0;
          deferred.resolve(itemCache);
          return deferred;
        }
      };

  return store;

});
</pre>
<p>Now, we&#8217;ll update the spec suite for <code>removeItem()</code> and add a few more expectations to ensure the item removal process is correct:</p>
<p><em>/test/jasmine/spec/storage-service.spec.js</em></p>
<pre class="brush: jscript; first-line: 85; title: ;" title="">
describe('removeItem()', function() {

  var itemOne = modelFactory.create(),
      itemTwo = modelFactory.create(),
      async = new AsyncSpec(this);

  beforeEach( function() {
    itemOne.name = 'one';
    store.saveItem(itemOne);
    store.saveItem(itemTwo);
  });

  afterEach( function() {
    store.empty();
  });

  async.it('should shorten length of the list', function(done) {
    store.removeItem(itemOne).then( function(item) {
      store.getItems().then( function(items) {
        expect(items.length).toEqual(1);
        done();
      });
    });
  });

  async.it('should remove item specified from the list', function(done) {
    store.removeItem(itemOne).then( function(item) {
      store.getItems().then( function(items) {
        expect(items.indexOf(itemOne)).toEqual(-1);
        done();
      });
    });
  });

  async.it('should return the item removed if found', function(done) {
    store.removeItem(itemOne).then( function(item) {
      expect(item).toEqual(itemOne);
      done();
    });
  });

  async.it('should return undefined if item not found', function(done) {
    store.removeItem(modelFactory.create()).then( function(item) {
      expect(item).toBeUndefined();
      done();
    });
  });

});
</pre>
<p>&#8230; and we&#8217;re still in business!<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_13.png" alt="Complete and passing removeItem specs" /></p>
<h3>Revisiting saveItem()</h3>
<p>When we setup the <code>saveItem</code> stub for our <code>getItem()</code> spec suite, we really only focused on getting the expectations to pass. To get back to <span style="color: green;">green</span> &#8211; at the time &#8211; we were only concerned with appending items to the list. I think this needs to be looked at again.</p>
<p>If we remember back to the notifications we set up for the <code>list-controller</code>, it will dispatch a <code>save-item</code> event upon the existence of a new item, as well as the modification to an existing item. So we will pass that item through the <code>storage-service</code> using <code>saveItem()</code> but we don&#8217;t want to continually append items that are previously stored to the list &#8211; if so, we&#8217;d be buying a lot of <del datetime="2013-02-07T10:18:31+00:00">spinich</del> <del datetime="2013-02-07T10:18:31+00:00">spinnash</del> spinach.</p>
<p><small>Normally I wouldn&#8217;t cut corners: a feature spec should be written up for what I have described here prior to modifying the tests. To save you some scrolling, however, I decided to not include walking through one and letting the expectations that we define in the following speak for the specification.</small></p>
<p><em>/test/jasmine/spec/storage-service.spec.js</em></p>
<pre class="brush: jscript; first-line: 38; highlight: [59,60,61,62,63,64,65,66,67]; title: ;" title="">
describe('saveItem()', function() {

  var itemOne = modelFactory.create(),
      itemTwo = modelFactory.create(),
      async = new AsyncSpec(this);

  beforeEach( function() {
    store.saveItem(itemOne);
  });

  afterEach( function() {
    store.empty();
  });

  async.it('should grow the length of items on new item', function(done) {
    store.getItems().then( function(items) {
      expect(items.length).toEqual(1);
      done();
    });
  });

  async.it('should not grow the length of items on pre-existing item', function(done) {
    itemOne.name = 'oranges';
    store.saveItem(itemOne).then( function(item) {
      store.getItems().then( function(items) {
        expect(items.length).toEqual(1);
        done();
      });
    });
  });

});
</pre>
<p>We modified the description of the original expectation to state that the items list should only grow on new existence and added a new expectation that previously stored items do not get appended to the stored list:</p>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_ix_14.png" alt="Failing update to saveItem() specs." /></p>
<p>As expected <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  Let&#8217;s update <code>saveItem()</code> on the <code>storage-service</code> to account for this:</p>
<p><em>/script/service/storage-service.js</em></p>
<pre class="brush: jscript; first-line: 5; title: ;" title="">
saveItem: function(item) {
  var deferred = $.Deferred(),
      index = itemCache.indexOf(item);
  if(index === -1) {
    itemCache[itemCache.length] = item;
  }
  return deferred.resolve(item);
}
</pre>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_ix_15.png" alt="Passing on new expectation for saveItem()" /></p>
<p>Not leaving any to chance, let&#8217;s add a couple more expectations as to how items are placed and how they remain in their places:</p>
<p><em>/test/jasmine/spec/storage-service.spec.js</em></p>
<pre class="brush: jscript; first-line: 71; title: ;" title="">
describe('saveItem() multiples', function() {

  var itemOne = modelFactory.create(),
      itemTwo = modelFactory.create(),
      async = new AsyncSpec(this);

  beforeEach( function() {
    store.saveItem(itemOne);
    store.saveItem(itemTwo);
  });

  afterEach( function() {
    store.empty();
  });

  async.it('should append new items to the end of the list', function(done) {
    store.getItems().then( function(items) {
      expect(items[items.length-1]).toBe(itemTwo);
      done();
    });
  });

  async.it('should update existing item at position', function(done) {
    itemOne.name = 'oranges';
    store.saveItem(itemOne).then( function(item) {
      store.getItems().then( function(items) {
        expect(items.indexOf(itemOne)).toEqual(0);
        done();
      });
    });
  });

});
</pre>
<p>I had begun to add these expectations for multiple items in the list to the <code>saveItem()</code> spec suite, but I saw a similar setup for them both that differed from the origin setup for the <code>saveItem()</code> suite. As such, I moved these expectations to their own spec suite and particular setup.</p>
<p>Without any new modification to <code>storage-service</code> implementation, run that and we are still green!<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_16.png" alt="Passing with new expectations for saveItem()" /></p>
<p>Tagged <strong>0.1.14</strong>: <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.14" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.14</a></p>
<h2>This Is All Great But We Still Haven&#8217;t Done Anything</h2>
<p>In other words, what this subsection header is trying to say, the <code>storage-service</code> &#8211; even after we hook up communication to it from <code>list-controller</code> events &#8211; will do <em>nothing</em> but keep a session-cache of items: <strong>there still is no persistence across sessions</strong>.</p>
<p>Seeing as this is the case, let&#8217;s start integrating communication with <code>localStorage</code> into our <code>storage-service</code>. I am not going to modify the tests in order to verify the utilization of <code>localStorage</code> in relation to the operations available on <code>storage-service</code> &#8211; I am simply going to modify the <code>storage-service</code> and posible change expectations. The reason being that I do not really care about whether the storage-service relies on <code>localStorage</code> or a remote resource to read and write items to storage; I am only concerned with communication to <code>storage-service</code> being supported. </p>
<p><small>In truth, if this were a real world application and had to support occasional connectivity, i&#8217;d have two service modules: local-storage-service and remove-storage-service. They would both support the same API and there would be a service layer facade that would manage the &#8216;live&#8217; instance and sync of both. That is a little too much for this series, so we&#8217;ll stick with a proxy to <code>localStorage</code> without modifying our tests to assume that the <code>storage-service</code> requires communication with it.</small></p>
<h3>storage-service modification</h3>
<p>To begin with, a <code>String</code> value is used as a key to read and write to an object held on <a href="https://developer.mozilla.org/en-US/docs/DOM/Storage" target="_blank">localStorage</a>. The API of <code>localStorage</code> is fairly simple and we&#8217;ll only be concerned with <code>getItem()</code> and <code>setItem()</code> to read and write to the store, respectively. We&#8217;ll use a key that we hope is unique to our application and won&#8217;t overwrite any object stored previously by another and use that key to access the stored grocery list items:</p>
<p><em>/script/service/storage-service.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [1,4,5,6,7,8,9,10,11,12,13,14,33,34,35,36,37,38,39,40,41,42,43,44]; title: ;" title="">
define(['jquery', 'script/model/grocery-ls-item'], function($, modelFactory) {

  var itemCache,
      groceryListKey = 'com.custardbelly.grocerylist',
      parseToCollection = function(json) {
        var i,
            length,
            list = (json &amp;&amp; typeof json === 'string') ? JSON.parse(json) : [];
        length = list.length;
        for(i = 0; i &lt; length; i++) {
          list[i] = $.extend(modelFactory.create(), list[i]);
        }
        return list;
      },
      store = {
        saveItem: function(item) {
          var deferred = $.Deferred();
          return deferred.resolve(item);
        },
        removeItem: function(item) {
          var deferred = $.Deferred(),
              itemIndex = itemCache.indexOf(item),
              removedItem;

          if(itemIndex &gt; -1) {
            itemCache.splice(itemIndex, 1);
            removedItem = item;
          }
          return deferred.resolve(removedItem);
        },
        getItems: function() {
          var deferred = $.Deferred();
          if(itemCache === undefined) {
             try {
              itemCache = parseToCollection(window.localStorage.getItem(groceryListKey));
              deferred.resolve(itemCache);
            }
            catch(e) {
              deferred.reject('Could not access items: ' + e.message);
            }
          }
          else {
            deferred.resolve(itemCache);
          }
          return deferred;
        },
        empty: function() {
          var deferred = $.Deferred();
          itemCache.length = 0;
          deferred.resolve(itemCache);
          return deferred;
        }
      };

  return store;

});
</pre>
<p>That will light up our tests in pretty <span style="color: red;">red</span>&#8230; but that was expected. Actually, if it didn&#8217;t make our tests fail horribly, I would have been worried.<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_23.png" alt="Failing on sotrage modification." /></p>
<p>There are a couple things going on in this modification to <code>storage-service</code> that we should go over, however &#8211; the first being <code>parseToCollection()</code>:</p>
<p><em>/script/service/storage-service.js</em></p>
<pre class="brush: jscript; first-line: 5; title: ;" title="">
parseToCollection = function(json) {
  var i,
      length,
      list = (json &amp;&amp; typeof json === 'string') ? JSON.parse(json) : [];

  length = list.length;
  for(i = 0; i &lt; length; i++) {
    list[i] = $.extend(modelFactory.create(), list[i]);
  }
  return list;
}
</pre>
<p>This method is invoked from <code>getItems()</code> and is provided the value of the object held in <code>localStorage</code> with the key <code>com.custardbelly.grocerylist</code>. We&#8217;ll be saving our data down in <a href="http://www.json.org/" target="_blank">JSON</a> format, and as such, <code>parseCollection()</code> is responsible for parsing that data back out; as well, if it is the first time accessing the data it will be coming in as undefined so a new list is created. What is particularly important in this parsing is how the objects on the list held in <code>localStorage</code> are converted to instances of our <code>grocery-ls-item</code> model: we create a new instance using the <code>modelFactory</code> and extend it with the object values from the item held on the list. The reason for this is because <code>grocery-ls-items</code> are decorated with getters and setters to allow for <code>property-change</code> events to be notified. In serializing down to JSON, this object structure is not perserved &#8211; it is just a <strong>POJSO</strong>.</p>
<p>The <code>parseToCollection()</code> method is invoked from <code>getItems()</code>:</p>
<p><em>/script/service/storage-service.js</em></p>
<pre class="brush: jscript; first-line: 31; title: ;" title="">
getItems: function() {
  var deferred = $.Deferred();
  if(itemCache === undefined) {
    try {
      itemCache = parseToCollection(window.localStorage.getItem(groceryListKey));
      deferred.resolve(itemCache);
    }
    catch(e) {
      deferred.reject('Could not access items: ' + e.message);
    }
  }
  else {
    deferred.resolve(itemCache);
  }
  return deferred;
}
</pre>
<p>When <code>getItems()</code> is first invoked in a session, it will go about trying to access and parse the data held on <code>localStorage</code>; any subsequent invocations will immediately return the currently held reference to the store. In essence, during a session of creating and curating a <strong>Grocery List</strong>, we are working with live and current data so there is no need to keep accessing the list of grocery items from local storage every time &#8211; we&#8217;ll just return the live record.</p>
<p>Speaking of which, a lot of the failing tests I suspect are due to not actually not saving the list down to <code>localStorage</code>. Let&#8217;s just modify <code>storage-service</code> a little to do so and see where that gets us:</p>
<p><em>/script/service/storage-service.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [15,16,17,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34]; title: ;" title="">
define(['jquery', 'script/model/grocery-ls-item'], function($, modelFactory) {

  var itemCache,
      groceryListKey = 'com.custardbelly.grocerylist',
      parseToCollection = function(json) {
        var i,
            length,
            list = (json &amp;&amp; typeof json === 'string') ? JSON.parse(json) : [];

        length = list.length;
        for(i = 0; i &lt; length; i++) {
          list[i] = $.extend(modelFactory.create(), list[i]);
        }
        return list;
      },
      serialize = function(key, data) {
        window.localStorage.setItem(key, JSON.stringify(data));
      },
      store = {
        saveItem: function(item) {
          var deferred = $.Deferred();
          $.when(this.getItems()).then(function(cache) {
            var index = cache.indexOf(item);
            try {
              if(index === -1) {
                cache[cache.length] = item;
              }
              serialize(groceryListKey, cache);
              deferred.resolve(item);
            }
            catch(e) {
              deferred.reject('Could not save item: ' + e.message);
            }
          });
          return deferred;
        },
        removeItem: function(item) {
          // implementation removed to reduce noise
        },
        getItems: function() {
          // implementation removed to reduce noise
        },
        empty: function() {
          // implementation removed to reduce noise
        }
      };

  return store;

});
</pre>
<p><code>saveItem()</code> was modified to access the held list using <code>getItems()</code>, operate on that list as it had done previously and then try to serialize the list back to storage. Fairly simple. It&#8217;s important to note that we don&#8217;t access the <code>itemCache</code> directly in saveItem(), the reason being that we can&#8217;t ensure that <code>saveItem()</code> will only be called after a request to <code>getItems()</code>. As such, we need to be sure we&#8217;re always working with the same data and do so by requesting that cached list from <code>getItems()</code> within <code>saveItem()</code>.</p>
<p>That gets us closer to <span style="color: green;">green</span>, but we still have some work to do&#8230;<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_24.png" alt="Closer to green for storage-service modifications." /></p>
<p>Let&#8217;s modify <code>removeItem()</code> and <code>empty()</code> to work with the cached list returned from <code>getItems()</code> just as the modification to <code>saveItems()</code> has:</p>
<p><em>/script/service/storage-service.js</em></p>
<pre class="brush: jscript; first-line: 36; title: ;" title="">
removeItem: function(item) {
  var deferred = $.Deferred();
  $.when(this.getItems()).then(function(cache) {
    var itemIndex = cache.indexOf(item),
        removedItem;
    try {
      if(itemIndex &gt; -1) {
        cache.splice(itemIndex, 1);
        removedItem = item;
        serialize(groceryListKey, cache);
      }
      deferred.resolve(removedItem);
    }
    catch(e) {
      cache.splice(itemIndex, 0, removedItem);
      deferred.reject('Could not remove item: ' + e.message);
    }
  });
  return deferred;
}
</pre>
<p><em>/script/service/storage-service.js</em></p>
<pre class="brush: jscript; first-line: 72; title: ;" title="">
empty: function() {
  var deferred = $.Deferred();
  $.when(this.getItems()).then(function(cache) {
    try {
      cache.length = 0;
      serialize(groceryListKey, cache);
      deferred.resolve(cache);
    }
    catch(e) {
      deferred.reject('Could not empty cache: ' + e.message);
    }
  });
  return deferred;
}
</pre>
<p>That oughta do. Basically doing the same as we had done with <code>saveItem()</code>: accessing the cached list through <code>getItems()</code>, then modifying that list and serializing back done to <code>localStorage</code>.</p>
<p>Run those tests again, and we are back to <span style="color: green">green</span>!<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_25.png" alt="Passing storage-service tests after modification!" /></p>
<p>&#8230; at least for our <code>storage-service</code>. Let&#8217;s turn on all our tests again and see if our previous expectations are met:<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_26.png" alt="Passing tests!" /></p>
<p>Whoopie!</p>
<p>Tagged <strong>0.1.15</strong>: <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.15" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.15</a></p>
<p>We&#8217;re not done yet: we have still to hook up <code>list-controller</code> notification to <code>storage-service</code> operations. However, I want to end this article here on a good note <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<h2>Conclusion</h2>
<p>We have yet to reach our goal of incorporating session persistence within our <strong>Grocery List</strong> application &#8211; but that is not to say we have gotten nowhere. We implemented our <code>storage-service</code> layer for <code>localStorage</code> communication and modified the <code>list-controller</code> to notify of change events to its collection related to <code>grocery-ls-item</code> existence. Not to shabby. </p>
<p>I know we want to get a finished product out the door, but we&#8217;ll get there&#8230; just a few more things to tie up in the next article&#8230;</p>
<p>Cheers! </p>
<p>&#8212;-</p>
<h1>Link Dump</h1>
<h2>Reference</h2>
<p><a href="http://tddjs.com/" target="_blank">Test-Driven JavaScript Development by Christian Johansen</a><br />
<a href="http://dannorth.net/introducing-bdd/" target="_blank">Introducing BDD by Dan North</a><br />
<a href="http://cumulative-hypotheses.org/2011/08/30/tdd-as-if-you-meant-it/">TDD as if you Meant it by Keith Braithwaite</a><br />
<a href="http://requirejs.org/" target="_blank">RequireJS</a><br />
<a href="https://github.com/amdjs/amdjs-api/wiki/AMD" target="_blank">AMD</a><br />
<a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a><br />
<a href="http://sinonjs.org/" target="_blank">Sinon</a><br />
<a href="https://github.com/derickbailey/jasmine.async" target="_blank">Jasmine.Async</a></p>
<h2>Post Series</h2>
<p><a href="https://github.com/bustardcelly/grocery-ls">grocery-ls github repo</a><br />
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i" target="_blank">Part I &#8211; Introduction</a><br />
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii">Part II &#8211; Feature: Add Item</a><br />
<a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii">Part III &#8211; Feature: Mark-Off Item</a><br />
<a href="http://custardbelly.com/blog/2012/12/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-iv">Part IV &#8211; Feature: List-Item-Controller</a><br />
<a href="http://custardbelly.com/blog/2012/12/31/the-making-of-a-test-driven-grocery-list-application-in-js-part-v/">Part V &#8211; Feature: List-Controller Refactoring</a><br />
<a href="http://custardbelly.com/blog/2013/01/08/the-making-of-a-test-driven-grocery-list-application-in-js-part-vi/" target="_blank">Part VI &#8211; Back to Passing</a><br />
<a href="http://custardbelly.com/blog/2013/01/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-vii/">Part VII &#8211; Remove Item</a><br />
<a href="http://custardbelly.com/blog/2013/01/22/the-making-of-a-test-driven-grocery-list-application-part-viii/">Part VIII &#8211; Bug Fixing</a><br />
<a href="http://custardbelly.com/blog/2013/02/15/the-making-of-a-test-driven-grocery-list-application-in-js-part-ix/">Part IX &#8211; Persistence</a><br />
<a href="http://custardbelly.com/blog/2013/03/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-x/">Part X &#8211; It Lives!</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/amd/" title="View all posts in AMD" rel="category tag">AMD</a>,  <a href="http://custardbelly.com/blog/category/javascript/" title="View all posts in JavaScript" rel="category tag">JavaScript</a>,  <a href="http://custardbelly.com/blog/category/requirejs/" title="View all posts in RequireJS" rel="category tag">RequireJS</a>,  <a href="http://custardbelly.com/blog/category/grocery-ls/" title="View all posts in grocery-ls" rel="category tag">grocery-ls</a>,  <a href="http://custardbelly.com/blog/category/jasmine/" title="View all posts in jasmine" rel="category tag">jasmine</a>,  <a href="http://custardbelly.com/blog/category/unit-testing/" title="View all posts in unit-testing" rel="category tag">unit-testing</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2013/02/15/the-making-of-a-test-driven-grocery-list-application-in-js-part-ix/#comments" rev="post-777"  title="Comment on The Making of a Test-Driven Grocery List Application in JS: Part IX">3 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2013-02-15T10:47">February 15, 2013</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-777-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-782" class="post-782 post hentry category-infrared5 category-javascript category-madmin category-node full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2013/02/04/madmin-for-ease-of-creating-and-documenting-restful-service-uris/" title="Permanent link to madmin: for ease of creating and documenting RESTful service URIs" rel="bookmark" rev="post-782">madmin: for ease of creating and documenting RESTful service URIs</a></h1>
	
	<div class="entry-content full-content">
		<p>My company, <a href="http://infrared5.com" target="_blank">Infrared5</a>, recently released an Open Source project called <a href="https://github.com/infrared5/madmin">madmin</a>, which I had the great pleasure of being a main part of. </p>
<p><strong>madmin</strong> is a node-based application that allows for generating immediately accessible RESTful URIs. Though it is possible to communicate with command line tools like cURL,  <strong>madmin</strong> also provides a client-side console to easily create the URIs and structure of JSON response(s). It was originally intended to solve a front-end development problem in maintaining two sets of code &#8211; a <em>fake</em> service layer and <em>production-level</em> service layer &#8211; during development, but has grown to be a proven way to facilitate communication between the server-side and client-side teams in discussing the requirements of the services for a project. It also proved to be pretty handy documentation, to boot, which could be easily discussed with clients.</p>
<p>Anyway, you can read a more detailed description of the project and how it came to fruition over at the <a href="http://blog.infrared5.com" target="_blank">Infrared5 blog</a>: <a href="http://blog.infrared5.com/2013/01/introducing-madmin-an-admin-console-for-generating-mock-services-with-restful-uris/">http://blog.infrared5.com/2013/01/introducing-madmin-an-admin-console-for-generating-mock-services-with-restful-uris/</a></p>
<p>If you check it out, I hope you find it useful in any way and please log issues for requests or fork it to add features! I intend to get more basic instructions up on the wiki at its <a href="https://github.com/infrared5/madmin">github location</a> and perhaps write a few blog posts as well.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/infrared5/" title="View all posts in Infrared5" rel="category tag">Infrared5</a>,  <a href="http://custardbelly.com/blog/category/javascript/" title="View all posts in JavaScript" rel="category tag">JavaScript</a>,  <a href="http://custardbelly.com/blog/category/madmin/" title="View all posts in madmin" rel="category tag">madmin</a>,  <a href="http://custardbelly.com/blog/category/node/" title="View all posts in node" rel="category tag">node</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2013-02-04T10:28">February 4, 2013</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-782-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-747" class="post-747 post hentry category-amd category-javascript category-requirejs category-grocery-ls category-jasmine category-unit-testing full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2013/01/22/the-making-of-a-test-driven-grocery-list-application-part-viii/" title="Permanent link to The Making of a Test-Driven Grocery List Application: Part VIII" rel="bookmark" rev="post-747">The Making of a Test-Driven Grocery List Application: Part VIII</a></h1>
	
	<div class="entry-content full-content">
		<p><em>This is the eighth installment in a series of building a Test-Driven Grocery List application using <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> and <a href="http://requirejs.org" target="_blank">RequireJS</a>. To learn more about the intent and general concept of the series please visit <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i/">The Making of a Test-Driven Grocery List Application in JavaScript: Part I</a></em><br />
&#8212;</p>
<h1>Introduction</h1>
<p>In the past several articles we have sort of have been living in the spec runner. We fiddled about making it turn red and green, and &#8211; until <a href="http://custardbelly.com/blog/2013/01/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-vii/" target="_blank">the last article</a> &#8211; we never really ran the <strong>Grocery List</strong> application we were building to give it a proper <em>User Testing</em>. If you did play around with the actual application we have been busy writing tests for, you may have found a bug. An unexpected result from supplying no grocery item name before saving it to the list:</p>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_viii_1.png" alt="Image for bug ticket with empty item." /></p>
<p>As you can see from the screenshot, there is an empty item in the third entry of the list. While I do think the act of walking into a store and picking up nothing is an accomplishment at times, this <em>Empty Item</em> bug is not an intended feature. In this article, I want to squash that bug&#8230; but &#8211; in keep with the theme of this series &#8211; we are going to do it through tests! Calm down. It is hard to read when you jump up and down like that.</p>
<h1>Bug Ticket</h1>
<p>Before we begin fixing the bug, let&#8217;s get it down in writing what we think the problem is and how we think the intended behavior should be. To start, we don&#8217;t want empty items added to the <strong>Grocery List</strong>. We are currently able to add them &#8211; and rather easily &#8211; so let&#8217;s list out the steps that allows us to do so:</p>
<p><em>Empty Item Added to List</em><br />
&#8212;<br />
<strong>Steps to Reproduce</strong></p>
<ol>
<li>Launch the Grocery List application</li>
<li>Click &#8216;add item&#8217; button</li>
<li>In focused input field, type the name of a grocery item, ie. &#8216;apples&#8217; (sans quotes)</li>
<li>Click the Tab button to save to list</li>
<li>Click &#8216;add item&#8217; button</li>
<li>Leave the focused input field blank</li>
<li>Click the Tab button</li>
</ol>
<p><strong>Result</strong><br />
Empty item is added to the list</p>
<p><strong>Expected Result</strong><br />
An item without any name value provided is not added to the list</p>
<p><strong>Additional Notes</strong><br />
It is not a requirement to first have a valid item added to the list in order to reproduce the issue. Steps 1-4 are intended to show expected behavior with a non-empty item.<br />
&#8212;</p>
<p><small>If you are out there reading this and file bug tickets, please, for the love of software, log a ticket with a structure similar to this. Most modern bug tracking systems have fields like this, but you&#8217;d be surprised (or maybe not) how tickets come in sometimes. My least favorite is explained bug in the title. I can only imagine that they are the same people who write the whole email in the Subject field.</small></p>
<p>Alright, so now we know what we are dealing with. We have clear steps to reproduce the issue we think is a bug and have explained the difference between the actual result and the intended/expected result. Let&#8217;s tackle it.</p>
<h1>Tests</h1>
<p>As the developer of the application, we probably know exactly where this is happening. Our initial response is to go write to the source and resolve this issue. But we&#8217;re not going to do that. Don&#8217;t give me that look. I know, I know. The less we have to be in bug-fixing-mode, the happier developer we be, but I think if we have a test that supports the validity of this claim then, when we do make changes to the application code and it still passes, we know we have not committed a regression. I think it is a confidence builder in relying on my code to work properly and takes away some stress when refactoring comes into play.</p>
<p>Before we begin, let&#8217;s think about where we will add the tests. We could append another spec suite to the <em>Add Item</em> specs &#8211; after all, this bug occurs upon the completion of the <em>Add Item</em> feature. But in thinking about how to reproduce the issue, it seems like it may be another feature, or at least could be discovered in a feature we haven&#8217;t addressed &#8211; <em>Edit Item</em>. Essentially, when we get to the 3rd step &#8211; <em>In focused input field, type the name of a grocery item, ie. &#8216;apples&#8217; (sans quotes)</em> &#8211; we have already added the item to the list. It has entered an edit mode, from which we need to ensure the validity of the value provided before saving it to the list. </p>
<p>Now, a true <strong>TDD</strong>&#8216;er probably would stop me right now and tell me I am thinking too much to get this resolved. And, in part, they would be correct in doing so. But it is not my intent to start dreaming up new features during bug fixing. I just want to properly think about where the tests make the most sense. I don&#8217;t think they belong as an addendum to the <em>Add Item</em> specs and should live in there own spec suite in a separate file:</p>
<p><em>/test/jasmine/spec/feature/saveitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define(['jquery', 'script/controller/list-controller', 'script/controller/list-item-controller'],
        function($, listController, itemControllerFactory) {

  describe('Save item to grocery list', function() {

    it('should not save an empty item to the list') {
      expect(true).toEqual(false);
    }

  }
}
</pre>
<p>Given the steps provided in the bug ticket, we could easily translate that into the setup for the spec suite:</p>
<p><em>/test/jasmine/spec/feature/saveitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [6,7,8,9,10,11,12,13,14,15,21,22,23,24]; title: ;" title="">
define(['jquery', 'script/controller/list-controller', 'script/controller/list-item-controller'],
        function($, listController, itemControllerFactory) {

  describe('Save item to grocery list', function() {

    var item,
        itemName = 'apples',
        invalidName = '',
        itemRenderer,
        async = new AsyncSpec(this);

    beforeEach( function() {
      item = listController.createNewItem();
      itemRenderer = listController.getRendererFromItem(item);
    });

    it('should not save an empty item to the list', function() {
      expect(true).toEqual(false);
    });

    afterEach( function() {
      item = undefined;
      itemRenderer = undefined;
    });
  });

});
</pre>
<p>In the <code>beforeEach()</code> setup, we have progressed the application &#8211; or at least a list item &#8211; to essentially the 3rd step in the <em>Steps to Reproduce</em>: we have added a new item to the list, and internally upon addition of an item in the <code>list-controller</code>, it has entered edit-mode for that item. In the variable declarations, we have also defined what we know of as being valid and invalid item entry names: <em>&#8216;apples&#8217;</em> and <em>&#8221;</em>, respectively. </p>
<p>We should be ready to go in our specs now to define the rest of the steps and expected results:</p>
<p><em>/test/jasmine/spec/feature/saveitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 17; highlight: [18,20,22]; title: ;" title="">
it('should not save an empty item to the list', function() {
  var listLength = listController.getItemList().itemLength();

  item.name = invalidName;
  // save item... ?
  expect(listController.getItemList().itemLength()).toEqual(listLength);
});
</pre>
<p>Oh, boy. How do we actually save an item? There is no API on the <code>list-controller</code> that saves an item. There used to be, but we refactored that out when we handed over item management to the <code>list-item-controller</code>. Furthermore, an item is added and kept on the list since its request for creation &#8211; the actual reason for the bug, I suppose. I am fine with such functionality internally to the <code>list-controller</code> as it stands now and don&#8217;t intend to change the item creation. I think an additional event should be dispatched from a <code>list-item-controller</code> signifying a request to commit the item to the list after being edited. Let&#8217;s finish up this spec under such assumptions, then work our way through the failing test:</p>
<p><em>/test/jasmine/spec/feature/saveitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 17; title: ;" title="">
async.it('should not save an empty item to the list', function(done) {
  var listLength = listController.getItemList().itemLength();

  $(itemRenderer).on('commit', function(event) {
    expect(listController.getItemList().itemLength()).toEqual(listLength-1);
    done();
  });

  item.name = invalidName;
  itemRenderer.save();
});
</pre>
<p>We marked the spec as asynchronous to support events from the <code>list-item-controller</code> and placed the expectation within the <em>&#8216;commit&#8217;</em> event handler.</p>
<p>Run that, and we&#8217;ll be waiting for about 5 seconds until we are told that save() is not a method on the <code>list-item-controller</code> instance:</p>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_viii_2.png" alt="Failing save item test with timeout" /></p>
<p><small>I have temporarily commented out the other tests in order to remove any noise and focus solely on resolving this bug. This is for local testing and would not commit the spec runner in such a state when committing back to the repo and running latest on a CI server.</small></p>
<p>To resolve that, let&#8217;s open up <code>list-item-controller</code> and add that method:</p>
<p><em>/script/controller/list-item-controller.js</em></p>
<pre class="brush: jscript; first-line: 71; highlight: [111,112]; title: ;" title="">
listItemController = {
  $editableView: undefined,
  $uneditableView: undefined,
  init: function() {
    ...
    return this;
  },
  save: function() {
  },
  dispose: function() {
    ...
  }
};
</pre>
<p>Run that again, and now we are down to just the timeout failure:</p>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_viii_3.png" alt="Timeout failure on list-item-controller save" /></p>
<p>To resolve that, we&#8217;ll first create a new event factory method and invoke it from <code>save()</code> to dispatch the <em>commit</em> event, of which we have assigned a handler for in the test:</p>
<p><em>/script/controller/list-item-controller.js</em></p>
<pre class="brush: jscript; first-line: 16; title: ;" title="">
function createSaveEvent(controller) {
  var event = $.Event('commit');
  event.controller = controller;
  return event;
}
</pre>
<p>and&#8230;</p>
<pre class="brush: jscript; first-line: 111; highlight: [112]; title: ;" title="">
save: function() {
  $(this).trigger(createSaveEvent(this));
},
</pre>
<p>No more timeout!</p>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_viii_4.png" alt="Failing expectation on list-item-controller save." /></p>
<p>But still failing. Reason is that the item had not been removed from the collection. In previous tests we have verified its addition to the collection from the <code>createNewItem()</code> method on <code>list-controller</code>. Now that we are saving the <code>list-item-controller</code> with a modified model that has an invalid name, we are expecting such an action to remove the item from the collection &#8211; the crux of our <em>Empty Item</em> bug.</p>
<p>Let&#8217;s modify the <code>list-controller</code> in order to handle the commit event from a <code>list-item-controller</code>:</p>
<p><em>/script/controller/list-controller.js</em></p>
<pre class="brush: jscript; first-line: 40; highlight: [54,55,56,57,58,69]; title: ;" title="">
$collection.on('collection-change', function(event) {
  var model, itemController, $itemView;
  switch( event.kind ) {
    case EventKindEnum.ADD:
      $itemView = $('&lt;li&gt;');
      model = event.items.shift();
      itemController = itemControllerFactory.create($itemView, model);

      $itemView.appendTo(listController.$view);
      rendererList.addItem(itemController);
      itemController.state = itemControllerFactory.state.EDITABLE;
      $(itemController).on('remove', function(event) {
        listController.removeItem(model);
      });
      $(itemController).on('commit', function(event) {
        if(!isValidValue(model.name)) {
          listController.removeItem(model);
        }
      });
      break;
    case EventKindEnum.REMOVE:
      model = event.items.shift();
      itemController = listController.getRendererFromItem(model);

      if(itemController) {
        $itemView = itemController.parentView;
        $itemView.remove();
        itemController.dispose();
        $(itemController).off('remove');
        $(itemController).off('commit');
        rendererList.removeItem(itemController);
      }
      break;
    case EventKindEnum.RESET:
      break;
  }
});
</pre>
<p>We&#8217;ve added another event listener to the <code>list-item-controller</code> when it is added to the collection to handle the <em>commit</em> event. Within the handler we check for its validity &#8211; which we have predetermined as not being an empty string &#8211; and if it does not pass, then we remove it.<br />
<small>Note: In shipped code I would hold a single reference to a wrapped non-jQuery object and not wrap it multiple times as is shown here when adding and removing event handlers. I left it in this example to not add extra noise to the task at hand.</small></p>
<p>Run that, and we are back to green!<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_viii_5.png" alt="Passing test on commit event form list-item-controller" /></p>
<h2>User Test</h2>
<p>Let&#8217;s run the application and see if the issue is resolved:<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_viii_6.png" alt="Non-resolution of bug in live test" /><br />
I think that picture says it all&#8230;</p>
<p>The bug is still there because <code>save()</code> is not being called on the <code>list-item-controller</code>. In our test, we explicitly called it after a change to the model, but in the application itself it is not being invoked upon change to the model. </p>
<p>But before we start adding calls to <code>save()</code> in our code, let&#8217;s think about the steps to reproduce the bug&#8230; or at least the fourth step &#8211; <em>Click the Tab button to save to list</em>. The tab keystroke, internally to the <code>list-item-controller</code>, causes a blur to the input field. If we look at the code from <code>list-item-controller</code>, that <em>blur</em> event performs a change to state:</p>
<p><em>/script/controller/list-item-controller.js</em></p>
<pre class="brush: jscript; first-line: 91; title: ;" title="">
$('input', this.$editableView).on('blur', (function(controller) {
  return function(event) {
    controller.model.name = $(this).val();
    controller.state = stateEnum.UNEDITABLE;
  };
}(this)));
</pre>
<p>This snippet is taken from the event handler assignment in the <code>init()</code> function. When in edit mode of the <code>list-item-controller</code>, once focus is lost from the input field &#8211; which happens upon tab &#8211; the model is updated and state changed to non-edit mode. My first inkling is to put it here. It is true that, in doing so, it will pass and get rid of the bug&#8230; but the real commit of changes to the <code>list-item-controller</code> and its underlying model I feel lie in its change from edit mode to non-edit mode. I would argue that <code>save()</code> should be called from that occurrence. But before we add that to the code, let&#8217;s write up an expectation of that behavior.</p>
<h2>More Tests</h2>
<p><em>&#8216;WHAT?!? The bug was in our sights. We know how to get rid of it, and you want to write more tests?!?&#8217;</em><br />
That is the voice in my head most of the time when I decide to go back to tests. It has lessened, and the swearing really has decreased. And when I finally do get around to passing tests, it goes away and is replaced with: <em>&#8216;Nice job! You deserve a raise.. or at least an egg sandwich!&#8217;</em></p>
<p>Anyway, let&#8217;s get to <em>Egg Sandwich Status</em> and add another test to ensure that upon change to non-edit mode, if the model properties are not valid, that the item is not saved:</p>
<p><em>/test/jasmine/spec/feature/saveitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 29; title: ;" title="">
async.it('should not save an empty item upon change to non-edit mode', function(done) {
   var listLength = listController.getItemList().itemLength();

  $(itemRenderer).on('commit', function(event) {
    expect(listController.getItemList().itemLength()).toEqual(listLength - 1);
    done();
  });

  item.name = invalidName;
  itemRenderer.state = itemControllerFactory.state.UNEDITABLE;
});
</pre>
<p>We have already verified the expectation that a <code>list-item-controller</code> is entered into an <code>EDITABLE</code> state from our <em>additem.spec.js</em> tests, so we don&#8217;t need to test for that here &#8211; just know that setting the <code>list-item-controller</code> instance to an <code>UNEDITABLE</code> state will trigger it to go into non-edit mode.</p>
<p>Run that, and we get the timeout failure from that test:<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_viii_7.png" alt="Timeout failure on non-edit mode commit" /></p>
<p>Good! Before you slap me&#8230; save that hand for modifying the <code>list-item-controller</code> to invoke the save() method from its state-change handler:</p>
<p><em>/script/controller/list-item-controller.js</em></p>
<pre class="brush: jscript; highlight: [48]; title: ;" title="">
function handleStateChange(controller, event) {
  // remove state-based item.
  if( typeof event.oldState !== 'undefined') {
    if(event.oldState === stateEnum.UNEDITABLE) {
      controller.$uneditableView.detach();
    }
    else if(event.oldState === stateEnum.EDITABLE) {
      controller.$editableView.detach();
    }
  }
  // append state-based item.
  if(event.newState === stateEnum.UNEDITABLE) {
    controller.parentView.append(controller.$uneditableView);
    controller.save();
  }
  else if(event.newState === stateEnum.EDITABLE) {
    var inputTimeout = setTimeout( function()  {
      clearTimeout(inputTimeout);
      $('input', controller.$editableView).focus();
    }, 100);
    controller.parentView.append(controller.$editableView);
  }
}
</pre>
<p>One little addition. Now run the tests:<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_viii_8.png" alt="Passing tests on change to non-edit mode and save." /></p>
<p><em>Hooray!</em> Now use that hand you were gonna slap me with and high-five yourself. Now look at yourself&#8230; you look silly. Run the application you crazy solo-high-fiver:<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_viii_9.png" alt="Application does not save empty item" /></p>
<p>That picture doesn&#8217;t say much, but &#8211; if all has gone well &#8211; it conveys that we are no longer able to save an item to the list when nothing has been provided in the input field and we can close the bug.</p>
<h3>Can&#8217;t Stop. Won&#8217;t Stop</h3>
<p>I would normally stop there, but I do like to sew things up nicely and verify all expectations. Such as:</p>
<p>1. Item controller view is not retained in list view if not valid:<br />
<em>/test/jasmine/spec/feature/saveitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 43; title: ;" title="">
async.it('should not add an empty item to list view upon change to non-edit mode', function(done) {
   var listViewLength = $listView.children().length;

  $(itemRenderer).on('commit', function(event) {
    expect($listView.children().length).toEqual(listViewLength - 1);
    done();
  });

  item.name = invalidName;
  itemRenderer.state = itemControllerFactory.state.UNEDITABLE;
});
</pre>
<p>2. When going from edit to non-edit mode, valid items are retained:<br />
<em>/test/jasmine/spec/feature/saveitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 55; title: ;" title="">
async.it('should save a valid item upon change to non-edit mode', function(done) {
   var listLength = listController.getItemList().itemLength();

  $(itemRenderer).on('commit', function(event) {
    expect(listController.getItemList().itemLength()).toEqual(listLength);
    done();
  });

  item.name = itemName;
  itemRenderer.state = itemControllerFactory.state.UNEDITABLE;
});

async.it('should add a valid item to list view upon change to non-edit mode', function(done) {
   var listViewLength = $listView.children.length;

  $(itemRenderer).on('commit', function(event) {
    expect($listView.children().length).toEqual(listViewLength);
    done();
  });

  item.name = itemName;
  itemRenderer.state = itemControllerFactory.state.UNEDITABLE;
});
</pre>
<p>Those additional specs will pass with flying colors and without having to modify any more application code:<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_viii_10.png" alt="Finishing up all expectations for Save Item feature" /></p>
<p>Tagged <strong>0.1.12</strong>: <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.12" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.12</a></p>
<h1>Conclusion</h1>
<p>In this article we tested our way to closing a bug.</p>
<p>Just as we had done in the <a href="http://custardbelly.com/blog/2013/01/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-vii/" target="_blank">previous article</a>, we adhered more closely to the principles of <strong>TDD</strong> and trudge along making things turn <span style="color: red;">red</span> before <span style="color: green;">green</span> &#8211; even when we found the reason and knew the resolution for the <em>Empty Item</em> bug. In doing so, we sort of verified and documented in test a <em>Save Item</em> feature. Now we know where to add or modify tests if the usability in committing an item to the list is changed in our requirements.</p>
<h2>Todd can&#8217;t leave well enough alone</h2>
<p>The application is pretty much ready to use as is to boot! There is just one more thing that is nagging me &#8211; persistence. No pun intended. We can create a list of all the items we need at the grocery store just fine, but if we close the browser window&#8230; oh-noes. It&#8217;s lost. I gotta fix that&#8230; next.</p>
<p>Cheers for sticking around!</p>
<p>&#8212;-</p>
<h1>Link Dump</h1>
<h2>Reference</h2>
<p><a href="http://tddjs.com/" target="_blank">Test-Driven JavaScript Development by Christian Johansen</a><br />
<a href="http://dannorth.net/introducing-bdd/" target="_blank">Introducing BDD by Dan North</a><br />
<a href="http://cumulative-hypotheses.org/2011/08/30/tdd-as-if-you-meant-it/">TDD as if you Meant it by Keith Braithwaite</a><br />
<a href="http://requirejs.org/" target="_blank">RequireJS</a><br />
<a href="https://github.com/amdjs/amdjs-api/wiki/AMD" target="_blank">AMD</a><br />
<a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a><br />
<a href="http://sinonjs.org/" target="_blank">Sinon</a><br />
<a href="https://github.com/derickbailey/jasmine.async" target="_blank">Jasmine.Async</a></p>
<h2>Post Series</h2>
<p><a href="https://github.com/bustardcelly/grocery-ls">grocery-ls github repo</a><br />
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i" target="_blank">Part I &#8211; Introduction</a><br />
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii">Part II &#8211; Feature: Add Item</a><br />
<a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii">Part III &#8211; Feature: Mark-Off Item</a><br />
<a href="http://custardbelly.com/blog/2012/12/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-iv">Part IV &#8211; Feature: List-Item-Controller</a><br />
<a href="http://custardbelly.com/blog/2012/12/31/the-making-of-a-test-driven-grocery-list-application-in-js-part-v/">Part V &#8211; Feature: List-Controller Refactoring</a><br />
<a href="http://custardbelly.com/blog/2013/01/08/the-making-of-a-test-driven-grocery-list-application-in-js-part-vi/" target="_blank">Part VI &#8211; Back to Passing</a><br />
<a href="http://custardbelly.com/blog/2013/01/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-vii/">Part VII &#8211; Remove Item</a><br />
<a href="http://custardbelly.com/blog/2013/01/22/the-making-of-a-test-driven-grocery-list-application-part-viii/">Part VIII &#8211; Bug Fixing</a><br />
<a href="http://custardbelly.com/blog/2013/02/15/the-making-of-a-test-driven-grocery-list-application-in-js-part-ix/">Part IX &#8211; Persistence</a><br />
<a href="http://custardbelly.com/blog/2013/03/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-x/">Part X &#8211; It Lives!</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/amd/" title="View all posts in AMD" rel="category tag">AMD</a>,  <a href="http://custardbelly.com/blog/category/javascript/" title="View all posts in JavaScript" rel="category tag">JavaScript</a>,  <a href="http://custardbelly.com/blog/category/requirejs/" title="View all posts in RequireJS" rel="category tag">RequireJS</a>,  <a href="http://custardbelly.com/blog/category/grocery-ls/" title="View all posts in grocery-ls" rel="category tag">grocery-ls</a>,  <a href="http://custardbelly.com/blog/category/jasmine/" title="View all posts in jasmine" rel="category tag">jasmine</a>,  <a href="http://custardbelly.com/blog/category/unit-testing/" title="View all posts in unit-testing" rel="category tag">unit-testing</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2013/01/22/the-making-of-a-test-driven-grocery-list-application-part-viii/#comments" rev="post-747"  title="Comment on The Making of a Test-Driven Grocery List Application: Part VIII">2 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2013-01-22T07:46">January 22, 2013</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-747-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-742" class="post-742 post hentry category-amd category-javascript category-requirejs category-grocery-ls category-jasmine category-unit-testing full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2013/01/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-vii/" title="Permanent link to The Making of a Test-Driven Grocery List Application in JS: Part VII" rel="bookmark" rev="post-742">The Making of a Test-Driven Grocery List Application in JS: Part VII</a></h1>
	
	<div class="entry-content full-content">
		<p><em>This is the seventh installment in a series of building a Test-Driven Grocery List application using <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> and <a href="http://requirejs.org" target="_blank">RequireJS</a>. To learn more about the intent and general concept of the series please visit <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i/">The Making of a Test-Driven Grocery List Application in JavaScript: Part I</a></em><br />
&#8212;</p>
<h2>Introduction</h2>
<p>In the <a href="http://custardbelly.com/blog/2013/01/08/the-making-of-a-test-driven-grocery-list-application-in-js-part-vi/" target="_blank">previous article</a> we resolved tests for the <em>Mark Off Item</em> feature that were left in a failing state after refactoring the list-controller. The test are all green now and the application usable, but we are not done with implementing the required features. In this article I plan to address another &#8211; the <em>Remove Item</em> feature.</p>
<p>Before we begin, let&#8217;s drum up a quick story and scenario(s) for the <em>Remove Item</em> feature. I know the feature seems a little simple &#8211; just remove an item from the list &#8211; and going through and adding stories and scenarios may appear like adding complexity to the situation, but since I have begun to incorporate such a workflow, I feel like it actually gives me more time to think about not only the necessity of the feature but the design; in result, <em>hopefully*</em> cutting down on the complexity of the code.</p>
<p><em>// story</em><br />
<strong>Feature:</strong> remove item from grocery list</p>
<p><strong>In order to</strong> not buy an item previous on a grocery list<br />
<strong>As a</strong> grocery shopper<br />
<strong>I want to</strong> remove the existence of the item on the grocery list<br />
&#8212;</p>
<p>That may be worded rather harshly, but I shop angry. It&#8217;s how I keep the cantelope in check. <em>&#8216;I see you looking at me, you lousy melon.&#8217;</em> All kidding aside, I tend to be a little more terse in describing stories so as not to mince words (no pun intended) and leave as little vagueness as possible. Sometimes, I&#8217;ll admit, there is no avoiding having the story lead to a lot of assumptions &#8211; but that is where scenarios come in.</p>
<p><em>// spec</em><br />
<strong>Scenario 1:</strong> Item removed from grocery list<br />
<strong>Given</strong> an item has been added to the list<br />
<strong>When</strong> a user requests to remove the item<br />
<strong>Then</strong> the list decreases in size by one</p>
<p>Hmm. Pretty straight forward. Well, it all seems rather easy going to implement this feature. Looks like it might be a short blog post, for once; we&#8217;ll see how much rambling I can pack in. At least we have something to show somebody who doesn&#8217;t want/need to read code when they ask, <em>&#8216;But, what does it do?&#8217;</em>.</p>
<h2>Tests</h2>
<p>As always, before we get into adding code to the components of the application to implement the new feature, let&#8217;s get some failing tests to pass. We&#8217;ll start of with defining a new spec suite for the <em>Remove Item</em> feature, with the setup (<code>beforeEach()</code>) being the <strong>Given</strong> describe above:</p>
<p><em>/test/jasmine/spec/feature/removeitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define(['jquery', 'script/controller/list-controller'], function($, listController) {

  describe('Remove item', function() {

    var $listView = $('&lt;ul/&gt;'),
        groceryItem;

    beforeEach( function() {
      listController.setView($listView);
      groceryItem = listController.createNewItem();
    });

    it('should remove existing item from the collection', function() {
      expect(false).toEqual(true);
    });

    afterEach( function() {
      groceryItem = undefined;
    });

  });

});
</pre>
<p>Don&#8217;t mind the expectation declared in the spec. <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> does not check empty specs and automatically fail them. In fact, if we ran it without any expectations defined, it would be all green. So, I usually drop a failing expectation in quickly when creating new specs in cases where someone/thing comes and interrupts me, I know where to pick back up when i come back. It&#8217;s habit. Maybe a little paranoia. Don&#8217;t know if it&#8217;s right or wrong <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /><br />
<small><br />
If you have been following along in the articles of this series, I typically do my implementation in the tests then move them to their respective modules. It&#8217;s a nice workflow for me, and in most cases I feel it gets me more focused on design. In this case, I am just going to declare my expectations, see them fail and move over to implementing the code right in the module, running the spec runner as we go until we see green.<br />
</small></p>
<p>Anyway, first on the agenda is to verify that the Remove API from <code>list-controller</code> is expected to remove the item from the underlying collection of grocery list items:</p>
<p><em>/test/jasmine/spec/feature/removeitem.spec.js</em></p>
<pre class="brush: jscript; highlight: [14,15,17,19,20]; title: ;" title="">
it('should remove existing item from the collection', function() {
  var collection = listController.getItemList(),
      removedItem;

  removedItem = listController.removeItem(groceryItem);

  expect(removedItem).toBe(groceryItem);
  expect(collection.getItemIndex(groceryItem)).toBe(-1);
});
</pre>
<p>Add the new spec to the spec runner:<br />
<em>/test/jasmine/specrunner.html</em></p>
<pre class="brush: jscript; first-line: 34; highlight: [34]; title: ;" title="">
require( ['spec/feature/additem.spec.js', 'spec/feature/markitem.spec.js', 'spec/feature/removeitem.spec.js',
          'spec/list-controller.spec.js', 'spec/list-item-controller.spec.js', 'spec/grocery-ls-item.spec.js',
          'spec/collection.spec.js'], function() {

  var jasmineEnv = jasmine.getEnv(),
      ...
  jasmineEnv.execute();

});
</pre>
<p>Run that, and we have a big honking failure:<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_vii_1.png" alt="Failing remove spec on collection." /><br />
Good!</p>
<p>In looking at the expectations of the <code>removeItem()</code> method on <code>list-controller</code>, we are expecting that the item is removed from the collection and returned on invocation. Let&#8217;s implement <code>removeItem</code> on <code>list-controller</code> with this understanding:</p>
<p><em>/script/controller/list-controller.js</em></p>
<pre class="brush: jscript; first-line: 6; highlight: [25,26,27]; title: ;" title="">
listController = {
  $view: undefined,
  getItemList: function() {
    return collection;
  },
  getRendererFromItem: function(item) {
    var i = rendererList.itemLength();
    while( --i &gt; -1 ) {
      if(rendererList.getItemAt(i).model === item) {
        return rendererList.getItemAt(i);
      }
      return undefined;
    }
  },
  createNewItem: function() {
    var model = modelFactory.create();
    collection.addItem(model);
    return model;
  },
  removeItem: function(item) {
    return collection.removeItem(item);
  },
  setView: function(view) {
    this.$view = (view instanceof $) ? view : $(view);
  }
};
</pre>
<p>Run it, and we pass!<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_vii_2.png" alt="Passing tests on remove from collection." /><br />
Well, that was sort of easy and anti-climatic. No drama. A little boring, if I may say so.</p>
<p>But&#8230; there&#8217;s more! The <code>list-controller</code> isn&#8217;t just some dumb facade to the underlying <strong>Grocery List</strong> collection &#8211; it also manages the associated renderers to the <code>grocery-ls-item</code> models. Let&#8217;s get back to our tests and add a new spec:</p>
<p><em>/test/jasmine/spec/feature/removeitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 23; title: ;" title="">
it('should remove item renderer from view', function() {
  listController.removeItem(groceryItem);

  expect($listView.children().length).toEqual(0);
});
</pre>
<p>Just as we had done for the <em>Add Item</em> feature specification, we are inspecting the view reference held by list-controller that is updated based on change to the model. In this case, we are expecting that the list item renderer is removed upon <code>removeItem()</code> as well.</p>
<p>Run that, and failure!<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_vii_3.png" alt="Failure of test on removl of item views." /><br />
It might be important to note the actual print out from the failing expectation. It says that the length of children on the list view is 2 &#8211; that is because we now have 2 specs that are defining the expectations of <code>removeItem()</code> that are failing to remove the item view from the list.</p>
<p>Let&#8217;s switch over the list-controller and get this sorted and back to green. But before we do, let&#8217;s think about the relationship of the <code>list-controller</code> and its underlying collection. The <code>list-controller</code> responds to collection event for <code>EventKindEnum.ADD</code> in order to modify the view. So, we will respond to <code>EventKindEnum.REMOVE</code> accordingly to modify the view on removal of an item as well, instead of adding more logic to the <code>removeItem()</code> method on <code>list-controller</code>:</p>
<p><em>/script/controller/list-controller.js</em></p>
<pre class="brush: jscript; first-line: 40; highlight: [53,54,55,56,57,58,59,60]; title: ;" title="">
$collection.on('collection-change', function(event) {
  var model, itemController, $itemView;
  switch( event.kind ) {
    case EventKindEnum.ADD:
      $itemView = $('&lt;li&gt;');
      model = event.items.shift();
      itemController = itemControllerFactory.create($itemView, model);

      $itemView.appendTo(listController.$view);
      rendererList.addItem(itemController);
      itemController.state = itemControllerFactory.state.EDITABLE;
      break;
    case EventKindEnum.REMOVE:
      model = event.items.shift();
      itemController = listController.getRendererFromItem(model);

      if(itemController) {
        $itemView = itemController.parentView;
        $itemView.remove();
        rendererList.removeItem(itemController);
      }
      break;
    case EventKindEnum.RESET:
      break;
  }
});
</pre>
<p>In the <code>EventKindEnum.REMOVE</code> case, we are grabbing the model provided on the event, using it to access the associated <code>list-item-controller</code> instance, and &#8211; if defined &#8211; removing the list item renderer view from the DOM and the controller from the renderer collection.</p>
<p>Run that, and we are back to green!<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_vii_4.png" alt="Passing tests on removal of item from view." /></p>
<p>Tagged <strong>0.1.10</strong>: <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.10" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.10</a></p>
<h2>Back to Reality</h2>
<p>We&#8217;ve got test for the removal of a grocery list item working. We are currently feature complete. Let&#8217;s ship it! But hold up, does the <strong>Grocery List</strong> application &#8211; the thing we are actually building for someone like myself to Use in real life &#8211; actually use the new Remove API. We defined a business feature that was a requirement to have, and met that expectation, but we really didn&#8217;t address how an item is removed, or under what circumstances&#8230;</p>
<p>Without getting to crazy on discussing how to handle swipe gestures and implementing press-and-hold menu actions, let&#8217;s just start with saying that the <code>list-item-controller</code> will dispatch a new event &#8211; <code>remove</code>. How we decide on the usability of an item being deleted could easily be another whole discussion on User Experience. For now, we want to verify that when a <code>list-item-controller</code> dispatches a <code>remove</code> event, that it is handled properly.</p>
<h3>Tests</h3>
<p>We&#8217;ll start with the specs for the <code>list-controller</code>. We are not going to be adding any new specs to the <em>Remove Item</em> feature to accomplish the implementation of <code>list-item-controller</code> notifying of a <code>remove</code> event; it seems a little odd to me as well, but we have already established that the <em>Remove</em> API performs as expected. We need to verify that the <code>list-controller</code> uses that API in response to a <code>list-item-controller</code> &#8211; less of a feature and more of an integration point.</p>
<p><em>/test/jasmine/spec/list-controller.spec.js</em></p>
<pre class="brush: jscript; first-line: 0; title: ;" title="">
describe('list-item-controller remove event response', function() {

  it('should invoke list-controller:removeItem()', function() {
    var newItem = listController.createNewItem(),
        itemRenderer = listController.getRendererFromItem(newItem);

    spyOn(listController, 'removeItem');
    $(itemRenderer).trigger('remove');
    expect(listController.removeItem).toHaveBeenCalledWith(newItem);
  });

});
</pre>
<p>In this spec, we set up a <a href="https://github.com/pivotal/jasmine/wiki/Spies" target="_blank">spy</a> to verify that the <code>removeItem()</code> method is invoked upon dispatch of <code>remove</code> from a <code>list-item-controller</code> instance.</p>
<p>Run that and we are back to red, with a message letting us know that <code>removeItem()</code> was never called.<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_vii_5.png" alt="Failing implementation of remove event." /><br />
Good. Let&#8217;s open up <code>list-controller</code> and implement a <code>remove</code> event response:</p>
<p>/script/controller/list-controller.js</p>
<pre class="brush: jscript; first-line: 40; highlight: [51,52,53,63]; title: ;" title="">
$collection.on('collection-change', function(event) {
  var model, itemController, $itemView;
  switch( event.kind ) {
    case EventKindEnum.ADD:
      $itemView = $('&lt;li&gt;');
      model = event.items.shift();
      itemController = itemControllerFactory.create($itemView, model);

      $itemView.appendTo(listController.$view);
      rendererList.addItem(itemController);
      itemController.state = itemControllerFactory.state.EDITABLE;
      $(itemController).on('remove', function(event) {
        listController.removeItem(model);
      });
      break;
    case EventKindEnum.REMOVE:
      model = event.items.shift();
      itemController = listController.getRendererFromItem(model);

      if(itemController) {
        $itemView = itemController.parentView;
        $itemView.remove();
        itemController.dispose();
        $(itemController).off('remove');
        rendererList.removeItem(itemController);
      }
      break;
    case EventKindEnum.RESET:
      break;
  }
});
</pre>
<p>We added the remove handler delegation in the <code>ADD</code> case when the collection changes, along with the other implementation of item renderer establishment. And, for good measure and memory management, we are sure to remove the event handler in the <code>REMOVE</code> case from the collection change, as well.</p>
<p>Run the test now and we are back to green!<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_vii_6.png" alt="Passing remove event response." /></p>
<h3>list-item-controller Modification</h3>
<p>That&#8217;s great, but we are still glazing over the usability aspect: <em>How does a User delete an item?</em></p>
<p>Again, we could go into a lengthy discussion of UX and code implementations, but to save yourself from scrolling just to read me ramble off topic, we&#8217;ll keep it simple: <em>add a delete button</em>! I don&#8217;t know why I got excited there. I&#8217;ll show the implementation in piecemeal just to see how it all comes together. First we&#8217;ll start with the markup we declared for the <code>list-item-controller</code> views:</p>
<p><em>/script/controller/list-item-controller.js</em></p>
<pre class="brush: jscript; first-line: 56; highlight: [56,57,58,59]; title: ;" title="">
uneditableItemFragment  = '&lt;p class=&quot;grocery-item&quot;&gt;' +
                                             '&lt;span class=&quot;grocery-item-label&quot; /&gt;' +
                                             '&lt;button class=&quot;delete-item-button&quot;&gt;delete&lt;/button&gt;' +
                                           '&lt;/p&gt;',
editableItemFragment    = '&lt;p class=&quot;editable-grocery-item&quot;&gt;' +
                                            '&lt;input name=&quot;editableItem&quot; ' +
                                              'class=&quot;editable-item&quot; placeholder=&quot;Enter item name...&quot;&gt;' +
                                            '&lt;/input&gt;' +
                                         '&lt;/p&gt;'
</pre>
<p>The <code>uneditableItemFragment</code> markup has changed slightly to support a label and a button. It was previously just a <code>p</code> element all by its lonesome, but with several references for modification and event <code>click</code> event handling. We&#8217;ll need to update those, as well as add another event handler for the <code>button</code> element:</p>
<p><em>/script/controller/list-item-controller.js</em></p>
<pre class="brush: jscript; first-line: 68; highlight: [73,74,75,76,77,78,79,80,81,82]; title: ;" title="">
init: function() {
  this.$editableView = $(editableItemFragment);
  this.$uneditableView = $(uneditableItemFragment);

  // view handlers.
  $('span.grocery-item-label', this.$uneditableView).on('click', (function(controller) {
    return function(event) {
      var toggled = $(this).css('text-decoration') === 'line-through';
      controller.model.marked = !toggled;
    };
  }(this)));
  $('button.delete-item-button', this.$uneditableView).on('click', (function(controller) {
    return function(event) {
      $(controller).trigger(createRemoveEvent(controller));
    };
  }(this)));
  ...
}
</pre>
<p>As seen previously, we are using <a href="http://benalman.com/news/2010/11/immediately-invoked-function-expression/" target="_blank">IIFE</a>s here as a factory method in order to pass in a reference to the <code>list-item-controller</code> instance instead of declaring the old:</p>
<pre class="brush: jscript; title: ;" title="">
var self = this;
</pre>
<p>and then passing <code>self</code> around which always makes me cringe. In any event (no pun intended), we have transferred the <em>click</em> handling previously assigned to the <code>p</code> element over the <code>span</code> element in order to support the usability of marking off an item. As well, we added handling of delete <code>button</code> <em>click</em> to trigger a new event:</p>
<p><em>/script/controller/list-item-controller.js</em></p>
<pre class="brush: jscript; first-line: 10; title: ;" title="">
function createRemoveEvent(controller) {
  var event = $.Event('remove');
  event.controller = controller;
  return event;
}
</pre>
<p>Pretty straight forward in how we have create factory methods for our <a href="http://jquery.org" target="_blank">jQuery</a> events previously in this series. Next we need to modify the references that respond to model changes, such as the <code>marked</code> property value:</p>
<p><em>/script/controller/list-item-controller.js</em></p>
<pre class="brush: jscript; first-line: 16; highlight: [20,24,25]; title: ;" title="">
function handlePropertyChange(controller, event) {
  if(event.property === &quot;name&quot;) {
    // update view based on model change.
    $('input', controller.$editableView).val(controller.model.name);
    $('span.grocery-item-label', controller.$uneditableView).text(event.newValue);
  }
  else if(event.property === &quot;marked&quot;) {
    // update view based on model change.
    $('span.grocery-item-label', controller.$uneditableView)
        .css('text-decoration', ( event.newValue ) ? 'line-through' : 'none');
  }
}
</pre>
<p>Alright. That should just about do it. Now you may be saying to yourself, <em>&#8216;Why haven&#8217;t we modified any tests in order to support this change in UI and event handling?&#8217;</em> To which I will respond, <em>&#8216;Stop bringing that up!&#8217;</em> In all seriousness, we perhaps should be writing tests to support these changes, however those will get pretty fine grained on the UI design aspect of the application. As you can see, it is constantly changing at this time and we are more concerned with the logical points of how the <strong>Grocery List</strong> application should behave. </p>
<p><small>Like with most of my code, future me may look back and shake his head at past me for such a statement &#8211; but for right now, present me will live with it</small> <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<h3>Using the Grocery List Application</h3>
<p>Let&#8217;s actually <em>run</em> the application and use it. We spend all this time making our tests turn red and green, we barely get to use what we are building.<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_vii_7.png" alt="Grocery list application" /></p>
<p>Oh my&#8230; that is ugly to look at. But it works! And it&#8217;s backed by tests!</p>
<p>Because I can&#8217;t leave well enough alone, I added some quick styling just to make it a little more pleasant on the eyes. I am not designer, so it might not be any more pleasant to you <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  I won&#8217;t go into the styling of the application as that could be a whole &#8216;nother article and discussion of box model, but feel free to mess around with the styling on your own&#8230;<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_vii_8.png" alt="Prettier Grocery List application" /></p>
<p>Tagged <strong>0.1.11</strong>: <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.11" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.11</a></p>
<h2>Conclusion</h2>
<p>In this article of the series, we took more of a traditional approach to <a href="http://en.wikipedia.org/wiki/Test-driven_development" target="_blank">TDD</a> and went along making things turn <span style="color: red;">red</span> before they turn <span style="color: green;">green</span>, one spec at a time, and all the while implementing the <em>Remove Item</em> feature. </p>
<p>The <strong>Grocery List</strong> application is also coming along pretty nicely and, as always, is easy and ready to use. But I can&#8217;t leave well enough alone and there are a few more items on my list (no pun intended) that I wish to address before ending this series, most importantly persistence. Our grocery list only last within the session of the page &#8211; once closed, our list is gone. We&#8217;ll get to that, but there might be some other things to address beforehand.</p>
<p>Cheers for sticking around!</p>
<p>&#8212;</p>
<h1>Link Dump</h1>
<h2>Reference</h2>
<p><a href="http://tddjs.com/" target="_blank">Test-Driven JavaScript Development by Christian Johansen</a><br />
<a href="http://dannorth.net/introducing-bdd/" target="_blank">Introducing BDD by Dan North</a><br />
<a href="http://requirejs.org/" target="_blank">RequireJS</a><br />
<a href="https://github.com/amdjs/amdjs-api/wiki/AMD" target="_blank">AMD</a><br />
<a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a><br />
<a href="http://sinonjs.org/" target="_blank">Sinon</a><br />
<a href="https://github.com/derickbailey/jasmine.async" target="_blank">Jasmine.Async</a></p>
<h2>Post Series</h2>
<p><a href="https://github.com/bustardcelly/grocery-ls">grocery-ls github repo</a><br />
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i" target="_blank">Part I &#8211; Introduction</a><br />
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii">Part II &#8211; Feature: Add Item</a><br />
<a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii">Part III &#8211; Feature: Mark-Off Item</a><br />
<a href="http://custardbelly.com/blog/2012/12/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-iv">Part IV &#8211; Feature: List-Item-Controller</a><br />
<a href="http://custardbelly.com/blog/2012/12/31/the-making-of-a-test-driven-grocery-list-application-in-js-part-v/">Part V &#8211; Feature: List-Controller Refactoring</a><br />
<a href="http://custardbelly.com/blog/2013/01/08/the-making-of-a-test-driven-grocery-list-application-in-js-part-vi/" target="_blank">Part VI &#8211; Back to Passing</a><br />
<a href="http://custardbelly.com/blog/2013/01/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-vii/">Part VII &#8211; Remove Item</a><br />
<a href="http://custardbelly.com/blog/2013/01/22/the-making-of-a-test-driven-grocery-list-application-part-viii/">Part VIII &#8211; Bug Fixing</a><br />
<a href="http://custardbelly.com/blog/2013/02/15/the-making-of-a-test-driven-grocery-list-application-in-js-part-ix/">Part IX &#8211; Persistence</a><br />
<a href="http://custardbelly.com/blog/2013/03/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-x/">Part X &#8211; It Lives!</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/amd/" title="View all posts in AMD" rel="category tag">AMD</a>,  <a href="http://custardbelly.com/blog/category/javascript/" title="View all posts in JavaScript" rel="category tag">JavaScript</a>,  <a href="http://custardbelly.com/blog/category/requirejs/" title="View all posts in RequireJS" rel="category tag">RequireJS</a>,  <a href="http://custardbelly.com/blog/category/grocery-ls/" title="View all posts in grocery-ls" rel="category tag">grocery-ls</a>,  <a href="http://custardbelly.com/blog/category/jasmine/" title="View all posts in jasmine" rel="category tag">jasmine</a>,  <a href="http://custardbelly.com/blog/category/unit-testing/" title="View all posts in unit-testing" rel="category tag">unit-testing</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2013/01/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-vii/#comments" rev="post-742"  title="Comment on The Making of a Test-Driven Grocery List Application in JS: Part VII">3 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2013-01-17T07:58">January 17, 2013</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-742-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-725" class="post-725 post hentry category-amd category-javascript category-requirejs category-grocery-ls category-jasmine category-unit-testing full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2013/01/08/the-making-of-a-test-driven-grocery-list-application-in-js-part-vi/" title="Permanent link to The Making of a Test-Driven Grocery List Application in JS: Part VI" rel="bookmark" rev="post-725">The Making of a Test-Driven Grocery List Application in JS: Part VI</a></h1>
	
	<div class="entry-content full-content">
		<p><em>This is the sixth installment in a series of building a Test-Driven Grocery List application using <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> and <a href="http://requirejs.org" target="_blank">RequireJS</a>. To learn more about the intent and general concept of the series please visit <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i/">The Making of a Test-Driven Grocery List Application in JavaScript: Part I</a></em><br />
&#8212;</p>
<h2>Introduction</h2>
<p>We left the <a href="http://custardbelly.com/blog/2012/12/31/the-making-of-a-test-driven-grocery-list-application-in-js-part-v/" target="_blank">previous post</a> with <span style="color:#ff0000;">failing tests</span>! </p>
<p>I don&#8217;t necessarily condone leaving a master branch in such a state, so don&#8217;t give my name to your managers <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  I, however, have no problem with leaving a feature or developer branch at the end of the day with failing tests &#8211; within reason. As long as the errors are from unimplemented behavior and the branch is not being monitored by some CI server feeding reports to your client(s), I see no problem. Sometimes I will write out the tests I plan to resolve the following day at 5:30 just so I can get a refresher the next morning as to the task at hand.</p>
<p>In the article I plan to get your tests all green again by modifying the <em>Mark Off Item</em> tests and possibly add a few new features.</p>
<h2>Mark Off Item Feature</h2>
<p>Way back in the <a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii/" target="_blank">third article in this series</a>, we wrote up a story and some feature specs around the usability of marking off an item already existant in the list of item of the <strong>Grocery List</strong> application. In getting this feature implemented, we added a basic mark-item API to the <code>list-controller</code>, which allowed us to pass in a <code>grocery-ls-item</code> model to the <code>list-controller</code> which would then modify its state. </p>
<p>In the previous couple posts, we have refactored <code>list-controller</code> to not be responsible for item state and to respond to changes on a collection model &#8211; this is what led us to <span style="color: #ff0000;">failing tests</span>. We still want to keep the <em>Mark Off Item</em> feature, but instead of having specs that tested the mark-item API of the <code>list-controller</code>, we&#8217;re going to change the specs to verify that the <code>grocery-ls-item</code> model that is being modified updates its state and is retained in the collection held by the <code>list-controller</code>.</p>
<h3>Tests</h3>
<p>When I start creating the tests, I take some time in thinking about the <strong>Given</strong>s. Typically, the <strong>Given</strong>s are what make up the <code>beforeEach()</code> setup of a spec suite, but they can also lead to address some design concerns about components involved in getting the tests to pass. Such is the case in modifying our <em>Mark Off Item</em> feature specs.</p>
<p>We are not necessarily going to test the UI changes related to the action of marking off an item from the <strong>Grocery List</strong>. We could, but it is more important to me to test that the <code>grocery-ls-item</code> model that holds that state value of being marked is properly retaining that value and accessible from not only the collection, but from the associated <code>list-item-controller</code> instance, as well &#8211; after all, it is the <code>list-item-controller</code> that is responsible for responding to changes to an item being marked-off; i want to ensure that, in the very least, it has the opportunity, not actually what it does with the opportunity. </p>
<p><small>That statement may sound foolish, i&#8217;ll admit. If it was an expectation that the action of marking off an item was to trigger a reaction that defined another feature specification, then certainly I would write up tests accordingly. But as it stands, it changes a style on the <code>list-item-controller</code> view. I am not so concerned with that implementation at the moment &#8211; if it becomes a real business issue and it was a requirement to have the text shown with a strike-through, then yes.</small></p>
<p>Let&#8217;s start with the setup and teardown for the <em>Mark Off Item</em> feature specs:</p>
<p><em>/test/jasmine/spec/feature/markitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define(['jquery', 'script/controller/list-controller', 'script/controller/list-item-controller'],
        function($, listController, itemControllerFactory) {

  describe('Existing item is marked-off', function() {

    var item,
        itemController,
        getRendererStub;

    beforeEach( function() {
      item = listController.createNewItem();

      itemController = itemControllerFactory.create($('&lt;li/&gt;'), item);
      getRendererStub = sinon.stub();
      getRendererStub.returns(itemController);
      listController.getRendererFromItem = getRendererStub;
    });

    afterEach( function() {
      item = undefined;
      itemController = undefined;
      getRendererStub = undefined;
    });

  });

});
</pre>
<p>In the <code>beforeEach()</code>, we&#8217;ve stubbed out a new method on <code>list-controller</code> that allows us to access the associated <code>list-item-controller</code> with a model: <code>getRendererFromItem()</code>.</p>
<p>If you remember <a href="http://custardbelly.com/blog/2012/12/31/the-making-of-a-test-driven-grocery-list-application-in-js-part-v/" target="_blank">from the last article</a>, we also did some stubbing of methods before moving to implementation on <code>list-controller</code>. We are doing the same here and using the <a href="http://sinonjs.org" target="_blank">SinonJS</a> <code>stub</code> API to stub a method that currently does not exist on <code>list-controller</code>. To do so, and not have exceptions thrown in your tests regarding the existence of the method on the object being stubbed, you create an anonymous stub and assign it to the target object:</p>
<p><em>/test/jasmine/spec/feature/markitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 14; title: ;" title="">
getRendererStub = sinon.stub();
getRendererStub.returns(itemController);
listController.getRendererFromItem = getRendererStub;
</pre>
<p>The stub is sort of a fub, seeing as it is not really accessing the <code>list-item-controller</code> created by the <code>list-controller</code> in response to change on the collection &#8211; but it does provide some basis of design in that <code>getRendererFromItem()</code> is expected to return a <code>list-item-controller</code> which in turn responds to the provided model. Anyway, once we remove the stub and implement the API on the <code>list-controller</code> itself, we&#8217;ll certainly have to write more tests for that integration as we are not necessarily concerned in this specification of <code>getRendererFromItem()</code> returning the correct <code>list-item-controller</code> instance&#8230; so you have that to look forward to <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  Right now, we only care about the preservation of state and model existence within the application.</p>
<p>First we&#8217;ll test that setting an item as marked is preserved in the model and held on the item controller:<br />
<em>/test/jasmine/spec/feature/markitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 19; title: ;" title="">
it('should denote item as being in possession', function() {
  var itemRenderer = listController.getRendererFromItem(item);
      savedItemSpy = sinon.spy();

  savedItemSpy(itemRenderer.model);
  item.marked = true;

  expect(item.marked).toEqual(true);
  sinon.assert.calledWith(savedItemSpy, sinon.match.hasOwn('marked', true));
});
</pre>
<p>Then, I want to ensure that marking off an item does not mean that it is removed from the overall collection:<br />
<em>/test/jasmine/spec/feature/markitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 31; title: ;" title="">
it('should retain the item in the grocery list collection', function() {
  var itemIndex = listController.getItemList().getItemIndex(item);

  item.marked = true;
  expect(listController.getItemList().getItemIndex(item)).toEqual(itemIndex);
});
</pre>
<p>And finally, just to be sure that we can safely toggle the marked off state and it be retained:<br />
<em>/test/jasmine/spec/feature/markitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 39; title: ;" title="">
it('should retain item in renderer listing regardless of marked-off status', function() {
  var itemRenderer = listController.getRendererFromItem(item),
      itemIndex = listController.getItemList().getItemIndex(item);

  item.marked = true;
  item.marked = false;

  expect(itemRenderer.model.marked).toEqual(false);
  expect(listController.getItemList().getItemIndex(item)).toEqual(itemIndex);
});
</pre>
<p>Perhaps the last one is out of a little paranoia, but it also describes the behavior of the <em>Mark Off Item</em> feature as being togglable from a User standpoint &#8211; meaning, marking off an item is not considered deleting it from the list. Also, a little paranoia sprinkled on some tests can save you from fret when working with the implementation code. </p>
<p>Speaking of implementation&#8230;</p>
<h3>list-controller Implementation</h3>
<p>Moving the <code>getRendererFromItem()</code> method over to the <code>list-controller</code> will involve holding and maintaining a list of <code>list-item-renderers</code>. We&#8217;ll use the <em>Collection</em> object we created previously for the models and place the job of curation between both collections on the <code>list-controller</code>:</p>
<p><em>/script/controller/list-controller</em></p>
<pre class="brush: jscript; first-line: 4; highlight: [5,11,12,13,14,15,16,17,18,19]; title: ;" title="">
var collection = collectionFactory.create(),
    rendererList = collectionFactory.create(),
    listController = {
      $view: undefined,
      getItemList: function() {
        return collection;
      },
      getRendererFromItem: function(item) {
        var i = rendererList.itemLength();
        while( --i &gt; -1 ) {
          if(rendererList.getItemAt(i).model === item) {
            return rendererList.getItemAt(i);
          }
          return undefined;
        }
      },
      createNewItem: function() {
        var model = modelFactory.create();
        collection.addItem(model);
        return model;
      },
      setView: function(view) {
        this.$view = (view instanceof $) ? view : $(view);
      }
    };
</pre>
<p>If an associated <code>list-item-controller</code> cannot be found from the provided <code>grocery-ls-item</code> model, then undefined is returned. We will ensure this and other expectations in a new integration test for the <code>list-controller</code> in a bit, but for now we have a little more work to do in order for the list-controller to behave as described in the <em>Mark Off Item</em> feature specs.</p>
<p>Next step is to have the tests fail by removing the stub for the <code>getRendererFromItem()</code> method now on the <code>list-controller</code>:<br />
<em>/test/jasmine/spec/feature/markitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define(['jquery', 'script/controller/list-controller'],
        function($, listController) {

  describe('Existing item is marked-off', function() {

    var item;

    beforeEach( function() {
      item = listController.createNewItem();
    });

    it('should denote item as being in possession', function() {
      var itemRenderer = listController.getRendererFromItem(item);
          savedItemSpy = sinon.spy();

      savedItemSpy(itemRenderer.model);
      item.marked = true;

      expect(item.marked).toEqual(true);
      sinon.assert.calledWith(savedItemSpy, sinon.match.hasOwn('marked', true));
    });

    it('should retain the item in the grocery list collection', function() {
      var itemIndex = listController.getItemList().getItemIndex(item);

      item.marked = true;
      expect(listController.getItemList().getItemIndex(item)).toEqual(itemIndex);
    });

    it('should retain item in renderer listing regardless of marked-off status', function() {
      var itemRenderer = listController.getRendererFromItem(item),
          itemIndex = listController.getItemList().getItemIndex(item);

      item.marked = true;
      item.marked = false;
      expect(itemRenderer.model.marked).toEqual(false);
      expect(listController.getItemList().getItemIndex(item)).toEqual(itemIndex);
    });

    afterEach( function() {
      item = undefined;
    });

  });

});
</pre>
<p>Run the tests, and we&#8217;ll get failures related to the <code>getRendererFromItem()</code> method returning undefined with each call:<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_vi_1.png" alt="Failing tests on getRendererFromItem invocation" /></p>
<p>Good. That sort of assures us that <code>getRendererFromItem()</code> works as expected. This little mid-implementation failure won&#8217;t save us from writing proper tests for <code>list-controller</code>, but it&#8217;s a warm feeling for now <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<p>The reason that <code>getRendererForItem()</code> is returning undefined on each call is that we have not modified <code>list-controller</code> to add the <code>list-item-controller</code> renderer to the underlying <code>rendererList</code> collection. Let&#8217;s add the maintenance to the <em>collection-change</em> response on the model collection:</p>
<p><em>/script/controller/list-controller</em></p>
<pre class="brush: jscript; first-line: 37; highlight: [38,42,43,46]; title: ;" title="">
$collection.on('collection-change', function(event) {
  var model, itemController, $itemView;
  switch( event.kind ) {
    case EventKindEnum.ADD:
      $itemView = $('&lt;li&gt;');
      model = event.items.shift();
      itemController = itemControllerFactory.create($itemView, model);

      $itemView.appendTo(listController.$view);
      rendererList.addItem(itemController);
      itemController.state = itemControllerFactory.state.EDITABLE;
      break;
    case EventKindEnum.REMOVE:
      break;
    case EventKindEnum.RESET:
      break;
  }
});
</pre>
<p>We&#8217;ve moved the variable declarations out of the <em>switch..case</em> for the <code>ADD</code> event type; they are hoisted by the interpreter, anyway, but I like a little more clarity. More importantly, we are adding the newly created <code>list-item-controller</code> to he <code>renderList</code>.</p>
<p>Run the tests and we&#8217;ll be back to green!<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_vi_2.png" alt="Passing tests on getRendererFromItem implementation" /></p>
<p>Hold on! Before you run out the door and down the street singing my praises&#8230; you need pants. I don&#8217;t know why you are reading this article without pants, but you probably will get a fine. Plus, we really need to add some tests for the <code>list-controller</code>.</p>
<h2>list-controller Tests</h2>
<p>The <em>Mark Off Item</em> specs we just got to pass are great in describing that feature and the usability, but they don&#8217;t necessarily test all the expectations we have of the <code>list-controller</code> and its API. Perhaps we should have wrote up the tests for <code>list-controller</code> and, specifically, the <code>getRendererFromItem()</code> method prior to modifying the <em>Mark Off Item</em> specs and getting them to pass. I would agree with that, but I am also not a stickler&#8230; as long as we get some integration tests in for <code>list-controller</code>, I won&#8217;t hold it against myself <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<p>There are more tests regarding the <code>list-controller</code> API in the repository tagged later in this article, but for now I wanted to create a new spec suite for <code>list-controller</code> and test the expectations we had previously described for the <code>getRendererFromItem()</code> method:</p>
<p><em>/test/jasmine/spec/list-controller.spec.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define(['jquery', 'script/controller/list-controller', 'script/model/grocery-ls-item'],
        function($, listController, modelFactory) {

  describe('Grocery List list-controller', function() {

    describe('getRendererItem()', function() {

      it('should return renderer associated with model', function() {
        var itemModel, renderer;

        itemModel = listController.createNewItem();
        renderer = listController.getRendererFromItem(itemModel);
        expect(renderer).not.toBeUndefined();
        expect(renderer.model).toBe(itemModel);
      });

      it('should return undefined with no associated model', function() {
        var itemModel, renderer;

        itemModel = modelFactory.create();
        renderer = listController.getRendererFromItem(itemModel);
        expect(renderer).toBeUndefined();
      });

    });

  });

});
</pre>
<p>We have defined two tests for the <code>getRendererFromItem()</code> method on <code>list-controller</code> to ensure that it <strong>1)</strong> does return the associated renderer when available and <strong>2)</strong> does return undefined when an associated renderer is not available.</p>
<p>Let&#8217;s add that to the specrunner:<br />
<em>/test/jasmine/specrunner.html</em></p>
<pre class="brush: jscript; first-line: 34; highlight: [35]; title: ;" title="">
require( ['spec/feature/additem.spec.js', 'spec/feature/markitem.spec.js',
          'spec/list-controller.spec.js', 'spec/list-item-controller.spec.js', 'spec/grocery-ls-item.spec.js',
          'spec/collection.spec.js'], function() {

  var jasmineEnv = jasmine.getEnv(),
      ...
  jasmineEnv.execute();

});
</pre>
<h4>aside</h4>
<p>You may be wondering why it seems like I am doubling up on tests; after all, we have verified that the <code>getRendererFromItem()</code> method does as expected from within the <em>Mark Off Item</em> specs. This is true. However, I think of this spec suite, <em>list-controller.spec.js</em>, as more unit tests in that we are verifying how the component behaves. Within the <em>Mark Off Item</em> specs, I feel it is closer to how the component behaves in the system and reveals more of an expectation of the features of the <strong>Grocery List</strong> application. If I was to do further work in modifying the <code>list-controller</code>, I would start with this spec, and if it impacted the <em>Mark Off Item</em> feature, get that passing afterward. Not stuck in my way of thinking on this, but it my current workflow. Let me know if you have any better strategies.</p>
<p>Actually, that brings up a good point. We should revisit the <em>Add Item</em> specs and add a test to ensure that the newly created item returned from <code>createNewItem()</code> will return an associated list-item-controller instance from <code>getRendererFromItem()</code>&#8230;</p>
<h2>Add Item Feature Update</h2>
<p>We&#8217;ll add a spec to the current suite that verifies that the new created <code>grocery-ls-item</code> is properly paired with the <code>list-item-controller</code> and that they associated view is the one made available on the <strong>Grocery List</strong> UI:</p>
<p><em>/test/jasmine/spec/feature/additem.spec.js</em></p>
<pre class="brush: jscript; first-line: 33; title: ;" title="">
it('should enable associated item renderer as editable', function() {
  var newItem = listController.createNewItem(),
      itemRenderer = listController.getRendererFromItem(newItem);

    expect(itemRenderer).not.toBeUndefined();
    expect(itemRenderer.model).toBe(newItem);
    expect(itemRenderer.state).toEqual(itemControllerFactory.state.EDITABLE);
    expect($listView.children()[0]).toBe(itemRenderer.parentView.get(0));
});
</pre>
<p>The last expectation in there utilizes some of the access API from <a href="http://custardbelly.com/blog/jquery.org" target="_blank">jQuery</a>. If you are unfamiliar with it, it is basically testing that the first item in the parent list view is that of the <code>parentView</code> managed by the associated <code>list-item-controller</code>. If you take a look at the <a href="https://github.com/bustardcelly/grocery-ls/blob/0.1.8/test/jasmine/spec/feature/newitem.spec.js" target="_blank">previous spec</a>, we had already verified that the child list of the list view had been changed to include a new item; now we are ensuring that the new item is the correct one, accessible from <code>getRendererFromItem()</code>.</p>
<p>I think that pretty much shores up the proper testing in describing the <em>Add Item</em> and <em>Mark Off Item</em> features. Run the tests and all are green!<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_vi_3.png" alt="Passing tests for Add Item and Mark Off Item Features" /></p>
<p>Tagged <strong>0.1.9</strong> : <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.9" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.9</a></p>
<h2>Conclusion</h2>
<p>We got the <em>Mark Off Item</em> specs running green again after we had left the application in a failing state from the <a href="http://custardbelly.com/blog/2012/12/31/the-making-of-a-test-driven-grocery-list-application-in-js-part-v/" target="_blank">last article</a>. Hooray! But, we are still only addressing half of the usability features I envision for the <strong>Grocery List</strong> application. Sometimes it is easy to forget that we are still building an application. If you ran it, you would see that it still works as expected, which I think is rather cool; I mean, we have been busying ourselves ensuring that our code will support our understanding of the system, and at the end of the day, it actually does. We have been running the test runner much more than the actual application. That is not to say that we shouldn&#8217;t be doing more User testing&#8230;</p>
<p>Anyway, in the next article I think we should address a new feature &#8211; Removal. Cheers for sticking around!</p>
<p>&#8212;</p>
<h1>Link Dump</h1>
<h2>Reference</h2>
<p><a href="http://tddjs.com/" target="_blank">Test-Driven JavaScript Development by Christian Johansen</a><br />
<a href="http://dannorth.net/introducing-bdd/" target="_blank">Introducing BDD by Dan North</a><br />
<a href="http://requirejs.org/" target="_blank">RequireJS</a><br />
<a href="https://github.com/amdjs/amdjs-api/wiki/AMD" target="_blank">AMD</a><br />
<a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a><br />
<a href="http://sinonjs.org/" target="_blank">Sinon</a><br />
<a href="https://github.com/derickbailey/jasmine.async" target="_blank">Jasmine.Async</a></p>
<h2>Post Series</h2>
<p><a href="https://github.com/bustardcelly/grocery-ls">grocery-ls github repo</a><br />
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i" target="_blank">Part I &#8211; Introduction</a><br />
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii">Part II &#8211; Feature: Add Item</a><br />
<a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii">Part III &#8211; Feature: Mark-Off Item</a><br />
<a href="http://custardbelly.com/blog/2012/12/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-iv">Part IV &#8211; Feature: List-Item-Controller</a><br />
<a href="http://custardbelly.com/blog/2012/12/31/the-making-of-a-test-driven-grocery-list-application-in-js-part-v/">Part V &#8211; Feature: List-Controller Refactoring</a><br />
<a href="http://custardbelly.com/blog/2013/01/08/the-making-of-a-test-driven-grocery-list-application-in-js-part-vi/" target="_blank">Part VI &#8211; Back to Passing</a><br />
<a href="http://custardbelly.com/blog/2013/01/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-vii/">Part VII &#8211; Remove Item</a><br />
<a href="http://custardbelly.com/blog/2013/01/22/the-making-of-a-test-driven-grocery-list-application-part-viii/">Part VIII &#8211; Bug Fixing</a><br />
<a href="http://custardbelly.com/blog/2013/02/15/the-making-of-a-test-driven-grocery-list-application-in-js-part-ix/">Part IX &#8211; Persistence</a><br />
<a href="http://custardbelly.com/blog/2013/03/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-x/">Part X &#8211; It Lives!</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/amd/" title="View all posts in AMD" rel="category tag">AMD</a>,  <a href="http://custardbelly.com/blog/category/javascript/" title="View all posts in JavaScript" rel="category tag">JavaScript</a>,  <a href="http://custardbelly.com/blog/category/requirejs/" title="View all posts in RequireJS" rel="category tag">RequireJS</a>,  <a href="http://custardbelly.com/blog/category/grocery-ls/" title="View all posts in grocery-ls" rel="category tag">grocery-ls</a>,  <a href="http://custardbelly.com/blog/category/jasmine/" title="View all posts in jasmine" rel="category tag">jasmine</a>,  <a href="http://custardbelly.com/blog/category/unit-testing/" title="View all posts in unit-testing" rel="category tag">unit-testing</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2013-01-08T11:31">January 8, 2013</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-725-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-686" class="post-686 post hentry category-amd category-javascript category-requirejs category-grocery-ls category-jasmine category-unit-testing full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2012/12/31/the-making-of-a-test-driven-grocery-list-application-in-js-part-v/" title="Permanent link to The Making of a Test-Driven Grocery List Application in JS: Part V" rel="bookmark" rev="post-686">The Making of a Test-Driven Grocery List Application in JS: Part V</a></h1>
	
	<div class="entry-content full-content">
		<p><em>This is the fifth installment in a series of building a Test-Driven Grocery List application using <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> and <a href="http://requirejs.org" target="_blank">RequireJS</a>. To learn more about the intent and general concept of the series please visit <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i/">The Making of a Test-Driven Grocery List Application in JavaScript: Part I</a></em><br />
&#8212;</p>
<h2>Introduction</h2>
<p>The <a href="http://custardbelly.com/blog/2012/12/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-iv" target="_blank">previous article</a> was prefaced to be a refactoring effort to remove responsibilities of item management from the <em>list-controller</em> to instances of a <em>list-item-controller</em>. We designed the list-item-controller through specs, moved the factory to its own AMD and modified not only the <em>grocery-ls-item</em> model, but how the <em>list-item-controller</em> responded to changes of it.</p>
<p>All important and &#8211; in my view &#8211; much needed changes. However, we fell short on our goal. Sure, the tests still passed, but we modified nothing within the <em>list-controller</em> to reflect this transfer of responsibility. Part of the reason for this is my attempt at not overloading each article in this series with information. The other part is that I wanted a little time to stew over how I actually saw the revision of <em>list-controller</em>.</p>
<p>We still want to keep our feature specs of <em>Add Item</em> and <em>Mark Item</em> (and we have a few more features still to address), but I begin to question if it is really necessary to expose that functionality on the API of the <em>list-controller</em>. I am starting to see that those features are really part of a collection of <em>grocery-ls-item</em> models, and the controllers are just responders to changes on the collection and models themselves &#8211; the basis of MVC design.</p>
<p>Just as we implemented <em>list-item-controller</em> in the previous article with a design to respond to changes on a provided <em>grocery-ls-item</em> model and update its state accordingly, I propose so should we refactor the <em>list-controller</em> to respond to changes on a collection of <em>grocery-ls-item</em> models.</p>
<h2>Collection</h2>
<p>A generic collection is basically an object that provides a higher-level API to interact with an array of items. The API can provide a more readable way of adding and removing items on an underlying <a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a> instance instead of using methods like <em>push</em> or <em>splice</em> &#8211; which are base level and don&#8217;t use a nomenclature that is best suited for the action taken &#8211; but more importantly, the API provides a facade to operations on an array of items from which it can internally have stricter rules over such actions. </p>
<p>There are various libraries and frameworks out there that support collections, and even different type of collections &#8211; ie, sets, linked lists, etc. As has been mentioned in previous posts, I am trying not to introduce new libraries into this series as it may add unnecessary noise to the task at hand. This also allows for us to keep the <em>Collection</em> implementation lean and customizable for the <strong>Grocery List</strong> application; we&#8217;re also going to support event notification from the collection, which is not inherent in the JavaScript <a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a> object.</p>
<h3>Tests</h3>
<p>We will create the design of a <em>Collection</em> object piecemeal as we write the specs for it. To start, we know that it is to be a wrapper around an Array source:</p>
<p><em>/test/jasmine/spec/collection.spec.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define( ['jquery'], function($) {

  var collectionImpl = {
        itemLength: function() {
          return this.list.length;
        }
      },
      collectionFactory = {
        create: function(source) {
          var instance = Object.create(collectionImpl, {
              &quot;list&quot;: {
                  value: Array.isArray(source) ? source : [],
                  writable: true,
                  enumerable: true
          });
          return instance;
        }
      };

  describe('Collection', function() {

    describe('collection factory instance creation', function() {

      it('should create unique instances of collection from create()', function() {
        var collectionOne = collectionFactory.create(),
            collectionTwo = collectionFactory.create();
        expect(collectionOne).not.toBe(collectionTwo);
      });

      it('should create an empty collection without source array provided', function() {
        var collection = collectionFactory.create();
        expect(collection).not.toBeUndefined();
        expect(collection.itemLength()).toBe(0);
      });

      it('should create a collection from source array provided', function() {
        var items = ['apples', 'oranges'],
            collection = collectionFactory.create(items);
        expect(collection.itemLength()).toBe(2);
      });

    });

  });

});
</pre>
<p>We have defined two specs that involve testing the wrapped Array source for a collection. Upon creation, the array should be empty if no source array supplied or filled with items if source provided. Pretty straight forward.<br />
<small>Again, we are only concerned with the latest-and-greatest browsers, so you may notice the use of  <a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/Array/isArray" target="_blank">Array.isArray</a> when the <em>list</em> property is defined within the check the <em>source</em> argument on the <em>collectionFactory.create()</em> call.</small></p>
<h4>aside</h4>
<p>We could get into a lengthy discussion about the design of <em>collectionImpl</em>, and in particular that the <em>list</em> property is publicly accessible &#8211; i mean, after all, are we not defeating the point of providing an API to manipulate the list if some developer could just come along and access it directly? A valid point, and one I struggle with often. We could &#8211; and I would recommend, at times &#8211; using the functional inheritance pattern to &#8216;privately&#8217; hold the underlying list within the collection. For example:</p>
<pre class="brush: jscript; title: ;" title="">
var collectionImpl = (function(source) {
  var list = source;
  return {
    itemLength: function() {
      return list.length;
    }
  };
});
var instance = collectionImpl([]);
</pre>
<p>That would &#8216;<em>conveniently</em>&#8216; make the underlying array &#8216;private&#8217;, but there are an arguable list of pros and cons to this approach &#8211; the biggest con is the creation of a new object with new functions and new properties each call, rather then a shared inheritance. In essence, each new instance of collection created using this pattern could then modify, add and/or remove methods so that the API is not the same across all &#8216;instances&#8217; of the collection &#8211; that&#8217;s a big con for me.</p>
<p>For our implementation, let&#8217;s just take it with a grain of salt that we don&#8217;t expect anyone to maliciously access the source array of the collection and use the API we are defining in our tests <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<h4>end aside</h4>
<p>Even though in the last spec, we aren&#8217;t concerned with the underlying list being strictly equal to the provided source, we should probably check that the list has the correct items and is in the correct order:</p>
<p><em>/test/jasmine/spec/collection.spec.js</em></p>
<pre class="brush: jscript; first-line: 3; highlight: [7,8,9,10,11,12]; title: ;" title="">
var collectionImpl = {
  itemLength: function() {
    return this.list.length;
  },
  getItemAt: function( index ) {
    if( index &lt; 0 || (index &gt; this.itemLength() - 1) ) {
      return undefined;
    }
    return this.list[index];
  }
}
</pre>
<p>The <em>getItemAt()</em> method first verifies that the supplied index within the range of the wrapped array and returns undefined if not or the item held in the array at the supplied index. We can ensure that method works properly by adding a couple tests to the spec we already have for verifying the source provided on creation:</p>
<p><em>/test/jasmine/spec/collection.spec.js</em></p>
<pre class="brush: jscript; first-line: 35; highlight: [36,37,38,40,41]; title: ;" title="">
it('should create a collection from source array', function() {
  var itemOne = 'apples',
      itemTwo = 'oranges',
      collection = collectionFactory.create([itemOne, itemTwo]);
  expect(collection.itemLength()).toBe(2);
  expect(collection.getItemAt(0)).toEqual(itemOne);
  expect(collection.getItemAt(1)).toEqual(itemTwo);
});
</pre>
<p>Let&#8217;s go ahead and add some useful methods that will aid in adding and removing items to and from the collection:</p>
<p><em>/test/jasmine/spec/collection.spec.js</em></p>
<pre class="brush: jscript; first-line: 3; highlight: [7,8,9,10,11,12,13,14,15,16,17,18,19,20,21]; title: ;" title="">
  var collectionImpl = {
    itemLength: function() {
      return this.list.length;
    },
    addItem: function(item) {
      this.list.push(item);
      return item;
    },
    removeItem: function(item) {
      var index = this.list.indexOf(item);
      if( index &gt; -1 ) {
        this.list.splice(index, 1);
        return item;
      }
      return undefined;
    },
    removeAll: function() {
      this.list.length = [];
    },
    getItemAt: function( index ) {
      if( index &lt; 0 || (index &gt; this.itemLength() - 1) ) {
        return undefined;
      }
      return this.list[index];
    }
  }
</pre>
<p>We could add some specs for <em>addItem()</em> to ensure that the list does grow with each item appended to the end:</p>
<p><em>/test/jasmine/spec/collection.spec.js</em></p>
<pre class="brush: jscript; first-line: 69; title: ;" title="">
describe('collection item addition', function() {

  var collection;

  beforeEach( function() {
    collection = collectionFactory.create();
  });

  it('should append item to list from addItem()', function() {
    var item = 'grapes';
    collection.addItem(item);
    expect(collection.itemLength()).toBe(1);
    expect(collection.getItemAt(0)).toEqual(item);
  });

  it('should maintain order during multiple additions', function() {
    var itemOne = 'grapes',
        itemTwo = 'grapefruit';
    collection.addItem(itemOne);
    collection.addItem(itemTwo);
    expect(collection.itemLength()).toBe(2);
    expect(collection.getItemAt(1)).toEqual(itemTwo);
  });

  afterEach( function() {
    collection = undefined;
  });

});
</pre>
<p>&#8230; and throw in a spec suite for testing the removal API on the <em>Collection</em>:</p>
<p><em>/test/jasmine/spec/collection.spec.js</em></p>
<pre class="brush: jscript; first-line: 99; title: ;" title="">
describe('collection item removal', function() {

  var collection,
      itemOne = 'pineapple',
      itemTwo = 'pear';

  beforeEach( function() {
    collection = collectionFactory.create();
    collection.addItem(itemOne);
  });

  it('should remove only specified item and report length of 0 from removeItem()', function() {
    collection.removeItem(itemOne);
    expect(collection.itemLength()).toBe(0);
  });

  it('should remove specified item from proper index', function() {
    collection.addItem(itemTwo);
    collection.removeItem(itemOne);
    expect(collection.itemLength()).toBe(1);
    expect(collection.getItemAt(0)).toEqual(itemTwo);
  });

  it('should retain items in collection if item provided to removeItem() is not found', function() {
    collection.addItem(itemTwo);
    collection.removeItem('watermelon');
    expect(collection.itemLength()).toBe(2);
  });

  it('should empty the list on removeAll()', function() {
    collection.addItem(itemTwo);
    collection.removeAll();
    expect(collection.itemLength()).toBe(0);
  });

  afterEach( function() {
    collection = undefined;
  });

});
</pre>
<p>With that, we have roughly designed and verified the API for our custom <em>Collection</em> object. Let&#8217;s add it to our list of specs to run:</p>
<p><em>/test/jasmine/specrunner.html</em></p>
<pre class="brush: jscript; first-line: 34; highlight: [36]; title: ;" title="">
require( ['spec/newitem.spec.js', 'spec/markitem.spec.js',
          'spec/item-controller.spec.js', 'spec/grocery-ls-item.spec.js',
          'spec/collection.spec.js'], function() {

  var jasmineEnv = jasmine.getEnv(),
     ...
  jasmineEnv.execute();

});
</pre>
<p>Run it and all is green!<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_v_1.png" alt="Passing collection suite" /></p>
<p>Whoa. Settle down&#8230; we&#8217;re not done yet <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<h4>Collection Events</h4>
<p>If we think back to why we even started down this path of creating a Collection object, we&#8217;ll remember that its role in the <strong>Grocery List</strong> application is to serve as the model for the <em>list-controller</em>. It is the intention to eventually modify the <em>list-controller</em> to not only offload the responsibility of managing the relationship and interaction between individual <em>grocery-ls-item</em> models to their views, but also to respond to changes on the collection of <em>grocery-ls-item</em>s accordingly. As such, we will incorporate event notification into our <em>Collection</em> object, from which the <em>list-controller</em> can assign response delegates to changes on the collection.</p>
<p>Using <a href="http://api.jquery.com/category/Events/?rdfrom=http%3A%2F%2Fdocs.jquery.com%2Fmw%2Findex.php%3Ftitle%3DAPI%2F1.3%2FEvents%26redirect%3Dno" target="_blank">jQuery Event</a> as we have previously in the development of this application throughout this series, we&#8217;ll create a factory method that returns an event object based provided arguments. If you are familiar with collections from the <a href="http://www.adobe.com/devnet/flex/flex-sdk-download.html" target="_blank">Flex SDK</a>, you might notice something similar <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  :</p>
<p><em>/test/jasmine/spec/collection.spec.js</em></p>
<pre class="brush: jscript; title: ;" title="">
function createEvent(kind, items) {
  var event = new $.Event('collection-change');
  event.kind = kind;
  event.items = items;
  return event;
}
</pre>
<p>Basically, any event dispatched from the collection object will be of the same type, and its operation can be differentiated from the <em>kind</em> property. The items affected upon the associated operation (<em>kind</em>) are provided in an array as some operations may involve multiple items.</p>
<p>With the API we have defined for the collection, there are three operations that can modify the the list of items:</p>
<ul>
<li>add</li>
<li>remove</li>
<li>reset</li>
</ul>
<p>The methods associated with add and remove are pretty self-explanatory and we will consider <em>removeAll()</em> as a reset on the collection. With this in mind, let&#8217;s append a couple tests to our spec suites for these event notifications:</p>
<p><em>/test/jasmine/spec/collection.spec.js</em></p>
<pre class="brush: jscript; first-line: 121; title: ;" title="">
describe('collection item addition', function() {
...
    async.it('should notify on addition of item', function(done) {
      var item = 'grapes';
      $(collection).on('collection-change', function(event) {
        expect(event.kind).toBe('add');
        expect(event.items.length).toBe(1);
        expect(event.items[0]).toEqual(item);
        $(collection).off('collection-change');
        done();
      });
      collection.addItem(item);
    });
...
});
...
describe('collection item removal', function() {
...
  async.it('should notify on removal of item', function(done) {
    collection.addItem(itemTwo);
    $(collection).on('collection-change', function(event) {
      expect(event.kind).toBe('remove');
      expect(event.items.length).toBe(1);
      expect(event.items[0]).toEqual(itemOne);
      $(collection).off('collection-change');
      done();
    });
    collection.removeItem(itemOne);
  });

  async.it('should notify on reset of collection', function(done) {
    $(collection).on('collection-change', function(event) {
      expect(event.kind).toBe('reset');
      expect(event.items.length).toBe(0);
      $(collection).off('collection-change');
      done();
    });
    collection.removeAll();
  });

  afterEach( function() {
    collection = undefined;
  });
...
});
</pre>
<p>If you were to run the tests now, you would see a couple execute then hang intermittently as it waits for the async tests to timeout&#8230; because we haven&#8217;t implemented the dispatching of events from the collection yet <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<p><em>/test/jasmine/spec/collection.spec.js</em></p>
<pre class="brush: jscript; first-line: 10; highlight: [16,23,30]; title: ;" title="">
var collectionImpl = {
  itemLength: function() {
    return this.list.length;
  },
  addItem: function(item) {
    this.list.push(item);
    $(this).trigger(createEvent('add', [item]));
    return item;
  },
  removeItem: function(item) {
    var index = this.list.indexOf(item);
    if( index &gt; -1 ) {
      this.list.splice(index, 1);
      $(this).trigger(createEvent('remove', [item]));
      return item;
    }
    return undefined;
  },
  removeAll: function() {
    this.list.length = [];
    $(this).trigger(createEvent('reset', this.list));
  },
  getItemAt: function( index ) {
    if( index &lt; 0 || (index &gt; this.itemLength() - 1) ) {
      return undefined;
    }
    return this.list[index];
  }
}
</pre>
<p>Now, if you were to run the tests, all should be happy.</p>
<h3>Collection Module Implementation</h3>
<p>Just as we have done with the <em>list-item-controller</em> from the <a href="http://custardbelly.com/blog/2012/12/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-iv/" target="_blank">previous article</a>, we are going to take the work we had done in implementing the collection object within our tests and move it to an AMD module. This way, if we <em>ever</em> get around to refactoring the <em>list-controller</em>, we&#8217;ll be able to utilize the collection module:</p>
<p><em>/script/collection/collection.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define(['jquery'], function($) {

  function createEvent(kind, items) {
    var event = $.Event('collection-change');
    event.kind = kind;
    event.items = items;
    return event;
  }

  var _collectionEventKind = {
        ADD: 'add',
        REMOVE: 'remove',
        RESET: 'reset'
      },
      collection = {
        itemLength: function() {
          return this.list.length;
        },
        addItem: function(item) {
          this.list.push(item);
          $(this).trigger(createEvent(_collectionEventKind.ADD, [item]));
          return item;
        },
        removeItem: function(item) {
          var index = this.getItemIndex(item);
          if( index &gt; -1 ) {
            this.list.splice(index, 1);
            $(this).trigger(createEvent(_collectionEventKind.REMOVE, [item]));
            return item;
          }
          return undefined;
        },
        removeAll: function() {
          this.list.length = 0;
          $(this).trigger(createEvent(_collectionEventKind.RESET, this.list));
        },
        getItemAt: function(index) {
          if( index &lt; 0 || (index &gt; this.itemLength() - 1) ) {
            return undefined;
          }
          return this.list[index];
        },
        getItemIndex: function(item) {
          return this.list.indexOf(item);
        },
        contains: function(item) {
          return this.getItemIndex(item) != -1;
        }
      };

  return {
    collectionEventKind: _collectionEventKind,
    create: function(source) {
      var instance = Object.create(collection);
      Object.defineProperty(instance, &quot;list&quot;, {
          value: Array.isArray(source) ? source : [],
          writable: true,
          enumerable: true
      });
      return instance;
    }
  };

});
</pre>
<p>We have basically ripped the collection and factory out from our test implementation and dropped it into its own file, returning the event kind enumeration object and the <em>create()</em> factory method to generate new collections for this AMD module.</p>
<p>To verify that our <em>Collection</em> module works correctly, let&#8217;s replace the implementation in the test with this module reference and run our tests again:</p>
<p><em>/test/jasmine/spec/collection.spec.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [1]; title: ;" title="">
define( ['jquery', 'script/collection/collection'], function($, collectionFactory) {

  describe('Collection', function() {
     ...
  });

});
</pre>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_v_2.png" alt="Passing collection tests on AMD module" /></p>
<p>Tagged: <strong>0.1.6</strong> <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.6" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.6</a></p>
<h2>list-controller Refactoring</h2>
<p>Passing tests are great! But currently, they are lying to us. Well&#8230; not <em>really</em>,  but we have gone about all these new additions to our application and have yet still to refactor <em>list-controller</em> to utilize them. However, before we just start chopping out and inserting code from <em>list-controller</em>, I want to go over the API and specs currently defined and see if they still hold water &#8211; meaning we might be able to cut some tests out. We might not. We might even add more. Let&#8217;s see&#8230;</p>
<h3>newitem.spec</h3>
<p>As we designed the <a href="https://github.com/bustardcelly/grocery-ls/blob/0.1.3/script/controller/list-controller.js" target="_blank"><em>list-controller</em></a> from a <a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii" target="_blank">previous article</a>, it oversaw the state of list items, list item views, and sort of supported a quasi-state of <em>&#8216;editability&#8217;</em>. While this provided an API to create a new item, it was forced into exposing an <em>editableItem</em> that was then mutable based on other parts of its API &#8211; ie, <em>editFocusedItem()</em> and <em>saveFocusedItem()</em>. All well and good to support the feature requirements at the time, but we have now moved the item and item view management &#8211; as well as the editable state &#8211; to the latest <em>list-item-controller</em> as can be seen in the repo <a href="https://github.com/bustardcelly/grocery-ls/blob/0.1.5/script/controller/list-item-controller.js" target="_blank">tagged at 0.1.5</a>. As such, I feel not only the <em>list-controller</em>, itself, should change to reflect these modifications, but also its API.</p>
<p>We are going to stick with our feature request to be able to add a new item to the <strong>Grocery List</strong> application through the <em>list-controller</em>, but will revisit how that is done in accordance to the new functionality of both the <em>list-item-controller</em> and <em>list-controller</em>; mainly we want to keep in mind that both should be driven by their respective model: <em>grocery-ls-item</em> and <em>collection</em>.</p>
<p>Let&#8217;s first revisit the specs we defined for new item feature from <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii/" target="_blank">the second post</a> in this series:</p>
<p><em>// spec</em><br />
&#8212;<br />
<strong>Scenario 1:</strong> Item added to list<br />
<strong>Given</strong> a user requests to add an item to the list<br />
<strong>And</strong> has provided a name for the item<br />
<strong>When</strong> she requests to save the item<br />
<strong>Then</strong> the list has grown by one item<br />
<strong>And</strong> the list contains the item appended at the end<br />
&#8212;</p>
<p><em>// spec</em><br />
&#8212;<br />
<strong>Scenario 2:</strong> Item not added to list<br />
<strong>Given</strong> the list has a single item<br />
<strong>And</strong> a user requests to add an item to the list<br />
<strong>And</strong> has not provided a name for the item<br />
<strong>When</strong> she requests to save the item<br />
<strong>Then</strong> the list has the same items as stored previously<br />
<strong>And</strong> the list does not add an empty-named item<br />
&#8212;</p>
<p>In looking at them now, I feel that the actual <em>Add Item</em> feature is hidden in the <strong>Given</strong>s. A slight oversight now that we have progressed &#8211; perhaps one at the time as well, but we were delivering to features using TDD, so I have no qualms with features and implementations revisited and revised as the functionality of the application is fleshed out. In any event, I feel like these feature specs are more for a <em>Save Item</em> story, especially seeing as a User can edit an existing item. We&#8217;ll tackle the <em>Save Item</em> specifications for a later post, for now I want to revise the specifications for the <em>Add Item</em> feature.</p>
<h4>Tests</h4>
<p>The original story does not change, but we want to ensure that a <em>grocery-ls-item</em> model is returned on the API to create a new item from <em>list-controller </em>. With such a drastic refactor to the functionality of <em>list-controller</em>, I tend to do my thinking and designing within the tests and move to implementation &#8211; just as I have done previously with other components. Let&#8217;s take a look at the change to <em>newitem.spec.js</em> as a whole and then discuss the specs singularly:</p>
<p><em>/test/jasmine/spec/feature.newitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define(['jquery', 'script/controller/list-controller', 'script/controller/list-item-controller',
        'script/collection/collection', 'script/model/grocery-ls-item'],
        function($, listController, itemControllerFactory, collectionFactory, modelFactory) {

  describe('New item creation from listController.createNewItem()', function() {

    var newModel,
        newItemController,
        listControllerStub,
        $listView = $('&lt;ul/&gt;'),
        itemCollection = collectionFactory.create();

    beforeEach( function() {
      var $itemView = $('&lt;li&gt;');

      newModel = modelFactory.create();
      newItemController = itemControllerFactory.create($itemView, newModel);

      listControllerStub = sinon.stub(listController, 'createNewItem', function() {
        listController.getItemList().addItem(newModel);
        $itemView.appendTo($listView);
        return newModel;
      });
      listController.getItemList = sinon.stub().returns(itemCollection);
      listController.setView($listView);
    });

    it('should return newly created model', function() {
      var newItem = listController.createNewItem();
      // loosely (duck-ly) verifying grocery-ls-item type.
      expect(newItem).toEqual(jasmine.any(Object));
      expect(newItem.hasOwnProperty('name')).toBe(true);
      expect(newItem.hasOwnProperty('id')).toBe(true);
      expect(newItem.id).not.toBeUndefined();
    });

    it('should add newly created item to collection', function() {
      var newItem = listController.createNewItem(),
          itemList = listController.getItemList();
      expect(itemList.itemLength()).not.toBe(0);
      expect(itemList.getItemAt(itemList.itemLength()-1)).toEqual(newItem);
    });

    it('should add new item controller to view', function() {
      listController.createNewItem();
      expect($listView.children().length).toBe(1);
    });

    afterEach( function() {
      $listView.empty();
      newModel = undefined;
      newItemController = undefined;
      itemCollection.removeAll();
      listController.createNewItem.restore();
    });

  });

});
</pre>
<p>First off, you may notice that we are pulling in, as dependencies, every component we have basically created up to this point. Then, within the <em>beforeEach()</em> of the spec suite, using <a href="http://sinonjs.org/" target="_blank">SinonJS</a> we stub out the redesign and addition(s) to the API of <em>list-controller</em>; we are redefining the functionality of <em>createNewItem()</em> (which currently exists on <em>list-controller</em>) to return a <em>grocery-ls-item</em> instance and stubbing the <em>getItemList(</em>) method which will return the underlying collection model.</p>
<p>You may notice that i am using sinon.stub in two different ways:</p>
<pre class="brush: jscript; first-line: 19; title: ;" title="">
listControllerStub = sinon.stub(listController, 'createNewItem', function() {
</pre>
<pre class="brush: jscript; first-line: 24; title: ;" title="">
listController.getItemList = sinon.stub().returns(itemCollection);
</pre>
<p>The former allows for you to redefine the function invoked upon the public method &#8211; in this case &#8216;<em>createNewItem</em>&#8216;. In order to properly define a stub in such a manner without being shown errors in executing the tests, the method must already be available on the object you are stubbing. The latter allows you to stub a method that is not currently on the object. As you may notice, the instantiation of the two different stubs are different in their assignment on the object being stubbed. The operations within these stubs shouldn&#8217;t be taken as set in stone &#8211; they may change once we get to implementation in <em>list-controller</em> &#8211; but they setup our expectations that will be verified in the specifications. The first of which ensures the return of a <em>grocery-ls-item</em> through property assertions:</p>
<p><em>/test/jasmine/spec/feature/newitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 28; title: ;" title="">
it('should return newly created model', function() {
  var newItem = listController.createNewItem();
  // loosely (duck-ly) verifying grocery-ls-item type.
  expect(newItem).toEqual(jasmine.any(Object));
  expect(newItem.hasOwnProperty('name')).toBe(true);
  expect(newItem.hasOwnProperty('id')).toBe(true);
  expect(newItem.id).not.toBeUndefined();
});
</pre>
<p>The second spec tests that the newly created item is added to the collection exposed on list-controller:<br />
<em>/test/jasmine/spec/feature/newitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 37; title: ;" title="">
it('should add newly created item to collection', function() {
  var newItem = listController.createNewItem(),
      itemList = listController.getItemList();
  expect(itemList.itemLength()).not.toBe(0);
  expect(itemList.getItemAt(itemList.itemLength()-1)).toEqual(newItem);
});
</pre>
<p>And the third spec&#8230; well, it starts to address some of the expectations a User may have when using the <strong>Grocery List</strong> application, something we really haven&#8217;t tested for as of yet &#8211; you have to start somewhere, though, right? We are testing that in addition to a new model added to the collection, there is an associated view in the UI (or at least presumably):<br />
<em>/test/jasmine/spec/feature/newitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 44; title: ;" title="">
it('should add new item controller to view', function() {
  listController.createNewItem();
  expect($listView.children().length).toBe(1);
});
</pre>
<p>I think we will start to see more of these type of tests as we start fleshing out the features more. </p>
<p>Actually, I have started taking steps in moving the separation of <em>integration tests</em> from <em>feature tests</em>, if you haven&#8217;t already noticed the update to the location of <em>newitem.spec.js</em>. In my mind, the difference is between what I consider tests of how a component behaves itself (and with others) and test which describe the actual use of the application, respectively.</p>
<p>Run the tests just as you have before with the updates to the feature spec locations:<br />
<em>/test/jasmine/specrunner.html</em></p>
<pre class="brush: jscript; first-line: 34; highlight: [34]; title: ;" title="">
require( ['spec/feature/additem.spec.js', 'spec/feature/markitem.spec.js',
          'spec/item-controller.spec.js', 'spec/grocery-ls-item.spec.js',
          'spec/collection.spec.js'], function() {

  var jasmineEnv = jasmine.getEnv(),
       ...
  jasmineEnv.execute();

});
</pre>
<p>And all is green! <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<p>Tagged <strong>0.1.7</strong> &#8211; <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.7" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.7</a></p>
<h3>list-controller Revisted</h3>
<p>It&#8217;s great that the tests still pass, but we have yet to <strong>still</strong> modify <em>list-controller</em>. I can&#8217;t put it off any longer. If you have put up with the last couple posts and promises to get somewhere, you are very kind. The wait is over! &#8230; but it is also just the tip of the iceberg. sorry to be a downer <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<p>In looking at the API on <em>list-controller</em> we stubbed out from the <em>beforeEach()</em> of the <em>newitem.spec</em> and the expectations of its functionality verified in the specs, we are basically boiling down the responsibilities of the <em>list-controller</em> to:</p>
<ul>
<li>Create a new item</li>
<li>Add item views to a provided element</li>
<li>Manage and respond to changes on a collection of <em>grocery-ls-item</em></li>
</ul>
<p>As a start, we can include the new dependencies and refactor the <em>list-controller</em> component to support these requirements:<br />
<em>/script/controller/list-controller.js</em></p>
<pre class="brush: jscript; title: ;" title="">
define(['jquery', 'script/controller/list-item-controller', 'script/collection/collection', 'script/model/grocery-ls-item'],
        function($, itemControllerFactory, collectionFactory, modelFactory) {

  var collection = collectionFactory.create(),
      listController = {
        $view: undefined,
        getItemList: function() {
          return collection;
        },
        createNewItem: function() {
          var model = modelFactory.create();
          collection.addItem(model);
          return model;
        },
        setView: function(view) {
          this.$view = (view instanceof $) ? view : $(view);
        }
      };

  return listController;

});
</pre>
<p>Differing from the stub created for <em>createNewItem()</em> in the <em>newitem.spec</em>, the <em>list-controller</em> is only concerned with updating the collection model here. This is because the change to the collection will drive updates to the UI and we don&#8217;t want to have the UI operations within the <em>createNewItem()</em> method &#8211; that will basically create a doubling-up of efforts. It will be the responsibility of this module to observe changes to the collection and update state. That is done by adding an event handler to <em>collection-change</em> and operating accordingly based on event <em>kind</em>:</p>
<p><em>/script/controller/list-controller.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41]; title: ;" title="">
define(['jquery', 'script/controller/list-item-controller', 'script/collection/collection', 'script/model/grocery-ls-item'],
        function($, itemControllerFactory, collectionFactory, modelFactory) {

  var collection = collectionFactory.create(),
      listController = {
        $view: undefined,
        getItemList: function() {
          return collection;
        },
        createNewItem: function() {
          var model = modelFactory.create();
          collection.addItem(model);
          return model;
        },
        setView: function(view) {
          this.$view = (view instanceof $) ? view : $(view);
        }
      };

  (function assignCollectionHandlers($collection) {

    var EventKindEnum = collectionFactory.collectionEventKind;

    $collection.on('collection-change', function(event) {
      switch( event.kind ) {
        case EventKindEnum.ADD:
          var model = event.items.shift(),
              $itemView = $('&lt;li&gt;'),
              itemController = itemControllerFactory.create($itemView, model);

          $itemView.appendTo(listController.$view);
          itemController.state = itemControllerFactory.state.EDITABLE;
          break;
        case EventKindEnum.REMOVE:
          break;
        case EventKindEnum.RESET:
          break;
      }
    });

  }($(collection)));

  return listController;

});
</pre>
<p>We are calling an <strong><a href="http://benalman.com/news/2010/11/immediately-invoked-function-expression/" target="_blank">IIFE</a></strong> with the <a href="http://jquery.org" target="_blank">jQuery</a> wrapped collection object and assigning an event handler to <em>collection-change</em> on the collection. Depending on the kind of <em>collection-change</em> event that has occurred, defined clauses with specified operations are entered &#8211; for the purposes of the current task and tests at hand, that is only the <em>ADD</em> event.</p>
<p>In the <em>EventKindEnum.ADD</em> switch..case you will see the UI modification, with the addition of the list item view and the editability state of its associated <em>list-item-controller</em> set to allow the User to edit the new item.</p>
<p>Now, with the implementation of the <em>Add Item</em> feature moved to <em>list-controller</em>, we can clean up our <em>newitem.spec.js</em>:<br />
<em>/test/jasmine/spec/feature/newitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [1,2,6,9,34]; title: ;" title="">
define(['jquery', 'script/controller/list-controller'],
        function($, listController) {

  describe('New item creation from listController.createNewItem()', function() {

    var $listView = $('&lt;ul/&gt;');

    beforeEach( function() {
      listController.setView($listView);
    });

    it('should return newly created model', function() {
      var newItem = listController.createNewItem();
      // loosely (duck-ly) verifying grocery-ls-item type.
      expect(newItem).toEqual(jasmine.any(Object));
      expect(newItem.hasOwnProperty('name')).toBe(true);
      expect(newItem.hasOwnProperty('id')).toBe(true);
      expect(newItem.id).not.toBeUndefined();
    });

    it('should add newly created item to collection', function() {
      var newItem = listController.createNewItem(),
          itemList = listController.getItemList();
      expect(itemList.itemLength()).not.toBe(0);
      expect(itemList.getItemAt(itemList.itemLength()-1)).toEqual(newItem);
    });

    it('should add new item controller to view', function() {
      listController.createNewItem();
      expect($listView.children().length).toBe(1);
    });

    afterEach( function() {
      $listView.empty();
    });

  });

});
</pre>
<p>And we&#8217;ll modify the main application module to reflect the change to the <em>list-controller</em> now only governing over a list DOM element and not to manage events from the add button on the DOM:</p>
<p><em>/script/grocery-ls.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [12,13,14,15,16,17,18,19,20]; title: ;" title="">
(function(window, require) {

  require.config({
    baseUrl: &quot;.&quot;,
    paths: {
      &quot;lib&quot;: &quot;./lib&quot;,
      &quot;script&quot;: &quot;./script&quot;,
      &quot;jquery&quot;: &quot;./lib/jquery-1.8.3.min&quot;
    }
  });

  require( ['jquery', 'script/controller/list-controller', 'script/collection/collection'],
            function($, listController, collectionFactory) {

    listController.setView($('section.groceries ul'));
    $('section.groceries #add-item-button').on('click', function(event) {
      listController.createNewItem();
    });

  });

}(window, requirejs));
</pre>
<p>Run the tests&#8230; and it will fail! Yay!<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_v_3.png" alt="Failing tests on list-controller refactor" /></p>
<p><em>wait, what?!</em></p>
<p>Actually, most will pass &#8211; including the <em>newitem.spec</em> tests. It is the <em>markitem.spec</em> tests that will fail. We have modified the <em>list-controller</em> to accomodate the changes to the <em>Add Item</em> feature, but have not addressed the <em>Mark Off Item</em> feature in our refactoring.</p>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_v_4.png" alt="Mark-Off Item failure on list-controller refactor" /></p>
<p>However, run the application and it will be just as usable as it was before &#8211; no change will be perceived by the end-user. The only thing that will change is now I have a <span style="color: red;">nagging feeling knowing my tests are failing</span>. Some naysayers may interject here and half-heartedly tell me to get rid of the tests, then. To them I say, &#8216;<em>pfffft</em>&#8216; <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  </p>
<p>I hate to see the tests in such a state, but this post is rather long as it is. Also, I like to joke that sometimes having failing tests to look at first thing in the morning is the best way to pick up from where you left off. I promise we&#8217;ll get these to go green in the next article of this series, and invite you to get them to pass if you are for it.</p>
<p>Tagged <strong>0.1.8</strong> &#8211; <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.8" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.8</a></p>
<h2>Conclusion</h2>
<p>We finally got around to refactoring the <em>list-controller</em> to relieve it of item model management and state. In the course of doing so, we created a <em>Collection</em> object that will serve as the model for the <em>list-controller</em>. </p>
<p>This post was a lengthy one, and I appreciate you sticking through my yackity-yack. I think we are in fine shape now to approach previously defined and new features, get our tests passing again, and finalize the <strong>Grocery List</strong> application&#8230; in as far as first iteration deliverables go <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<p>&#8216;Til next time&#8230;</p>
<p>&#8212;</p>
<h1>Link Dump</h1>
<h2>Reference</h2>
<p><a href="http://tddjs.com/" target="_blank">Test-Driven JavaScript Development by Christian Johansen</a><br />
<a href="http://dannorth.net/introducing-bdd/" target="_blank">Introducing BDD by Dan North</a><br />
<a href="http://requirejs.org/" target="_blank">RequireJS</a><br />
<a href="https://github.com/amdjs/amdjs-api/wiki/AMD" target="_blank">AMD</a><br />
<a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a><br />
<a href="http://sinonjs.org/" target="_blank">Sinon</a><br />
<a href="https://github.com/derickbailey/jasmine.async" target="_blank">Jasmine.Async</a></p>
<h2>Post Series</h2>
<p><a href="https://github.com/bustardcelly/grocery-ls">grocery-ls github repo</a><br />
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i" target="_blank">Part I &#8211; Introduction</a><br />
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii">Part II &#8211; Feature: Add Item</a><br />
<a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii">Part III &#8211; Feature: Mark-Off Item</a><br />
<a href="http://custardbelly.com/blog/2012/12/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-iv">Part IV &#8211; Feature: List-Item-Controller</a><br />
<a href="http://custardbelly.com/blog/2012/12/31/the-making-of-a-test-driven-grocery-list-application-in-js-part-v/">Part V &#8211; Feature: List-Controller Refactoring</a><br />
<a href="http://custardbelly.com/blog/2013/01/08/the-making-of-a-test-driven-grocery-list-application-in-js-part-vi/" target="_blank">Part VI &#8211; Back to Passing</a><br />
<a href="http://custardbelly.com/blog/2013/01/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-vii/">Part VII &#8211; Remove Item</a><br />
<a href="http://custardbelly.com/blog/2013/01/22/the-making-of-a-test-driven-grocery-list-application-part-viii/">Part VIII &#8211; Bug Fixing</a><br />
<a href="http://custardbelly.com/blog/2013/02/15/the-making-of-a-test-driven-grocery-list-application-in-js-part-ix/">Part IX &#8211; Persistence</a><br />
<a href="http://custardbelly.com/blog/2013/03/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-x/">Part X &#8211; It Lives!</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/amd/" title="View all posts in AMD" rel="category tag">AMD</a>,  <a href="http://custardbelly.com/blog/category/javascript/" title="View all posts in JavaScript" rel="category tag">JavaScript</a>,  <a href="http://custardbelly.com/blog/category/requirejs/" title="View all posts in RequireJS" rel="category tag">RequireJS</a>,  <a href="http://custardbelly.com/blog/category/grocery-ls/" title="View all posts in grocery-ls" rel="category tag">grocery-ls</a>,  <a href="http://custardbelly.com/blog/category/jasmine/" title="View all posts in jasmine" rel="category tag">jasmine</a>,  <a href="http://custardbelly.com/blog/category/unit-testing/" title="View all posts in unit-testing" rel="category tag">unit-testing</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2012/12/31/the-making-of-a-test-driven-grocery-list-application-in-js-part-v/#comments" rev="post-686"  title="Comment on The Making of a Test-Driven Grocery List Application in JS: Part V">1 comment</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2012-12-31T16:13">December 31, 2012</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-686-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-655" class="post-655 post hentry category-amd category-javascript category-requirejs category-grocery-ls category-jasmine category-unit-testing full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2012/12/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-iv/" title="Permanent link to The Making of a Test-Driven Grocery List Application in JS: Part IV" rel="bookmark" rev="post-655">The Making of a Test-Driven Grocery List Application in JS: Part IV</a></h1>
	
	<div class="entry-content full-content">
		<p><em>This is the fourth installment in a series of building a Test-Driven Grocery List application using <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> and <a href="http://requirejs.org" target="_blank">RequireJS</a>. To learn more about the intent and general concept of the series please visit <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i/">The Making of a Test-Driven Grocery List Application in JavaScript: Part I</a></em><br />
&#8212;</p>
<h1>Introduction</h1>
<p>In the <a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii/" target="_blank">previous</a> article we developed a new feature for the <strong>Grocery List</strong> application: <em>Mark Off Item</em>. In the process of doing so, or at least when we went from the tests to implementation, we added more responsibility to the <em>list-controller</em> as it pertained to individual view and model items.</p>
<p>In this article, we are going to refactor out that responsibility into its own <em>list-item-controller</em> that will be responsible for managing the relationship of a list item view to a single <em>grocery-ls-item</em> model.</p>
<h2>Refactoring</h2>
<p>As it stands , I think the design of the <em>list-controller</em> is fine: exposing an API to modify the list. It&#8217;s the internals that are starting to bug me. If the current behaviour and responsibilities were all that was needed, I suppose we could walk away and feel confident about our application as is. However, in forward thinking other operations that could involve list items &#8211; such as deletion &#8211; I feel the responsibilities of the <em>list-controller</em> will quickly outgrow its intent. </p>
<p>I suppose, some would argue, that if the responsibilities of the list-controller grow to more operations that are tightly coupled with singular pieces of data, then we could just write more tests to verify its soundness. Not entirely a bad argument &#8211; i mean that is what we are trying to justify in this series, essentially. But it is not a 1:1 correlation of more tests to better design. It is preferred to separate concerns as much as possible in order to properly test. The maintenance of complex tests can be a bigger burden than the maintenance of complex code &#8211; so much so that testing stops all together.</p>
<h3>list-item-controller</h3>
<p>Before we dive in to creating a <em>list-item-controller</em>, let&#8217;s take a look at what concerns within <em>list-controller</em> we want to move out. Looking from the <a href="https://github.com/bustardcelly/grocery-ls/blob/0.1.3/script/controller/list-controller.js" target="_blank">0.1.3 tagged list-controller</a>, we mainly want to cut out the item view creation &#8211; so the following node declarations and any associated item creation and item management:</p>
<p><em>/script/controller/list-controller.js tagged at 0.1.3</em></p>
<pre class="brush: jscript; first-line: 6; title: ;" title="">
itemFragment          = '&lt;li class=&quot;grocery-item&quot; /&gt;',
editableItemFragment  = '&lt;li class=&quot;editable-grocery-item&quot;&gt;' +
                                           '&lt;input id=&quot;editableItem&quot; name=&quot;editableItem&quot; ' +
                                               'class=&quot;editable-item&quot; placeholder=&quot;Enter item name...&quot;&gt;' +
                                          '&lt;/input&gt;' +
                                        '&lt;/li&gt;'
</pre>
<p>These declarations and management of view will be moved to the <em>list-item-controller</em>. The UI and usability of a list item will be driven by the model and should provide an API that is a level of abstraction from the model for any outside parties (ie, the <em>list-controller</em>). As well, the model drives the internal state of edit-ability and marked-off-ed-ness (<em>they&#8217;re words, alright</em>!), and the <em>list-item-controller</em> will dispatch events related to its change of state. Lofty goals, but let&#8217;s see if we can&#8217;t address them.</p>
<h4>a bit of uncertainty</h4>
<p>We currently created specs for <em>Add Item</em> and <em>Mark Off Item</em> features. These were a little high-level in that they described features using the BDD syntax of <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> but did involve tests around how to interact with the <em>list-controller</em> API; so they do involve integration to some respect &#8211; we kind of ignore the whole UI and User Interaction aspect within the tests. </p>
<p>Now here is where I have an internal struggle with writing specs: should the tests we need for the <em>list-item-controller</em> be added to these specs? Or should a new spec focused on <em>list-item-controller</em> API and usability be born? I ask, because from outside-looking-in, the creation, editability and mark-off of an item will still be feasible through the <em>list-controller</em> and to any other third parties &#8211; that API provides a facade to modifying a grocery list. So, the current specs we have serve as a nice example of how to interact with the application from the outside&#8230; and if they are passing, we know that from higher-level things <em>should</em>* work <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  </p>
<p>When we get down to the implementation of the <em>list-item-controller</em>, from a design perspective we know that a dependency will be introduced: <em>list-controller</em> will have n-number of <em>list-item-controller</em> instances, and will be responsible for the creation and maintenance of each <em>list-item-controller</em>. The state and <em>grocery-ls-item</em> model maintenance which we established in the previous articles as the responsibility of the <em>list-controller</em> will, as well, become the responsibility of the <em>list-item-controller</em>.</p>
<p>Knowing this, I start to feel that this is closer to testing the implementation and behaviour of a component, rather then one of the &#8217;system&#8217;, and would push for its own spec. But I am very much open to ideas, so please leave a comment.</p>
<h3>list-item-controller design</h3>
<p>In my <em>bit of uncertainty</em>, I basically described the design of the <em>list-item-controller</em>. Now, we&#8217;ll flesh out its behaviour and API in a spec and eventually move it to its own AMD implementation. To start out slowly we&#8217;ll create a new spec suite and define the <em>list-item-controller</em> attributes:</p>
<p><em>/test/jasmine/spec/list-item-controller.spec.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define(['jquery', 'script/model/grocery-ls-item'], function($, modelFactory) {

  describe('list-item-controller', function() {

    function createStateEvent(oldState, newState) {
        var event = new $.Event('state-change');
        event.oldState = oldState;
        event.newState = newState;
        return event;
    }

    var itemControllerFactory = {
        create: function(node, model) {
          var itemController = Object.create(Object.prototype);

          (function(controller, stateEventCreator) {
            var _state = 'normal';
            Object.defineProperties(controller, {
              &quot;model&quot;: {
                value: model,
                writable: false,
                enumerable: true
              },
              &quot;parentView&quot;: {
                value: node,
                writable: false,
                enumerable: true
              },
              &quot;state&quot;: {
                set: function(value) {
                  var event = stateEventCreator.call(this, this.state, value);
                  _state = value;
                  $(this).trigger(event);
                },
                get: function() {
                  return _state;
                }
              }
            });
          }(itemController, createStateEvent));

          return itemController;
        }
      };
  });
});
</pre>
<p>The object declared &#8211; <em>itemControllerFactory</em> &#8211; is a factory instance that will generate new instances of a <em>list-item-controller</em>. The factory pattern should be familiar to you if you look at the <em>grocery-ls-item</em> AMD we created in the second article in the series. When creating an instance of a <em>list-item-controller</em>, we have defined that a parent DOM node and a model should be passed in during creation, as can be seen in <em>itemControllerFactory:create()</em>. If we look at the <em>defineProperties</em>, we have also defined a few characteristics of the <em>list-item-controller</em> here. It has:</p>
<ul>
<li>Parent Node reference &#8211; DOM instance of which to modify view state.</li>
<li>Model reference &#8211; Model of which the View is driven by.</li>
<li>State &#8211; State of View within the DOM representing the Model.</li>
</ul>
<p>We have designed the <em>state</em> property a little differently than you may have seen before, at least in this series. We declared the implicit getter/setters so as to keep track of state internally and dispatch an event of <em>&#8217;state-change&#8217;</em>. By &#8216;<em>internally</em>&#8216;, I mean I used an <a href="http://benalman.com/news/2010/11/immediately-invoked-function-expression/" target="_blank">IIFE</a> to enclose a &#8216;<em>private</em>&#8216; member storing state.</p>
<p>If you know of event-driven design &#8211; whether or not you are familiar with <a href="http://api.jquery.com/category/Events/?rdfrom=http%3A%2F%2Fdocs.jquery.com%2Fmw%2Findex.php%3Ftitle%3DAPI%2F1.3%2FEvents%26redirect%3Dno" target="_blank">jQuery Events</a>, which the <em>state</em> property employs &#8211; then this will look familiar. Essentially, we want to allow any client who wants to know about the change of state to a <em>list-item-controller</em> instance to be notified through an event of <em>&#8217;state-change&#8217;</em>. This will become more apparent later on in development, but just keep in mind that it is the responsibility of the <em>list-controller</em> to maintain n-number of <em>list-item-controller</em>s; and part of that maintenance is being aware of each <em>list-item-controller</em>&#8217;s state &#8211; and since binding is not inherently available in JavaScript, and I don&#8217;t want to introduce any new libraries that could handle binding, listening on events is an easy way to go about tracking state. <em>You feel adventurous enough, we can build a binding mechanism on top of this event system&#8230; just make sure it&#8217;s got tests <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </em></p>
<h2>Tests</h2>
<p>Before we begin creating the tests for the <em>list-item-controller</em>, you may be wondering where the feature stories and scenarios are. We could definitely define those, however &#8211; and of course, I can always be wrong &#8211; I feel those are more business-facing&#8230; well, stories at least. They are used to define some type of behaviour that is accepted as part of the software, with scenarios describing the various outcomes of a behaviour. Still valid for the case in hand of integrating the <em>list-item-controller</em>, but I tend to think this closer to testing on the implementation of behaviour. It&#8217;s a gray area to me, as well, if this all sounds confusing &#8211; I invite someone to step in and either clarify my understanding to set me straight. </p>
<p>Basically, our goal here is to verify the design and implementation of <em>list-item-controller</em>. If done properly this will pass, as well as the specs for the <em>Add Item</em> and <em>Mark Off Item</em> features we created in <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii/" target="_blank">previous</a> <a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii/" target="_blank">articles</a>.</p>
<p>That said, let&#8217;s flesh out some tests that verify:</p>
<ol>
<li>Factory generates unique instances of list-item-controller</li>
<li>Model is preserved and immutable on list-item-controller</li>
<li>State is mutable through implicit getter/setters</li>
<li>Change to state is dispatched</li>
</ol>
<p><em>/test/jasmine/spec/list-item-controller.spec.js</em></p>
<pre class="brush: jscript; first-line: 45; title: ;" title="">
describe('Grocery list-item-controller', function() {

  var model,
      newController,
      async = new AsyncSpec(this);

  beforeEach( function() {
    model = modelFactory.create();
    newController = itemControllerFactory.create(parentNode, model);
  });

  describe('list-item-controller factory creation', function() {

    it('should return a new instance of list-item-controller', function() {
      expect(newController).not.toBeUndefined();
    });

    it('should return unique instances of list-item-controllers', function() {
      var nextController = itemControllerFactory.create(parentNode, model);
      nextController.state = 'testing';
      expect(nextController).not.toBe(newController);
      expect(nextController.state).not.toBe(newController.state);
    });

  });

  describe('new list-item-controller instance', function() {

    it('should expose model provided in creation', function() {
      expect(newController.model).not.toBeUndefined();
      expect(newController.model).toBe(model);
    });

    it('should expose non-writable model', function() {
      var newModel = modelFactory.create();
      newController.model = newModel;
      expect(newController.model).not.toBe(newModel);
      expect(newController.model).toBe(model);
    });

  describe('list-item-controller notifies on state-change', function() {

    async.it('should provide old and new state values on state-change', function(done) {
      var previousState = newController.state,
          newState = 'editable';

      $(newController).on('state-change', function(event) {
        $(newController).off('state-change');

        expect(event.oldState).toBe(previousState);
        expect(event.newState).toBe(newState);
        expect(newController.state).toBe(newState);
        done();
      });
      newController.state = newState;
    });

  });

  });

  afterEach( function() {
    model = undefined;
    newController = undefined;
  });

});
</pre>
<p>The last spec declared, as you may notice, runs asynchronously in order to test the state notification:</p>
<pre class="brush: jscript; title: ;" title="">
async.it('should provide old and new state values on state-change', function(done) {
</pre>
<p> The <em>AsyncSpec</em> object comes from the <a href="https://github.com/derickbailey/jasmine.async" target="_blank">jasmine.async library</a> we&#8217;ve previously included in the specrunner page. By invoking the spec (<em>it()</em>) through an instance of <em>AsyncSpec</em>, the spec is suspended until either it fails or the <em>done</em> delegate method is invoked. Since notification of state change is event-based, we use it in the spec to verify that the <em>list-item-controller</em> does dispatch that event.</p>
<p>Add that spec to the list:<br />
<em>/test/jasmine/specrunner.html</em></p>
<pre class="brush: jscript; first-line: 34; highlight: [34]; title: ;" title="">
require( ['spec/newitem.spec.js', 'spec/markitem.spec.js', 'spec/list-item-controller.spec.js'], function() {

  var jasmineEnv = jasmine.getEnv(),
     ...
  jasmineEnv.execute();

});
</pre>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_iv_1.png" alt="passing list-item-controller spec" /></p>
<h2>list-item-controller implementation</h2>
<p>We&#8217;ve verified our design for the <em>list-item-controller</em> with passing tests, but we have yet to incorporate it into our system and offload the responsibilities (addressed earlier in this article) from the <em>list-controller</em> to it. Before we get there, however, let&#8217;s move the implementation of the <em>list-item-controller</em> (and the factory) out into its own AMD module. To start we&#8217;ll just move the <em>itemControllerFactory</em> declaration into a new file:</p>
<p><em>/script/controller/list-item-controller.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define(['jquery'], function($) {

  function createStateEvent(oldState, newState) {
    var event = new $.Event('state-change');
    event.oldState = oldState;
    event.newState = newState;
    return event;
  }

  return {
    create: function(node, model) {
      var itemController = Object.create(Object.prototype);

      (function(controller, stateEventCreator) {
        var _state;
        Object.defineProperties(controller, {
          &quot;model&quot;: {
            value: model,
            writable: false,
            enumerable: true
          },
          &quot;parentView&quot;: {
            value: node,
            writable: false,
            enumerable: true
          },
          &quot;state&quot;: {
            set: function(value) {
              var event = stateEventCreator.call(this, this.state, value);
              _state = value;
              $(this).trigger(event);
            },
            get: function() {
              return _state;
            }
          }
        });
      }(itemController, createStateEvent));

      return itemController.init();
    }
  };

});
</pre>
<p>With that in place, we could modify the <em>list-item-controller.spec.js</em> file to include the <em>list-item-controller</em> dependency for testing:</p>
<p><em>/test/jasmine/spec/list-item-controller.spec.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [1,2,3]; title: ;" title="">
define(['jquery', 'script/model/grocery-ls-item', 'script/controller/list-item-controller'],
          function($, modelFactory, itemControllerFactory) {
  // moved to script/controller/list-item-controller.js

  describe('Grocery list-item-controller', function() {
    ...
  });
});
</pre>
<p>And our tests still pass! But&#8230; we want to move all the view and item management out of <em>list-controller</em> and have that handled by a <em>list-item-controller</em>. So let&#8217;s transfer over those view fragments and flesh out the <em>list-item-controller</em> object that is generated from the factory:</p>
<p><em>/script/controller/list-item-controller.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,34,36,64]; title: ;" title="">
define(['jquery'], function($) {

  function createStateEvent(oldState, newState) {
    var event = new $.Event('state-change');
    event.oldState = oldState;
    event.newState = newState;
    return event;
  }

   var stateEnum = {
        UNEDITABLE: 0,
        EDITABLE: 1
      },
      uneditableItemFragment  = '&lt;p class=&quot;grocery-item&quot; /&gt;',
      editableItemFragment    = '&lt;p class=&quot;editable-grocery-item&quot;&gt;' +
                                                  '&lt;input name=&quot;editableItem&quot; ' +
                                                      'class=&quot;editable-item&quot; placeholder=&quot;Enter item name...&quot;&gt;' +
                                                  '&lt;/input&gt;' +
                                               '&lt;/p&gt;',
      listItemController = {
        $editableView: undefined,
        $uneditableView: undefined,
        init: function() {
          this.$editableView = $(editableItemFragment);
          this.$uneditableView = $(uneditableItemFragment);

          // default to undeditable state.
          this.state = stateEnum.UNEDITABLE;
          return this;
        }
      };

  return {
    state: stateEnum,
    create: function(node, model) {
      var itemController = Object.create(listItemController);

      (function(controller, stateEventCreator) {
        var _state = 'normal';
        Object.defineProperties(controller, {
          &quot;model&quot;: {
            value: model,
            writable: false,
            enumerable: true
          },
          &quot;parentView&quot;: {
            value: node,
            writable: false,
            enumerable: true
          },
          &quot;state&quot;: {
            set: function(value) {
              var event = stateEventCreator.call(this, this.state, value);
              _state = value;
              $(this).trigger(event);
            },
            get: function() {
              return _state;
            }
          }
        });
      }(itemController, createStateEvent));

      return itemController.init();
    }
  };

});
</pre>
<p>The <em>init()</em> method of a new <em>list-item-controller</em> is invoked upon creation and return in order to define the view references and default state. The fragment declarations have changed slightly as well &#8211; the list item wrappers have been removed. Basically, even though the name suggest that the view will reside in a list, we don&#8217;t want to tie the idea that they need to be <em>li</em> DOM elements since they also have no concept of what type of DOM element the <em>parentView</em> is.</p>
<p>As it stands with <a href="https://github.com/bustardcelly/grocery-ls/blob/0.1.3" target="_blank">our current work from the previous article</a>, the <em>list-controller</em> was responsible for listening on UI events of a list item &#8211; such as <em>&#8216;blur&#8217;</em> on input and <em>&#8216;click&#8217;</em>. It is the intent to relive the <em>list-controller</em> of such responsibility so we&#8217;ll transfer that over, as well:</p>
<p><em>/script/controller/list-item-controller.js</em></p>
<pre class="brush: jscript; first-line: 20; highlight: [27,28,29,30,31,32,33,34,35,36,37,38,39]; title: ;" title="">
listItemController = {
  $editableView: undefined,
  $uneditableView: undefined,
  init: function() {
    this.$editableView = $(editableItemFragment);
    this.$uneditableView = $(uneditableItemFragment);

    // view handlers.
    this.$uneditableView.on('click', (function(controller) {
      return function(event) {
        var toggled = controller.$uneditableView.css('text-decoration') === 'line-through';
        controller.model.marked = !toggled;
      };
    }(this)));
    $('input', this.$editableView).on('blur', (function(controller) {
      return function(event) {
        controller.model.name = $(this).val();
        controller.state = stateEnum.UNEDITABLE;
      };
    }(this)));

    // default to undeditable state.
    this.state = stateEnum.UNEDITABLE;
    return this;
  }
};
</pre>
<p>Again, we are using an <strong>IIFE</strong>, and in this case to pass in a reference to the controller instance. I could have easily defined a new variable like</p>
<pre class="brush: jscript; title: ;" title="">
var self = this;
</pre>
<p>but that always makes me cry a little inside. Anyway, so we are listening on click of the uneditable view item in order to update value of the <em>marked</em> property on the model and we have assigned a <em>blur</em> handler on the input of the editable view item that updates the value of the <em>name</em> property of the model and flips the state. Now we have to respond to those changes <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<p><em>/script/controller/list-item-controller.js</em></p>
<pre class="brush: jscript; first-line: 23; highlight: [41,42,43,44,45,46,47,48,49,50]; title: ;" title="">
init: function() {
  this.$editableView = $(editableItemFragment);
  this.$uneditableView = $(uneditableItemFragment);

  // view handlers.
  this.$uneditableView.on('click', (function(controller) {
    return function(event) {
      var toggled = controller.$uneditableView.css('text-decoration') === 'line-through';
      controller.model.marked = !toggled;
    };
  }(this)));
  $('input', this.$editableView).on('blur', (function(controller) {
    return function(event) {
      controller.model.name = $(this).val();
      controller.state = stateEnum.UNEDITABLE;
    };
  }(this)));
  // state &amp; model handlers.
  $(this).on('state-change',  (function(controller) {
    return function(event) {
      handleStateChange.call(null, controller, event);
    };
  }(this)));
  $(this.model).on('property-change', (function(controller) {
    return function(event) {
      handlePropertyChange.call(null, controller, event);
    };
  }(this)));
  // default to undeditable state.
  this.state = stateEnum.UNEDITABLE;
  return this;
}
</pre>
<p>The <em>handleStateChange</em> delegate is responsible for updating the view based on a change to state: either <em>EDITABLE</em> or <em>UNEDITABLE</em> from the <em>stateEnum</em> object:</p>
<pre class="brush: jscript; title: ;" title="">
function handleStateChange(controller, event) {
  // remove state-based item.
  if( typeof event.oldState !== 'undefined') {
    if(event.oldState === stateEnum.UNEDITABLE) {
      controller.$uneditableView.detach();
    }
    else if(event.oldState === stateEnum.EDITABLE) {
      controller.$editableView.detach();
    }
  }
  // append state-based item.
  if(event.newState === stateEnum.UNEDITABLE) {
    controller.parentView.append(controller.$uneditableView);
  }
  else if(event.newState === stateEnum.EDITABLE) {
    var inputTimeout = setTimeout( function()  {
      clearTimeout(inputTimeout);
      $('input', controller.$editableView).focus();
    }, 100);
    controller.parentView.append(controller.$editableView);
  }
}
</pre>
<p>The <em>handlePropertyChange</em> delegate is responsible for updating the views based on the <em>model</em> property values:</p>
<pre class="brush: jscript; title: ;" title="">
function handlePropertyChange(controller, event) {
  if(event.property === &quot;name&quot;) {
    // update view based on model change.
    $('input', controller.$editableView).val(controller.model.name);
    controller.$uneditableView.text(event.newValue);
  }
  else if(event.property === &quot;marked&quot;) {
    // update view based on model change.
    controller.$uneditableView.css('text-decoration', (event.newValue) ? 'line-through' : 'none');
  }
}
</pre>
<p>That pretty much shores up the implementation for the <em>list-item-controller</em> taking on the responsibilities of view creation and management based on state and model updates. But running the tests from this point will fail. The reason being a change to design on the model.</p>
<h2>grocery-ls-item Modification</h2>
<p>One particular change to design introduced in the implementation for <em>list-item-controller</em> is response to <em>&#8216;property-change&#8217;</em> event from the model. In our work up to this point, the <em>grocery-ls-item</em> is a basic object; we&#8217;ll use the same paradigm that we implemented for notification of state for the <em>grocery-ls-item</em> in order to respond to changes on model properties. Although a simple change, we need to first test our design before modifying the code for the <em>grocery-ls-item</em>. Lets create a new spec file for our model:</p>
<p><em>/test/jasmine/spec/grocery-ls-item.spec.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define(['jquery', 'script/model/grocery-ls-item'], function($, modelFactory) {

  describe('Grocery grocery-ls-item model', function() {

    var model,
        name = 'grapes',
        async = new AsyncSpec(this);

    beforeEach( function() {
      model = modelFactory.create();
      model.name = name;
      model.marked = false;
    });

    describe('grocery-ls-item factory model creation', function() {

      it('should generate unique instances of model', function() {
        var newModel = modelFactory.create();
        expect(model).not.toBeUndefined();
        expect(newModel).not.toBeUndefined();
        expect(model).not.toBe(newModel);
      });

      async.it('should auto generate unique ids on models', function(done) {
        var newModel,
            creationTimeout;

        // Offload creation because ids are generated based on time.
        // This allows for timestamp to progess.
        creationTimeout = setTimeout(function() {
          clearTimeout(creationTimeout);
          newModel = modelFactory.create();
          expect(model.id).not.toBeUndefined();
          expect(typeof model.id).toBe('number');
          expect(model.id).not.toEqual(newModel.id);
          done();
        }, 100);
      });

    });

    describe('grocery-ls-item properties', function() {

      it('should contain an immutable id property, created at instantiation', function() {
        var newID = 1234567;
        model.id = newID;

        expect(model.id).not.toEqual(newID);
      });

    });

    describe('grocery-ls-item property change notification', function() {

      async.it('should notify with \'property-change\' upon change to name property', function(done) {
        var oldName = model.name,
            newName = 'apples';
        $(model).on('property-change', function(event) {
          expect(event.property).toEqual('name');
          expect(event.oldValue).toEqual(oldName);
          expect(event.newValue).toEqual(newName);
          $(model).off('property-change');
          done();
        });
        model.name = newName;
      });

      async.it('should notify with \'property-change\' upon change to marked property', function(done) {
        var oldValue = model.marked,
            newValue = true;
        $(model).on('property-change', function(event) {
          expect(event.property).toEqual('marked');
          expect(event.oldValue).toEqual(oldValue);
          expect(event.newValue).toEqual(newValue);
          $(model).off('property-change');
          done();
        });
        model.marked = newValue;
      });

    });

    afterEach( function() {
      model = undefined;
    });

  });

});
</pre>
<p>We have a few suites there to verify:</p>
<ol>
<li>Model generation from factory produces unique items</li>
<li>Model property immutability for auto-assigned IDs</li>
<li>Event notification on property change</li>
</ol>
<p>We add that to our spec runner:</p>
<pre class="brush: jscript; first-line: 34; highlight: [34,35]; title: ;" title="">
require( ['spec/newitem.spec.js', 'spec/markitem.spec.js',
          'spec/item-controller.spec.js', 'spec/grocery-ls-item.spec.js'], function() {

  var jasmineEnv = jasmine.getEnv(),
     ...
  jasmineEnv.execute();

});
</pre>
<p>&#8230; and it fails. Whoopee! It&#8217;s supposed to. Now we just take the knowledge we know of wiring up event notification on state of the <em>list-item-controller</em>, and apply it to <em>property-change</em> on the model:</p>
<p><em>/script/model/grocery-ls-item.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42]; title: ;" title="">
define(['jquery'], function($) {

  var propertyEvent = {
      create: function(property, oldValue, newValue) {
        var event = $.Event('property-change');
        event.property = property;
        event.oldValue = oldValue;
        event.newValue = newValue;
        return event;
      }
    },
    properties = function(id) {
      return {
        &quot;id&quot;: {
          value: id,
          writable: false,
          enumerable: true
        },
        &quot;name&quot;: {
          enumerable: true,
          set: function(value) {
            var oldValue = this._name;
            this._name = value;
            $(this).trigger(propertyEvent.create('name', oldValue, value));
          },
          get: function() {
            return this._name;
          }
        },
        &quot;marked&quot;: {
          enumerable: true,
          set: function(value) {
            var oldValue = this._marked;
            this._marked = value;
            $(this).trigger(propertyEvent.create('marked', oldValue, value));
          },
          get: function() {
            return this._marked;
          }
        }
      };
    };

  return {
    create: function() {
      return Object.create(Object.prototype, properties(new Date().getTime()));
    }
  };

});
</pre>
<p>The modification to <em>grocery-ls-item</em> was perhaps our first introduction to writing failing tests due to a change in design prior to actually modifying the implementation. That feeling you&#8217;re feeling right now&#8230; that&#8217;s what makes this all worth it <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_wink.gif' alt=';)' class='wp-smiley' /> </p>
<p>Anyway&#8230; hold on to that feeling until the next post, because we are not done and it will go away quickly&#8230; just kidding <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<p><strong>Tagged</strong>: 0.1.5 <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.5">https://github.com/bustardcelly/grocery-ls/tree/0.1.5</a></p>
<h2>Blinders</h2>
<p>If you were to run the tests again&#8230; they still pass!<br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_iv_2.png" alt="passing grocery-ls-item spec" /></p>
<p>That is because we have not changed <em>list-controller</em> at all <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  </p>
<p>Our <em>list-item-controller.spec.js</em> is happily oblivious to our recent additions and modifications, and the tests we wrote previously for the <em>Add Item</em> and <em>Mark Off Item</em> features still pass. </p>
<p>Before we just start chopping out and inserting code from <em>list-controller</em>, I want to go over the API and specs currently defined and see if they still hold water &#8211; meaning we might be able to cut some tests out. We might not. We might even add more&#8230; That&#8217;s what i plan to address in the next article of this series.</p>
<p>&#8212;</p>
<h1>Link Dump</h1>
<h2>Reference</h2>
<p><a href="http://tddjs.com/" target="_blank">Test-Driven JavaScript Development by Christian Johansen</a><br />
<a href="http://dannorth.net/introducing-bdd/" target="_blank">Introducing BDD by Dan North</a><br />
<a href="http://benalman.com/news/2010/11/immediately-invoked-function-expression/">Immediately-Invoked Function Expression (IIFE) by Ben Alman</a><br />
<a href="http://requirejs.org/" target="_blank">RequireJS</a><br />
<a href="https://github.com/amdjs/amdjs-api/wiki/AMD" target="_blank">AMD</a><br />
<a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a><br />
<a href="http://sinonjs.org/" target="_blank">Sinon</a><br />
<a href="https://github.com/derickbailey/jasmine.async" target="_blank">Jasmine.Async</a></p>
<h2>Post Series</h2>
<p><a href="https://github.com/bustardcelly/grocery-ls">grocery-ls github repo</a><br />
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i" target="_blank">Part I &#8211; Introduction</a><br />
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii">Part II &#8211; Feature: Add Item</a><br />
<a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii">Part III &#8211; Feature: Mark-Off Item</a><br />
<a href="http://custardbelly.com/blog/2012/12/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-iv">Part IV &#8211; Feature: List-Item-Controller</a><br />
<a href="http://custardbelly.com/blog/2012/12/31/the-making-of-a-test-driven-grocery-list-application-in-js-part-v/">Part V &#8211; Feature: List-Controller Refactoring</a><br />
<a href="http://custardbelly.com/blog/2013/01/08/the-making-of-a-test-driven-grocery-list-application-in-js-part-vi/" target="_blank">Part VI &#8211; Back to Passing</a><br />
<a href="http://custardbelly.com/blog/2013/01/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-vii/">Part VII &#8211; Remove Item</a><br />
<a href="http://custardbelly.com/blog/2013/01/22/the-making-of-a-test-driven-grocery-list-application-part-viii/">Part VIII &#8211; Bug Fixing</a><br />
<a href="http://custardbelly.com/blog/2013/02/15/the-making-of-a-test-driven-grocery-list-application-in-js-part-ix/">Part IX &#8211; Persistence</a><br />
<a href="http://custardbelly.com/blog/2013/03/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-x/">Part X &#8211; It Lives!</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/amd/" title="View all posts in AMD" rel="category tag">AMD</a>,  <a href="http://custardbelly.com/blog/category/javascript/" title="View all posts in JavaScript" rel="category tag">JavaScript</a>,  <a href="http://custardbelly.com/blog/category/requirejs/" title="View all posts in RequireJS" rel="category tag">RequireJS</a>,  <a href="http://custardbelly.com/blog/category/grocery-ls/" title="View all posts in grocery-ls" rel="category tag">grocery-ls</a>,  <a href="http://custardbelly.com/blog/category/jasmine/" title="View all posts in jasmine" rel="category tag">jasmine</a>,  <a href="http://custardbelly.com/blog/category/unit-testing/" title="View all posts in unit-testing" rel="category tag">unit-testing</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2012/12/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-iv/#comments" rev="post-655"  title="Comment on The Making of a Test-Driven Grocery List Application in JS: Part IV">2 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2012-12-17T17:01">December 17, 2012</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-655-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-636" class="post-636 post hentry category-javascript category-requirejs category-grocery-ls category-jasmine category-unit-testing full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii/" title="Permanent link to The Making of a Test-Driven Grocery List Application in JS: Part III" rel="bookmark" rev="post-636">The Making of a Test-Driven Grocery List Application in JS: Part III</a></h1>
	
	<div class="entry-content full-content">
		<p><em>This is the third installment in a series of building a Test-Driven Grocery List application using <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> and <a href="http://requirejs.org" target="_blank">RequireJS</a>. To learn more about the intent and general concept of the series please visit <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i/">The Making of a Test-Driven Grocery List Application in JavaScript: Part I</a></em><br />
&#8212;</p>
<h1>Introduction</h1>
<p>In the <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii/">previous article</a>, I addressed adding the first feature to the <strong>Grocery List</strong> application: <em>Add Item</em>. Trying my best to adhere to the TDD/BDD philosophy, a story and a couple scenarios were drummed up prior to implementation development using language similar to that described in <a href="http://dannorth.net/introducing-bdd/" target="_blank">Dan Worth’s Introducing BDD article</a>. Once passing, the code written within the test was moved to its own file(s) with dependencies updated in the specs and tests run again to confirm passing against the implementations.</p>
<p>I will take the same approach in adding a new feature in this article: <em>Mark-Off Item</em>. </p>
<p>I suspect, however, that I may actually end up creating stories for more of what can be considered <em>integration</em>. Since the last post, I stumbled upon a <a href="http://chrismdp.com" target="_blank">great blog from Chris Parsons</a> that covers BDD (with a bend toward Cucumber), and in particular the article <a href="http://chrismdp.com/2012/11/the-integration-testing-trap/" target="_blank">Cucumber: the integration test trap</a> provided some great insight into the difference between acceptance and integration testing. In the previous article, I suppose more of what was done could be considered acceptance testing. Some implementation details are testing against in the <em>Add-Item</em> feature (for instance, the item API on the list-controller), but I sort of threw in extra code and UX/UI implementation details at the end just so I could make sure the code was actually usable in a real-life scenario. At the time, I felt that writing specs for the integration of features &#8211; what i consider more fine-grained in testing that an element is added to the DOM upon an API call &#8211; would muddle down the intent of this series. I might take back that assumption. That may lead to longer posts&#8230; you have been forewarned <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<h1>Mark-Off Feature</h1>
<p>There are basically 3 states to an item in the grocery store: </p>
<ol>
<li>unpossessed</li>
<li>unpurchased</li>
<li>owned</li>
</ol>
<p>Once owned&#8230; well it either gets eaten or is freed into the wild &#8211; through those seemingly impenetrable automatic doors of unpurchased state, into the world of natural lighting. As well, prior to own-ed-ship, the item is in limbo as to whether or not it can reach that state &#8211; it might be placed back on the shelf to be forever unpossessed again. (You don&#8217;t want me to go over the possessed state.) Not unlike the life a a loaf of bread in a store, so too are the states of the grocery list items of the <strong>Grocery List</strong> application.</p>
<p>By adding an item &#8211; the feature completed in the <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i/">previous article</a> &#8211; a User has essentially identified an item not in possession, with the end goal of being owned. As a User of the application, we want to be able to denote the item as being in possession, but not purchased. The unpurchased state will notify other Users of the list that it no longer needs to be obtained. However, it will still be allowed to be unmarked and back to unpossessed &#8211; say if someone got <strong>Miracle Whip</strong> mayo instead of <strong>Helmann&#8217;s</strong> (whole &#8216;nother argument).</p>
<p>So we have essentially defined the feature for this post in the series: being able to mark and unmark an item added to the grocery list.</p>
<p><em>// story</em><br />
&#8212;<br />
<strong>Story:</strong> Item is marked off on grocery list</p>
<p><strong>In order to</strong> remember what items have already made it to the cart<br />
<strong>As a</strong> grocery shopper<br />
<strong>I want to</strong> mark an item as being attained on the grocery list.<br />
&#8212;</p>
<p>Similarly, since the item will still be available from the <strong>Grocer List</strong> application and only considered marked off, we could write up another story of being able to unmark an item from the list. For brevity&#8217;s sake, I should probably do that and if we were actually incorporating DSLs and tools that would facilitate in BDD testing, I probably would. But for the sake of this article, we&#8217;ll leave that as an added scenario to this feature.</p>
<p><em>// spec</em><br />
&#8212;<br />
<strong>Scenario 1:</strong> Item is marked off on grocery list<br />
<strong>Given</strong> a user has saved an item to the list<br />
<strong>When</strong> she requests to mark off the item<br />
<strong>Then</strong> the item is presented differently to the user, denoting in possession<br />
<strong>And</strong> the item is not removed from the list<br />
&#8212;</p>
<p>Okay. I&#8217;ll admit. The desired outcome from that scenario is a little vague. But the scenarios I am writing &#8211; as discussed before, after having read <a href="http://chrismdp.com/2012/11/the-integration-testing-trap/" target="_blank">this article from Chris Parsons</a> &#8211; are more loosely acceptance criteria. As a developer, it makes me squirm a little because I know there is much more that can be described in this scenario, especially as it pertains to UI and UX. Aspects such as those can be considered more as integration points and I may circle back for more scenarios involving more of what we, as developers, are affirming in our tests (ie, design and functionality).</p>
<p>Anyway, undoing as well:</p>
<p><em>// spec</em><br />
&#8212;<br />
<strong>Scenario 2:</strong> Item is un-marked off on grocery list<br />
<strong>Given</strong> a user has saved an item to the list<br />
<strong>And</strong> she has marked off an item<br />
<strong>When</strong> she requests to un-mark off the item<br />
<strong>Then</strong> the item is presented to the user as not being in possession<br />
<strong>And</strong> the item is not removed from the list<br />
&#8212;</p>
<p>Basically, we are defining an item of the <strong>Grocery List</strong> application as a toggle control. Now, I can sum that up in a tiny single sentence and wave my hand, but I think we will find that there is a lot more to that statement as we start writing our tests and ultimately will change the design of the application &#8211; fo the better, I hope!</p>
<h2>Test</h2>
<p>To start, the story in question and described above adds to the API of the <em>list-controller</em> we defined and created in the <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii" target="_blank">previous article</a>. The <em>list-controller</em> will need to expose a way to mark off an item that is saved to the list, and a way to unmark an item that was previously marked. As I see it, that&#8217;s two new methods &#8211; let&#8217;s call them <em>markOffItem</em> and <em>unmarkOffItem</em>. Let&#8217;s flesh them out and their signatures in a new spec for this feature:</p>
<p><em>/test/jasmine/spec/markitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define(['script/controller/list-controller'], function(listController) {

  describe('User Requests to mark-off existing item', function() {

    var name = 'apples',
        savedItem,
        markOffSpy,
        unmarkOffSpy;

    beforeEach( function() {
      listController.createNewItem();
      listController.editFocusedItem(name);
      listController.saveFocusedItem();

      savedItem = listController.itemList[listController.itemList.length-1];

      markOffSpy = spyOn(listController, &quot;markOffItem&quot;).andCallThrough();
      unmarkOffSpy = spyOn(listController, &quot;unmarkOffItem&quot;).andCallThrough();
    });

    ...

    afterEach( function() {
      savedItem = undefined;
      markOffSpy.reset();
      unmarkOffSpy.reset();
      listController.itemList = [];
      listController.editableItem = undefined;
    });

  });

});
</pre>
<p>I wanted to start off this test example with just showing to setup and teardown for the feature as it introduces the concept of spies. The <em>beforeEach()</em> of the above specification suite starts off similarly to the other spec we created for the <em>Add Item</em> feature &#8211; create, edit and save an item on the <em>list-controller</em>. Following that, and specifically on line 17 and 18, we create spies for the API modifications we are making on the <em>list-controller</em> in order to add the <em>Mark Off Item</em> feature &#8211; <em>markOffItem()</em> and <em>unmarkOffItem()</em>. Spies, in as far as they are used in this instance, are essentially wrappers on a function that can record invocation calls and provide another API to facilitate in affirming expectations of how a method should be used. If you are unfamiliar with spies, both <a href="https://github.com/pivotal/jasmine/wiki/Spies" target="_blank">Jasmine</a> and <a href="http://sinonjs.org/docs/#spies" target="_blank">Sinon</a> have some great documentation.</p>
<p>The spies are defined to &#8220;call through&#8221; to the function implementation on the <em>list-controller</em>, as well. This will allow for the benefit of recording invocation and defining expectations of the actual implementation. Before we get into the real implementation, let&#8217;s take a look at the first spec for this test &#8211; marking off an item:</p>
<p><em>/test/jasmine/spec/markitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 21; title: ;" title="">
    it('should denote item as being in possession', function() {
      var previouslySavedItem = savedItem,
          savedItemID = savedItem.id,
          savedItemSpy = sinon.spy();

      savedItemSpy(previouslySavedItem);
      listController.markOffItem(savedItemID);

      // spy expectations.
      expect(markOffSpy).toHaveBeenCalled();
      expect(markOffSpy).toHaveBeenCalledWith(savedItemID);

      // model expectations.
      expect(previouslySavedItem.hasOwnProperty('marked')).toBe(true);
      expect(previouslySavedItem.marked).toBe(true);
      // OR &gt;
      sinon.assert.calledWith(savedItemSpy, sinon.match.hasOwn('marked', true));
    });
</pre>
<p>With this spec, we are affirming the signature of <em>markOffItem()</em> method on the <em>list-controller</em>, as well as revealing the need for modifications to the attributes on the model of a grocery list item. I wanted to highlight how the <em>markOffSpy()</em> is being used in expectations, and &#8211; though not technically needed &#8211; also maybe provide some intrigue (hopefully not confusion) in using spies from <a href="http://sinonjs.org" target="_blank">SinonJS</a> as well.</p>
<p>The following expectations, taken from the above spec, facilitate more in describing how <em>listController.markOffItem()</em> is to be used in the application, particularly that the method should be called with only one argument and that being an ID of an item from the list :</p>
<pre class="brush: jscript; first-line: 30; title: ;" title="">
  expect(markOffSpy).toHaveBeenCalled();
  expect(markOffSpy).toHaveBeenCalledWith(savedItemID);
</pre>
<p>Some may say that such expectations are superfluous, and in some ways I do agree. Essentially, this line already defines its usage:</p>
<pre class="brush: jscript; first-line: 27; title: ;" title="">
  listController.markOffItem(savedItemID);
</pre>
<p>If the test didn&#8217;t cough at that line, that we can relatively assume the expectations called into question. To each his own, however. In fact, part of me thinks I should go <em>even more</em> overboard &#8211; ensuring only one argument was called, that it was of the same type as the id attribute on the model, etc. Anyway, after the expectations on the spy, we verify an update to the model on an attribute we have yet to define as well. From this test, we have defined it as being a boolean value and accessible on the <em>marked</em> property. I included a spy created using <a href="http://sinonjs.org" target="_blank">SinonJS</a> as well, just to show off it&#8217;s capabilities and compare and contrast testing on the new attribute of the model:</p>
<pre class="brush: jscript; title: ;" title="">
var previouslySavedItem = savedItem,
      savedItemSpy = sinon.spy();
savedItemSpy(previouslySavedItem);
...
sinon.assert.calledWith(savedItemSpy, sinon.match.hasOwn('marked', true));
</pre>
<p>A spy is created on the model object, and after marking it off through the <em>list-controller</em> API, it is verified as being of type boolean and value of true using a sinon assert. Neat stuff. In this case, I probably would have just stuck with the <strong>Jasmine</strong> expectations, but I wanted to show you the power of <strong>SinonJS</strong> as it can provide a more robust testing API.</p>
<p>Rambling on. There&#8217;s still two other specifications we need to cover in this suite:</p>
<p><em>/test/jasmine/spec/markitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 40; title: ;" title="">
    it('should retain the item in the grocery list', function() {
      listController.markOffItem(savedItem.id);

      expect(listController.itemList.length).toBe(1);
      expect(listController.itemList.indexOf(savedItem)).toBe(0);
    });

    it('should have marked-off item available to unmark-off', function() {
      var previouslySavedItem = savedItem,
          savedItemID = savedItem.id;

      listController.markOffItem(savedItem.id);
      listController.unmarkOffItem(savedItem.id);

      // stubbed expectations.
      expect(unmarkOffSpy).toHaveBeenCalled();
      // model expectations.
      expect(previouslySavedItem.marked).not.toBe(true);
    });
</pre>
<p>These specs define the expectations of the list remaining unmodified when marking off an item, and that the model is updated appropriately when unmarking off an item through the <em>list-controller</em> API, respectively. </p>
<p><small><br />
[note]<br />
<em>I am using Array.prototype.indexOf in the first spec from the previous example. That didn&#8217;t make <a href="https://developer.mozilla.org/en-US/docs/JavaScript/New_in_JavaScript/1.6" target="_blank">an appearance until JavaScript 1.6</a> and as such is not implemented in some older browsers (i have no &lt;3 for IE&lt;9). As I mentioned in the first article of this series, I am taking for granted that the application will be viewed on modern browsers, and in particular modern mobile browsers.</em><br />
</small></p>
<h3>Failing</h3>
<p>If you added this spec to the spec runner like so:</p>
<p><em>/test/jasmine/specrunner.html</em></p>
<pre class="brush: jscript; first-line: 34; highlight: [34]; title: ;" title="">
require( ['spec/newitem.spec.js', 'spec/markitem.spec.js'], function() {
  var jasmineEnv = jasmine.getEnv(),
       ...
  jasmineEnv.execute();
});
</pre>
<p>&gt; it will fail. miserably. But that&#8217;s okay! That&#8217;s expected. Spies require an actual implementation on the object you are spying, and if you recall from the first spec described, we actually request a call through on the implementation in order to verify expected functionality. </p>
<p>Let&#8217;s get to the <em>list-controller</em> and <em>grocery-ls-item</em> model, as those are the two items addressed in the latest spec suite as needing modifications to pass.</p>
<h2>Implementation</h2>
<p>In our Mark Off Item spec suite, we identified two additions to the API of the list-controller. Those methods are:</p>
<ul>
<li>+ markOffItem( itemID )</li>
<li>+ unmarkOffItem( itemID )</li>
</ul>
<p>The first instinct is to just add these to the <em>list-controller</em> object and add an internal method that traverses the held <em>itemList</em> array to locate models that have the passed <em>itemID</em> value. Not a bad instinct, and something of the following would get the tests passing:</p>
<p><em>/script/controller/list-controller.js</em></p>
<pre class="brush: jscript; first-line: 64; title: ;" title="">
markOffItem: function(itemID) {
  var item = findItemByID(itemID, this.itemList),
        renderer = findRendererByItem(item, $itemList.children());
  item.marked = true;
  $(renderer).css('text-decoration', 'line-through');
},
unmarkOffItem: function(itemID) {
  var item = findItemByID(itemID, this.itemList),
        renderer = findRendererByItem(item, $itemList.children());
  item.marked = false;
  $(renderer).css('text-decoration', 'none');
}
</pre>
<p><em>&gt; where findByItemID() locates the model associated with the itemID within the itemList array and findRendererByItem() locates the DOM element associated with the model.</em></p>
<p>If you were to run that, the tests would pass. Well, technically, if you left that bit in there where a <a href="http://sinonjs.org" target="_blank">SinonJS</a> spy was asserting on the model, it would not pass. But if you took that out, all green. Even without modifying the <em>grocery-ls-item</em> model&#8230; such is the dynamic nature of JavaScript. For brevities sake, let&#8217;s add the marked property to the Object.defineProperties object upon creation of a new model:</p>
<p><em>/script/model/grocery-ls-item.js</em></p>
<pre class="brush: jscript; first-line: 3; highlight: [15,16,17,18,19]; title: ;" title="">
var properties = function(id) {
    return {
      &quot;id&quot;: {
        value: id,
        writable: false,
        enumerable: true
      },
      &quot;name&quot;: {
        value: '',
        writable: true,
        enumerable: true
      },
      &quot;marked&quot;: {
        value: false,
        writable: true,
        enumerable: true
      }
    };
  };
</pre>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_iii_1.png" alt="passing mark-off item spec" /><br />
<img src="http://custardbelly.com/blog/images/tdd_js/part_iii_app_1.png" alt="grocery list app with mark off" /></p>
<p><strong>Tagged</strong>: 0.1.3 <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.3" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.3</a></p>
<h2>Before you leave!</h2>
<p>I am not satisfied with the current state of the <em>list-controller</em>; it has far too much responsibility in managing list item renderers and models and lacks the finer details to properly keep the 1:1 relationship that renderers have to their models. We could just throw more code in there, more tests and let it grow into this gross beast, but I really think it is up for a good refactor.</p>
<p>So, that is what I have planned for the next article. We&#8217;ll refactor the <em>list-controller</em> to have less responsibility in managing each <em>grocery-ls-item</em> model and pass that off to a new <em>list-item-controller</em>. In fact, I already have started upon such a refactor and had included most of it in this article, but I felt it was getting too long (as usual) and taking away from the <em>Mark Off Item</em> feature presented here.</p>
<p>Until then, you have passing tests and a functioning <strong>Grocery List</strong> application to play with if you <a href="https://github.com/bustardcelly/grocery-ls" target="_blank">check it out of the repo</a>.</p>
<p>&#8212;</p>
<h1>Link Dump</h1>
<h2>Post Series</h2>
<p><a href="https://github.com/bustardcelly/grocery-ls">grocery-ls github repo</a><br />
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i" target="_blank">Part I &#8211; Introduction</a><br />
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii">Part II &#8211; Feature: Add Item</a><br />
<a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii">Part III &#8211; Feature: Mark-Off Item</a><br />
<a href="http://custardbelly.com/blog/2012/12/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-iv">Part IV &#8211; Feature: List-Item-Controller</a><br />
<a href="http://custardbelly.com/blog/2012/12/31/the-making-of-a-test-driven-grocery-list-application-in-js-part-v/">Part V &#8211; Feature: List-Controller Refactoring</a><br />
<a href="http://custardbelly.com/blog/2013/01/08/the-making-of-a-test-driven-grocery-list-application-in-js-part-vi/" target="_blank">Part VI &#8211; Back to Passing</a><br />
<a href="http://custardbelly.com/blog/2013/01/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-vii/">Part VII &#8211; Remove Item</a><br />
<a href="http://custardbelly.com/blog/2013/01/22/the-making-of-a-test-driven-grocery-list-application-part-viii/">Part VIII &#8211; Bug Fixing</a><br />
<a href="http://custardbelly.com/blog/2013/02/15/the-making-of-a-test-driven-grocery-list-application-in-js-part-ix/">Part IX &#8211; Persistence</a><br />
<a href="http://custardbelly.com/blog/2013/03/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-x/">Part X &#8211; It Lives!</a></p>
<h2>Reference</h2>
<p><a href="http://tddjs.com/" target="_blank">Test-Driven JavaScript Development by Christian Johansen</a><br />
<a href="http://dannorth.net/introducing-bdd/" target="_blank">Introducing BDD by Dan North</a><br />
<a href="http://chrismdp.com/2012/11/the-integration-testing-trap/" target="_blank">Cucumber: the integration test trap by Crhis Parsons</a><br />
Testing spies for <a href="https://github.com/pivotal/jasmine/wiki/Spies">Jasmine</a> and <a href="http://sinonjs.org/docs/#spies">Sinon</a><br />
<a href="http://requirejs.org/" target="_blank">RequireJS</a><br />
<a href="https://github.com/amdjs/amdjs-api/wiki/AMD" target="_blank">AMD</a><br />
<a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a><br />
<a href="http://sinonjs.org/" target="_blank">Sinon</a><br />
<a href="https://github.com/derickbailey/jasmine.async" target="_blank">Jasmine.Async</a><br />
the <a href="http://www.flickr.com/photos/unitzeroone/4721521533/">infamous</a> <a href="http://bit-101.com">eye-roller</a> </p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/javascript/" title="View all posts in JavaScript" rel="category tag">JavaScript</a>,  <a href="http://custardbelly.com/blog/category/requirejs/" title="View all posts in RequireJS" rel="category tag">RequireJS</a>,  <a href="http://custardbelly.com/blog/category/grocery-ls/" title="View all posts in grocery-ls" rel="category tag">grocery-ls</a>,  <a href="http://custardbelly.com/blog/category/jasmine/" title="View all posts in jasmine" rel="category tag">jasmine</a>,  <a href="http://custardbelly.com/blog/category/unit-testing/" title="View all posts in unit-testing" rel="category tag">unit-testing</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii/#comments" rev="post-636"  title="Comment on The Making of a Test-Driven Grocery List Application in JS: Part III">4 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2012-12-06T14:19">December 6, 2012</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-636-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-601" class="post-601 post hentry category-javascript category-grocery-ls category-jasmine category-unit-testing full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii/" title="Permanent link to The Making of a Test-Driven Grocery List Application in JS: Part II" rel="bookmark" rev="post-601">The Making of a Test-Driven Grocery List Application in JS: Part II</a></h1>
	
	<div class="entry-content full-content">
		<p><em>This is the second installment in a series of building a Test-Driven Grocery List application using <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> and <a href="http://requirejs.org" target="_blank">RequireJS</a>. To learn more about the intent and general concept of the series please visit <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i/">The Making of a Test-Driven Grocery List Application in JavaScript: Part I</a></em><br />
&#8212;</p>
<h1>Introduction</h1>
<p>In the <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i" target="_blank">previous article</a>, I covered the intent of developing a Test-Driven <strong>Grocery List</strong> application using <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a>, the <a href="http://dannorth.net/introducing-bdd/" target="_blank">BDD</a> testing framework for JavaScript.</p>
<p>In this article, I want to address a single <a href="http://en.wikipedia.org/wiki/User_story" target="_blank">User Story</a> with a couple scenarios, using language similar to that describe in <a href="http://dannorth.net/introducing-bdd/">Dan Worth&#8217;s <em>Introducing BDD</em> article</a>, that will describe the specifications and expectations of one piece of the <strong>Grocery List</strong> application: adding an item.</p>
<h1>Requirements</h1>
<p>Instead of starting with code and project setup, let&#8217;s take a bite off the requirements of the <strong>Grocery List</strong> application and discuss a single usability point to start with.</p>
<p>The intended use of the <strong>Grocery List</strong> application is to be able to add, check-off and delete items from a list. We&#8217;ll address the difference of checking-off items vs. deleting items in later posts, so for now we&#8217;ll be concerned with only adding an item. Let&#8217;s start with a simple story:</p>
<p><em>// story</em><br />
&#8212;<br />
<strong>Story:</strong> Item is added to grocery list</p>
<p><strong>In order to</strong> remember what to pick up at the grocery store<br />
<strong>As a</strong> grocery shopper<br />
<strong>I want to</strong> add an item to a grocery list accessible when at the store.<br />
&#8212;</p>
<p>With this story, we can define some specification for the application as far as User Requirements. Now, this is where I often have a struggle with my inner &#8216;<em>lets-get-to-it!</em>&#8216; developer attitude and I have to keep concrete implementations in check for a bit.</p>
<p><em>// spec</em><br />
&#8212;<br />
<strong>Scenario 1:</strong> Item added to list<br />
<strong>Given</strong> a user requests to add an item to the list<br />
<strong>And</strong> has provided a name for the item<br />
<strong>When</strong> she requests to save the item<br />
<strong>Then</strong> the list has grown by one item<br />
<strong>And</strong> the list contains the item appended at the end<br />
&#8212;</p>
<p>A pretty basic scenario. It is hard for me to not go overboard here and cover every single aspect and moving piece at this stage &#8211; ie, how does this all happen? What is involved upon the first request? What UI has changed? How is a name provided? Shouldn&#8217;t all these be defined as well? All good questions. In my head, this scenario can be broken out into a handful of other scenarios. But I have to stand back and say that this is the scenario that I consider to be the business requirement at hand. This can be read and agreed upon by a third-party who is unfamiliar with the technology that will fulfill this requirement. If I can prove that this expectation is met successfully, the implementation is a by-product and can have additional test if seen fit. We can also add another scenario to this:</p>
<p><em>// spec</em><br />
&#8212;<br />
<strong>Scenario 2:</strong> Item not added to list<br />
<strong>Given</strong> the list has a single item<br />
<strong>And</strong> a user requests to add an item to the list<br />
<strong>And</strong> has not provided a name for the item<br />
<strong>When</strong> she requests to save the item<br />
<strong>Then</strong> the list has the same items as stored previously<br />
<strong>And</strong> the list does not add an empty-named item<br />
&#8212;</p>
<p>Now we are covering the requirements involved in adding an item to the <strong>Grocery List</strong>&#8230; and I always like to fill in a scenario of what it <em>doesn&#8217;t</em> do, because sometimes what it <em>doesn&#8217;t do</em> tells you more about what the system is supposed to do. Again, we can get exhaustive with UI and device event tests, but we don&#8217;t want to meddle down the specs at this point with concrete implementations.</p>
<p>What I do find interesting from just these basic scenarios is that it does reveal some aspects of the application that will need to be addressed while creating the tests &#8211; mainly, a starter on the grocery item model schema and the API in conversing with a view controller to add and edit an item. </p>
<h4>design note</h4>
<p>It should be noted that I do prefer the design concept of <a href="http://martinfowler.com/eaaDev/SupervisingPresenter.html" target="_blank">Supervising Presenter</a> and will employ it within the tests and application, so you are forewarned <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  If you are unfamiliar, a <strong>Supervising Presenter</strong> is knowledgable of the view and model and provides an API that allows for an outside party to affect each, but mostly in affecting the attributes on the model that are observed by the view. Consequently, it will also allow us to not worry to much about the view implementation and User-based events when resolving logical requirements. I don&#8217;t plan to incorporate any application framework that provides such a pattern, so a basic view controller (supervising presenter) will essentially be in charge of modifying the view and model in the <strong>Grocery List</strong> application that will be built. </p>
<p>Architecture, design patterns and the pros and cons of frameworks are things I am more than willing to discuss over beers <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  I just wanted to give you a heads up.</p>
<h2>Test</h2>
<p>I suppose we should address some set-up as this is the first post. <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> tests are described in a JavaScript file related to a (typically, single) specification of the application requirements, and those <strong>specs</strong> are run in what is considered a <strong>spec-runner</strong>. The browser-based <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> library comes with support for reporting in an HTML document.</p>
<p>Here is an example of the <strong>specrunner.html</strong> from <em>/test/jasmine</em> directory of the github repo for <a href="https://github.com/bustardcelly/grocery-ls">grocery-ls</a>:</p>
<pre class="brush: xml; first-line: 1; title: ;" title="">
&lt;!DOCTYPE html&quot;&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;grocery-ls Spec Runner&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;lib/jasmine-1.2.0/jasmine.css&quot;&gt;
    &lt;script src=&quot;../../lib/require-2.1.1.min.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;lib/jasmine-1.2.0/jasmine.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;lib/jasmine-1.2.0/jasmine-html.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;lib/jasmine.async.min.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;lib/sinon-1.5.0.js&quot;&gt;&lt;/script&gt;

    &lt;script&gt;
      (function( window, require ) {

        require.config({
          baseUrl: &quot;../..&quot;,
          paths: {
            &quot;spec&quot;: &quot;./test/jasmine/spec&quot;,
            &quot;script&quot;: &quot;./script&quot;,
            &quot;jquery&quot;: &quot;./lib/jquery-1.8.3.min.js&quot;
          }
        });

        require( ['spec/newitem.spec.js'], function() {

          var jasmineEnv = jasmine.getEnv(),
              htmlReporter = new jasmine.HtmlReporter();

          jasmineEnv.updateInterval = 1000;
          jasmineEnv.addReporter(htmlReporter);
          jasmineEnv.execute();

        });  

      }(window, requirejs));
    &lt;/script&gt;

&lt;/head&gt;
&lt;body&gt;&lt;/body&gt;
&lt;/html&gt;
</pre>
<p>In the spec runner, we have included the library scripts described previously in the <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i">previous post</a>. One thing to note, is the use of <a href="http://requirejs.org/" target="_blank">RequireJS</a>. In order to support <a href="https://github.com/amdjs/amdjs-api/wiki/AMD" target="_blank">AMD</a>, we instruct <strong>RequireJS</strong> to load the <strong>Jasmine</strong> specs defined in JavaScript files prior to setting the environment and executing the specs. Normally, when not incorporating <strong>RequireJS</strong>, you would just add the specs as script tags in the head. An important part of using <strong>RequireJS</strong> is setting the proper paths in the configuration. This allows <strong>RequireJS</strong> to find the proper dependencies not only in the spec itself, but in any concrete implementations separate from the specs. In this example we have set the <em>baseURL</em> to the root of the project directory and define the keyword &#8220;<em>spec</em>&#8221; as pointing to the <strong>Jasmine</strong> spec directory we have set up. If you checkout the <a href="https://github.com/bustardcelly/grocery-ls">project from the repo</a>, the directory structure and the <strong>RequireJS</strong> configuration paths hopefully will make things clearer.</p>
<p>That&#8217;s just a quick introduction to the spec runner. I may not discuss it further in later posts aside from appending specs to the <em>require()</em> invocation. Without additional headless tooling (which may be covered later), when I run the tests I will simply load the spec runner in a browser.</p>
<h2>New-Item Specifications</h2>
<p>Back to the task at hand&#8230; we have to verify the adding of an item to our <strong>Grocery List</strong>. The make up of a spec file should be addressed, especially when incorporating <a href="http://requirejs.org" target="_blank">RequireJS</a> in our application and tests. We need to start off with a <em>define()</em>, which is a <strong>RequireJS</strong> method to define an <strong>AMD</strong> module &#8211; what we are loading from the spec runner are <strong>Jasmine</strong> spec modules, essentially. Within the <strong>Jasmine</strong> spec file itself, we will be primarily concerned with 3 methods:</p>
<ul>
<li><strong>describe</strong> : encapsulates a suite of specifications</li>
<li><strong>it</strong> : defines a specification</li>
<li><strong>expect</strong> : executes a test against matchers that verify expectations</li>
</ul>
<p>That list is hierarchical &#8211; expectations are defined in a suite of specifications. I will start off using the basic matchers that come with <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a>, but may cover creating custom ones if need be while I develop the <strong>Grocery List</strong> application. It is also important to note that suites can be nested and <strong>Jasmine</strong> is knowledgable enough to execute the tree of specifications appropriately.</p>
<p>Along with those methods that involve expectations of a suite of specifications, there are also two helper methods that I will employ often: <em>beforeEach()</em> and <em>afterEach()</em>. If you are already familiar with unit testing, these are the <strong>setup</strong> and <strong>teardown</strong> methods and will be executed before and after each specification, respectively. They aide in performing common tasks across a suite of specifications that basically setup and teardown dependencies for expectations.</p>
<p><em>Again all of this is a basic overview to actually get to the spec file itself. Definitely checkout the <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine documentation</a> for finer detail.</em></p>
<h2>Failing</h2>
<p>With this knowledge, we can create a basic skeleton of the spec file to cover the scenarios described before:<br />
/test/jasmine/spec/newitem.spec.js</p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define( function() {

  describe('User requests to add new item', function() {

    it('should save new item when name supplied', function() {
        expect(false).toBe(true);
    });

    it('should not save new item when name not supplied', function() {
        expect(false).toBe(true);
    });

  });

});
</pre>
<p>This spec encompasses the story and specifications we defined previously in this post, and has two failing expectations &#8211; typically, when setting up a suite of specifications and just defining specifications that I will return to in order to complete, I throw in a failing expectation. We are describing our &#8216;add item to grocery list&#8217; story with the two specifications: <strong>1)</strong> allowing an item to be added that has a valid name and <strong>2)</strong> not allowing an item to be added without a valid name.</p>
<p>Now, just working through the employment of a view controller/presenter and the API to expose in order to properly define the requirement of adding an item to the list in the specification, we can come to a handful of requirements in order to successfully fulfill these specs:</p>
<ul>
<li>A grocery item model that exposes a &#8220;name&#8221; property</li>
<li>A list view controller/presenter that exposes an API to:</li>
</ul>
<ul>
<li>add/create a new item</li>
<li>modify a newly added/created item</li>
<li>save an item to the list</li>
</ul>
<p>Additionally, we will want to run the request to add at least one item to the list in order to meet expectations in each specification defined. As such, and without any concrete implementations or stubs, we can modify the spec to include the setup and teardown of the controller that will get us to the expectations of the spec:</p>
<p><em>/test/jasmine/spec/newitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 3; title: ;" title="">
describe('User requests to add new item', function() {

    var listController = {
              editableItem: undefined,
              itemList: []
          };

    beforeEach( function() {
      listController.createNewItem();
      listController.editFocusedItem('apples');
      listController.saveFocusedItem();
    });

    it('should save new item when name supplied', function() {
      expect(false).toBe(true);
    });

    it('should not save new item when name not supplied', function() {
      expect(false).toBe(true);
    });

    afterEach( function() {
      listController.itemList = [];
      listController.editableItem = undefined;
    });

  });
</pre>
<p>Before each spec is entered, the list controller is requested to create a new item, modify it and save it to the list. After each spec, reference to the newly created item is returned to an undefined value and the list is emptied. All this will fail if you run it &#8211; even before getting to the specifications; the <em>listController</em> variable only exposes the item and list properties and does not provide the API we have defined in the <em>beforeEach()</em> method. </p>
<p>Now we could go about stubbing the <em>listController</em> out with an API, like such:</p>
<pre class="brush: jscript; title: ;" title="">
sinon.stub(listController, &quot;createNewItem&quot;, function() {
    listController.editableItem = {};
});
</pre>
<p>&#8230; but, in instances like such, I&#8217;d rather just modify the object directly and then move the implementation to its own <strong>AMD</strong> module. We will get into stubbing and mocking in later posts &#8211; as it is very useful &#8211; but for now, to keep things a little more simpler, I will define the makeup of the <em>listController</em> on itself directly:</p>
<p><em>/test/jasmine/spec/newitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 3; highlight: [3,4,5,6,7,8,9,10,11,12,13,14,15,16,20,21,22,23,24,25,26,27,28,29,30,31,32]; title: ;" title="">
var itemProperties = function(id) {
      return {
        &quot;id&quot;: {
          value: id,
          writable: false,
          enumerable: true
        },
        &quot;name&quot;: {
          value: '',
          writable: true,
          enumerable: true
        }
      };
    },
    listController = {
      itemList: [],
      editableItem: undefined,
      createNewItem: function() {
        this.editableItem = Object.create(Object.prototype, itemProperties(new Date().getTime()));
      },
      editFocusedItem: function(name) {
        this.editableItem.name = name;
      },
      saveFocusedItem: function() {
        if( this.editableItem.name.length !== 0 ) {
          this.itemList.push(this.editableItem);
        }
        this.editableItem = undefined;
      }
    };
</pre>
<p>The <em>listController</em> now exposes the methods for creation, edit and save of an item and internally updates the property values of <em>itemList</em> and <em>editableItem</em>. As well, you will notice how a new item is generated using the <em>Object.create()</em> method and supplying a <em>defineProperties</em> object with an immutable &#8220;<em>id</em>&#8221; property and a mutable &#8220;<em>name</em>&#8221; property. With the <em>listController</em> fleshed out a bit more, we can return to the specs and defined some expectations. Remembering that we instruct the <em>listController</em> to create, modify and save an item to the list in the <em>beforeEach()</em> method fo the spec suite, we can modify the first spec that pertains to the successful add of an item:</p>
<p><em>/test/jasmine/spec/newitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 59; title: ;" title="">
    it('should save new item when name supplied', function() {
      expect(listController.itemList.length).toBe(1);
      expect(listController.itemList[0]).not.toBe(undefined);
      expect(listController.itemList[0].hasOwnProperty('name')).toBe(true);
      expect(listController.itemList[0].name).toBe('apples');
    });
</pre>
<p>It can be debated about the number of expectations per spec and whether each expectation should be split into their respective spec. I see pros and cons with both styles, but I mainly strive to keep &#8220;noise&#8221; to a minimum in my tests &#8211; meaning i will sacrifice listing a handful of expectations around a single specification in order for the progression and specification suite to be more &#8220;readable&#8221;. In this case, I am just verifying that an item has been added and retained by the list exposed on <em>listController</em>, and that the item that resides in the list matches that which was added.</p>
<p>Likewise, to complete the other specification of not being able to add an item that does not have an name attributed to it:<br />
<em>/test/jasmine/spec/newitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 0; title: ;" title="">
    it('should not save new item when name not supplied', function() {
      listController.createNewItem();
      listController.saveFocusedItem();
      expect(listController.itemList.length).toBe(1);
      expect(listController.itemList[0].name).toBe('apples');
    });
</pre>
<p>In this specification, we are requesting to create and save a new item through the <em>listController</em> API. Remembering that an item has already been added from the <em>beforeEach()</em> method, after the <em>saveFocusedItem()</em> request, the list should only contain the item added previously.</p>
<h2>Passing</h2>
<p>If we ran the spec runner, we would see our specifications pass:<br />
<img src="http://custardbelly.com/blog/images/jasmine_1.png" alt="new item passing spec" /></p>
<p>Whoopee! The following is the whole spec file:</p>
<p><em>/test/jasmine/spec/newitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define( function() {

  var itemProperties = function(id) {
        return {
          &quot;id&quot;: {
            value: id,
            writable: false,
            enumerable: true
          },
          &quot;name&quot;: {
            value: '',
            writable: true,
            enumerable: true
          }
        };
      },
      listController = {
        itemList: [],
        editableItem: undefined,
        createNewItem: function() {
          this.editableItem = Object.create(Object.prototype, itemProperties(new Date().getTime()));
        },
        editFocusedItem: function(name) {
          this.editableItem.name = name;
        },
        saveFocusedItem: function() {
          if( this.editableItem.name.length !== 0 ) {
            this.itemList.push(this.editableItem);
          }
          this.editableItem = undefined;
        }
      },
      itemName = 'apples';

  describe('List Controller creates a new item', function() {

    beforeEach( function() {
      listController.createNewItem();
    });

    it('should expose the editableItem upon creation', function() {
      var createdItem = listController.editableItem;
      expect(createdItem).not.toBeUndefined();
      expect(typeof createdItem.name).toBe('string');
      expect(createdItem.name.length).toBe(0);
    });

    afterEach( function() {
      listController.editableItem = undefined;
    });

  });

  describe('User requests to add new item', function() {

    beforeEach( function() {
      listController.createNewItem();
      listController.editFocusedItem(itemName);
      listController.saveFocusedItem();
    });

    it('should save new item when name supplied', function() {
      expect(listController.itemList.length).toBe(1);
      expect(listController.itemList[0]).not.toBe(undefined);
      expect(listController.itemList[0].hasOwnProperty('name')).toBe(true);
      expect(listController.itemList[0].name).toBe(itemName);
    });

    it('should not save new item when name not supplied', function() {
      listController.createNewItem();
      listController.saveFocusedItem();
      expect(listController.itemList.length).toBe(1);
      expect(listController.itemList[0].name).toBe(itemName);
    });

    afterEach( function() {
      listController.itemList = [];
      listController.editableItem = undefined;
    });

  });

});
</pre>
<p>You may notice that I snuck in another little specification revolved around the creation and exposure of a new item through the <em>listController</em> &#8211; that is because I am anal and additionally wanted to ensure that the <em>listController</em> responded properly as I saw fit upon creation of a new item.</p>
<p>Of course, at this point the design of the controller can be debated &#8211; and it is a much welcome discussion. I setup <em>listController</em> as it is with the following requirements:</p>
<ul>
<li>View implementation is abstracted away. <em>In fact there is absolutely no communication with the DOM to make these specifications pass. It will be the controller&#8217;s responsibility on how the view is updated based on the exposed API.</em></li>
<li>Only one item will be editable at any given time within the application session. <em>This may be later determined as an oversight, but that is the requirement I have set at the moment&#8230; and if we need multiple editable items, we&#8217;ll modify our tests and refactor!</em></li>
<li>The list of items is accessible and mutable on the controller. <em>This is a requirement that will likely change as the addition and removal of items will have some impact on the supervised view, likely leading to the an API to modify the list replacing the direct access.</em></li>
</ul>
<p><strong>Tagged</strong> 0.1.0: <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.0" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.0</a></p>
<h3>Implementation</h3>
<p>Typically, after having passed specifications, I like to move the work to actual implementations of the application. It is similar to the concept of <a href="http://cumulative-hypotheses.org/2011/08/30/tdd-as-if-you-meant-it/" target="_blank"><em>TDD like you mean it</em></a>, but I don&#8217;t think I strictly adhere to that principle. In any event, we can move the implementation of the <em>listController</em> from the <strong>newitem.spec</strong> to its own <strong>AMD</strong> module define that as a dependency for our spec.</p>
<p>Very simply, we could rip the object declarations from <strong>newitem.spec.js</strong> and drop them into a new <strong>AMD</strong> module and define the <em>listController</em> export for dependency reference in the spec:</p>
<p><em>/script/controller/list-controller.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define(function() {
  var itemProperties = function(id) {
        return {
          &quot;id&quot;: {
            value: id,
            writable: false,
            enumerable: true
          },
          &quot;name&quot;: {
            value: '',
            writable: true,
            enumerable: true
          }
        };
      },
      listController = {
        itemList: [],
        editableItem: undefined,
        createNewItem: function() {
          this.editableItem = Object.create(Object.prototype, itemProperties(new Date().getTime()));
        },
        editFocusedItem: function(name) {
          this.editableItem.name = name;
        },
        saveFocusedItem: function() {
          if( this.editableItem.name.length !== 0 ) {
            this.itemList.push(this.editableItem);
          }
          this.editableItem = undefined;
        }
      };

  return listController;
});
</pre>
<p><em>/test/jasmine/spec/newitem.spec.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define( ['script/controller/list-controller'], function(listController) {

  var itemName = 'apples';

  describe('List Controller creates a new item', function() {

    beforeEach( function() {
      listController.createNewItem();
    });

    it('should expose the editableItem upon creation', function() {
      expect(listController.editableItem).not.toBeUndefined();
    });

    afterEach( function() {
      listController.editableItem = undefined;
    });

  });

  describe('User requests to add new item', function() {

    beforeEach( function() {
      listController.createNewItem();
      listController.editFocusedItem(itemName);
      listController.saveFocusedItem();
    });

    it('should save new item when name supplied', function() {
      expect(listController.itemList.length).toBe(1);
      expect(listController.itemList[0]).not.toBe(undefined);
      expect(listController.itemList[0].hasOwnProperty('name')).toBe(true);
      expect(listController.itemList[0].name).toBe(itemName);
    });

    it('should not save new item when name not supplied', function() {
      listController.createNewItem();
      listController.saveFocusedItem();
      expect(listController.itemList.length).toBe(1);
      expect(listController.itemList[0].name).toBe(itemName);
    });

    afterEach( function() {
      listController.itemList = [];
      listController.editableItem = undefined;
    });

  });

});
</pre>
<p>In the modified <strong>newitem.spec.js</strong>, we have defined the dependency on the <em>list-controller</em> module which is then referenced using <em>listController</em>. Running that will result in the same successful expectations as before. You may notice that the dependency for the <em>listController</em> is defined as <em>&#8217;script/controller/list-controller&#8217;</em>. The <em>&#8217;script&#8217;</em> directory is defined in the <strong>RequireJS</strong> configuration in the spec runner file discussed previously in this post &#8211; it will know how to resolve its location and load the controller file.</p>
<p>Now is where, typically, as modifications to <em>list-controller</em> are made in response to new requirements and specifications, stubbing comes into play within my specs more. If an addition or change to the API of <em>list-controller</em> is required for a new story, then in the specification test I would implement that API using stubs, then move the implementation to the <em>list-controller</em> module once they pass.</p>
<p><strong>Tagged</strong>, 0.1.1: <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.1" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.1</a></p>
<h3>Usability</h3>
<p>Because I can&#8217;t leave well-enough alone, I want to hook up this functionality to User response <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<p>Available in the repo at the current revision up to this point (tagged  <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.1" target="_blank">0.1.1</a>), there is a main index file that I have not addressed in this post:</p>
<p><em>/index.html</em></p>
<pre class="brush: xml; first-line: 1; title: ;" title="">
&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;grocery-ls&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;header&gt;
      &lt;h1&gt;grocery-ls&lt;/h1&gt;
    &lt;/header&gt;
    &lt;section class=&quot;groceries&quot;&gt;
      &lt;ul class=&quot;grocery-list&quot;&gt;&lt;/ul&gt;
      &lt;button id=&quot;add-item-button&quot;&gt;add item&lt;/button&gt;
    &lt;/section&gt;
    &lt;script src=&quot;lib/require-2.1.1.min.js&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;script/grocery-ls.js&quot;&gt;&lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
</pre>
<p>The page just defines an unordered list to display grocery items (editable &#038; uneditable) and a button to add an item to the list. As well, we have included the <a href="http://requirejs.org/" target="_blank">RequireJS</a> library and a main JS file for the <strong>Grocery List</strong> application:</p>
<p><em>/script/grocery-ls.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
(function(window, require) {

  require.config({
    baseUrl: &quot;.&quot;,
    paths: {
      &quot;lib&quot;: &quot;./lib&quot;,
      &quot;script&quot;: &quot;./script&quot;,
      &quot;jquery&quot;: &quot;./lib/jquery-1.8.3.min&quot;
    }
  });

  require( ['jquery', 'script/controller/list-controller'], function($, listController) {
    listController.setView($('section.groceries'));
  });

}(window, requirejs));
</pre>
<p>The configuration paths, you are familiar with when we set up the specrunner for our <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> tests. Additionally, we are asking <strong>RequireJS</strong> to load the &#8216;<em>jquery</em>&#8216; and &#8216;<em>list-controller</em>&#8216; dependencies, after which, the <em>list-controller</em> is given a reference to the DOM element it will supervise: the <strong>section</strong> element with the <strong>class</strong> attribute value of &#8216;<em>groceries</em>&#8216;.</p>
<p>The <em>list-controller</em> will now have more responsibility in updating the view based on invocations of the API we have previously defined for our specifications:</p>
<p><em>/script/controller/list-controller.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define(['jquery', 'script/model/grocery-ls-item'], function($, itemModel) {

  var $view,
      $item,
      $itemList,
      itemFragment              = '&lt;li class=&quot;grocery-item&quot; /&gt;',
      editableItemFragment  = '&lt;li class=&quot;editable-grocery-item&quot;&gt;' +
                                '&lt;input id=&quot;editableItem&quot; name=&quot;editableItem&quot; ' +
                                  'class=&quot;editable-item&quot; placeholder=&quot;Enter item name...&quot;&gt;' +
                                '&lt;/input&gt;' +
                              '&lt;/li&gt;',
      findItemList = function() {
        if( typeof $itemList === 'undefined' ) {
          $itemList = $('.grocery-list', $view);
        }
        return $itemList;
      },
      listController = {
        itemList: [],
        editableItem: undefined,
        setView: function(value) {
          var controller = this;
          $view = $(value);
          $('#add-item-button', this.$view).on( 'click', function(event) {
            controller.createNewItem();
          });
        },
        createNewItem: function() {
          var $list = findItemList(),
              $input,
              controller = this;

          this.editableItem = itemModel.create();
          $item = $(editableItemFragment);
          $input = $('input', $item);
          $input.first().bind( 'blur', function(event) {
            var $this = $(this);

            $this.unbind('blur');
            controller.editFocusedItem( $this.val() );
            controller.saveFocusedItem();
          });

          $item.data('gls-item', this.editableItem);
          $list.append($item);
          $input.first().focus();
        },
        editFocusedItem: function(name) {
          this.editableItem.name = name;
        },
        saveFocusedItem: function() {
          var $list = findItemList();
              $itemFragment = $(itemFragment);

          $item.remove();
          if( this.editableItem.name.length &gt; 0 ) {
            $itemFragment.append('p').text(this.editableItem.name);
            $itemFragment.data('gls-item', this.editableItem);
            $list.append($itemFragment);
            this.itemList.push(this.editableItem);
          }
          this.editableItem = undefined;
        }
      };

  return listController;

});
</pre>
<p><em>/script/model/grocery-ls-item.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define(function() {

  var properties = function(id) {
    return {
      &quot;id&quot;: {
        value: id,
        writable: false,
        enumerable: true
      },
      &quot;name&quot;: {
        value: '',
        writable: true,
        enumerable: true
      }
    };
  };

  return {
    create: function() {
      return Object.create(Object.prototype, properties(new Date().getTime()));
    }
  };

});
</pre>
<p>The modifications to the <em>list-controller</em> from it&#8217;s previous implementation mainly involve access and modification of the DOM in response to requests on its API. If we ran the <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> spec we previously created &#8211; <strong>newitem.spec.js</strong> &#8211; it would still pass. If the main <strong>index.html</strong> file is loaded in a browser, you will be able to add an item by clicking the button and as long as you provide a name in the input field, it will be added to the list.</p>
<p><img src="http://custardbelly.com/blog/images/jasmine1_app.png" alt="grocery list app version 0.1.2" /></p>
<p>We could (and perhaps some readers would say that I <em>should</em> have) created more specs that defined the usability and expectations of DOM manipulation on response to API invocations on the <em>list-controller</em>. It is a valid point and I totally agree. At this point I don&#8217;t want to add noise with the user interface implementations in the specifications; the view implementation is subject to change and the API on the <em>list-controller</em> currently supports the modification of the grocery list. We can be assured at the current moment that the <em>list-controller</em> knows how to manage the list and we should not worry about what User impetus invokes the API.</p>
<p>Perhaps in later posts I will see the error of my ways in letting this go&#8230;</p>
<p><strong>Tagged</strong>, 0.1.2: <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.2" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.2</a></p>
<h1>Conclusion</h1>
<p>We went through the first story, scenarios and specifications of the <strong>Grocery List</strong> application that will be built throughout this series. A tonne of information was covered and if you stayed with me, I appreciate it. In the end we have a passing spec suite for the creation and add of a grocery item through a list view controller. We moved the implementation of the controller and model from the spec to their respective <strong>AMD</strong> modules and allowed for user interaction with the application to perform the creation and add operations.</p>
<p>Thanks for sticking around. I hope this series proves to be helpful in some way.</p>
<p>&#8212;-</p>
<h1>Link Dump</h1>
<h2>Post Series</h2>
<p><a href="https://github.com/bustardcelly/grocery-ls">grocery-ls github repo</a><br />
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i" target="_blank">Part I &#8211; Introduction</a><br />
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii">Part II &#8211; Feature: Add Item</a><br />
<a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii">Part III &#8211; Feature: Mark-Off Item</a><br />
<a href="http://custardbelly.com/blog/2012/12/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-iv">Part IV &#8211; Feature: List-Item-Controller</a><br />
<a href="http://custardbelly.com/blog/2012/12/31/the-making-of-a-test-driven-grocery-list-application-in-js-part-v/">Part V &#8211; Feature: List-Controller Refactoring</a><br />
<a href="http://custardbelly.com/blog/2013/01/08/the-making-of-a-test-driven-grocery-list-application-in-js-part-vi/" target="_blank">Part VI &#8211; Back to Passing</a><br />
<a href="http://custardbelly.com/blog/2013/01/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-vii/">Part VII &#8211; Remove Item</a><br />
<a href="http://custardbelly.com/blog/2013/01/22/the-making-of-a-test-driven-grocery-list-application-part-viii/">Part VIII &#8211; Bug Fixing</a><br />
<a href="http://custardbelly.com/blog/2013/02/15/the-making-of-a-test-driven-grocery-list-application-in-js-part-ix/">Part IX &#8211; Persistence</a><br />
<a href="http://custardbelly.com/blog/2013/03/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-x/">Part X &#8211; It Lives!</a></p>
<h2>Reference</h2>
<p><a href="http://tddjs.com/" target="_blank">Test-Driven JavaScript Development by Christian Johansen</a><br />
<a href="http://dannorth.net/introducing-bdd/" target="_blank">Introducing BDD by Dan North</a><br />
<a href="http://cumulative-hypotheses.org/2011/08/30/tdd-as-if-you-meant-it/">TDD as if you Meant it by Keith Braithwaite</a><br />
<a href="http://requirejs.org/" target="_blank">RequireJS</a><br />
<a href="https://github.com/amdjs/amdjs-api/wiki/AMD" target="_blank">AMD</a><br />
<a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a><br />
<a href="http://sinonjs.org/" target="_blank">Sinon</a><br />
<a href="https://github.com/derickbailey/jasmine.async" target="_blank">Jasmine.Async</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/javascript/" title="View all posts in JavaScript" rel="category tag">JavaScript</a>,  <a href="http://custardbelly.com/blog/category/grocery-ls/" title="View all posts in grocery-ls" rel="category tag">grocery-ls</a>,  <a href="http://custardbelly.com/blog/category/jasmine/" title="View all posts in jasmine" rel="category tag">jasmine</a>,  <a href="http://custardbelly.com/blog/category/unit-testing/" title="View all posts in unit-testing" rel="category tag">unit-testing</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii/#comments" rev="post-601"  title="Comment on The Making of a Test-Driven Grocery List Application in JS: Part II">2 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2012-11-26T07:01">November 26, 2012</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-601-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-580" class="post-580 post hentry category-javascript category-grocery-ls category-jasmine category-unit-testing full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i/" title="Permanent link to The Making of a Test-Driven Grocery List Application in JavaScript: Part I" rel="bookmark" rev="post-580">The Making of a Test-Driven Grocery List Application in JavaScript: Part I</a></h1>
	
	<div class="entry-content full-content">
		<h1>Preface</h1>
<p>Over the past year, after having read <a href="http://tddjs.com/" target="_blank">Test-Driven JavaScript Development</a> by <a href="https://twitter.com/cjno" target="_blank">Christian Johansen</a>, I have become a strong proponent for unit testing. Prior to becoming a total convert, I would start a project with good intentions in writing tests which would end, <em>at best</em>, in having a handful of unit tests in which each was focused on a single method and intended only to validate an expected return value or change of state; <em>at worst</em> (and much more commonly), no tests at all. </p>
<p>That was before the <em>a-HA</em> moment in which I began to realize that unit tests could more importantly verify the design of the application and the requirement of its components. What brings an even larger smile on my face is being able to squash bugs simply by providing different data or changing the impetus of an action in my tests; I can verify the bug and eliminate it, all without having to go through launching the application and going through n-number of User Actions just to see if what I changed fixed the issue at hand. Of course, yes, as a developer you still need to &#8211; nay, <em>must</em> &#8211; do your own QA before passing to QA, but I can offload the time required to go through all those User steps <em>after</em> I have verified that my modification is a logical fix and all other tests are still passing. Armed with this knowledge, I can now cause colleagues to have involuntary eye-rolls with a response to development issues as either: &#8220;What does the test say?&#8221; or &#8220;Modify the tests to the requirement and work from there.&#8221;</p>
<p>In any event, I still consider myself an early convert and haven&#8217;t figured everything out and am still tentative in spots and question the validity of writing a test for perhaps an implementation that is not really a requirement. But, it has brought a new level of fun and excitement to my development cycle and that is never a bad thing &#8211; especially as I see that it adds value.</p>
<h1>Introduction</h1>
<p>If you sat through that jabbering about why i think unit testing brings value to application development, you are very kind, but now I want to address the real intent of this post: I thought it would be interesting to lay it out on the line and build a test-driven application over a series of posts. Writing something that is publicly accessible always drives me to question my knowledge (<a href="http://www.amazon.com/Todd-Anderson/e/B0037FMULM" target="_blank">ps. buy my books</a>!), but I would also like this series to invite criticism from readers so I can (selfishly) better myself. As well, perhaps I can impart some tidbit of wisdom to anyone following along &#8211; no guarantees <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_wink.gif' alt=';)' class='wp-smiley' /> </p>
<h1>Grocery List Application</h1>
<p>I decided to dedicate this series to building a test-driven application that would allow me to create a <strong>Grocery List</strong>. I figured it will be a small enough application to not get muddled down in large, complex requirements and several moving parts but still provide a real-life example of a <a href="http://en.wikipedia.org/wiki/Create,_read,_update_and_delete" target="_blank">CRUD</a>-based application. </p>
<p>A <strong>Grocery List</strong> application is also something I have wanted to make for some time. We still, as a household, create a grocery list with pen and paper and take it in hand to the store. Nothing wrong with that, aside from the general user error of <strong>a)</strong> forgetting the list at home, and the user experience oversight of <strong>b)</strong> not being able to split up and cover parts of the list as a group. So, I thought it may be handy to have a web-based application that my family could add to, remove from and have available on the one thing we never leave the house without: attitudes. No. smartphones.</p>
<h2>Client-side Requirements</h2>
<p>Since we are talking web-based, and specifically mobile-web, the current natural choice (barring snarky comments) is to build the application using HTML/JS/CSS. As well, I will assume we are developing against the latest available browsers and APIs; the application won&#8217;t (with my current mindset) be doing anything cutting edge, so will not require a specific distribution or OS.</p>
<p>Throughout this series, the presentation layer may take more of a back seat as the implementation of tests will largely revolve around the JavaScript language and associated publicly-available libraries. While I do intend to demonstrate how to use the JS libraries, I hope to also provide a healthy discussion around the practice of test-driven development. That said, I do have a preferred set of libraries and tools I use for web development. If you are unfamiliar with them, hopefully I can provide some insight or interest. As well, if you feel I may be off track &#8211; either with the libraries/tools being used, or in the practice of test-driven development &#8211; please speak up.</p>
<h3>Libraries Used</h3>
<p>The following is a list of libraries that will be used in developing the Grocery List application:</p>
<h4>RequireJS</h4>
<p>I am a huge proponent of <a href="http://wiki.commonjs.org/wiki/Modules/AsynchronousDefinition" target="_blank">AMD</a> as part of application structure, with <a href="http://requirejs.org/" target="_blank">RequireJS</a> as my library of choice. I have discussed it in more length in <a href="http://custardbelly.com/blog/2012/03/06/facaded-micro-libraries-and-dependency-management-using-requirejs/" target="_blank">previous</a> <a href="http://custardbelly.com/blog/2012/02/07/current-workflow-developing-linting-testing-and-distributing-javascript/" target="_blank">posts</a>. I will not really cover the usage of <a href="http://requirejs.org/" target="_blank">RequireJS</a> or  concept of <a href="https://github.com/amdjs/amdjs-api/wiki/AMD" target="_blank">AMD</a> much (if at all) in this series, so if you are unfamiliar I implore you to check them out; I will state that it provides a very convenient mechanism to separate responsibilities and dependencies (ie, modular development).</p>
<h4>Jasmine</h4>
<p>I chose <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> as my unit-test framework. In previous posts, I have supported the use of <a href="http://qunitjs.com/" target="_blank">QUnit</a>. I still love <a href="http://qunitjs.com/" target="_blank">QUnit</a> and admire its ease of use and set-up. However, over the past half-year, I had fallen in love with<a href="http://pivotal.github.com/jasmine/" target="_blank"> Jasmine</a> and its <a href="http://en.wikipedia.org/wiki/Behavior-driven_development" target="_blank">BDD</a>-style syntax. It provides (to me) more of means of defining behaviors of a system over testing attributes of an application&#8217;s components and lends to a nicer workflow of defining requirements and designing the application architecture. As well, just like <a href="http://qunitjs.com/" target="_blank">QUnit</a>, it is easy to integrate with <a href="http://requirejs.org/" target="_blank">RequireJS</a> which is a requirement.</p>
<h4>Sinon</h4>
<p><a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> does come with spies, but every now and then I find I need more when stubbing and mocking objects. I got familiar with <a href="http://sinonjs.org/" target="_blank">Sinon</a> when writing unit-tests in <a href="http://qunitjs.com/" target="_blank">QUnit</a>. I still continue to use it as it provides no conflicts with <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> and is familiar to me. There is a library out there called<a href="https://github.com/froots/jasmine-sinon" target="_blank"> jasmine-sinon</a> that provides <strong>Jasmine</strong> matchers for <strong>Sinon</strong> if you are interested; looks good &#8211; just trying to keep requirements low for the development of the <strong>Grocery List</strong> application.</p>
<p>If you are unfamiliar with stubs and mocks for testing, have a look at the <a href="http://sinonjs.org/docs/" target="_blank">Sinon docs</a>.</p>
<h4>Jasmin.Async</h4>
<p><a href="https://github.com/derickbailey/jasmine.async" target="_blank">Jasmine.Async</a> provides a means of which to do asynchronous testing with Jasmine with ease. I have used it on a couple client-side projects and it really is worth it. Modelled after <a href="http://visionmedia.github.com/mocha/" target="_blank">Mocha</a>&#8217;s async test support, it is miles above the default async testing model available in <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> which basically suspends the test from progression until a flag is flipped in a <em>watch()</em> block.</p>
<p>So those are the libraries you will see being used when developing tests. From that list, <a href="http://requirejs.org/" target="_blank">RequireJS</a> is the only library that will also be used in developing the actual <strong>Grocery List</strong> client-side application, which will most likely incorporate <a href="http://jquery.com" target="_blank">jQuery</a> for ease in DOM traversal and AJAX, as well &#8211; it&#8217;s ubiquitous enough that I will not have to add noise to this series of posts by introducing another suite of libraries.</p>
<h2>Github Repo</h2>
<p>I have started a GitHub repo to track the progress of the application in this series: <a href="https://github.com/bustardcelly/grocery-ls" target="_blank">grocery-ls</a>. Each blog post will have an associated tag, or tags, that will represent a snapshot of the repo at that point in time and which are accessible from the GitHub UI. The master branch will represent the current state of the application throughout the whole series.</p>
<h2>Initial Development</h2>
<p>I will be using a pre-defined set of terms and language to define a story and specification for a requirement when developing a test. These are mostly gleaned from the excellent article <a href="http://dannorth.net/introducing-bdd/" target="_blank">Introducing BDD</a> by <strong>Dan North</strong>. I won&#8217;t be doing true BDD with the proper tooling, but rather more of a TDD with BDD characteristic and syntax as is provided from <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a>, and will most likely complete the associated implementation from the specifications addressed in a single post so as to show test-to-implementation, instead of assembling all stories and specifications prior to implementation.</p>
<p>Alright, now that we have the pleasantries of intent and libraries used out of the way, let&#8217;s kick this off&#8230;</p>
<p><strong>[edit] </strong><br />
I had originally included working through the first story and suite of specifications for the <strong>Grocery List</strong> application in this post, but it got rather lengthy and though it started taking away some of the value (if any) the previous sections in this post provided. As such, I moved it out to the second installment of this series:</p>
<p><a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii/">The Making of a Test-Driven Grocery List Application in JavaScript: Part II</a></p>
<p>&#8212;-</p>
<h1>Link Dump</h1>
<p><a href="https://github.com/bustardcelly/grocery-ls">grocery-ls github repo</a><br />
<a href="http://tddjs.com/" target="_blank">Test-Driven JavaScript Development by Christian Johansen</a><br />
<a href="http://dannorth.net/introducing-bdd/" target="_blank">Introducing BDD by Dan North</a><br />
<a href="http://cumulative-hypotheses.org/2011/08/30/tdd-as-if-you-meant-it/">TDD as if you Meant it by Keith Braithwaite</a><br />
<a href="http://requirejs.org/" target="_blank">RequireJS</a><br />
<a href="https://github.com/amdjs/amdjs-api/wiki/AMD" target="_blank">AMD</a><br />
<a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a><br />
<a href="http://sinonjs.org/" target="_blank">Sinon</a><br />
<a href="https://github.com/derickbailey/jasmine.async" target="_blank">Jasmine.Async</a></p>
<h2>Post Series</h2>
<p><a href="https://github.com/bustardcelly/grocery-ls">grocery-ls github repo</a><br />
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i" target="_blank">Part I &#8211; Introduction</a><br />
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii">Part II &#8211; Feature: Add Item</a><br />
<a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii">Part III &#8211; Feature: Mark-Off Item</a><br />
<a href="http://custardbelly.com/blog/2012/12/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-iv">Part IV &#8211; Feature: List-Item-Controller</a><br />
<a href="http://custardbelly.com/blog/2012/12/31/the-making-of-a-test-driven-grocery-list-application-in-js-part-v/">Part V &#8211; Feature: List-Controller Refactoring</a><br />
<a href="http://custardbelly.com/blog/2013/01/08/the-making-of-a-test-driven-grocery-list-application-in-js-part-vi/" target="_blank">Part VI &#8211; Back to Passing</a><br />
<a href="http://custardbelly.com/blog/2013/01/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-vii/">Part VII &#8211; Remove Item</a><br />
<a href="http://custardbelly.com/blog/2013/01/22/the-making-of-a-test-driven-grocery-list-application-part-viii/">Part VIII &#8211; Bug Fixing</a><br />
<a href="http://custardbelly.com/blog/2013/02/15/the-making-of-a-test-driven-grocery-list-application-in-js-part-ix/">Part IX &#8211; Persistence</a><br />
<a href="http://custardbelly.com/blog/2013/03/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-x/">Part X &#8211; It Lives!</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/javascript/" title="View all posts in JavaScript" rel="category tag">JavaScript</a>,  <a href="http://custardbelly.com/blog/category/grocery-ls/" title="View all posts in grocery-ls" rel="category tag">grocery-ls</a>,  <a href="http://custardbelly.com/blog/category/jasmine/" title="View all posts in jasmine" rel="category tag">jasmine</a>,  <a href="http://custardbelly.com/blog/category/unit-testing/" title="View all posts in unit-testing" rel="category tag">unit-testing</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i/#comments" rev="post-580"  title="Comment on The Making of a Test-Driven Grocery List Application in JavaScript: Part I">8 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2012-11-26T07:00">November 26, 2012</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-580-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-545" class="post-545 post hentry category-amd category-javascript category-requirejs category-micro-library full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2012/03/06/facaded-micro-libraries-and-dependency-management-using-requirejs/" title="Permanent link to Micro-Library Facades and Dependency Management using RequireJS" rel="bookmark" rev="post-545">Micro-Library Facades and Dependency Management using RequireJS</a></h1>
	
	<div class="entry-content full-content">
		<p>I recently have been evaluating some JavaScript micro-libraries mainly to see what the community has put out there, read through some code and see what might be appropriate for any upcoming projects, but also to break a dependency on loading libraries that include code that largely goes unused in an application. </p>
<p>As of late, I have been a pretty strong proponent of <a href="https://github.com/amdjs/amdjs-api" target="_blank">AMD</a> (with a favor toward <a href="http://requirejs.org/" target="_blank">RequireJS</a>) largely with the intent of modularized development but also with an ideal of downloading only what is required by the application. Introducing a dependence (and unnecessary download time) on a library that is only fractionally used seems contradictory in the goal of deploying a compact and stream-lined application. That is not to say that such libraries aren&#8217;t useful or have a place; and more often than not, such libraries have a great history, a number of brilliant engineers behind it and proven track record with production-level applications. There is definitely a give and take, and options do need to be weighed on a per-application basis, yet I feel there can be a great benefit in using a collection of libraries that each serve a single purpose.</p>
<p>So with that determination, I have been investigating some JavaScript micro-libraries that are out there in the wild &#8211; from DOM accessors, to routers, to observers. I haven&#8217;t settled on anything to definitively give the OK on using one library over another; just having a bit of fun discovering what the community has to offer &#8211; and hopefully one day can contribute and give back to.</p>
<h2>The Problem</h2>
<p>While test-driving some micro-libraries it quickly became apparent how inefficient my process was. I would start creating a new project to test out a library and copy over numerous files or <em>worse</em> just fill up a directory with files targeting and named after the library I was including. This grew out of control and weakened a proper evaluation of a library with all the clutter; <em>which one was it? where did i use it? why am i so hungry?</em> </p>
<p>Out of a desire to mitigate this confusion, I settled on an approach to provide a consistent API for development of an application through facades that affords the ability to test-drive different micro-libraries with similar responsibilities. The basic premise is to define a common API that I can develop against contextually, and define and swap out abstracted adaptations of different micro-libraries. As such, I can amass a directory of modules that define this API and declare the library I am currently working within a require statement using <a href="http://requirejs.org/" target="_blank">RequireJS</a>. I believe it is more of a poor-man&#8217;s, less-robust and perhaps not production ready approach that <a href="http://addyosmani.com/blog/" target="_blank">Addy Osmani</a> is working on with <a href="https://github.com/addyosmani/backbone-aura" target="_blank">Aura</a> &#8211; a library I am very excited to checkout.</p>
<p>I have some basic examples of the solution I am using at <a href="http://github.com/bustardcelly/requirejs-microlib-facade" target="_blank">http://github.com/bustardcelly/requirejs-microlib-facade</a>.</p>
<h2>Facades</h2>
<p>As mentioned previously, the largest part of this solution is to provide a common API to develop against. I want to have my scripts that interact with an API to pass tests regardless of the dependency passed in &#8211; with the dependence being the facade module that is adapted to the target micro-library. This area is possibly the crux of the whole argument. Which API do you adapt to? Or rather, which implementation of a micro-library should you favor in exposing an API for multiple micro-libraries? A lot of them have similar methods, but the delegate response signatures can vary. It&#8217;s all at the whim of the developer of the micro-library and their vision of the cleanest solution. I don&#8217;t have an answer to this, by the way <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  Just bringing it up. I lean towards providing an API that is similar to the most widely-used solution.</p>
<p>Recently I have been evaluating client-side routing libraries that fit perfectly into this modularized facading concept. Particularly, the first library I wanted to test was <a href="https://github.com/mtrpcic/pathjs" target="_blank">PathJS</a> which provided support for <a href="http://diveintohtml5.info/history.html" target="_blank">HTML5 history</a> as well as fall-back to hash tags (plus niceties like parameterized routes, roots, and others). However, as it provided these capabilities, it also provided two different APIs for them. We could go into a discussion of whether this is good practice and whether it should be abstracted away from the front-end developer, but that isn&#8217;t my biggest concern at the moment &#8211; especially as we can mitigate that concern by abstracting each approach into facades that share a common API. The following are examples of the implementations that adapt to the hash tag implementation and the History implementation respectively:</p>
<p><em>/script/router/PathHashTagFacade.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define( ['../../lib/path.min.js'], function() {

    return {
        map: function( fragment, delegate ) {
            Path.map( '#'+fragment ).to( function() {
                var paramProperty,
                    paramArray = [];
                for( paramProperty in this.params ) {
                    paramArray[paramArray.length] = this.params[paramProperty];
                }
                delegate.apply( this, paramArray )
            });
        },
        root: function( fragment ) {
            Path.root( '#'+fragment );
        },
        init: function( useHistory ) {
            Path.listen();
        }
    };

});
</pre>
<p><em>/script/router/PathHistoryFacade.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define( ['../selector/SimpleSelectorFacade', '../../lib/path.min.js'], function( $ ) {

    var links = $('a'),
        i = 0, length = links.length;

    for( i; i &lt; length; i++ ) {
        links[i].onclick = function( event ){
            event.preventDefault();

            var location = this.attributes['href'].value;
            location = location.split( '#' ).join( '' );
            Path.history.pushState( {}, '', location );
            return false;
        };
    }

    return {
        map: function( fragment, delegate ) {
            Path.map( fragment ).to( function() {
                var paramProperty,
                    paramArray = [];
                for( paramProperty in this.params ) {
                    paramArray[paramArray.length] = this.params[paramProperty];
                }
                delegate.apply( this, paramArray )
            });
        },
        root: function( fragment ) {
            Path.history.pushState( {}, '', fragment );
        },
        init: function( useHistory ) {
            Path.history.listen( true );
        }
    };
});
</pre>
<p>Within the definition of each module, a dependency on the <a href="https://github.com/mtrpcic/pathjs" target="_blank">PathJS</a> library is declared and loaded prior to entering the load delegate. <a href="https://github.com/mtrpcic/pathjs" target="_blank">PathJS</a> is not provided as an AMD module, so it is accessed using <em>Path</em> globally in both examples. The two differ, however, in their implementation of the their common API: <em>map</em>, <em>root</em>, and <em>init</em>. Let&#8217;s set aside the irony of the fact that I am now loading two files (<em>path.js</em> and either facade file) with the end goal being to minimize load times &#8211; this will be made clearer in the next example; I just wanted to show the possibility this solution provides in also testing implementation with the same library.</p>
<p>The implementations are very similar in the two examples. The former mostly takes input and prepends values with a hash (#). The latter uses the History API on <em>Path</em>, and intercepts click events on links to properly handle then in the context of <em>Path.history</em>.</p>
<p>Just as a quick example of how I would then employ this:</p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
require( ['script/router/PathHashTagFacade'], handleRouterDependency );

function handleRouteDependency( router ) {
    require( ['script/RouterDependentClient'], function( client ) {
        client.setRouter( router );
    });
};
</pre>
<p>If HTML5 History API was okay&#8217;d for the project and we wanted to utilize the History API on <a href="https://github.com/mtrpcic/pathjs" target="_blank">PathJS</a>, then we just change the loaded dependency in the first <em>require</em>() statement.</p>
<p>If we look back at the two facade examples for the <em>Path</em> library, both <em>map</em> implementations change the way in which a mapped delegate is handed state with regards to how <em>Path</em> is designed to forward along parameterized values. Usually the parameter key/value pairs are filled on a <em>params</em> Object which is then inspected within the delegate method for the mapped URL. In those examples, I have changed the invocation on the delegate to actually provide the parameterized values as arguments. The reason is because another library I am evaluating does such, and I much prefer it.</p>
<p>Another popular routing library is <a href="https://github.com/flatiron/director" target="_blank">Director</a>. We can now provide a facade for that library that adheres to the same API as the other examples and not have to modify any scripts that interact with the routing dependency (aside from the original <em>require</em>() call):</p>
<p><em>/script/router/DirectorFacade.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define( ['../../lib/director-1.0.7.min.js'],function() {

    var router, root,
        routes = {},
        adapter = {
            map: function( fragment, delegate ) {
                routes[fragment] = delegate;
            },
            root: function( fragment ) {
                if( router === undefined ) {
                    root = fragment;
                }
                else {
                    router.setRoute( fragment );
                }
            },
            init: function( useHistory ) {
                router = new Router( routes );
                router.init();
                if( root !== undefined ) {
                    router.setRoute( root );
                }
            }
        };

    return adapter;

});
</pre>
<p>Now I can swap out the preferred facade at any time during the development cycle of my project and not have to change any application code that depends on the one chosen.</p>
<p>You can checkout the code and an example at <a href="https://github.com/bustardcelly/requirejs-microlib-facade" target="_blank">https://github.com/bustardcelly/requirejs-microlib-facade</a>.</p>
<h2>Evaluation</h2>
<p>This isn&#8217;t going to be an evaluation of the micro-libraries I am currently testing. Perhaps I will do that in another post, but usually I reserve stating my preference on libraries through <a href="http://twitter.com/_toddanderson_" target="_blank">annoying tweets</a>. Rather, I wanted to provide my running list of Pro&#8217;s and Con&#8217;s with regards to this approach of developing an application against a common API that is defined in AMD modules that provide access similarly to underlying micro-libraries that implement the same contextual task differently. I like starting with Con&#8217;s.</p>
<p><strong>Cons:</strong></p>
<li>Adapting to each libraries implementation.</li>
<ul>
<li>
With the glut of micro-libraries out there, it can be a daunting task to simply say that I can fit each one into a similar interface &#8211; much less provide the same outgoing signature on any delegate responders.
</li>
</ul>
<li>Facading to a single task.</li>
<ul>
<li>There are many libraries that are well-suited for a task, but provide implementations for multiple tasks.</li>
<li>Typically, I think of a facade as providing one API for multiple composited pieces that may or may not interact with each other. I can get over the nomenclature, but what if a the same library provides a well-suited implementation for multiple tasks and is not provided as an AMD? I have not addressed cutting down multiple requests for the same library that may be used across multiple facade modules.</li>
</ul>
<li>JavaScript itself.</li>
<ul>
<li>In JavaScript we can not define an Object as being an implementation of a specific Interface nor, consequently, run any tools to ensure that it adheres to one. I am sure there are libraries and &#8216;tools&#8217; out there that can provide a way that makes it appear that an Object needs to or is adhering to an Interface, I am speaking more out-of-the-box: JavaScript doesn&#8217;t have interfaces. <em>Not arguing whether that is right or wrong</em>.</li>
<li>The main advantage of this approach to facade modules is to develop against a consistent API. As such, it is far too easy &#8211; because of the dynamicism of JavaScript &#8211; to lose that across multiple modules, even just in simple spelling mistakes. This calls for more unit testing, which you should be doing anyway (<strong>yes, I am glaring at myself right now</strong>).</li>
</ul>
<p><strong>Pros:</strong></p>
<li>Developing an application against a dependency whose API will not change based on the required underlying micro-library.</li>
<li>Ability to inject, at runtime, a different dependency if required (say, for instance, after having checked browser capabilities).</li>
<li>The use of high-falootin&#8217; buzzwords when describing your approach to colleagues.</li>
<p>Does one outweigh the other? In as far as development, I am leaning toward the <em>Pro&#8217;s</em>, but I do worry that some the <em>Con&#8217;s</em> may deter me from really evaluating a library that may be best-suited, simply because it is too difficult at the time to fit into the defined API.</p>
<h2>Conclusion</h2>
<p>Will I recommend this approach for production-level application deployment? </p>
<p>That is yet to be determined. I still subscribe to the practice that you should compile in (concatenate and minify) all the sources required by an application. So, having the ability to switch the target facade at runtime or on the server by just modifying a line in some script file doesn&#8217;t seem to be the right approach in delivering a web-based application at the moment for me. I would evaluate a handful of libraries, determine the best suited one for the application and include that one (along with the accompanying facade) in my <a href="https://github.com/jrburke/r.js/" target="_blank">r.js build</a>. But I reserve the right to be proven wrong and/or change my mind <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/amd/" title="View all posts in AMD" rel="category tag">AMD</a>,  <a href="http://custardbelly.com/blog/category/javascript/" title="View all posts in JavaScript" rel="category tag">JavaScript</a>,  <a href="http://custardbelly.com/blog/category/requirejs/" title="View all posts in RequireJS" rel="category tag">RequireJS</a>,  <a href="http://custardbelly.com/blog/category/micro-library/" title="View all posts in micro-library" rel="category tag">micro-library</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2012-03-06T06:45">March 6, 2012</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-545-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-513" class="post-513 post hentry category-amd category-jshint category-javascript category-phantomjs category-qunit category-requirejs category-r-js full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2012/02/07/current-workflow-developing-linting-testing-and-distributing-javascript/" title="Permanent link to Current Workflow: Developing, Linting, Testing and Distributing JavaScript" rel="bookmark" rev="post-513">Current Workflow: Developing, Linting, Testing and Distributing JavaScript</a></h1>
	
	<div class="entry-content full-content">
		<p>The title is a bit lofty, no? You&#8217;d expect a treatise to follow, but alas it will most likely be a rambling mess about the various tools and libraries I have a current fascination with and why &#8211; the reason, of which, is due to a recent desire to have a proper build system in place to comfortably develop <strong>JavaScript</strong>. </p>
<p>If you have been following along on this blog, you may be aware of the <a href="https://github.com/bustardcelly/massroute-js" target="_blank">massroute_js project i have up on github</a>. I am testing out various <strong>JavaScript</strong> toolkits, libraries and frameworks and have pushed a few up on the repo. As I was finishing up playing around with the last framework, it dawned on me that I didn&#8217;t have an example with <em>NO</em> framework; NO not being the latest the JS framework. NO being no&#8230; but with more face-palm. Perhaps it is telling of the state of <strong>JavaScript</strong> development these days that I am missing a plain vanilla JS example of my <a href="https://github.com/bustardcelly/massroute-js" target="_blank">MassRoute</a> application, and it is all true. I still don&#8217;t have one committed to the repo. However, the reasoning for that is a lengthy one &#8211; I got obsessed with a proper development environment and custom build system <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  By obsessed, I mean I researched a fair bit of tools and libraries involved in the following areas that I thought fit into my workflow:</p>
<ul>
<li>AMD</li>
<li>Code Quality</li>
<li>Unit Testing</li>
<li>Minification / Concatenation</li>
<li>Build / Deploy</li>
</ul>
<p>I intend to address each of these topics in this article and the tools/libraries I found and those I had chosen for my workflow. It should be noted that I was not considered with development and deployment of the other two piece of the webstack &#8211; <strong>HTML</strong> and <strong>CSS</strong>. It is vital to have a good workflow when working with those technologies as well, and especially if all three are part of your job. There are some great tools and libraries out there for developing and shipping <strong>HTML</strong> and <strong>CSS</strong> and perhaps I will dive into that at a later date.</p>
<p>For now, I have created a common library in the <a href="https://github.com/bustardcelly/massroute-js" target="_blank">massroute_js</a> repo to develop what was turning out to be common pieces of the application I was developing against various <strong>JavaScript</strong> libraries out there. In there are the tools and libraries I will discuss in this post along with a simple build script: <a href="https://github.com/bustardcelly/massroute-js/tree/master/massroute-examples/common" target="_blank">https://github.com/bustardcelly/massroute-js/tree/master/massroute-examples/common</a></p>
<p>I will do my best to explain the history and usage behind each tool and library, but will try to not get too in depth as I may get lost in the actual meaning of this post &#8211; which is to highlight the tools and the workflow in which they can be used together. </p>
<h2>AMD</h2>
<p>The <strong>Asynchronous Module Definition</strong> &#8211; commonly referred to as <strong>AMD</strong> &#8211; is a specification that defines how modules and their dependencies can be defined and loaded asynchronously. The asynchronous part of <strong>AMD</strong> fits nicely in a browser environment so as to not block rendering and script execution while loading modules, but the bigger take away for my development purposes is really the modularization of code and dependency management.</p>
<p>There is a larger history behind <a href="https://github.com/amdjs/amdjs-api/wiki/AMD" target="_blank">AMD</a> and its fruition from <a href="http://wiki.commonjs.org/wiki/CommonJS" target="_blank">CommonJS</a> which I will not go into, not only as I do not have enough personal involvement to speak intelligently about such matters, but that <a href="http://tagneto.blogspot.com/?m=1" target="_blank">James Burke</a> and <a href="http://addyosmani.com/blog/" target="_blank">Addy Osmani</a> already have some extremely insightful articles already out there on the webs:</p>
<p><a href="http://tagneto.blogspot.com/2012/01/simplicity-and-javascript-modules.html?m=1" target="_blank">James Burke: Simplicity and JavaScript modules</a><br />
<a href="http://addyosmani.com/writing-modular-js/" target="_blank">Addy Osmani: Writing Modular JavaScript with AMD, CommonJS and ES Harmony</a></p>
<p>I started dabbling and really getting interested in the idea of modular JavaScript when <a href="http://custardbelly.com/blog/2011/10/04/massroute-js-dojo-example/" target="blank">I began using the Dojo toolkit</a>. That was back at 1.6.1 release and the use of <em>dojo.provide</em>, <em>dojo.require</em> and <em>dojo.declare</em>. Now at 1.7, <a href="http://custardbelly.com/blog/dojotoolkit.com" target="_blank">Dojo</a> is fully compliant with <strong>AMD</strong>. Here is an article discussing <strong>Dojo</strong>&#8217;s move to <strong>AMD</strong> compatibility: <a href="http://dojotoolkit.org/features/1.6/async-modules" target="_blank">http://dojotoolkit.org/features/1.6/async-modules</a>. <em>Just as an aside &#8211; you really should check out <a href="http://dojotoolkit.org/" target="_blank">Dojo</a>, particularly if you come from a <strong>Flex</strong> background and have happened upon this post.</em></p>
<p>So, with some familiarity and a strong interest to incorporate modular development, I set out to find a library that would fit nicely in my workflow. There are a handful of <strong>AMD</strong>-compatible libraries, most notably <a href="https://github.com/unscriptable/curl" target="_blank">curl</a> from <a href="http://unscriptable.com" target="_blank">John Hann</a>, <a href="http://bdframework.org/bdLoad/" target="_blank">Backdraft</a>, and <a href="http://requirejs.org/" target="_blank">RequireJS</a> from <a href="http://tagneto.blogspot.com/" target="_blank">James Burke</a>. I settled on the last <strong>RequireJS</strong> as, not only because of its ease of use and the cleanest, most concise documentation, but because of its <a href="http://requirejs.org/docs/history.html" target="_blank">author and his history</a> and <a href="https://twitter.com/#!/jrburke" target="_blank">active role in the community</a>; not to mention that the related optimization tool &#8211; <a href="http://requirejs.org/docs/optimization.html" target="_blank">r.js</a> &#8211; was also a good selling point.</p>
<h3>RequireJS</h3>
<p>The <a href="http://requirejs.org/docs/api.html">RequireJS API</a> defines how to define a module as well as how to load modules with dependencies. Along with other niceties, it also provides the ability to define dependency load order and loading of <strong>text</strong> files (including <strong>CSS</strong>).<br />
Just taking some stripped down and generalized examples from the common lib of my <a href="https://github.com/bustardcelly/massroute-js" target="_blank">massroute_js repo</a>, a module is defined as such:</p>
<p><em>/script/com/custardbelly/js/RequestToken.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define( function() {

    var RequestToken = (function() {
        this.then = function( handler ) {
            ...
        }
    });
    return RequestToken;

})l
</pre>
<p>&gt; and a module with dependencies are defined as so:</p>
<p><em>/script/com/custardbelly/js/Request.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
define( [&quot;com/custardbelly/js/RequestToken&quot;], function( RequestToken ) {

    var Request = (function( url ) {
        this.send = function( variables ) {
            var token = new RequestToken();
            ...
            return token;
        }
    });
    return Request;

});
</pre>
<p>So with these two examples we see how to define modules with and without dependencies, hopefully demonstrating the benefit of modularization but also the beauty of composition through dependency that <strong>AMD</strong> libraries like <a href="http://requirejs.org/" target="_blank">RequireJS</a> provide. </p>
<p>Another great benefit in using RequireJS is that it gets rid of you having to manage your code in namespaces. In other words, this is no longer necessary:</p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
(function( window ) {
    var massroute = getNamspace( 'com.custardbelly.massroute' );

    function getNamespace( value ) {
        var parts = value.split( '.' ),
            i = 0,
            length = parts.length,
            package, parent = window;

        for( i; i &lt; length; i++ ) {
            package = parts[i];
            parent[package] = parent[package] || {};
            parent = package;
        }
        return parent;
     };

    var Something = function() {
        ....
    };

    massroute.Something = Something;

})( this );
</pre>
<p>What is happening under the hood, loading and reference-wise, is that <strong>RequireJS</strong> (now <em>require</em> on the <strong>window</strong> Object) holds a list of file references in its own <em>contexts.urlMap</em> property &#8211; the key being the normalized string of the module based on configuration and the value being the actual url for that module file. As dependency requests are made, a lookup is made on <strong>require</strong>&#8217;s <em>contexts.loaded</em> property which maps the normalized module string to a flag of already loaded and available. A script tag is actually written and attached to the <strong>DOM</strong> to begin loading of the script just as most script loaders do. What sets it apart is the use of async and datasets. If we take a look at what is appended for the <em>Request</em> module from a previous example:</p>
<pre class="brush: xml; title: ;" title="">
&lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot; async=&quot;&quot; data-requirecontext=&quot;_&quot; data-requiremodule=&quot;com/custardbelly/js/Request&quot; src=&quot;./../script/com/custardbelly/js/Request.js&quot;&gt;&lt;/script&gt;
</pre>
<p>We can see that the values on the datasets directly correspond to those of the key/value pairs in <em>require.context.urlMap</em> for your application. So as these are loaded, the flag in <em>require.context.loaded</em> is flipped. Pretty elegant, and if you are interested in more about <strong>RequireJS</strong>&#8217;s design and the requirements it adheres to, this is a great article: <a href="http://requirejs.org/docs/requirements.html" target="_blank">http://requirejs.org/docs/requirements.html</a>. Now&#8230; back to looking at code.</p>
<p>When it came time to employ these modules, I would <em>require</em>() where my application is responsible for making a request. Let&#8217;s just take on start-up in a main file as an example:</p>
<p><em>/app/main.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
(function( require ) {
    require.config({
        baseUrl: &quot;.&quot;,
        paths: {
            &quot;com&quot;: &quot;./script/com&quot;
        }
    });

    require( ['com/custardbelly/js/Request'], function( Request ) {

        var request = new Request( 'http://somewhere.fun/go'),
            token = request.send({person:'Todd'});

        token.then( relax );

        function relax() {
            console.log( 'ahhh' );
        }
    });
})( requirejs );
</pre>
<p>It should be noted that anything (ie. objects, functions, native objects) can be returned from a module definition. Typically, though, and which is seen from these examples, i tend to return constructors probably due to my class-based language background; in other words, <em>x</em> requires <em>y</em> as <em>x</em> is going to create at least one new instance of it. But you could very well return an object or a function, and the real power comes in when you consider composition and module dependencies&#8230; and for all you <strong>DI</strong> fans out there like me, the cogs might start spinning up in that noggin. I have yet to do a real test-drive of <strong>IoC</strong> containers for <strong>JavaScript</strong> but there must be or could be something that is a perfect match for <strong>RequireJS</strong>. I am aware of <a href="https://github.com/briancavalier/wire" target="_blank">wire</a>, but as I said, have yet to give it a go &#8211; Santa failed on delivering more hours in the day <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  If you know of any, please leave a comment.</p>
<p>So that is where my <strong>AMD</strong> loader choice stands. I have been using it for some time and have been pretty happy. Keep in mind that all these modules are separated to their own files. Depending on the size of the project, that can tally up to a lot of requests. And if we compound that with a slow network and a limited caching capabilities, we&#8217;re talking about trade-offs in even using <strong>AMD</strong>&#8230; unless we can optimize our development workspace down to a reasonable production environment that will go live. We&#8217;ll address those concerns a little later in the article&#8230;</p>
<h3>AMD reading link dump:</h3>
<p><a href="https://github.com/amdjs/amdjs-api/wiki/AMD" target="_blank">AMD specification on GitHub</a><br />
<a href="https://github.com/umdjs/umd" target="_blank">(UMD) Universal Module Definition</a><br />
<a href="http://unscriptable.com/code/AMD-vs-CommonJS/#0" target="_blank">John Hann: AMD vs CommonJS</a><br />
<a href="http://dailyjs.com/2011/12/22/framework/" target="_blank">DailyJS: The How and Why of AMD</a><br />
<a href="http://addyosmani.com/writing-modular-js/" target="_blank">Addy Osmani: Writing Modular JavaScript with AMD, CommonJS and ES Harmony</a><br />
<a href="http://tagneto.blogspot.com/2012/01/simplicity-and-javascript-modules.html?m=1" target="_blank">James Burke: Simplicity and JavaScript modules</a><br />
<a href="http://tomdale.net/2012/01/amd-is-not-the-answer" target="_blank">Tom Dale: AMD is Not the Answer</a><br />
<a href="http://wiki.ecmascript.org/doku.php?id=harmony:modules_examples" target="_blank">ES Harmony modules proposal</a><br />
<a href="http://requirejs.org/" target="_blank">RequireJS</a></p>
<h2>Code Quality</h2>
<p>What makes <strong>JavaScript</strong> so <em>fun</em> is you can get away with a lot of shi&#8230; pped code that is littered with syntactical errors, misspellings, declared and unused variables and not to mention code that is improperly formatted. Such things can cause your application to fail silently and unsuspectingly to a user &#8211; no flag is explicitly raised that the code is failing unless an end-user cares about opening the debugger tools of a browser and submitting tickets for you. Such things you can&#8217;t mitigate and handle properly with more code because it is the code itself&#8230; well, i guess you could wrap everything in a little try&#8230; catch&#8217;s, but that would be silly.</p>
<p>If you are coming to <strong>JavaScript</strong> from a language that gets compiled, finding such mistakes during development might be a bit of a challenge in as far as the IDE department goes. There are a handful of excellent <strong>IDE</strong>s out there targeting web development (I enjoy <a href="http://www.sublimetext.com/2" target="_blank">Sublime Text 2</a>), but the nature of an interpreted language leaves the ability to analyze and catch possible syntax and runtime errors before deploying code a challenge; unlike <strong>SDK</strong>s and <strong>IDE</strong>s that employ compiler tools that can determine errors in live edit or through a pre-compilation build.</p>
<p>That&#8217;s not to say, <em>by any means</em>, that a program has less bugs in a compiled environment than in an interpreted one. It just means you have to be a little more diligent in analyzing and testing your code &#8211; more on testing later. This type of analysis without actually executing or running the code for a program is commonly referred to as <em>linting</em><a href="http://en.wikipedia.org/wiki/Lint_(software)" target="_blank">. When it comes to JavaScript, you can&#8217;t go far into searching for a linter without finding </a><a href="http://www.jslint.com/" target="_blank">JSLint</a>, nor <a href="http://www.jshint.com/" target="_blank">JSHint</a> and their <a href="http://anton.kovalyov.net/2011/02/20/why-i-forked-jslint-to-jshint/" target="_blank">connection</a>. </p>
<p>I won&#8217;t go over the benefits of one or the other, nor their history as there are plenty of articles out there on such. For the benefit of my own development environment and workflow, I have chosen <a href="http://www.jshint.com/" target="_blank">JSHint</a> for linting code &#8211; mainly because of the ease of set-up especially when it comes to disregarding the formatting of my code. I am much more concerned with syntactical errors and do not consider such things as indentation to be detrimental to the performance of the program, especially as it will later be run through minification. That is in no way stating that proper formatting is un-important, especially, especially, especially when working with a team. I do strive to keep a consistent format to my code, and certain IDEs help in some respect with coding standards and conventions, but at this time <a href="http://www.jslint.com/" target="_blank">JSLint</a> is a little too strict and feels a little more like prodding the code into a certain style &#8211; like a master&#8217;s apprentice. Not necessarily a bad thing and I may change my mind at some point, but for now <strong>JSHint</strong> it is. Plus, there is a sweet <a href="https://github.com/uipoet/sublime-jshint" target="_blank">JSHint package</a> for <a href="http://www.sublimetext.com/2" target="_blank">Sublime Text 2</a> that I can hook into a hotkey to check for errors on the current file I have open. </p>
<h3>Code Quality reading link dump:</h3>
<p><a href="http://www.jslint.com/" target="_blank">JSLint</a><br />
<a href="http://www.jshint.com/" target="_blank">JSHint</a><br />
<a href="http://anton.kovalyov.net/2011/02/20/why-i-forked-jslint-to-jshint/" target="_blank">Anton Kovalyov: Why I Forked JSLint to JSHint</a><br />
<a href="https://github.com/uipoet/sublime-jshint" target="_blank">JSHint Sublime Plugin: uipoet/sublime-jshint</a></p>
<h2>Unit Testing</h2>
<p>This topic is too large to really go into discussing methodologies, extolling the virtues of and defining best practices for in this article. As such, I will simply state that I am guilty of not doing enough testing during the design of applications. For a time, when I was getting more familiar with languages and programming in general, creating unit tests for my code seemed more as a distraction from getting down to brass tacks and delivering a product. I&#8217;ll admit that, and the hugely naive stance that it takes <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  That is in no way to say that now I practice good <a href="http://en.wikipedia.org/wiki/Test-driven_development" target="_blank">Test Driven Development</a> (TDD). Far from it; really far from it. But I am trying to get better. More importantly, my thinking has changed in that I now believe unit testing is actually a proper way of testing the <em>design</em> of my application rather than finding errors in the code. I think that was a big leap for me. And, for whatever it may mean, coming to an interpreted language like <strong>JavaScript</strong>, designing and developing upon unit tests becomes even more important to me. <a href="http://www.amazon.com/Test-Driven-JavaScript-Development-Developers-Library/dp/0321683919" target="_blank">Test-Driven JavaScript Development</a> by <a href="http://cjohansen.no/" target="_blank">Christian Johansen</a> has definitely gone a long way in swaying my development practices for <strong>JavaScript</strong>, and I highly recommend picking up this book. </p>
<p>Like I said, it is too much to get into a discussion of <strong>TDD</strong> and unit testing, I wanted more to highlight the choices I have made for my development and deployment workflow in unit testing my code. I looked at and tried out a couple different unit testing frameworks for <strong>JavaScript</strong> &#8211; with <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a>, <a href="http://hirojs.com/" target="_blank">Hiro</a> and <a href="http://docs.jquery.com/QUnit" target="_blank">QUnit</a> catching my eye. </p>
<h3>QUnit</h3>
<p>I ended up settling with <strong>QUnit</strong> for the following reasons:</p>
<ol>
<li>Familiarity and ease of use.</li>
<li>Easy integration with RequireJS.</li>
<li>Easy and already available source/docs for integration with headless test runners (<a href="http://code.google.com/p/js-test-driver/wiki/QUnitAdapter" target="_blank">JSTestDriver</a>, <a href="http://code.google.com/p/phantomjs/wiki/TestFrameworkIntegration" target="_blank">PhantomJS</a> &#8211; more on this later).</li>
</ol>
<p>All of those are important. That list is really more representative of the order the contact states of a 3-way bulb where it eventually all came together. It was imperative that I could keep developing without choosing a <strong>Unit Testing</strong> framework that influenced the <strong>AMD</strong> library I chose and (as I will go into in a bit) it was necessary for my deployment needs to run the tests in a headless environment; during development, i want to write my tests (hopefully using &#8220;<a href="http://www.markhneedham.com/blog/2009/04/30/coding-dojo-13-tdd-as-if-you-meant-it/" target="_blank"><em>TDD-like-you-mean-it</em></a>&#8220;) and run them quickly and visually, but I also was looking forward to take that work in unit testing unmodified and provide it to a headless test runner when it came to run a full deployment. So <a href="http://docs.jquery.com/QUnit" target="_blank">QUnit</a> fit in nicely&#8230; for now at least. The familiarity and ease of use is a nice initial draw, but the other two are really the weighing factors and I would not mind giving <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> more of a go at a later date if i can ensure those two points.</p>
<p>In any event, using <a href="http://requirejs.org/" target="_blank">RequireJS</a> and <a href="http://docs.jquery.com/QUnit" target="_blank">QUnit</a> together is rather straight-forward, especially after finding this <a href="https://gist.github.com/920405" target="_blank">nice gist from drewwells: https://gist.github.com/920405</a>. The main rule to remember is to set <em>autostart</em> to false on <strong>QUnit</strong>, and only invoke :<em>start()</em> once you have required all tests:</p>
<p><em>/test/index.html</em></p>
<pre class="brush: xml; first-line: 6; title: ;" title="">
&lt;script src=&quot;../lib/require-1.0.4.js&quot;&gt;&lt;/script&gt;
&lt;script src=&quot;lib/qunit.js&quot;&gt;&lt;/script&gt;
&lt;script&gt;
    QUnit.config.autostart = false;

    require.config({
        baseUrl: &quot;.&quot;,
        paths: {
            &quot;com&quot;: &quot;../script/com&quot;
        }
    });

    requirejs(['script/RequestTest.js', 'script/RequestTokenTest.js', 'script/RouteStopTest.js'], function() {
        QUnit.start(); // Tests loaded, run tests
    });
&lt;/script&gt;
</pre>
<p>In basic terms, you have replaced adding <em>&lt;script&gt;</em> tags for each test &#8211; as you normally would when working with <strong>QUnit</strong> &#8211; with loading them as modules through <strong>RequireJS</strong>. The tests utilize <strong>RequireJS</strong> as well, but do not define a module; rather require necessary dependencies through <strong>RequireJS</strong> and define tests that <strong>QUnit</strong> will find:</p>
<p><em>/test/script/RequestTest.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
require( ['com/custardbelly/js/RequestToken', 'com/custardbelly/js/Request'], function( RequestToken, Request ) {

    module( &quot;Request Test&quot; );

    test( 'send returns RequestToken', function() {
        var token,
            xhr = new Request( 'http://webservices.nextbus.com/service/publicXMLFeed?command=routeList&amp;a=mbta' );

        token = xhr.send();
        equals( ( token !== 'undefined' ), true, 'Request.send() returns RequestToken' );
    });
    ...
});
</pre>
<p>The source library dependencies are defined in the first argument for <em>require</em>(), while the second argument is a handler with there reference supplied as arguments. As for the <em>module</em>() call, there&#8217;s nothing there now accept the name that will be associated and printed along with the tests but the <strong>QUnit</strong> <em>modules</em> can also be used to define your <em>setUp</em> and <em>tearDown</em> fixtures. <a href="http://docs.jquery.com/QUnit" target="_blank">Check out the docs for more information</a>.</p>
<h3>PhantomJS</h3>
<p>As I mentioned in the previous part of this section, it is a requirement for my deployment process to be able to run my unit tests in a headless environment. As well, it is preferable to not modify the set-up for unit testing in the development environment to run the tests later in deployment. I originally checked out <a href="http://code.google.com/p/js-test-driver/" target="_blank">JsTestDriver</a> for my headless environment as it is undoubtably the most widely known &#8211; and for good reason. It even has an <a href="http://code.google.com/p/js-test-driver/wiki/QUnitAdapter" target="_blank">adapter for QUnit</a>, and I spent a great deal of time to get it working with my <strong>QUnit</strong> + <strong>RequireJS</strong> setup. To no available, however, as <a href="http://groups.google.com/group/requirejs/browse_thread/thread/5113a89cf5f5dc52" target="_blank">this discussion reveals</a> in which script loading is not really supported by <strong>JsTestDriver</strong>, which is required (no pun) as we saw earlier in this article that <strong>RequireJS</strong> writes <em>async</em> <em>&lt;script&gt;</em> tags to the <strong>DOM</strong>.</p>
<p>That discovery led me to <a href="http://www.phantomjs.org/" target="_blank">PhantomJS</a> which I am pretty happy out. As the site states:</p>
<p>&#8220;PhantomJS is a headless WebKit with JavaScript API. It has fast and native support for various web standards: DOM handling, CSS selector, JSON, Canvas, and SVG.<br />
PhantomJS is created by <a href="https://twitter.com/AriyaHidayat">Ariya Hidayat</a>.&#8221;</p>
<p>What that basically means is that it is nothing short of awesome, and by executing the <strong>QUnit</strong> adapter script provided at <a href="http://code.google.com/p/phantomjs/wiki/TestFrameworkIntegration" target="_blank">http://code.google.com/p/phantomjs/wiki/TestFrameworkIntegration</a> I could point to my local main file that I use for running unit tests during development and run <strong>PhantomJS</strong> during deployment to stop and report back any failures encountered. Here is an example of that command:</p>
<pre class="brush: bash; title: ;" title="">
./bin/phantomjs run-qunit.js file://localhost/Users/todd/massroute_js/massroute-examples/common/test/index.html
</pre>
<p>I actually played around with <a href="http://www.phantomjs.org/" target="_blank">PhantomJS</a> farther beyond just trying to integrate with my <a href="http://requirejs.org/" target="_blank">RequireJS</a> and <a href="http://docs.jquery.com/QUnit" target="_blank">QUnit</a> set up for deployment, and the <strong>API</strong> it provides is exceptional and proves its use in a variety of automated tasks: <a href="http://code.google.com/p/phantomjs/wiki/Interface" target="_blank">http://code.google.com/p/phantomjs/wiki/Interface</a>.</p>
<p>* <em>If you are interested in how you can hook up additional logging/output for PhantomJS+QUnit, <a href="https://twitter.com/gavincoop" target="_blank">@gavincoop</a> tweeted this gist to me that incorporates output of JUnit XML, which I hadn&#8217;t incorporated into my workflow: <a href="https://gist.github.com/1588423" target="_blank">https://gist.github.com/1588423</a></em></p>
<h3>Unit Testing link dump:</h3>
<p><a href="http://en.wikipedia.org/wiki/Test-driven_development" target="_blank">Test Driven Development</a><br />
<a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a><br />
<a href="http://hirojs.com/" target="_blank">Hiro</a><br />
<a href="http://docs.jquery.com/QUnit" target="_blank">QUnit</a><br />
<a href="http://code.google.com/p/js-test-driver/" target="_blank">JsTestDriver</a><br />
<a href="http://www.phantomjs.org/" target="_blank">PhantomJS</a><br />
<a href="http://www.amazon.com/Test-Driven-JavaScript-Development-Developers-Library/dp/0321683919" target="_blank">Test-Driven JavaScript Development</a> by Christian Johansen.</p>
<h2>Minification &#038; Concatenation (min-concat)</h2>
<p>As I was researching and introducing unit testing for my development workflow, the choice of unit testing framework began to hinge on its integration in a headless testing environment that could be used in a deployment scheme. When it comes to deployment and production-level sources, it is recommended to minify and concatenate scripts. Concatenation has the benefit of minimizing HTTP requests (with a trade off of size of course), and should be done with respect to dependencies; meaning, I would concatenate Service and Token modules together, but not with interactivity utility scripts &#8211; the user may not require one or the other during their session, so there is no need to bundle them together and bloat file size and request response time.</p>
<p>Typically I would save the min-concat for deployment. I would develop and test (both with browser developer tools and unit test) with fully spaced-up, line-break-containing, long-variable-name-using scripts and only min-concat when it came time to push to staging and production. Some say that this may present false positives as I would not be testing with what is to be live code. I would tend to agree and I am looking for a reliable way to fit this into the dev/deploy workflow, but for now it is much easier to test code with the full source using the browser developer tools (though i have heard that there may be new advancements in file swapping a&#8217;la <a href="http://www.charlesproxy.com/" target="_blank">Charles</a> or <a href="http://kevinlangdon.com/serviceCapture/" target="_blank">Service Capture</a> for dev tools).</p>
<p>When it comes to minification and concatenation of <strong>JavaScript</strong> files, there are a handful. When researching the right one to fit into my current development and deployment workflow, I also discovered and kick the tires on some fuller build systems that incorporated min-concat to see if they were something I could use. I highlight a few in the links section of this part as I think they may be beneficial to others, but I stuck with rolling my one build/deployment script mainly due to the dependency (happily and no pun intended <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> ) of <a href="http://custardbelly.com/blog/requirejs.org" target="_blank">RequireJS</a> in my development.</p>
<h3>Minification</h3>
<p>Here is a quick rundown of the most popular minifier/optimization scripts out there that I see:</p>
<ul>
<li><a href="http://developer.yahoo.com/yui/compressor/" target="_blank">YUI Compressor</a></li>
<li><a href="http://code.google.com/closure/compiler/" target="_blank">Google Closure Compiler</a></li>
<li><a href="https://github.com/mishoo/UglifyJS/">UglifyJS</a></li>
</ul>
<p>In one way or another, most open-source build systems I have come across use one or a coupling of these. Each have their own strengths and compiler options, but I can not speak at length on the benefits outweighing one or the other. The reason that I didn&#8217;t delve into which incorporated better into my workflow was due to my want of modular development and <strong>RequireJS</strong>. So for obvious reasons that lead me to the supported optimizer tool from <strong>RequireJS</strong> &#8211; <a href="http://requirejs.org/docs/optimization.html" target="_blank">r.js</a>.</p>
<p><a href="https://github.com/jrburke/r.js" target="_blank">r.js</a> is an optimizer for JavaScript source files that use the AMD API. It can be configured to use either <strong>UglifyJS</strong>(default) or the <strong>Closure Compiler</strong> and can be run under <a href="http://nodejs.org/" target="_blank">node.js</a> and <a href="http://www.mozilla.org/rhino/" target="_blank">Rhino</a>. It is a minifier and concatenator rolled into one and does so with respect to AMD loaders.</p>
<p>When using <strong>r.js</strong>, you provide a build file that defines your desired configuration in optimization. There is a good base example up in github: <a href="https://github.com/jrburke/r.js/blob/master/build/example.build.js" target="_blank">https://github.com/jrburke/r.js/blob/master/build/example.build.js</a>, and just as a quick example of what I have for a build file for the custom script in <a href="https://github.com/bustardcelly/massroute-js/tree/master/massroute-examples/common" target="_blank">massroute-js/common</a>:</p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
({
    baseUrl: '../../script',
    name: 'com/custardbelly/js/Request',
    include: ['com/custardbelly/js/RequestToken'],
    out: '../../dist/script/custardbelly.min.js',
    optimize: &quot;closure&quot;,
    wrap: true
})
</pre>
<p>That is the defining the base URL for modules to be used by the AMD loader (<em>baseUrl</em>), the main module (<em>name</em>) and its dependencies (<em>include[]</em>), the output filename (<em>out</em>), preferred optimizer (<em>optimize</em>), and whether or not to wrap the optimized file in <em>(function() { &#8230; }());</em> to encapsulate the code.</p>
<p>Now, for my &#8220;commons&#8221; library that is being developed for the <a href="https://github.com/bustardcelly/massroute-js" target="_blank">massroute-js examples</a>, I have source split up into two packages &#8211; one that may be considered common to my domain, and one that is considered common to the application. Unfortunately, a single build file for <a href="https://github.com/jrburke/r.js" target="_blank">r.js</a> doesn&#8217;t seem to be compatible to define multiple output modules with their own separate dependencies. In remembering the configuration file from previous example, I had thought this would be achievable by placing the <em>name</em>, <em>include</em> and <em>out</em> properties into each element of the modules list available from the <strong>r.js</strong> build API, eg.:</p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
({
    baseUrl: '../../script',
    dir: '../../dist/script',
    modules: [
        {
            name: 'com/custardbelly/js/Request',
            include: ['com/custardbelly/js/RequestToken'],
            out: 'custardbelly.min.js'
        },
        {
            name: 'com/custardbelly/massroute/model/InflatableModel',
            include: ['com/custardbelly/massroute/model/Route', 'com/custardbelly/massroute/model/RouteStop'],
            out: 'massroute.min.js'
        }
    ],
    optimize: &quot;closure&quot;,
    wrap: true
})
</pre>
<p>In this build file example, I attempted to output two optimized modules &#8211; one each for the <em>custardbelly</em> and <em>massroute</em> namespace, as I figured with the previous example representing a single module output with its configuration, defining them in the list in <em>modules</em> would perform multiple module outputs; which is not the case. That is when i stumbled upon <a href="https://github.com/jrburke/r.js/issues/30#issuecomment-3693033" target="_blank">this ticket in requirejs&#8217; github</a> and gave the solution of using multiple &#8220;single file&#8221; builds, which is what I wound up using in my deployment.</p>
<p>It should be noted that <a href="http://tagneto.blogspot.com" target="_blank">James Burke</a> has also released <a href="https://github.com/jrburke/almond" target="_blank">almond.js</a>, which is a light-weight AMD loader. With this, it is possible to run <strong>r.js</strong> and compile in <strong>almond.js</strong> to remove the dependency of loading the <strong>require.js</strong> library at runtime. I attempted to fold this solution into my deployment build, but ended up not using it mainly because of how <strong>Rhino</strong> looks up resources based on the <em>name</em> property in the <strong>r.js</strong> configuration file; the only way to reliably fold <strong>almond.js</strong> into my optimized library was to include in the same directory as my custom scripts. I generally like to separate my scripts out into folders that rightly define their role and particularly do not intermix third-party libraries with my own scripts. But whatever. I am being a stickler and if it comes a benefit, I will probably incorporate a script that will temporarily copy the <em>/external/lib/almond.js</em> file into my <em>/scripts</em> directory only to remove if after running optimization with <a href="http://requirejs.org/docs/optimization.html" target="_blank">r.js</a>.</p>
<h3>Min/Concat link dump:</h3>
<p><a href="http://developer.yahoo.com/performance/rules.html" target="_blank">Yahoo!: Best Practices For Speeding Up Your Website</a><br />
<a href="http://developer.yahoo.com/yui/compressor/" target="_blank">YUI Compressor</a><br />
<a href="http://code.google.com/closure/compiler/" target="_blank">Google Closure Compiler</a><br />
<a href="https://github.com/mishoo/UglifyJS/">UglifyJS</a><br />
<a href="http://requirejs.org/docs/optimization.html" target="_blank">r.js</a><br />
<a href="https://github.com/jrburke/almond" target="_blank">almond.js</a></p>
<h3>Other min-concat build systems</h3>
<p><a href="https://github.com/cjohansen/juicer" target="_blank">juicer: A command line tool for JavaScript and CSS developers.</a><em>(Incredible work and will probably use again at a later date)</em><br />
<a href="https://github.com/fat/smoosh" target="_blank">smoosh: something like a himalountain.</a> <em>(I personally liked using this)</em><br />
<a href="https://github.com/cowboy/grunt" target="_blank">grunt: A command line build tool for JavaScript projects.</a><br />
<a href="https://github.com/webpro/jaguarundi" target="_blank">jaguarandi: Ant build script to optimize and version Javascript, CSS, and HTML files</a><br />
<a href="https://github.com/tobie/modulr-node/" target="_blank">modulr-node: Resolves and concatenates CommonJS module dependencies for use in the browser.</a></p>
<h2>Deployment</h2>
<p>The last couple sections of research &#8211; headless test runners and min-concat optimization &#8211; were leading up to deployment. These two areas are outside of my development workflow and are part of my deployment workflow. Truth be told, I will probably incorporate running headless test on the optimized scripts as well to make sure that the compiler didn&#8217;t ming anything once in production, but for now I am putting trust in the fact that it does not &#8211; and any runtime errors that occur are due to my source code (it happens!). </p>
<p>In any event, here we stand with being tasked to fold in linting, testing, optimization and deployment. In the last section, I highlighted a few build systems I had come across as I was researching minification and concatenation of <strong>JavaScript</strong>, but I wanted to roll my own deployment script just so I can tailor it to my needs. I am not intending to provide it as an open source project as I feel it is very specific, but it is available and being continually developed from the <a href="https://github.com/bustardcelly/massroute-js/tree/master/massroute-examples/common" target="_blank">massroute-js github</a> if you are interested.</p>
<p>When it came to creating the build script(s), I sat for moment to think about the environment I wanted to use. I took under consideration what I thought should be considered of a client-side developer to have installed on her machine. Is it too much to ask to install <a href="http://nodejs.org/" target="_blank">node.js</a> or <a href="http://www.ruby-lang.org/en/" target="_blank">ruby</a> for the sole purpose of running a development/deployment script? Should I stick with old reliable <a href="http://ant.apache.org/" target="_blank">ANT</a> as it is pretty much accepted as a requirement for current and past projects? I answered &#8220;No&#8221; to both, though I do think the first question is a good discussion for another time; and I have written so many <strong>ANT</strong> build scripts that I wanted to do something different&#8230;</p>
<p>I settled on a simple <a href="http://www.gnu.org/software/make/manual/make.html" target="_blank">Makefile</a>, as it is quick and easy to understand and fulfills its current purpose:</p>
<pre class="brush: bash; first-line: 1; title: ;" title="">
# Lint - JSHint
LINT = ./build/lint/jshint
SRC_DIR = ./script

# Tests - PhantomJS
PHANTOM = ./build/phantom/phantomjs
PHANTOM_QUNIT_RUNNER = ./build/phantom/run-qunit.js
TEST_DIR = ./test
TEST_INDEX_URL = file://localhost/Users/todd/massroute_js/massroute-examples/common/test/index.html

# Min/Concat - r.js
R_JS = java -classpath ./build/rhino/js.jar:./build/closure/compiler.jar org.mozilla.javascript.tools.shell.Main
R_DIR = ./build/require

all: lint phantom optimize

lint:
	@echo '==&gt; JSHint $&lt;'
	@@for file in `find ${SRC_DIR} -name &quot;*.js&quot;`; \
		do echo ===Linting $$file...===; ${LINT} $$file; done;
	@echo

phantom:
	@echo '==&gt; Phantom $&lt;'
	${PHANTOM} ${PHANTOM_QUNIT_RUNNER} ${TEST_INDEX_URL};
	@echo

optimize:
	@echo '==&gt; r.js $&lt;'
	@@for file in `find ${R_DIR} -name &quot;*.build.js&quot;`; \
	   do echo ===r.js: $$file...===; ${R_JS} ${R_DIR}/r.js -o $$file; done;
	@echo
</pre>
<p>Certainly, this sort of <a href="http://www.gnu.org/software/make/manual/make.html" target="_blank">Makefile</a> is intended for the lead developer or automated system to run at deployment, rather than being shared across multiple developers during development as the constants are pretty system specific. If this development/deployment workflow were to introduced into a company workflow, I would probably opt for <a href="http://ant.apache.org/" target="_blank">ANT</a> or <a href="http://rake.rubyforge.org/" target="_blank">Rake</a> &#8211; which I intend to add to the repository at some point. As well, this deployment is simply just for JavaScript. I may find down the line that a more complete system is required which can optimize HTML, CSS, images, etc. and actually deploy files to a server. The playing field then widens and sticking with <strong>Make</strong> is probably not going to be the optimal solution, and I may rethink requiring <a href="http://nodejs.org/" target="_blank">node.js</a> or <a href="http://www.ruby-lang.org/en/" target="_blank">ruby</a> environments for deployment.</p>
<h2>Conclusion</h2>
<p>So there we have it. My current development and deployment workflow. Subject to change, as always. Decisions towards testing and optimization were definitely weighted with respect to my choice in <a href="https://github.com/amdjs/amdjs-api/wiki/AMD" target="_blank">AMD</a>, but I feel <a href="http://requirejs.org/" target="_blank">RequireJS</a> presents a strong enough case for modular development, so I am pretty confortable and happy with it at the moment. It was a great learning experience researching and testing all the various frameworks, libraries and systems in finding what worked and I appreciate the openness of the <strong>JavaScript</strong> community in releasing such quality and well-documented code; I hope to return the favor some day.</p>
<p>A quick round-up from the original listing of what i wanted to achieve, marked with the decision:</p>
<ul>
<li>AMD &#8211; <a href="http://requirejs.org/">RequireJS</a></li>
<li>Code Quality &#8211; <a href="http://www.jshint.com/">JSHint</a></li>
<li>Unit Testing &#8211; <a href="http://docs.jquery.com/QUnit">QUnit</a> &#038; <a href="http://www.phantomjs.org/">PhantomJS</a></li>
<li>Minification / Concatenation &#8211; <a href="https://github.com/jrburke/r.js/" target="_blank">r.js</a> (+<a href="http://code.google.com/closure/compiler/">Closure Compiler</a>)</li>
<li>Build / Deploy &#8211; <a href="http://www.gnu.org/software/make/manual/make.html">make</a></li>
</ul>
<p>cheers!</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/amd/" title="View all posts in AMD" rel="category tag">AMD</a>,  <a href="http://custardbelly.com/blog/category/jshint/" title="View all posts in JSHint" rel="category tag">JSHint</a>,  <a href="http://custardbelly.com/blog/category/javascript/" title="View all posts in JavaScript" rel="category tag">JavaScript</a>,  <a href="http://custardbelly.com/blog/category/phantomjs/" title="View all posts in PhantomJS" rel="category tag">PhantomJS</a>,  <a href="http://custardbelly.com/blog/category/qunit/" title="View all posts in QUnit" rel="category tag">QUnit</a>,  <a href="http://custardbelly.com/blog/category/requirejs/" title="View all posts in RequireJS" rel="category tag">RequireJS</a>,  <a href="http://custardbelly.com/blog/category/r-js/" title="View all posts in r.js" rel="category tag">r.js</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2012/02/07/current-workflow-developing-linting-testing-and-distributing-javascript/#comments" rev="post-513"  title="Comment on Current Workflow: Developing, Linting, Testing and Distributing JavaScript">3 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2012-02-07T10:53">February 7, 2012</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-513-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-496" class="post-496 post hentry category-javascript category-jquery category-knockoutjs full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2011/11/14/massroute-js-knockout-example/" title="Permanent link to massroute-js: knockout example" rel="bookmark" rev="post-496">massroute-js: knockout example</a></h1>
	
	<div class="entry-content full-content">
		<p><em>I have created a github repository at <a href="http://github.com/bustardcelly/massroute-js" target="_blank">http://github.com/bustardcelly/massroute-js</a> to explore various JavaScript libraries and frameworks with a focus of delivering a web-based application for <a href="http://www.eot.state.ma.us/developers/realtime/" target="_blank">real-time transportation data made available from MassDOT</a>. This article intends to address my findings in an exploration of one of those libraries or frameworks that have caught my interest. If you have any suggestions for another <strong>JavaScript</strong> library/framework please leave a comment.</em></p>
<p><em>It should also be noted that some explanations may be heavily influenced by my experience in developing for the <strong>Flash Platform</strong> and particularly their relation to the <strong>ActionScript</strong> and the <strong>Flex</strong> mark-up language.</em></p>
<p>The massroute-js example using Knockout can be found at: <a href="http://github.com/bustardcelly/massroute-js/tree/master/massroute-examples/" target="_blank">http://github.com/bustardcelly/massroute-js/tree/master/massroute-examples/</a></p>
<p>The initial draw to test out the <a href="http://knockoutjs.com/" target="_blank">Knockout</a> library was its basis on the <a href="http://en.wikipedia.org/wiki/Model_View_ViewModel" target="_blank">Model-View-View Model</a> (MVVM) architectural pattern. I won&#8217;t go into to much detail about what MVVM is and what it can provide, as there are already many good explanations out there; I will just quickly point you to <a href="http://en.wikipedia.org/wiki/Model_View_ViewModel" target="_blank">wikipedia</a> and its <a href="http://knockoutjs.com/documentation/observables.html#mvvm_and_view_models" target="_blank">explanation on the Knockout site directly</a>. If you are not up for clicking those links, MVVM is an architectural design pattern &#8211; like <a href="http://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller" target="_blank">Model-View-Controller</a> (MVC) &#8211; but is similar to the <a href="http://martinfowler.com/eaaDev/uiArchs.html" target="_blank">Model-View-Presenter</a> (MVP) pattern. In basic terms, the ViewModel of MVVM is similar to the Presenter of MVP in so much as the View is responding to changes on an abstraction of the Model rather than directly on the Model. However, they differ in that the ViewModel is an abstraction of not only the properties of the Model but also provides an API that reflects the actions taken by a View that in turn affect the state of the Model; the Presenter from MVP has more of a role in being knowledgable about the View directly &#8211; subscribing to events and accessing the View&#8217;s API. These are both markedly different from the MVC approach in which the Controller is only responsible for updating the Model in response to user actions on the View &#8211; providing an indirect relationship of the View to the Controller in which the state of the View is directly related to the state of the Model.</p>
<h3>Data Binding and Observables</h3>
<p>At the heart of <a href="http://knockoutjs.com/" target="_blank">Knockout</a>&#8217;s MVVM implementation is <em>data binding</em>. If you stumbled upon here and are coming from the Flex world, the concept of data binding is probably all too familiar. In basic terms, data binding is a process in which one party, bound to a change on another party, is automatically updated to reflect that change when it occurs. Most notably, data binding is utilized in updating UI that is bound to a model representing state. </p>
<p>In broader terms, data binding utilizes the <strong>Observer Pattern</strong>. If you are familiar with subscribing to events and assigning handlers that respond to change in UI, then you are already aware of using an <strong>Observer</strong>. Within the implementation of the data binding concept, the subscription and publishing mechanisms are hidden away and as a change to the <em>subject</em> (the one subscribed to) occurs, they change is published to a <em>dependent</em> (the subscriber). What i mean by &#8220;hidden away&#8221; is that you as a developer do not directly establish this relationship by setting up event listeners and implementing the logic in response to a change in state. Libraries that allow for data binding provide a way in which you can establish this relationship which is then wired behind the scenes. Again, if you are coming from the Flex world, this is familiar in the use of curly brackets ({}) in-line in your MXML or (my preference) the methods of the <em>BindingUtils</em> class.</p>
<p>Using Knockout, you define <em>observables</em> which dispatch notifications when changes to a value occur. Properties on a ViewModel are defined with observables to which an element can be bound, creating a dependency that is reflected in the rendering of the UI. Let&#8217;s get away from wordy word-words and see an implementation of a ViewModel and how it relates to declarations of elements on the DOM. At the core you will have your model object that defines &#8211; among other things &#8211; the <strong>observables</strong>:</p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
var model = {
    title: ko.observable('Hello World'),
    items: ko.observableArray()
};
</pre>
<p>If your dependency is on value change to one object &#8211; whether it be a string, number, boolean, object, etc. &#8211; you use <em>ko.observable</em> as defined in this example for the <em>title</em> property on the <strong>model</strong> object.  If you want to detect and notify of changes to a collection of objects, you use <em>ko.observableArray</em>.  You can also define <strong>dependent observables</strong> which are properties that are updated based on the value of other observables. Just a quick example of dependent observables:</p>
<pre class="brush: jscript; title: ;" title="">
model.greeting = ko.dependentObservable( function() {
    return this.title + ', how are ya?';
}, model );
</pre>
<p>These observables and their notifications are then managed once you register the model:</p>
<pre class="brush: jscript; title: ;" title="">
ko.applyBindings( model );
</pre>
<p>On the HTML side, you use the datasets to define the binding definitions. <a href="http://knockoutjs.com/" target="_blank">Knockout</a> recognizes the <strong>data-bind</strong> attribute on elements of the DOM and &#8211; in broad, general terms &#8211; evaluates the attribute value as a binding expression. As a quick example of how this would look in using the model from the previous examples, the mark-up would look something like the following:</p>
<pre class="brush: xml; first-line: 1; title: ;" title="">
&lt;header&gt;
    &lt;hgroup&gt;
        &lt;h1 data-bind=&quot;text: title&quot;&gt;&lt;/h1&gt;
        &lt;h2 data-bind=&quot;text: greeting&quot;&gt;&lt;/h2&gt;
    &lt;/hgroup&gt;
&lt;/header&gt;
&lt;section&gt;
    &lt;nav&gt;
        &lt;ul data-bind='foreach: items'&gt;
            &lt;li class='list-item'&gt;
            	&lt;a data-bind=&quot;attr: {href:url}, text: label&quot;&gt;&lt;/p&gt;
            &lt;/li&gt;
        &lt;/ul&gt;
    &lt;/nav&gt;
&lt;/section&gt;
</pre>
<p>As changes to the <em>title</em> property on the model occur, both items in the header group will be updated on the DOM (<em>greeting</em> because of its dependency on <em>title</em>), and as the <em>item</em> collection changes so will the un-order list, with the declared list item serving as the item renderer to be used in adding child elements to the list (more on that in the next section).</p>
<p>Properties are updated by <em>invoking</em> the observable. That may seem a little strange at first, as you are probably more familiar with updating object properties using the = expression. But the properties, once declared as <em>ko.observables</em>, are actually not the primitive objects they represent and are functions themselves. So if we were to update the properties on the model in the previous examples, that would be done as in the following:</p>
<pre class="brush: jscript; title: ;" title="">
model.title( 'Hello Again' );
model.items( [
    {label:'foo', url:'http://foo.com'},
    {label:'bar', url:'http://bar.com'}
] );
</pre>
<p>And that is important to remember, as the same goes for accessing the property value. Accessing <strong>model.title</strong> will actually return the observable function, not the string value. To get the underlying value, you use <em>ko.utils.unwrapObservable</em>, as in the following example:</p>
<pre class="brush: jscript; title: ;" title="">
var titleValue = ko.utils.unwrapObservable( model.title() );
</pre>
<p>You can also subscribe to changes explicitly in JavaScript, and if you are coming from the Flex world, this is pretty much like the BindingUtils:</p>
<pre class="brush: jscript; title: ;" title="">
var itemSubscription = model.items.subscribe( function( collection ) {
    // do something really cool that will win you friends and influence others.
});
...
// No longer need to win friends and influence others.
itemSubscription.dispose()
</pre>
<p>That is just a birds-eye-view quick run-down of how the view model plays a part in knockout, and i really encourage you to check out the document on their site to see all of what is capable: <a href="http://knockoutjs.com/documentation/introduction.html" target="_blank">http://knockoutjs.com/documentation/introduction.html</a>.</p>
<h3>Control Flow</h3>
<p>If you&#8217;ve looked at those examples or are familiar with <a href="https://github.com/SteveSanderson/knockout" target="_blank">Knockout</a> and have checked out the <a href="https://github.com/bustardcelly/massroute-js/tree/master/massroute-examples/knockout" target="_blank">massroute-js/knockout example I put on github</a>, you might see that things are set up a bit different. Indeed they are; I had begun my example using knockout-1.2.1.js, but had found this post toward the end of my finishing the example: <a href="http://blog.stevensanderson.com/2011/08/31/knockout-1-3-0-beta-available/" target="_blank">http://blog.stevensanderson.com/2011/08/31/knockout-1-3-0-beta-available/</a>. I was so taken with the changes to <em>Control Flow Bindings</em>, that I moved my example to that. If this is all new to you and that last sentence was complete gibberish, I&#8217;ll explain; I just wanted to give a heads up if any of you were curious enough to check out their current examples and look at <a href="https://github.com/bustardcelly/massroute-js/tree/master/massroute-examples/knockout" target="_blank">my project on github</a>.</p>
<p>What I take away from the concept of <em>Control Flow Binding</em>, is that you can define (and Knockout with manage) the existence of DOM elements based on a ViewModel condition. If you are coming from the Flex world, you can think of it somewhat in terms of the State API and state-based declarations for elements, such as <em>includeIn</em> and <em>excludeFrom</em>. But it goes a little farther in that, in so much as it is also allows for and is used in rendering whole graphs of DOM elements based on a condition and model data. A common example is lists, and the UI elements you define are the item renderers &#8211; depending on the existence of a collection, graphs of defined HTML elements are rendered, added to the DOM and handed data.</p>
<p>Prior to the current work on <a href="http://knockoutjs.com/" target="_blank">Knockout</a> that is in beta and <a href="https://github.com/SteveSanderson/knockout" target="_blank">available from the projects github</a>, there was a dependency on an external templating engine &#8211; for example, <a href="http://api.jquery.com/category/plugins/templates/" target="_blank">jquery-tmpl</a> which was commonly the go-to engine since there is already a dependency on <a href="http://jquery.com/" target="_blank">jQuery</a> -that would allow you to define UI elements to use in deferred rendering within the Control Flow and state of the target ViewModel. In the <a href="https://github.com/SteveSanderson/knockout/tree/master/build/output" target="_blank">latest beta for Knockout</a>, you can now declare those elements inline within the document and the library will handle the existence and rendering based on the defined condition.</p>
<p>To give a quick example, here is the whole section in the <a href="https://github.com/bustardcelly/massroute-js/tree/master/massroute-examples/knockout" target="_blank">massroute-js/knockout</a> project that displays the list of routes available from the real-time MBTA feed:</p>
<pre class="brush: xml; first-line: 1; title: ;" title="">
&lt;section id=&quot;routesection&quot; data-bind=&quot;visible: routes.visible&quot;&gt;
    &lt;h1 data-bind=&quot;text: routes.title&quot;&gt;&lt;/h1&gt;
    &lt;p data-bind=&quot;if: routes.list().length === 0&quot;&gt;loading...&lt;/p&gt;
    &lt;nav data-bind=&quot;if: routes.list().length &gt; 0&quot;&gt;
        &lt;ul data-bind='foreach: routes.list'&gt;
            &lt;li class='route-item list-item icon-list-item' style='cursor: pointer;'&gt;
                &lt;figure&gt;
                    &lt;img src='style/image/bus_icon.png' /&gt;
                    &lt;figcaption data-bind=&quot;text: title&quot;&gt;&lt;/figcaption&gt;
                &lt;/figure&gt;
            &lt;/li&gt;
        &lt;/ul&gt;
    &lt;/nav&gt;
&lt;/section&gt;
</pre>
<p>If this is example you are seeing that utilizes the <a href="http://knockoutjs.com/">Knockout</a> library, i will just quickly mention that Knockout recognizes the <em>data-bind</em> attribute and interprets the value as an expression allowing you to associated DOM elements with a ViewModel declaratively. It is too much of a discussion to go into the dataset attribute and their usage, but wanted to give a brief explanation of how it is relevant to this snippet and will now defer you to this documentation: <a href="http://dev.w3.org/html5/spec/Overview.html#embedding-custom-non-visible-data" target="_blank">http://dev.w3.org/html5/spec/Overview.html#embedding-custom-non-visible-data</a></p>
<p>To get a clearer picture of <em>Control Flow</em> and element templating, take a look at the &lt;ul&gt; and &lt;li&gt; fragments of this example. A <em>foreach</em> is declared on the binding for the <strong>ul</strong> element, which in turn will render a new instance of the list item declared within the ul for this example. In simpler terms, this allows us to define the item renderer for the list declaratively inline within the control flow definition. A pretty cool addition to the library, and one in which, even though i am just test-driving Knockout, warranted me using <a href="https://github.com/SteveSanderson/knockout/tree/master/build/output" target="_blank">Knockout 1.3.0 beta</a> to do away with using another dependency on a template engine.</p>
<p>There are also some other additions to the library which I am excited to try out, most notably Binding Providers and Throttling. Check out this post from <a href="http://blog.stevensanderson.com/" target="_blank">Steven Sanders</a> about <a href="https://github.com/SteveSanderson/knockout/tree/master/build/output" target="_blank">Knockout 1.3.0 Beta</a>: <a href="http://blog.stevensanderson.com/2011/08/31/knockout-1-3-0-beta-available/" target="_blank">http://blog.stevensanderson.com/2011/08/31/knockout-1-3-0-beta-available/</a>.</p>
<h3>Links</h3>
<p>I encourage you to check out the Knockout home page at <a href="http://knockoutjs.com/">http://knockoutjs.com/</a> and the awesome interactive tutorials they have available at <a href="http://learn.knockoutjs.com" target="_blank">http://learn.knockoutjs.com</a>. You can also checkout the latest developments from github &#8211; <a href="https://github.com/SteveSanderson/knockout">https://github.com/SteveSanderson/knockout</a> &#8211; and, again, check out what is coming in the next version from this nice article: <a href="http://blog.stevensanderson.com/2011/08/31/knockout-1-3-0-beta-available/">http://blog.stevensanderson.com/2011/08/31/knockout-1-3-0-beta-available/</a>.</p>
<p>You can checkout the rest of my massroute-js/knockout example on github here: <a href="https://github.com/bustardcelly/massroute-js/tree/master/massroute-examples/knockout">https://github.com/bustardcelly/massroute-js/tree/master/massroute-examples/knockout</a>. Questions, comments and constructive berating are welcome (though not so much the last one).</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/javascript/" title="View all posts in JavaScript" rel="category tag">JavaScript</a>,  <a href="http://custardbelly.com/blog/category/jquery/" title="View all posts in jquery" rel="category tag">jquery</a>,  <a href="http://custardbelly.com/blog/category/knockoutjs/" title="View all posts in knockoutjs" rel="category tag">knockoutjs</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2011-11-14T10:07">November 14, 2011</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-496-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-502" class="post-502 post hentry category-air category-as3 category-flash category-flex category-flex-4 category-flex-4-5 full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2011/11/11/deferred-content-for-flex-4-group-using-defaultproperty/" title="Permanent link to Deferred content for Flex 4 Group using [DefaultProperty]" rel="bookmark" rev="post-502">Deferred content for Flex 4 Group using [DefaultProperty]</a></h1>
	
	<div class="entry-content full-content">
		<p>Thought i would <a href="https://gist.github.com/1340472" target="_blank">share a little gist</a> with you about a solution i whipped up with regards to deferred content in a Flex 4 <strong>Group</strong> container. </p>
<p>If there are numerous children within a container and their style definitions are rather complex, there may be some lag within the rendering cycle. Though it may not cause the <strong>Flash Player</strong> to time-out or even invoke the beachball/hourglass of the user&#8217;s system, any perceived lag in rendering that is a considerable amount (to be discussed at a later date) could send the user packing if not in the very least curious as to the reliability of the application; needless to say, most UI heavy applications are those in which a user interacts heavily with the application in order to get something accomplished.</p>
<p>Setting UX/design decisions aside and trusting that optimizations &#8211; such as absolute positioning &#8211; are being used where appropriate, there still may come a time where the task at hand calls for a lengthly child list within a container, or even a rather small list with a heavy render cycle due to customization. In such a situation, having the ability to defer rendering is a great improvement to the perceived &#8220;snappiness&#8221; of your application.</p>
<p>Back in the Flex 3 days &#8211; well, i shouldn&#8217;t say &#8220;back&#8221; as the <strong>MX</strong> containers are still available in the SDK and i am sure there are still people working on Flex 3 whether grudgingly or not &#8211; the <strong>MX</strong> containers had a property called <a href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/mx/core/Container.html#creationPolicy" target="_blank"><em>creationPolicy</em></a>. This allowed a developer to define the how the container was to render its children &#8211; basically, whether it should build its display tree upon creation of the container or defer. If you deferred it by setting the property to <em>ContainerCreationPolicy.NONE</em>, you could at anytime within the life of the application call <em>createComponentsFromDescriptors()</em> on that container to have its children be created.</p>
<p>Now it should be noted that this functionality is at parity in Flex 4.x, yet only available to <strong>SkinnableContainers</strong> &#8211; and more accurately those that implement <a href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/mx/core/IDeferredContentOwner.html#propertySummary" target="_blank"><strong>IDeferredContentOwner</strong></a>. Those containers within the Flex 4 SDK which are considered lighter-weight, such as <strong>Group</strong> and <strong>DataGroup</strong>, do not play host to skins or define style properties for graphical backgrounds but they also do not support deferred content inherently either.</p>
<p>I should stop here and say that even though <strong>Group</strong> and <strong>DataGroup</strong> are in the same boat as not being privy to a <em>creationPolicy</em>, the example code should really only be translated to a <strong>Group</strong> container. Deferred content for a <strong>DataGroup</strong> should be left to its defined layout and its properties. That said, there is a way to defer the child element creation of a <strong>Group</strong> rather simply; that is by utilizing the <strong>[DefaultProperty]</strong> metadata.</p>
<p>You can see the full <a href="https://gist.github.com/1340472" target="_blank">gist of the moving pieces on my github</a>, but just to give a quick example and rundown:</p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
package
{
    import flash.events.Event;

    import mx.events.FlexEvent;

    import spark.components.Group;

    /**
     * Use the deferredElements property as the modifier that is handed the list of IVisualElements defined in MXML.
     */
    [DefaultProperty(&quot;deferredElements&quot;)]

    /**
     * Group container extension in order to do deferred child element attachment.
     */
    public class DeferredGroup extends Group
    {
        protected var _elementAddQuota:int = 10;

        /* IVisualElement[] */
        protected var _deferredElements:Array;
        protected var _deferredElementsChanged:Boolean;

        protected var _deferredElementAttacher:IDeferredElementAttacher;

        public function DeferredGroup()
        {
            super();
        }

        /**
         * @inheritDoc
         */
        override protected function commitProperties():void
        {
            super.commitProperties();
            if( _deferredElementsChanged )
            {
                queueDeferredElements();
                _deferredElementsChanged = false;
            }
        }

        /**
         * Defines and executes the IDeferredElementAttacher implementation used in queue-ing up &quot;packs&quot;
         * of IVisualElement instances declared in MXML and assigned as deferredElements.
         */
        protected function queueDeferredElements():void
        {
            // Define IDeferredElementAttacher and listen for completion on attach of all elements within deferredElements.
            _deferredElementAttacher = new FrameDeferredElementAttacher( this );
            _deferredElementAttacher.addEventListener( Event.COMPLETE, handleDeferredAttachmentComplete, false, 0, true );

            // &quot;Chunk&quot; up lists of IVisualElements based on limit quota.
            var i:int;
            var startIndex:int;
            var endIndex:int;
            var length:int = _deferredElements.length;
            var count:int = Math.ceil(length / _elementAddQuota);
            for( i = 0; i &lt; count; i++ )
            {
                startIndex = i * _elementAddQuota;
                endIndex = startIndex + _elementAddQuota;
                endIndex = ( endIndex &gt; length ) ? length : endIndex;
                _deferredElementAttacher.addElementPack( _deferredElements.slice( startIndex, endIndex ) );
            }
            _deferredElementAttacher.start();
        }

        /**
         * Event handler for completion from the IDeferredElementAttacher instance.
         * @param evt Event
         */
        protected function handleDeferredAttachmentComplete( evt:Event ):void
        {
            // Kill reference.
            _deferredElementAttacher.removeEventListener( Event.COMPLETE, handleDeferredAttachmentComplete, false );
            _deferredElementAttacher.dispose();
            _deferredElementAttacher = null;

            // -&gt; Do whatever you normally would do in a handler for CREATION_COMPLETE.
        }

        /**
         * The amount of IVisualElements to &quot;chunk&quot; into packets for deferred queue.
         * @return int
         */
        public function get elementAddQuota():int
        {
            return _elementAddQuota;
        }
        public function set elementAddQuota( value:int ):void
        {
            _elementAddQuota = value;
        }

        /**
         * The DefaultProperty array of IVisualElements declared in MXML markup.
         * @return Array Required to be IVisualElement[]
         */
        public function get deferredElements():Array
        {
            return _deferredElements;
        }
        public function set deferredElements( value:Array ):void
        {
            if( _deferredElements == value ) return;

            _deferredElements = value;
            _deferredElementsChanged = true;
            invalidateProperties();
        }
    }
}
</pre>
<p>Essentially, I have defined the <strong>[DefaultProperty]</strong> to be the <em>deferredElements</em> property. By default, any Flex container&#8217;s <strong>[DefaultProperty]</strong> is the <em>mxmlContent</em> property. If left to default, anything declared in MXML within the container declaration is handed to the <em>mxmlContent</em> property which in turn is used to add the children to the container using ActionScript at a later time within its instantiation cycle. Just as an example, the <strong>Label</strong> and <strong>Button</strong> of the <strong>Group</strong> container defined in this MXML can be considered the array of <strong>IVisualElements</strong> known to the parent <strong>Group</strong> as <em>mxmlContent</em>.</p>
<pre class="brush: xml; first-line: 1; title: ;" title="">
&lt;s:Group&gt;
    &lt;s:Label text=&quot;Hello, World&quot; /&gt;
    &lt;s:Button label=&quot;foo&quot; /&gt;
&lt;/s:Group&gt;
</pre>
<p>&#8230; and same goes for Flex 3 containers. Not much has changed, aside form non-parity in <em>creationPolicy</em> on Flex 4 containers that don&#8217;t implement <strong>IDeferredContentOwner</strong>. However, in the example provided above and in the <a href="https://gist.github.com/1340472" target="_blank">gist</a>, the declared children in MXML aren&#8217;t handed to the <em>mxmlChildren</em>, but rather the <em>deferredChildren</em>. Because of this, we can then check if we have deferred content upon a pass to <em>invalidationProperties()</em> and act accordingly &#8211; as is done by invoking <em>queueDeferredElements</em>() in the example:</p>
<pre class="brush: jscript; first-line: 48; title: ;" title="">
/**
 * Defines and executes the IDeferredElementAttacher implementation used in queue-ing up &quot;packs&quot; of IVisualElement instances declared in MXML and assigned as deferredElements.
 */
protected function queueDeferredElements():void
{
    // Define IDeferredElementAttacher and listen for completion on attach of all elements within deferredElements.
    _deferredElementAttacher = new FrameDeferredElementAttacher( this );
    _deferredElementAttacher.addEventListener( Event.COMPLETE, handleDeferredAttachmentComplete, false, 0, true );

    // &quot;Chunk&quot; up lists of IVisualElements based on limit quota.
    var i:int;
    var startIndex:int;
    var endIndex:int;
    var length:int = _deferredElements.length;
    var count:int = Math.ceil(length / _elementAddQuota);
    for( i = 0; i &lt; count; i++ )
    {
        startIndex = i * _elementAddQuota;
        endIndex = startIndex + _elementAddQuota;
        endIndex = ( endIndex &gt; length ) ? length : endIndex;
        _deferredElementAttacher.addElementPack( _deferredElements.slice( startIndex, endIndex ) );
     }
     _deferredElementAttacher.start();
}
</pre>
<p>And in that method, an <strong>IDeferredElementAttacher</strong> (non-SDK, part of the <a href="https://gist.github.com/1340472" target="_blank">gist</a>) implementation is used to queue up smaller arrays of child elements and dequeued to start adding children to the target container. In this example that implementation is a <strong>FrameDeferredElementAttacher</strong> instance which waits a frame to move along in its queue. Included in the <a href="https://gist.github.com/1340472" target="_blank">gist</a> is also one for timer-based element addition.</p>
<p>This post got rather long as far as just wanting to show off how to defer child content of a <strong>Group</strong> container in Flex 4, but I just wanted to bring light my solution as there is no parity of <em>creationPolicy</em> on non-<strong>IDeferredContentOwner</strong> containers in the SDK.</p>
<p>See the whole gist here: <a href="https://gist.github.com/1340472">https://gist.github.com/1340472</a>.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/air/" title="View all posts in AIR" rel="category tag">AIR</a>,  <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>,  <a href="http://custardbelly.com/blog/category/flex-4/" title="View all posts in Flex 4" rel="category tag">Flex 4</a>,  <a href="http://custardbelly.com/blog/category/flex-4-5/" title="View all posts in Flex 4.5" rel="category tag">Flex 4.5</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2011/11/11/deferred-content-for-flex-4-group-using-defaultproperty/#comments" rev="post-502"  title="Comment on Deferred content for Flex 4 Group using [DefaultProperty]">2 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2011-11-11T15:50">November 11, 2011</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-502-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-486" class="post-486 post hentry category-javascript category-dojo category-massroute-js full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2011/10/04/massroute-js-dojo-example/" title="Permanent link to massroute-js: dojo example" rel="bookmark" rev="post-486">massroute-js: dojo example</a></h1>
	
	<div class="entry-content full-content">
		<p><em>I have created a github repository at <a href="http://github.com/bustardcelly/massroute-js" target="_blank">http://github.com/bustardcelly/massroute-js</a> to explore various JavaScript libraries and frameworks with a focus of delivering a web-based application for <a href="http://www.eot.state.ma.us/developers/realtime/" target="_blank">real-time transportation data made available from MassDOT</a>. This article intends to address my findings in an exploration of one of those libraries or frameworks that have caught my interest. If you have any suggestions for another <strong>JavaScript</strong> library/framework please leave a comment.</em></p>
<p><em>It should also be noted that some explanations may be heavily influenced by my experience in developing for the <strong>Flash Platform</strong> and particularly their relation to the <strong>ActionScript</strong> and the <strong>Flex</strong> mark-up language.</em></p>
<p>As far as <strong>JavaScript</strong> libraries that go beyond providing an abstraction layer/decorator to the <strong>DOM</strong> and a facade for <strong>AJAX</strong> requests &#8211; such as one would find with <a href="http://jquery.com" target="_blank">jQuery</a> &#8211; I have been interested in digging into <a href="http://dojotoolkit.org/" target="_blank">Dojo</a> for some time. I should state that I am in no way knocking <strong>jQuery</strong>. It works extremely well at what it purports to do. I do, however, have an interest in how to &#8220;maintain&#8221; an application written in <strong>JavaScript</strong> in as much as not only adhering to architectural patterns but code organization and dependency management. That is not to say you could not work with another library that incorporates or works laterally with <strong>jQuery</strong> for such support; I am also interested in those libraries that provide more of a unified application structure alongside <strong>AJAX</strong> and <strong>DOM</strong> access. Enough defending <strong>jQuery</strong>&#8230;</p>
<p>For many reasons <a href="http://dojotoolkit.org/" target="_blank">Dojo</a> caught my eye because not only does it provide <strong>DOM</strong> access/manipulation through abstraction (as well as using <a href="http://sizzlejs.com/" target="_blank">Sizzle</a> as the selector engine, as <strong>jQuery</strong> does) but dependency management through a modular package system, as well. What that really means is that I can organize my scripts in a directory tree structure, and define classes and their dependencies using the provide/declare/require API of <a href="http://dojotoolkit.org/" target="_blank">Dojo</a>. This allows for a common &#8220;package structure&#8221; and resolves to namespaced objects at runtime (or <em>build time</em>- maybe more on that later), providing a modular-approach to building a <strong>JavaScript</strong> application.</p>
<p><em>The example was built against <strong>Dojo 1.6.1</strong>, so any further explanations in this post are dependent on my knowledge working with the Dojo library at that version.</em></p>
<h2>Modules</h2>
<p>Now, truth be told, I utilized the <strong>Dojo</strong> module dependency system as I would with declaring and importing classes. This is mainly because of my experience with languages that are class-based (or provide a class &#8220;structure&#8221;) and that <strong>Dojo</strong> provides an elegant and easy way for class declaration and inheritance on top of the prototypical nature of <strong>JavaScript</strong>. So my modules really became more like classes or groupings of common classes &#8211; which is perfectly acceptable to me and how I would prefer to work &#8211; but it should be noted (if you were to look at <a href="htts://github.com/bustardcelly/massroute-js" target="_blank">the example in the github repo</a>) that modules are not restricted to only declaring classes.</p>
<p>Just to provide a quick example of what i mean by treating modules as independent classes or a grouping of common classes, let&#8217;s look at an abbreviated version of the main context module (script file) for the application:</p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
dojo.provide( &quot;context.massroute&quot; );
dojo.require( &quot;model.session&quot; );

dojo.declare( &quot;context.massroute.MassRouteContext&quot;, null, {
    constructor: function() {
        this.session = new model.session.Session();
    }
}
</pre>
<p>The value within a <em>dojo.provide()</em> invocation creates (if not previously existant) a namespaced object on global (window) scope and caches the reference within <em>dojo._loadedModules</em> with the property value of the string argument (&#8221;context.massroute&#8221; in this example). Essentially this sets up a &#8220;package&#8221; structure for your declarations with access to classes once a module has been requested and loaded. </p>
<p>Modules are loaded using<em> dojo.require()</em>. The <em>dojo.require()</em> states a dependency on another module. For this example, <strong>Dojo</strong> is requested to load the &#8220;model.session&#8221; module. More on the association between files and package declarations in a bit, but for now know that if &#8220;model.session&#8221; is not found on the <em>dojo._loadedModules</em> cache, a request for <strong>/model/session.js</strong> will be made. Once loaded, it would go through much of what is currently being covered in this example: defining namespace, loaded dependencies and declaring classes. If we were to open the <strong>/model/session.js</strong> file found the application script source, we would find a <em>dojo.declare()</em> for the <strong>model.session.Session</strong> class.</p>
<p>With each <em>dojo.declare()</em> within the provided namespace, the objects on the direct global scope and within <em>dojo._loadedModules</em> are updated to hold reference to the class, which essentially allows you to create a new instance of a class as one normally would:</p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
var context = new context.massroute.MassRouteContext();
</pre>
<p>// declare explanation<br />
The <em>dojo.declare()</em> takes three arguments:</p>
<ul>
<li>className: defines the associated name for the class within the package/namespace.</li>
<li>inheritance: defines the classes to &#8220;mixin&#8221; to your class. This can be null, a single class reference or an array of class references. The class reference(s) can be thought of as base or multiple inheritance if defined.</li>
<li>properties: defines the object that encapsulates all the logic particular to the class</li>
</ul>
<p><em>The inheritance I found of particular note as dojo provides an easy way to call super methods. Essentially, within the scope of the override method of a subclass you can call this.inherited(arguments).</em></p>
<p>To get a better understanding of how this all works and what is modified as modules are loaded and classes declared, if we suppose that this module is requested to be loaded in the current domain, the global object will be modified to reflect the following:</p>
<pre class="brush: jscript; title: ;" title="">
[window] {
    dojo: {
        _loadedModules: {
            &quot;context.massroute&quot;: {
                &quot;MassRouteContext&quot;: function() { ... };
            }
            &quot;model.session&quot;: {
                &quot;Session&quot;: function() { ... };
            }
        }
    }
    context: {
        massroute: {
            MassRouteContext: function() { ... };
        }
    }
    model: {
        session: {
            Session: function() { ... };
        }
    }
}
</pre>
<p>That gives a little insight into <strong>Dojo</strong>&#8217;s nested namespace pattern and how access to classes is provided, as well as how <strong>Dojo</strong> manages caching of previously requested dependencies.</p>
<p>Just for kicks, if we translated this example over to ActionScript it would be read as this:</p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
package context.massroute {
    import model.session.Session;

    class MassRouteContext {
        public var session:Session;

        function MassRouteContext() {
            session = new Session();
        }
    }
}
</pre>
<p>I touched on it briefly before, but you may be wondering how dojo knows how to associated these namespaces with modules to load within its package system. By default, <strong>Dojo</strong> will assume that a file with the name of the ending namespace resides in a relative location of its request &#8211; meaning, if my main <strong>index.html</strong> file resides at the root of the directory, when I <em>dojo.require(&#8221;context.massroute&#8221;)</em>, <strong>dojo</strong> will make a request for <strong>./context/massroute.js</strong> if the path to that module is not defined. If you have taken a look at the example in my github repo, you may notice that <strong>/content/massroute.js</strong> is not located at the root but in a parenting directory describing the scripts for my application.</p>
<p>You can define the path to your modules by declaring a global <em>dojoConfig</em> object prior to load of the <strong>Dojo</strong> library. An abbreviated version of what that would be for the example above:</p>
<pre class="brush: xml; first-line: 22; title: ;" title="">
&lt;script&gt;
    dojoConfig = {
      baseUrl: './',
      modulePaths : {
            app : &quot;js/app&quot;,
            context: &quot;js/app/context&quot;,
            model: &quot;js/app/model&quot;
        }
    };
&lt;/script&gt;
&lt;script src=&quot;http://ajax.googleapis.com/ajax/libs/dojo/1.6.1/dojo/dojo.xd.js&quot;&gt;&lt;/script&gt;
</pre>
<p>This defines the base URL for the directories defined in <strong>modulePaths</strong>. Now when you <em>dojo.require( &#8220;context.massroute&#8221; )</em>, <strong>dojo</strong> will look up the associated directory for the context namespace and request to load <strong>massroute.js</strong>. Once loaded, it is important to note that the file isn&#8217;t inserted into a script tag which is a common practice for script loaders. It is actually run through <em>dojo.eval()</em> which creates namespaced objects on  <strong>global</strong> and <strong>dojo</strong> scopes as described above.</p>
<h3>Some Caveats</h3>
<p>There are some things that I didn&#8217;t immediately realize or think of off-hand that may be of interest to those of you whether or not you come from a class-based language:</p>
<ul>
<li>Anything you think is defined privately to the &#8220;class&#8221; in the constructor using <em>dojo.declare()</em> is actually set at global scope.</li>
<li>No such things as private members to the class. Prepending members with &#8220;<strong>_</strong>&#8221; is the convention to &#8220;convey&#8221; to developers that a member is private.</li>
</ul>
<p>There is a way around this whole private member business, however. If you are in dire need to keep something private, you can use an <a href="http://benalman.com/news/2010/11/immediately-invoked-function-expression/" target="_blank">Immediately Invoked Function Expression</a> (<strong>IIFE</strong>) to define your private members as well as the class, such as:</p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
dojo.provide( &quot;context.massroute&quot; );
dojo.require( &quot;model.session&quot; );

(function() {
    var _session = new model.session.Session();
    dojo.declare( &quot;context.massroute.MassRouteContext&quot;, null, {
        constructor: function() {
            console.info( _session );
        }
    }
}
)();
</pre>
<p>It should also be noted that you don&#8217;t have to use <em>dojo.declare()</em> at all to get the same structure. Essentially &#8211; from what I gather &#8211; under the hood, the library does the following (in as far as constructing the namespace) which you are perfectly welcome to do as well in a module and can help with your private requirements using a mix of <strong>IIFE</strong> and the <a href="http://javascript.crockford.com/private.html" target="_blank">Constructor Pattern</a>:</p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
dojo.require( &quot;model.session&quot;);

(function() {
    if( !dojo._hasResource[&quot;context&quot;] ) {
        dojo._hasResource[&quot;context&quot;] = true;
        dojo.context = {};
    }
    if( !dojo._hasResource[&quot;context.massroute&quot;] ) {
        dojo._hasResource[&quot;context.massroute&quot;] = true;
        dojo.provide( &quot;context.massroute&quot; );

        context.massroute.MassRouteContext = function() {
            var _session = new model.session.Session();
            return {
                getSession: function() {
                    return _session;
                }
            }
        }
    }
})();
</pre>
<p>Obviously, going that route, you will miss the niceties that <strong>Dojo</strong> provides in class inheritance but just throwing it out there.</p>
<h2>Events</h2>
<p><strong>Dojo</strong>&#8217;s event system was another part of the framework i enjoyed. Using <em>dojo.connect()</em> and <em>dojo.disconnect()</em> you could easily assign and remove event handling (delegate functions) to <strong>DOM</strong> events on a target scope, respectively. And, because <em>dojo.connect()</em> returned a connect object, it conveniently made it possible to disconnect all connection I may have set up in a view controller that was going to be trashed:</p>
<pre class="brush: jscript; title: ;" title="">
var connections = [];
connections.push( dojo.connect( dojo.byId('submitButton'), 'onclick', handleSubmitRequest ) );
connections.push( dojo.connect( dojo.byId('cancelButton'), 'onclick', handleCancelRequest ) );
...
dojo.forEach( connections, dojo.disconnect );
</pre>
<p>It should be noted that when using <em>dojo.connect()</em> you are not limited to just <strong>DOM</strong> events. You can connect to &#8220;custom&#8221; events on non-<strong>DOM</strong> objects. To do so, the second argument is actually the function on the target object that you wish to &#8220;listen&#8221; for invocation of. As a quick example:</p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
var test = function() {
    return {
        run: function() {
            setTimeout( this.onTimeout, 1000 );
        },
        onTimeout: function() {
            console.info( &quot;test.onTimeout&quot; );
        }
    }
};

var myTest = new tester();
dojo.connect( myTest, &quot;onTimeout&quot;, function() {
    console.info( &quot;dojo.connect() &gt; onTimeout&quot; );
});
myTest.run();
</pre>
<p>Along with <em>dojo.connect()</em> and <em>dojo.disconnect()</em>, using <em>dojo.publish()</em> and <em>dojo.subscribe()</em>/<em>dojo.unsubscribe()</em> you can make use of the global event bus to broadcast and subscribe to custom events &#8211; similar to, say, the <em>NSNotificationCenter</em> from <strong>Objective-C</strong>. I used this heavily in reporting what i deemed application-level state related events from the view controllers in the <strong>Dojo</strong> example in the <a href="http://github.com/bustardcelly/massroute-js" target="_blank">massroute-js github repo</a>, and thought it was a pleasure to work with.</p>
<h2>Other</h2>
<p>Just quick notes on some other things that i found interesting from the <strong>Dojo</strong> framework that I either used or want to use in the future using <strong>Dojo</strong>:</p>
<h3>dojo.hitch</h3>
<p>Keeping scope was a pleasure with <em>dojo.hitch()</em>. Due to developer requirements from <strong>MassDOT</strong> in using their <strong>API</strong> for real-time transportation data, you cannot make <strong>API</strong> calls more frequently than every 10 seconds. This meant that I had to implement a request queue in which I had to route the calls: immediate invoke if timer not running, else your next in line when timer runs out. Keeping scope of what was to be called when inside this queue manager was necessary as the queue manager itself was not supposed to have any logic about the service, only knowledge of state between orders coming and going. So it was important that when it was time to process the order, the scope was tied to the one who placed the order.<br />
<a href="http://dojotoolkit.org/reference-guide/dojo/hitch.html" target="_blank">dojo reference: dojo.hitch()</a></p>
<h3>dojo.behavior</h3>
<p>Though I went with my own custom view controllers and their logic encapsulated in respective classes, Dojo provides the ability to assign &#8220;behaviors&#8221; which i really want to look into further as it looks to be a nice design in separation of logic from view using mediation that can be swapped out quite easily at runtime.<br />
<a href="http://dojotoolkit.org/documentation/tutorials/1.6/using_behavior/" target="_blank">dojo toolkit: Using dojo.behaviour</a></p>
<h2>Wish I Coulda</h2>
<p>The following are a couple things I struggled with when working with the <strong>Dojo</strong> toolkit.</p>
<h3>Development/Debugging</h3>
<p>I love <strong>breakpoints</strong>. Being able to set a breakpoint and traverse a call stack and inspect properties is the pleasurable way for me to debug any problems. However, due to the design of <strong>Dojo</strong>&#8217;s modular architecture I found myself relying more on console for debugging purposes as modules are essentially read from a URL and evaluated as an expression. This means i couldn&#8217;t locate the file resource in development tools and set a breakpoint in any of my modules. </p>
<p>I am sure there is some trick or project set-up that would provide a more debugging-friendly environment when developing an application with <strong>Dojo</strong>, but I couldn&#8217;t find it. If you know of one, please leave a comment. </p>
<h3>Build</h3>
<p>From the looks of it, <strong>Dojo</strong> has a pretty powerful <a href="http://dojotoolkit.org/reference-guide/build/" target="_blank">Build System</a>. Intended to produce minified and concatenated scripts, using the build system allows you to package only what your app required from the <strong>Dojo</strong> framework. I frustratingly tried to get it to work a couple times, but it always ended up with the full dojo and my scripts were never minified or concatenated and it created this weird directory structure that made no sense. I am probably doing it wrong, but there is little out there in documentation if anything goes wrong. </p>
<p>There is also the <a href="http://build.dojotoolkit.org/" target="_blank">online Build Tool</a>, but i didn&#8217;t know the whole breath of source I needed for my build; I am assuming from the docs that there is where the power of the Build System and profiles comes into play.. Something I would definitely like to check out further because, next to the modular design, this *in theory* makes <strong>Dojo</strong> a real winner.</p>
<h2>Conclusion</h2>
<p>All in all, I was pretty impressed by <strong>Dojo</strong> and would recommend trying it out and may bring it up as a framework of choice for any larger projects in the future (especially if i could get Build to work for me). There was a slight learning curve mainly in the class declaration and inheritance design, but nothing over-daunting and actually quite revealing. The curve probably would have been higher if I was not already familiar with popular <strong>JavaScript</strong> patterns.</p>
<p><a href="http://dojotoolkit.org/">Dojo Toolkit</a><br />
<a href="https://github.com/bustardcelly/massroute-js/tree/master/massroute-examples/dojo">massroute-js/dojo</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/javascript/" title="View all posts in JavaScript" rel="category tag">JavaScript</a>,  <a href="http://custardbelly.com/blog/category/dojo/" title="View all posts in dojo" rel="category tag">dojo</a>,  <a href="http://custardbelly.com/blog/category/massroute-js/" title="View all posts in massroute-js" rel="category tag">massroute-js</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2011/10/04/massroute-js-dojo-example/#comments" rev="post-486"  title="Comment on massroute-js: dojo example">1 comment</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2011-10-04T09:46">October 4, 2011</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-486-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-483" class="post-483 post hentry category-javascript category-jquery category-jquery-mobile full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2011/09/27/new-github-repo-massroute-js/" title="Permanent link to new github repo: massroute-js" rel="bookmark" rev="post-483">new github repo: massroute-js</a></h1>
	
	<div class="entry-content full-content">
		<p>This is just a quick post to alert any subscribers to this blog that are interested in JavaScript development that I created a <a href="https://github.com/bustardcelly/massroute-js" target="_blank">repository some time back on github</a> that holds my exploration of various JavaScript frameworks and libraries. You can check it out at <a href="https://github.com/bustardcelly/massroute-js" target="_blank">http://github.com/bustardcelly/massroute-js</a>.</p>
<p>Centered around the theme of developing a web-based application to access real-time MBTA transportation data (made available by <a href="http://www.twitter.com/MassDOTdev" target="_blank">MassDOT</a> &#8211; <a href="http://www.eot.state.ma.us/developers/realtime/" target="_blank">more info here</a>), I wanted to explore various libraries and micro-application frameworks that are out in-the-wild for JavaScript; some more well-known than others, but still hold my interest.</p>
<p>The initial commit included the work i had done with jQuery Mobile, which i have been actively working with for almost a year and have given a couple <a href="http://www.slideshare.net/todd_anderson/jquery-mobile-progressive-enhancement-with-html5-8302294" target="_blank">presentation</a>s on. Most recently, I committed an example of my exploration into <a href="http://dojotoolkit.org/" target="_blank">dojo</a>. I rather enjoyed working with the dojo framework and toolkit and hope to have another post that spotlights my experience working with it &#8211; actually i hope to post on each library/framework that i dig into with the repo, so we&#8217;ll see how that goes. Next up on my curiosity list is <a href="http://knockoutjs.com/" target="_blank">Knockout</a>&#8230;</p>
<p>I won&#8217;t list all those that have caught my eye, so if you have any suggestions please feel free to leave them in the comments.</p>
<p><strong>[Disclaimer]</strong><br />
If you look at the source of the examples in the repo, I don&#8217;t claim to be a master of the library or frameworks I am exploring, needless to say the JavaScript language itself. So, if you see something that is considered bad practice or all together wrong, please let me know.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/javascript/" title="View all posts in JavaScript" rel="category tag">JavaScript</a>,  <a href="http://custardbelly.com/blog/category/jquery/" title="View all posts in jquery" rel="category tag">jquery</a>,  <a href="http://custardbelly.com/blog/category/jquery-mobile/" title="View all posts in jquery-mobile" rel="category tag">jquery-mobile</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2011-09-27T05:08">September 27, 2011</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-483-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-474" class="post-474 post hentry category-air category-as3 category-flex category-flex-4-5 category-native-extension-for-adobe-air full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2011/09/21/air-native-extension-example-ibattery-for-ios/" title="Permanent link to AIR Native Extension Example: iBattery for iOS" rel="bookmark" rev="post-474">AIR Native Extension Example: iBattery for iOS</a></h1>
	
	<div class="entry-content full-content">
		<h2>Introduction</h2>
<p>The most exciting new feature <a href="http://blogs.adobe.com/flashplatform/2011/09/announcing-flash-player-11-and-air-3.html" target="_blank">coming to Adobe AIR</a> to me is the ability to compile against a library that can communicate with a device natively. Though some of the Stage* API opens a whole new world of rendering improvements, the inclusion of <a href="http://www.adobe.com/devnet/air/articles/extending-air.html" target="_blank">Native extensions for Adobe AIR</a> (NE) relieves the wishing and waiting of what will be exposed at the device level in future <strong>AIR SDK</strong> releases; we can now extend the <strong>Runtime</strong> ourselves. With the arrival of <strong>Native extensions</strong>, the possibilities of what can be achieved with a mobile <strong>AIR</strong> application grow larger; and certainly with that, so does complexity in design and the requirement to develop with mobile performance in mind. </p>
<p>Keeping the complexities and performance in check (and to calm myself down from excitement of the endless possibilities) I decided to give it a quick test-run by creating a <strong>Native Extension</strong> that I thought was sorely missing from the <strong>Adobe AIR SDK</strong> &#8211; battery information on iOS. In all seriousness, getting up and running and accessing the battery information of my iPhone from an application <strong>AIR</strong> application was rather painless and &#8211; dare i say it &#8211; easier than i expected. I intend to give a quick walk through of how I went about creating the <strong>iBattery Native Extension</strong> and how to use it in an AIR application.</p>
<h3>Disclaimer</h3>
<p>I am going to assume you are familiar with setting up an <strong>Apple Developer</strong> account and downloading the SDK and won&#8217;t even go into the headache of provisioning profiles and the deployment process for an <strong>iOS</strong> application. I am also going to assume that you are familiar with using the recent <strong>Flex 4.5 SDK</strong> to create mobile Flex applications. The application in this example is in no way complex, but I am not going to cover how the pieces of the application work &#8211; only how you can compile against and include an <strong>Native extension for Adobe AIR</strong>.</p>
<h3>Source</h3>
<p>If you are curious or just want to jump to code, I created a <a href="https://github.com/bustardcelly/iBattery" target="_blank">github repo</a> with all the source as well as deployment builds or if you just came here for the <strong>Native Extension</strong> and know your way around you can download <a href="http://www.custardbelly.com/downloads/air/ane/ibatteryextension.ane.zip">ibatteryextension.ane</a> directly.</p>
<h2>Requirements</h2>
<ul>
<li><a href="http://opensource.adobe.com/wiki/display/flexsdk/Download+Flex+4.5" target="_blank">Flex 4.5.1 SDK</a></li>
<li><a href="http://labs.adobe.com/technologies/flashplatformruntimes/air3/" target="_blank">AIR 3 Runtime and SDK (Release Candidate)</a></li>
<li><a href="http://developer.apple.com/devcenter/ios/index.action" target="_blank">iOS SDK</a></li>
</ul>
<p>Also, take a look at these excellent articles:</p>
<ul>
<li><a href="http://www.adobe.com/devnet/air/articles/extending-air.html" target="_blank">Extending Adobe AIR by Oliver Goldman</a></li>
<li><a href="http://renaun.com/blog/2011/09/why-native-extensions-for-air/" target="_blank">Why Native Extensions for AIR</a></li>
<li><a href="http://www.adobe.com/content/dam/Adobe/en/devnet/devices/pdfs/DevelopingActionScriptExtensionsForAdobeAIR.pdf" target="_blank">Developing ActionScript Extensions for Adobe AIR</a></li>
<li><a href="http://www.adobe.com/devnet/air/native-extensions-for-air.html" target="_blank">Native Extensions for Adobe AIR</a> in the AIR Developer Center</li>
</ul>
<p><em>I am not going to cover how to get this going with any IDEs (eg. <strong>Flash Builder 4.5</strong>). I will show you how to do all this from the command line. There are some niceties with IDEs that will separate you from invoking the command line tools of the <strong>SDK</strong> directly, but sometimes it is nice to see what is going on behind the scenes.</em></p>
<p>I went about downloading the <strong>Flex 4.5 SDK</strong> and unzipping it somewhere on my local disk, then downloaded the <strong>Adobe AIR SDK</strong> and overlaid it on the <strong>Flex SDK</strong> using the instructions here: <a href="http://kb2.adobe.com/cps/495/cpsid_49532.html" target="_blank">How To Overlay the AIR SDK</a>. For the purposes of the examples in this article let&#8217;s just say that <strong>SDK</strong> is located on my machine at: <strong>/Users/todd/SDKs/flex_4.5_air_3rc1</strong>.</p>
<p>The whole iOS &#038; Xcode set up, you are on your own. Sorry, not to be mean. There is some great information already out there and i want to keep this article more focused on <strong>Native Extensions for Adobe AIR</strong> and not to prevent hair-loss developing for iOS.</p>
<h2>Moving Pieces</h2>
<p>There are three major portions to create an AIR application utilizing the <strong>Native Extension for Adobe AIR</strong>:</p>
<ol>
<li>Native code compiled for target platform.</li>
<li>Flex library project to deploy the Native Extension for Adobe AIR.</li>
<li>Mobile AIR application.</li>
</ol>
<p>Depending on your target device/platform, the language and generated library on the native-side can vary and really is covered well in <a href="http://www.adobe.com/devnet/air/articles/extending-air.html#articlecontentAdobe_numberedheader_4" target="_blank">Oliver Goldman&#8217;s article</a>. For the purposes of this example, the native part involved me writing some C/Obj-C and creating a static library (.a file). The Flex library project is actually two-fold; I created a library that interfaced with the <a href="http://help.adobe.com/en_US/FlashPlatform/beta/reference/actionscript/3/flash/external/ExtensionContext.html " target="_blank">flash.external.ExtensionContext</a>, then generated an <strong>.ane</strong> file from the <strong>SWC</strong> and static library. The <strong>Mobile AIR</strong> application is then compiled against this <strong>Native Extension</strong> and the <strong>.ane</strong> library file is included in the generated <strong>.ipa</strong> file.</p>
<h2>Native</h2>
<p>I am not that much of an C/Objective-C developer. I have developed and deployed a handful of iOS applications in the past (some reaching the <strong>AppStore</strong>), but honestly have not touched it in quite some time. So I have some history, but cannot speak at length on how things work and why. Let&#8217;s just say, for the example in this article, that I knew enough to get in and get out and carry on on the <strong>ActionScript</strong> side of things.</p>
<p>When creating a native extension targeting the iOS platform, you&#8217;ll write some C code (which can call Obj-C) and deploy a static library with a <strong>.a</strong> extension. What i did was create a new Library project in Xcode, imported the header file included with the <strong>AIR SDK</strong> (found at <strong>/include/FlashRuntimeExtensions.h</strong>) and added a <strong>.m</strong> (Obj-C implementation) file to the project that will serve as the implementation of the native context and expose the API for accessing the battery life and information of the iOS device:</p>
<pre class="brush: cpp; first-line: 1; title: ;" title="">
// Access battery life.
FREObject GetBatteryLife(FREContext ctx, void* funcData, uint32_t argc, FREObject argv[]) {
    UIDevice *device = [UIDevice currentDevice];
    [device setBatteryMonitoringEnabled:YES];
    float life = [device batteryLevel];

    FREObject retVal;
    FRENewObjectFromDouble( life, &amp;retVal );
    return retVal;
}

// Access info about battery
FREObject GetBatteryInfo(FREContext ctx, void* funcData, uint32_t argc, FREObject argv[]) {
    UIDevice *device = [UIDevice currentDevice];
    [device setBatteryMonitoringEnabled:YES];
    int info = [device batteryState];

    FREObject retVal;
    FRENewObjectFromInt32( info, &amp;retVal );
    return retVal;
}
</pre>
<p>Boiled down and abstracted in thinking on the <strong>ActionScript</strong> side of things, the API of this native library exposes two methods: <em>GetBatteryLife</em> and <em>GetBatteryInfo</em>. Each return a numerical value related to their context: a Number representing the percent of battery life left on the device and an Integer representing battery state, respectively. The relation of the Number value to percent is fairly straight-forward. The Integer returned from <em>[[UIDevice currentDevice] batteryState]</em> relates to the various &#8220;states&#8221; that the battery can be in, and they are:</p>
<ul>
<li>0 : Unknown</li>
<li>1 : Unplugged</li>
<li>2 : Charging</li>
<li>3 : Full</li>
</ul>
<p>The <strong>FREObject</strong> is covered more properly by <a href="http://www.adobe.com/devnet/air/articles/extending-air.html#articlecontentAdobe_numberedheader_4" target="_blank">Oliver Goldman in his article</a>, and I just blindly assume that the <a href="http://help.adobe.com/en_US/FlashPlatform/beta/reference/actionscript/3/flash/external/ExtensionContext.html ">ExtensionContext</a> of the <strong>AIR SDK</strong> knows how to interpret this value for me so I can cast as an <strong>ActionScript</strong> type and move on. We&#8217;ll see how that happens in the next section.</p>
<h2>The Native Extension</h2>
<p>The previous section lightly covered the native side of things and generated a static library file that will be used to compile an <strong>Native Extension</strong> (NE) library that will be used by an AIR application to access battery information of an iOS device it is deployed to. Creating the <strong>Native Extension</strong> file (.ane) is actually a two step process:</p>
<ol>
<li>Create a Flash library project compiled against AIR libraries and expose an API that interfaces with the native library through <a href="http://help.adobe.com/en_US/FlashPlatform/beta/reference/actionscript/3/flash/external/ExtensionContext.html " target="_blank">ExtensionContext</a>.</li>
<li>Use the ADT command line tool with to generate an .ane file compiled against the library SWC and the native library.</li>
</ol>
<p>The <a href="http://help.adobe.com/en_US/FlashPlatform/beta/reference/actionscript/3/flash/external/ExtensionContext.html " target="_blank">flash.external.ExtensionContext</a> from the <strong>AIR SDK</strong> is your main access point to the native library. Essentially, you create a new instance of an <strong>ExtensionContext</strong> using an ID defined in an extension descriptor file compiled into the <strong>Native Extension</strong>. For the <strong>iBattery Native Extension</strong>, this is what my extension descriptor file looks like:</p>
<pre class="brush: xml; first-line: 1; highlight: [2,7]; title: ;" title="">
&lt;extension xmlns=&quot;http://ns.adobe.com/air/extension/2.5&quot;&gt;
  &lt;id&gt;com.custardbelly.ibattery&lt;/id&gt;
  &lt;versionNumber&gt;1&lt;/versionNumber&gt;
  &lt;platforms&gt;
    &lt;platform name=&quot;iPhone-ARM&quot;&gt;
            &lt;applicationDeployment&gt;
                &lt;nativeLibrary&gt;libAIRExtensionC.a&lt;/nativeLibrary&gt;
                &lt;initializer&gt;ExtInitializer&lt;/initializer&gt;
                &lt;finalizer&gt;ExtFinalizer&lt;/finalizer&gt;
            &lt;/applicationDeployment&gt;
        &lt;/platform&gt;
  &lt;/platforms&gt;
&lt;/extension&gt;
</pre>
<p>Highlighted in that snippet are some important bits. The <strong>id</strong> node value will be used to create a new <strong>ExtensionContext</strong> instance. The <strong>nativeLibrary</strong> node value is the native library created in the previous section. For this example, it is also of note that we have defined the <em>iPhone-ARM</em> platform as a target, as well. This extension descriptor file describes the association of id to native library that the <strong>ExtensionContext</strong> will look up upon instantiation. To create an <strong>ExtensionContext</strong>:</p>
<p><em>com.cusardbelly.air.extensions.battery.ios.Battery</em></p>
<pre class="brush: jscript; title: ;" title="">
_extensionContext = ExtensionContext.createExtensionContext( &quot;com.custardbelly.ibattery&quot;, &quot;main&quot; );
</pre>
<p>&#8230; and then use the <strong>call</strong>() method to invoke the corresponding method exposed in the native library. For the purposes of the example in this article, and for the <strong>iBattery Native Extension</strong>, I basically exposed the same API that was on the native side:</p>
<p><em>com.cusardbelly.air.extensions.battery.ios.Battery</em></p>
<pre class="brush: jscript; title: ;" title="">
public function getBatteryLife():Number
{
    return _extensionContext.call( 'GetBatteryLife' ) as Number;
}

public function getBatteryState():int
{
    return _extensionContext.call( 'GetBatteryInfo' ) as int;
}
</pre>
<p>With my API done, I compiled the library into a SWC:</p>
<pre class="brush: bash; title: ;" title="">
&gt; /Users/todd/SDKs/flex_4.5_air_3rc1/bin/compc -output build/iBattery.swc -load-config+=ibattery_lib.config +configname=airmobile
</pre>
<p>If you are unfamiliar with using the command line tools of the SDK, I used the compc tool which is used to generate SWC files. The <strong>iBattery.swc</strong> file is generated and placed in a build directory and is compiled against an additional custom config (which just defines source location) and the <strong>+configname=airmobile</strong> directive. That&#8217;s actually a little fun tidbit. If you want to generate a SWC or SWF that uses the AIR mobile libraries, just add <strong>+configname=airmobile</strong> and they&#8217;ll be compiled against for you without defining them in an additional config file.</p>
<p>I then took the iBattery.swc and unzipped it to get the <strong>library.swf</strong> file. This is necessary for generating a <strong>Native Extension</strong> file (.ane) using the <strong>ADT</strong> command line tool:</p>
<pre class="brush: bash; title: ;" title="">
&gt; /Users/todd/SDKs/flex_4.5_air_3rc1/bin/adt -package -target ane ../release/ibatteryextension.ane extension.xml -swc iBattery.swc -platform iPhone-ARM library.swf libAIRExtensionC.a
</pre>
<p>That generates an <strong>ibatteryextension.ane</strong> in a release directory and defines the target SWC library and platform as well as compiling in the descriptor, SWF library and native library.</p>
<p>That <strong>Native extension</strong> is then used as one would as SWC library in an AIR Mobile application to interface with the native library. You need to compile against the .ane and include it in an extension directory within the AIR application.</p>
<h2>The AIR Mobile Application</h2>
<p>The application I created to showcase the <strong>iBattery Native Extension</strong> is pretty dead simple. Again, I am assuming you have some knowledge of a mobile AIR application and its pieces. There are a ton of great articles out there that can help in developing an AIR application targeting mobile, so I won&#8217;t  provide any more explanations in this article, I just wanted to show you quickly how the communication works and the requirements for compilation of the application.</p>
<p>To being I just have a main <em>ViewNavigatorApplication</em> that defines a single view:</p>
<p><em>iBatteryExample.mxml</em></p>
<pre class="brush: xml; first-line: 1; title: ;" title="">
&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;s:ViewNavigatorApplication xmlns:fx=&quot;http://ns.adobe.com/mxml/2009&quot;
        xmlns:s=&quot;library://ns.adobe.com/flex/spark&quot;
        firstView=&quot;BatteryTestView&quot;&gt;

&lt;/s:ViewNavigatorApplication&gt;
</pre>
<p>&#8230; and the <em>BatteryTestView</em> provides a UI to request the battery information on the device and does all the communication through the <strong>ActionScript</strong> side of the <strong>Native Extension</strong> library generated previously:</p>
<p><em>BatteryTestView.mxml</em></p>
<pre class="brush: xml; first-line: 1; title: ;" title="">
&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;s:View xmlns:fx=&quot;http://ns.adobe.com/mxml/2009&quot;
        xmlns:s=&quot;library://ns.adobe.com/flex/spark&quot;
        title=&quot;BatteryTestView&quot; creationComplete=&quot;handleCreationComplete();&quot;&gt;

    &lt;fx:Script&gt;
        &lt;![CDATA[
            import com.custardbelly.air.extensions.battery.ios.Battery;

            protected var _batteryExtension:Battery;

            protected function handleCreationComplete():void
            {
                _batteryExtension = new Battery();

                lifeButton.addEventListener( MouseEvent.CLICK, handleLifeRequest, false, 0, true );
                infoButton.addEventListener( MouseEvent.CLICK, handleInfoRequest, false, 0, true );
            }

            protected function handleLifeRequest( evt:Event ):void
            {
                try {
                    console.appendText( &quot;Battery Life Percentage: &quot; );
                    console.appendText( ( _batteryExtension.getBatteryLife() * 100 ).toString() + &quot;%\n&quot; );
                }
                catch( e:Error )
                {
                    console.appendText( &quot;Error: &quot; + e.message );
                }
            }

            protected function handleInfoRequest( evt:Event ):void
            {
                console.appendText( &quot;Battery State: &quot; + ( _batteryExtension.getBatteryState() ).toString() + &quot;\n&quot; );
            }
        ]]&gt;
    &lt;/fx:Script&gt;

    &lt;s:layout&gt;
        &lt;s:VerticalLayout paddingLeft=&quot;10&quot; paddingRight=&quot;10&quot; paddingTop=&quot;10&quot; paddingBottom=&quot;10&quot; /&gt;
    &lt;/s:layout&gt;

    &lt;s:TextArea id=&quot;console&quot; width=&quot;100%&quot; height=&quot;100%&quot; editable=&quot;false&quot; text=&quot;Hello World!&quot; /&gt;
    &lt;s:HGroup width=&quot;100%&quot; height=&quot;24&quot; verticalAlign=&quot;middle&quot;&gt;
        &lt;s:Button id=&quot;lifeButton&quot; label=&quot;get life&quot; /&gt;
        &lt;s:Button id=&quot;infoButton&quot; label=&quot;get info&quot; /&gt;
    &lt;/s:HGroup&gt;

&lt;/s:View&gt;
</pre>
<p>Access to the <strong>ActionScript</strong> API from the <strong>Native Extension</strong> is available just as if you were developing against an external SWC library, and I created a new instance of a <em>Battery</em> to request life and information of the device which is then just printed out in a text area:</p>
<p><em>BatteryTestView.mxml</em></p>
<pre class="brush: jscript; first-line: 14; title: ;" title="">
_batteryExtension = new Battery();
</pre>
<pre class="brush: jscript; first-line: 34; title: ;" title="">
console.appendText( &quot;Battery State: &quot; + ( _batteryExtension.getBatteryState() ).toString() + &quot;\n&quot; );
</pre>
<p>To generate my AIR application for iOS, was a two step process. First, I generated the application SWF targeting AIR mobile:</p>
<pre class="brush: bash; title: ;" title="">
&gt; /Users/todd/SDKs/flex_4.5_air_3rc1/bin/mxmlc +configname=airmobile -output build/iBatteryExample.swf src/iBatteryExample.mxml -load-config+=battery_app.config
</pre>
<p>Again i used the <strong>+configname=airmobile</strong> directive to include the mobile SWC from the Adobe AIR SDK without defining the dependencies in an additional config file. I did, however, have an additional config file that defined the <strong>Native Extension</strong> (.ane file) to compile against as an external library:</p>
<p><em>battery_app.config</em></p>
<pre class="brush: xml; first-line: 1; title: ;" title="">
&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;flex-config xmlns=&quot;http://www.adobe.com/2006/flex-config&quot;&gt;
    &lt;compiler&gt;
        &lt;external-library-path append=&quot;true&quot;&gt;
            &lt;path-element&gt;ext/ibatteryextension.ane&lt;/path-element&gt;
        &lt;/external-library-path&gt;
    &lt;/compiler&gt;
&lt;/flex-config&gt;
</pre>
<p>That generated an <em>iBatteryExample.swf</em> which was then used alongside an application descriptor file to compile and generate the <strong>.ipa</strong> file (application installer file for iOS). We can create that using the <strong>ADT</strong> command line tool:</p>
<pre class="brush: bash; title: ;" title="">
&gt; /Users/todd/SDKs/flex_4.5_air_3rc1/bin/adt -package -target ipa-test-interpreter -provisioning-profile {path.to}.mobileprovision -storetype pkcs12 -keystore {path.to}.developer_identity.p12 -storepass {pass} ../release/iBatteryExample.ipa iBatteryExample-app.xml iBatteryExample.swf -extdir ../ext/
</pre>
<p>There are two things in this command that you should note. First off, you will need to replace the <em>{path.to}</em> and <em>{pass}</em> tokens to point to your iOS developer files and password, respectively. Second is the <em>-extdir</em> option. This defines where the application can locate the <strong>Native Extension</strong> (.ane file).</p>
<p>And that was pretty much it for the application. Pretty basic, but a rather quick way to get up and running to allow someone to find information about their battery on an iOS device.</p>
<h2>Conclusion</h2>
<p>The addition of <strong>Native Extensions for Adobe AIR</strong> to the AIR SDK opens a lot of doors not only for native device integration but also to the experience you can provide in a mobile AIR application &#8211; with the biggest takeaway (as a developer) being that we no longer have to wait and see what gets exposed to us at the device-level in future <strong>AIR SDK</strong> releases. We can just write our own native extension now.</p>
<p>Hopefully this article provided some insight on how to quickly get up and running in creating your own Native Extensions and how to incorporate them into your mobile AIR application. And it should be noted that though this example was iOS specific, the native library for an <strong>Native Extension for Adobe AIR</strong> is in no way restricted to that platform and you should really check out <a href="http://www.adobe.com/devnet/air/articles/extending-air.html#articlecontentAdobe_numberedheader_4" target="_blank">Oliver Goldman&#8217;s excellent article, Extending Adobe AIR on the Adobe DevNet</a>.</p>
<p>The source discussed in this article can be found on <strong>github</strong> at <a href="https://github.com/bustardcelly/iBattery">http://github.com/bustardcelly/iBattery</a> and the <a href="http://www.custardbelly.com/downloads/air/ane/ibatteryextension.ane.zip" target="_blank">ibatteryextension.ane</a> itself (if you&#8217;d like to use it in your application) can be downloaded from this link.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/air/" title="View all posts in AIR" rel="category tag">AIR</a>,  <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>,  <a href="http://custardbelly.com/blog/category/flex-4-5/" title="View all posts in Flex 4.5" rel="category tag">Flex 4.5</a>,  <a href="http://custardbelly.com/blog/category/native-extension-for-adobe-air/" title="View all posts in Native Extension for Adobe AIR" rel="category tag">Native Extension for Adobe AIR</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2011/09/21/air-native-extension-example-ibattery-for-ios/#comments" rev="post-474"  title="Comment on AIR Native Extension Example: iBattery for iOS">28 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2011-09-21T12:54">September 21, 2011</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-474-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-457" class="post-457 post hentry category-flash category-flex category-flex-4-5 full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2011/07/15/flex-4-5-hidden-additions/" title="Permanent link to Flex 4.5 Hidden Additions*" rel="bookmark" rev="post-457">Flex 4.5 Hidden Additions*</a></h1>
	
	<div class="entry-content full-content">
		<p>*Maybe not necessarily <em>hidden</em> per se, but with the main focus on delivering <strong>Flex</strong> to mobile, there are a few things that have snuck into the <a href="http://opensource.adobe.com/wiki/display/flexsdk/Download+Flex+4.5" target="_blank">Flex 4.5 SDK</a> release that don&#8217;t get much coverage. I am not talking about <strong>Molehill</strong>, native <strong>JSON</strong> support, <strong>GC</strong> advice, etc. disclosed in <a href="http://www.bytearray.org/?p=3216" target="_blank">this announcement</a> &#8211; which are very exciting. I wanted to shed some light on some things I found kicking around in the new <strong>SDK</strong> that I have not heard very much about. Truthfully, they may have been a bi-product of getting the framework to be more performant on a mobile device &#8211; not sure &#8211; but they are things that I (and probably you) have created over and over for projects with varying degrees of functionality and <strong>API</strong> completeness as was deemed fit for the requirements at hand.</p>
<p>They are:</p>
<ol>
<li>s:Image</li>
<li>ContentCache</li>
<li>LinkedList</li>
</ol>
<p>read on to find out more about them&#8230;</p>
<h2>1. s:Image</h2>
<p>Finally, a <strong>Spark</strong> equivalent of <strong>mx:Image</strong>! And with it comes its own skin &#8211; <strong>ImageSkin</strong> &#8211; that allows the ability to show loading progress (with its own skin!). I can&#8217;t tell you how many times i have made these for client projects. Many &#8211; let&#8217;s keep it at that. However, the skin contract I would create for these custom &#8220;images-with-loading-indicator-components&#8221; (as I would call them) defined an <strong>mx:Image</strong> as the graphics container. The reason being a security issue with trying to manipulate bitmap data added to a <strong>BitmapImage</strong>.</p>
<p>Fortunately it looks like some updates to <strong>BitmapImage</strong> have been added as well in <a href="http://opensource.adobe.com/wiki/display/flexsdk/Download+Flex+4.5" target="_blank">Flex 4.5</a>, of which i am assuming clears up the security issues seeing as the skin contract for <strong>s:Image</strong> defines a <strong>BitmapImage</strong> as its graphic layer. Maybe I will dig into it later and come up with more info (or if someone reading knows, please tell), but what immediately pops out are the new <strong>load events and properties</strong> such as <em>trustedSource</em>, <em>contentLoader</em> and <em>bitmapData</em> (which returns a clone).</p>
<h3>Usage</h3>
<pre class="brush: xml; first-line: 1; title: ;" title="">
&lt;s:Image source=&quot;http://upload.wikimedia.org/wikipedia/commons/archive/4/4e/20090913162821!Pleiades_large.jpg&quot;
                width=&quot;800&quot; height=&quot;600&quot;
                enableLoadingState=&quot;true&quot;
                /&gt;
</pre>
<p>Remember how i mentioned <em>contentLoader</em> as a new property for <strong>BitmapImage</strong> (and the decorating <strong>s:Image</strong>)? That is typed to an <strong>IContentLoader</strong> interface, of which <strong>ContentCache</strong> is an implementation.</p>
<h2>2. ContentCache</h2>
<p>Many 3rd party libraries have been written for this. I&#8217;ve created some in <strong>AS2</strong>, some in <strong>AS3</strong>. Basically just a lookup on file access either remote or embedded so as not to load or generate new content &#8211; some with load queues, some with instant request. And that is what <strong>ContentCache</strong> provides &#8211; a queueable, cacheable loader for files on a remote resource. Another cool feature is being able to assign a grouping for queued requests and priority in loading &#8211; (another property on <strong>s:Image</strong> and <strong>BitmapImage</strong> not addressed previously).</p>
<p>If we look at the <em>load</em>() signature on <strong>ContentCache</strong>:</p>
<pre class="brush: jscript; title: ;" title="">
public function load(source:Object, contentLoaderGrouping:String=null):ContentRequest
</pre>
<p>we can see the grouping designation associated with the load request as the second argument. The first argument can be either a <strong>URLRequest</strong> object or a <strong>String</strong> (well <em>technically</em> you can supply anything there, but it will either be resolved to a <strong>URLRequest</strong> or <strong>String</strong> within the <em>load</em> function). We also see that <em>load</em>() returns an instance of <strong>ContentRequest</strong>. That can either be an active request in the queue or currently running or filled and considered <em>complete</em> from cache. </p>
<p>The <em>content</em> property on <strong>ContentRequest</strong> is typed as an Object and the docs suggest it can be anything. In the instance of the one returned from <strong>ContentCache</strong> it looks as though it is always typed to <strong>LoaderInfo</strong> (the target loader of the request). Pretty cool. So basically, you request <strong>ContentCache</strong> to load your image file, check for <em>complete</em> on the returned <strong>ContentRequest</strong>, if false, assign event handlers for complete. When using <strong>ContentCache</strong>, the <em>content</em> value on the <strong>ContentRequest</strong> (from what i see) will always be <strong>LoaderInfo</strong>. Obviously it is flexible enough to create your own <strong>IContentLoader</strong> implementation to return content of a different type.</p>
<h3>Usage</h3>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
public var cache:ContentCache;
public var requests:Vector.&lt;ContentRequest&gt;;

protected function requestImages():void
{
    cache = new ContentCache();
    cache.prioritize( &quot;walls&quot; );
    cache.enableCaching = true;
    cache.enableQueueing = true;

    requests = new Vector.&lt;ContentRequest&gt;();
    requests.push( cache.load( &quot;http://30.media.tumblr.com/tumblr_loc6v1EmWE1qzpsuoo1_500.jpg&quot;, &quot;superheros&quot; ) );
    requests.push( cache.load( &quot;http://26.media.tumblr.com/tumblr_locs8oFznL1qzpsuoo1_400.jpg&quot;, &quot;walls&quot; ) );
    requests.push( cache.load( &quot;http://25.media.tumblr.com/tumblr_loc2ysUcfw1qzpsuoo1_500.jpg&quot;, &quot;superheros&quot; ) )
    requests.push( cache.load( &quot;http://24.media.tumblr.com/tumblr_loarags4Du1qzpsuoo1_500.jpg&quot;, &quot;walls&quot; ) )

    var request:ContentRequest;
    var i:int = requests.length;
    while( --i &gt; -1 )
    {
        request = requests[i];
        if( request.complete )
        {
            requests.splice( i, 1 );
            addImage( (request.content as LoaderInfo).content as Bitmap );
        }
        else
        {
            addRequestHandlers( request );
        }
    }
}		

protected function addRequestHandlers( request:ContentRequest ):void
{
    request.addEventListener( Event.COMPLETE, handleRequestComplete );
}
protected function removeRequestHandlers( request:ContentRequest ):void
{
    request.removeEventListener( Event.COMPLETE, handleRequestComplete );
}

protected function handleRequestComplete( evt:Event ):void
{
    var request:ContentRequest = ( evt.target as ContentRequest );
    var index:int = requests.indexOf( request );
    requests.splice( index, 1 );
    removeRequestHandlers( request );

    var info:LoaderInfo = request.content as LoaderInfo;
    addImage( info.content as Bitmap );
}

protected function addImage( source:Bitmap ):void
{
    var img:BitmapImage = new BitmapImage();
    img.width = source.width;
    img.height = source.height;
    img.source = source;
    // imageHolder is just some container on the display list.
    imageHolder.addElement( img );
}
</pre>
<h3>The Good?</h3>
<p>Clean implementation. Remember that there is a <em>contentLoader</em> property on <strong>s:Image</strong> and <strong>BitmapImage</strong> now. You can use <strong>ContentLoader</strong> if it suits your needs, but you can also roll your own implementation of <strong>IContentLoader</strong>! I like.</p>
<h3>The Bad?</h3>
<p><em>Not necessarily bad implementations &#8211; we can certainly extend ContentLoader and make any modifications &#8211; these are more of things to consider when you are using it</em>:</p>
<p>There is no <em>add</em>() and <em>run</em>() on the API, or at least an <strong>autostart</strong> argument to <em>load</em>(). Invoking <em>load</em>() immediately starts loading. I may want to build a queue then kick it off. Plus it kind of kills the prioritize, because say your first two calls are #1) without priority association #2) with priority association. The first one is already in the loading process, so #2 does not take priority.</p>
<p>Even with prioritizing, do not rely on the order in which you call <em>load</em>() to be the order in which you will receive complete on the requests. This is mainly due to varying load times, priority, and cacheing. So if you are using <strong>ContentLoader</strong> as a queue loader, maintain the order outside of the <strong>ContentLoader</strong> and as requests come in as complete, fill that order accordingly. In essence, <strong>ContentLoader</strong> should be thought of &#8211; in my opinion &#8211; more of a cache of requests, rather than a queue loader per se. The <em>enableQueue</em> property does not pertain to &#8220;order in, order out&#8221; but rather &#8220;wait your turn&#8221;. The above example utilizes the priority API of <strong>ContentLoader</strong> to just show an example. If you run that a couple times, you will see what i mean about the order of the queue and priority being not what you would expect.</p>
<p>&#8230;</p>
<p>Now what caught my eye as I was checking out <strong>ContentCache</strong> is that is used linked lists, and more over that <strong>LinkedList</strong> was now available in the <strong>SDK</strong>! I&#8217;ll be it, in the <strong>mx.utils</strong> package (<em>why</em>?!) but still.</p>
<h2>3. LinkedList</h2>
<p>If you are unfamiliar with the concept of <a href="http://en.wikipedia.org/wiki/Linked_list" target="_blank">linked lists</a>, they are &#8211; in real simple terms &#8211; a great way to traverse a set of data using a node structure; unlike an array that stores data accessible from element index, a linked list really is more of an access point to nodes that have the knowledge of the next node and &#8211; depending on the type of linked list &#8211; at times, the previous node. </p>
<p>In the case of the <strong>LinkedList</strong> from the <a href="http://opensource.adobe.com/wiki/display/flexsdk/Download+Flex+4.5" target="_blank">Flex SDK</a> &#8211; which is a doubly linked list &#8211; each item in the list points to the previous and next item if existant. So you can imagine, if you want to traverse the list from the first element to the last, you just point the next node from the current node. Not only does each node hold a reference to the next and previous node, but also the data which you are storing. So basically when you add data to a linked list, you are requesting the data be wrapped in a node and hold reference to the previous and next node depending on where you insert it.</p>
<p>There have been some great implementations out there &#8211; such as ones found in <a href="http://lab.polygonal.de/as3ds/" target="_blank">polygonal&#8217;s data structures</a> &#8211; and i have built a couple in my day for clients with varying functionality based on requirements. </p>
<p>I should say that it is a great exercise to create your own linked list and I recommend that you should do so. The one included in the <strong>SDK</strong> is good, but in my opinion very limited (or maybe i should say &#8220;lightweight&#8221;) and its implementation is a little different than how I would have handled. But, implementation aside, there is a <strong>LinkedList</strong> in the <strong>SDK</strong> now. It&#8217;s bare bones. No iterator, no traversal <strong>API</strong> on the list itself, and you traverse by accessing the nodes directly through the list.</p>
<h3>Usage:</h3>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
var list:LinkedList = new LinkedList();
list.push( &quot;foo&quot; );
list.push( &quot;bar&quot; );
list.push( &quot;baz&quot; );

var node:LinkedListNode = list.head;
while( node.next )
{
    trace( &quot;Node value: &quot; + node.value );
    node = node.next;
}

// &lt;&lt;outputs&gt;&gt;
// Node value: foo
// Node value: bar
// Node value: baz
</pre>
<h3>The Good?</h3>
<p>If i need a simple linked list, i dont have to create a new one again&#8230; yay!</p>
<h3>The Bad?</h3>
<p><em>Again, not necessarily bad in implementation but things i may have done differently:</em></p>
<p>One thing i would prefer is that you don&#8217;t have access the <strong>LinkedListNode</strong> directly. I think that the node wrapper for your data should be hidden or only accessible from the linked list (or iterator). This means that access to the data is provided through another layer of <strong>API</strong> and when you call things like <em>head</em>(), <em>next</em>(), or <em>previous</em>() you would actually be returned the <strong>data</strong> you sent to store &#8211; not the <strong>node</strong>. And typically this would be resolved by exposing access to an <strong>iterator</strong> that provides an API to traverse the linked list. So, the linked list has an API on how to store the data (ie. <em>push</em>(), <em>insertAt</em>(), <em>remove</em>(), etc.) and the iterator has the traversal API (ie. <em>next</em>(), <em>previous</em>(), etc.). But that would just be my way of working with a linked list and I see nothing stopping me from adding that layer myself to this lightweight doubly linked list from the <strong>SDK</strong>.</p>
<p>Is it fast? I&#8217;ll leave that to <a href="http://jacksondunstan.com/articles/548" target="_blank">Jackson Dunstan</a> to find out&#8230; I am guessing no &#8211; or rather not as fast as it could be if it were part of the player globals like <strong>Array</strong> and <strong>Vector</strong>. And why oh why is it stuck in the <strong>mx</strong> package?!? I don&#8217;t mean to complain, but it seems like there is no reason to have <strong>LinkedList</strong> stuck in the <strong>Flex</strong> framework. There&#8217;s no binding. Its not even in <strong>MX</strong> collections. Whatever. Maybe it was just a quick implementation to use in request of icon images for speed on <strong>Flex mobile</strong>.</p>
<p>So in any event, I would say it is a great exercise to roll your own linked list so you have it for any <strong>ActionScript</strong>-only AND <strong>Flex</strong> projects. But you can also find some really useful implementations out there.</p>
<h2>Conclusion</h2>
<p>Nothing really to conclude. I just found these while digging around and became intrigued as they were fairly common things that i implemented over and over with varying functionality on projects based on requirements and now they are available in the Flex 4.5 SDK. If you have found some that you really like, let me know.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>,  <a href="http://custardbelly.com/blog/category/flex-4-5/" title="View all posts in Flex 4.5" rel="category tag">Flex 4.5</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2011/07/15/flex-4-5-hidden-additions/#comments" rev="post-457"  title="Comment on Flex 4.5 Hidden Additions*">3 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2011-07-15T09:08">July 15, 2011</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-457-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-450" class="post-450 post hentry category-flash-and-the-city category-jquery category-jquery-mobile full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2011/06/15/flash-and-the-city-jquery-mobile/" title="Permanent link to Flash And The City: jQuery Mobile" rel="bookmark" rev="post-450">Flash And The City: jQuery Mobile</a></h1>
	
	<div class="entry-content full-content">
		<p>Over the past weekend, I had the great pleasure to attend and present at <a href="http://fatc.co/" target="_blank">Flash And The City</a> in NYC. I want to thank <a href="https://twitter.com/#!/eladelrom" target="_blank">Elad</a> and <a href="https://twitter.com/#!/joseeight" target="_blank">Jose</a> for putting on an excellent conference and giving me an opportunity to present. </p>
<p><a href="http://www.custardbelly.com/presentations/FATC/jqm/jQM_FATC.zip">Download Source + Presentation</a></p>
<p>The talk was about the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework and was sort of a nuts and bolts overview of what the framework has to offer and its foundation on the principal of <a href="http://www.alistapart.com/articles/understandingprogressiveenhancement" target="_blank">Progressive Enhancement</a>. Thanks to all who made it out. I really appreciate it and hopefully it was worth taking you away from the beautiful city for a little bit.</p>
<div style="width:425px" id="__ss_8302294"><strong style="display:block;margin:12px 0 4px"><a href="http://www.slideshare.net/todd_anderson/jquery-mobile-progressive-enhancement-with-html5-8302294" title="jQuery Mobile: Progressive Enhancement with HTML5">jQuery Mobile: Progressive Enhancement with HTML5</a></strong><object id="__sse8302294" width="425" height="355"><param name="movie" value="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=fatcjqm-110614051649-phpapp01&#038;stripped_title=jquery-mobile-progressive-enhancement-with-html5-8302294&#038;userName=todd_anderson" /><param name="allowFullScreen" value="true"/><param name="allowScriptAccess" value="always"/><embed name="__sse8302294" src="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=fatcjqm-110614051649-phpapp01&#038;stripped_title=jquery-mobile-progressive-enhancement-with-html5-8302294&#038;userName=todd_anderson" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="425" height="355"></embed></object>
<div style="padding:5px 0 12px">View more <a href="http://www.slideshare.net/">presentations</a> from <a href="http://www.slideshare.net/todd_anderson">Todd Anderson</a>.</div>
</div>
<p>You can also check out a loose transcript of what i *may* have said here: <a href="http://www.custardbelly.com/presentations/FATC/jqm/FATC_jQM_Transcript.pdf" target="_blank">jQuery Mobile: Progressive Enhancement with HTML5 [FATC 2011] transcript</a>. [<strong>Warning</strong> - its a PDF] </p>
<p>There were more slides than the time allotted and I didn&#8217;t want to keep those who were nice enough to attend from exploring the city by watching me ramble on over my time limit. So i can&#8217;t guarantee that the transcript was true to the presentation; it was more of a rough draft of my thoughts on the slides.</p>
<p>All the demo source code and a PDF of the slide-deck can be downloaded here as well:<br />
<a href="http://www.custardbelly.com/presentations/FATC/jqm/jQM_FATC.zip">Download Source + Presentation</a></p>
<p>Thanks again to everyone who came out and to <a href="https://twitter.com/#!/eladelrom" target="_blank">Elad</a> and <a href="https://twitter.com/#!/joseeight" target="_blank">Jose</a> for putting on another great <a href="http://fatc.co/" target="_blank">Flash And The City</a> conference!</p>
<p>Link dump of what i may have mentioned and what is in the slides:</p>
<p><a href="http://fatc.co/">Flash And The City</a><br />
<a href="http://jquerymobile.com">jQuery Mobile</a><br />
<a href="http://jquerymobile.com/gbs/">jQuery Mobile A-Grade browser support</a><br />
<a href="http://www.alistapart.com/articles/understandingprogressiveenhancement">Progressive Enhancement</a><br />
<a href="http://selleckwaterfallsandwich.tumblr.com/">Selleck Waterfall Sandwich</a><br />
<a href="http://jeromeetienne.github.com/jquery-mobile-960/">jQuery Mobile: 960</a><br />
<a href="http://www.famfamfam.com/lab/icons/silk/">FamFamFam icons</a><br />
<a href="http://jqueryui.com/themeroller/">jQuery UI Theme Roller</a><br />
<a href="http://www.w3.org/WAI/intro/aria.php">WAI-ARIA</a><br />
<a href="http://dev.opera.com/articles/view/introduction-to-wai-aria/">Introduction to WAI ARIA by Gez Lemon</a><br />
<a href="http://dayofjs.com/videos/22152945/jquery-mobile_scott-jehl">Presentation by Scott Jehl of the Filament Group (specifically the Screen Reader demo)</a><br />
<a href="http://labjs.com">LabJS</a><br />
<a href="http://yepnopejs.com/">yepnope</a><br />
<a href="http://www.modernizr.com/">Modernizr</a><br />
<a href="http://developer.apple.com/library/safari/#documentation/appleapplications/reference/ SafariHTMLRef/Articles/MetaTags.html">Web-App Meta</a><br />
<a href="documentation/appleapplications/reference/ safariwebcontent/configuringwebapplications/configuringwebapplications.html<br />
http://developer.apple.com/library/safari/#">WebClips</a><br />
<a href="http://diveintohtml5.org/offline.html">HTML5 cache.manifest</a><br />
<a href="http://www.phonegap.com">PhoneGap</a><br />
<a href="http://labs.adobe.com/technologies/flashplatformruntimes/">Adobe AIR</a><br />
<a href="http://voisen.org/blog/2010/10/making-the-most-of-stagewebview/">Making the most of StageWebView by Sean Voisen</a><br />
<a href="http://www.nimblekit.com/">NimbleKit</a><br />
<a href="http://quickconnectfamily.org/">QuickConnectFamily</a><br />
<a href="http://www.appcelerator.com/">Titanium</a><br />
<a href="http://rhomobile.com/products/rhodes/">Rhodes</a><br />
<a href="http://infrared5.com">Infrared5</a><br />
<a href="https://twitter.com/#!/bustardcelly">me on twitter</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash-and-the-city/" title="View all posts in Flash and the City" rel="category tag">Flash and the City</a>,  <a href="http://custardbelly.com/blog/category/jquery/" title="View all posts in jquery" rel="category tag">jquery</a>,  <a href="http://custardbelly.com/blog/category/jquery-mobile/" title="View all posts in jquery-mobile" rel="category tag">jquery-mobile</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2011-06-15T09:12">June 15, 2011</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-450-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-394" class="post-394 post hentry category-couchdb category-jquery category-jquery-mobile full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2011/03/04/jquery-mobile-couchdb-part-7-2-%e2%80%93-authorization-and-validation/" title="Permanent link to jQuery Mobile + CouchDB: Part 7.2 – Authorization and Validation" rel="bookmark" rev="post-394">jQuery Mobile + CouchDB: Part 7.2 – Authorization and Validation</a></h1>
	
	<div class="entry-content full-content">
		<p>In my <a href="http://custardbelly.com/blog/?p=360" target="_blank">previous post</a>, I covered authorization and validation on the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> side. We set up an administrator, created a user or two and established a <strong>user-role</strong> for our <strong>albums</strong> database that will be used in validation on document operations based on the user context of a session. We got to write some code &#8211; our <strong>validate_doc_update</strong> &#8211; but mainly it was all clicking around and filling in fields in <a href="http://127.0.0.1:5984/_utils/" target="_blank">Futon</a>. Necessary stuff, mind you&#8230; but let&#8217;s get back to code. More importantly, let&#8217;s get back to our <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> application. We didn&#8217;t even touch it in the last mini-series in a series.</p>
<p>In this article I am going to address showing a <strong>Log In/Sign Up</strong> dialog in our <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> application. Instead of forcing a user to log in upon first landing on our application (as we saw when setting up <strong>Security</strong> on our database in the past article), we are going to present the dialog when a user tries to perform an operation that requires session and user validation. The way we have set up the <strong>albums</strong> database in <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> is that everyone can view all the <strong>album</strong> documents, but only users of the <strong>albums</strong> database (those assigned with a <strong>user-role</strong> of &#8220;<em>albums-user</em>&#8220;) are allowed to add new <strong>album</strong> documents and only those associated users of a document are allowed to edit and delete their <strong>album</strong> document. So, from a client-side perspective, the dialog will be shown on <strong>Add</strong>, <strong>Edit</strong> and <strong>Delete</strong> if a previous session for the user has not been established.</p>
<p>Actually, it is probably a little misleading to say we will be doing all this in <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a>. I am actually going to incorporate <a href="http://jquery.com/" target="_blank">jQuery</a> concepts into our <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> application. We are going to present the dialog as a <a href="http://jquery.com/" target="_blank">jQuery</a> <strong>widget</strong> and manage the communication through a <a href="http://jquery.com/" target="_blank">jQuery</a> <strong>plugin</strong> for our application. So as far as the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework is concerned, we won&#8217;t be learning anything new per se &#8211; we&#8217;ll be learning how to incorporate <a href="http://jquery.com/" target="_blank">jQuery</a> <strong>widgets</strong> and <strong>plugins</strong> into our application. In previous articles, the main bulk of <a href="http://jquery.com/" target="_blank">jQuery</a> we have employed has been using accessors and modifiers for elements/events within our <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> application. We have also gotten familiar with the <em>jquery.couch</em> plugin that comes with <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> and handles most (if not all) the communication points we need for our application. So working with the <a href="http://jquery.com/" target="_blank">jQuery</a> library is not all that unfamiliar.</p>
<p>Right. Didn&#8217;t i say there will be more coding in this article? What am i doing yammering on? Its time to put your <a href="http://jquery.com/" target="_blank">jQuery</a> hats on, because its about to get a whole lot more fun*!</p>
<p><em>*guarantees not included.</em></p>
<h2>Template</h2>
<p>We are going to create a <strong>login dialog</strong> pretty much as your standard form with the option to either &#8220;<em>log in</em>&#8221; or &#8220;<em>sign up</em>&#8221; (if i ever don&#8217;t use the space in those and it bothers you, i apologize. its become a little habit). In our planning, we currently want the dialog to appear in at least 3 places based on an operation that requires session and user validation &#8211; <strong>Add</strong>, <strong>Edit</strong> and <strong>Delete</strong>. Down the road, there could be more. We could add a login button to some or every page to allow to login at any time within the application. We&#8217;ll stick to the 3 operations for now, but in knowing that the same visual piece will be used in multiple places throughout the application, it makes for a good case to use a template for the UI of our login dialog.</p>
<p>We learned about templates on the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> side previously &#8211; using <a href="https://github.com/janl/mustache.js/" target="_blank">Mustache</a> and <strong>Partials</strong> to create our views. Same concept. We want to be able to declare some mark-up in one place that will be rendered in the <strong>DOM</strong> upon request from anywhere in the application. To do that, we&#8217;ll use the <a href="http://github.com/jquery/jquery-tmpl" target="_blank">jquery.tmpl</a> plugin available at: <a href="http://github.com/jquery/jquery-tmpl" target="_blank">http://github.com/jquery/jquery-tmpl</a>. Why jquery.tmpl? It is simple to use and &#8211; though still in beta &#8211; is considered an <a href="http://www.borismoore.com/2010/10/jquery-templates-is-now-official-jquery.html" target="_blank">official jQuery plugin</a>, so documentation can be found on the <a href="http://jquery.com/" target="_blank">jQuery</a> site at: <a href="http://api.jquery.com/jquery.tmpl/" target="_blank">http://api.jquery.com/jquery.tmpl/</a>. In any event, make sure to download the jquery.tmpl plugin from <a href="http://github.com/jquery/jquery-tmpl" target="_blank">http://github.com/jquery/jquery-tmpl</a> as we are going to use it for our login dialog.</p>
<p>With <em>jquery.tmpl</em> downloaded and added to the <em>/vendor/couchapp/_attachments/</em> folder of our <strong>albums</strong> <a href="http://couchapp.org/page/index" target="_blank">coucapp</a> directory (in following the examples within this series, for me that directory is <em>/Documents/workspace/custardbelly/couchdb/albums</em>), open up the <em>loader.js</em> file from that same directory and save the following modification to include the <em>jquery.tmpl</em>:</p>
<p><em>/vendor/couchapp/_attachments/loader.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [17]; title: ;" title="">
function couchapp_load(scripts) {
  for (var i=0; i &lt; scripts.length; i++) {
    document.write('&lt;script src=&quot;'+scripts[i]+'&quot;&gt;&lt;\/script&gt;')
  };
};

couchapp_load([
  &quot;/_utils/script/sha1.js&quot;,
  &quot;/_utils/script/json2.js&quot;,
  &quot;vendor/couchapp/jquery-1.4.4.js&quot;,
  &quot;/_utils/script/jquery.couch.js&quot;,
  &quot;vendor/couchapp/jquery.couch.app.js&quot;,
  &quot;vendor/couchapp/jquery.couch.app.util.js&quot;,
  &quot;vendor/couchapp/jquery.mustache.js&quot;,
  &quot;vendor/couchapp/jquery.evently.js&quot;,
  &quot;vendor/couchapp/jquery.mobile-1.0a2.js&quot;,
  &quot;vendor/couchapp/jquery.tmpl.js&quot;
]);
</pre>
<p>Pretty straight forward; just adding the <em>jquery.tmpl</em> <strong>plugin</strong> to be loaded into the <strong>DOM</strong>. Now we need to declare the mark-up for our <strong>login dialog</strong>. We&#8217;ll just add it to our main page and its usage will be revealed later. For now, open up the <em>/_attachments/index.html</em> file and save the following script tag and content between the previously declared script tags for the <em>loader.js</em> and our application script:</p>
<pre class="brush: xml; first-line: 52; highlight: [53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73]; title: ;" title="">
&lt;script src=&quot;vendor/couchapp/loader.js&quot;&gt;&lt;/script&gt;
&lt;script id=&quot;loginSignupDialog&quot; type=&quot;text/x-jquery-tmpl&quot;&gt;
    &lt;div role=&quot;dialog&quot; data-backbtn=&quot;false&quot; class=&quot;ui-dialog ui-body-a&quot;&gt;
      &lt;div class=&quot;ui-header ui-bar-a ui-corner-top ui-overlay-shadow&quot;&gt;
	&lt;h1 class=&quot;ui-title&quot;&gt;&lt;/h1&gt;
	&lt;a id=&quot;dialogCloseButton&quot; href=&quot;#&quot; data-icon=&quot;delete&quot; data-iconpos=&quot;notext&quot; style=&quot;left: 15px; top: .4em; position: absolute;&quot; /&gt;
      &lt;/div&gt;
      &lt;div data-role=&quot;content&quot; class=&quot;ui-body-c ui-corner-bottom ui-overlay-shadow&quot;&gt;
        &lt;p&gt;You need to be logged in to do that!&lt;/p&gt;
        &lt;form action=&quot;#&quot; method=&quot;post&quot;&gt;
          &lt;label for=&quot;username&quot;&gt;Username:&lt;/label&gt;
          &lt;input type=&quot;text&quot; name=&quot;username&quot; id=&quot;username&quot; value=&quot;&quot;  /&gt;
          &lt;label for=&quot;password&quot;&gt;Password:&lt;/label&gt;
          &lt;input type=&quot;password&quot; name=&quot;password&quot; id=&quot;password&quot; value=&quot;&quot; /&gt;
          &lt;a id=&quot;submitButton&quot; href=&quot;#&quot; type=&quot;submit&quot; data-role=&quot;button&quot; data-theme=&quot;b&quot;&gt;Submit&lt;/a&gt;
          &lt;hr/&gt;
          &lt;a id=&quot;optionLinkButton&quot; href=&quot;#&quot; /&gt;
        &lt;/form&gt;
      &lt;/div&gt;
      &lt;div data-role=&quot;footer&quot; /&gt;
    &lt;/div&gt;
&lt;/script&gt;
&lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;
     $db = $.couch.db(&quot;albums&quot;);
</pre>
<p>The <strong>loginSignupDialog</strong> template looks pretty familiar if you have been following along in this series. It is just a hacked up <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page dialog with a form &#8211; looks pretty much what our <em>albumdelete.html</em> <strong>template</strong> we created before but with a form in it. You may notice that the header and <strong>optionLinkButton</strong> have no textual content. That will be updated based on the state of the dialog (login or signup). We&#8217;ll get to that later. What is important is to know that this template declaration can be rendered using the following:</p>
<pre class="brush: jscript; title: ;" title="">
$(&quot;#loginSignupDialog&quot;).tmpl()
</pre>
<p>Once it has been rendered it can be added to the <strong>DOM</strong> as you normally would with <a href="http://jquery.com/" target="_blank">jQuery</a> (eg, <em>appendTo</em>()), but since we are developing in the context of a <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> application, we will treating it as a page in the application. Things to remember and will act upon later.</p>
<p>Also important to note is the type attribute of the <strong>template</strong> declaration &#8211; <em>text/x-jquery-tmpl</em>. That is so the <strong>HTML</strong> parser knows to treat that markup as a string and not try to parse and add to the <strong>DOM</strong>. Without that type, you likely will get a parse error when viewing your application in a browser. The plugin does not search for the explicit type value of <em>text/x-jquery-tmpl</em> in order to due its rendering, it just needs to have some denotation for the browser engine to recognize not to render the content to the <strong>DOM</strong> &#8211; <em>text/x-jquery-tmpl</em> is just easier to recognize what is being reserved as a <a href="http://jquery.com/" target="_blank">jQuery</a> template by human readers.</p>
<h2>Organization and Re-use</h2>
<p>Up to this point in the series, if you have been following along, the extent of our working with <a href="http://jquery.com/" target="_blank">jQuery</a> has been in accessing and modifying the <strong>DOM</strong>. We&#8217;ve used the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> API mainly to listen for events and change pages. The extent of working with the <a href="http://jquery.com/" target="_blank">jQuery Mobile</a> framework has been more under the hood &#8211; which i believe is the intent &#8211; though we have employed some hacks to get things to work as we would like. So, the <strong>JavaScript</strong> we have done up until this point has been to manipulate the <strong>DOM</strong> associated with a particular view &#8211; we created our <strong>Partials</strong> as quasi-view controllers and we have some script related to the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> pages we have defined in <em>index.html</em>.</p>
<p>That&#8217;s fine. I might do some things a little different if this was going to get my seal of approval, but we were having fun. I&#8217;m gonna get a little more organized now, however, and use some great functionality and <strong>API</strong> available to us just by loading <a href="http://jquery.com/">jQuery</a> and <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> that we have been foolishly ignoring. Not really ignoring&#8230; we just never had a really strong use case to address it until now.</p>
<p>We are going to employ two architectural concepts of jQuery in order to present our login dialog and authenticate session with our <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance: <strong>widgets</strong> and <strong>plugins</strong>.</p>
<p>Before we dive into some code, perhaps I should clarify how I interpret each concept as really they can be somewhat interchangeable and used in the same fashion. For instance they both can target an element like so:</p>
<pre class="brush: jscript; title: ;" title="">
$(&quot;#myElement&quot;).something();
</pre>
<p>It is typically the <em>something</em>() invocation, for me, that sets them apart (aside from the code behind the <em>something</em>()). If it is a directive to manipulate the element or its ancestry in the <strong>DOM</strong>, then it is a plugin. If it is a call to decorate the element in such a way that it looks and behaves in a manner usually not associated with that element, then i consider it a <strong>widget</strong> <em>(in fact, as we will discuss later, there is more to this in terms of a factory/builder plugin for widgets)</em>. Say for instance: <strong>$(&#8221;#myElement&#8221;)</strong>.<em>slider</em>() would manipulate the contents of <strong>#myElement</strong> to behave like a slider control.</p>
<p>And then of course, plugins can declare a global access variable and define an <strong>API</strong>, as we have seen with <strong>$.mobile</strong> (<em>jquery-mobile-1.0a2.js</em>) and <strong>$.couch</strong> (<em>jquery.couch.js</em>), which takes the <strong>plugin</strong> concept from being more of a &#8220;utility&#8221; method on element(s) to that of a library.</p>
<p>Of course, I could be totally off-base in how i interpret these concepts and am open to discussion. If you have different interpretations or more insight please leave a comment.</p>
<h2>Widget</h2>
<p>Truthfully, a <strong>widget</strong> is more tied with the <a href="http://jqueryui.com/" target="_blank">jQuery UI</a> library. Included in the development-bundle source for <a href="http://jqueryui.com/" target="_blank">jQuery UI</a> is a <em>jquery.ui.widget</em> script that defines the <strong>widget</strong> factory/builder and the defined UI <strong>widget</strong> elements with the <strong>jquery.ui.*</strong> namespaced file name. We are not going to load the <a href="http://jqueryui.com/" target="_blank">jQuery UI</a> library as well, since <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> basically contains that script from <em>jquery.ui.widget</em> and extends it to <strong>mobile.widget</strong> to preform some string manipulation on the data attribute. In fact, most of the controls (and even page!) that are &#8220;mobilized&#8221; are widgets.</p>
<p>So we have <strong>$.widget</strong> at our disposal (thanks to <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a>). We&#8217;ll use the <strong>$.widget</strong> factory to create a <strong>login dialog</strong> widget to provide functional logic to our <strong>login template</strong> create previously in this article. In this sense, you can think of the <strong>login dialog widget</strong>, itself, as a sort of presenter. We can go about mucking around with the layout and such of our template and wire up our widget to respond to events from elements in our view.</p>
<p>Before we dive right in to some code, I wanted to touch on some finer points so when we take a look at how our <strong>login dialog widget</strong> is created we might have a clearer understanding of its construction. <strong>$.widget</strong> is considered a factory method to create custom widgets and is an extension of <strong>$.Widget</strong> (capital W). <strong>$.Widget</strong> itself acts as sort of a builder. Upon widget-ization of an element, <em>_init</em>() and <em>_create</em>() hook methods are invoked and available for override in our custom <strong>widget</strong>. There are also some methods for options, enablement, and for triggering events (<em>_trigger</em>()) to name a few. But most importantly, there is a <em>destroy</em>() method. To squash any memory leaks, we must tidy up our mess. </p>
<p>So, to break it down, <strong>$.Widget</strong> provides a lifecycle method template and is the builder of our <strong>widget</strong>. <strong>$.widget</strong> is a factory method for creating custom widgets and allows us to widget-ize elements based on the name of our widget. <em>What the hell does that mean?</em> If we create a widget using the <strong>$.widget</strong> factory and provide it a name of &#8220;<em>albums.loginDialog</em>&#8220;, we can widget-ize our template as such:</p>
<pre class="brush: jscript; title: ;" title="">
$(&quot;#loginSignupDialog&quot;).tmpl().loginDialog()
</pre>
<p>In fact, that is essentially what we are going to do&#8230; but we first lets cover how we&#8217;re going to do it. For some extra reading, this is a great article form <a href="http://jqueryui.com/" target="_blank">jQuery UI</a> explaining the widget factory: <a href="http://jqueryui.com/docs/Developer_Guide" target="_blank">http://jqueryui.com/docs/Developer_Guide</a>. There is also this excellent write up i found by <a href="http://www.erichynds.com" target="_blank">Eric Hynds</a>: <a href="http://www.erichynds.com/jquery/tips-for-developing-jquery-ui-widgets/" target="_blank">http://www.erichynds.com/jquery/tips-for-developing-jquery-ui-widgets/</a>.</p>
<p>Less talk. More code. Open up your favorite editor and save the following snippet as <em>jquery.albums.loginDialog.js</em> in the <em>/_attachments/script</em> directory of the <strong>albums</strong> <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> (for me that directory is <em>/Documents/workspace/custardbelly/couchdb/albums</em>):</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
(function( $ ) {

  $.widget( &quot;albums.loginDialog&quot;, {

    options: {
      state: 0, // 0 - log in state. 1 - sign up state.
      loginText: &quot;Log In&quot;,
      signUpText: &quot;Sign Up&quot;
    },

    _create: function() {
      var ops = this.options;
      var $element = this.element;

      // Current page reference.
      var currentPage = $.mobile.activePage;
      var pageLink = currentPage.attr( &quot;id&quot; );
      // It is an internal page link.
      if( pageLink.indexOf( &quot;.html&quot; ) == -1 ) pageLink = &quot;#&quot; + pageLink;
      var closeButton = $element.find( &quot;div[class*='ui-header'] a#dialogCloseButton&quot; )
                                .attr( &quot;href&quot;, pageLink );
      // Hold reference in custom data expando.
      $element.data(&quot;previous&quot;, pageLink );

      // Wrap the content in a dialog page.
      var wrapper = this._wrapDialog( $element );
      // Wire interactions.
      this._wire();
      this._changeState( ops.state );
      // For some reason, i have to add it to the DOM in order to changePage() to it.
      $(&quot;body[class*=\&quot;ui-mobile-viewport\&quot;]&quot;).append(wrapper);
      $.mobile.changePage( [currentPage, wrapper], &quot;pop&quot;, false );
    },

    _setOption: function( key, value ) {
      this._changeState( ( key == &quot;state&quot; ) ? value : this.options.state );
      jQuery.Widget.prototype._setOption.apply( this, arguments );
    },

    _wrapDialog: function( dialogElement ) {
      // Page wrapper usually created on external page.
      var dialogPage = $(&quot;&lt;div data-role=\&quot;page\&quot;&gt;&quot;);
      dialogPage.append( dialogElement );
      dialogPage.page();

      dialogPage.bind( &quot;pagebeforeshow&quot;, function() {
          dialogPage.unbind( &quot;pagebeforeshow&quot; );
          var h = parseFloat(dialogPage.innerHeight());
          h -= ( parseFloat(dialogElement.css(&quot;border-top-width&quot;)) + parseFloat(dialogElement.css(&quot;border-bottom-width&quot;)) );
          // define the height based on innerHeight of wrapping parent page and the border styles applied to a dialog.
          dialogElement.css( &quot;height&quot;, h + &quot;px&quot; );
      });
      dialogPage.bind( &quot;pagehide&quot;, function() {
          dialogPage.unbind( &quot;pagehide&quot; );
          dialogPage.empty();
          dialogPage.remove();
      });
      return dialogPage;
    },

    _changeState: function( state ) {
      var mainText = ( state == 0 ) ? this.options.loginText : this.options.signUpText;
      var optionText = ( state == 0 ) ? this.options.signUpText : this.options.loginText;
      var $element = this.element;
      var header = $element.find( &quot;div[class*='ui-header']&quot; );
      var page = $element.find( &quot;div[data-role='content']&quot; );
      var title = header.find( &quot;[class*='ui-title']&quot; );
      var optionLinkButton =  page.find( &quot;#optionLinkButton&quot; );
      var submitButton = page.find( &quot;a[aria-label='submit']&quot; );
      title.html( mainText );
      optionLinkButton.html( optionText + &quot;?&quot; );
      submitButton.html( mainText );
      submitButton.buttonMarkup();
    },

    _wire: function() {
      var ref = this;
      var $element = ref.element;
      var ops = ref.options;
      var page = $element.find(&quot;div[data-role='content']&quot;);
      var optionLinkButton = page.find( &quot;#optionLinkButton&quot; );

      optionLinkButton.bind( &quot;click&quot;, function(event) {
        event.preventDefault();
        // toggle state.
        ref._setOption( &quot;state&quot;, ( ops.state == 1 ) ? 0 : 1 );
        return false;
      });

      $element.bind( &quot;submit&quot;, function(event) {
        event.preventDefault();
        var username = $element.find( &quot;input#username&quot; ).val();
        var password = $element.find( &quot;input#password&quot; ).val();
        var uievent = ( ops.state == 0 ) ? &quot;login&quot; : &quot;signup&quot;;
        var ui = {name:username, password:password};
        ref._trigger( uievent, {type:uievent}, ui );
        return false;
      });
    },

    _unwire: function() {
      var $element = this.element;
      var page = $element.find( &quot;div[data-role='content']&quot; );
      var optionLinkButton =  page.find( &quot;#optionLinkButton&quot; );
      optionLinkButton.unbind( &quot;click&quot; );
      $element.unbind( &quot;submit&quot; );
    },

    close: function() {
      var $element = this.element;
      this._trigger( &quot;close&quot;, {type:&quot;close&quot;} );
      $.mobile.changePage( $element.data(&quot;previous&quot;), undefined, false );
    },

    destroy: function() {
      this._unwire();
      // jQuery Mobile keeps adding a Submit button substitue to the template upon show,
      // Lets remove it here.
      var $element = this.element;
      var page = $element.find( &quot;div[data-role='content']&quot; );
      var submitButton = page.find( &quot;a[aria-label='submit']&quot; );
      submitButton.remove();
      // super destroy.
      jQuery.Widget.prototype.destroy.call( this );
      this.element = null;
    }

  });

})(jQuery)
</pre>
<p>You wanted code? You got it <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  I am not going to go into explaining the under-workings of <strong>$.widget</strong> or <strong>$.Widget</strong> but more the work we have here that relates to <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> and our application. Again, if you are curious, <a href="http://jqueryui.com/" target="_blank">jQuery UI</a> has some great documentation at <a href="http://jqueryui.com/docs/Developer_Guide" target="_blank">http://jqueryui.com/docs/Developer_Guide</a> and you can also look at the <strong>JavaScript</strong> source for <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a>. That is chock full of widgets. And then there is this awesome write up by <a href="http://www.erichynds.com" target="_blank">Eric Hynds</a>: <a href="http://www.erichynds.com/jquery/tips-for-developing-jquery-ui-widgets/" target="_blank">http://www.erichynds.com/jquery/tips-for-developing-jquery-ui-widgets/</a>.</p>
<p>Now, let&#8217;s step through it&#8230; If you are being introduced to <a href="http://jquery.com/" target="_blank">jQuery</a> by this article series: <strong>a)</strong> i hope i have not mislead you in my explanations and <strong>b)</strong> this might be the first time you have seen this anonymous function declaration:</p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
(function( $ ) {
...
})(jQuery)
</pre>
<p>There is more going on here (conflict resolution) than i will explain, but in essence this is a self-executing method that has a reference to <a href="http://jquery.com/" target="_blank">jQuery</a>. Basically, upon load any code within this anonymous function will be run and have access to <a href="http://jquery.com/" target="_blank">jQuery</a> using the <strong>$</strong> token; once <em>jquery.albums.loginDialog.js</em> is loaded, we invoke the <strong>$.widget</strong> factory method to create a <strong>widget</strong> accessible via <em>loginDialog</em>() on an element reference:</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<pre class="brush: jscript; first-line: 3; title: ;" title="">
$.widget( &quot;albums.loginDialog&quot;, {
...
} );
</pre>
<p>The second argument to <strong>$.widget</strong> &#8211; the whole big object &#8211; is basically the meat of our <strong>widget</strong>; its got some declared default options, overidden inherited methods and some other private and public methods to make our <strong>loginDialog</strong> work. Our options are just some default values to set the initial state (either to <em>login</em> or <em>signup</em>) and the textual content associated with the state. Our <strong>login dialog</strong> isn&#8217;t going to be very pretty or contain much content other than a form and a way to switch between <em>login</em> and <em>signup</em>.</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<pre class="brush: jscript; first-line: 5; title: ;" title="">
options: {
  state: 0, // 0 - log in state. 1 - sign up state.
  loginText: &quot;Log In&quot;,
  signUpText: &quot;Sign Up&quot;
},
</pre>
<p>When it enters <em>_create</em>() (inheritance call from <strong>$.Widget</strong>), is when we do some real magic:</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<pre class="brush: jscript; first-line: 13; title: ;" title="">
var $element = this.element;

// Current page reference.
var currentPage = $.mobile.activePage;
var pageLink = currentPage.attr( &quot;id&quot; );
// It is an internal page link.
if( pageLink.indexOf( &quot;.html&quot; ) == -1 ) pageLink = &quot;#&quot; + pageLink;
var closeButton = $element.find( &quot;div[class*='ui-header'] a#dialogCloseButton&quot; )
                          .attr( &quot;href&quot;, pageLink );
// Hold reference in custom data expando.
$element.data(&quot;previous&quot;, pageLink );
</pre>
<p>The target element (the one widget-ized by calling <strong>$(&#8221;#myElement&#8221;)</strong>.<em>loginDialog</em>()) is accessed using the this keyword and is available through the life of the <strong>widget</strong>. In order to get a reference to the current page prior to opening the <strong>loginDialog</strong>, we access the id value of <strong>$.mobile</strong>.<em>activePage</em> and determine if it is an external or internal page. We then pass that as the href value for the close button on the <strong>loginDialog</strong> and add a <strong>data-previous</strong> attribute to the target element. </p>
<p>After the previous page has been determined to return to after login or signup, we then wrap the <strong>dialog template</strong> element in a page <strong>div</strong> listen for events, change the state to the default defined in options and change the page to the <strong>loginDialog</strong>:</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<pre class="brush: jscript; first-line: 25; title: ;" title="">
// Wrap the content in a dialog page.
var wrapper = this._wrapDialog( $element );
// Wire interactions.
this._wire();
this._changeState( ops.state );
// For some reason, i have to add it to the DOM in order to changePage() to it.
$(&quot;body[class*=\&quot;ui-mobile-viewport\&quot;]&quot;).append(wrapper);
$.mobile.changePage( [currentPage, wrapper], &quot;pop&quot;, false );
</pre>
<p>You see that funky append before <strong>$.mobile</strong>.<em>changePage</em>()?</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<pre class="brush: jscript; first-line: 31; title: ;" title="">
$(&quot;body[class*=\&quot;ui-mobile-viewport\&quot;]&quot;).append(wrapper);
</pre>
<p>The comment above that line explains it, but for some reason i couldn&#8217;t just switch to this dynamically created page. Instead i had to add it quickly at the end of the body (accessed by the <em>ui-mobile-viewport</em> class) and then was able to switch from the previous page to show a <strong>loginDialog</strong>. No big deal, just something to look out for. </p>
<p>Most of what is in <em>jquery.albums.loginDialog</em>, if you have been following along, may be pretty familiar to you. We do the same sizing on <em>pagebeforeshow</em> and emptying on <em>pagehide</em>, and change values based on state using <a href="http://jquery.com/" target="_blank">jQuery</a>. Your basic fanfare. I just wanted to touch on two more methods in <em>jquery.albums.loginDialog</em>: <em>close</em> and <em>destroy</em>:</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<pre class="brush: jscript; first-line: 109; title: ;" title="">
close: function() {
var $element = this.element;
this._trigger( &quot;close&quot;, {type:&quot;close&quot;} );
$.mobile.changePage( $element.data(&quot;previous&quot;), undefined, false );
},

destroy: function() {
  this._unwire();
  // jQuery Mobile keeps adding a Submit button substitue to the template upon show,
  // Lets remove it here.
  var $element = this.element;
  var page = $element.find( &quot;div[data-role='content']&quot; );
  var submitButton = page.find( &quot;a[aria-label='submit']&quot; );
  submitButton.remove();
  // super destroy.
  jQuery.Widget.prototype.destroy.call( this );
  this.element = null;
}
</pre>
<p>The <em>close</em>() method we have exposed and is not part of <strong>$.Widget</strong>. That just allows access to anyone with a reference to the created <strong>loginDialog</strong> to directly close it (as opposed to explicitly closing it within the dialog). You can see that we change the page by using the previous data value set on the element within <em>_create</em>(). We also dispatch a &#8220;<em>close</em>&#8221; event using <em>_trigger</em>(). The <em>_trigger</em>() method is part of <strong>$.Widget</strong> and can be bound to like other events, yet the type is slightly different within the context of a <strong>widget</strong>. The type value is actually appended to the <strong>widget</strong> name, so if you were to listen for close on this:</p>
<pre class="brush: jscript; title: ;" title="">
$(&quot;#loginSignupDialog&quot;).tmpl().loginDialog().bind( &quot;logindialogclose&quot;, handleLoginDialogClose );
</pre>
<p>That&#8217;s one way to do it, though i often assign handlers by passing in a <strong>callback</strong> object like so:</p>
<pre class="brush: jscript; title: ;" title="">
$(&quot;#loginSignupDialog&quot;).tmpl().loginDialog( {
        close: function( evt, ui ) {
            ...
        }
});
</pre>
<p>We actually trigger two other events within our <strong>loginDialog</strong> &#8211; &#8220;<em>login</em>&#8221; and &#8220;<em>signup</em>&#8221; &#8211; which are dispatched upon submit based on current state. We&#8217;ll see how all this is handled a little later on in more code, but i quickly wanted to touch on something that looks odd in the <em>destroy</em>() override:</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<pre class="brush: jscript; title: ;" title="">
var $element = this.element;
var page = $element.find( &quot;div[data-role='content']&quot; );
var submitButton = page.find( &quot;a[aria-label='submit']&quot; );
submitButton.remove();
</pre>
<p>When a form is added top the <strong>DOM</strong> through <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a>, it actually duplicates and hides the originally declared <strong>submit</strong> button and decorates a that duplicate for display. In that decoration, it is given the <strong>aria-label</strong> attribute for accessibility. Not entirely a huge issue, but if you were to show the template form more than once, you would start to see n+ times the amount of submit buttons! So we just remove it in our <em>destroy</em> override and move on.</p>
<p>Alright. Hopefully you are still with me. You may or may not have created your first <a href="http://jquery.com/" target="_blank">jQuery</a> <strong>widget</strong>. Isn&#8217;t it glorious or not glorious, respectively? With our <strong>template</strong> and <strong>widget</strong> defined, now begs the question: <em>When do we show this thing?</em> </p>
<h2>Plugin</h2>
<p>So you thought introducing two new concepts (<a href="http://jquery.com/" target="_blank">jQuery</a> <strong>templates</strong> and <strong>widgets</strong>) was enough for one article? Well, in the words of television&#8217;s <strong>Emeril</strong>, &#8216;<em>We&#8217;re going to kick it up a notch!</em>&#8216; That&#8217;s actually probably a paraphrase. I don&#8217;t know the exact words he said and i don&#8217;t feel like googling it. I was just pandering to the developer crowd who enjoys watching cooking shows&#8230; Its a low point in this article and i am not proud of it. Let&#8217;s keep going.</p>
<p>If we step back and remember why we started doing all this business in this mini-series, we wanted to use validation on operations to our database documents. In the previous article we spoke of <strong>user context</strong>s, and updated our <strong>album</strong> document to require a user field. So, our main intent with this <strong>loginDialog</strong> is to verify a current session and then either login or signup a user. If the session is valid (user previously logged in) then, the user reference is stored and &#8211; dependent on the action &#8211; used in further transactions.</p>
<p>Now, we could just open the <strong>loginDialog</strong> all willy-nilly, here and there, and try to track down the persisted user across actions, but a saner approach (for me at least) is to encapsulate this logic in a <strong>plugin</strong>. You may be familiar with <a href="http://jquery.com/" target="_blank">jQuery</a> <strong>plugins</strong>&#8230; actually we have been using them throughout this whole series. We just haven&#8217;t directly looked at how they are made or work. Like I did with our <strong>widget</strong> example, I am not going to go into a discussion of <a href="http://jquery.com/">jQuery</a> <strong>plugins</strong> per se &#8211; I am going to try and focus on the task at hand and provide explanations as to how it pertains to our application as a whole. That said, to read more about <a href="http://jquery.com/" target="_blank">jQuery</a> <strong>plugins</strong>, this is always a great place to start: <a href="http://docs.jquery.com/Plugins/Authoring" target="_blank">http://docs.jquery.com/Plugins/Authoring</a>.</p>
<p>Alright, we are going to take a little piecemeal approach to fleshing out our <strong>plugin</strong>, explaining as we go along, and I&#8217;ll provide it in its entirety afterward. To start, open up your favorite editor, create a file named <em>jquery.albums.app.js</em> and save it in the <em>/_attachments/script</em> folder of our <strong>albums</strong> <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> directory. Add the following:</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
(function($) {

  $.albums = $.albums || {};
  $.extend( $.albums, {
  });

})(jQuery)
</pre>
<p>That is the start of our <strong>albums</strong> <strong>plugin</strong> which will be accessible by <strong>$.albums</strong>. We&#8217;re extending our (hopefully) newly created <strong>$.albums</strong> object to flesh out its public <strong>API</strong>. <strong>$.albums</strong> will serve as a facade/adaptor to the <strong>$.couch</strong> plugin and handle the display and event from the <strong>loginDialog</strong>. So there are roughly five main functions of out <strong>$.albums</strong> plugin:</p>
<ul>
<li>Log In &#8211; Direct log in request.</li>
<li>Log Out &#8211; Direct log out request</li>
<li>Save Document &#8211; Request to Create or Update a document.</li>
<li>Delete Document &#8211; Request to Delete a document.</li>
</ul>
<p>The <strong>Log In</strong> and <strong>Log Out</strong> methods mainly interface directly with <strong>$.couch</strong> and won&#8217;t deal with any UI. They are just facades to track the logged in user so we can properly send user data when creating or updating documents. The <strong>Save Document</strong> and <strong>Delete Document</strong> methods are more adaptors for <strong>$.couch</strong> communication &#8211; checking session and presenting the <strong>loginDialog</strong> if necessary. Update the <em>jquery.albums.app.js</em> with the following:</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38]; title: ;" title="">
(function($) {

  $.albums = $.albums || {};
  $.extend( $.albums, {

    dialog: undefined,
    database: undefined,

    logIn: function( name, password, options ) {
      doLogIn( name, password, options );
    },

    logOut: function( options ) {
      doLogOut( options );
    },

    saveDocument: function( document, options ) {
      checkSession( {
        available: function( userCtx ) {
          document.user = user;
          $.albums.database.saveDoc( document, options );
        },
        unavailable: function() {
          showDialog( options );
        }
      });
    },

    deleteDocument: function( document, options ) {
      checkSession( {
        available: function( userCtx ) {
          $.albums.database.removeDoc( document, options );
        },
        unavailable: function() {
          showDialog( options );
        }
      });
    }

  });

})(jQuery)
</pre>
<p>So there we have our 4 public methods of <strong>$.albums</strong>. We have also added to public properties: <strong>dialog</strong> and <strong>database</strong>. These two will be the targets to the <strong>loginDialog</strong> template and a reference to our <strong>albums</strong> database, respectively. This is so we don&#8217;t rely so heavily on globally declared variables to do what we need in our nice little encapsulated <strong>plugin</strong>. In any event, if you have looked at the contents of these methods, they all call other functions that we haven&#8217;t declared yet. Lets start with <em>checkSession</em>() in <strong>saveDocument</strong> and <strong>deleteDocument</strong>. Add the following after the <strong>$.extend</strong> declaration and prior to close of <em>function</em>():</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<pre class="brush: jscript; title: ;" title="">
function checkSession( options ) {
    options = options || {};
    $.couch.session( {
      success: function( response ) {
        var context = response.userCtx;
        if( context.name == null ) {
          if( options.unavailable ) options.unavailable();
        }
        else{
          if( options.available ) options.available( context );
        }
      },
      error: function( status, error, reason ) {
        if( options.unavailable ) options.unavailable();
      }
    });
}
</pre>
<p>The <em>checkSession</em>() does just that: request the current session established by our client through the <strong>$.couch</strong> plugin. If the <strong>userCtx</strong> comes back as null, there is no session and no logged in user on our end. We can try this out using <strong>curl</strong> on the command line:</p>
<pre class="brush: bash; title: ;" title="">
&gt; curl -vX GET http://127.0.0.1:5984/_session
&lt; {&quot;ok&quot;:true,&quot;userCtx&quot;:{&quot;name&quot;:null,&quot;roles&quot;:[]},&quot;info&quot;:{&quot;authentication_db&quot;:&quot;_users&quot;,&quot;authentication_handlers&quot;:[&quot;oauth&quot;,&quot;cookie&quot;,&quot;default&quot;]}}
</pre>
<p>Depending on the value of <strong>userCtx</strong>, <em>checkSession</em>() will invoke an <em>available</em>() or <em>unavailable</em>() <strong>callback</strong> method on the anonymous options argument. The available responder on <em>saveDocument</em>() and <em>deleteDocument</em>() is different &#8211; one saves, the other deletes &#8211; but if unavailable is entered, they both call <em>showDialog</em>(). Append the following script to <em>jquery.albums.app.js</em> after the <em>checkSession</em>() declaration:</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<pre class="brush: jscript; title: ;" title="">
function showDialog( options ) {
    $.albums.dialog.loginDialog( {
      login: function( evt, ui ) {
        doLogIn( ui.name, ui.password, {
          success: function( response ) {
            $.albums.dialog.loginDialog( &quot;close&quot; );
          },
          error: function( status, error, reason ) {
            alert( &quot;Error: &quot; + error + &quot;, &quot; + reason );
          }
        });
      },
      signup: function( evt, ui ) {
        doSignUp( ui.name, ui.password, {
          success: function( response ) {
            $.albums.dialog.loginDialog( &quot;close&quot; );
          },
          error: function( status, error, reason ) {
            alert( &quot;Error: &quot; + error + &quot;, &quot; + reason );
          }
        });
      }
    });
}
</pre>
<p>Hey! That&#8217;s using our <strong>widget</strong>! I don&#8217;t know why i seriously get excited when i see that&#8230; In any event, there it is in all its glory. The <strong>login template</strong> will be handed to <strong>$.albums</strong> and we&#8217;ll widget-ize it within the <em>showDialog</em>() invocation:</p>
<pre class="brush: jscript; title: ;" title="">
$.albums.dialog.loginDialog( {
...
});
</pre>
<p>If you remember back when we created the <strong>widget</strong>, it will dispatch two events when submitted based on state: <em>login</em> and <em>signup</em>. Here we have added the <strong>callbacks</strong> to those events which in turn call either <em>doLogIn</em>() or <em>doSignUp</em>(). We&#8217;ll get to that in a bit, but i wanted to point out the success responders in the anonymous <strong>callback</strong> objects we pass to those methods:</p>
<pre class="brush: jscript; title: ;" title="">
success: function( response ) {
    $.albums.dialog.loginDialog( &quot;close&quot; );
}
</pre>
<p>If we have passed being logged in/signed up, we close the <strong>loginDialog</strong>. We exposed the <em>close</em>() method in <em>jquery.albums.loginDialog.js</em>, but its important to note that you cannot call <em>close</em>() using dot-notation like a property. The reason is that we are not holding a reference to the <strong>loginDialog</strong>. Calling <strong>$(&#8221;#myElement&#8221;)</strong>.<em>loginDialog</em>() just decorates the target element on the <strong>DOM</strong>. We can still interface with <strong>$(&#8221;#myElement&#8221;)</strong> but those methods associated with the <strong>widget</strong> are not then accessible on the target element. So we call a public method through <em>loginDialog</em>().</p>
<p>OK. So <em>doLogin</em>(), <em>doLogout</em>() and <em>doSignUp</em>() are yet to be covered. For some reason i have this convention where if it is considered an internal response to a public invocation i prepend &#8216;<em>d</em>o&#8217; to the public method name. Some people prefer &#8220;<em>_</em>&#8220;. To each his own. Just if you are wondering&#8230; Let&#8217;s tackle the login and logout first, as they are easy. Add the following script to <em>jquery.albums.app.js</em> somewhere after the <strong>$.extend</strong> declaration and prior to the end of the <em>function</em>() block:</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<pre class="brush: jscript; title: ;" title="">
var user; /* _user &gt; document.name */

function doLogIn( name, password, options ) {
    options = options || {};
    var loginObj = {
      name:name,
      password:password,
      success: function( response ) {
        user = response.name;
        if( options.success ) options.success( response );
      },
      error: function( status, error, reason ) {
        if( options.error ) options.error( status, error, reason );
      }
    };
    $.couch.login( loginObj );
}

function doLogOut( options ) {
    options = options || {};
    $.couch.logout( {
      success: function( response ) {
        user = undefined;
        if( options.success ) options.success( response );
      },
      error: function( status, error, reason ) {
        if( options.error ) options.error( status, error, reason );
      }
    })
}
</pre>
<p>Again, we are just interfacing with the <strong>$.couch</strong> plugin to perform the <em>login</em>() and <em>logout</em>(). The only reason we go through <strong>$.albums</strong> instead of <strong>$.couch</strong> directly is to maintain the <strong>user</strong>, which we have privately declared. That user value is the one assigned to the user field of a document when a new <strong>album</strong> document will be created and saved through <strong>$.albums</strong> using <em>saveDocument</em>().</p>
<p>Alright, <strong>Sign Up</strong> is where the magic happens. Signing a user up through <strong>$.couch</strong> is a little trickier. In <a href="http://127.0.0.1:5984/_utils" target="_blank">Futon</a> it is all easy-peasy as we saw in the last article in this mini-series in a series. Now that we have taken our <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance out of <strong>Admin Party</strong> mode, the <strong>$.couch</strong>.<em>signUp</em>() method won&#8217;t work unless we are logged in as an admin. We don&#8217;t want to take the approach of <a href="http://127.0.0.1:5984/_utils" target="_blank">Futon</a> for the User Experience for our little application here. Our application shouldn&#8217;t act as an admin console to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database as well as its current function of just adding, updating and deleting <strong>album</strong> documents. </p>
<p>We going to secretly log in as an admin behind the scenes and set our new user up for gold and start adding documents. So, <strong>Sign Up</strong> is actually going to be a series of commands just to sign someone up, assign their proper <strong>user-role</strong> and create their session to allow them to start working with <strong>album</strong> documents. That sequence in readable terms is:</p>
<ol>
<li>Log In as Admin</li>
<li>Sign Up new User</li>
<li>Open new User document</li>
<li>Add &#8220;albums-user&#8221; User Role to new User</li>
<li>Log Out as Admin</li>
<li>Log In as new User</li>
</ol>
<p>Maybe the <em>jquery.couch</em> plugin has changed since the last revision i checked out, but that is the order of things to <em>signup</em> and <em>login</em> a new user as far as i understand. The signature for <strong>$.couch</strong>.<em>signUp</em>() method has no arguments for administration to do this more streamlined, so we are going to create a chain of commands to signup a new user a little more efficiently. Now, in actuality, i would turn to a server-side developer and ask pretty-please that they implement a proxy in whatever language to do this and not handle it all in <strong>JavaScript</strong> (especially since we are going to expose our admin credentials &#8211; <em>HIDE YOUR CHILDREN</em>!), but we&#8217;re having fun and not going to production with this, right? We&#8217;re taking some liberties to explore what we have&#8230;</p>
<p>Now, if you have not figured out yet in following these articles, i can get a little anal. But it isn&#8217;t about everything. I seem to get focused on one thing that really irks me. And one of those things is deeply nested anonymous <strong>callbacks</strong>. Sure i am guilty of doing it and when i do it i feel dirty, but i usually let it go if its not nesting too deep. This sequence of actions for <strong>Sign Up</strong>, however, i can foresee being really ugly if we just went with anonymous <strong>callback</strong> objects down the line. So what i did was create <strong>Queue</strong> and <strong>Command</strong> &#8220;classes&#8221; to keep my sanity. The following is the script for that. Open a new document in your favorite editor (we&#8217;ll get back to <em>jquery.albums.app.js</em> in a bit) and save the following script as <em>command_queue.js</em> in <em>/_attachments/script</em>:</p>
<p><em>/_attachments/script/command_queue.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
(function(window) {

    function Commandable() {}
    Commandable.prototype.execute = function( data ){};

    function Queue( ops ) {
        this.options = ops || {};
        this.list = [];
        this.command;

        this.addCommand = function( command ) {
            var length = this.list.length;
            if( length &gt; 0 ) {
                this.list[length-1].nextCommand = this;
            }
            this.list.push( command );
        }
    }
    var q = Queue.prototype = new Commandable();
    q.options = undefined;
    q.list = undefined;
    q.command = undefined;
    q.constructor = Queue;
    q.execute = function( data ) {
        if( this.list.length &gt; 0 ) {
            this.command = this.list.shift();
            this.command.execute( data );
        }
        else {
            this.command = undefined;
            if( this.options.complete ) {
                this.options.complete();
            }
        }
    }

    function Command( target, args, ops ) {
        this.target = target;
        this.args = args || [];
        this.options = ops || {};
        this.nextCommand = undefined;
    }
    var c = Command.prototype = new Commandable();
    c.constructor = Command;
    c.getCommandOptions = function( options, nextCommand ) {
        var responder = {
            ops: options,
            success: function( response ) {
                if( options &amp;&amp; options.success ) options.success( response );
                if( nextCommand ) {
                    nextCommand.execute( response );
                }
            },
            error: function( status, error, reason ) {
                if( options &amp;&amp; options.error ) options.error( status, error, reason );
            }
        };
        return $.extend( {}, this.options, responder );
    }
    c.execute = function( data ) {
        this.args.push( this.getCommandOptions( this.options, this.nextCommand ) );
        this.target.apply( this, this.args );
    }

window.Queue = Queue;
window.Command = Command;

}(window));
</pre>
<p>I&#8217;m not going to say it&#8217;s sophisticated by any means, but this is a simple implementation to allow us to chain commands together. That is done by adding <strong>Commands</strong> to the <strong>Queue</strong> using <em>addCommand</em>(), which then appends a command using the <em>nextCommand</em> property of the previous (if available) <strong>Command</strong>. Both <strong>Queue</strong> and <strong>Command</strong> have a method called <em>execute</em>() (as extensions of <strong>Commandable</strong>). Executing a <strong>Queue</strong> will start the chain of commands; executing a <strong>Command</strong> will invoke whatever <strong>target</strong> method supplied in the constructor. If this needs more explanation, please leave a comment. We&#8217;ll see how we use this by implementing our <em>doSignUp</em>() method in <em>jquery.albums.app.js</em>. Open up <em>jquery.albums.app.js</em> in your favorite editor and add the following script somewhere after the <strong>$.execute</strong> declaration and before the end of the <em>function</em>() block:</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<pre class="brush: jscript; title: ;" title="">
function doSignUp( name, password, options ) {
    options = options || {};
    var queueOptions = {
      complete: function() {
        if( options.success ) options.success();
      }
    }
    var queue = new Queue( queueOptions );
    queue.addCommand( new Command( $.albums.logIn, [&quot;toddanderson&quot;, &quot;admin123&quot;] ) );
    queue.addCommand( new Command( $.couch.signup, [{name:name}, password] ) );
    queue.addCommand( new OpenUserDocCommand() );
    queue.addCommand( new AssignRoleCommand() );
    queue.addCommand( new Command( $.albums.logOut ) );
    queue.addCommand( new Command( $.albums.logIn, [name, password], options ) );
    queue.execute();
}
</pre>
<p>There we have our sequence of command described earlier. You can see how we pass the target method and arguments to the <strong>Command</strong> to be executed and the queue of commands is assembled using <strong>Queue</strong>:<em>addCommand</em>(). Again, our admin credentials are exposed and available to all &#8211; I do not recommend this practice in real life. Its just us here. So, there are two commands there in the middle that we haven&#8217;t discussed and aren&#8217;t declared in <em>command_queue.js</em>. They are specific to our <strong>albums</strong> application, so we will define them in <em>jquery.albums.app.js</em>. With the file still open, add the following script after (or before) the <em>doSignUp</em>() declaration:</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<pre class="brush: jscript; title: ;" title="">
function OpenUserDocCommand( target, args, options ) {}
OpenUserDocCommand.prototype = new Command();
OpenUserDocCommand.prototype.execute = function( data ) {
      var $userDB = $.couch.db(&quot;_users&quot;);
      $userDB.openDoc( data.id, this.getCommandOptions( this.options, this.nextCommand ) );
}

function AssignRoleCommand( target, args, options ) {}
AssignRoleCommand.prototype = new Command();
AssignRoleCommand.prototype.execute = function( data ) {
      data.roles = [&quot;albums-user&quot;];
      var $userDB = $.couch.db(&quot;_users&quot;);
      $userDB.saveDoc( data, this.getCommandOptions( this.options, this.nextCommand ) );
}
</pre>
<p>Nothing too crazy going on in <strong>OpenUserDocCommand</strong> or <strong>AssignRoleCommand</strong>, just needed to do some work with the <strong>_users</strong> database of our <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance as an admin.</p>
<p>Guess what? That&#8217;s it! We&#8217;re done with <em>jquery.albums.app.js</em>. Whew! If you have stuck around, i am quite humbled. Seriously. A lot of code and rambling on. I don&#8217;t know if i would have made it. Anyway, here is <em>jquery.albums.app.js</em> in full:</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
(function($) {

  $.albums = $.albums || {};
  $.extend( $.albums, {

    dialog: undefined,
    database: undefined,

    logIn: function( name, password, options ) {
      doLogIn( name, password, options );
    },

    logOut: function( options ) {
      doLogOut( options );
    },

    saveDocument: function( document, options ) {
      checkSession( {
        available: function( userCtx ) {
          document.user = user;
          $.albums.database.saveDoc( document, options );
        },
        unavailable: function() {
          showDialog( options );
        }
      });
    },

    deleteDocument: function( document, options ) {
      checkSession( {
        available: function( userCtx ) {
          $.albums.database.removeDoc( document, options );
        },
        unavailable: function() {
          showDialog( options );
        }
      });
    }

  });

  var user; /* _user &gt; document.name */

  function OpenUserDocCommand( target, args, options ) {}
  OpenUserDocCommand.prototype = new Command();
  OpenUserDocCommand.prototype.execute = function( data ) {
      var $userDB = $.couch.db(&quot;_users&quot;);
      $userDB.openDoc( data.id, this.getCommandOptions( this.options, this.nextCommand ) );
  }

  function AssignRoleCommand( target, args, options ) {}
  AssignRoleCommand.prototype = new Command();
  AssignRoleCommand.prototype.execute = function( data ) {
      data.roles = [&quot;albums-user&quot;];
      var $userDB = $.couch.db(&quot;_users&quot;);
      $userDB.saveDoc( data, this.getCommandOptions( this.options, this.nextCommand ) );
  }

  function checkSession( options ) {
    options = options || {};
    $.couch.session( {
      success: function( response ) {
        var context = response.userCtx;
        if( context.name == null ) {
          if( options.unavailable ) options.unavailable();
        }
        else{
          if( options.available ) options.available( context );
        }
      },
      error: function( status, error, reason ) {
        if( options.unavailable ) options.unavailable();
      }
    });
  }

  function doLogIn( name, password, options ) {
    options = options || {};
    var loginObj = {
      name:name,
      password:password,
      success: function( response ) {
        user = response.name;
        if( options.success ) options.success( response );
      },
      error: function( status, error, reason ) {
        if( options.error ) options.error( status, error, reason );
      }
    };
    $.couch.login( loginObj );
  }

  function doLogOut( options ) {
    options = options || {};
    $.couch.logout( {
      success: function( response ) {
        user = undefined;
        if( options.success ) options.success( response );
      },
      error: function( status, error, reason ) {
        if( options.error ) options.error( status, error, reason );
      }
    })
  }

  function doSignUp( name, password, options ) {
    options = options || {};
    var queueOptions = {
      complete: function() {
        if( options.success ) options.success();
      }
    }
    var queue = new Queue( queueOptions );
    queue.addCommand( new Command( $.albums.logIn, [&quot;toddanderson&quot;, &quot;admin123&quot;] ) );
    queue.addCommand( new Command( $.couch.signup, [{name:name}, password] ) );
    queue.addCommand( new OpenUserDocCommand() );
    queue.addCommand( new AssignRoleCommand() );
    queue.addCommand( new Command( $.albums.logOut ) );
    queue.addCommand( new Command( $.albums.logIn, [name, password], options ) );
    queue.execute();
  }

  function showDialog( options ) {
    $.albums.dialog.loginDialog( {
      login: function( evt, ui ) {
        doLogIn( ui.name, ui.password, {
          success: function( response ) {
            $.albums.dialog.loginDialog( &quot;close&quot; );
          },
          error: function( status, error, reason ) {
            alert( &quot;Error: &quot; + error + &quot;, &quot; + reason );
          }
        });
      },
      signup: function( evt, ui ) {
        doSignUp( ui.name, ui.password, {
          success: function( response ) {
            $.albums.dialog.loginDialog( &quot;close&quot; );
          },
          error: function( status, error, reason ) {
            alert( &quot;Error: &quot; + error + &quot;, &quot; + reason );
          }
        });
      }
    });
  }

})(jQuery)
</pre>
<p>Now before you run off, kiss your significant other and tell him/her that you will soon be billionaires, we have a little more work to do to get this up and running in our <strong>Albums</strong>  application.</p>
<h2>Loader and Index</h2>
<p>We kind of went off the deep-end there and dove right into code that code stand on its own outside of our current design of the <strong>Albums</strong> application. That&#8217;s good, but now we gotta reel it back in and wire it up. To start, lets add our new scripts in the <em>loader</em>. Open up <em>/vendor/couchapp/_attachments/loader.js</em> and save the following modifications:</p>
<p><em>/vendor/couchapp/_attachments/loader.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [18,19,20]; title: ;" title="">
function couchapp_load(scripts) {
  for (var i=0; i &lt; scripts.length; i++) {
    document.write('&lt;script src=&quot;'+scripts[i]+'&quot;&gt;&lt;\/script&gt;')
  };
};

couchapp_load([
  &quot;/_utils/script/sha1.js&quot;,
  &quot;/_utils/script/json2.js&quot;,
  &quot;vendor/couchapp/jquery-1.4.4.js&quot;,
  &quot;/_utils/script/jquery.couch.js&quot;,
  &quot;vendor/couchapp/jquery.couch.app.js&quot;,
  &quot;vendor/couchapp/jquery.couch.app.util.js&quot;,
  &quot;vendor/couchapp/jquery.mustache.js&quot;,
  &quot;vendor/couchapp/jquery.evently.js&quot;,
  &quot;vendor/couchapp/jquery.mobile-1.0a2.js&quot;,
  &quot;vendor/couchapp/jquery.tmpl.js&quot;,
  &quot;script/command_queue.js&quot;,
  &quot;script/jquery.albums.app.js&quot;,
  &quot;script/jquery.albums.loginDialog.js&quot;
]);
</pre>
<p>We&#8217;ve just added the last three files we have been working on: the <em>command_queue</em> script and our <strong>$.albums</strong> plugin and <strong>loginDialog</strong> widget. Now we&#8217;re going to make some modifications to the inline script on our <em>index.html</em> document. In a <a href="http://custardbelly.com/blog/?p=332" target="_blank">previous article</a> we hooked up the saving of a new album document to the internal <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> <strong>addAlbum</strong> page, and were using the <em>jquery.couch</em> plugin directly to save the document. Now we are just going to go through our <strong>$.albums</strong> plugin to perform that action which will open the <strong>loginDialog</strong> if a session is currently not available on our client. Open the <em>/_attachments/index.html</em> file in your favorite editor and save the following modifications in the <em>handleDocumentReady</em>() function:</p>
<p><em>/attachments/index.html</em></p>
<pre class="brush: jscript; first-line: 79; highlight: [84,85,86,87,88,97]; title: ;" title="">
function handleDocumentReady()
{
    $(&quot;#home&quot;).bind( &quot;pagebeforeshow&quot;, refreshAlbums );
    refreshAlbums();

    // Set database reference and dialog template on albums.
    $.extend( $.albums, {
        database: $db,
        dialog:  $(&quot;#loginSignupDialog&quot;).tmpl()
    });

    $(&quot;#addSubmitButton&quot;).live( &quot;click&quot;, function( event ) {
        event.preventDefault();
        var document = {};
        document.artist = $(&quot;input#addArtistField&quot;).val();
        document.title = $(&quot;input#addTitleField&quot;).val();
        document.description = $(&quot;textarea#addDescriptionField&quot;).val();
        document.creation_date = ( new Date() ).getTime();
        $.albums.saveDocument( document, {
            success: function() {
                $.mobile.changePage( &quot;#home&quot;, &quot;slidedown&quot;, true, true );
            },
            error: function( status, error, reason ) {
                alert( &quot;Cannot save new document.\n&quot; + status + &quot;, &quot; + reason + &quot;, &quot; + error );
            }
        });
        return false;
    });

    $(&quot;#addAlbum&quot;).bind( &quot;pagehide&quot;, function() {
        $(&quot;input#addArtistField&quot;).val( &quot;&quot; );
        $(&quot;input#addTitleField&quot;).val( &quot;&quot; );
        $(&quot;textarea#addDescriptionField&quot;).val( &quot;&quot; );
    });
}
</pre>
<p>Not that much to change. First we assign the default properties for the dialog <strong>template</strong> and database reference for our <strong>$.albums</strong> plugin and then we replace the call to save the document using <em>jquery.couch</em> to that of our <strong>$.albums</strong> plugin. Ta-da! Now we can add new documents as a logged in user.</p>
<p>There is, however, two more places that we need to interact with our <strong>$.albums</strong> plugin: the <strong>edit</strong> page and the <strong>delete</strong> page. Without modifying those and with the new authorization and validation we have introduced, we&#8217;d only be able to create and read documents&#8230; </p>
<p><em>Oh nos! There are tons of albums that i entered in late at night in a different state of mind! I am second guessing my decision on wanting <strong>Hall &#038; Oates</strong>&#8216;</em> War Babies! </p>
<p>These are the type of exclamations i am assuming are going through your head&#8230; because i would never&#8230;</p>
<h2>album-delete and album-edit</h2>
<p>If you go way back in this article series and have been following along, you may remember that we create quasi-view controllers for our <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> <strong>template</strong> pages and included the as <strong>partials</strong> in the <strong>show function</strong>. There are two that we need to modify with our recent changes to using the <strong>$.albums</strong> plugin to verify session: <em>/_attachments/script/album-delete-dialog.js</em> and <em>/_attachments/script/album-edit-page.js</em>. They will be small changes, but once deployed will give our application a little more security on who can perform modifications on <strong>album</strong> documents.</p>
<p>Open up <em>/_attachments/script/album-delete-dialog.js</em> in your favorite editor and save the following change to the <em>handleDelete</em>() function:</p>
<p><em>/_attachments/script/album-delete-dialog.js</em></p>
<pre class="brush: jscript; first-line: 32; highlight: [40]; title: ;" title="">
function handleDelete( event )
{
    event.preventDefault();
    var docId = $(&quot;#dialogContent&quot;).data(&quot;identity&quot;);
    // First open doc based on ID in order to get full document.
    $db.openDoc( docId, {
        success: function( document ) {
            // Then use the opened doc as reference to remove.
            $.albums.deleteDocument( document, {
                success: function() {
                    $.mobile.changePage( &quot;#home&quot;, &quot;slide&quot;, true, true );
                },
                error: function() {
                    alert( &quot;Could not remove document with id: &quot; + docId );
                }
            });
        },
        error: function() {
            alert( &quot;Could not find document with id: &quot; + docId );
        }
    });
    return false;
}
</pre>
<p>Open up <em>/_attachments/script/album-edit-page.js</em> in your favorite editor and save the following change to <em>saveDocument</em>():</p>
<p><em>/_attachments/script/album-edit-page.js</em></p>
<pre class="brush: jscript; first-line: 42; highlight: [44]; title: ;" title="">
function saveDocument( document )
{
    $.albums.saveDocument( document, {
        success: function( response )  {
            updateEditableAlbum( document );
            navigateToAlbumPage( document._id );
        },
        error: function( status, error, reason ) {
            alert( &quot;Cannot save document: &quot; + document._id + &quot;\n&quot; + reason );
        }
    });
}
</pre>
<p>That&#8217;s all! basically moved away from actions through the reference to our <strong>albums</strong> database to using the <strong>$.albums</strong> plugin. Finally. Now let&#8217;s push all this to our <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance so we can play around with it.</p>
<h2>Deployment</h2>
<p>If you remember from the last article when we introduced authorization, we need to pass our credentials when we push our couchapp to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance:</p>
<pre class="brush: bash; title: ;" title="">
couchapp push albums http://toddanderson:admin123@127.0.0.1:5984/albums
</pre>
<p>You&#8217;ll will have to replace to username and password, but once we have pushed we can now checkout our application at <a href="http://127.0.0.1:5984/albums/_design/albums/index.html" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html</a>. If you visit your application and try to either add, edit or delete a document and have not previously logged in, you will see something on the following:</p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_7_2_2.png" alt="Log In" /><br />
<em>[Log In]</em></p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_7_2_1.png" alt="Log In" /><br />
<em>[Sign Up]</em></p>
<h2>Conclusion</h2>
<p>We have come a long way! We now have authorization and user validation in our <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> <strong>albums</strong> application ensuring that a user must be logged in to create a new <strong>album</strong> document and that the owner of a document is the only one that can make modifications or delete the document from the database. Fun stuff.</p>
<p>I think this is going to be the last article of this series. Of course if this application were to go live, it would need a lot more work. For instance, the ability to log in and log out persisted on every page and information about who is logged in, etc. &#8211; but i will leave that up to you if you want to keep going. Hope you had fun and gleaned some useful information that i hope is not misleading.</p>
<p>Thanks again if you have actually took the time to follow along in this series. I am truly humbled if you sat through it all.</p>
<p>Cheers!</p>
<p><em>[Note] This post was written against the following software versions:</em><br />
<strong>CouchDB </strong>– 1.0.1<br />
<strong>CouchApp</strong> – 0.7.2<br />
<strong>jQuery</strong> – 1.4.4<br />
<strong>jQuery Mobile</strong> – 1.0a2<br />
<strong>jQuery Templates Plugin</strong> 1.0.0pre<br />
<em>If you have found this post and any piece has moved forward, hopefully the examples are still viable/useful. I will not be updating the examples in this post in parellel with updates to any of the previously mentioned software, unless explicitly noted.</em></p>
<p><strong>Articles in this series:</strong></p>
<ol>
<li><a href="http://custardbelly.com/blog/?p=244" target="_blank">Getting Started</a></li>
<li><a href="http://custardbelly.com/blog/?p=278" target="_blank">Displaying a page detail of a single album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=297" target="_blank">Templates and Mustache</a></li>
<li><a href="http://custardbelly.com/blog/?p=318" target="_blank">Displaying an editable page of an album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=332" target="_blank">Creating and Adding an album document.</a></li>
<li><a href="http://custardbelly.com/blog/?p=344" target="_blank">Deleting an album document</a></li>
<li><a href="http://custardbelly.com/blog/?p=360" target="_blank">Authorization and Validation &#8211; Part 1</a></li>
<li><a href="http://custardbelly.com/blog/?p=394">Authorization and Validation &#8211; Part 2</a></li>
</ol>
<p><a href="http://custardbelly.com/downloads/couchapp/jqm_couchdb_albums.zip">Full source for albums couchapp available here</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/couchdb/" title="View all posts in CouchDB" rel="category tag">CouchDB</a>,  <a href="http://custardbelly.com/blog/category/jquery/" title="View all posts in jquery" rel="category tag">jquery</a>,  <a href="http://custardbelly.com/blog/category/jquery-mobile/" title="View all posts in jquery-mobile" rel="category tag">jquery-mobile</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2011/03/04/jquery-mobile-couchdb-part-7-2-%e2%80%93-authorization-and-validation/#comments" rev="post-394"  title="Comment on jQuery Mobile + CouchDB: Part 7.2 – Authorization and Validation">6 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2011-03-04T12:42">March 4, 2011</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-394-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-360" class="post-360 post hentry category-couchdb category-jquery category-jquery-mobile full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2011/03/04/jquery-mobile-couchdb-part-7-1-authorization-and-validation/" title="Permanent link to jQuery Mobile + CouchDB: Part 7.1 &#8211; Authorization and Validation" rel="bookmark" rev="post-360">jQuery Mobile + CouchDB: Part 7.1 &#8211; Authorization and Validation</a></h1>
	
	<div class="entry-content full-content">
		<p>In my <a href="http://custardbelly.com/blog/?p=344" target="_blank">previous article</a> I addressed deleting documents from the <strong>albums</strong> database within <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> using the <em>jquery.couch</em> plugin and hacked around <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> a bit to get an external page to act as a dialog without updating the hash location. All great stuff, and we ended off having an application that provided the basics when working with documents &#8211; <strong>C</strong>reate <strong>R</strong>ead <strong>U</strong>pdate and <strong>D</strong>elete. After that post, I decided it was high time to throw a wrench into the mix and lock down the <strong>admin party</strong> we have been having. It&#8217;s been a good run&#8230;</p>
<p><em>Wait&#8230; so what&#8217;s with the versioning of <strong>Part 7</strong> in the title?! Its a multipart article of an article series. Barring i don&#8217;t break the space-time continuum for breaking up an article into sections, introducing authorization and validation will be spread over a couple posts. There is a lot of information involving set-up and development, plus we will jump into some new concepts &#8211; such as <strong>jQuery widgets and plugins</strong> &#8211; that may be a little too much information to digest in a single article.</em></p>
<p>In the first installment of this multi-part article I intend to address authorization and validation of our document operations so as to not let any old joey-bagadonuts hit the application and start adding, deleting and modifying our precious album list we have been painstakingly curating. If you have been following along, you may have noticed that we have thrown security and user-permitted actions out the window. This article won&#8217;t address the real breadth of security that your <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance should employ, but I will cover moving away from our <strong>admin party</strong> (anybody can do anything) and introduce the concept of user contexts, as well as how they can be used to validate operations requested for documents in the <strong>albums</strong> database of our <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance.</p>
<h2>Light Reading</h2>
<p>Before I start, there are two excellent articles out there that address authorization and validation in <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> that are indespensible. I read them before I started this series while working on another project, but came back to them as a refresher. I recommend you go check them out as they provide a more concise explanation of the work we are about to do (i&#8217;ll just touch on the finer points to get this application up and running). They are:</p>
<p><a href="http://blog.couchone.com/" target="_blank">CouchOne</a> &#8211; <a href="http://blog.couchone.com/post/1027100082/whats-new-in-couchdb-1-0-part-4-securityn-stuff" target="_blank">What’s new in CouchDB 1.0 — Part 4: Security’n stuff: Users, Authentication, Authorisation and Permissions</a><br />
<a href="http://guide.couchdb.org/index.html" target="_blank">CouchDB <em>The Definitive Guide</em></a> &#8211; <a href="http://guide.couchdb.org/draft/validation.html" target="_blank">Validation Functions</a></p>
<p>While those articles are an excellent resource for the task at hand, the sites themselves have a wealth of information which I highly suggest perusing, as well. Alright, armed with a little knowledge, lets dig in.</p>
<h2>Fix This</h2>
<p><em>If you have already taken your <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance out of admin party, you can skip this section or read on.</em></p>
<p>If you have been following along in this series and have only been using the command line to interact with <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a>, there is a utility application called <a href="http://wiki.apache.org/couchdb/Getting_started_with_Futon" target="_blank">Futon</a> that ships with <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a>. I actually browse my <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance using <a href="http://wiki.apache.org/couchdb/Getting_started_with_Futon" target="_blank">Futon</a> in <a href="http://www.couchone.com/get" target="_blank">CouchOne (neé CouchDBX for Mac)</a>. If you have ever visited <a href="http://127.0.0.1:5984/_utils" target="_blank">http://127.0.0.1:5984/_utils</a>, that&#8217;s <strong>Futon</strong>. If you have a version of <a href="http://www.couchone.com/get" target="_blank">CouchOne</a> running on your machine, that shows <strong>Futon</strong> within the browse window. I recommend using <a href="http://www.couchone.com/get" target="_blank">CouchOne</a> for local development as it makes it easier to start and stop the service as well as pretty prints out the http calls (not as verbose as i would like, but still useful).</p>
<p>So if you&#8217;ve visited <a href="http://127.0.0.1:5984/_utils" target="_blank">Futon</a> and have been running our application that we have built along in the series under <strong>admin party</strong> (ie. all access), then you may see something of the sort on the right hand side of <a href="http://127.0.0.1:5984/_utils" target="_blank">Futon</a>. Notice the bottom portion:</p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_7_1_1.png" alt="Futon side panel" /><br />
<em>[Futon side panel]</em></p>
<p>We intend to Fix this.</p>
<p>Click that link, and a dialog should appear looking like the following:</p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_7_1_2.png" alt="Create Server Admin" /><br />
<em>[Create Server Admin]</em></p>
<p>Make sure to read what is in that dialog as it is useful and i will not reiterate its information here&#8230; we&#8217;re just trying to get back to coding people! Enter in whatever <strong>username</strong> and <strong>password</strong> you choose. For the purposes of this article series (as the information will be used later) I entered:</p>
<pre class="brush: bash; title: ;" title="">
u: toddanderson
p: admin123
</pre>
<p>Click <em>Create</em> to create the <strong>admin</strong> user and relax. What just happened is that you created an <strong>admin</strong> that can now do everything everybody used to be able to do. That <strong>username</strong> and <strong>hashed password</strong> are now saved in <em>/etc/couchdb/local.ini</em> of your <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance and is viewable in <a href="http://127.0.0.1:5984/_utils" target="_blank">Futon</a> when you go to <strong>Configuration</strong>:</p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_7_1_3.png" alt="Configuration Panel" /><br />
<em>[Configuration panel]</em></p>
<p>I have to admit, I am doing this all backtracking. Meaning I took my <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance off of <strong>admin party</strong> some time ago. So I am trusting this is still the way to go about it. And I am hoping that since <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> 1.0+ there has been a <em>_users</em> database. To check if there is within <a href="http://127.0.0.1:5984/_utils" target="_blank">Futon</a>, go to <strong>Overview</strong> and one of the first databases listed should be <em>_users</em>. If its there, great! It should probably even have its authentication validation view included so we are all set, and the <strong>admin</strong> you just created may or may not be automatically entered as a user (i have on mine).</p>
<p>If <em>_users</em> is not available for you&#8230; leave a comment and we can work something out.</p>
<h2>Creating Users</h2>
<p>Remember that rush of power you had when <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> was running under <strong>admin party</strong>? That light may have gone out once you created an <strong>admin</strong>&#8230; but think of it &#8211; now you possess the control to create/update/delete as many users as you want. Isn&#8217;t it glorious. Now we are going to reign it in a bit and create a new user.</p>
<p>The easiest way to set up a new user is through <a href="http://127.0.0.1:5984/_utils" target="_blank">Futon</a>. If you are still logged in as the <strong>admin</strong> you just created, log out from the right hand panel and use the <strong>Signup</strong> link:</p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_7_1_4.png" alt="Futon Sign Up" /><br />
<em>[FutonSign Up]</em></p>
<p>That will open up the <strong>Sign Up</strong> dialog allowing you to enter a <strong>username</strong> and <strong>password</strong>:</p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_7_1_5.png" alt="Create User Dialog" /><br />
<em>[Create User Dialog]</em></p>
<p>I am creating a new user named <em>custardbelly</em> with a super-secret password that will be salted using <strong>sha1</strong>. That is all handled by the<em> jquery.couch</em> plugin (the same one we have been using in the examples in this series) employed by <a href="http://127.0.0.1:5984/_utils" target="_blank">Futon</a>. If we open up the new user from the <em>_users</em> database we should see the following:</p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_7_1_6.png" alt="User Entry" /><br />
<em>[User Entry]</em></p>
<p>There are a couple things to note here. First off, I took that screen shot after i already assigned a role (<em>&#8220;albums-user&#8221;</em>) to it. My bad. To do that for you new user, just click on the roles value field and enter <em>&#8220;albums-user&#8221;</em> (with quotes). That role assignment will be used later when validating documents, so don&#8217;t think too hard about it right now.</p>
<p>The other things of note are the auto-generated <strong>type</strong> field with a value of <em>&#8220;user&#8221;</em>, and the <strong>password_sha</strong> and <strong>salt</strong> fields &#8211; auto-generated and populated with values created through the <em>jquery.couch</em> plugin during signup. The <strong>_id</strong> for a user also has to have the form of reverse-domain for a couchdb user: <em>org.couchdb.user:custardbelly</em>. It must be in that format to be a valid user id so if you ever go about creating a new User manually, either from the <em>_user</em> database <strong>New Document</strong> option or from the command line, keep that in mind. Last, but not least, the <strong>name</strong> field is populated with the value of the <em>username</em> (the one entered in the <strong>Sign Up</strong> dialog through <a href="http://127.0.0.1:5984/_utils" target="_blank">Futon</a> and the value at the end of the <strong>_id</strong> property). The name property is commonly used in validating documents against a user context which we will get into a little later.</p>
<p>That said, you could create a new user using the database controls in <a href="http://127.0.0.1:5984/_utils" target="_blank">Futon</a> or the command line, but some extra work would be needed to create that <strong>sha1</strong> encrypted password. It would be neat to have a script that would do that and output a <strong>json</strong> file that can be passed in the command line creation of a User, but i won&#8217;t go into that right now. Just so you can see what that would look like, the following is an example of how to create a user using the command line:</p>
<pre class="brush: bash; title: ;" title="">
curl -vX PUT http://toddanderson:admin123@127.0.0.1:5984/_users/org.couchdb.user:custardbelly -d '{&quot;name&quot;:&quot;custardbelly&quot;, &quot;roles&quot;:[&quot;albums-user&quot;], &quot;type&quot;:&quot;user&quot;, &quot;password-sha&quot;:&quot;39bc3d994b6a0ce19cb60726b630237d494ae928&quot;, &quot;salt&quot;:&quot;312b9eb84105e322eb508a559b0000d3&quot;}'
</pre>
<p>The <strong>-d</strong> argument takes a valid <strong>json</strong> string and you could alternatively point to a file using:</p>
<pre class="brush: bash; title: ;" title="">
-d @custardbelly_user.json
</pre>
<p>So yeah, a script would be awesome to perform the password encryption and generate that <strong>json</strong> file with the proper fields. If you have one, let me know. Otherwise it might be a little project for me at a later date. For now, I just use <a href="http://127.0.0.1:5984/_utils" target="_blank">Futon</a> to create new users.</p>
<h2>Adding User to Documents</h2>
<p>Great. Now we have to associate a user with each album in the <strong>albums</strong> database. Technically, becaaue we are working with a document-based DMS, we don&#8217;t have to go and add a <strong>user</strong> field to all the <strong>album</strong> documents we currently have entered. Not having a <strong>user</strong> field on an <strong>album</strong> document &#8211; though we will include on in all future creates and updates to albums &#8211; will not break either party: client or server. But it will be needed for validation on operations. And because we are working with a lovely document-based DMS, its not pulling teeth. For the <strong>album</strong> documents i currently have in my <strong>albums</strong> database, i have gone and added a <strong>user</strong> field with the value of the user <em>name</em> previously created:</p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_7_1_7.png" alt="Document Update" /><br />
<em>[Document Update]</em></p>
<p>It is important to not that the <strong>user</strong> field value of an <strong>album</strong> document must match a <strong>name</strong> field value from a <em>_user</em> database document. This property will be assigned to the <em>user</em> attribute of a <strong>user context</strong> and be used for comparison on validation. So&#8230; human error and misspelling are high at stake in this case when done manually, unfortunately &#8211; i&#8217;ve definitely been guilty of it and spent hours cursing and pointing at mouses and monitors when only to finally say, &#8220;<em>oh&#8230; missed the &#8216;t&#8217; in there. huh</em>&#8220;.</p>
<p>Alright. Now we have our album(s) associated with user(s) from the <em>_user</em> database. Let&#8217;s take a peek at how validation will occur when performing operations on albums with our client-side <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> application. <em>(ah, <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a>. not much of it in this article of the series, unfortunately. But hold on to your hats&#8230; there&#8217;s a ton of it in the next!)</em></p>
<h2>Validation</h2>
<p>When operations to a document are requested, <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> performs, or rather invokes, validation based on the presence of a <strong>validate_doc_update</strong> script in each <em>/_design</em> document of a database. If the script is not present, there is no validation and anyone (barring the security level assigned to the database) can do whatever they want. So we took <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> out of <strong>admin party</strong>, but that only puts restrictions on operations that require admin credentials once an <strong>admin</strong> is stored &#8211; operations like user creation, user role assignment, database creation, etc, essentially administrative tasks for your <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance. However, without a <strong>validate_doc_updates</strong> script in the <em>/_design</em> of our <strong>albums</strong> <a href="http://couchapp.org/page/index" target="_blank">CouchApp</a>, anyone can still update an <strong>album</strong> document however they see fit.</p>
<p>Truthfully, i spend my days as a client-side architect/developer. So i can&#8217;t speak well enough about how <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> invokes the <strong>validate_doc_update</strong> and why we are allowed to use <strong>JavaScript</strong>. There is some type of interpreter that intercepts a create or update (/delete) operation and invokes the <strong>validate_update_doc</strong> script. If no exception is thrown from that script, it continues along with the operation. Easy concept to grasp and a beautiful design by the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> team&#8230; someday i will dig more into how all this comes to happen&#8230;</p>
<p>So, we can use good ol&#8217; familiar <strong>JavaScript</strong> for our validation. When the <strong>validate_doc_update</strong> is invoked, it is passed two document objects &#8211; the &#8220;if-all-goes-well&#8221; new document and old document &#8211; and the <strong>user context</strong>. The <strong>user context</strong> object is representative of the current user logged into a session and has property values that can be used for validation on document operations.</p>
<p>To keep you even further from creating the <strong>validate_update_doc</strong> <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> , let&#8217;s take a look at what is returned when you create a session:</p>
<pre class="brush: bash; title: ;" title="">
&gt; curl http://toddanderson:6s0jo772c0kcnwg@127.0.0.1:5984/_session
&gt; {&quot;ok&quot;:true,&quot;userCtx&quot;:{&quot;name&quot;:&quot;toddanderson&quot;,&quot;roles&quot;:[&quot;_admin&quot;,&quot;admin&quot;]},&quot;info&quot;:{&quot;authentication_db&quot;:&quot;_users&quot;,&quot;authentication_handlers&quot;:[&quot;oauth&quot;,&quot;cookie&quot;,&quot;default&quot;],&quot;authenticated&quot;:&quot;default&quot;}}
</pre>
<p>So that <strong>userCtx</strong> object is essentially what is passed during invocation of <strong>validation_doc_update</strong>. On to the code! Open up your favorite text editor, add the following script and save the file as <em>validate_doc_update.js</em> in the root of your <strong>albums</strong> <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> directory (for me, in following with this series, is: <em>/Documents/workspace/custardbelly/couchdb/albums/</em>):</p>
<p><em>/validate_doc_update.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
function( newDoc, oldDoc, userCtx ) {
  // Load validation script.
  var v = require(&quot;vendor/couchapp/lib/validate&quot;).init( newDoc, oldDoc, userCtx );

  // Create method to test if valid user.
  v.isAlbumsUser = function() {
    return v.isAdmin() || userCtx.roles.indexOf(&quot;albums-user&quot;) != -1;
  }

  // Ensure that a current session exists for editing.
  if( !userCtx.name ) {
    v.unauthorized( &quot;You need to be logged in order to do that.&quot; );
  }
  else if( !v.isAlbumsUser() ) {
    v.forbidden( &quot;You do not have proper access to edit this document.&quot; );
  }

  // Ensure that any updates need to match user.
  var isDeletingWithoutPermission = ( newDoc._deleted &amp;&amp; ( oldDoc.user != userCtx.name ) );
  var isUpdatingWithoutPermission = ( newDoc.user != userCtx.name ) || ( oldDoc &amp;&amp; ( newDoc.user != oldDoc.user ) );
  // If either non-permission criteria is met, checking delete first...
  if( !v.isAdmin() &amp;&amp; isDeletingWithoutPermission ) {
    v.forbidden( &quot;Only the creator of this document has permission to delete.&quot; );
  }
  else if( !v.isAdmin &amp;&amp; ( !newDoc._deleted &amp;&amp; isUpdatingWithoutPermission ) ) {
    v.forbidden( &quot;Only the creator of this document has permission to update.&quot; );
  }
  else {
    // If it is being deleted, we are all set.
    if( newDoc._deleted ) return true;

    // Require a user field.
    v.require( &quot;user&quot; );
    // Ensure the assigned user is not changed.
    v.unchanged( &quot;user&quot; );
    // Ensure that user does not have value of undefined.
    v.assert( (newDoc.user != &quot;undefined&quot;), &quot;New documents must have an associated user.&quot; );
  }
}
</pre>
<p>First off, when you create a <a href="http://couchapp.org/page/index" target="_blank">CouchApp</a>, you get a bunch of scripts available to you in the <em>/vendor</em> directory. We seen and used some of these, most notably in the <em>loader.js</em> from <em>/vender/couchapp/_attachments</em> that is loaded by the <em>index.html</em> document of our <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> application. In the first line of our <strong>validate_doc_update</strong> we require another <strong>JavaScript</strong> provided through <a href="http://couchapp.org/page/index" target="_blank">CouchApp</a> &#8211; the <em>validate.js</em>. The <em>validate.js</em> script essentially exposes helper methods for determining user roles and validating document updates as well as convenience methods for throwing exceptions (as forbidden or unauthorized). The <em>init</em>() method is a utility method to access a new instance of this validation object and call these methods against the <strong>newDoc</strong>, <strong>oldDoc</strong> and <strong>userCtx</strong> objects.</p>
<p>We add a new method to our validation object to check if the user has a role of is an <em>&#8220;albums-user&#8221;</em> or is an <strong>admin</strong>:</p>
<p><em>/validate_doc_update.js</em></p>
<pre class="brush: jscript; first-line: 6; title: ;" title="">
v.isAlbumsUser = function() {
  return v.isAdmin() || userCtx.roles.indexOf(&quot;albums-user&quot;) != -1;
}
</pre>
<p>That is then used to verify that we can go forward in our validation of the document based on the <strong>userCtx</strong> and documents. It is important to note that a document that is in the process of being deleted is assigned a <em>_deleted</em> property before being passed to the <strong>validate_doc_update</strong>. That is important to our validation as it will not necessarily be filled with a <em>&#8220;user&#8221;</em> property, nor is the <em>&#8220;user&#8221;</em> property necessary on the <strong>newDoc</strong> to validate the operation. We need to check if a delete operation is valid by comparing the <strong>oldDoc</strong> to the <strong>userCtx</strong>:</p>
<p><em>/validate_doc_update.js</em></p>
<pre class="brush: jscript; first-line: 19; title: ;" title="">
var isDeletingWithoutPermission = ( newDoc._deleted &amp;&amp; ( oldDoc.user != userCtx.name ) );
var isUpdatingWithoutPermission = ( newDoc.user != userCtx.name ) || ( oldDoc &amp;&amp; ( newDoc.user != oldDoc.user ) );
// If either non-permission criteria is met, checking delete first...
if( !v.isAdmin() &amp;&amp; isDeletingWithoutPermission ) {
  v.forbidden( &quot;Only the creator of this document has permission to delete.&quot; );
}
else if( !v.isAdmin &amp;&amp; ( !newDoc._deleted &amp;&amp; isUpdatingWithoutPermission ) ) {
  v.forbidden( &quot;Only the creator of this document has permission to update.&quot; );
}
</pre>
<p>If our validation passes through that, then all that is left is to make sure that we have the correct fields and their values are valid:</p>
<p>/validate_doc_update.js</p>
<pre class="brush: jscript; first-line: 28; title: ;" title="">
else {
  // If it is being deleted, we are all set.
  if( newDoc._deleted ) return true;

  // Require a user field.
  v.require( &quot;user&quot; );
  // Ensure the assigned user is not changed.
  v.unchanged( &quot;user&quot; );
  // Ensure that user does not have value of undefined.
  v.assert( (newDoc.user != &quot;undefined&quot;), &quot;New documents must have an associated user.&quot; );
}
</pre>
<p>If we are simply deleting the document, return true to pass the validation, else we ensure that a <strong>user</strong> field is present, that it has not changed and that it is not undefined. If none of those checks throws an exception, the validation will be complete and the update (create or update) will pass.</p>
<p>What&#8217;s cool about <a href="http://127.0.0.1:5984/_utils" target="_blank">Futon</a> is that it will use that validation script when working on documents within <a href="http://127.0.0.1:5984/_utils" target="_blank">Futon</a>&#8230; pretty meta. So if you have shut down validation to no-one-at-all-ever, and go and try to update a document in your database, you&#8217;ll get an alert and will have to log in as an admin and change your <strong>validate_doc_update</strong>.</p>
<h3>Push Validation to our Albums CouchApp</h3>
<p>Alright, with our <strong>validate_doc_update</strong> script ready to go, its time to push it live. If you have been following along in this series, you are familiar with how we push updates using <a href="http://couchapp.org/page/index" target="_blank">couchapp</a>. However, with our new privileges that we implemented in this article, we have to do it a little differently. Whoa whoa whoa! Calm down&#8230; its not that bad. We just have to pass our admin credentials in the command:</p>
<pre class="brush: bash; title: ;" title="">
couchapp push albums http://toddanderson:admin123@127.0.0.1:5984/albums
</pre>
<p>All we did was use <a href="http://en.wikipedia.org/wiki/Basic_access_authentication" target="_blank">basic access authentication</a> to push an update to our <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> with the credentials of the <strong>admin</strong> we created previously. Now you have authority. Can you feel the power? Sometimes i think i feel the power, but it could be gas. Not this time, though. I swear.</p>
<h2>Security</h2>
<p>If you have been playing around with <a href="http://127.0.0.1:5984/_utils" target="_blank">Futon</a> and looked at your <strong>albums</strong> database, you may have seen a <strong>Security&#8230;</strong> option in the list of actions:</p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_7_1_8.png" alt="Security Option" /><br />
<em>[Security Option]</em></p>
<p>If you log in as the <strong>administrator</strong>, click option and fill in the credentials with the admin and roles we created previously in this article, you will enforce a login prior to viewing the application:</p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_7_1_9.png" alt="Security Dialog" /><br />
<em>[Security Dialog]</em></p>
<p>If you save that and logout of Futon then try to access the <strong>albums</strong> database, you will get the following alert:</p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_7_1_10.png" alt="Security Alert" /><br />
<em>[Security Alert]</em></p>
<p>Likewise, if we now browse to our application at <a href="http://127.0.0.1:5984/albums/_design/albums/index.html" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html</a> you&#8217;ll be presented with this page on landing:</p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_7_1_11.png" alt="Application Landing" /><br />
<em>[Application Landing]</em></p>
<p>That is the <em>session.html</em> shipped with <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> that provides an easy way to present a login or signup gateway page for your application. We don&#8217;t want that. It breaks the User Experience for our <strong>albums</strong> application. We are going to present a login/signup only when a user tries to perform an operation that requires session validation. So, if you went ahead and added security, go and roll that back be emptying the fields&#8230; just wanted to show you a little more about security.</p>
<h2>Now Your Stuck</h2>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_7_1_12.png" alt="Uh-oh" /><br />
<em>[Uh-oh]</em></p>
<p>LOL. You fell for it. What a ruse! If you have visited your application and tried to either create, update or delete a document, you can&#8217;t! That&#8217;s the end of this series. See you around!</p>
<p>No, no. Come back. Lower your fists. We&#8217;re going to add a login/signup dialog to our <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> application so we can go about our business as we had done previously, but this time using user credentials and validation. This post has already gotten rather long, so that will come in the next installment of this mini-series. Just sit back for a bit and feel your <del datetime="2011-02-24T14:05:15+00:00">gas</del> power rise.</p>
<h2>Conclusion</h2>
<p>In this first installment of <strong>Part 7</strong> mini-series within a series, we address user credentials, validation and security for our database and albums application. All fun stuff, and prior to <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> 0.11 a sore point. I won&#8217;t go into how I had done it previously, but it boiled down to giving in and keeping the admin party. Maybe i wasn&#8217;t smart enough. But thankfully the intelligent people leading <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> made me look smart again in later releases.</p>
<p>Next up in the mini-series within a series within <strong>Part 7</strong> within this blog within these series of tubes, we will use the information gathered in this article along with our validation script and modify our <a href="http://jquerymobile.com/<br />
http://jquerymobile.com/http://jquerymobile.com/" target="_blank">jQuery Mobile</a> application to present a login/signup dialog when an operation is requested that requires session authentication and user credentials. Hurrah!</p>
<p><em>[Note] This post was written against the following software versions:</em><br />
<strong>CouchDB </strong>– 1.0.1<br />
<strong>CouchApp</strong> – 0.7.2<br />
<strong>jQuery</strong> – 1.4.4<br />
<strong>jQuery Mobile</strong> – 1.0a2<br />
<em>If you have found this post and any piece has moved forward, hopefully the examples are still viable/useful. I will not be updating the examples in this post in parellel with updates to any of the previously mentioned software, unless explicitly noted.</em></p>
<p><strong>Articles in this series:</strong></p>
<ol>
<li><a href="http://custardbelly.com/blog/?p=244" target="_blank">Getting Started</a></li>
<li><a href="http://custardbelly.com/blog/?p=278" target="_blank">Displaying a page detail of a single album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=297" target="_blank">Templates and Mustache</a></li>
<li><a href="http://custardbelly.com/blog/?p=318" target="_blank">Displaying an editable page of an album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=332" target="_blank">Creating and Adding an album document.</a></li>
<li><a href="http://custardbelly.com/blog/?p=344" target="_blank">Deleting an album document</a></li>
<li><a href="http://custardbelly.com/blog/?p=360" target="_blank">Authorization and Validation &#8211; Part 1</a></li>
<li><a href="http://custardbelly.com/blog/?p=394">Authorization and Validation &#8211; Part 2</a></li>
</ol>
<p><a href="http://custardbelly.com/downloads/couchapp/jqm_couchdb_albums.zip">Full source for albums couchapp here.</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/couchdb/" title="View all posts in CouchDB" rel="category tag">CouchDB</a>,  <a href="http://custardbelly.com/blog/category/jquery/" title="View all posts in jquery" rel="category tag">jquery</a>,  <a href="http://custardbelly.com/blog/category/jquery-mobile/" title="View all posts in jquery-mobile" rel="category tag">jquery-mobile</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2011-03-04T11:23">March 4, 2011</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-360-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-373" class="post-373 post hentry category-as3 category-flash category-flex category-flex-4 category-as3flobile full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2011/02/16/as3flobile-scrollviewport-and-flex-4-containers-from-yeah-to-eh/" title="Permanent link to as3flobile ScrollViewport and Flex 4 containers? from yeah to eh." rel="bookmark" rev="post-373">as3flobile ScrollViewport and Flex 4 containers? from yeah to eh.</a></h1>
	
	<div class="entry-content full-content">
		<p>The other day i got an email from <a href="http://twitter.com/tomkordys" target="_blank">Tom Kordys</a> for a little clarification on the <a href="https://github.com/bustardcelly/as3flobile" target="_blank">as3flobile</a> project and if the <a href="https://github.com/bustardcelly/as3flobile/tree/master/src/com/custardbelly/as3flobile/controls/viewport" target="_blank">ScrollViewport</a> could be used to provide touch scrolling to a <strong>DataGroup</strong>. My first thought was <em>&#8220;no&#8221;</em>, then my second thought was <em>&#8220;why not?&#8221;</em>. The third thought i forget. But then the fourth thought was fire up <strong>Flash Builder</strong> and take a break.</p>
<p>When i originally started out creating the <a href="https://github.com/bustardcelly/as3flobile" target="_blank">as3flobile</a> library, the intent was to provide a suite of controls for an <strong>AS3</strong> project targeting the <strong>Flash Player</strong> on a mobile browser. I intentionally pushed <strong>Flex</strong> to the side for a number of reasons:</p>
<ol>
<li><strong>Adobe</strong> is currently <a href="http://labs.adobe.com/technologies/flex/mobile/" target="_blank">working on and improving <strong>Hero</strong></a> (nee <strong>Slider</strong>).</li>
<li>It runs like crap on mobile (hence the first line item).</li>
<li>I wanted to dive into a solely <strong>AS3</strong> personal project again (selfish).</li>
</ol>
<p>Before i got that email, truthfully, the thought never crossed my mind to intermingle parts from the as3flobile library into <strong>Flex</strong>; <strong>Adobe</strong> will deliver their solution in due time and i will then make a decision whether to use <strong>Flex</strong> or <strong>AS3</strong> for my next mobile-web based project. Until then, if need be, i&#8217;ll just use <strong>AS3</strong>. That is still my impression, but after i got that email i was just dying to know if i could enable touch scrolling on <strong>Flex 4</strong> containers. </p>
<p>So you&#8217;ve read all the way down to here and i still haven&#8217;t given an answer&#8230;</p>
<p>[view source enabled]<br />
<a href="http://www.custardbelly.com/downloads/as3flobile/containerviewport/" target="_blank"><img src="http://www.custardbelly.com/blog/images/as3flobile_vp_container.png" alt="as3flobile viewport container" /></a><br />
<em>ScrollViewport with Group containers.</em></p>
<p>[view source enabled]<br />
<a href="http://www.custardbelly.com/downloads/as3flobile/flexviewport/" target="_blank"><img src="http://www.custardbelly.com/blog/images/as3flobile_vp_datagroup.png" alt="as3flobile viewport datagroup" /></a><br />
<em>ScrollViewport with virtualized DataGroup container.</em></p>
<p>Yes, it is possibile! Would i recommend it? Sure, have fun! Would i put it into production? No. No, i would not. </p>
<p>From my tests, <strong>Flex</strong> containers in the <a href="https://github.com/bustardcelly/as3flobile/" target="_blank">as3flobile</a> <strong>ScrollViewport</strong> run pretty smoothly on a desktop browser. If that is your target platform and you are looking for touch-scroll on containers, I say try it out. In <strong>Flash Player</strong> on mobile browser, the scrolling and touch interaction is not smooth enough for my liking, but it may pass your user experience tests&#8230; who knows. I believe it is the length of invalidation cycle for <strong>Flex</strong> that is causing the render hiccups, but i am sure there is some optimization that could be done in <a href="https://github.com/bustardcelly/as3flobile/" target="_blank">as3flobile</a> that may help a little. That said, <a href="https://github.com/bustardcelly/as3flobile/" target="_blank">as3flobile</a> touch-scroll runs pretty smoothly on an <strong>AS3</strong> project, so i don&#8217;t know how much optimization could be done for me to be comfortable with the rendering performance of Flex containers in an <a href="https://github.com/bustardcelly/as3flobile/" target="_blank">as3flobile</a> <strong>ScrollViewport</strong>. All said, I will explain how you can target a <strong>Flex 4</strong> container as the content for <a href="https://github.com/bustardcelly/as3flobile/" target="_blank">as3flobile</a> <strong>ScrollViewport</strong>.</p>
<h2>as3flobile ScrollViewport</h2>
<p>The <strong>ScrollViewport</strong> control from <a href="https://github.com/bustardcelly/as3flobile/" target="_blank">as3flobile</a> essentially uses its dimensions as a visible area for child content. Its target child content is typed to an <strong>InteractiveObject</strong>, which is the base display class from which touch/mouse events are received on. <strong>Flex</strong> containers subclass (through a larger inheritance chain) <strong>InteractiveObject</strong> so there was no extra effort or cajoling of the as3flobile library to make <strong>ScrollViewport</strong> work with <strong>Flex</strong> containers.</p>
<p>With its content set to <strong>IntractiveObject</strong>, <strong>ScrollViewport</strong> employs the <a href="http://en.wikipedia.org/wiki/Strategy_pattern" target="_blank">Strategy Pattern</a> to recognize interactive events on the content and perform scrolling. You can assign custom scroll contexts and strategies to <strong>ScrollViewport</strong>, but the default context reacts to <strong>Mouse</strong> events invoking the default scroll strategy. The scroll behaviour is based on the <strong>width</strong> and <strong>height</strong> dimensions of the target content for the <strong>ScrollViewport</strong>. If the <strong>height</strong> of the content is less than or equal to the <strong>height</strong> property of <strong>ScrollViewport</strong>, then vertical scrolling is turned off. Likewise for the <strong>width</strong> property values and horizontal scrolling.</p>
<p>To set up a viewport for <strong>AS3</strong>, you would do something of the following:</p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
var container:Sprite = new Sprite();
var bitmap:Bitmap = new Bitmap( new BitmapData( 200, 200, false, 0x000000 ) );
container.addChild( bitmap );

// Direct dimension values
var viewport:ScrollViewport = new ScrollViewport();
viewport.width = 100;
viewport.height = 100;
viewport.content = container;
addChild( viewport );

// OR - Utility convenience instantiation
var viewport:ScrollViewport = ScrollViewport.initWithScrollRect( new Rectangle( 0, 0, 100, 100 ) );
viewport.content = container;
addChild( viewport );
</pre>
<p>In this example, the <strong>InteractiveObject</strong> target is the <strong>Sprite</strong> that has a <strong>Bitmap</strong> child. The size of the <strong>Bitmap</strong> (and consequently the parenting size of the <strong>Sprite</strong>) is larger than the designated size for the viewport. In reality this is a terrible example because you won&#8217;t really see the scrolling affect due to a single colored bitmap. <em>An example with a loaded bitmap can be seen at <a href="http://www.custardbelly.com/android/froyo/as3flobile" target="_blank">http://www.custardbelly.com/android/froyo/as3flobile</a>.</em></p>
<h2>Targeting Flex 4 containers</h2>
<p>The approach to apply the content of the <strong>ScrollViewport</strong> to a <strong>Flex</strong> container is relatively the same as in the <strong>AS3</strong> example. The only caveat is that you need to listen for a change in the <strong>contentWidth</strong> and <strong>contentHeight</strong> properties of the <strong>Flex</strong> container and refresh the <strong>ScrollViewport</strong> instance. As well, the <strong>ScrollViewport</strong> needs to be added as a child of <strong>SpriteVisualElement</strong>, and the target container re-parented to the <strong>ScrollViewport</strong>. Here is a quick example:</p>
<pre class="brush: xml; first-line: 1; title: ;" title="">
&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;s:Group xmlns:fx=&quot;http://ns.adobe.com/mxml/2009&quot;
		 xmlns:s=&quot;library://ns.adobe.com/flex/spark&quot;
		 xmlns:mx=&quot;library://ns.adobe.com/flex/mx&quot;
		 creationComplete=&quot;handleCreationComplete();&quot;&gt;

	&lt;fx:Script&gt;
		&lt;![CDATA[
			import com.custardbelly.as3flobile.controls.viewport.ScrollViewport;

			import mx.events.PropertyChangeEvent;

			protected var viewport:ScrollViewport;

			protected function handleCreationComplete():void
			{
				container.addEventListener( PropertyChangeEvent.PROPERTY_CHANGE, handleContentPropertyChange, false, 0, true );

				viewport = new ScrollViewport();
				viewport.width = 100;
				viewport.height = 100;
				viewport.content = container;
				viewportHolder.addChild( viewport );
			}

			protected function handleContentPropertyChange( evt:PropertyChangeEvent ):void
			{
				if( evt.property == &quot;contentWidth&quot; || evt.property == &quot;contentHeight&quot; )
				{
					viewport.refresh();
				}
			}
		]]&gt;
	&lt;/fx:Script&gt;

	&lt;s:SpriteVisualElement id=&quot;viewportHolder&quot; /&gt;

	&lt;s:Group id=&quot;container&quot; width=&quot;200&quot; height=&quot;200&quot;&gt;
		&lt;s:Rect width=&quot;200&quot; height=&quot;200&quot;&gt;
			&lt;s:fill&gt;
				&lt;s:LinearGradient&gt;
					&lt;s:entries&gt;
						&lt;s:GradientEntry color=&quot;0x000000&quot; ratio=&quot;0&quot; /&gt;
						&lt;s:GradientEntry color=&quot;0xFFFFFF&quot; ratio=&quot;.66&quot; /&gt;
					&lt;/s:entries&gt;
				&lt;/s:LinearGradient&gt;
			&lt;/s:fill&gt;
		&lt;/s:Rect&gt;
	&lt;/s:Group&gt;

&lt;/s:Group&gt;
</pre>
<p>The target content &#8211; in this example, a <strong>Group</strong> container with the id of &#8220;container&#8221; &#8211; needs to go through the invalidation cycle within <strong>Flex</strong>. So it is declared in mark-up as a child of the parent <strong>Group</strong>. This is important to note, because the target content container cannot be added from a <strong>Declarations</strong> tag in <strong>Flex</strong>. It needs to have gone through its invalidation in order to be rendered and re-parented to the <strong>ScrollViewport</strong>. Once the container is set as the content for the <strong>ScrollViewport</strong> it is now on the display list of the <strong>ScrollViewport</strong>.</p>
<p>As mentioned early, in this example, i have assigned a <strong>PropertyChangeEvent</strong> listener to pick up the change to <strong>contentWidth</strong> and <strong>contentHeight</strong> of the container. Once caught, the viewport is refreshed. This is needed in order to properly based its scroll bounds in the strategy. Once that is set, you are already to go.</p>
<p>Here is an example of using this approach which shows vertical and horizontal scroll viewports for <strong>Group</strong> containers:</p>
<p>[view source enabled]<br />
<a href="http://www.custardbelly.com/downloads/as3flobile/containerviewport/" target="_blank"><img src="http://www.custardbelly.com/blog/images/as3flobile_vp_container.png" alt="as3flobile viewport container" /></a><br />
<em>ScrollViewport with Group containers.</em></p>
<h2>ScrollViewport and virtualized DataGroup renderers</h2>
<p>After drumming up a working example with <strong>Group</strong> container as content target for <strong>ScrollViewport</strong>, my mind immediately changed focus to <strong>DataGroups</strong>. And not just <strong>DataGroup</strong>s, but the need for item renderer recycling using virtualization. I<em>f you are unfamiliar with virualization and <strong>DataGroup</strong>s, <strong>Adobe</strong> has some useful information <a href="http://help.adobe.com/en_US/flex/using/WS64909091-7042-4fb8-A243-8FD4E2990264.html" target="_blank">here</a>.</em></p>
<p>That gets a little trickier, but not too much. Fortunately the <strong>contentWidth</strong> and <strong>contentHeight</strong> property values are updated on a <strong>DataGroup</strong> based on the <strong>dataProvider</strong> and the item renderer using <em>virtualization</em>, even though every data renderer for an item in the <strong>dataProvider</strong> is not present in the layout display stack since they are recycled. In broad terms, this means our scroll strategy will still be a viable solution, but we will need to update the <strong>verticalScrollPosition</strong> and <strong>y</strong> position of the <strong>DataGroup</strong> during the scroll behaviour.</p>
<p>Here is an example of using <strong>DataGroup</strong> with a virtualized layout:</p>
<pre class="brush: xml; first-line: 1; title: ;" title="">
&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;s:Group xmlns:fx=&quot;http://ns.adobe.com/mxml/2009&quot;
		 xmlns:s=&quot;library://ns.adobe.com/flex/spark&quot;
		 xmlns:mx=&quot;library://ns.adobe.com/flex/mx&quot;
		 creationComplete=&quot;handleCreationComplete();&quot;&gt;

	&lt;fx:Declarations&gt;
		&lt;s:ArrayList id=&quot;dp&quot;&gt;
			&lt;fx:String&gt;hello&lt;/fx:String&gt;
			&lt;fx:String&gt;world&lt;/fx:String&gt;
			&lt;fx:String&gt;foo&lt;/fx:String&gt;
			&lt;fx:String&gt;bar&lt;/fx:String&gt;
			&lt;fx:String&gt;baz&lt;/fx:String&gt;
			&lt;fx:String&gt;jello&lt;/fx:String&gt;
			&lt;fx:String&gt;biafra&lt;/fx:String&gt;
		&lt;/s:ArrayList&gt;
	&lt;/fx:Declarations&gt;

	&lt;fx:Script&gt;
		&lt;![CDATA[
			import com.custardbelly.as3flobile.controls.viewport.ScrollViewport;

			import mx.events.PropertyChangeEvent;

			protected var viewport:ScrollViewport;

			protected function handleCreationComplete():void
			{
				dataGroup.addEventListener( PropertyChangeEvent.PROPERTY_CHANGE, handleContentPropertyChange, false, 0, true );
				dataGroup.dataProvider = dp;

				viewport = new ScrollViewport();
				viewport.width = 100;
				viewport.height = 100;
				viewport.content = container;
				viewport.scrollChange.add( handleScrollChange );
				viewportHolder.addChild( viewport );
			}

			protected function handleContentPropertyChange( evt:PropertyChangeEvent ):void
			{
				if( evt.property == &quot;contentHeight&quot; )
				{
					container.height = dataGroup.contentHeight;
					contentBackground.height = dataGroup.contentHeight;
					viewport.refresh();
				}
			}

			protected function handleScrollChange( value:Point ):void
			{
				dataGroup.verticalScrollPosition = value.y * -1;
				dataGroup.y = dataGroup.verticalScrollPosition;
			}
		]]&gt;
	&lt;/fx:Script&gt;

	&lt;s:SpriteVisualElement id=&quot;viewportHolder&quot; /&gt;

	&lt;s:Group id=&quot;container&quot; width=&quot;100&quot;&gt;
		&lt;s:Rect id=&quot;contentBackground&quot; width=&quot;100&quot;&gt;
			&lt;s:fill&gt;
				&lt;s:SolidColor color=&quot;#DDDDDD&quot; /&gt;
			&lt;/s:fill&gt;
		&lt;/s:Rect&gt;
		&lt;s:DataGroup id=&quot;dataGroup&quot;
					 width=&quot;100&quot; height=&quot;200&quot;
					 clipAndEnableScrolling=&quot;true&quot;
					 itemRenderer=&quot;spark.skins.spark.DefaultItemRenderer&quot;&gt;
			&lt;s:layout&gt;
				&lt;s:VerticalLayout useVirtualLayout=&quot;true&quot; gap=&quot;2&quot; /&gt;
			&lt;/s:layout&gt;
		&lt;/s:DataGroup&gt;
	&lt;/s:Group&gt;

&lt;/s:Group&gt;
</pre>
<p>In this example, we are basing our target content container dimensions on change to the contentHeight property of the <strong>DataGroup</strong> child. The <strong>dataProvider</strong> and the item renderer are the basis of the <strong>contentHeight</strong> property, and once we handle that change, we apply the height properties to the container and contentBackground, then refresh the viewport. The <strong>contentBackground</strong> is there to act as a grabbable area within the container so we can scroll without having to touched down on an item renderer in the <strong>DataGroup</strong> directly.</p>
<p>The handler for the <strong>scrollChange</strong> <a href="https://github.com/robertpenner/as3-signals" target="_blank">Signal</a> then updates the <strong>verticalScrollPosition</strong> of the <strong>DataGroup</strong> and the <strong>y</strong> position within the container. This gives the perceived scrolling display incorporated with item renderer recycling (notice the <strong>useVirtualLayout</strong> property value on the <strong>VerticalLayout</strong> assigned to the <strong>DataGroup</strong>).</p>
<p>Here is an example of this working with the status API of <strong>Twitter</strong> as the data content for a <strong>DataGroup</strong>:</p>
<p>[view source enabled]<br />
<a href="http://www.custardbelly.com/downloads/as3flobile/flexviewport/" target="_blank"><img src="http://www.custardbelly.com/blog/images/as3flobile_vp_datagroup.png" alt="as3flobile viewport datagroup" /></a><br />
<em>ScrollViewport with virtualized DataGroup container.</em></p>
<p>You&#8217;ll see some lag when each new item renderer is requested to render, but once it has finished and cached the image requests it will get smoother.</p>
<h2>Conclusion</h2>
<p>Cheers to <a href="http://twitter.com/tomkordys" target="_blank">Tom Kordys</a> for looking in to <a href="https://github.com/bustardcelly/as3flobile" target="_blank">as3flobile</a> and sparking the discussion. In short, yeah is it possible to use ScrollViewport and Flex 4 containers. But if you have looked at the examples on a mobile device that supports <strong>Flash Player</strong>, you may agree with me that it is not production-ready. Maybe there is some optimization i could do one my side, but i feel the lag really is on the <strong>Flex</strong> invalidation cycle. As well, these examples are pretty basic and there might be some other fine-tuning, not to mention maybe swapping out the container with a <strong>Bitmap</strong> snapshot of itself while scrolling&#8230; something to think about.</p>
<h2>Attribution</h2>
<p>The examples use the <a href="https://github.com/mrdoob/Hi-ReS-Stats">Hi-ReS-Stats component</a> created by <a href="http://mrdoob.com/">Mr.doob</a>.</p>
<p>as3flobile uses the <a href="https://github.com/robertpenner/as3-signals">as3-signals</a> library created by <a href="http://flashblog.robertpenner.com/">Robert Penner</a>.</p>
<p><em><a href="https://github.com/bustardcelly/as3flobile" target="_blank">as3flobile</a> is a set of ActionScript 3 components targeting the Flash Player on mobile devices. <a href="http://custardbelly.com/blog/?page_id=180">You can read more about the project here</a>. To see working examples, visit <a href="http://www.custardbelly.com/android/froyo/as3flobile/">http://www.custardbelly.com/android/froyo/as3flobile/</a></em></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>,  <a href="http://custardbelly.com/blog/category/flex-4/" title="View all posts in Flex 4" rel="category tag">Flex 4</a>,  <a href="http://custardbelly.com/blog/category/as3flobile/" title="View all posts in as3flobile" rel="category tag">as3flobile</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2011/02/16/as3flobile-scrollviewport-and-flex-4-containers-from-yeah-to-eh/#comments" rev="post-373"  title="Comment on as3flobile ScrollViewport and Flex 4 containers? from yeah to eh.">7 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2011-02-16T11:24">February 16, 2011</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-373-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-344" class="post-344 post hentry category-couchdb category-jquery category-jquery-mobile full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2011/01/21/jquery-mobile-couchdb-part-6-deleting-documents/" title="Permanent link to jQuery Mobile + CouchDB: Part 6 &#8211; Deleting Documents" rel="bookmark" rev="post-344">jQuery Mobile + CouchDB: Part 6 &#8211; Deleting Documents</a></h1>
	
	<div class="entry-content full-content">
		<p>In my <a href="http://custardbelly.com/blog/?p=332" target="_blank">previous article</a>, I addressed adding documents to a <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database using the <em>jquery.couch</em> plugin along with a form within the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework. If you have been following along (and have been using with the application that is being built) that database might be filling up with album documents by now&#8230; but with no way to remove them!</p>
<p><em>&#8220;Why, late on Friday night, did I ever think I needed to catalog Starship&#8217;s &#8216;Knee Deep in the Hoopla&#8217; as &#8216;my saving grace&#8217;?!&#8221;</em></p>
<p>&#8230; is one thing that you may say to yourself because there is currently no way to delete a document from the application we have built within this series. However, we have come to the final piece in basic document operations: the <strong>D</strong> in <strong>CRUD</strong>. Sit back down. I know it is exciting, but I have a lot of long-winded explanations to write so get ready.</p>
<p>In this article I am going to address adding the ability to delete a document from a <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database. While doing so, I will lightly cover the role that dialogs play in <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> and, in the end, hack it to present a <strong>dialog</strong> (our delete confirmation dialog) as an <strong>external page</strong> styled as a <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> dialog.</p>
<p><strong>In the following examples, I will assume that you have been following along from previous posts and will present updates to existing code.</strong></p>
<h2>Deleting Documents</h2>
<p>Before we just dive into adding a <strong>Delete</strong> button somewhere, let&#8217;s first think about its context within the application itself. If you have been following along with the previous posts, we have essentially 4 pages in our application:</p>
<ul>
<li>Home &#8211; Displays the full list of album documents.</li>
<li>Add Album &#8211; Provides form to an album document.</li>
<li>View Album &#8211; Displays information from the album document.</li>
<li>Edit Album &#8211; Provides form to edit the information on an album document.</li>
</ul>
<p>From this set of pages we can remove <strong>Home</strong> and <strong>Add Album</strong> as candidates to present a <strong>Delete</strong> button associated with a single document, as they have multiple and no album targets, respectively. So, that leaves us with <strong>View Album</strong> and <strong>Edit Album</strong>. A case can definitely be made that a <strong>Delete</strong> button should be available from the <strong>Edit Album</strong> page, but I think it would start to get crowded on that page with <strong>Save</strong>, <strong>Cancel</strong> and <strong>Delete</strong>&#8230; furthermore, it might be confusing to the User what <strong>Cancel</strong> actually referred to; cancel delete? cancel edit? I think the <strong>Delete</strong> button is much more suited to live alongside the <strong>Edit</strong> button in the <strong>View Album</strong> page.</p>
<p>So we know where the <strong>Delete</strong> button is going to reside. The role of the <strong>Delete</strong> button is to open a confirmation <strong>Dialog</strong> so the user can confirm their intent on deleting an album document, or deny it; they may have accidentally hit that button. Now an architectural decision needs to be addressed as to how to present this <strong>Delete</strong> dialog&#8230; should we have it as an internal page within the <em>album view</em> page that is served up from our <strong>show function</strong> in <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a>, or should it be an external page completely self manageable?</p>
<p>We can make a case for internal with obvious reasons being that a <em>delete dialog</em> is associated with a single document with which you want to perform an operation and our <em>album view</em> page represents a single album document. We also don&#8217;t necessarily need the <em>dialog page</em> to be accessed outside of the flow of the application. Meaning, it is not a requirement that the <em>delete dialog</em> is exposed to any user without having to open the application and select an album from the list. </p>
<p>So an <strong>internal</strong> dialog page might be a good fit, and in most cases I might push for it. Unfortunately, the current state of <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> makes the case for an external dialog page an easy one. If we were to add a dialog page to the <em>album view</em> <strong>template</strong> served up from our <strong>show function</strong> for an album, the elements would be all screwed up. I do not know if by design that is expected or if it is just a by-product of the templating and dynamic <strong>DOM</strong> that external pages provides. Either way, things get screwy adding a dialog page along side another page in an external <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page. So external dialog page, ahoy!</p>
<p>Wow, if you read that whole ramble, I am flattered and I hope it made sense. If you didn&#8217;t, i dont blame you; more code less talk.</p>
<h2>Delete Dialog</h2>
<p>We are going to create an <strong>external dialog page</strong> to present the user the ability to cancel out of the action or confim that they would like to delete the album document from the database. Now, typically when working with the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework, a dialog is assigned for a page anchor link with the <strong>data-rel</strong> attribute value set to &#8220;<em>dialog</em>&#8220;. For example:</p>
<pre class="brush: xml; first-line: 1; title: ;" title="">
&lt;a href=&quot;_show/album-delete/12345&quot; data-icon=&quot;minus&quot; data-rel=&quot;dialog&quot;&gt;Delete&lt;/a&gt;
</pre>
<p>In essence, this attribute not only is responsible for the look-and-feel of the page, but also is an indicator that the <strong>url location</strong> should not be updated when the dialog page is loaded in the <strong>DOM</strong>. Makes sense &#8211; you shouldn&#8217;t have to hit back to get out of a dialog (though <strong>Android</strong> throws that use-case out the window with its context menus, which i think is still intuitive&#8230; but whatever).</p>
<p>But&#8230; we can&#8217;t do that. We need to use the <strong>$.mobile</strong>.<em>changePage</em>() method to present the delete dialog page from the album view page. The main reason being relative page locations in relation to <strong>show function</strong> requests. Basically we would have to invoke the <strong>show function</strong> to allow for the <em>delete dialog</em> to be presented using a relative path out of the current <em>album view</em> page. An updated example for our application would look like:</p>
<pre class="brush: xml; first-line: 1; title: ;" title="">
&lt;a href=&quot;../../_show/album-delete/12345&quot; data-icon=&quot;minus&quot; data-rel=&quot;dialog&quot;&gt;Delete&lt;/a&gt;
</pre>
<p>To me, very ugly and not the correct way to enable this functionality. Furthermore, if we think back to how we implemented the <em>album view</em> page, we decided to clear the page from the <strong>DOM</strong> after navigating away from it. Essentially, within this context, showing the dialog would wipe the <strong>DOM</strong> of the <em>album view</em> page and when we choose to either confirm or deny or cancel deletion of the document, we would be returned to a blank page due to the inherent behaviour assigned to the role of a dialog in <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> (ie. the previous page is not loaded again using <strong>$.mobile</strong>.<em>changePage</em>()). Not ideal.</p>
<p>So we&#8217;ll just create an external <em>delete dialog</em> maintaining the look and feel by applying styles manually (instead of having the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework parse the <strong>DOM</strong> and apply them intrinsically). That way we can also encapsulate the logic used in deleting a document from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database using a <em>view-controller</em> associated with the dialog page.</p>
<h3>Delete Dialog show function</h3>
<p>With our minds made up on externalizing the <strong>Delete Dialog</strong> page, we&#8217;ll continue on with how we have made all our pages in this series. First up the <strong>show function</strong>. With your favorite text editor open, create a new document called <em>album-delete.js</em> in the /shows directory of your couchapp application folder (for me that is <em>/Documents/workspace/custardbelly/couchdb/albums</em>). Add the following script and save:</p>
<p><em>/shows/album-delete.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
function(doc, req) {
    var Mustache = require(&quot;vendor/couchapp/lib/mustache&quot;);
       var stash = {
            artist: doc.artist,
            title : doc.title,
            document: doc._id
    };
    return Mustache.to_html(this.templates.albumdelete, stash, this.templates.partials.albumdelete);
}
</pre>
<p>Very similar to our other <strong>show function</strong>s for the view and edit pages, with just a little less information about the document in the <strong>stash</strong>. We&#8217;ve also got our template and partials declared in the <a href="https://github.com/janl/mustache.js/" target="_blank">Mustache</a> <em>to_html</em>() call, so let&#8217;s go ahead and create those.</p>
<h3>Delete Dialog template</h3>
<p>As I mentioned earlier, since our dialog is external and will be presented using <strong>$.mobile</strong>.<em>changePage</em>( ) we loose some niceties of styling pages as dialogs within the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework. As such, we are going to roll-up our sleeves and apply some classes and styles directly inline to fake the appearance of the delete album page as a dialog.</p>
<p>With you favorite text editor open, create and save the following mark-up as <em>albumdelete.html</em> in the <em>/templates</em> directory:</p>
<p><em>/templates/albumdelete.html</em></p>
<pre class="brush: xml; first-line: 1; title: ;" title="">
&lt;div data-role=&quot;page&quot; id=&quot;albumdelete&quot; data-backbtn=&quot;false&quot; class=&quot;ui-dialog ui-body-a&quot;&gt;
    &lt;div class=&quot;ui-header ui-bar-a ui-corner-top ui-overlay-shadow&quot;&gt;
        &lt;h1 class=&quot;ui-title&quot;&gt;Delete Album?&lt;/h1&gt;
        &lt;a id=&quot;dialogCloseButton&quot; href=&quot;#&quot; data-icon=&quot;delete&quot; data-iconpos=&quot;notext&quot; style=&quot;left: 15px; top: .4em; position: absolute;&quot;&gt;Close&lt;/a&gt;
    &lt;/div&gt;
    &lt;div data-role=&quot;content&quot; id=&quot;dialogContent&quot; data-identity=&quot;{{document}}&quot; class=&quot;ui-body-c ui-corner-bottom ui-overlay-shadow&quot;&gt;
        &lt;p&gt;Are you sure you want to delete {{artist}}, {{title}}?&lt;/p&gt;
        &lt;a id=&quot;dialogCancelButton&quot; href=&quot;#&quot; data-role=&quot;button&quot; data-theme=&quot;a&quot;&gt;no&lt;/a&gt;
        &lt;a id=&quot;dialogConfirmButton&quot; href=&quot;#&quot; data-role=&quot;button&quot; data-theme=&quot;c&quot;&gt;yes&lt;/a&gt;
    &lt;/div&gt;
    &lt;div data-role=&quot;footer&quot; /&gt;
&lt;/div&gt;
{{&gt;scripts}}
</pre>
<p>When you request to load an external page into the <strong>DOM</strong>, that page &#8211; or rather, i should say, the root <strong>div</strong> with the <strong>data-role</strong> value of <em>page</em> &#8211; is actually wrapped in another parent <strong>div</strong> with the <strong>data-role</strong> removed and transfered to the wrapping <strong>div</strong>. So keep that in the back of your mind as we will need to a little more pixel pushing in the <em>view-controller</em>. For now, understand that this mark-up is going to be wrapped by a <strong>div</strong>, and the page role of this page will be removed. </p>
<p>Now, in order to style the content of our page as a <strong>dialog</strong>, we explicitly set the root <strong>div</strong> <strong>class</strong> to <em>ui-dialog</em> which just throws in some margins to present more of a self contained box (like a dialog), and <em>ui-body-a</em> essentially being a base style for color and font treatments. </p>
<p>You may also notice the <strong>data-backbtn</strong> attribute thrown in there. I have rarely gotten it to work for an <strong>external page</strong> in the current stable release of <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> (1.0a2), but i threw it in there and crossed my fingers. In any event, we&#8217;ll handle the no back button issue manually, as we only want to display a close button just like all other default dialogs do in <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a>. </p>
<p>First step in that process: get rid of the <strong>header</strong>. You may notice that the first <strong>div</strong> in the children is not assigned a <strong>data-role</strong> of <em>header</em> or any other value. Instead, i peaked inside the <strong>JS</strong> and <strong>CSS</strong> of the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework and assigned in-line the <strong>class</strong> declarations given to a header in the context of a dialog. These classes are responsible for the colorization, size and corner-roundedness (not getting any spell-checking squigglies on that word!) of the <strong>div</strong>, which houses a custom <strong>Close</strong> button. Just as I went through and found the classes assigned to a <strong>header</strong> in a dialog, I went and found the specific styles given to the <strong>Close</strong> button that is added to the <strong>DOM</strong> inherently in <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> when a dialog is present. I have also done the same for the content, finishing the look-and-feel off with a different background color and bottom rounded corners.</p>
<p>This will look relatively just like any other dialog that is created/modified within the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework (at the current release, at least!). However, the background will not grow with its parent size (will be wrapped in a <strong>div</strong>), so the background treatment assigned to this page will not flow to the size of the page in the browser. To do that we&#8217;ll do some <a href="http://jquery.com/" target="_blank">jQuery</a> wizardry in the <em>view-controller</em> for this <em>delete dialog page</em>. In order to get there, let&#8217;s create our <strong>partial</strong> for this <strong>template</strong>.</p>
<p>With you favorite text editor open, create a file named <em>scripts.html</em>, add the following mark-up, and save it in <em>/templates/partials/albumdelete</em>:</p>
<p><em>/templates/partials/albumdelete/script.html</em></p>
<pre class="brush: xml; first-line: 1; title: ;" title="">
&lt;script src=&quot;../../script/album-delete-dialog.js&quot;&gt;&lt;/script&gt;
</pre>
<p>If you haven&#8217;t been following along in the series, this partial is just an organizational thing for me. I may be a little anal about where my code resides, and adding the <strong>JavaScript</strong> within the <strong>script</strong> declaration is totally acceptable; i just like having my scripts all in one place in a project.</p>
<p>OK. With that set, let&#8217;s get on to creating the <em>view-controller</em> for the <em>delete dialog page</em>.</p>
<h3>Delete Dialog View-Controller</h3>
<p>Before we jump in and create the script, let&#8217;s just make sure we are on the same page for the functionality of our <em>delete dialog page</em>. Like most dialogs, it presents the ability to confirm an action or cancel out of that action. So those are two pieces of functionality we need to implement in our <em>view-controller</em> for the page, with the confirmation being a <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> transaction. Actually&#8230; i think that is about it. Aside from some custom styling we will do in order for the page to be in full, it should be some smooth sailing. I am going to assume that you have been following along in the series and won&#8217;t go into the breadth of how the <em>view-controller</em> behaves, but rather the methods which we will implement on it.</p>
<p>With your favorite text editor open, create a new file called <em>album-delete-dialog.js</em>, add the following <strong>JavaScript</strong> and save in <em>/_attachments/script</em>:</p>
<p><em>/_attachments/script/album-delete-dialog.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
var AlbumDeleteDialogController = function() {

    function handleDialogViewHide()
    {
        $(&quot;#dialogCloseButton&quot;).die( &quot;click&quot;, handleClose );
        $(&quot;#dialogCancelButton&quot;).die( &quot;click&quot;, handleClose );
        $(&quot;#dialogConfirmButton&quot;).die( &quot;click&quot;, handleDelete );

        var docId = $(&quot;#dialogContent&quot;).data(&quot;identity&quot;);
        var dialogCache =  $(document.getElementById(&quot;_show/album-delete/&quot; + docId));
        dialogCache.unbind( &quot;pagehide&quot;, handleDialogViewHide );
        dialogCache.empty();
        dialogCache.remove();
    }

    function handleDialogView()
    {
        // Watch for bound hide of page to clear from cache.
        var docId = $(&quot;#dialogContent&quot;).data(&quot;identity&quot;);
        var dialogPage = $(document.getElementById(&quot;_show/album-delete/&quot; + docId));
        dialogPage.bind( &quot;pagehide&quot;, handleDialogViewHide );
    }

    function handleClose( event )
    {
        event.preventDefault();
        var docId = $(&quot;#dialogContent&quot;).data(&quot;identity&quot;);
        $.mobile.changePage( &quot;_show/album/&quot; + docId, &quot;slide&quot;, true, true );
        return false;
    }

    function handleDelete( event )
    {
        event.preventDefault();
        var docId = $(&quot;#dialogContent&quot;).data(&quot;identity&quot;);
        // First open doc based on ID in order to get full document.
        $db.openDoc( docId, {
            success: function( document ) {
                // Then use the opened doc as reference to remove.
                $db.removeDoc( document, {
                    success: function() {
                        $.mobile.changePage( &quot;#home&quot;, &quot;slide&quot;, true, true );
                    },
                    error: function() {
                        alert( &quot;Could not remove document with id: &quot; + docId );
                    }
                });
            },
            error: function() {
                alert( &quot;Could not find document with id: &quot; + docId );
            }
        });
        return false;
    }

    return {
        initialize: function() {
            $(&quot;#dialogCloseButton&quot;).live( &quot;click&quot;, handleClose );
            $(&quot;#dialogCancelButton&quot;).live( &quot;click&quot;, handleClose );
            $(&quot;#dialogConfirmButton&quot;).live( &quot;click&quot;, handleDelete);
            // Do pagebefore so when it is shown, it is filled correctly.
            $(&quot;div[data-role='page']&quot;).live( &quot;pagebeforeshow&quot;, function() {
                $(&quot;div[data-role='page']&quot;).die( &quot;pagebeforeshow&quot; );
                var docId = $(&quot;#dialogContent&quot;).data(&quot;identity&quot;);
                var dialogPage = $(document.getElementById(&quot;_show/album-delete/&quot; + docId));
                var dialog = $(&quot;#albumdelete&quot;);
                var h = parseFloat(dialogPage.innerHeight());
                h -= ( parseFloat(dialog.css(&quot;border-top-width&quot;)) + parseFloat(dialog.css(&quot;border-bottom-width&quot;)) );
                // define the height based on innerHeight of wrapping parent page and the border styles applied to a dialog.
                dialog.css( &quot;height&quot;, h + &quot;px&quot; );
            });
            $(&quot;div[data-role='page']&quot;).live( &quot;pageshow&quot;, function() {
                $(&quot;div[data-role='page']&quot;).die( &quot;pageshow&quot; );
                handleDialogView();
            });
        }
    };
}();

function handleDialogReady()
{
    AlbumDeleteDialogController.initialize();
}
$().ready( handleDialogReady )
</pre>
<p>That might be a lot to digest all at once, but it has the same functionality as the other <em>view-controllers</em> we have created in this series. Essentially, It manages the removal of the page from the <strong>DOM</strong> on navigation away. A user will be navigated to the previous &#8211; <em>album view</em> &#8211; page on cancel/close or be taken to the <strong>#home</strong> page with the updated list of albums after confirmation of delete and success of the transaction from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance. Let&#8217;s take a closer look on how that is done:</p>
<p><em>/_attachments/script/album-delete-dialog.js</em></p>
<pre class="brush: jscript; first-line: 32; title: ;" title="">
function handleDelete( event )
{
    event.preventDefault();
    var docId = $(&quot;#dialogContent&quot;).data(&quot;identity&quot;);
    // First open doc based on ID in order to get full document.
    $db.openDoc( docId, {
        success: function( document ) {
            // Then use the opened doc as reference to remove.
            $db.removeDoc( document, {
                success: function() {
                    $.mobile.changePage( &quot;#home&quot;, &quot;slide&quot;, true, true );
                },
                error: function() {
                    alert( &quot;Could not remove document with id: &quot; + docId );
                }
           });
        },
        error: function() {
            alert( &quot;Could not find document with id: &quot; + docId );
        }
    });
    return false;
}
</pre>
<p>We first grab the document id assigned to the <strong>data-identity</strong> attribute of the content <strong>div</strong> and use that to open the document from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database using the declared <strong>$db</strong> instance on the <em>index.html</em> (of which this page is loaded into). On success of opening the document, we make a request to remove it from the database using the <em>removeDoc</em>() method from the <em>jquery.couch</em> plugin. Upon success of removal from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database, we then navigate back to the <strong>#home</strong> page where the list is updated accordingly to reflect the removal of the album document.</p>
<p>Now the fun part! In order to have the original <strong>div</strong> (assigned the <strong>data-role</strong> of <em>page</em> in our <strong>template</strong>) fill its background to its wrapping parent (assigned by <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> upon load of external page) we need to do some <a href="http://jquery.com/" target="_blank">jQuery</a> to grab the dimensions of the wrapping page <strong>div</strong> and the assigned styles on the dialog to reset the dimensions of the dialog to fill its background to the page.</p>
<p><em>/_attachments/script/album-delete-dialog.js</em></p>
<pre class="brush: jscript; first-line: 62; title: ;" title="">
// Do pagebefore so when it is shown, it is filled correctly.
$(&quot;div[data-role='page']&quot;).live( &quot;pagebeforeshow&quot;, function() {
    $(&quot;div[data-role='page']&quot;).die( &quot;pagebeforeshow&quot; );
    var docId = $(&quot;#dialogContent&quot;).data(&quot;identity&quot;);
    var dialogPage = $(document.getElementById(&quot;_show/album-delete/&quot; + docId));
    var dialog = $(&quot;#albumdelete&quot;);
    var h = parseFloat(dialogPage.innerHeight());
    h -= ( parseFloat(dialog.css(&quot;border-top-width&quot;)) + parseFloat(dialog.css(&quot;border-bottom-width&quot;)) );
    // define the height based on innerHeight of wrapping parent page and the border styles applied to a dialog.
    dialog.css( &quot;height&quot;, h + &quot;px&quot; );
});
</pre>
<p>The <strong>dialogPage</strong> is the parent <strong>div</strong> for the external <em>delete dialog page</em> (the <strong>template</strong> previously created in this article). As mentioned before that is created and wrapped around the external page inherently within the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework when the page is loaded into the <strong>DOM</strong>. </p>
<p>That wrapping parent is assigned the <strong>id</strong> of the url location shown in the <strong>hash</strong>, and is accessed using <em>getElementById</em>(). There might be some other tricks to access that div using <strong>class*=&#8217;ui-page&#8217;</strong>. It is also assigned a <strong>class</strong> of <em>ui-page-active</em>, but that is only after it has been shown. Since we assign a handler for <em>pagebeforeshow</em>, that class has yet to be assigned so we can&#8217;t access it that way using <a href="http://jquery.com/" target="_blank">jQuery</a>. Listening and assigning these property during the <em>pagebeforeshow</em> event also has the added benefit of sizing the dialog background correctly before the user sees it.</p>
<p>Alright. So we have faked our external page to be presented as a dialog normally shown through the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework by assigning the <strong>data-rel</strong> on a page link. Now we have to go about modifying the code so we can show it&#8230;</p>
<h2>Modifying Album View Page</h2>
<p>Way back in the beginning of this article before i started yammering on about this and that, we resolved that the <strong>Delete</strong> button should be an additional UI piece to the album view page. If you have been following along in this series, we added the <strong>Edit</strong> button a couple articles back to the <em>album view</em> page. It was represented by a <strong>p</strong> element with the <strong>data-role</strong> of <em>button</em> and positioned vertically below the document information fields. Quite ugly, but reasonable for the time.</p>
<p>To get into more of a consistant look and feel, we are going to add a navigation bar to the <em>album view</em> page, just as we have done for the <strong>#home</strong> page in the last article. The <strong>navbar</strong> for the <em>album view</em> page will consists of two buttons &#8211; <strong>Edit</strong> and <strong>Delete</strong> &#8211; and we&#8217;ll also throw in some styling to give them unique enough color treatments.</p>
<p>In your favorite text editor, open the <em>/templates/album.html</em> document and make the following modifications:</p>
<p><em>/templates/album.html</em></p>
<pre class="brush: xml; first-line: 1; highlight: [10,11,12,13,14,15,16,17,18,19]; title: ;" title="">
&lt;div data-role=&quot;page&quot; id=&quot;albumview&quot; data-position=&quot;inline&quot; data-back=&quot;true&quot;&gt;
    &lt;div data-role=&quot;header&quot; id=&quot;albumheader&quot;&gt;
        &lt;h1 class=&quot;albumtitle&quot;&gt;{{title}}&lt;/h1&gt;
        &lt;a href=&quot;#home&quot; data-icon=&quot;grid&quot; class=&quot;ui-btn-right&quot;&gt;Home&lt;/a&gt;
    &lt;/div&gt;
    &lt;div data-role=&quot;content&quot; id=&quot;albumcontent&quot; data-identity=&quot;{{document}}&quot;&gt;
        &lt;h2 class=&quot;artist&quot;&gt;{{artist}}&lt;/h2&gt;
        &lt;p class=&quot;title&quot;&gt;{{title}}&lt;/p&gt;
        &lt;p class=&quot;description&quot;&gt;{{description}}&lt;/p&gt;
    &lt;/div&gt;
    &lt;div id=&quot;falseFooter&quot; class=&quot;ui-bar-a ui-footer ui-footer-fixed ui-fixed-inline fade&quot; role=&quot;content&quot; data-position=&quot;fixed&quot;&gt;
        &lt;div data-role=&quot;navbar&quot;&gt;
          &lt;ul class=&quot;ui-grid-a&quot;&gt;
              &lt;li&gt;&lt;a href=&quot;#&quot; id=&quot;deleteButton&quot; data-icon=&quot;minus&quot;&gt;Delete&lt;/a&gt;&lt;/li&gt;
              &lt;li&gt;&lt;a href=&quot;#&quot; id=&quot;editButton&quot; data-icon=&quot;gear&quot; data-theme=&quot;b&quot;&gt;Edit&lt;/a&gt;&lt;/li&gt;
          &lt;/ul&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div data-role=&quot;footer&quot; data-position=&quot;fixed&quot; /&gt;
&lt;/div&gt;
{{&gt;scripts}}
</pre>
<p>We got rid of the previous <strong>Edit</strong> button element and added it to a list of buttons in a <strong>navbar</strong>. Alongside the <strong>Edit</strong> button, we have added the <strong>Delete</strong> button. We also added some icons and applied a theme to the <strong>Edit</strong> button to give it a blue color so as to be immediately distinguishable from an action to delete the album document.</p>
<p>You may notice that we actually did not add the <strong>navbar</strong> to the <strong>footer</strong> as we did for the home page. The reason being that there is a bug in the current stable release for <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> that screwed up the layout if we did that. <em>Even though I have mentioned bugs in the jQuery Mobile framework, the beauty is we can easily work around most of them by either faking the HTML mark-up or using jQuery to modify properties; that is always a win in my book.</em> So we created a false footer and assigned it the classes that would normally be assigned to a footer from the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework, and with a <strong>data-position</strong> of <em>fixed</em>, it should always appear at the bottom of the page (it won&#8217;t really, but we will modify the <em>view-controller</em> to put it there). </p>
<p>Now, we needed to leave the <strong>footer</strong> tag in this template because, you guessed it, a bug in <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a>. If we omitted that <strong>footer</strong> on an external document, the <em>ready</em> event is never fired &#8211; bad news. So we threw it in with a <strong>data-position</strong> of <em>fixed</em> so it is always at the bottom. Woohoo! Our page has been updated. Let&#8217;s wired up some operations so we can show our <em>delete album dialog</em>.</p>
<h3>Modifying Album View-Controller</h3>
<p>Before we get into this, i must profess that we are going to do something gross. I don&#8217;t particularly like it, but it is a fast and cheap way to get the result we want. Let&#8217;s get into it and see if i can dig myself out&#8230;</p>
<p>In your favorite text editor, open the <em>/_attachments/script/album-page.js</em> document and make the following modifications:</p>
<p><em>/_attachments/script/album-page.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,49,51,69,70,71,72,73,74,75,76,77,78,83]; title: ;" title="">
var AlbumPageController = function() {

    /* RIPPED FROM jquerymobile-1.0a2.js */
    function getOffsetTop(ele)
    {
        var top = 0;
        if (ele)
        {
            var op = ele.offsetParent, body = document.body;
            top = ele.offsetTop;
            while (ele &amp;&amp; ele != body)
            {
                top += ele.scrollTop || 0;
                if (ele == op)
                {
                    top += op.offsetTop;
                    op = ele.offsetParent;
                }
                ele = ele.parentNode;
            }
        }
        return top;
    }

    function setTop(el){
        var fromTop = $(window).scrollTop(),
            thisTop = getOffsetTop(el[0]), // el.offset().top returns the wrong value on iPad iOS 3.2.1, call our workaround instead.
            thisCSStop = el.css('top') == 'auto' ? 0 : parseFloat(el.css('top')),
            screenHeight = window.innerHeight,
            thisHeight = el.outerHeight(),
            useRelative = el.parents('.ui-page:not(.ui-page-fullscreen)').length,
            relval;
        if( el.is('.ui-header-fixed') ){
            relval = fromTop - thisTop + thisCSStop;
            if( relval &lt; thisTop){ relval = 0; }
            return el.css('top', ( useRelative ) ? relval : fromTop);
        }
        else{
            //relval = -1 * (thisTop - (fromTop + screenHeight) + thisCSStop + thisHeight);
            //if( relval &gt; thisTop ){ relval = 0; }
            relval = fromTop + screenHeight - thisHeight - (thisTop - thisCSStop);
            return el.css('top', ( useRelative ) ? relval : fromTop + screenHeight - thisHeight );
        }
    }
    /* END RIPPED FROM jquerymobile-1.0a2.js */

    function handleView()
    {
        setTop( $(&quot;#falseFooter&quot;) );
        $(&quot;#editButton&quot;).live( &quot;click&quot;, handleEdit );
        $(&quot;#deleteButton&quot;).live( &quot;click&quot;, handleDelete );
        // Watch for bound hide of page to clear from cache.
        var docId = $(&quot;#albumcontent&quot;).data(&quot;identity&quot;);
        var albumPage = $(document.getElementById(&quot;_show/album/&quot; + docId));
        albumPage.bind( &quot;pagehide&quot;, handlePageViewHide );
    }

    function handleEdit( event )
    {
        // Prevent default link event.
        event.preventDefault();
        // Access document id from data-identity.
        var docId = $(&quot;#albumcontent&quot;).data(&quot;identity&quot;);
        // Change page.
        $.mobile.changePage( &quot;_show/album-edit/&quot; + docId, &quot;flip&quot;, false, true );
        return false;
    }

    function handleDelete( event )
    {
        // Prevent default link event.
        event.preventDefault();
        // Access document id from data-identity.
        var docId = $(&quot;#albumcontent&quot;).data(&quot;identity&quot;);
        // Change page.
        $.mobile.changePage( &quot;_show/album-delete/&quot; + docId, &quot;slideup&quot;, false, false );
        return false;
    }

    function handlePageViewHide()
    {
        $(&quot;#editButton&quot;).die( &quot;click&quot;, handleEdit );
        $(&quot;#deleteButton&quot;).die( &quot;click&quot;, handleDelete );

        var docId = $(&quot;#albumcontent&quot;).data(&quot;identity&quot;);
        var albumPageCache =  $(document.getElementById(&quot;_show/album/&quot; + docId));
        albumPageCache.unbind( &quot;pagehide&quot;, handlePageViewHide );
        albumPageCache.empty();
        albumPageCache.remove();
    }

    return {
        initialize : function() {
            $(&quot;div[data-role='page']&quot;).live( &quot;pageshow&quot;, function() {
                $(&quot;div[data-role='page']&quot;).die( &quot;pageshow&quot; );
                handleView();
            });
        }
    };
}();

function handlePageViewReady()
{
    AlbumPageController.initialize();
}
$().ready( handlePageViewReady );
</pre>
<p>You notice those first two methods? Yeah, i just copied and pasted them from the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> script. They are private methods of the &#8220;<em>fixedHeaderFooter</em>&#8221; plugin of the framework. We needed them to position our false footer <strong>navbar</strong>, so i ripped &#8216;em. Wait! Don&#8217;t leave. I am not happy about it either. Hopefully they will be exposed utilities in a later release of the framework, or we could go about creating our own so they are accessible outside of this page, but for now you gotta do what you gotta do.</p>
<p>Upon show of the page we use those methods to position the false footer <strong>navbar</strong> at the bottom. Sure, in the real world a client &#8211; our rather your team since you know about it! &#8211; would log a bug, but we&#8217;re just having fun right? I hope so.</p>
<p>The other modification was to wire up the <strong>Delete</strong> button to show the <em>delete album dialog</em> page we previously created. We employed the same operations we have done throughout this series to navigating to a page: access the document <strong>id</strong> and call <strong>$.mobile</strong>.<em>changePage</em>() to serve up the filled template form <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a>. Done and done. Let&#8217;s get all <strong>Salt-N-Pepa</strong> up in here and Push It.</p>
<h3>Deployment</h3>
<p>We modified our application to have the ability to delete an album document from the database by adding a new <em>delete dialog</em> page and updating the UI of the album view page. With these changes saved, we can now push to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database using the <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> utility. Open a terminal and navigate to the directory where you create your <strong>CouchApp</strong> applications (for me that is <em>/Documents/workspace/custardbelly/couchdb</em> and in there i have a folder named <em>albums</em> which is the <strong>CouchApp</strong> application directory for these examples). Enter the following command to push the changes to the <strong>CouchDB</strong> instance:</p>
<pre class="brush: bash; title: ;" title="">
couchapp push albums http://127.0.0.1:5984/albums
</pre>
<p>If all was successful and you now go to <a href="http://127.0.0.1:5984/albums/_design/albums/index.html" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html</a>. Select an album from the the list on the landing page, and click the <strong>Delete</strong> button from the <em>album view</em> page. Choose to delete, cancel or close and you should be navigated to the correct page: <strong>#home</strong> if delete, album view if cancel/close. These updated and new pages should look somewhat like the following:</p>
<p><em>updated album view</em><br />
<img src="http://www.custardbelly.com/blog/images/couchapp_album_view2.png" /></p>
<p><em>delete album dialog</em><br />
<img src="http://www.custardbelly.com/blog/images/couchapp_delete_dialog.png" /></p>
<h3>Conclusion</h3>
<p>In this article, we finished off having the basic operations for handling documents in our application. We can now create, read, update and delete documents from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database. Along the way, we covered a few ways to hack things together for an application utilizing the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework; some were work-arounds due to bugs, some were just design decisions. In any event, I hope it was informative if not fun.</p>
<p>Next up: I am wavering between authentication or attachments&#8230; you&#8217;ll have to wait and see!</p>
<p><em>[Note] This post was written against the following software versions:</em><br />
<strong>CouchDB </strong>– 1.0.1<br />
<strong>CouchApp</strong> – 0.7.2<br />
<strong>jQuery</strong> – 1.4.4<br />
<strong>jQuery Mobile</strong> – 1.0a2<br />
<em>If you have found this post and any piece has moved forward, hopefully the examples are still viable/useful. I will not be updating the examples in this post in parellel with updates to any of the previously mentioned software, unless explicitly noted.</em></p>
<p><strong>Articles in this series:</strong></p>
<ol>
<li><a href="http://custardbelly.com/blog/?p=244" target="_blank">Getting Started</a></li>
<li><a href="http://custardbelly.com/blog/?p=278" target="_blank">Displaying a page detail of a single album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=297" target="_blank">Templates and Mustache</a></li>
<li><a href="http://custardbelly.com/blog/?p=318" target="_blank">Displaying an editable page of an album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=332" target="_blank">Creating and Adding an album document.</a></li>
<li><a href="http://custardbelly.com/blog/?p=344" target="_blank">Deleting an album document</a></li>
<li><a href="http://custardbelly.com/blog/?p=360" target="_blank">Authorization and Validation &#8211; Part 1</a></li>
<li><a href="http://custardbelly.com/blog/?p=394">Authorization and Validation &#8211; Part 2</a></li>
</ol>
<p><a href="http://custardbelly.com/downloads/couchapp/jqm_couchdb_albums.zip">Full source for albums couchapp here.</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/couchdb/" title="View all posts in CouchDB" rel="category tag">CouchDB</a>,  <a href="http://custardbelly.com/blog/category/jquery/" title="View all posts in jquery" rel="category tag">jquery</a>,  <a href="http://custardbelly.com/blog/category/jquery-mobile/" title="View all posts in jquery-mobile" rel="category tag">jquery-mobile</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2011/01/21/jquery-mobile-couchdb-part-6-deleting-documents/#comments" rev="post-344"  title="Comment on jQuery Mobile + CouchDB: Part 6 &#8211; Deleting Documents">4 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2011-01-21T11:38">January 21, 2011</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-344-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-332" class="post-332 post hentry category-couchdb category-jquery category-jquery-mobile full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2011/01/12/jquery-mobile-couchdb-part-5-adding-documents/" title="Permanent link to jQuery Mobile + CouchDB: Part 5 &#8211; Adding Documents" rel="bookmark" rev="post-332">jQuery Mobile + CouchDB: Part 5 &#8211; Adding Documents</a></h1>
	
	<div class="entry-content full-content">
		<p>In my <a href="http://custardbelly.com/blog/?p=318" target="_blank">previous post</a>, I addressed editing documents using a form in <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> and updating the document in the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database using the <em>jquery.couch</em> plugin. So far, if you have been following along, the posts have only addressed the <em>RU</em> of <strong>CRUD</strong> (<strong>C</strong>reate <strong>R</strong>ead <strong>U</strong>pdate <strong>D</strong>elete) from the client application aspect. The list of albums are read upon launch, with a single album read on detail, and last post addressed updating a target document. Its high-time we start throwing <strong>C</strong> &#038; <strong>D</strong> into that mix&#8230; but hold on. One at a time. First one will be fun. The second one will make you cry. That&#8217;s not true.</p>
<p>In this article I am going to address the ability to create a new album document, which in and of itself is not entirely different from editing. While doing so, I will address adding a button bar as a <strong>footer</strong> using <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> grid layout and a few tidbits here and there to get things to work, as well as continue to gush over the beauty of using a document-oriented database system&#8230; because there&#8217;s changes ahead!</p>
<p><strong>In the following examples, I will assume that you have been following along from previous posts and present updates to existing code</strong>.</p>
<h2>Adding Documents</h2>
<p>In the previous posts, I discussed the difference between <strong>internal</strong> and <strong>external</strong> pages in <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> and made a fair assessment (i hope) to create the pages of our client application as externally-loaded into the <strong>DOM</strong>. This allows us to see the beauty of <strong>templates</strong> and <strong>show functions</strong> and peek a little into how a <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance, which is an <strong>HTTP</strong> server itself, can be used to serve up a client the communicates with a target <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database.</p>
<p>Well, we are not going to do that for the <em>album add</em> page. Instead, we will declare the page <strong>internally</strong> and not worry about removing it form the <strong>DOM</strong> to prevent page caching. The reason is that, though it will look very similar to the <em>album edit</em> page in mark-up, it differs slightly in its usage. The <em>album add</em> page has no document association and is not served up based on a document <strong>id</strong>. So using a <strong>show function</strong> would essentially return a 404. We could have it as an external page, but I got to thinking&#8230; will we need the ability for a user to hit the <em>album add</em> page outside of the context of the client application? Meaning, should we restrict the ability to add documents to a single client? I am choosing to, but you can certainly run with it and make it external. For me it makes more sense to only allow the <em>index.html</em> to be hit and the sole starting point for the <strong>Albums</strong> application.</p>
<p>To start, open up that old <em>index.html</em> file from the <em>/_attachments</em> directory in your favorite text editor. We are initially just going to modify the page declarations in the <strong>body</strong> tag, so the following modifications are a subset of lines from the <em>index.html</em>. The whole file will be presented later; for now save the following changes:</p>
<p><em>_attachments/index.html</em></p>
<pre class="brush: xml; first-line: 8; highlight: [16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44]; title: ;" title="">
&lt;body&gt;
    &lt;div id=&quot;home&quot; data-role=&quot;page&quot;&gt;
        &lt;div data-role=&quot;header&quot;&gt;&lt;h1&gt;Albums&lt;/h1&gt;&lt;/div&gt;
        &lt;div data-role=&quot;content&quot;&gt;
            &lt;ul id=&quot;albums&quot; data-role=&quot;listview&quot; data-theme=&quot;c&quot; data-dividertheme=&quot;b&quot;&gt;&lt;/ul&gt;
        &lt;/div&gt;
        &lt;div data-role=&quot;footer&quot; class=&quot;ui-bar&quot;&gt;&lt;h4&gt;a list of albums&lt;/h4&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div id=&quot;addAlbum&quot; data-role=&quot;page&quot;&gt;
        &lt;div data-role=&quot;header&quot;&gt;&lt;h1&gt;Add Album&lt;/h1&gt;&lt;/div&gt;
        &lt;div data-role=&quot;content&quot;&gt;
            &lt;form id=&quot;albumAddForm&quot; action=&quot;#&quot; method=&quot;get&quot;&gt;
                &lt;div data-role=&quot;fieldcontain&quot;&gt;
                  &lt;label for=&quot;artist&quot;&gt;Artist:&lt;/label&gt;
                     &lt;input id=&quot;addArtistField&quot; name=&quot;artist&quot; type=&quot;text&quot; /&gt;
              &lt;/div&gt;
              &lt;div data-role=&quot;fieldcontain&quot;&gt;
                  &lt;label for=&quot;title&quot;&gt;Title:&lt;/label&gt;
                     &lt;input id=&quot;addTitleField&quot; name=&quot;title&quot; type=&quot;text&quot; /&gt;
              &lt;/div&gt;
              &lt;div data-role=&quot;fieldcontain&quot;&gt;
                  &lt;label for=&quot;description&quot;&gt;Description:&lt;/label&gt;
                  &lt;textarea id=&quot;addDescriptionField&quot; name=&quot;description&quot; cols=&quot;40&quot; rows=&quot;8&quot;&gt;&lt;/textarea&gt;
              &lt;/div&gt;
              &lt;div class=&quot;ui-body ui-body-b&quot;&gt;
                  &lt;fieldset class=&quot;ui-grid-a&quot;&gt;
                      &lt;div class=&quot;ui-block-a&quot;&gt;
                          &lt;a href=&quot;#home&quot; id=&quot;addCancelButton&quot; data-role=&quot;button&quot; data-theme=&quot;d&quot;&gt;Cancel&lt;/a&gt;
                      &lt;/div&gt;
                      &lt;div class=&quot;ui-block-b&quot;&gt;
                          &lt;a href=&quot;#&quot; id=&quot;addSubmitButton&quot; data-role=&quot;button&quot; data-theme=&quot;a&quot;&gt;Submit&lt;/a&gt;
                      &lt;/div&gt;
                  &lt;/fieldset&gt;
              &lt;/div&gt;
          &lt;/form&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
</pre>
<p>As i mentioned earlier, if you have been following along with the previous posts, the <strong>addAlbum</strong> page is very similar to the <strong>external</strong> <em>album edit</em> page (created in the last post); the only difference being that the fields/buttons have different <strong>id</strong>s and the header is left to default in displaying the <strong>Back</strong> button.</p>
<p>There is associated script with the internal <strong>addAlbum</strong> page that handles submitting a new album document to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database, and there is no time like the present to shut me up and dive right in. Make the following changes to the previously created <em>handleDocumentReady</em>() <strong>JavaScript</strong> method within <em>index.html</em>:</p>
<p><em>_attachments/index.html</em></p>
<pre class="brush: jscript; first-line: 51; highlight: [56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72]; title: ;" title="">
function handleDocumentReady()
{
    $(&quot;#home&quot;).bind( &quot;pagebeforeshow&quot;, refreshAlbums );
    refreshAlbums();

    $(&quot;#addSubmitButton&quot;).live( &quot;click&quot;, function( event ) {
        event.preventDefault();
        var document = {};
        document.artist = $(&quot;input#addArtistField&quot;).val();
        document.title = $(&quot;input#addTitleField&quot;).val();
        document.description = $(&quot;textarea#addDescriptionField&quot;).val();
        document.creation_date = ( new Date() ).getTime();
        $db.saveDoc( document, {
                success: function() {
                    $.mobile.changePage( &quot;#home&quot;, &quot;slidedown&quot;, true, true );
                },
                error: function() {
                    alert( &quot;Cannot save new document.&quot; );
                 }
        });
        return false;
    });
}
</pre>
<p>Essentially, we add a <em>click</em> event handler to the <strong>submit button</strong>, create a new document object, fill in the proper fields then use the <strong>$db</strong> instance (established on load as the albums databased from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance) to save the new document. You may notice that saving a new document and updating an existing document are both done using the same function from the <strong>jquery.couch</strong> plugin: <em>saveDoc</em>(). That function will check for an <strong>_id</strong> on the document object (first argument) and determine if a <strong>POST</strong> or <strong>PUT</strong> is required. That is all handled internally in <em>saveDoc</em>() so you don&#8217;t have to worry.</p>
<h3>creation_date</h3>
<p>You may have also noticed that i said &#8220;proper fields&#8221; and the document object has a property that was not on the previous documents we created from the first post. Where did this <strong>creation_date</strong> property come from? And why won&#8217;t it throw an error on save? Short answer: we are working with a document-oriented database, so we are not tied to a schema and a pre-defined set of fields in a table. So anything can be added to any document?! Isn&#8217;t that a little wild-west?! Maybe, but we are making a pretty focused client application here where we know what fields we want to present to the user; but it is a good point and a solid argument to not keep your <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance in <a href="http://guide.couchdb.org/draft/security.html" target="_blank">admin-party</a> and to create good <a href="http://guide.couchdb.org/draft/validation.html" target="_blank">validation functions</a>. For now, we are not concerned about security or validation and are having some fun.</p>
<p>OK, so why did we add <strong>creation_date</strong>? The reason is related to the <strong>map function</strong> for <em>/views/albums</em>. If you remember way back to the <a href="http://custardbelly.com/blog/?p=244" target="_blank">first article</a>, we created a <strong>map function</strong> for our <strong>albums view</strong> that basically returned a key and value. The key being the <strong>_id</strong> of each document. That key is used to sort the returned array of documents. That key is also automatically generated for us when we create a new document. Hence, a case could be made that the order of added documents will not correlate to the descending order of the sorted key list (<strong>_id</strong> of each document in the database). In order to be able to properly present the list of albums in the order that they were added to the database, the <strong>creation_date</strong> property is now being added to each new document. I use the time in milliseconds as the value for <strong>creation_date</strong> because i feel that most (if not all) client-side languages will know how to use that number and format the date as required.</p>
<h3>Updating albums view</h3>
<p>Well&#8230; now there is the issue of returning and displaying album documents sorted by <strong>creation_date</strong>. Fortunately it is an easy issue to resolve: we are going to update the key value returned from the <strong>map function</strong> of the <strong>albums view</strong>.</p>
<p>Open up <em>/views/albums/map.js</em> in your favorite text editor and change the previously-saved <em>emit</em>() invocation to the following:</p>
<p>/views/albums/map.js</p>
<pre class="brush: jscript; first-line: 1; highlight: [2]; title: ;" title="">
function(doc) {
  emit( ( new Date(doc.creation_date) ).getTime(), doc );
}
</pre>
<p>We are now using the <strong>creation_date</strong> property as the key for each document to return. <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> will sort on this key and return a list of documents from the <strong>albums</strong> database in our <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance. You may notice that we are resolving to a new instance of <strong>Date</strong> using the <strong>creation_date</strong> property value and then returning the same value using <em>getTime</em>(). Seems a little superfluous. However, it is just a sort of future-proofing if a requirement comes down the pipe that <strong>creation_date</strong> needs to be saved in some other format. Who knows.</p>
<h3>Sorting</h3>
<p>If we were to push our changes and requested the list of album documents, you would notice that the documents are sorted by <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> in ascending order (oldest <strong>creation_date</strong> first). Now, we could create a <strong>reduce function</strong> to return the list in descending order, but i don&#8217;t think that is the best use of <strong>reduce</strong> seeing as we can easily using <strong>JavaScript</strong> to reverse the array upon response. So, I am going to make you open up <em>index.html</em> again and add one line with the <em>refreshAlbums</em>() <strong>JavaScript</strong> method:</p>
<p><em>/_attachments/index.html</em></p>
<pre class="brush: jscript; first-line: 83; highlight: [96]; title: ;" title="">
function refreshAlbums()
{
    $(&quot;#albums&quot;).empty();
    $db.view(&quot;albums/albums&quot;, {
        success: function( data ) {
                var i;
                var album;
                var artist;
                var title;
                var description;
                var listItem;
                var header;
                var albumLink;
                data.rows.reverse();
                for( i in data.rows )
                {
                    album = data.rows[i].value;
                    artist = album.artist;
                    title = album.title;
                    description = album.description;
                    externalPage = &quot;_show/album/&quot; + album._id;
                    listItem = &quot;&lt;li class=\&quot;album\&quot;&gt;&quot; +
                                &quot;&lt;a href=\&quot;&quot; + externalPage + &quot;\&quot;&gt;&quot; +
                                    &quot;&lt;h2 class=\&quot;artist\&quot;&gt;&quot; + artist + &quot;&lt;\/h2&gt;&quot; +
                                &quot;&lt;\/a&gt;&quot; +
                                &quot;&lt;p class=\&quot;title\&quot;&gt;&quot; + title + &quot;&lt;\/p&gt;&quot; +
                                &quot;&lt;p class=\&quot;description\&quot;&gt;&quot; + description + &quot;&lt;\/p&gt;&quot; +
                               &quot;&lt;\/li&gt;&quot;;
                    $(&quot;#albums&quot;).append( listItem );
                }
                $(&quot;#albums&quot;).listview( &quot;refresh&quot; );
            }
    });
}
</pre>
<p>That&#8217;s it! Just reverse the returned rows of album documents from the view request and we have a descending list of albums we have added to the database based on <strong>creation_date</strong>.</p>
<p>Now the only problem is we have no way of accessing the <strong>addAlbum</strong> page! Don&#8217;t fret. We&#8217;re going to add a button bar to the <strong>footer</strong> of the <strong>#home</strong> page that will take us there.</p>
<h2>Updating #home Footer</h2>
<p>We are going to update the default (<strong>#home</strong>) <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page for our application to display a button bar in the <strong>footer</strong>. Originally, we just had some text there as a placeholder, but seeing as we want to ability to add album documents from the list view will replace that text with a <strong>navbar</strong> containing a single button &#8211; the <strong>add button</strong> &#8211; that will navigate the user to the <em>album add</em> page we created in the previous section of this article. Doing so will involve a couple user experience issues that we will address and uncover a few more <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> goodies.</p>
<p>Open up <em>/_attachments/index.html</em> in your favorite editor and save the following modifications to the <strong>#home</strong> page:</p>
<p><em>/_attachments/index.html</em></p>
<pre class="brush: xml; first-line: 9; highlight: [10,14,15,16,17,18,19,20]; title: ;" title="">
&lt;div id=&quot;home&quot; data-role=&quot;page&quot;&gt;
  &lt;div data-role=&quot;header&quot; data-position=&quot;fixed&quot;&gt;&lt;h1&gt;Albums&lt;/h1&gt;&lt;/div&gt;
  &lt;div data-role=&quot;content&quot;&gt;
      &lt;ul id=&quot;albums&quot; data-role=&quot;listview&quot; data-theme=&quot;c&quot; data-dividertheme=&quot;b&quot;&gt;&lt;/ul&gt;
  &lt;/div&gt;
  &lt;div data-role=&quot;footer&quot; data-position=&quot;fixed&quot;&gt;
    &lt;div data-role=&quot;navbar&quot;&gt;
        &lt;ul class=&quot;ui-grid-a&quot;&gt;
            &lt;li style=&quot;width:100%;&quot;&gt;&lt;a href=&quot;#addAlbum&quot; data-transition=&quot;slideup&quot; data-icon=&quot;plus&quot;&gt;Add Album&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</pre>
<p>The first thing you may notice is that we have added a <strong>data-position</strong> attribute to the <strong>header</strong> and <strong>footer</strong>. With a value of &#8220;<em>fixed</em>&#8220;, the<a href="http://jquerymobile.com/" target="_blank"> jQuery Mobile</a> framework will ensure that they are always in place (<strong>header</strong> at top, <strong>footer</strong> at bottom) without regards to scrolling. This will treat the content list as the scrollable area, so when our list grows with all the new album documents that we create a user will always see and be able to access the <strong>header</strong> and <strong>footer</strong> (with the <strong>add button</strong>).</p>
<p>Aside from the <strong>data-position</strong> attribution, we added a <strong>navbar</strong> as the content for the <strong>footer</strong>. The content of the <strong>navbar</strong> is a list with a single item with its navigational reference to the <strong>addAlbum</strong> <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page we created previously. Assigning a <a href="http://jquerymobile.com/demos/1.0a2/#docs/content/content-grids.html" target="_blank">grid</a> class to the list will layout its items in a sequently manner. We set the <strong>width</strong> style rule directly for the list item because styling of list items for a <strong>navbar</strong> are limited to at least 2 items in the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a>. To get around that and have a single button, we just set it to have the width of the <strong>navbar</strong>. Then we also got all fancy with transitions and icons on the link within the list item <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<p>The only drawback to this solution is that we dynamically fill our list upon load. Unfortunately this updates the y position of the <strong>footer</strong> by (<em>n*list item height</em>). So if we kept our page like this, we&#8217;d lose the <strong>footer</strong> off the page once the list is filled <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_sad.gif' alt=':(' class='wp-smiley' />  Wait, don&#8217;t leave&#8230; we can easily fix that!</p>
<p>With the <em>/_attachments/index.html</em> file still open in your favorite text editor, add the following line after the list <em>refresh</em>():</p>
<p><em>/_attachments/index.html</em></p>
<pre class="brush: jscript; first-line: 83; highlight: [115]; title: ;" title="">
function refreshAlbums()
{
    $(&quot;#albums&quot;).empty();
    $db.view(&quot;albums/albums&quot;, {
        success: function( data ) {
                var i;
                var album;
                var artist;
                var title;
                var description;
                var listItem;
                var header;
                var albumLink;
                data.rows.reverse();
                for( i in data.rows )
                {
                    album = data.rows[i].value;
                    artist = album.artist;
                    title = album.title;
                    description = album.description;
                    externalPage = &quot;_show/album/&quot; + album._id;
                    listItem = &quot;&lt;li class=\&quot;album\&quot;&gt;&quot; +
                                &quot;&lt;a href=\&quot;&quot; + externalPage + &quot;\&quot;&gt;&quot; +
                                    &quot;&lt;h2 class=\&quot;artist\&quot;&gt;&quot; + artist + &quot;&lt;\/h2&gt;&quot; +
                                &quot;&lt;\/a&gt;&quot; +
                                &quot;&lt;p class=\&quot;title\&quot;&gt;&quot; + title + &quot;&lt;\/p&gt;&quot; +
                                &quot;&lt;p class=\&quot;description\&quot;&gt;&quot; + description + &quot;&lt;\/p&gt;&quot; +
                                &quot;&lt;p class=\&quot;date\&quot;&gt;&quot; + new Date( album.creation_date ) + &quot;&lt;\/p&gt;&quot; +
                               &quot;&lt;\/li&gt;&quot;;
                    $(&quot;#albums&quot;).append( listItem );
                }
                $(&quot;#albums&quot;).listview( &quot;refresh&quot; );
                $.fixedToolbars.show();
            }
    });
}
</pre>
<p>The <strong>fixedToolbars</strong> controller is available from <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> with several public methods exposed for dealing with the <strong>header</strong> and <strong>footer</strong> toolbars. We are using <em>show</em>() to force an update in placement once the list has been refreshed. This will affectively put the <strong>footer</strong> (with its add button) back to the bottom where it belongs and is accessible. Hack? Maybe. But it works for now (see versions at end of post <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> ).</p>
<p>So that is it&#8230; except for one thing. </p>
<h3>Finishing Up</h3>
<p>I can be a stickler. The <strong>addAlbum</strong> page is not removed from the <strong>DOM</strong> once navigated away from like the other pages we have created. We did that previously to ensure we were getting the correct returns from the <strong>show function</strong> based on document <strong>_id</strong>; <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> was caching those pages in the <strong>DOM</strong> so it never went back out with the update <strong>_id</strong>. However, our case here is a little different. </p>
<p>The <strong>addAlbum</strong> page is not associated with a document upon view. It just saves a document to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database using the <em>jquery.couch</em> plugin. As such, if a user navigates away from the page &#8211; either from an explicit cancel/close or directed back to <strong>#home</strong> upon save success &#8211; we should clear out those input fields. Otherwise, when a user navigates to the <strong>addAlbum</strong> page again, we&#8217;ll always see the last input. That shouldn&#8217;t be the case. The user should start fresh each time. To do that, we&#8217;ll just listen to when the page is hidden in the <strong>DOM</strong> and clear the fields.</p>
<p>With <em>/_attachments/index.html</em> still open in your favorite text editor, save the following modifications to the <em>handleDocumentReady</em>() <strong>JavaScript</strong> function:</p>
<p><em>/_attachments/index.html</em></p>
<pre class="brush: jscript; first-line: 57; highlight: [80,81,82,83,84]; title: ;" title="">
function handleDocumentReady()
{
    $(&quot;#home&quot;).bind( &quot;pagebeforeshow&quot;, refreshAlbums );
    refreshAlbums();

    $(&quot;#addSubmitButton&quot;).live( &quot;click&quot;, function( event ) {
        event.preventDefault();
        var document = {};
        document.artist = $(&quot;input#addArtistField&quot;).val();
        document.title = $(&quot;input#addTitleField&quot;).val();
        document.description = $(&quot;textarea#addDescriptionField&quot;).val();
        document.creation_date = ( new Date() ).getTime();
        $db.saveDoc( document, {
                success: function() {
                    $.mobile.changePage( &quot;#home&quot;, &quot;slidedown&quot;, true, true );
                },
                error: function() {
                    alert( &quot;Cannot save new document.&quot; );
                 }
        });
        return false;
    });

    $(&quot;#addAlbum&quot;).bind( &quot;pagehide&quot;, function() {
       $(&quot;input#addArtistField&quot;).val( &quot;&quot; );
       $(&quot;input#addTitleField&quot;).val( &quot;&quot; );
       $(&quot;textarea#addDescriptionField&quot;).val( &quot;&quot; );
    });
}
</pre>
<p>Similarly to how we listened for navigation away from the other <strong>external</strong> pages, we assign an even handler for the &#8220;<em>pagehide</em>&#8221; event and clear the input fields. That will be invoked upon back/cancel and successful commit (via the <strong>$.mobile</strong>.<em>changePage</em>() method), so we can ensure that the fields are always presented empty upon hitting the <strong>addAlbum</strong> page.</p>
<p>So we are all on the same page (pun&#8230; intended?), here is the updated <em>/_attachments/index.html</em> file in all its modified glory:</p>
<pre class="brush: xml; first-line: 1; title: ;" title="">
&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;My Albums&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;style/main.css&quot; type=&quot;text/css&quot;&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;style/jquery.mobile-1.0a2.css&quot; type=&quot;text/css&quot;/&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id=&quot;home&quot; data-role=&quot;page&quot;&gt;
          &lt;div data-role=&quot;header&quot; data-position=&quot;fixed&quot;&gt;&lt;h1&gt;Albums&lt;/h1&gt;&lt;/div&gt;
          &lt;div data-role=&quot;content&quot;&gt;
              &lt;ul id=&quot;albums&quot; data-role=&quot;listview&quot; data-theme=&quot;c&quot; data-dividertheme=&quot;b&quot;&gt;&lt;/ul&gt;
          &lt;/div&gt;
          &lt;div data-role=&quot;footer&quot; data-position=&quot;fixed&quot;&gt;
            &lt;div data-role=&quot;navbar&quot;&gt;
                &lt;ul class=&quot;ui-grid-a&quot;&gt;
                    &lt;li style=&quot;width:100%;&quot;&gt;&lt;a href=&quot;#addAlbum&quot; data-transition=&quot;slideup&quot; data-icon=&quot;plus&quot;&gt;Add Album&lt;/a&gt;&lt;/li&gt;
                &lt;/ul&gt;
            &lt;/div&gt;
          &lt;/div&gt;
      &lt;/div&gt;
      &lt;div id=&quot;addAlbum&quot; data-role=&quot;page&quot;&gt;
          &lt;div data-role=&quot;header&quot;&gt;&lt;h1&gt;Add Album&lt;/h1&gt;&lt;/div&gt;
          &lt;div data-role=&quot;content&quot;&gt;
              &lt;form id=&quot;albumAddForm&quot; action=&quot;#&quot; method=&quot;get&quot;&gt;
                  &lt;div data-role=&quot;fieldcontain&quot;&gt;
                    &lt;label for=&quot;artist&quot;&gt;Artist:&lt;/label&gt;
                       &lt;input id=&quot;addArtistField&quot; name=&quot;artist&quot; type=&quot;text&quot; /&gt;
                &lt;/div&gt;
                &lt;div data-role=&quot;fieldcontain&quot;&gt;
                    &lt;label for=&quot;title&quot;&gt;Title:&lt;/label&gt;
                       &lt;input id=&quot;addTitleField&quot; name=&quot;title&quot; type=&quot;text&quot; /&gt;
                &lt;/div&gt;
                &lt;div data-role=&quot;fieldcontain&quot;&gt;
                    &lt;label for=&quot;description&quot;&gt;Description:&lt;/label&gt;
                    &lt;textarea id=&quot;addDescriptionField&quot; name=&quot;description&quot; cols=&quot;40&quot; rows=&quot;8&quot;&gt;&lt;/textarea&gt;
                &lt;/div&gt;
                &lt;div class=&quot;ui-body ui-body-b&quot;&gt;
                    &lt;fieldset class=&quot;ui-grid-a&quot;&gt;
                        &lt;div class=&quot;ui-block-a&quot;&gt;
                            &lt;a href=&quot;#home&quot; id=&quot;addCancelButton&quot; data-role=&quot;button&quot; data-theme=&quot;d&quot;&gt;Cancel&lt;/a&gt;
                        &lt;/div&gt;
                        &lt;div class=&quot;ui-block-b&quot;&gt;
                            &lt;a href=&quot;#&quot; id=&quot;addSubmitButton&quot; data-role=&quot;button&quot; data-theme=&quot;a&quot;&gt;Submit&lt;/a&gt;
                        &lt;/div&gt;
                    &lt;/fieldset&gt;
                &lt;/div&gt;
            &lt;/form&gt;
          &lt;/div&gt;
      &lt;/div&gt;
  &lt;/body&gt;
  &lt;script src=&quot;vendor/couchapp/loader.js&quot;&gt;&lt;/script&gt;
  &lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;

      $db = $.couch.db(&quot;albums&quot;);

      function handleDocumentReady()
      {
          $(&quot;#home&quot;).bind( &quot;pagebeforeshow&quot;, refreshAlbums );
          refreshAlbums();

          $(&quot;#addSubmitButton&quot;).live( &quot;click&quot;, function( event ) {
              event.preventDefault();
              var document = {};
              document.artist = $(&quot;input#addArtistField&quot;).val();
              document.title = $(&quot;input#addTitleField&quot;).val();
              document.description = $(&quot;textarea#addDescriptionField&quot;).val();
              document.creation_date = ( new Date() ).getTime();
              $db.saveDoc( document, {
                      success: function() {
                          $.mobile.changePage( &quot;#home&quot;, &quot;slidedown&quot;, true, true );
                      },
                      error: function() {
                          alert( &quot;Cannot save new document.&quot; );
                      }
              });
              return false;
          });

          $(&quot;#addAlbum&quot;).bind( &quot;pagehide&quot;, function() {
              $(&quot;input#addArtistField&quot;).val( &quot;&quot; );
              $(&quot;input#addTitleField&quot;).val( &quot;&quot; );
              $(&quot;textarea#addDescriptionField&quot;).val( &quot;&quot; );
          });
      }

      function refreshAlbums()
      {
          $(&quot;#albums&quot;).empty();
          $db.view(&quot;albums/albums&quot;, {
            success: function( data ) {
                    var i;
                    var album;
                    var artist;
                    var title;
                    var description;
                    var listItem;
                    var header;
                    var albumLink;
                    data.rows.reverse();
                    for( i in data.rows )
                    {
                        album = data.rows[i].value;
                        artist = album.artist;
                        title = album.title;
                        description = album.description;
                        externalPage = &quot;_show/album/&quot; + album._id;
                        listItem = &quot;&lt;li class=\&quot;album\&quot;&gt;&quot; +
                                    &quot;&lt;a href=\&quot;&quot; + externalPage + &quot;\&quot;&gt;&quot; +
                                        &quot;&lt;h2 class=\&quot;artist\&quot;&gt;&quot; + artist + &quot;&lt;\/h2&gt;&quot; +
                                    &quot;&lt;\/a&gt;&quot; +
                                    &quot;&lt;p class=\&quot;title\&quot;&gt;&quot; + title + &quot;&lt;\/p&gt;&quot; +
                                    &quot;&lt;p class=\&quot;description\&quot;&gt;&quot; + description + &quot;&lt;\/p&gt;&quot; +
                                    &quot;&lt;\/li&gt;&quot;;
                        $(&quot;#albums&quot;).append( listItem );
                    }
                    $(&quot;#albums&quot;).listview( &quot;refresh&quot; );
                    $.fixedToolbars.show();
                }
            });
      }
      $(document).ready( handleDocumentReady );

  &lt;/script&gt;
&lt;/html&gt;
</pre>
<h3>Deployment</h3>
<p>We modified our application to utilize a <strong>show function</strong> to serve the <em>albumadd</em> page up within a <a href="http://jquerymobile.com/" target="_blank">jquery Mobile</a> application. With these changes saved, we can now push to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database using the <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> utility. Open a terminal and navigate to the directory where you create your <strong>CouchApp</strong> applications (for me that is <em>/Documents/workspace/custardbelly/couchdb</em> and in there i have a folder named <em>albums</em> which is the <strong>CouchApp</strong> application directory for these examples). Enter the following command to push the changes to the <strong>CouchDB</strong> instance:</p>
<pre class="brush: bash; title: ;" title="">
couchapp push albums http://127.0.0.1:5984/albums
</pre>
<p>If all was successful and you now go to <a href="http://127.0.0.1:5984/albums/_design/albums/index.html" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html</a>, we&#8217;ll still have our old familiar list and our new <strong>navbar</strong> items in the <strong>footer</strong>. Click the <strong>Add Album</strong> button to open the form and save some information. The document should be saved to the <strong>CouchDB</strong> database and the application will direct you back to the <strong>#home</strong> page with the updated list of albums.</p>
<p><em>index.html#addAlbum</em><br />
<img src="http://www.custardbelly.com/blog/images/couchapp_add_album.png" /></p>
<p><em>index.html#home</em><br />
<img src="http://www.custardbelly.com/blog/images/couchapp_new_list.png" /></p>
<h3>Conclusion</h3>
<p>In this article, we added another important piece to working with documents from a database &#8211; <strong>Create</strong>. Along the way  we uncovered a little about view maps from <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> and how they are sorted. We also found that the <strong>jquery.couch</strong> plugin handles create and update of documents through the same method &#8211; <em>saveDoc</em>() &#8211; on a database instance. As well, as it pertains to visible changes, we employed fixed toolbars, added custom <strong>footer</strong> content and discussed a little about the decision between using <strong>internal</strong> and <strong>external</strong> pages as it pertains to <em>User Experience</em> and application design. Hopefully, it all worked out. </p>
<p>Next up: we got the <strong>CRU</strong>&#8230; we need to the <strong>D</strong>.</p>
<p><em>[Note] This post was written against the following software versions:</em><br />
<strong>CouchDB </strong>– 1.0.1<br />
<strong>CouchApp</strong> – 0.7.2<br />
<strong>jQuery</strong> – 1.4.4<br />
<strong>jQuery Mobile</strong> – 1.0a2<br />
<em>If you have found this post and any piece has moved forward, hopefully the examples are still viable/useful. I will not be updating the examples in this post in parellel with updates to any of the previously mentioned software, unless explicitly noted.</em></p>
<p><strong>Articles in this series:</strong></p>
<ol>
<li><a href="http://custardbelly.com/blog/?p=244" target="_blank">Getting Started</a></li>
<li><a href="http://custardbelly.com/blog/?p=278" target="_blank">Displaying a page detail of a single album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=297" target="_blank">Templates and Mustache</a></li>
<li><a href="http://custardbelly.com/blog/?p=318" target="_blank">Displaying an editable page of an album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=332" target="_blank">Creating and Adding an album document.</a></li>
<li><a href="http://custardbelly.com/blog/?p=344" target="_blank">Deleting an album document</a></li>
<li><a href="http://custardbelly.com/blog/?p=360" target="_blank">Authorization and Validation &#8211; Part 1</a></li>
<li><a href="http://custardbelly.com/blog/?p=394">Authorization and Validation &#8211; Part 2</a></li>
</ol>
<p><a href="http://custardbelly.com/downloads/couchapp/jqm_couchdb_albums.zip">Full source for albums couchapp here.</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/couchdb/" title="View all posts in CouchDB" rel="category tag">CouchDB</a>,  <a href="http://custardbelly.com/blog/category/jquery/" title="View all posts in jquery" rel="category tag">jquery</a>,  <a href="http://custardbelly.com/blog/category/jquery-mobile/" title="View all posts in jquery-mobile" rel="category tag">jquery-mobile</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2011/01/12/jquery-mobile-couchdb-part-5-adding-documents/#comments" rev="post-332"  title="Comment on jQuery Mobile + CouchDB: Part 5 &#8211; Adding Documents">3 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2011-01-12T07:34">January 12, 2011</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-332-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-318" class="post-318 post hentry category-couchdb category-jquery category-jquery-mobile full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2011/01/04/jquery-mobile-couchdb-part-4-editing-documents/" title="Permanent link to jQuery Mobile + CouchDB: Part 4 &#8211; Editing Documents" rel="bookmark" rev="post-318">jQuery Mobile + CouchDB: Part 4 &#8211; Editing Documents</a></h1>
	
	<div class="entry-content full-content">
		<p>In the <a href="http://custardbelly.com/blog/?p=297" target="_blank">previous post</a>, I addressed using templates to generate the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> external pages. Though it addressed a fundamental (imo) part of serving up <strong>HTML</strong> from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance and had a few nice tricks for <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a>, it essentially was organization and cleanup so I could move forward in developing the application without it getting to cluttered for my development and workflow.</p>
<p>In this article, I am going to take the templating structure established in the <a href="http://custardbelly.com/blog/?p=297" target="_blank">previous post</a> and add another external page to the<a href="http://jquerymobile.com/" target="_blank"> jQuery Mobile</a> application &#8211; one in which I will be able to edit the document served up from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database. Along with this, I&#8217;ll discuss assigning event handlers to <strong>DOM</strong> elements using <a href="http://jquery.com/" target="_blank">jQuery</a>, adding buttons to footers and headers, and clearing external <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> pages from cache to ensure a user is looking at the most recent changes to a document.</p>
<h2>Edit Template</h2>
<p>In the <a href="http://custardbelly.com/blog/?p=297">previous post</a>, we moved from returning <strong>HTML</strong> from <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> using a <strong>show function</strong> and string manipulation to moving mark-up over to a <strong>template</strong> and utilizing <a href="https://github.com/janl/mustache.js" target="_blank">Mustache</a> to render the served up <strong>jQuery Mobile</strong> external page. We are going to use the same technique to deliver another page that will allow a user to edit a target <strong>CouchDB</strong> document, with the option to either cancel or submit their changes.</p>
<p>Open up your favorite text editor, add the following snippet and save the file as <em>albumedit.html</em> in the <em>/templates</em> directory of your <strong>albums</strong> <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> (eg. <em>/Documents/workspace/custardbelly/couchdb/albums/templates/albumedit.html</em>):</p>
<p><em>/templates/albumedit.html</em></p>
<pre class="brush: xml; first-line: 1; title: ;" title="">
&lt;div data-role=&quot;page&quot; id=&quot;albumedit&quot; data-nobackbtn=&quot;true&quot;&gt;
    &lt;div data-role=&quot;header&quot; id=&quot;albumheader&quot;&gt;
        &lt;a id=&quot;cancelBackButton&quot; href=&quot;#&quot; data-icon=&quot;delete&quot;&gt;Close&lt;/a&gt;
        &lt;h1 class=&quot;albumtitle&quot;&gt;{{title}}&lt;/h1&gt;
    &lt;/div&gt;
    &lt;div data-role=&quot;content&quot; data-theme=&quot;c&quot; style=&quot;padding:0em;&quot;&gt;
        &lt;form id=&quot;albumform&quot; action=&quot;#&quot; method=&quot;get&quot; data-identity=&quot;{{document}}&quot;&gt;
            &lt;div data-role=&quot;fieldcontain&quot;&gt;
                &lt;label for=&quot;artist&quot;&gt;Artist:&lt;/label&gt;
                &lt;input id=&quot;artistField&quot; name=&quot;artist&quot; type=&quot;text&quot; value=&quot;{{artist}}&quot; /&gt;
            &lt;/div&gt;
            &lt;div data-role=&quot;fieldcontain&quot;&gt;
                &lt;label for=&quot;title&quot;&gt;Title:&lt;/label&gt;
                &lt;input id=&quot;titleField&quot; name=&quot;title&quot; type=&quot;text&quot; value=&quot;{{title}}&quot; /&gt;
            &lt;/div&gt;
            &lt;div data-role=&quot;fieldcontain&quot;&gt;
                &lt;label for=&quot;description&quot;&gt;Description:&lt;/label&gt;
                &lt;textarea id=&quot;descriptionField&quot; name=&quot;description&quot; cols=&quot;40&quot; rows=&quot;8&quot;&gt;{{description}}&lt;/textarea&gt;
            &lt;/div&gt;
            &lt;div class=&quot;ui-body ui-body-b&quot;&gt;
                &lt;fieldset class=&quot;ui-grid-a&quot;&gt;
                    &lt;div class=&quot;ui-block-a&quot;&gt;
                        &lt;p id=&quot;cancelButton&quot; data-role=&quot;button&quot; data-theme=&quot;d&quot;&gt;Cancel&lt;/p&gt;
                    &lt;/div&gt;
                    &lt;div class=&quot;ui-block-b&quot;&gt;
                        &lt;p id=&quot;submitButton&quot; data-role=&quot;button&quot; data-theme=&quot;a&quot;&gt;Submit&lt;/p&gt;
                    &lt;/div&gt;
                &lt;/fieldset&gt;
            &lt;/div&gt;
        &lt;/form&gt;
    &lt;/div&gt;
    &lt;div data-role=&quot;footer&quot; /&gt;
&lt;/div&gt;
{{&gt;scripts}}
</pre>
<p>That is some pretty hefty mark-up in relation to the relatively small (element count-wise) pages we have previously created. What should be familiar are the <strong>{{mustache}}</strong> tokens which will be dynamically filled with content using <a href="https://github.com/janl/mustache.js" target="_blank">mustache.js</a> in our soon-to-be created <strong>show function</strong> for the <em>album edit</em> page; but there are a few <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> tidbits in here that we should take a little deeper of a look at.</p>
<h3>Page &#038; Header</h3>
<p><em>/templates/albumedit.html</em></p>
<pre class="brush: xml; first-line: 1; title: ;" title="">
&lt;div data-role=&quot;page&quot; id=&quot;albumedit&quot; data-nobackbtn=&quot;true&quot;&gt;
    &lt;div data-role=&quot;header&quot; id=&quot;albumheader&quot;&gt;
        &lt;a id=&quot;cancelBackButton&quot; href=&quot;#&quot; data-icon=&quot;delete&quot;&gt;Close&lt;/a&gt;
        &lt;h1 class=&quot;albumtitle&quot;&gt;{{title}}&lt;/h1&gt;
    &lt;/div&gt;
</pre>
<p>A <strong>data-role</strong> of <em>page</em> is set as usual to declare a <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page and an <strong>id</strong> attribute is assigned for a reason that will be discussed shortly. What is of note in the page <strong>div</strong> is the <strong>data-nobackbtn</strong> attribute. If set the a value of <em>true</em>, this declaration will remove the default <strong>Back</strong> button from the header and allow us to customize the options. For this case, we have replaced the <strong>Back</strong> button with a <strong>Close</strong> button:</p>
<p><em>/templates/albumedit.html</em></p>
<pre class="brush: xml; first-line: 3; title: ;" title="">
&lt;a id=&quot;cancelBackButton&quot; href=&quot;#&quot; data-icon=&quot;delete&quot;&gt;Close&lt;/a&gt;
</pre>
<p>Without specifying a style <strong>class</strong>, the <strong>Close</strong> button will be positioned to the left in the header. The <strong>href</strong> is set to an empty anchor. Essentially this is just a placeholder for an action defaulted to a link in the header. When we create the controller script for the <em>album edit</em> page later in this article, we will prevent the default behaviour and handle the close manually.</p>
<h3>Content Form</h3>
<p><a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> has some great organization and styling when it comes to <strong>form</strong> elements. Positioning and aligning fields is all handled by the framework and, unless you want to get fancy, you basically just have to declare the desired element or assign the desired role/layout in order to achieve a fairly simple form. What we have done for our <em>album edit</em> page template is pretty basic:</p>
<p><em>/templates/albumedit.html</em></p>
<pre class="brush: xml; first-line: 7; title: ;" title="">
&lt;form id=&quot;albumform&quot; action=&quot;#&quot; method=&quot;get&quot; data-identity=&quot;{{document}}&quot;&gt;
    &lt;div data-role=&quot;fieldcontain&quot;&gt;
        &lt;label for=&quot;artist&quot;&gt;Artist:&lt;/label&gt;
        &lt;input id=&quot;artistField&quot; name=&quot;artist&quot; type=&quot;text&quot; value=&quot;{{artist}}&quot; /&gt;
    &lt;/div&gt;
    &lt;div data-role=&quot;fieldcontain&quot;&gt;
        &lt;label for=&quot;title&quot;&gt;Title:&lt;/label&gt;
        &lt;input id=&quot;titleField&quot; name=&quot;title&quot; type=&quot;text&quot; value=&quot;{{title}}&quot; /&gt;
    &lt;/div&gt;
    &lt;div data-role=&quot;fieldcontain&quot;&gt;
        &lt;label for=&quot;description&quot;&gt;Description:&lt;/label&gt;
        &lt;textarea id=&quot;descriptionField&quot; name=&quot;description&quot; cols=&quot;40&quot; rows=&quot;8&quot;&gt;{{description}}&lt;/textarea&gt;
    &lt;/div&gt;
    &lt;div class=&quot;ui-body ui-body-b&quot;&gt;
        &lt;fieldset class=&quot;ui-grid-a&quot;&gt;
            &lt;div class=&quot;ui-block-a&quot;&gt;
                &lt;p id=&quot;cancelButton&quot; data-role=&quot;button&quot; data-theme=&quot;d&quot;&gt;Cancel&lt;/p&gt;
            &lt;/div&gt;
            &lt;div class=&quot;ui-block-b&quot;&gt;
                &lt;p id=&quot;submitButton&quot; data-role=&quot;button&quot; data-theme=&quot;a&quot;&gt;Submit&lt;/p&gt;
            &lt;/div&gt;
        &lt;/fieldset&gt;
    &lt;/div&gt;
&lt;/form&gt;
</pre>
<p>The input fields are populated with the dynamic values from our <strong>show function</strong> (discussed later) and two buttons are presented to either <strong>Cancel</strong> or <strong>Submit</strong> any changes to those values. By marking each <strong>div</strong> with a <strong>data-role</strong> of <em>fieldcontain</em>, the label/input pair will be styled and aligned with each other <strong>div</strong> with a horizontal bar to delimit them vertically. The <strong>Cancel</strong> and <strong>Submit</strong> buttons are held in a <strong>fieldset</strong> with a grid layout assigned:</p>
<p><em>/templates/albumedit.html</em></p>
<pre class="brush: xml; first-line: 21; title: ;" title="">
&lt;fieldset class=&quot;ui-grid-a&quot;&gt;
    &lt;div class=&quot;ui-block-a&quot;&gt;
        &lt;p id=&quot;cancelButton&quot; data-role=&quot;button&quot; data-theme=&quot;d&quot;&gt;Cancel&lt;/p&gt;
    &lt;/div&gt;
    &lt;div class=&quot;ui-block-b&quot;&gt;
        &lt;p id=&quot;submitButton&quot; data-role=&quot;button&quot; data-theme=&quot;a&quot;&gt;Submit&lt;/p&gt;
    &lt;/div&gt;
&lt;/fieldset&gt;
</pre>
<p>By assigning a <em>ui-block</em> value to each <strong>div</strong> in the <strong>fieldset</strong>, they will essentially be sized at 50% within the grid and positioned accordingly &#8211; <strong>Cancel</strong> to the left of <strong>Submit</strong>. You may notice that the &#8220;buttons&#8221; are not a link elements nor button elements. The reason being that both of those within a context of a form element were somehow being overridden to always perform a submit action. We will want to trap the user interaction with these elements in order to either <strong>a)</strong> reset the field values or <strong>b)</strong> submit our changes to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database. So, they have been declared as <strong>p</strong> elements with a <strong>data-role</strong> of button so as to have the proper styling, but not the default action role of submittal of form without being captured and prevented first. </p>
<p>We will get into the submission of an edited document in a bit when we discuss the associated script with the <em>album edit</em> page, but until then take notice of the <strong>Partial</strong> inclusion in our <em>albumedit</em> template:</p>
<p><em>/templates/albumedit.html</em></p>
<pre class="brush: xml; first-line: 34; title: ;" title="">
{{&gt;scripts}}
</pre>
<p>&#8230; and let&#8217;s dive into creating our <strong>show function</strong> for editable album pages.</p>
<h2>Edit Show Function</h2>
<p>If you have been following along with the <a href="http://custardbelly.com/blog/?p=297" target="_blank">previous post</a>, you will remember that we removed the string-manipulated mark-up from the <strong>show function</strong> for the <em>album view</em> page and replaced it with <a href="https://github.com/janl/mustache.js" target="_blank">Mustache</a> templating. The <strong>show function</strong> we will create for the <em>album edit</em> page will largely look the same as the one created for the <em>album view</em> page. In fact, the only difference will be the target template and partial include.</p>
<p>Open up your favorite text editor, create a new file, add the following snippet and save the file as <em>album-edit.js</em> in the <em>/shows</em> directory of your albums <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> (eg. <em>/Documents/workspace/custardbelly/couchdb/albums/shows/album-edit.js</em>):</p>
<p><em>/shows/album-edit.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
function(doc, req) {
    var Mustache = require(&quot;vendor/couchapp/lib/mustache&quot;);
    var stash = {
            artist: doc.artist,
            title : doc.title,
            description: doc.description,
            document: doc._id
    };
    return Mustache.to_html(this.templates.albumedit, stash, this.templates.partials.albumedit);
}
</pre>
<p>Again, if you have been following along with previous posts, this would look relatively familiar. Essentially, we are using the <a href="https://github.com/janl/mustache.js" target="_blank">mustache.js</a> template plugin to deliver <strong>HTML</strong> mark-up of the previously created <em>albumedit.html</em> <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page. The associated document is retrieved from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database by passing the <strong>_id</strong> of the document in the request (eg. <a href="http://127.0.0.1:5984/albums/_design/albums/_show/album-edit/db04eb7e5c845ee0aa791ae1ed001e4d" target="_blank">http://127.0.0.1:5984/albums/_design/albums/_show/<br />
album-edit/db04eb7e5c845ee0aa791ae1ed001e4d</a>). </p>
<p>The previously created <em>/templates/albumedit.html</em> will be used as the template and is supplied as the first argument in <strong>Mustache</strong>.<em>to_html()</em>. The <strong>stash</strong> object (second argument) is used to dynamically filled the values of the fields upon load and the specified properties of the <strong>album document</strong> are available for editing: <strong>artist name</strong>, <strong>album title</strong> and <strong>personal description</strong>. The third argument is the <strong>Partial</strong> includes directory that will be substituted in the <strong>{{>}}</strong> declarations of the <em>/templates/albumedit.html</em> document. There is only one <strong>Partial</strong> defined in <em>albumedit.html</em> &#8211; <strong>{{>scripts}}</strong> &#8211; which will essentially declare a <strong>JavaScript</strong> file with actions associated with the <em>album edit</em> page.</p>
<h2>Scripts Partial</h2>
<p>Open up your favorite text editor and save the following snippet as <em>scripts.html</em> in <em>/templates/partials/albumedit</em>:</p>
<p><em>/templates/partials/albumedit/scripts.html</em></p>
<pre class="brush: xml; first-line: 1; title: ;" title="">
&lt;script src=&quot;../../script/album-edit-page.js&quot;&gt;&lt;/script&gt;
</pre>
<p>If you have followed along with create the <strong>show function</strong>, template and partial for the <em>album view</em> page, this again will look similar. We are essentially loading an associated <strong>JavaScript</strong> file for the <em>album edit</em> page. As explained in the <a href="http://custardbelly.com/blog/?p=297" target="_blank">previous post</a>, the script could be included here and not redirected to a <strong>js</strong> file, but for my own organizational habits I create a separate <strong>JavaScript</strong> file and have it residing in the <em>/_attachments/script/</em> directory of my <strong>albums</strong> <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> (eg. <em>/Documents/workspace/custardbelly/couchdb/albums/<br />
_attachments/script/album-edit-page.js</em>).</p>
<h2>album-edit-page.js</h2>
<p>If we think about the role of our <em>album edit</em> page in the scheme of the application, we want to present the user with the ability to edit the album document from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> <strong>albums</strong> database. The form will initially be filled with the latest editable values and the user has the ability to either submit changes or cancel any pending changes. A <strong>Cancel</strong> action will return the fields back to the original values and return the user to the <em>album view</em> page. To ensure that the user is presented with the latest changes to the document from the database, we will also need to clear the page from the page cache just as we have done with the <em>album view</em> page. With these requirements in mind, let&#8217;s start creating the associated script for the album edit <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page served up from the <em>album-edit</em> <strong>show function</strong>.</p>
<h3>AlbumEditPageController</h3>
<p>We&#8217;ll start by creating a quasi-view-controller for the <em>album edit</em> page in the similar fashion as the one used for the <em>album view</em> page (created in the <a href="http://custardbelly.com/blog/?p=297" target="_blank">previous post</a>). Initially, it will handle recognizing once the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page <strong>div</strong> is shown and remove it from the page cache once it is hidden (by navigating away from the page).</p>
<p>Open your favorite text editor and save the following snippet as <em>album-edit-page.js</em> in the <em>/_attachments/script/</em> directory:</p>
<p><em>/_attachments/script/album-edit-page.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
var AlbumEditPageController = function() {

    function handleEditPageViewHide()
    {
        var docId = $(&quot;#albumform&quot;).data(&quot;identity&quot;);
        var pageCache =  $(document.getElementById(&quot;_show/album-edit/&quot; + docId));
        pageCache.unbind( &quot;pagehide&quot;, handleEditPageViewHide );
        pageCache.empty();
        pageCache.remove();
    }

    function handleEditView()
    {
        // Watch for bound hide of page to clear from cache.
        var docId = $(&quot;#albumform&quot;).data(&quot;identity&quot;);
        var albumPage = $(document.getElementById(&quot;_show/album-edit/&quot; + docId));
        albumPage.bind( &quot;pagehide&quot;, handleEditPageViewHide );
    }

    return {
        initialize: function() {
            $(&quot;div[data-role='page']&quot;).live( &quot;pageshow&quot;, function() {
                $(&quot;div[data-role='page']&quot;).die( &quot;pageshow&quot; );
                handleEditView();
            });
        }
    };
}();

function handleEditPageReady()
{
    AlbumEditPageController.initialize();
}
$().ready( handleEditPageReady )
</pre>
<p>Once the page is loaded, the <strong>AlbumEditPageController</strong> is initialized an a <em>pageshow</em> event handler is assigned to recognize when the <em>albumedit</em> <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page is shown. We access the page in the <strong>DOM</strong> using the standard <strong>data-role</strong> attribute value for a <strong>jQuery Mobile</strong> page. I stumbled upon this solution from these two forum posts – <a href="http://forum.jquery.com/topic/force-page-update" target="_blank">http://forum.jquery.com/topic/force-page-update</a> and <a href="http://forum.jquery.com/topic/binding-events-to-buttons-in-a-dialog" target="_blank">http://forum.jquery.com/topic/binding-events-to-buttons-in-a-dialog</a> – and seem to be the current agreed upon solution for accessing a loading <strong>jQuery Mobile</strong> page. In the <em>handleEditView()</em> handler, the page in the <strong>DOM</strong> is accessed using <strong>document</strong>.<em>getElementById()</em> and assigned an event handler for <em>pagehide</em> to clear it from the page (ie. <strong>DOM</strong>) cache. Aside from the external page <strong>id</strong> used to access the element, this is pretty much identical to the solution from the previous post.</p>
<p>One of the requirements for the <em>album edit</em> page is the ability to cancel and clear any edited fields by the user. In order to do so, we will stored a local object with the provided name/value pairs so the fields can be easily reverted.</p>
<p>With <em>album-edit-page.js</em> open in your favorite text editor, make the following modifications and save the file:</p>
<p><em>/_attachments/script/album-edit-page.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [3,23,26,27,28,29,30,31,32]; title: ;" title="">
var AlbumEditPageController = function() {

    var editableAlbum;

    function handleEditPageViewHide()
    {
        editableAlbum = null;

        var docId = $(&quot;#albumform&quot;).data(&quot;identity&quot;);
        var pageCache =  $(document.getElementById(&quot;_show/album-edit/&quot; + docId));
        pageCache.unbind( &quot;pagehide&quot;, handleEditPageViewHide );
        pageCache.empty();
        pageCache.remove();
    }

    function handleEditView()
    {
        // Watch for bound hide of page to clear from cache.
        var docId = $(&quot;#albumform&quot;).data(&quot;identity&quot;);
        var albumPage = $(document.getElementById(&quot;_show/album-edit/&quot; + docId));
        albumPage.bind( &quot;pagehide&quot;, handleEditPageViewHide );

        storeUneditedDocument();
    }

    function storeUneditedDocument()
    {
        var artist = $(&quot;input#artistField&quot;).val();
        var album = $(&quot;input#titleField&quot;).val();
        var description = $(&quot;textarea#descriptionField&quot;).val();
        editableAlbum = {artist:artist, album:album, description:description};
    }

    return {
        initialize: function() {
           $(&quot;div[data-role='page']&quot;).live( &quot;pageshow&quot;, function() {
                $(&quot;div[data-role='page']&quot;).die( &quot;pageshow&quot; );
                handleEditView();
            });
        }
    };
}();

function handleEditPageReady()
{
    AlbumEditPageController.initialize();
}
$().ready( handleEditPageReady )
</pre>
<p>An <strong>editableAlbum</strong> member is declared and updated upon <em>pageshow</em> in the <em>storeUneditedDocument()</em> method. With the original values stored in this externally-immutable we can ensure that whenever a user decides to cancel the editing of the <strong>album document</strong> we can revert the field values to the original document values. Let&#8217;s hook up the <strong>cancelBackButton</strong> and <strong>cancelButton</strong> elements declared in the <em>albumedit.html</em> template with <em>click</em> event handlers in order to handle the revert action back to the original values.</p>
<p>Save the following modifications to <em>album-edit-page.js</em>:</p>
<p><em>/_attachments/script/album-edit-page.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [7,8,36,37,38,39,40,41,42,43,44,45,46,50,51,52,53,54,55]; title: ;" title="">
var AlbumEditPageController = function() {

    var editableAlbum;

    function handleEditPageViewHide()
    {
        $(&quot;#cancelButton&quot;).die( &quot;click&quot;, handleCancelEdit );
        $(&quot;#cancelBackButton&quot;).die( &quot;click&quot; );
        editableAlbum = null;

        var docId = $(&quot;#albumform&quot;).data(&quot;identity&quot;);
        var pageCache =  $(document.getElementById(&quot;_show/album-edit/&quot; + docId));
        pageCache.unbind( &quot;pagehide&quot;, handleEditPageViewHide );
        pageCache.empty();
        pageCache.remove();
    }

    function handleEditView()
    {
        // Watch for bound hide of page to clear from cache.
        var docId = $(&quot;#albumform&quot;).data(&quot;identity&quot;);
        var albumPage = $(document.getElementById(&quot;_show/album-edit/&quot; + docId));
        albumPage.bind( &quot;pagehide&quot;, handleEditPageViewHide );

        storeUneditedDocument();
    }

    function storeUneditedDocument()
    {
        var artist = $(&quot;input#artistField&quot;).val();
        var album = $(&quot;input#titleField&quot;).val();
        var description = $(&quot;textarea#descriptionField&quot;).val();
        editableAlbum = {artist:artist, album:album, description:description};
    }

    function revertEdits()
    {
        $(&quot;input#artistField&quot;).val( editableAlbum.artist );
        $(&quot;input#titleField&quot;).val( editableAlbum.album );
        $(&quot;textarea#descriptionField&quot;).val( editableAlbum.description );
    }

    function handleCancelEdit()
    {
        revertEdits();
    }

    return {
        initialize: function() {
            $(&quot;#cancelButton&quot;).live( &quot;click&quot;, handleCancelEdit );
            $(&quot;#cancelBackButton&quot;).live( &quot;click&quot;, function( event ) {
                event.preventDefault();
                handleCancelEdit();
                return false;
            });
            $(&quot;div[data-role='page']&quot;).live( &quot;pageshow&quot;, function() {
                $(&quot;div[data-role='page']&quot;).die( &quot;pageshow&quot; );
                handleEditView();
            });
        }
    };
}();

function handleEditPageReady()
{
    AlbumEditPageController.initialize();
}
$().ready( handleEditPageReady )
</pre>
<p>In this snippet, we have wired the two cancelable button elements up to invoke the <em>handleCancelEdit()</em> method upon a click event. All <em>revertEdits()</em> does is reset the field values based on the stored values in <strong>editableAlbum</strong>. We also take care to kill those event listeners when the page is hidden. Now that we have one requirement fulfilled (cancel-ability) for the <em>album edit</em> page, let&#8217;s move on to original intent of the page &#8211; submitting document changes.</p>
<h3>Submit</h3>
<p>To submit changes to the target album document form the album edit page we will use the database API provided in the<em> jquery.couchdb</em> library plugin. That library is automatically loaded from the <strong>loader</strong> script created by <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> if remember back to the first post where we accessed the list of available <strong>album documents</strong> from the <strong>albums</strong> database in our <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance. We resolved the <strong>$db</strong> member in the <em>index.html</em> to the <strong>albums</strong> database when the page is loaded. When submitting from the <em>album edit</em> page, we will just use that instance to load, modify and save the target document back to the database.</p>
<p>Make the following modifications to <em>album-edit-page.js</em> and save:</p>
<p><em>/_attachments/script/album-edit-page.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [9,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,76,77,78,79,80,81,82,83,84,85,86,87,88,89]; title: ;" title="">
var AlbumEditPageController = function() {

    var editableAlbum;

    function handleEditPageViewHide()
    {
        $(&quot;#cancelButton&quot;).die( &quot;click&quot;, handleCancelEdit );
        $(&quot;#cancelBackButton&quot;).die( &quot;click&quot; );
        $(&quot;#submitButton&quot;).die( &quot;click&quot; );
        editableAlbum = null;

        var docId = $(&quot;#albumform&quot;).data(&quot;identity&quot;);
        var pageCache =  $(document.getElementById(&quot;_show/album-edit/&quot; + docId));
        pageCache.unbind( &quot;pagehide&quot;, handleEditPageViewHide );
        pageCache.empty();
        pageCache.remove();
    }

    function handleEditView()
    {
        // Watch for bound hide of page to clear from cache.
        var docId = $(&quot;#albumform&quot;).data(&quot;identity&quot;);
        var albumPage = $(document.getElementById(&quot;_show/album-edit/&quot; + docId));
        albumPage.bind( &quot;pagehide&quot;, handleEditPageViewHide );

        storeUneditedDocument();
    }

    function storeUneditedDocument()
    {
        var artist = $(&quot;input#artistField&quot;).val();
        var album = $(&quot;input#titleField&quot;).val();
        var description = $(&quot;textarea#descriptionField&quot;).val();
        editableAlbum = {artist:artist, album:album, description:description};
    }

    function saveDocument( document )
    {
        $db.saveDoc( document, {
            success: function( response )  {
                updateEditableAlbum( document );
            },
            error: function() {
                alert( &quot;Cannot save document: &quot; + document._id );
            }
        });
    }

    function updateEditableAlbum( document )
    {
        editableAlbum.artist = document.artist;
        editableAlbum.album = document.album;
        editableAlbum.description = document.description;
    }

    function revertEdits()
    {
        $(&quot;input#artistField&quot;).val( editableAlbum.artist );
        $(&quot;input#titleField&quot;).val( editableAlbum.album );
        $(&quot;textarea#descriptionField&quot;).val( editableAlbum.description );
    }

    function handleCancelEdit()
    {
        revertEdits();
    }

    return {
        initialize: function() {
            $(&quot;#cancelButton&quot;).live( &quot;click&quot;, handleCancelEdit );
            $(&quot;#cancelBackButton&quot;).live( &quot;click&quot;, function( event ) {
                event.preventDefault();
                handleCancelEdit();
                return false;
            });
            $(&quot;#submitButton&quot;).live( &quot;click&quot;, function( event ) {
                var docId = $(&quot;#albumform&quot;).data(&quot;identity&quot;);
                $db.openDoc( docId, {
                    success: function( document ) {
                        document.artist = $(&quot;input#artistField&quot;).val();
                        document.album = $(&quot;input#titleField&quot;).val();
                        document.description = $(&quot;textarea#descriptionField&quot;).val();
                        saveDocument( document );
                    },
                    error: function() {
                        alert( &quot;Cannot open document: &quot; + docId );
                    }
                });
            });
            $(&quot;div[data-role='page']&quot;).live( &quot;pageshow&quot;, function() {
                $(&quot;div[data-role='page']&quot;).die( &quot;pageshow&quot; );
                handleEditView();
            });
        }
    };
}();

function handleEditPageReady()
{
    AlbumEditPageController.initialize();
}
$().ready( handleEditPageReady )
</pre>
<p>A click event handler is assigned to the <strong>submitButton</strong> element, from which the document is loaded and assigned the associated field values. Upon update to the new values, <strong>$db</strong>.<em>saveDoc()</em> is invoked with a <strong>success</strong> handler that updates the privately held <strong>editableAlbum</strong> object. This ensures that the values are properly restored back to any saved changes if the user decides to cancel at any time after the successful save.<br />
Almost there. We will just finish off our controller by navigating the user to the <em>album view</em> page upon <strong>Cancel</strong> or <strong>Submit</strong>.</p>
<p>The following is the full <em>album-edit-page.js</em> file with the last modifications highlighted. Save the following changes to <em>album-edit-page.js</em>:</p>
<p><em>/_attachments/script/album-edit-page.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [29,30,31,32,47,72,73]; title: ;" title="">
var AlbumEditPageController = function() {

    var editableAlbum;

    function handleEditPageViewHide()
    {
        $(&quot;#cancelButton&quot;).die( &quot;click&quot;, handleCancelEdit );
        $(&quot;#cancelBackButton&quot;).die( &quot;click&quot; );
        $(&quot;#submitButton&quot;).die( &quot;click&quot; );
        editableAlbum = null;

        var docId = $(&quot;#albumform&quot;).data(&quot;identity&quot;);
        var pageCache =  $(document.getElementById(&quot;_show/album-edit/&quot; + docId));
        pageCache.unbind( &quot;pagehide&quot;, handleEditPageViewHide );
        pageCache.empty();
        pageCache.remove();
    }

    function handleEditView()
    {
        // Watch for bound hide of page to clear from cache.
        var docId = $(&quot;#albumform&quot;).data(&quot;identity&quot;);
        var albumPage = $(document.getElementById(&quot;_show/album-edit/&quot; + docId));
        albumPage.bind( &quot;pagehide&quot;, handleEditPageViewHide );

        storeUneditedDocument();
    }

    function navigateToAlbumPage( docId )
    {
        $.mobile.changePage( &quot;_show/album/&quot; + docId, &quot;slide&quot;, true, true );
    }

    function storeUneditedDocument()
    {
        var artist = $(&quot;input#artistField&quot;).val();
        var album = $(&quot;input#titleField&quot;).val();
        var description = $(&quot;textarea#descriptionField&quot;).val();
        editableAlbum = {artist:artist, album:album, description:description};
    }

    function saveDocument( document )
    {
        $db.saveDoc( document, {
            success: function( response )  {
                updateEditableAlbum( document );
                navigateToAlbumPage( document._id );
            },
            error: function() {
                alert( &quot;Cannot save document: &quot; + document._id );
            }
        });
    }

    function updateEditableAlbum( document )
    {
        editableAlbum.artist = document.artist;
        editableAlbum.album = document.album;
        editableAlbum.description = document.description;
    }

    function revertEdits()
    {
        $(&quot;input#artistField&quot;).val( editableAlbum.artist );
        $(&quot;input#titleField&quot;).val( editableAlbum.album );
        $(&quot;textarea#descriptionField&quot;).val( editableAlbum.description );
    }

    function handleCancelEdit()
    {
        revertEdits();
        var docId = $(&quot;#albumform&quot;).data(&quot;identity&quot;);
        navigateToAlbumPage( docId );
    }

    return {
        initialize: function() {
            $(&quot;#cancelButton&quot;).live( &quot;click&quot;, handleCancelEdit );
            $(&quot;#cancelBackButton&quot;).live( &quot;click&quot;, function( event ) {
                event.preventDefault();
                handleCancelEdit();
                return false;
            });
            $(&quot;#submitButton&quot;).live( &quot;click&quot;, function( event ) {
                var docId = $(&quot;#albumform&quot;).data(&quot;identity&quot;);
                $db.openDoc( docId, {
                    success: function( document ) {
                        document.artist = $(&quot;input#artistField&quot;).val();
                        document.album = $(&quot;input#titleField&quot;).val();
                        document.description = $(&quot;textarea#descriptionField&quot;).val();
                        saveDocument( document );
                    },
                    error: function() {
                        alert( &quot;Cannot open document: &quot; + docId );
                    }
                });
            });
            $(&quot;div[data-role='page']&quot;).live( &quot;pageshow&quot;, function() {
                $(&quot;div[data-role='page']&quot;).die( &quot;pageshow&quot; );
                handleEditView();
            });
        }
    };
}();

function handleEditPageReady()
{
    AlbumEditPageController.initialize();
}
$().ready( handleEditPageReady )
</pre>
<p>In <em>navigateToAlbumPage()</em> we use <strong>$.mobile</strong>.<em>changePage()</em> to navigate the user to the external <em>album view</em> page using the <strong>show function</strong> of our <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> application based on the <strong>_id</strong> of the target document that is loaded in the <em>album edit</em> page.</p>
<p>That should be it&#8230; aside from one thing. Although (once we push our changes) we can access the page using the <strong>#_show/album-edit/${id}</strong> location, as the application currently stands, there is no way to access the <em>album edit</em> page from any other page in the application. To remedy that, we will make some modifications to the <em>album.html</em> template and the <em>album-page.js</em> script to navigate the user to the <em>album edit</em> page.</p>
<h2>Accessing the Album Edit Page</h2>
<p>I am going to assume that you have been following along with <a href="http://custardbelly.com/blog/?p=297" target="_blank">previous posts</a> here and that you already have the <em>/templates/album.html</em> and <em>/_attachments/script/album-page.js</em> files. We are going to make modifications to them to include an <strong>edit button</strong> in the <em>album view</em> page and assign a <em>click</em> handler to navigate to the <em>album edit</em> page.</p>
<h3>album.html</h3>
<p>Open up the <em>/templates/album.html</em> file in your favorite text editor and save the following modifications:</p>
<p><em>/templates/album.html</em></p>
<pre class="brush: xml; first-line: 1; highlight: [10]; title: ;" title="">
&lt;div data-role=&quot;page&quot; id=&quot;albumview&quot; data-position=&quot;inline&quot; data-back=&quot;true&quot;&gt;
    &lt;div data-role=&quot;header&quot; id=&quot;albumheader&quot;&gt;
        &lt;h1 class=&quot;albumtitle&quot;&gt;{{title}}&lt;/h1&gt;
        &lt;a href=&quot;#home&quot; data-icon=&quot;grid&quot; class=&quot;ui-btn-right&quot;&gt;Home&lt;/a&gt;
    &lt;/div&gt;
    &lt;div data-role=&quot;content&quot; id=&quot;albumcontent&quot; data-identity=&quot;{{document}}&quot;&gt;
      &lt;h2 class=&quot;artist&quot;&gt;{{artist}}&lt;/h2&gt;
      &lt;p class=&quot;title&quot;&gt;{{title}}&lt;/p&gt;
      &lt;p class=&quot;description&quot;&gt;{{description}}&lt;/p&gt;
      &lt;p id=&quot;editbutton&quot; data-role=&quot;button&quot; data-theme=&quot;a&quot;&gt;Edit&lt;/p&gt;
    &lt;/div&gt;
    &lt;div data-role=&quot;footer&quot; /&gt;
&lt;/div&gt;
{{&gt;scripts}}
</pre>
<p>The only modification to the <em>album.html</em> template e have made is the inclusion of an <strong>Edit</strong> button which is a <strong>p</strong> element attributed with the <strong>data-role</strong> of <em>button</em>. The <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework will handle styling the <strong>Edit</strong> button to have consistency in look-and-feel with the other buttons throughout the application. Now let&#8217;s hook up a <em>click</em> event listener for that button element to take the user to the <em>album edit</em> page.</p>
<h3>album-page.js</h3>
<p>Open up <em>/_attachments/script/album-page.js</em> in your favorite text editor and save the following modifications:</p>
<p><em>/_attachments/script/album-page.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [5,13,14,15,16,17,18,19,20,21,22,26]; title: ;" title="">
var AlbumPageController = function() {

    function handleView()
    {
        $(&quot;#editbutton&quot;).live( &quot;click&quot;, handleEdit );

        // Watch for bound hide of page to clear from cache.
        var docId = $(&quot;#albumcontent&quot;).data(&quot;identity&quot;);
        var albumPage = $(document.getElementById(&quot;_show/album/&quot; + docId));
        albumPage.bind( &quot;pagehide&quot;, handlePageViewHide );
    }

    function handleEdit( event )
    {
        // Prevent default link event.
        event.preventDefault();
        // Access document id from data-identity.
        var docId = $(&quot;#albumcontent&quot;).data(&quot;identity&quot;);
        // Change page.
        $.mobile.changePage( &quot;_show/album-edit/&quot; + docId, &quot;slide&quot;, false, true );
        return false;
    }

    function handlePageViewHide()
    {
        $(&quot;#editbutton&quot;).die( &quot;click&quot;, handleEdit );

        var docId = $(&quot;#albumcontent&quot;).data(&quot;identity&quot;);
        var albumPageCache =  $(document.getElementById(&quot;_show/album/&quot; + docId));
        albumPageCache.unbind( &quot;pagehide&quot;, handlePageViewHide );
        albumPageCache.empty();
        albumPageCache.remove();
    }

    return {
        initialize : function() {
            $(&quot;div[data-role='page']&quot;).live( &quot;pageshow&quot;, function() {
                $(&quot;div[data-role='page']&quot;).die( &quot;pageshow&quot; );
                handleView();
            });
        }
    };
}();

function handlePageViewReady()
{
    AlbumPageController.initialize();
}
$().ready( handlePageViewReady );
</pre>
<p>The <em>handleEdit()</em> handler navigates to the album edit page using the <strong>$.mobile</strong>.<em>changePage()</em> method pointing to the page created by the <strong>show function</strong> using the target document <strong>id</strong> that is used to show the <em>album view</em> page.</p>
<p>Now that we have implemented a way to navigate to the album edit page from the application through the album view page, we can deploy our changes to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance for our <strong>albums</strong> application.</p>
<h2>Deployment</h2>
<p>Our <strong>Albums</strong> application has been modified to allow a user to modify properties of an <strong>album document</strong> from an <em>album edit</em> page. That page can be accessed by clicking an <strong>Edit</strong> button from the <em>album view</em> page accessible from a selection of an album from the list presented on the landing <em>index.html</em>. With these modifications saved, we can now push to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database using the <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> utility. Open a terminal and navigate to the directory where you create your <strong>CouchApp</strong> applications (for me that is <em>/Documents/workspace/custardbelly/couchdb</em> and in there i have a folder named <em>albums</em> which is the <strong>CouchApp</strong> application directory for these examples). Enter the following command to push the changes to the <strong>CouchDB</strong> instance:</p>
<pre class="brush: bash; title: ;" title="">
couchapp push albums http://127.0.0.1:5984/albums
</pre>
<p>If all was successful and you now go to <a href="http://127.0.0.1:5984/albums/_design/albums/index.html" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html</a>, click on an album from the list and select to edit that document. From the <em>album edit</em> page you are able to either cancel any edits or submit the changes to the target <strong>album document</strong>. What a thing of beauty <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  Let&#8217;s take a look at the current state of the application:</p>
<p><em>index.html (aka #home)</em>:<br />
<img src="http://www.custardbelly.com/blog/images/couchapp_six.png" alt="index.html" /></p>
<p><em>album view page</em>:<br />
<img src="http://www.custardbelly.com/blog/images/couchapp_seven.png" alt="album view page" /></p>
<p><em>album edit page</em>:<br />
<img src="http://www.custardbelly.com/blog/images/couchapp_eight.png" alt="album edit page" /></p>
<h2>Conclusion</h2>
<p>This post got a lot longer than I had anticipated&#8230; which just goes to show what a wind-bag i am <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  All joking aside, I think we covered some good ground, especially about saving modifications to a document back to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database. We also covered, again, how to monitor pages so as to remove them from cache and ensure that the user is always presented with the latest document information. We also delved into assigning event listeners to button elements. All good fun&#8230; well, hopefully, it was to you.</p>
<p><em>[Note] This post was written against the following software versions:</em><br />
<strong>CouchDB </strong>– 1.0.1<br />
<strong>CouchApp</strong> – 0.7.2<br />
<strong>jQuery</strong> – 1.4.4<br />
<strong>jQuery Mobile</strong> – 1.0a2<br />
<em>If you have found this post and any piece has moved forward, hopefully the examples are still viable/useful. I will not be updating the examples in this post in parellel with updates to any of the previously mentioned software, unless explicitly noted.</em></p>
<p><strong>Articles in this series:</strong></p>
<ol>
<li><a href="http://custardbelly.com/blog/?p=244" target="_blank">Getting Started</a></li>
<li><a href="http://custardbelly.com/blog/?p=278" target="_blank">Displaying a page detail of a single album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=297" target="_blank">Templates and Mustache</a></li>
<li><a href="http://custardbelly.com/blog/?p=318" target="_blank">Displaying an editable page of an album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=332" target="_blank">Creating and Adding an album document.</a></li>
<li><a href="http://custardbelly.com/blog/?p=344" target="_blank">Deleting an album document</a></li>
<li><a href="http://custardbelly.com/blog/?p=360" target="_blank">Authorization and Validation &#8211; Part 1</a></li>
<li><a href="http://custardbelly.com/blog/?p=394">Authorization and Validation &#8211; Part 2</a></li>
</ol>
<p><a href="http://custardbelly.com/downloads/couchapp/jqm_couchdb_albums.zip">Full source for albums couchapp here.</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/couchdb/" title="View all posts in CouchDB" rel="category tag">CouchDB</a>,  <a href="http://custardbelly.com/blog/category/jquery/" title="View all posts in jquery" rel="category tag">jquery</a>,  <a href="http://custardbelly.com/blog/category/jquery-mobile/" title="View all posts in jquery-mobile" rel="category tag">jquery-mobile</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2011/01/04/jquery-mobile-couchdb-part-4-editing-documents/#comments" rev="post-318"  title="Comment on jQuery Mobile + CouchDB: Part 4 &#8211; Editing Documents">7 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2011-01-04T06:26">January 4, 2011</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-318-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-297" class="post-297 post hentry category-couchdb category-jquery category-jquery-mobile full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2010/12/28/jquery-mobile-couchdb-part-3-templates-and-mustache-js/" title="Permanent link to jQuery Mobile + CouchDB: Part 3 &#8211; Templates and Mustache.js" rel="bookmark" rev="post-297">jQuery Mobile + CouchDB: Part 3 &#8211; Templates and Mustache.js</a></h1>
	
	<div class="entry-content full-content">
		<p>In the <a href="http://custardbelly.com/blog/?p=278" target="_blank">previous post</a>, I covered displaying a document from a <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database  in the context of a <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page. A difference between <strong>local</strong> vs <strong>external</strong> <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> pages was discussed, and it was concluded that external pages was beneficial for the client-side application. In finding this happy medium, I also talked about <em>show functions</em> in <strong>CouchDB</strong> and how they serve up documents upon request.</p>
<p>In this article, I am going to cover another aspect of delivering <strong>HTML</strong> content from <strong>CouchDB</strong> &#8211; <em>templates</em>. While doing so, I will modify the current document views to provide a cleaner solution (imo) for delivering and rendering document-based <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> pages. Hopefully, this will set the basis for creating additional views for the application&#8230;</p>
<h2>Templates</h2>
<p>In the previous post, I covered using <strong>show function</strong>s to deliver <strong>HTML</strong> content as a <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page from a <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance. From the previous <strong>show function</strong> example for the <strong>Albums</strong> application, I basically constructed a string that would be interpreted as <strong>HTML</strong> mark-up using the values from the document. While this is a perfectly valid solution, its probably not the best if we want to reuse parts of that <strong>HTML</strong> or if the mark-up gets a little too unwieldy for string manipulation based on the request. To provide a little sanity as we start making more page documents for the application, we going to start using <strong>templates</strong> to stub out the mark-up of an <strong>HTML</strong> document and fill content dynamically from the <strong>show function</strong>s.</p>
<h3><a href="https://github.com/janl/mustache.js" target="_blank">mustache.js</a></h3>
<p>If you have been following along in the tutorials, you may remember that in the <em>loader.js</em> script there were a few <strong>JavaScript</strong> files being loaded that were not being referenced within the current application. One of those was <em>mustache.js</em>. I didn&#8217;t talk about it at the time and I said we could probably get rid of it for now, but might as well leave it in&#8230; hopefully you left it in. If not, you&#8217;re screwed. Kidding <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<p>I don&#8217;t want to go into a <a href="https://github.com/janl/mustache.js" target="_blank">mustache</a> explanation as there are already some great articles out there &#8211; especially this one from <a href="http://blog.couchone.com/post/622014913/mustache-js" target="_blank">CouchOne</a> &#8211; but I will say that <em>mustache.js</em> is a templating engine for rendering any type of content. For our purposes, we are going to use the <em>to_html</em>() function of <strong>Mustache</strong> to marry our dynamic album document values with an <strong>HTML</strong> template and deliver pages from our respective <strong>show function</strong>s from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database.</p>
<h3>Album Page Template</h3>
<p>Our previous version of <em>album.js</em> from the <em>/show</em> directory of our <strong>Albums</strong> <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> looked like the following:</p>
<p><em>/show/album.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
function(doc, req) {
  var html = &quot;&lt;div data-role=\&quot;page\&quot; id=\&quot;albumview\&quot;&gt;&quot; +
                       &quot;&lt;div data-role=\&quot;header\&quot; id=\&quot;albumheader\&quot;&gt;&quot; +
                           &quot;&lt;h2 class=\&quot;albumtitle\&quot;&gt;&quot; + doc.title + &quot;&lt;\/h2&gt;&quot; +
                       &quot;&lt;\/div&gt;&quot; +
                       &quot;&lt;div data-role=\&quot;content\&quot; id=\&quot;albumcontent\&quot;&gt;&quot; +
                           &quot;&lt;h2 class=\&quot;artist\&quot;&gt;&quot; + doc.artist + &quot;&lt;\/h2&gt;&quot; +
                           &quot;&lt;p class=\&quot;title\&quot;&gt;&quot; + doc.title + &quot;&lt;\/p&gt;&quot; +
                           &quot;&lt;p class=\&quot;description\&quot;&gt;&quot; + doc.description + &quot;&lt;\/p&gt;&quot; +
                       &quot;&lt;\/div&gt;&quot; +
                       &quot;&lt;div data-role=\&quot;footer\&quot; \/&gt;&quot; +
                   &quot;&lt;\/div&gt;&quot;;
  return html;
}
</pre>
<p>That served our purpose at the time, but such string manipulation for each page we are going to serve up makes my eyes bleed <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  As such, we will use <em>mustache.js</em> to populate document values in an <strong>HTML</strong> template. First order of business: Remove that string construct from <em>/shows/album.js</em> and put it into a <strong>template</strong>, replacing the values with <strong>{{mustache}}</strong> directives.</p>
<p>Create a new directory called <em>templates</em> in your <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> directory for the <strong>Albums</strong> application (for me that is at <em>/Documents/workspace/custardbelly/couchdb/albums</em>). Create a new <strong>HTML</strong> document in your favorite text editor and save the following as <em>album.html</em> in the <em>/templates</em> directory:</p>
<p><em>/templates/album.html</em></p>
<pre class="brush: xml; first-line: 1; title: ;" title="">
&lt;div data-role=&quot;page&quot; id=&quot;albumview&quot; data-position=&quot;inline&quot; data-back=&quot;true&quot;&gt;
    &lt;div data-role=&quot;header&quot; id=&quot;albumheader&quot;&gt;
        &lt;h1 class=&quot;albumtitle&quot;&gt;{{title}}&lt;/h1&gt;
        &lt;a href=&quot;#home&quot; data-icon=&quot;grid&quot; class=&quot;ui-btn-right&quot;&gt;Home&lt;/a&gt;
    &lt;/div&gt;
    &lt;div data-role=&quot;content&quot; id=&quot;albumcontent&quot; data-identity=&quot;{{document}}&quot;&gt;
        &lt;h2 class=&quot;artist&quot;&gt;{{artist}}&lt;/h2&gt;
        &lt;p class=&quot;title&quot;&gt;{{title}}&lt;/p&gt;
        &lt;p class=&quot;description&quot;&gt;{{description}}&lt;/p&gt;
    &lt;/div&gt;
    &lt;div data-role=&quot;footer&quot; /&gt;
&lt;/div&gt;
</pre>
<p>Essentially, we have just moved our mark-up from one document to another; the difference being that we are now employing <strong>{{mustache}}</strong>s as placeholders for dynamic content values. You may notice that the names used in the mustaches are just the property names of the document &#8211; similar to the previous <em>albums.js</em> example. In fact there are the property names of the object that will be passed to the <a href="https://github.com/janl/mustache.js" target="_blank">Mustache</a> engine to generate our page.</p>
<p>Some added <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> element content has been added to the new <em>album</em> page document, as well. We added the <strong>data-position</strong> and <strong>data-back</strong> attributes to the <em>page</em> <strong>div</strong> in order to preserve the back button and add a <strong>Home</strong> page button to the header. This will allow us to always be able to get back to the <em>index.html</em> <strong>Home</strong> page from an <em>album page</em>.</p>
<pre class="brush: xml; title: ;" title="">
&lt;a href=&quot;#home&quot; data-icon=&quot;grid&quot; class=&quot;ui-btn-right&quot;&gt;Home&lt;/a&gt;
</pre>
<p>We will need to modify the <em>page</em> <strong>div</strong> in <em>index.html</em> to have an <strong>id</strong> value of &#8220;home&#8221;, but setting that hash as the <strong>href</strong> for the <strong>Home</strong> button in the header of our <em>album page</em> will, essentially, enable that link to direct the user back to the page content of the parenting document -<em>index.html</em>.</p>
<p>In <em>album.html</em> we have also declared a <strong>data-identity</strong> for the content <strong>div</strong> and provided a <em>{{document}}</em> value. This will be the <em>document._id</em> from the <em>album.js</em> <strong>show function</strong> and we will later see how it will be used. Back to our <em>album.js</em> document&#8230;</p>
<h3>Album Page Show Function</h3>
<p>Open up the <em>/show/album.js</em> document in your favorite text editor and make replace the current content with the following:</p>
<p><em>/show/album.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [2,3,4,5,6,7,8,9]; title: ;" title="">
function(doc, req) {
    var Mustache = require(&quot;vendor/couchapp/lib/mustache&quot;);
    var stash = {
        artist: doc.artist,
        title : doc.title,
        description: doc.description,
        document: doc._id
    };
    return Mustache.to_html(this.templates.album, stash);
}
</pre>
<p>As mentioned previously, <a href="http://couchapp.org/page/index" target="_blank">CouchApp</a> includes the <a href="https://github.com/janl/mustache.js" target="_blank">Mustache</a> <strong>JavaScript</strong> file automatically when generating a new <strong>couchapp</strong> application. In this example we first assign a reference to the <strong>Mustache</strong> module through a <em>require()</em> call for the file in the <em>vendor/couchapp/lib</em> directory. A generic <em>stash</em> object is created to assign property values that are dynamically populated into the <em>album.html</em> template (previous snippet) using the <strong>Mustache</strong>:<em>to_html</em> method.</p>
<p>I am not entirely clear on how it is possible to reference files and directories with the <strong>this</strong> keyword in a <strong>show function</strong>, but i can only assume that <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> has generated an object tree based on the file structure from which one can access values. If you do know, please leave a comment. In any event, the template file and the defining object are the first two arguments for <strong>Mustache</strong>:<em>to_html</em>. Upon request for an <em>album</em> document, this will return the <em>album.html</em> page dynamically populated with the values for the document related to the <em>id</em> in the request <strong>URL</strong> (eg. <a href="http://127.0.0.1:5984/albums/_design/albums/index.html#_show/album/db04eb7e5c845ee0aa791ae1ed000fe8" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html#_show<br />
/album/db04eb7e5c845ee0aa791ae1ed000fe8</a>).</p>
<h3>Hiccup</h3>
<p>There may be a slight problem in this solution however&#8230;. Though <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> does request-cacheing based on header <strong>ETag</strong>s on documents, <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> also does cacheing of pages (or rather it accesses &#8216;pages&#8217; already loaded into the <strong>DOM</strong>). So there may be a time that an album has been edited during the application session and <strong>jQuery Mobile</strong> serves up old information as it never went back out the make a <strong>GET</strong> request to <strong>CouchDB</strong>, utilizing this <strong>show function</strong>. We could make a request for the document each time the page is shown in the <strong>DOM</strong> using the <em>jquery.couch</em> library, but that may be unnecessary overhead; not to mention a waste of the templating engine.</p>
<p>Another solution, and one I think is viable and worth consideration, is to remove the page from the <a href="http://jquerymobile.com/" target="_blank">jquery Mobile</a> page cache when this page is hidden in the view (when you navigate to another page). In order to do so, we will need to access the cached page in the <strong>DOM</strong> using <strong>JavaScript</strong>. Instead of adding this <strong>JavaScript</strong> directly in the <strong>HTML</strong> template file, we will use another templating feature available in <a href="https://github.com/janl/mustache.js" target="_blank">Mustache</a> &#8211; <strong>Partials</strong>.</p>
<h2>Partials</h2>
<p><strong>Partials</strong> are, essentially, just a way to include common mark-up or code or what have you into the target <strong>template</strong> page. It&#8217;s important to remember that partials are rendered in first so any <strong>{{mustache}}</strong>s in the partial file will also be filled. For the purposes of our example application, we are just going to include mark-up to load a script. It may be a little overkill at the moment, but I wanted to show the use of partials as they can be very handy.</p>
<p>Open up your favorite text editor and save the following snippet as <em>scripts.html</em> in <em>/templates/partials/album</em>.</p>
<p><em>/templates/partials/album/scripts.html</em></p>
<pre class="brush: xml; first-line: 1; title: ;" title="">
&lt;script src=&quot;../../script/album-page.js&quot;&gt;&lt;/script&gt;
</pre>
<p><em>[<strong>02-06-2010</strong>: Thank you to Steve and Stacy Braxton for leaving a comment noting that the filepath to scripts.html for the album page was incorrectly shown in italics. The correct filepath is now displayed. Thanks!]</em></p>
<p>Real boring stuff and not using the full breath of what <strong>Partials</strong> can do. Basically we are just loading in an associated <strong>JavaScript</strong> file with our page from the <strong>show function</strong>. Great. Now we have to create another file. I know, I know. It may appear convoluted, but in my head it is much cleaner and organized. The script we are about to create, could be included in this <strong>partial</strong> or in the <strong>template</strong>, but i prefer to work with another separate <strong>JavaScript</strong> file whose purpose I know based on its extension &#8211; its got script in it.</p>
<h3>album-page.js</h3>
<p>You may have looked at the path in the <strong>src</strong> attribute value from the <strong>Partial</strong> we just created and noticed that it is a relative path that goes out a couple directories. That is going back to the <em>_attachments</em> directory to access the <em>album-page.js</em> file from the <em>script</em> folder. The <em>_attachments</em> directory also houses the style folder in which we added the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> styles in the first post.</p>
<p>We&#8217;re going to create an add the <em>album-page.js</em> file to the <em>/_attachments/script</em> directory and it will provide the ability to access and clear the page from the page cache of <strong>jQuery Mobile</strong> so as to always serve up a the page from <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> (based on its own cacheing mechanism) using the show function. Open up your favorite text editor and save the following snippet as <em>album-page.js</em> in <em>/_attachments/script</em>:</p>
<p><em>/_attachments/script/album-page.js</em></p>
<pre class="brush: jscript; first-line: 1; title: ;" title="">
var AlbumPageController = function() {

    function handleView()
    {
        // Watch for bound hide of page to clear from cache.
        var docId = $(&quot;#albumcontent&quot;).data(&quot;identity&quot;);
        var albumPage = $(document.getElementById(&quot;_show/album/&quot; + docId));
        albumPage.bind( &quot;pagehide&quot;, handlePageViewHide );
    }

    function handlePageViewHide()
    {
        var docId = $(&quot;#albumcontent&quot;).data(&quot;identity&quot;);
        var albumPageCache =  $(document.getElementById(&quot;_show/album/&quot; + docId));
        albumPageCache.unbind( &quot;pagehide&quot;, handlePageViewHide );
        albumPageCache.empty();
        albumPageCache.remove();
    }

    return {
        initialize : function() {
            $(&quot;div[data-role='page']&quot;).live( &quot;pageshow&quot;, function() {
                $(&quot;div[data-role='page']&quot;).die( &quot;pageshow&quot; );
                handleView();
            });
        }
    };
}();

function handlePageViewReady()
{
    AlbumPageController.initialize();
}
$().ready( handlePageViewReady );
</pre>
<p>In essence, we are just creating a view controller for our <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page served up from the <strong>show function</strong>. Once the page is recognized as part of the <strong>DOM</strong>, the controller is initialized and an event handler is assigned to the <em>pageshow</em> event for the current page &#8211; the <em>album.html</em> served up. We access the page in the <strong>DOM</strong> using the standard <strong>data-role</strong> attribute value for a <strong>jQuery Mobile</strong> page. I stumbled upon this solution from these two forum posts &#8211; <a href="http://forum.jquery.com/topic/force-page-update" target="_blank">http://forum.jquery.com/topic/force-page-update</a> and <a href="http://forum.jquery.com/topic/binding-events-to-buttons-in-a-dialog" target="_blank">http://forum.jquery.com/topic/binding-events-to-buttons-in-a-dialog</a> &#8211; and seem to be the current agreed upon solution for accessing a loading <strong>jQuery Mobile</strong> page. </p>
<p>Now, it should be noted that setting that handler will actually set a handler on all <strong>div</strong>s with the <strong>data-role</strong> attributed as &#8220;page&#8221;. But since we are only concerned with the <em>pageshow</em> event, we know that the current target is the <em>album page</em>. Once that event is captured, we remove the handler and assign a <em>pagehide</em> event handler to clear the page from the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> (ie. <strong>DOM</strong>) cache and remove the elements from the <strong>DOM</strong>.</p>
<p>Since the <em>album page</em> is an external page (defined in the script in <em>index.html</em> when building the list items), its registered in the <strong>DOM</strong> and accessed using the <em>_show</em> path based on the document ID. So, when the page is fully loaded we access that page recognized in the <strong>DOM</strong> using the <em>getElementById</em>() method:</p>
<pre class="brush: jscript; first-line: 6; title: ;" title="">
var docId = $(&quot;#albumcontent&quot;).data(&quot;identity&quot;);
var albumPage = $(document.getElementById(&quot;_show/album/&quot; + docId));
</pre>
<p>Accessing the page as such, we can empty all its elements and remove it once the page has been fully hidden from the view in the page transition of jQuery Mobile:</p>
<pre class="brush: jscript; first-line: 13; title: ;" title="">
 var docId = $(&quot;#albumcontent&quot;).data(&quot;identity&quot;);
 var albumPageCache =  $(document.getElementById(&quot;_show/album/&quot; + docId));
 albumPageCache.unbind( &quot;pagehide&quot;, handlePageViewHide );
 albumPageCache.empty();
 albumPageCache.remove();
</pre>
<p>That essentially will make a request each time to <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> for the album document page and not rely on the cacheing of pages within <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a>. This will also open up the ability to assign and manage handlers for other events, such a requesting pages for editing a document&#8230; but we&#8217;ll broach that subject in another post <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_wink.gif' alt=';)' class='wp-smiley' />  For now, let&#8217;s go back and update our <em>album.js</em> and <em>album.html</em> documents to include the <strong>partial</strong>.</p>
<p><em>[<strong>01-28-2010</strong>: Thank you to IR for leaving a comment alerting me to the fact that i totally missed out on updating the neccessary files after creating the partial]</em></p>
<h3>Modifying album.js and album.html</h3>
<p>Open up <em>/shows/album.js</em> in your favorite text editor and make the following modification to pass the <strong>partial</strong> directory in <strong>Mustache</strong>.<em>to_html</em>():</p>
<p><em>/shows/album.js</em></p>
<pre class="brush: jscript; first-line: 1; highlight: [9]; title: ;" title="">
function(doc, req) {
    var Mustache = require(&quot;vendor/couchapp/lib/mustache&quot;);
    var stash = {
        artist: doc.artist,
        title : doc.title,
        description: doc.description,
        document: doc._id
    };
    return Mustache.to_html(this.templates.album, stash, this.templates.partials.album);
}
</pre>
<p>That last argument in <em>to_html</em>() will allow you to stub out the documents included in the <em>/album</em> folder of the <strong>partials</strong> directory in the <em>album.html</em> template. We&#8217;ll need to update that document as well for our <em>scripts</em> <strong>partial</strong> to be included.</p>
<p>Open up <em>/templates/album.html</em> and make the following modification:</p>
<p><em>/templates/album.html</em></p>
<pre class="brush: xml; first-line: 1; highlight: [13]; title: ;" title="">
&lt;div data-role=&quot;page&quot; id=&quot;albumview&quot; data-position=&quot;inline&quot; data-back=&quot;true&quot;&gt;
    &lt;div data-role=&quot;header&quot; id=&quot;albumheader&quot;&gt;
        &lt;h1 class=&quot;albumtitle&quot;&gt;{{title}}&lt;/h1&gt;
        &lt;a href=&quot;#home&quot; data-icon=&quot;grid&quot; class=&quot;ui-btn-right&quot;&gt;Home&lt;/a&gt;
    &lt;/div&gt;
    &lt;div data-role=&quot;content&quot; id=&quot;albumcontent&quot; data-identity=&quot;{{document}}&quot;&gt;
        &lt;h2 class=&quot;artist&quot;&gt;{{artist}}&lt;/h2&gt;
        &lt;p class=&quot;title&quot;&gt;{{title}}&lt;/p&gt;
        &lt;p class=&quot;description&quot;&gt;{{description}}&lt;/p&gt;
    &lt;/div&gt;
    &lt;div data-role=&quot;footer&quot; /&gt;
&lt;/div&gt;
{{&gt;scripts}}
</pre>
<p>A slight modification to the syntax on how you would include object property values, the <strong>partial</strong> is included by appending the name of the <strong>partial</strong> document to include with a <em>greater than</em> character. That will essentially write the content of the document inline in the <strong>template</strong> where it is declared.</p>
<p>Now we just need to make a small modification to the <em>index.html</em> file and then deploy our modified application to the <strong>CouchDB</strong> instance so we can view our wonderful changes (which won&#8217;t look like we changed a thing).</p>
<h3>Modifying index.html</h3>
<p>We added a <strong>Home</strong> button to the header bar of the <em>album page</em> so we could always navigate back to the <strong>Home</strong> page. Currently the <em>album page</em> is accessible from the album list on the <strong>Home</strong> page, but who knows, maybe that won&#8217;t always be the case in the future. In any event, we made the change and assigned the <strong>href</strong> value for the <strong>Home</strong> page button with the <em>#home</em> anchor. Currently that will go nowhere. We&#8217;ll set that as the div id on the main <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page in <em>index.html</em>.</p>
<p>Open up the <em>/_attachments/index.html</em> file in your favorite text editor and make the following modifications the #home <strong>page div</strong>:</p>
<p><em>/_attachments/index.html</em></p>
<pre class="brush: xml; first-line: 9; highlight: [9]; title: ;" title="">
&lt;div id=&quot;home&quot; data-role=&quot;page&quot;&gt;
    &lt;div data-role=&quot;header&quot;&gt;&lt;h1&gt;Albums&lt;/h1&gt;&lt;/div&gt;
    &lt;div data-role=&quot;content&quot;&gt;
        &lt;ul id=&quot;albums&quot; data-role=&quot;listview&quot; data-theme=&quot;c&quot; data-dividertheme=&quot;b&quot;&gt;&lt;/ul&gt;
    &lt;/div&gt;
    &lt;div data-role=&quot;footer&quot; class=&quot;ui-bar&quot;&gt;&lt;h4&gt;a list of albums&lt;/h4&gt;&lt;/div&gt;
&lt;/div&gt;
</pre>
<p><em>[<strong>02-05-2010</strong>: Thank you to Otetz for leaving a comment about the missing call to refresh the list prior to shoe on the index.html file]</em><br />
With <em>index.html</em> still open in your favorite text editor, add the following line to the <em>handleDocumentReady</em>() method in the inline <strong>JavaScript</strong>:</p>
<pre class="brush: plain; first-line: 22; highlight: [24]; title: ;" title="">
function handleDocumentReady()
{
    $(&quot;#home&quot;).bind( &quot;pagebeforeshow&quot;, refreshAlbums );
    refreshAlbums();
</pre>
<p>Save that, and now we can add a <strong>Home</strong> button to any page and will always be directed back to that <strong>div</strong> with the list of albums from our <strong>CouchDB</strong> database. Cool. Time to deploy.</p>
<h2>Deployment</h2>
<p>We modified our show function to use templates and created a script to empty the page and its elements from the <strong>DOM</strong> upon hide within the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> context and are assured that each access of an album document will contain the latest changes. With these modifications saved, we can now push to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database using the <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> utility. Open a terminal and navigate to the directory where you create your <strong>CouchApp</strong> applications (for me that is <em>/Documents/workspace/custardbelly/couchdb</em> and in there i have a folder named <em>albums</em> which is the <strong>CouchApp</strong> application directory for these examples). Enter the following command to push the changes to the <strong>CouchDB</strong> instance:</p>
<pre class="brush: bash; title: ;" title="">
couchapp push albums http://127.0.0.1:5984/albums
</pre>
<p>If all was successful and you now go to <a href="http://127.0.0.1:5984/albums/_design/albums/index.html" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html</a>, we&#8217;ll still have our old familiar list and still access each album by clicking on a list item. Basically it performs exactly as it had before, but we cleaned up a little on our end&#8230; a benefit to us as the developer and a benefit to the user though not visually noticeable&#8230; it still looks rather ugly <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<h2>Conclusion</h2>
<p>We delved a little deeper into how to serve up pages from <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> using <strong>templates</strong> and <strong>partials</strong> (thanks to <a href="https://github.com/janl/mustache.js" target="_blank">Mustache</a>!) and also touched on accessing pages from <strong>DOM</strong> cache in the context of <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework. All nice stuff, but nothing really has changed in how the application worked for the end user. We ensured that <em>album page</em>s always had the correct and latest content, but we haven&#8217;t opened up the possibility to edit the document and commit changes. That&#8217;s to come <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  Just wanted to lay the groundwork for easing into adding more pages to our application. Hopefully you found some of this useful.</p>
<p><em>[Note] This post was written against the following software versions:</em><br />
<strong>CouchDB </strong>– 1.0.1<br />
<strong>CouchApp</strong> – 0.7.2<br />
<strong>jQuery</strong> – 1.4.4<br />
<strong>jQuery Mobile</strong> – 1.0a2<br />
<em>If you have found this post and any piece has moved forward, hopefully the examples are still viable/useful. I will not be updating the examples in this post in parellel with updates to any of the previously mentioned software, unless explicitly noted.</em></p>
<p><strong>Articles in this series:</strong></p>
<ol>
<li><a href="http://custardbelly.com/blog/?p=244" target="_blank">Getting Started</a></li>
<li><a href="http://custardbelly.com/blog/?p=278" target="_blank">Displaying a page detail of a single album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=297" target="_blank">Templates and Mustache</a></li>
<li><a href="http://custardbelly.com/blog/?p=318" target="_blank">Displaying an editable page of an album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=332" target="_blank">Creating and Adding an album document.</a></li>
<li><a href="http://custardbelly.com/blog/?p=344" target="_blank">Deleting an album document</a></li>
<li><a href="http://custardbelly.com/blog/?p=360" target="_blank">Authorization and Validation &#8211; Part 1</a></li>
<li><a href="http://custardbelly.com/blog/?p=394">Authorization and Validation &#8211; Part 2</a></li>
</ol>
<p><a href="http://custardbelly.com/downloads/couchapp/jqm_couchdb_albums.zip">Full source for albums couchapp here.</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/couchdb/" title="View all posts in CouchDB" rel="category tag">CouchDB</a>,  <a href="http://custardbelly.com/blog/category/jquery/" title="View all posts in jquery" rel="category tag">jquery</a>,  <a href="http://custardbelly.com/blog/category/jquery-mobile/" title="View all posts in jquery-mobile" rel="category tag">jquery-mobile</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2010/12/28/jquery-mobile-couchdb-part-3-templates-and-mustache-js/#comments" rev="post-297"  title="Comment on jQuery Mobile + CouchDB: Part 3 &#8211; Templates and Mustache.js">19 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2010-12-28T10:21">December 28, 2010</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-297-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-278" class="post-278 post hentry category-couchdb category-jquery category-jquery-mobile full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2010/12/13/jquery-mobile-couchdb-part-2-document-view/" title="Permanent link to jQuery Mobile + CouchDB: Part 2 &#8211; Document View" rel="bookmark" rev="post-278">jQuery Mobile + CouchDB: Part 2 &#8211; Document View</a></h1>
	
	<div class="entry-content full-content">
		<p>In the <a href="http://custardbelly.com/blog/?p=244" target="_blank">previous post</a> for this series, I covered getting up and running with <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> as a client-side application for a <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database. Along with examples for the <strong>DHTML</strong> documents, I also covered/talked about some great tools that help along with the workflow of creating a client-side application and working with a <strong>CouchDB</strong> instance. I am going to continue using those tools &#8211; mainly <a href="http://couchapp.org/page/index" target="_blank">CouchApp</a> &#8211; and cover the differences between local and external jQuery Mobile pages and how to show a single document from the albums list. If you have not already, I recommend checking out the first part in this series: <a href="http://custardbelly.com/blog/?p=244">jQuery Mobile + CouchDB: Part 1 &#8211; Getting Started</a>. Some tools and directory structures are discussed in that post that will not be explained in this post.</p>
<h2>Introduction</h2>
<p>Looking at the current state of the client-side application created for communicating with a <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance, the landing page loads all the documents from a target database and displays them in a <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> list.</p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_three.png" /></p>
<p>The database for the application holds <em>album</em> documents and a simple view was created that would return every document in the database. Currently the <strong>URL</strong> for viewing that list of documents from the albums view is <a href="http://127.0.0.1:5984/albums/_design/albums/index.html" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html</a>.</p>
<p>Now i can peruse the list just fine, but what if the list items do not show all the fields pertaining to a document? (<em>* they do now, but that is the beauty of CouchDB&#8230; the album document schema can change without having me curl up and start crying under my desk!</em>) Good question, me. The application should direct the user to a detail page which shows a single document upon selection from an item in the list. Nice answer, you.</p>
<p>In this post, I will be covering how to create and navigate to a detail page for a single document from the list for our <strong>jQuery Mobile</strong> + <strong>CouchDB</strong> application. I&#8217;ll hope to address the benefits of local and external pages in the <strong>jQuery Mobile</strong> framework and how to go about displaying pages using the show functions available in the design for a <strong>CouchDB</strong> database.</p>
<h2>Decisions, Decisions</h2>
<p>A <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> application is comprised of pages, loosely discussed in the previous post. The framework allows for a developer to declare the content of each page inline in the same document (<em>local</em>, <em>internally linked</em>) or point to another <strong>HTML</strong> document (<em>external</em>) by providing a link as the content of a page. For some quick examples:</p>
<p><strong>Local:</strong></p>
<p><em>index.html</em></p>
<pre class="brush: xml; title: ;" title="">
...
&lt;body&gt;
    &lt;div id=&quot;home&quot; data-role=&quot;page&quot;&gt;
        &lt;div data-role=&quot;header&quot;&gt;Home&lt;/div&gt;
        &lt;div data-role=&quot;content&quot;&gt;
            &lt;p&gt;Hello World!&lt;/p&gt;
            &lt;p&gt;&lt;a href=&quot;#signin&quot;&gt;Sign in?&lt;/a&gt;
        &lt;/div&gt;
        &lt;div data-role=&quot;footer&quot;&gt;welcome&lt;/div&gt;
    &lt;/div&gt;
    &lt;div id=&quot;signin&quot; data-role=&quot;page&quot;&gt;
        &lt;div data-role=&quot;header&quot;&gt;Sign up&lt;/div&gt;
        &lt;div data-role=&quot;content&quot;&gt;
            &lt;p&gt;&lt;a href=&quot;#home&quot;&gt;Nevermind&lt;/a&gt;&lt;/p&gt;
        &lt;/div&gt;
        &lt;div data-role=&quot;footer&quot;&gt;come in&lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
...
</pre>
<p>In this example, two pages are declared (<em>home</em> and <em>signin</em>), and each have a link in their content that points to the other. By setting the <strong>href</strong> to the value of the <em>id</em> attribute of a <em>div</em> element with a <strong>data-role</strong> of <em>page</em>, preceded by a hash (#), the framework knows to display the content of that page upon request &#8211; updating the location and history as well.</p>
<p><strong>External:</strong></p>
<p><em>index.html</em></p>
<pre class="brush: xml; title: ;" title="">
...
&lt;body&gt;
    &lt;div id=&quot;home&quot; data-role=&quot;page&quot;&gt;
        &lt;div data-role=&quot;header&quot;&gt;Home&lt;/div&gt;
        &lt;div data-role=&quot;content&quot;&gt;
            &lt;p&gt;Hello World!&lt;/p&gt;
            &lt;p&gt;&lt;a href=&quot;pages/signin.html&quot;&gt;Sign in?&lt;/a&gt;
        &lt;/div&gt;
        &lt;div data-role=&quot;footer&quot;&gt;welcome&lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
...
</pre>
<p><em>/pages/signin.html</em></p>
<pre class="brush: xml; title: ;" title="">
&lt;body&gt;
    &lt;div id=&quot;signin&quot; data-role=&quot;page&quot;&gt;
        &lt;div data-role=&quot;header&quot;&gt;Sign up&lt;/div&gt;
        &lt;div data-role=&quot;content&quot;&gt;
            &lt;p&gt;&lt;a href=&quot;../index.html&quot;&gt;Nevermind&lt;/a&gt;&lt;/p&gt;
        &lt;/div&gt;
        &lt;div data-role=&quot;footer&quot;&gt;come in&lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
</pre>
<p><em>[* NOTE :: If you try to develop an application using externally linked pages on your local disk, you will get an error that looks somewhat like the following:</em></p>
<pre class="brush: bash; title: ;" title="">
XMLHttpRequest cannot load file:///Users/{user}/{location}/index.html. Origin null is not allowed by Access-Control-Allow-Origin.
</pre>
<p><em>The reason is that file:// requests produce a null Origin. Someone more familiar with <a href="http://jquerymobile.com/" target="_blank">jquery Mobile</a> could hopefully give a fuller explanation, but a null Origin throws an error on transitioning pages. When developing i deploy the client to my localhost for testing.*]</em></p>
<p>In this example, the landing page has a link that points to an external <strong>HTML</strong> document (<em>signin.html</em>). With a <em>div</em> element attributed as a page in the external <strong>HTML</strong> document, the location is updated to <em>/index.html#pages/signup.html</em>.</p>
<p>Both approaches have their advantages and disadvantages. The biggest advantage for internal pages is transition speed, while the biggest disadvantage for internal pages is readability; and those are switched for external pages. At least those are what i perceive as being the selling points for <strong>internal vs external</strong>, aside from the <strong>URL</strong>s&#8230;</p>
<p>I would choose external most of the time, mainly because it adds the ability to view a page without being in the flow of a whole page set in a single document. Sure, the <strong>URL</strong> is way uglier (ie <em>index.html#pages/signup.html</em> as opposed to <em>index.html#signup</em>) but hopefully i could then bug someone smarter than me to pretty up the <strong>URL</strong>s with some rewrites.</p>
<p>So, in conclusion, I lean toward external pages&#8230; but i will offer up both solutions so you can see how each would work.</p>
<h2>Local Album Page View</h2>
<p>First things first, fire up your favorite text editor and open the <em>/_attachments/index.html</em> page from your <a href="http://couchapp.org/page/index" target="_blank">CouchApp</a> directory for the albums application. We are going to add another page <em>div</em> to the document and display the album detail locally:</p>
<pre class="brush: xml; first-line: 1; highlight: [16,17,18,19,20,21,22]; title: ;" title="">
&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;My Albums&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;style/main.css&quot; type=&quot;text/css&quot;&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;style/jquery.mobile-1.0a2.css&quot; type=&quot;text/css&quot;/&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div data-role=&quot;page&quot;&gt;
        &lt;div data-role=&quot;header&quot;&gt;&lt;h2&gt;Albums&lt;/h2&gt;&lt;/div&gt;
        &lt;div data-role=&quot;content&quot;&gt;
            &lt;ul id=&quot;albums&quot; data-role=&quot;listview&quot; data-theme=&quot;c&quot; data-dividertheme=&quot;b&quot; /&gt;
        &lt;/div&gt;
        &lt;div data-role=&quot;footer&quot;&gt;Footer&lt;/div&gt;
    &lt;/div&gt;
    &lt;div data-role=&quot;page&quot; id=&quot;albumview&quot;&gt;
        &lt;div data-role=&quot;header&quot; id=&quot;albumheader&quot;&gt;
            &lt;h2 class=&quot;albumtitle&quot;&gt;&lt;/h2&gt;
        &lt;/div&gt;
        &lt;div data-role=&quot;content&quot; id=&quot;albumcontent&quot;&gt;&lt;/div&gt;
        &lt;div data-role=&quot;footer&quot; /&gt;
    &lt;/div&gt;
  &lt;/body&gt;
  &lt;script src=&quot;vendor/couchapp/loader.js&quot;&gt;&lt;/script&gt;
  &lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;
      // forget about this for now.
  &lt;/script&gt;
&lt;/html&gt;
</pre>
<p>In this example, we have added another <em>page</em> and given it the <strong>id</strong> attribute value of &#8220;<em>albumview</em>&#8220;. When an item from the albums list is clicked, we&#8217;ll notify the framework to navigate to that page and display the corresponding content. The <strong>JavaScript</strong> was removed for this example just to clear away the clutter from what the intention was in making a new page. Just so we know we are working with the same content, here is the full updated document with inline script:</p>
<pre class="brush: xml; title: ;" title="">
&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;My Albums&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;style/main.css&quot; type=&quot;text/css&quot;&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;style/jquery.mobile-1.0a2.css&quot; type=&quot;text/css&quot;/&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div data-role=&quot;page&quot;&gt;
        &lt;div data-role=&quot;header&quot;&gt;&lt;h2&gt;Albums&lt;/h2&gt;&lt;/div&gt;
        &lt;div data-role=&quot;content&quot;&gt;
            &lt;ul id=&quot;albums&quot; data-role=&quot;listview&quot; data-theme=&quot;c&quot; data-dividertheme=&quot;b&quot; /&gt;
        &lt;/div&gt;
        &lt;div data-role=&quot;footer&quot;&gt;Footer&lt;/div&gt;
    &lt;/div&gt;
    &lt;div data-role=&quot;page&quot; id=&quot;albumview&quot;&gt;
        &lt;div data-role=&quot;header&quot; id=&quot;albumheader&quot;&gt;
            &lt;h2 class=&quot;albumtitle&quot;&gt;&lt;/h2&gt;
        &lt;/div&gt;
        &lt;div data-role=&quot;content&quot; id=&quot;albumcontent&quot;&gt;&lt;/div&gt;
        &lt;div data-role=&quot;footer&quot; /&gt;
    &lt;/div&gt;
  &lt;/body&gt;
  &lt;script src=&quot;vendor/couchapp/loader.js&quot;&gt;&lt;/script&gt;
  &lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;

      $db = $.couch.db(&quot;albums&quot;);

      function handleDocumentReady()
      {
          refreshAlbums();
      }

      function refreshAlbums()
      {
          $(&quot;#albums&quot;).empty();
          $db.view(&quot;albums/albums&quot;,
            { success: function( data ) {
                    var i;
                    var album;
                    var artist;
                    var title;
                    var description;
                    var listItem;
                    for( i in data.rows )
                    {
                        album = data.rows[i].value;
                        artist = album.artist;
                        title = album.title;
                        description = album.description;
                        listItem = &quot;&lt;li&gt;&quot; +
                                    &quot;&lt;h2 class=\&quot;artist\&quot;&gt;gt;&quot; + artist + &quot;&lt;\/h2&gt;&quot; +
                                    &quot;&lt;p class=\&quot;title\&quot;&gt;gt;&quot; + title + &quot;&lt;\/p&gt;&quot; +
                                    &quot;&lt;p class=\&quot;description\&quot;&gt;gt;&quot; + description + &quot;&lt;\/p&gt;&quot;;
                        $(&quot;#albums&quot;).append( listItem );
                    }
                    $(&quot;#albums&quot;).listview( &quot;refresh&quot; );
                }
            });
      }

      $(document).ready( handleDocumentReady );

  &lt;/script&gt;
&lt;/html&gt;
</pre>
<p>As it stands, the <strong>HTML</strong> that is constructed and appended as a list item to the <em>albums</em> list does not have any clickable navigation. As shown in previous examples, to add navigation to internal pages, we&#8217;ll add a link with an <strong>href</strong> to a page preceded by a hash (#) to each <em>listItem</em> <strong>HTML</strong> snippet.</p>
<h3>ListItem HTML</h3>
<p>Now we could just update the <strong>HTML</strong> string as such:</p>
<pre class="brush: jscript; title: ;" title="">
listItem = &quot;&lt;li&gt;&quot; +
                 &quot;&lt;a href=\&quot;#albumview\&quot;&gt;&lt;h2 class=\&quot;artist\&quot;&gt;gt;&quot; + artist + &quot;&lt;\/h2&gt;&lt;\/a&gt;&quot; +
                 &quot;&lt;p class=\&quot;title\&quot;&gt;gt;&quot; + title + &quot;&lt;\/p&gt;&quot; +
                 &quot;&lt;p class=\&quot;description\&quot;&gt;gt;&quot; + description + &quot;&lt;\/p&gt;&quot;;
</pre>
<p>With the link wrapping the artist <em>header</em>, upon user-click the document would navigate to the <em>albumview</em> page. The problem with this solution is that the <em>albumview</em> is not populated with any content. We don&#8217;t know which list item was clicked or any other relevant information related to the target document. To access that, we&#8217;ll switch up how the <strong>HTML</strong> snippet is created and assign a <em>click</em> handler to each link in order to update a variable accessible between pages. </p>
<p>Make the following modifications the the <strong>HTML</strong> snippet within the for&#8230; loop of <em>refreshAlbums()</em>:</p>
<pre class="brush: jscript; title: ;" title="">
for( i in data.rows )
{
    album = data.rows[i].value;
    artist = album.artist;
    title = album.title;
    description = album.description;
    listItem = $(&quot;&lt;li/&gt;&quot;, {
                        class: &quot;album&quot;
                    });
    header = &quot;&lt;h2 class=\&quot;artist\&quot;&gt;&quot; + artist + &quot;&lt;\/h2&gt;&quot;;
    albumLink = $(&quot;&lt;a/&gt;&quot;, {
                            href: &quot;#albumview&quot;,
                            &quot;data-identity&quot;: album._id,
                            click: function() {
                                albumId = $(this).data(&quot;identity&quot;);
                            }
                    });
    albumLink.append( header );
    listItem.append( albumLink );
    listItem.append( &quot;&lt;p class=\&quot;title\&quot;&gt;&quot; + title + &quot;&lt;\/p&gt;&quot; );
    listItem.append( &quot;&lt;p class=\&quot;description\&quot;&gt;&quot; + description + &quot;&lt;\/p&gt;&quot; );
    $(&quot;#albums&quot;).append( listItem );
}
</pre>
<p>In this snippet, we have resolved <em>listItem</em> to an <strong>HTML</strong> entity we can append to and construct a click-able <em>albumLink</em> using object notation. a <strong>data-identity</strong> property is set in the link to access and assign an <em>albumId</em> which will later be used to request the document once we have landed on the albumview page. The content elements are largely the same as they were previously for the <em>listItem</em>, but we have wrapped the header in a link element.</p>
<h3>Navigation</h3>
<p>We will need to bind an event prior to showing the albumview page in order to request the document and display it once we land on the <em>albumview</em> page. The following snippet is the full document with those changes highlighted:</p>
<pre class="brush: xml; highlight: [27,32,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90]; title: ;" title="">
&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;My Albums&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;style/main.css&quot; type=&quot;text/css&quot;&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;style/jquery.mobile-1.0a2.css&quot; type=&quot;text/css&quot;/&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div data-role=&quot;page&quot;&gt;
        &lt;div data-role=&quot;header&quot;&gt;&lt;h2&gt;Albums&lt;/h2&gt;&lt;/div&gt;
        &lt;div data-role=&quot;content&quot;&gt;
            &lt;ul id=&quot;albums&quot; data-role=&quot;listview&quot; data-theme=&quot;c&quot; data-dividertheme=&quot;b&quot; /&gt;
        &lt;/div&gt;
        &lt;div data-role=&quot;footer&quot;&gt;Footer&lt;/div&gt;
    &lt;/div&gt;
    &lt;div data-role=&quot;page&quot; id=&quot;albumview&quot;&gt;
        &lt;div data-role=&quot;header&quot; id=&quot;albumheader&quot;&gt;
            &lt;h2 class=&quot;albumtitle&quot;&gt;&lt;/h2&gt;
        &lt;/div&gt;
        &lt;div data-role=&quot;content&quot; id=&quot;albumcontent&quot;&gt;&lt;/div&gt;
        &lt;div data-role=&quot;footer&quot; /&gt;
    &lt;/div&gt;
  &lt;/body&gt;
  &lt;script src=&quot;vendor/couchapp/loader.js&quot;&gt;&lt;/script&gt;
  &lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;

      var albumId;
      $db = $.couch.db(&quot;albums&quot;);

      function handleDocumentReady()
      {
          $(&quot;#albumview&quot;).bind( &quot;pagebeforeshow&quot;, openAlbum );
          refreshAlbums();
      }

      function refreshAlbums()
      {
          $(&quot;#albums&quot;).empty();
          $db.view(&quot;albums/albums&quot;,
            { success: function( data ) {
                    var i;
                    var album;
                    var artist;
                    var title;
                    var description;
                    var listItem;
                    for( i in data.rows )
                    {
                        album = data.rows[i].value;
                        artist = album.artist;
                        title = album.title;
                        description = album.description;
                        listItem = $(&quot;&lt;li/&gt;&quot;, {
                                        class: &quot;album&quot;
                                        });
                        header = &quot;&lt;h2 class=\&quot;artist\&quot;&gt;&quot; + artist + &quot;&lt;\/h2&gt;&quot;;
                        albumLink = $(&quot;&lt;a/&gt;&quot;, {
                                        href: &quot;#albumview&quot;,
                                        &quot;data-identity&quot;: album._id,
                                        click: function() {
                                                albumId = $(this).data(&quot;identity&quot;);
                                            }
                                        });
                        albumLink.append( header );
                        listItem.append( albumLink );
                        listItem.append( &quot;&lt;p class=\&quot;title\&quot;&gt;&quot; + title + &quot;&lt;\/p&gt;&quot; );
                        listItem.append( &quot;&lt;p class=\&quot;description\&quot;&gt;&quot; + description + &quot;&lt;\/p&gt;&quot; );
                        $(&quot;#albums&quot;).append( listItem );
                    }
                    $(&quot;#albums&quot;).listview( &quot;refresh&quot; );
                }
            });
      }

      function openAlbum()
      {
          $(&quot;#albumcontent&quot;).children().remove();
            $db.openDoc( albumId,
                  { success: function( data ) {
                          var artist = data.artist;
                          var title = data.title;
                          var description = data.description;
                          var html = &quot;&lt;h2 class=\&quot;artist\&quot;&gt;&quot; + artist + &quot;&lt;\/h2&gt;&quot; +
                                        &quot;&lt;p class=\&quot;title\&quot;&gt;&quot; + title + &quot;&lt;\/p&gt;&quot; +
                                        &quot;&lt;p class=\&quot;description\&quot;&gt;&quot; + description + &quot;&lt;\/p&gt;&quot;;
                          $(&quot;#albumcontent&quot;).append( html );
                          $(&quot;#albumheader .albumtitle&quot;).text( title );
                  }
              });
      }

      $(document).ready( handleDocumentReady );

  &lt;/script&gt;
&lt;/html&gt;
</pre>
<p>In this snippet we have bound the &#8220;<em>pagebefoeshow</em>&#8221; event to the <em>openAlbum()</em> method handler within the <em>handleDocumentReader()</em> method:</p>
<pre class="brush: jscript; title: ;" title="">
$(&quot;#albumview&quot;).bind( &quot;pagebeforeshow&quot;, openAlbum );
</pre>
<p>This will invoke <em>openAlbum()</em> prior to transitioning to the <em>albumview</em> page, allowing us to request the document based on the <em>albumId</em> and add elements to the content of the <em>albumview</em> page:</p>
<pre class="brush: jscript; title: ;" title="">
function openAlbum()
{
    $(&quot;#albumcontent&quot;).children().remove();
     $db.openDoc( albumId,
            { success: function( data ) {
                    var artist = data.artist;
                    var title = data.title;
                    var description = data.description;
                    var html = &quot;&lt;h2 class=\&quot;artist\&quot;&gt;&quot; + artist + &quot;&lt;\/h2&gt;&quot; +
                                  &quot;&lt;p class=\&quot;title\&quot;&gt;&quot; + title + &quot;&lt;\/p&gt;&quot; +
                                  &quot;&lt;p class=\&quot;description\&quot;&gt;&quot; + description + &quot;&lt;\/p&gt;&quot;;
                    $(&quot;#albumcontent&quot;).append( html );
                    $(&quot;#albumheader .albumtitle&quot;).text( title );
            }
        });
}
</pre>
<p>&#8230; nothing to unfamiliar&#8230; and nothing to pretty <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> . </p>
<h3>Deployment</h3>
<p>We can now push our changes to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database using the <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> utliity. Open a terminal and navigate to the directory where you create your <strong>CouchApp</strong> applications (for me that is <em>/Documents/workspace/custardbelly/couchdb</em> and in there i have a folder named albums which is my <strong>CouchApp</strong> application directory). Enter the following command to push the changes to the <strong>CouchDB</strong> instance:</p>
<pre class="brush: bash; title: ;" title="">
couchapp push albums http://127.0.0.1:5984/albums
</pre>
<p>If that was successful and you now visit <a href="http://127.0.0.1:5984/albums/_design/albums/index.html" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html</a>, you will be presented with the list of albums. Click on a list item, and you should be navigated to the <em>albumview</em> page which will display the detail of the document selected from the list. It may look something like the following:</p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_four.png" /></p>
<p>I intentionally left the browser wide (and not the simulated size of a mobile device) so you can how see the hash is added to the <strong>URL</strong> once on the <em>albumview</em> page: <a href="http://127.0.0.1:5984/albums/_design/albums/index.html#albumview" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html#albumview</a>.</p>
<p>This is all well and good, but it leads to a problem (in my opinion) as to directly sending a user to the <em>albumview</em> with a populated document. As it stands, an album detail can only be seen once a user has clicked on an item from the list. If you just pasted the <a href="http://127.0.0.1:5984/albums/_design/albums/index.html#albumview" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html#albumview</a> <strong>URL</strong> in a new browser window, the content would be empty. Not good User Experience.</p>
<p>Fortunately, there is an alternative. We can add a <em>show</em> function to our application in <strong>CouchDB</strong> to navigate to an external page that has a (somewhat) uglier URI but allows for you to land on a detail page without going through the landing page of the application. yay!</p>
<h2>External Album Page View</h2>
<p>In the browser, up to this point through the series, we have seen pages that return the JSON object representing rows of documents (ie. <a href="http://127.0.0.1:5984/albums/_all_docs" target="_blank">http://127.0.0.1:5984/albums/_all_docs</a>) and used design views to create a default landing page to interact with the albums database (<a href="http://127.0.0.1:5984/albums/_design/albums/index.html" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html</a>). But there is more to <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a>. Using <strong>shows and lists</strong>, you can serve up a document in any type of representation, including <strong>HTML</strong>. They are restricted to only <em>GET</em> requests, so you can&#8217;t save a document in a different format, but you can certainly return a document in another format.</p>
<p>If you look within the <em>/albums</em> directory we created using <a href="http://couchapp.org/page/index" target="_blank">CouchApp</a>, you may notice a couple folders we have largely been ignoring while we toiled away in <em>/_attachments</em> and <em>/vendor</em> &#8211; <em>shows</em> and <em>lists</em>. We are not going to look into lists at the moment, but we will create a <strong>show</strong> function in our application design to return the <strong>HTML</strong> representation of a document marked-up as a <a href="http://jquerymobile.com/" target="_blank">jquery Mobile</a> page. With this scenario, we can treat the <em>show</em> function as an external page view and have a ugl(ier)y URL, but one we can send to anyone and not have to go through list item selection from the main page.</p>
<h3>Show Function</h3>
<p>As we are moving away from internal pages to external pages for our application, we are going to have each page returned in a <strong>show function</strong> of our design. The first order of business to return a album detail page upon selection from the list, is to move the <strong>HTML</strong> markup for <em>albumview</em> into a show design document in the <em>/shows</em> directory of our <em>albums</em> <a href="http://couchapp.org/page/index" target="_blank">CouchApp</a> application.</p>
<p>Open up your favorite text editor and create a new <strong>JavaScript</strong> document. Enter in the following function and save it as <em>album.js</em> in the <em>/shows</em> folder:</p>
<pre class="brush: jscript; title: ;" title="">
function(doc, req) {
  var html = &quot;&lt;div data-role=\&quot;page\&quot; id=\&quot;albumview\&quot;&gt;&quot; +
                       &quot;&lt;div data-role=\&quot;header\&quot; id=\&quot;albumheader\&quot;&gt;&quot; +
                           &quot;&lt;h2 class=\&quot;albumtitle\&quot;&gt;&quot; + doc.title + &quot;&lt;\/h2&gt;&quot; +
                       &quot;&lt;\/div&gt;&quot; +
                       &quot;&lt;div data-role=\&quot;content\&quot; id=\&quot;albumcontent\&quot;&gt;&quot; +
                           &quot;&lt;h2 class=\&quot;artist\&quot;&gt;&quot; + doc.artist + &quot;&lt;\/h2&gt;&quot; +
                           &quot;&lt;p class=\&quot;title\&quot;&gt;&quot; + doc.title + &quot;&lt;\/p&gt;&quot; +
                           &quot;&lt;p class=\&quot;description\&quot;&gt;&quot; + doc.description + &quot;&lt;\/p&gt;&quot; +
                       &quot;&lt;\/div&gt;&quot; +
                       &quot;&lt;div data-role=\&quot;footer\&quot; \/&gt;&quot; +
                   &quot;&lt;\/div&gt;&quot;;
  return html;
}
</pre>
<p>Each <strong>show document</strong> must declare the <em>function(doc, reg)</em> method. This is the standard function of a <em>show document</em> which is invoked on a request through <em>http://127.0.0.1:5984/albums/_design/albums/_show/album/${_id}</em> and handed the full corresponding document from the database and the <strong>HTTP</strong> request object.</p>
<p>If we look at the <em>index.html</em> page we worked on in the previous section (<strong>Local Album Page View</strong>), we&#8217;ll see that what is returned from this <strong>show function</strong> is really just a mixture of the mark-up for the <em>albumview</em> page and the <em>openAlbum()</em> method. You may notice that we are not sending back a full <strong>HTML</strong> document from this <em>show</em> function. That is alright for now. This mark-up will be treated as a page and housed and styled by our <em>index.html</em> page. We can probably do some fancy string assembly based on the <em>request</em> path, but for now we are just gonna leave it as an insertion into the <a href="http://jquerymobile.com/" target="_blank">jquery Mobile</a> application.</p>
<h3>Modifying index.html</h3>
<p>Now that we have a <strong>show function</strong> serving up our <em>abumview</em> pages, we need to clean up our <em>index.html</em> document and change our <em>albumview</em> link from internal to external. Open up the <em>/_attachments/index.html</em> document in your favorite editor and make the following modifications:</p>
<pre class="brush: xml; highlight: [38,45,46,47,48,49,50,51,52]; title: ;" title="">
&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;My Albums&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;style/main.css&quot; type=&quot;text/css&quot;&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;style/jquery.mobile-1.0a2.css&quot; type=&quot;text/css&quot;/&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div data-role=&quot;page&quot;&gt;
          &lt;div data-role=&quot;header&quot;&gt;&lt;h2&gt;Albums&lt;/h2&gt;&lt;/div&gt;
          &lt;div data-role=&quot;content&quot;&gt;
              &lt;ul id=&quot;albums&quot; data-role=&quot;listview&quot; data-theme=&quot;c&quot; data-dividertheme=&quot;b&quot; /&gt;
          &lt;/div&gt;
          &lt;div data-role=&quot;footer&quot;&gt;Footer&lt;/div&gt;
      &lt;/div&gt;
  &lt;/body&gt;
  &lt;script src=&quot;vendor/couchapp/loader.js&quot;&gt;&lt;/script&gt;
  &lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;

      $db = $.couch.db(&quot;albums&quot;);

      function handleDocumentReady()
      {
          refreshAlbums();
      }

      function refreshAlbums()
      {
          $(&quot;#albums&quot;).empty();
          $db.view(&quot;albums/albums&quot;,
            { success: function( data ) {
                    var i;
                    var album;
                    var artist;
                    var title;
                    var description;
                    var listItem;
                    var externalPage;
                    for( i in data.rows )
                    {
                        album = data.rows[i].value;
                        artist = album.artist;
                        title = album.title;
                        description = album.description;
                        externalPage = &quot;_show/album/&quot; + album._id;
                        listItem = &quot;&lt;li class=\&quot;album\&quot;&gt;&quot; +
                                            &quot;&lt;a href=\&quot;&quot; + externalPage + &quot;\&quot;&gt;&quot; +
                                                &quot;&lt;h2 class=\&quot;artist\&quot;&gt;&quot; + artist + &quot;&lt;\/h2&gt;&quot; +
                                            &quot;&lt;\/a&gt;&quot; +
                                            &quot;&lt;p class=\&quot;title\&quot;&gt;&quot; + title + &quot;&lt;\/p&gt;&quot; +
                                            &quot;&lt;p class=\&quot;description\&quot;&gt;&quot; + description + &quot;&lt;\/p&gt;&quot;;
                                        &quot;&lt;\/li&gt;&quot;;
                        $(&quot;#albums&quot;).append( listItem );
                    }
                    $(&quot;#albums&quot;).listview( &quot;refresh&quot; );
                }
            });
      }

      $(document).ready( handleDocumentReady );

  &lt;/script&gt;
&lt;/html&gt;
</pre>
<p>There&#8217;s no highlighting for what we removed in that snippet, but we took out the <em>albumview</em> page declaration from the <em>body</em> and removed the <em>openAlbum()</em> method (as well as its binding on &#8220;<em>pagebeforeshow</em>&#8220;). The <em>listItem</em> is now back to an <strong>HTML</strong> string that is appending to the albums <em>listview</em>. Instead of adding a <em>click</em> handler to a link, the <strong>href</strong> is attributed as an external <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page which is is a query to show the associated document with the <em>_id</em>. Simple, clean.</p>
<h3>Deployment</h3>
<p>We modified our application to utilize a <strong>show function</strong> to serve the <em>albumview</em> page up within a <a href="http://jquerymobile.com/" target="_blank">jquery Mobile</a> application. With these changes saved, we can now push to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database using the <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> utility. Open a terminal and navigate to the directory where you create your <strong>CouchApp</strong> applications (for me that is <em>/Documents/workspace/custardbelly/couchdb</em> and in there i have a folder named <em>albums</em> which is the <strong>CouchApp</strong> application directory for these examples). Enter the following command to push the changes to the <strong>CouchDB</strong> instance:</p>
<pre class="brush: bash; title: ;" title="">
couchapp push albums http://127.0.0.1:5984/albums
</pre>
<p>If all was successful and you now go to <a href="http://127.0.0.1:5984/albums/_design/albums/index.html" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html</a>, we&#8217;ll still have our old familiar list. Click on an item, and we should be navigated to a detail (or <em>albumview</em>) page somewhat like the following:</p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_five.png" /></p>
<p>I left the browser wide again so you can see the new <strong>URL</strong> for viewing a single <em>album</em> document: <a href="http://127.0.0.1:5984/albums/_design/albums/index.html#_show/album/" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html#_show/album/</a>${doc._id}. Pretty neat. Now you can even copy that <strong>#show</strong> page <strong>URL</strong> and paste it in another window and you should be taken directly to that detail page. You may notice that we still get the back button in the upper left of the header. That is because of the hash (#) in the <strong>URL</strong> which the <a href="http://jquerymobile.com/" target="_blank">jquery Mobile</a> framework interprets as being a page linked from another. So a false history. If you clicked <strong>Back</strong> from the page, it would not go to the <em>index.html</em> page. A minor flaw in our design that we are going to let go for now <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  Hey, we just got all this neat stuff working&#8230; we&#8217;ll work out the kinks later. There&#8217;s more fun stuff to work on.</p>
<h2>Conclusion</h2>
<p>Well, i said the subsequent posts after the initial <a href="http://custardbelly.com/blog/?p=244" target="_blank">Getting Started</a> would be shorter&#8230; i lied <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  In any event, we created a detail page for a single document and offloaded the page loading to an external <a href="http://jquerymobile.com/" target="_blank">jquery Mobile</a> page utilizing the <strong>show function</strong> of the albums design. A nice solution with an ugly<strong>URL</strong> (we can address that later) that can be passed to other people so they can land on that single page without going through the whole application from the beginning. Since I prefer the external page solution, any continuing posts on this example will utilize the <strong>show function</strong> to serve, at least, the album detail page.</p>
<p>Now what if we wanted to edit the fields of that document&#8230; I am on the edge of my seat as i write this. Literally. Someone stacked a bunch of wrapping stuff on this chair and left me little room. I could have moved it, but i was just too excited to talk about forms&#8230;</p>
<p><em>[Note] This post was written against the following software versions:</em><br />
<strong>CouchDB </strong>– 1.0.1<br />
<strong>CouchApp</strong> – 0.7.2<br />
<strong>jQuery</strong> – 1.4.4<br />
<strong>jQuery Mobile</strong> – 1.0a2<br />
<em>If you have found this post and any piece has moved forward, hopefully the examples are still viable/useful. I will not be updating the examples in this post in parellel with updates to any of the previously mentioned software, unless explicitly noted.</em></p>
<p><strong>Articles in this series:</strong></p>
<ol>
<li><a href="http://custardbelly.com/blog/?p=244" target="_blank">Getting Started</a></li>
<li><a href="http://custardbelly.com/blog/?p=278" target="_blank">Displaying a page detail of a single album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=297" target="_blank">Templates and Mustache</a></li>
<li><a href="http://custardbelly.com/blog/?p=318" target="_blank">Displaying an editable page of an album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=332" target="_blank">Creating and Adding an album document.</a></li>
<li><a href="http://custardbelly.com/blog/?p=344" target="_blank">Deleting an album document</a></li>
<li><a href="http://custardbelly.com/blog/?p=360" target="_blank">Authorization and Validation &#8211; Part 1</a></li>
<li><a href="http://custardbelly.com/blog/?p=394">Authorization and Validation &#8211; Part 2</a></li>
</ol>
<p><a href="http://custardbelly.com/downloads/couchapp/jqm_couchdb_albums.zip">Full source for albums couchapp here.</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/couchdb/" title="View all posts in CouchDB" rel="category tag">CouchDB</a>,  <a href="http://custardbelly.com/blog/category/jquery/" title="View all posts in jquery" rel="category tag">jquery</a>,  <a href="http://custardbelly.com/blog/category/jquery-mobile/" title="View all posts in jquery-mobile" rel="category tag">jquery-mobile</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2010/12/13/jquery-mobile-couchdb-part-2-document-view/#comments" rev="post-278"  title="Comment on jQuery Mobile + CouchDB: Part 2 &#8211; Document View">3 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2010-12-13T05:40">December 13, 2010</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-278-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-244" class="post-244 post hentry category-couchdb category-jquery category-jquery-mobile full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2010/12/08/jquery-mobile-couchdb-part-1-getting-started/" title="Permanent link to jquery Mobile + CouchDB: Part 1 &#8211; Getting Started" rel="bookmark" rev="post-244">jquery Mobile + CouchDB: Part 1 &#8211; Getting Started</a></h1>
	
	<div class="entry-content full-content">
		<h2>Intro</h2>
<p>I have been digging using <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> as my back-end choice for personal projects for a while now and truly do believe it is the best solution when choosing a non-relational database management system. While discovering my affinity for <strong>CouchDB</strong>, i started developing <a href="http://custardbelly.com/blog/?page_id=127" target="_blank">as3couchdb</a> &#8211; an open-source library written in <strong>ActionScript 3</strong> that allows <strong>Flash</strong> to communicate to a <strong>CouchDB</strong> instance which can be found on <a href="https://github.com/bustardcelly/as3couchdb" target="_blank">github</a>. I think <strong>as3couchdb</strong> is in a pretty stable place at the moment and have built a couple applications and have been happy with it. I am going to continue developing it, and if you do use it and find problems/suggestions please let me know.</p>
<p>That said, i have never been one to focus on something for too long (without getting paid to, of course <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> ), without getting distracted by wanting to learn something new. I knew <strong>CouchDB</strong> shipped with a <a href="http://jquery.com/" target="_blank">jQuery</a> <a href="https://github.com/apache/couchdb/blob/trunk/share/www/script/jquery.couch.js" target="_blank">plugin</a>, so i thought i would play around with making a <strong>DHTML</strong> client for some of my projects. Then i thought, why the hell not throw in the <a href="http://jquerymobile.com/" target="_blank">jquery Mobile</a> framework for the fun of it? If we are gonna do it, let&#8217;s do it. </p>
<p>So that is what i have set out to do. I have finished some basics of an application and am looking to get more into the nitty gritty. I figured what better way to do this than to document it; not only purposed as a storage of how to do something, but *hopefully* a place for some people to chime in and tell me how to do it better <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  </p>
<p>This happens to be the first in a series of posts that document building a &#8220;simple&#8221; <strong>DHTML</strong> application using the <a href="http://jquerymobile.com/" target="_blank">jQuery  Mobile</a> framework and a <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> back-end. <em>Here&#8217;s to hoping the intro for subsequent posts are not as long.</em></p>
<h2>CouchDB</h2>
<p><a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> is a schema-free document-oriented database HTTP server. If you have not heard the term <a href="http://en.wikipedia.org/wiki/NoSQL" target="_blank">NoSQL</a>, it is used to refer to a database management system (<strong>DBMS</strong>) that differs from the widely-used relational model; started out as meaning a <strong>DBMS</strong> that does not providing a <strong>SQL</strong> interface, but became a term to refer to any non-relational <strong>DBMS</strong>, of which <strong>CouchDB</strong> is often grouped with when talking about <strong>NoSQL</strong>. I won&#8217;t go into a lengthy discussion of <strong>CouchDB</strong> &#8211; so I will say, in basic terms, <strong>CouchDB</strong> is a document-based <strong>DBMS</strong>. This will make more sense once we start looking at the API for the <strong>CouchDB</strong> <strong>jQuery</strong> plugin.</p>
<p>Before we get into building a front-end for our application, we need to set up a database to play around with. I am assuming here that you have installed <strong>CouchDB</strong> on your local machine and have it running and accessible at <a href="http://127.0.0.1:5984" target="_blank">http://127.0.0.1:5984</a>. If you don&#8217;t and want to set it up, <a href="http://couchdb.apache.org/downloads.html" target="_blank">download CouchDB</a> and peruse the appendix on this link &#8211; <a href="http://guide.couchdb.org/draft" target="_blank">http://guide.couchdb.org/draft</a> &#8211; or install from source from this link -<a href="http://guide.couchdb.org/draft/source.html" target="_blank">http://guide.couchdb.org/draft/source.html</a></p>
<h2>CouchApp</h2>
<p>Though it is not necessary in creating and modifying views and <strong>DHTML</strong> pages served up from <strong>CouchDB</strong>, i tend to use the <a href="http://couchapp.org/page/index" target="_blank">CouchApp</a> command line tool when working with and managing a <strong>CouchDB</strong> database. </p>
<p>You can read more about <strong>CouchApp</strong> on their <a href="http://couchapp.org/page/index" target="_blank">main wiki</a> and checkout the project at <a href="https://github.com/couchapp/couchapp" target="_blank">/couchapp/couchapp on github</a>. <strong>CouchApp</strong> is basically a set of utilities that makes creating and modifying views of a <strong>CouchDB</strong> database instance easy (or i should say <em>easier</em>). Not to mention (the best part), you can create all your views, etc locally, make sure you got it right then push replication remotely and you are all set. Beauty.</p>
<p>When pushing design documents to a <strong>CouchDB</strong> database in this and following example posts, I will be using the <strong>couchapp</strong> command line tool as it is quick and easy and a great little utility, but everything done with it can be easily done using <a href="http://curl.haxx.se/docs/manpage.html" target="_blank">curl</a> if you wish.</p>
<h2>Our Album Database</h2>
<p>First things first, let&#8217;s set up a database we can start working with. I use <a href="http://janl.github.com/couchdbx/" target="_blank">CouchDBX</a>, which i recommend if you are on a <strong>Mac</strong>. Don&#8217;t know if there is an equivalent for <strong>Windows</strong> or <strong>Linux</strong>, so if you do know, leave a comment please. Otherwise, just hitting up <a href="http://127.0.0.1:5984/_utils" target="_blank">http://127.0.0.1:5984/_utils</a>, the <strong>Futon</strong> app, should work in getting started.</p>
<p>Create a new database called <em>albums</em>&#8230; or whatever you want to call it. I will be building <em>album</em> views in these examples but you could easily make them something else. Once we have our <em>albums</em> database created, lets create a couple <em>album</em> documents since we are going to have a view that shows a list of albums. The make up of an <em>album</em> document is as such:</p>
<pre class="brush: jscript; title: ;" title="">
{
    &quot;artist&quot; : {
        &quot;type&quot; : &quot;string&quot;
    }
    &quot;title&quot; : {
        &quot;type&quot; : &quot;string&quot;
    }
    &quot;description&quot; : {
        &quot;type&quot; : &quot;string&quot;
    }
}
</pre>
<p>&#8230; pretty basic for our purposes. Using that schema, add a couple album documents to the databse. I just threw in the following document entries:</p>
<pre class="brush: jscript; title: ;" title="">
{&quot;artist&quot;:&quot;Thin Lizzy&quot;, &quot;title&quot;:&quot;Fighting&quot;, &quot;description&quot;:&quot;Bona-fide rock classic.&quot;}
{&quot;artist&quot;:&quot;David Bowie&quot;, &quot;title&quot;:&quot;Honky Dory&quot;, &quot;description&quot;:&quot;Doesn't get much better than this.&quot;}
</pre>
<p> &#8230; and now you know a little bit about my musical tastes <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  Any way, we&#8217;ve got our database and a few documents residing in it. Lets create a client-side application using <a href="http://couchapp.org/page/index" target="_blank">CouchApp</a> and push it to the <em>albums</em> database. </p>
<h2>Our Albums CouchApp</h2>
<p>With <a href="https://github.com/couchapp/couchapp" target="_blank">CouchApp</a> properly installed, we&#8217;ll move over to using the command line tools to create our <strong>Albums</strong> application, create views and push the documents to our <strong>CouchDB</strong> database.</p>
<h3>Application</h3>
<p>With the terminal open, navigate to a directory that you deem worthy to create applications for <strong>CouchDB</strong> in. For example, on <strong>Mac</strong>, that for me is usually <em>/Documents/workspace/custardbelly/couchdb</em>. Enter in the following command to generate an <em>albums</em> application to which we will add some views and later push to the <em>albums</em> database:</p>
<pre class="brush: bash; title: ;" title="">
couchapp generate app albums
</pre>
<p>If all goes well, a new folder named <em>albums</em> will be in the target directory and will contain files such as the following:</p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_one.png" alt="couch app application diretory" /></p>
<p>I won&#8217;t cover all of what those files pertain to, but basically those files will be pushed to the <em>albums</em> database and stored based on the <em>_id</em> file value &#8211; <strong>CouchApp</strong> defaults to <em>_design/${application}</em> and for this example will be <em>_design/albums</em>.</p>
<p>Now, if we were to push this application to our <strong>CouchDB</strong> database as it stands now and visited <a href="http://127.0.0.1:5984/albums/_all_docs" target="_blank">http://127.0.0.1:5984/albums/_all_docs</a> we would get returned a page that shows the <strong>JSON</strong> object of rows of available documents with the default key/values. Maybe useful to some, but not a good user experience for looking at documents in our database. To do this we can create a view using <strong>CouchApp</strong> that will help in presenting a page that lists the available documents in a nice readable manner.</p>
<h3>View</h3>
<p>In the terminal, enter the following command to generate a view for all albums in the database:</p>
<pre class="brush: bash; title: ;" title="">
couchapp generate view albums albums
</pre>
<p>With that command, we have used <strong>CouchApp</strong> to create a view named <em>albums</em> (the last argument) in the database <em>albums</em> (argument after <strong>view</strong>). If you take a look at the views directory in the <em>albums application</em> folder, you will see that a new folder called <em>albums</em> has been created containing the <em>map.js</em> and <em>reduce.js</em> files. </p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_two.png" alt="couch app application diretory" /></p>
<p>I won&#8217;t go over all that is involved in map/reduce in <strong>CouchDB</strong>, so this is some good information if you are interested: <a href="http://wiki.apache.org/couchdb/Introduction_to_CouchDB_views" target="_blank">http://wiki.apache.org/couchdb/Introduction_to_CouchDB_views</a>. For now, we are just going to modify the<em> map.js</em> file and delete the <em>reduce.js</em> file so it returns a list of the album documents in the database.</p>
<h3>map.js</h3>
<p>Open up the <em>/albums/views/albums/map.js</em> file in you favorite text editor and add the following line within the <em>function()</em> statement:</p>
<pre class="brush: jscript; title: ;" title="">
function( doc ) {
    emit( doc._id, doc );
}
</pre>
<p>When you visit <a href="http://127.0.0.1:5984/albums/_design/albums/_view/albums" target="_blank">http://127.0.0.1:5984/albums/_design/albums/_view/albums</a> a <strong>JSON</strong> object will be returned with a key/value pairing for each document in the database with the key being the <em>_id</em> assigned to the document and the value being the full document object. In essence, when you create a view, you are creating a rule of how you want documents from the database returned to you. For this simple example, we are just going to return all the documents trusting that they will all be albums. You can create more views (and more applications) as you see fit. For now, we&#8217;ll just work with all the documents and wire up a page to view them.</p>
<p>Let&#8217;s go ahead and push the <em>albums</em> application to our albums database:</p>
<pre class="brush: bash; title: ;" title="">
couchapp push albums http://127.0.0.1:5984/albums
</pre>
<p>If successful, that should return:</p>
<pre class="brush: bash; title: ;" title="">
2010-12-06 17:37:24 [INFO] Visit your CouchApp here:
http://127.0.0.1:5984/albums/_design/albums/index.html
</pre>
<p>If you go and visit <a href="http://127.0.0.1:5984/albums/_design/albums/index.html" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html</a>, you will notice that shows absolutely no relevance to our application or our database <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  If you go to <a href="http://127.0.0.1:5984/albums/_design/albums/_view/albums" target="_blank">http://127.0.0.1:5984/albums/_design/albums/_view/albums</a> you will now see our full <strong>JSON</strong> object that we will use when we modify that <em>index.html</em>. </p>
<p>The index file that you were originally directed to is the <em>index.html</em> file in the <em>/albums/_attachments</em> directory. If you open that file up in a text editor, you will see that it is using the <strong>couch.app</strong> <strong>jQuery</strong> plugin to construct the elements on the default page. We can modify this <strong>HTML</strong> document now and use the <strong>jQuery Mobile</strong> plugin to present our list of albums beautifully (no guarantees on the beautiful part:)).</p>
<h2>Albums Application User Interface</h2>
<p><a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> ships with a version of <a href="http://jquery.com/" target="_blank">jQuery</a> and a plugin to interact with a <strong>CouchDB</strong> instance. They (and other scripts for serialization and <strong>futon</strong>) can be found in your installation, which on my make is in the following location:</p>
<pre class="brush: bash; title: ;" title="">
/opt/local/share/couchdb/www/script
</pre>
<p>If we look at the default <em>index.html</em> page created for us when we used <strong>CouchApp</strong> to create our <em>albums</em> application, we see that it is using a loader to load in all those necessary scripts:</p>
<pre class="brush: xml; title: ;" title="">
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;My New CouchApp&lt; itle&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;style/main.css&quot; type=&quot;text/css&quot;&gt;
  &lt;/link&gt;&lt;/title&gt;&lt;/head&gt;
  &lt;body&gt;
    &lt;div id=&quot;account&quot;&gt;&lt;/div&gt;

    &lt;h1&gt;Generated CouchApp&lt;/h1&gt;

    &lt;div id=&quot;profile&quot;&gt;&lt;/div&gt;
    &lt;div id=&quot;items&quot;&gt;&lt;/div&gt;

    &lt;div id=&quot;sidebar&quot;&gt;
      &lt;p&gt;Edit welcome message.&lt;/p&gt;
      &lt;p&gt;Ideas: You could easily turn this into a photo sharing app, or a grocery list, or a chat room.&lt;/p&gt;
    &lt;/div&gt;
  &lt;/body&gt;
  &lt;script src=&quot;vendor/couchapp/loader.js&quot;&gt;&lt;/script&gt;
  &lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;
    $.couch.app(function(app) {
      $(&quot;#account&quot;).evently(&quot;account&quot;, app);
      $(&quot;#profile&quot;).evently(&quot;profile&quot;, app);
      $.evently.connect(&quot;#account&quot;,&quot;#profile&quot;, [&quot;loggedIn&quot;,&quot;loggedOut&quot;]);
      $(&quot;#items&quot;).evently(&quot;items&quot;, app);
    });
  &lt;/script&gt;
&lt;/html&gt;
</pre>
<p>That <em>loader.js</em> file can be found in the <em>/albums/vendor/couchapp/_attachments</em> directory and looks like the following:</p>
<pre class="brush: jscript; title: ;" title="">
function couchapp_load(scripts) {
  for (var i=0; i &lt; scripts.length; i++) {
    document.write('&lt;script src=&quot;'+scripts[i]+'&quot;&gt;&lt; \/script&gt;')
  };
};

couchapp_load([
  &quot;/_utils/script/sha1.js&quot;,
  &quot;/_utils/script/json2.js&quot;,
  &quot;/_utils/script/jquery.js&quot;,
  &quot;/_utils/script/jquery.couch.js&quot;,
  &quot;vendor/couchapp/jquery.couch.app.js&quot;,
  &quot;vendor/couchapp/jquery.couch.app.util.js&quot;,
  &quot;vendor/couchapp/jquery.mustache.js&quot;,
  &quot;vendor/couchapp/jquery.evently.js&quot;
]);
</pre>
<p>As we intend to use <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> for our user interface, we will modify this <em>loader.js</em> file to include the latest <a href="http://jquery.com/" target="_blank">jQuery</a> libray and the <a href="http://jquerymodile.com/" target="_blank">jQuery Mobile</a> plugin.</p>
<h3>Modifying loader.js</h3>
<p>If you have not already done so, download the latest releases of <a href="http://jquery.com/" target="_blank">jQuery</a> and <a href="http://jquerymobile.com/">jQuery Mobile</a>. As of this writing those are:</p>
<ol>
<li>
jQuery-1.4.4.js
</li>
<li>
jQuery.mobile-1.0a2.js
</li>
</ol>
<p>Copy those files from wherever you downloaded them to into the <em>/albums/vendor/couchapp/_attachments/</em> directory.</p>
<p>Open up <em>loader.js</em> from that same directory in you favorite text editor and make the following changes:</p>
<pre class="brush: jscript; highlight: [10,16]; title: ;" title="">
function couchapp_load(scripts) {
  for (var i=0; i &lt; scripts.length; i++) {
    document.write('&lt;script src=&quot;'+scripts[i]+'&quot;&gt;&lt; \/script&gt;')
  };
};

couchapp_load([
  &quot;/_utils/script/sha1.js&quot;,
  &quot;/_utils/script/json2.js&quot;,
  &quot;vendor/couchapp/jquery-1.4.4.js&quot;,
  &quot;/_utils/script/jquery.couch.js&quot;,
  &quot;vendor/couchapp/jquery.couch.app.js&quot;,
  &quot;vendor/couchapp/jquery.couch.app.util.js&quot;,
  &quot;vendor/couchapp/jquery.mustache.js&quot;,
  &quot;vendor/couchapp/jquery.evently.js&quot;,
  &quot;vendor/couchapp/jquery.mobile-1.0a2.js&quot;
]);
</pre>
<p>Save the changes to <em>loader.js</em>. We could probably get rid of the <em>mustache.js</em> and <em>evently.js</em> includes, but we&#8217;ll forget about that for now.</p>
<p>Now that we have our loader loading the proper scripts to display a <strong>jQuery Mobile</strong> interface, we need to modify the <em>index.html</em> file to display the list of <em>album</em> documents from our <strong>CouchDB</strong> database.</p>
<h3>Modifying index.html</h3>
<p>Firstly, we&#8217;ll need to add the necessary css and image files that came with the <strong>jQuery Mobile</strong> download so we get the default look-and-feel. </p>
<p>Copy the <em>jquery.mobile-1.0.a2.css</em> file and the <em>images/</em> directory from your <strong>jQuery Mobile</strong> download into the <em>/albums/_attachments/style/</em> folder (residing along with the default <em>main.css</em> file generated using <strong>CouchApp</strong>).</p>
<p>Open up the <em>index.html</em> file in the <em>/albums/_attachments</em> directory with your favorite text editor, and start off with a clean slate by removing the inline <strong>JavaScript</strong> and <em>div</em> tags in the body of the <strong>HTML</strong> document. Also declare the <em>jquery.mobile-1.0a2.css</em> file in your stylesheets. The <em>index.html</em> file should now look somewhat like the following:</p>
<pre class="brush: xml; title: ;" title="">
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;My Albums&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;style/main.css&quot; type=&quot;text/css&quot;&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;style/jquery.mobile-1.0a2.css&quot; type=&quot;text/css&quot;/&gt;
  &lt;/head&gt;
  &lt;body&gt;

  &lt;/body&gt;
  &lt;script src=&quot;vendor/couchapp/loader.js&quot;&gt;&lt;/script&gt;
  &lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;

  &lt;/script&gt;
&lt;/html&gt;
</pre>
<h3>JQuery Mobile Page</h3>
<p>This post is already getting pretty long as it is, and i don&#8217;t want to discuss the finer parts of <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> so the following modifications might not have the fullest explanations as to why we are adding some elements, but i will try at times to explain. </p>
<p>To begin, a <strong>jQuery Mobile</strong> application is comprised of <em>pages</em>. You can declare all your <em>pages</em> in a single <strong>HTML</strong> document or load other pages (saved as <strong>HTML</strong> documents) into <em>divs</em>. A page is denoted by a <strong>data-role</strong> attribute with the value of <em>&#8220;page&#8221;</em>. The <strong>jQuery Mobile</strong> framework handles this pagination and its browser history for you, so there isn&#8217;t much to worry about except for how you want you pages to look&#8230; well there is more to worry about, but we won&#8217;t for the time being <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<p>The landing page for our <em>albums</em> application will display the list of album documents. To do so, modify the <em>index.html</em> file by adding a page <em>div</em> to the <em>body</em> of the <strong>HTML</strong> document:</p>
<pre class="brush: xml; highlight: [8,9,10,11,12,13,14]; title: ;" title="">
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;My Albums&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;style/main.css&quot; type=&quot;text/css&quot;&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;style/jquery.mobile-1.0a2.css&quot; type=&quot;text/css&quot;/&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div data-role=&quot;page&quot;&gt;
          &lt;div data-role=&quot;header&quot;&gt;&lt;h2&gt;Albums&lt;/h2&gt;&lt;/div&gt;
          &lt;div data-role=&quot;content&quot;&gt;
              &lt;ul id=&quot;albums&quot; data-role=&quot;listview&quot; data-theme=&quot;c&quot; data-dividertheme=&quot;b&quot; /&gt;
          &lt;/div&gt;
          &lt;div data-role=&quot;footer&quot;&gt;Footer&lt;/div&gt;
      &lt;/div&gt;
  &lt;/body&gt;
  &lt;script src=&quot;vendor/couchapp/loader.js&quot;&gt;&lt;/script&gt;
  &lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;

  &lt;/script&gt;
&lt;/html&gt;
</pre>
<p>The make up of a <strong>jQuery Mobile</strong> page contains a <em>content</em> div and optional <em>header</em> and <em>footer</em> divs. In this example we have included the <em>header</em> and <em>footer</em> with some very basic information. What is of note is the <em>content</em> div (marked with the <strong>data-role</strong> of &#8220;<em>content</em>&#8220;). The content of our landing page is a list maked with a <strong>data-role</strong> of &#8220;<em>listview</em>&#8221; which will be populated with the document result form our <strong>CouchDB</strong> database query for all album documents.</p>
<p>With our <strong>jQuery Mobile</strong> elements in place, we will add the <strong>JavaScript</strong> to communicate with our <strong>CouchDB</strong> instance and request the <em>album</em> documents from our <em>albums</em> database.</p>
<h3>Communication</h3>
<p>As mentioned previously, <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> ships with a <a href="http://jquery.com/" target="_blank">jquery</a> plugin to ease the communication with a <strong>CouchDB</strong> instance. That script (<em>jquery.couch.js</em>) along with scripts for serialization are loaded within the <em>loader.js</em>.</p>
<p>First things first, we need to assign a handler for when the document has become available and we declare our database reference as the <em>albums</em> database form the <strong>CouchDB</strong> instance:</p>
<pre class="brush: xml; highlight: [18,19,20,21,22,23,24,25,26,27]; title: ;" title="">
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;My Albums&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;style/main.css&quot; type=&quot;text/css&quot;&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;style/jquery.mobile-1.0a2.css&quot; type=&quot;text/css&quot;/&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div data-role=&quot;page&quot;&gt;
          &lt;div data-role=&quot;header&quot;&gt;&lt;h2&gt;Albums&lt;/h2&gt;&lt;/div&gt;
          &lt;div data-role=&quot;content&quot;&gt;
              &lt;ul id=&quot;albums&quot; data-role=&quot;listview&quot; data-theme=&quot;c&quot; data-dividertheme=&quot;b&quot; /&gt;
          &lt;/div&gt;
          &lt;div data-role=&quot;footer&quot;&gt;Footer&lt;/div&gt;
      &lt;/div&gt;
  &lt;/body&gt;
  &lt;script src=&quot;vendor/couchapp/loader.js&quot;&gt;&lt;/script&gt;
  &lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;

      $db = $.couch.db(&quot;albums&quot;);

      function handleDocumentReady()
      {
          // request album documents...
      }

      $(document).ready( handleDocumentReady );

  &lt;/script&gt;
&lt;/html&gt;
</pre>
<p>The <a href="http://docs.jquery.com/Tutorials:Introducing_$(document).ready()" target="_blank">$(document).ready()</a> event hook is a standard part of <a href="http://jquery.com/" target="_blank">jQuery</a> to recognize when the <strong>DOM</strong> has been loaded and we can begin any operations/transactions. In this example, the <em>handleDocumentReady()</em> method is defined as the handler for that event. Within that handler we will add the communication with the <em>$db</em> instance to request our album documents and add them to the <em>listview</em> of the content.</p>
<p>The following snippet is a full implementation of making a request for those documents and adding them to the <em>listview</em>:</p>
<pre class="brush: xml; highlight: [22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52]; title: ;" title="">
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;My Albums&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;style/main.css&quot; type=&quot;text/css&quot;&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;style/jquery.mobile-1.0a2.css&quot; type=&quot;text/css&quot;/&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div data-role=&quot;page&quot;&gt;
          &lt;div data-role=&quot;header&quot;&gt;&lt;h2&gt;Albums&lt;/h2&gt;&lt;/div&gt;
          &lt;div data-role=&quot;content&quot;&gt;
              &lt;ul id=&quot;albums&quot; data-role=&quot;listview&quot; data-theme=&quot;c&quot; data-dividertheme=&quot;b&quot; /&gt;
          &lt;/div&gt;
          &lt;div data-role=&quot;footer&quot;&gt;Footer&lt;/div&gt;
      &lt;/div&gt;
  &lt;/body&gt;
  &lt;script src=&quot;vendor/couchapp/loader.js&quot;&gt;&lt;/script&gt;
  &lt;script type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;

      $db = $.couch.db(&quot;albums&quot;);

      function handleDocumentReady()
      {
          refreshAlbums();
      }

      function refreshAlbums()
      {
          $(&quot;#albums&quot;).empty();
          $db.view(&quot;albums/albums&quot;,
            { success: function( data ) {
                    var i;
                    var album;
                    var artist;
                    var title;
                    var description;
                    var listItem;
                    for( i in data.rows )
                    {
                        album = data.rows[i].value;
                        artist = album.artist;
                        title = album.title;
                        description = album.description;
                        listItem = &quot;&lt;li&gt;&quot; +
                                    &quot;&lt;h2 class=\&quot;artist\&quot;&gt;gt;&quot; + artist + &quot;&lt;\/h2&gt;&quot; +
                                    &quot;&lt;p class=\&quot;title\&quot;&gt;gt;&quot; + title + &quot;&lt;\/p&gt;&quot; +
                                    &quot;&lt;p class=\&quot;description\&quot;&gt;gt;&quot; + description + &quot;&lt;\/p&gt;&quot;;
                        $(&quot;#albums&quot;).append( listItem );
                    }
                    $(&quot;#albums&quot;).listview( &quot;refresh&quot; );
                }
            });
      }

      $(document).ready( handleDocumentReady );

  &lt;/script&gt;
&lt;/html&gt;
</pre>
<p>To get a deeper view, lets look in detail at the method that handles loading the album documents in the script which is invoked from the <em>handleDocumentReady(</em>) handler:</p>
<pre class="brush: jscript; first-line: 27; title: ;" title="">
function refreshAlbums()
{
    $(&quot;#albums&quot;).empty();
    $db.view(&quot;albums/albums&quot;,
    { success: function( data ) {
            var i;
            var album;
            var artist;
            var title;
            var description;
            var listItem;
            for( i in data.rows )
            {
                album = data.rows[i].value;
                artist = album.artist;
                title = album.title;
                description = album.description;
                listItem = &quot;&lt;li&gt;&quot; +
                            &quot;&lt;h2 class=\&quot;artist\&quot;&gt;&quot; + artist + &quot;&lt;\/h2&gt;&quot; +
                            &quot;&lt;p class=\&quot;title\&quot;&gt;&quot; + title + &quot;&lt;\/p&gt;&quot; +
                            &quot;&lt;p class=\&quot;description\&quot;&gt;&quot; + description + &quot;&lt;\/p&gt;&quot;;
                $(&quot;#albums&quot;).append( listItem );
            }
            $(&quot;#albums&quot;).listview( &quot;refresh&quot; );
        }
    });
}
</pre>
<p>First and foremost, as we might use this method in later implementations of the application to refresh the list, we make a call to empty the content of the <em>listview</em>:</p>
<pre class="brush: jscript; first-line: 29; title: ;" title="">
$(&quot;#albums&quot;).empty();
</pre>
<p>Following that, we request the <em>albums</em> view from the database instance by calling <strong>$db.view()</strong> and pointing to the <em>albums</em> view that we created and pushed to the <strong>CouchDB</strong> database using <strong>CouchApp</strong>.</p>
<pre class="brush: jscript; first-line: 30; title: ;" title="">
$db.view(&quot;albums/albums&quot;
</pre>
<p>&#8230; and then resolve a successful result to a function that handles interpreting each <strong>JSON</strong> object related to to an album document so as to add them as list items to the <em>listview</em>:</p>
<pre class="brush: jscript; first-line: 31; title: ;" title="">
{ success: function( data ) {
            var i;
            var album;
            var artist;
            var title;
            var description;
            var listItem;
            for( i in data.rows )
            {
                album = data.rows[i].value;
                artist = album.artist;
                title = album.title;
                description = album.description;
                listItem = &quot;&lt;li&gt;&quot; +
                            &quot;&lt;h2 class=\&quot;artist\&quot;&gt;&quot; + artist + &quot;&lt;\/h2&gt;&quot; +
                            &quot;&lt;p class=\&quot;title\&quot;&gt;&quot; + title + &quot;&lt;\/p&gt;&quot; +
                            &quot;&lt;p class=\&quot;description\&quot;&gt;&quot; + description + &quot;&lt;\/p&gt;&quot;;
                $(&quot;#albums&quot;).append( listItem );
            }
            $(&quot;#albums&quot;).listview( &quot;refresh&quot; );
        }
}
</pre>
<p>The <em>for..in</em> loop in this example goes reads each document object and appends a list item to the <em>listview</em>, after which we make a call to <strong>refresh</strong> the view.</p>
<h3>Deployment</h3>
<p>With the <em>index.html</em> file modified and ready to go live, we can use the couchapp utility to push an update to the <strong>CouchDB</strong> instance so we can view our new mobile-based application in a browser:</p>
<pre class="brush: bash; title: ;" title="">
couchapp push albums http://127.0.0.1:5984/albums
</pre>
<p>.. if all goes well you should see the following printed out :</p>
<pre class="brush: bash; title: ;" title="">
2010-12-07 11:46:55 [INFO] Visit your CouchApp here:
http://127.0.0.1:5984/albums/_design/albums/index.html
</pre>
<p>Now, if you do visit that link, it should redirect you to <a href="http://127.0.0.1:5984/albums/_design/albums/index.html" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html</a> and you should see something like the following:</p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_three.png" alt="couch app mobile application" /></p>
<p>Pretty, no? No. But maybe in later posts we can modify that. For now its up and running. yay!</p>
<h2>Conclusion</h2>
<p>Well, if you made it this far down, you have been a trooper. Hopefully this has been of some help in getting up and started using <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a>, <a href="http://couchapp.org/page/index" target="_blank">CouchApp</a> and <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> to provide a mobile-based <em>User Interface</em> for documents in a <strong>CouchDB</strong> database. Since this is the first in a series of posts in working with <strong>jQuery Mobile</strong> and <strong>CouchDB</strong> it is pretty lengthy as it addresses set-up and the beginning of an application of which we can continue to work. Good news is, later posts on this topic will be shorter <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  and address more of the finer details of <strong>jQuery Mobile</strong> and <strong>CouchDB</strong> communication. At least that is the hope <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> .</p>
<h2>Future Topics</h2>
<p>I am looking forward to adding more posts for this topic as i go about discovering how to create a mobile-based solution for working with documents from a <strong>CouchDB</strong> database. The tentative list is as follows:</p>
<ol>
<li><a href="http://custardbelly.com/blog/?p=244" target="_blank">Getting Started</a></li>
<li><a href="http://custardbelly.com/blog/?p=278" target="_blank">Displaying a page detail of a single album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=297" target="_blank">Templates and Mustache</a></li>
<li><a href="http://custardbelly.com/blog/?p=318" target="_blank">Displaying an editable page of an album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=332" target="_blank">Creating and Adding an album document.</a></li>
<li><a href="http://custardbelly.com/blog/?p=344" target="_blank">Deleting an album document</a></li>
<li><a href="http://custardbelly.com/blog/?p=360" target="_blank">Authorization and Validation &#8211; Part 1</a></li>
<li><a href="http://custardbelly.com/blog/?p=394">Authorization and Validation &#8211; Part 2</a></li>
</ol>
<p><a href="http://custardbelly.com/downloads/couchapp/jqm_couchdb_albums.zip">Full source for albums couchapp here.</a></p>
<p>As those post go live, this list will be updated with the related links.</p>
<p><em>[Note] This post was written against the following software versions:</em><br />
<strong>CouchDB</strong> &#8211; 1.0.1<br />
<strong>CouchApp</strong> &#8211; 0.7.2<br />
<strong>jQuery</strong> &#8211; 1.4.4<br />
<strong>jQuery Mobile</strong> &#8211; 1.0a2<br />
<em>If you have found this post and any piece has moved forward, hopefully the examples are still viable/useful. I will not be updating the examples in this post in parellel with updates to any of the previously mentioned software, unless explicitly noted.</em></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/couchdb/" title="View all posts in CouchDB" rel="category tag">CouchDB</a>,  <a href="http://custardbelly.com/blog/category/jquery/" title="View all posts in jquery" rel="category tag">jquery</a>,  <a href="http://custardbelly.com/blog/category/jquery-mobile/" title="View all posts in jquery-mobile" rel="category tag">jquery-mobile</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2010/12/08/jquery-mobile-couchdb-part-1-getting-started/#comments" rev="post-244"  title="Comment on jquery Mobile + CouchDB: Part 1 &#8211; Getting Started">32 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2010-12-08T05:13">December 8, 2010</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-244-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-231" class="post-231 post hentry category-air category-burrito category-flex category-flex-4-5 full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2010/11/17/flex-hero-pausing-session-restoration/" title="Permanent link to Flex 4.5 (Hero) &#8211; Pausing Session Restoration" rel="bookmark" rev="post-231">Flex 4.5 (Hero) &#8211; Pausing Session Restoration</a></h1>
	
	<div class="entry-content full-content">
		<p>While<a href="http://labs.adobe.com/technologies/flashbuilder_burrito/" target="_blank"> Flex 4.5 (Hero)</a> provides an API for persisting session data within <strong>View</strong> objects, as discussed in my <a href="http://custardbelly.com/blog/?p=228" target="_blank">previous post</a>, <strong>MobileApplication</strong> dispatches events at the initialization and deactivation of the application that allow for you to perform any subsequent custom handling of persistent data &#8211; such as re-logging a user back into a service on relaunch of the application.</p>
<p>[<strong>[NOTE]</strong> <em>It should be noted that this post will be discussing some of the finer points of the persistant data API available, as of this writing, with the free trial download of <a href="http://labs.adobe.com/technologies/flashbuilder_burrito/" target="_blank">Flash Builder &#8220;Burrito&#8221;</a> and the included Flex SDK Version 4.5.0 build 17689</em>]</p>
<p>When the <em>sessionCachingEnabled</em> property of <strong>MobileApplication</strong> is declared as true, the following events are broadcast:</p>

<div class="wp_syntax"><div class="code"><pre class="actionscript" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/* dispatched in MobileApplication +initialize() */</span>
FlexEvent.<span style="color: #006600;">APPLICATION_RESTORING</span>
FlexEvent.<span style="color: #006600;">APPLICATION_RESTORE</span>
<span style="color: #808080; font-style: italic;">/* dispatched in MobileApplication -applicationDeactivateHandler() */</span>
FlexEvent.<span style="color: #006600;">APPLICATION_PERSISTING</span>
FlexEvent.<span style="color: #006600;">APPLICATION_PERSIST</span></pre></div></div>

<p>In responding to these events, a client can serialize any other custom data to the disk that is relevant between sessions (launch, close, re-launch) of your application &#8211; be it as a <strong>Shared Object</strong>, which the <strong>PersistenceManager</strong> writes to, or a file using the <strong>File</strong> API.</p>
<p>When working with persisted data between <strong>View</strong> objects, what essentially is happening is the serialization of the <strong>NavigationStack</strong>. The <strong>NavigationStack</strong> is, in rough terms, a history manager. It holds a list of <strong>ViewHistoryData</strong> objects that pertain to the progression of <strong>View</strong> requests; popping and pushing the <strong>ViewHistoryData</strong> objects from the stack as the user progresses through the application.</p>
<p>When responding to the session-persistent events, you most likely will not be modifying that stack that is being serialized between <strong>View</strong> objects already for you (using the <em>data</em> property and<em> serializeData</em>() and <em>deserializePersistedData</em>() methods discuss in my <a href="http://custardbelly.com/blog/?p=228" target="_blank">previous post</a>). Though you could, you could hijack that <strong>Shared Object</strong> from the <strong>PersistenceManager</strong> and overwrite the work it had previously done, but most likely the serialized <strong>NavigationStack</strong> will be left untouched or at the very least only inspected.</p>
<p>What had originally got me looking into working with these session-persistent events was to have the ability to re-log in a user who had previously been logged into a service in a prior session. It is a common practice and user experience and one the user rarely thinks about. Think about every time you open a <a href="http://twitter.com/#!/bustardcelly" target="_blank">Twitter</a> client on your device. The session is most-likely not kept alive while you have it closed and are playing <a href="http://itunes.apple.com/us/app/falling-balls/id301545989?mt=8" target="_blank">Falling Balls</a>. But when you re-launch it, you don&#8217;t (typically) have to log back in. You can begin sending tweets again. Right away.</p>
<p>This can be achieved in a Flex Hero <strong>MobileApplication</strong>, but you will have to suspend the &#8220;restoring&#8221; of the application upon initialization in order to read in any custom persisted data and log a user into a service. I&#8217;ll touch on that later, but for now let&#8217;s look at how you would first serialize custom data when the application is being deactivated:</p>

<div class="wp_syntax"><div class="code"><pre class="actionscript" style="font-family:monospace;">protected <span style="color: #000000; font-weight: bold;">var</span> _currentUser:CustomUser;
protected <span style="color: #000000; font-weight: bold;">var</span> storedUserFilename:<span style="color: #0066CC;">String</span> = <span style="color: #ff0000;">&quot;currentUser.obj&quot;</span>;
...
<span style="color: #808080; font-style: italic;">// Event handler for FlexEvent.APPLICATION_PERSIST of MobileApplication.</span>
protected <span style="color: #000000; font-weight: bold;">function</span> handleApplicationPersist<span style="color: #66cc66;">&#40;</span> evt:Event <span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
<span style="color: #66cc66;">&#123;</span>
	<span style="color: #000000; font-weight: bold;">var</span> user:CustomUser = _currentUser;
	<span style="color: #000000; font-weight: bold;">var</span> file:File = File.<span style="color: #006600;">applicationStorageDirectory</span>.<span style="color: #006600;">resolvePath</span><span style="color: #66cc66;">&#40;</span> storedUserFilename <span style="color: #66cc66;">&#41;</span>;
	<span style="color: #000000; font-weight: bold;">var</span> stream:FileStream = <span style="color: #000000; font-weight: bold;">new</span> FileStream<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
	stream.<span style="color: #006600;">open</span><span style="color: #66cc66;">&#40;</span> file, FileMode.<span style="color: #006600;">WRITE</span> <span style="color: #66cc66;">&#41;</span>;
	stream.<span style="color: #006600;">writeObject</span><span style="color: #66cc66;">&#40;</span> user <span style="color: #66cc66;">&#41;</span>;
	stream.<span style="color: #0066CC;">close</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
<span style="color: #66cc66;">&#125;</span></pre></div></div>

<p>Pretty familiar if you have worked with the <strong>File</strong> API. Nothing actually new in regards to 4.5, just writing the serializable <strong>CustomUser</strong> object to the application storage directory. It&#8217;s another topic on how to maintain the reference to <em>_currentUser</em>, so for the purposes of this example we&#8217;ll just say that object is available and managed here. If you are familiar with the <strong>File</strong> API, you probably are aware that <strong>CustomUser</strong> needs to be registered with a class alias in order to be properly written to and read back in from the file system as that ActionScript object. That can be achieved by wither declaring a <strong>[RemoteClass]</strong> meta-tag or the <em>registerClassAlias</em>() method. <em>[*Fun fact*: MobileApplication registers the ViewNavigator and NavigationStack classes upon initialization in the </em><em>registerPersistenceClassAliases</em>() method]. Here&#8217;s a quick exmaple of using the <strong>[RemoteClass]</strong> meta:</p>

<div class="wp_syntax"><div class="code"><pre class="actionscript" style="font-family:monospace;">package com.<span style="color: #006600;">custardbelly</span>.<span style="color: #006600;">examples</span>.<span style="color: #006600;">model</span>
<span style="color: #66cc66;">&#123;</span>
	<span style="color: #66cc66;">&#91;</span>RemoteClass<span style="color: #66cc66;">&#40;</span>alias=<span style="color: #ff0000;">&quot;com.custardbelly.examples.model.CustomUser&quot;</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#93;</span>
	<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">class</span> CustomUser
	<span style="color: #66cc66;">&#123;</span>
		<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">var</span> username:<span style="color: #0066CC;">String</span>;
		<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">var</span> <span style="color: #0066CC;">password</span>:<span style="color: #0066CC;">String</span>;
&nbsp;
		<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">function</span> CustomUser<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#123;</span><span style="color: #66cc66;">&#125;</span>
	<span style="color: #66cc66;">&#125;</span>
<span style="color: #66cc66;">&#125;</span></pre></div></div>

<p>One thing to remember when serializing ActionScript objects, don&#8217;t have any non-defaulted constructor parameters. You will get an error when the object is being de-serialized.</p>
<p>Back to the task at hand &#8211; logging a user back into the service on relaunch of the application (start of a new session). In order to do that, the &#8220;restoring&#8221; process of the application needs to be suspended so as to inspect the serialized &#8220;history stack&#8221; and determine if the user is being brought back to the &#8220;login&#8221; view or not. If not, the application should log the user back in and resume to the <strong>View</strong> persisted at the top of the stack from a previous session:</p>

<div class="wp_syntax"><div class="code"><pre class="actionscript" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">// [Sublass of MobileApplication]</span>
&nbsp;
<span style="color: #808080; font-style: italic;">// Event handler for FlexEvent.APPLICATION_RESTORING on MobileApplication</span>
protected <span style="color: #000000; font-weight: bold;">function</span> handleApplicationRestoring<span style="color: #66cc66;">&#40;</span> evt:Event <span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
<span style="color: #66cc66;">&#123;</span>
	<span style="color: #808080; font-style: italic;">// Stop any subsequent work so we can determine if we need to log a user back in. </span>
	evt.<span style="color: #006600;">preventDefault</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
&nbsp;
	<span style="color: #808080; font-style: italic;">// Access the serialized navigator state, maintained between view navigation.</span>
	<span style="color: #000000; font-weight: bold;">var</span> savedState:<span style="color: #0066CC;">Object</span> = persistenceManager.<span style="color: #0066CC;">getProperty</span><span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">&quot;navigatorState&quot;</span><span style="color: #66cc66;">&#41;</span>;
	<span style="color: #808080; font-style: italic;">// Check if the topview from the stack is the view we deliver as the login view.</span>
	<span style="color: #b1b100;">if</span><span style="color: #66cc66;">&#40;</span> topViewIsNotLogIn<span style="color: #66cc66;">&#40;</span> savedState <span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#41;</span>
	<span style="color: #66cc66;">&#123;</span>
		<span style="color: #0066CC;">try</span>
		<span style="color: #66cc66;">&#123;</span>
			<span style="color: #808080; font-style: italic;">// Access a file we serialized to the disk that represents the previously logged-in user.</span>
			<span style="color: #000000; font-weight: bold;">var</span> file:File = File.<span style="color: #006600;">applicationStorageDirectory</span>.<span style="color: #006600;">resolvePath</span><span style="color: #66cc66;">&#40;</span> storedUserFilename <span style="color: #66cc66;">&#41;</span>;
			<span style="color: #000000; font-weight: bold;">var</span> stream:FileStream = <span style="color: #000000; font-weight: bold;">new</span> FileStream<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
			stream.<span style="color: #006600;">open</span><span style="color: #66cc66;">&#40;</span> file, FileMode.<span style="color: #006600;">READ</span> <span style="color: #66cc66;">&#41;</span>;
			<span style="color: #000000; font-weight: bold;">var</span> user:CustomUser = stream.<span style="color: #006600;">readObject</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> as CustomUser;
			<span style="color: #b1b100;">if</span><span style="color: #66cc66;">&#40;</span> user <span style="color: #66cc66;">!</span>= <span style="color: #000000; font-weight: bold;">null</span> <span style="color: #66cc66;">&#41;</span>
			<span style="color: #66cc66;">&#123;</span>
				<span style="color: #808080; font-style: italic;">// Log user back into service.</span>
				<span style="color: #808080; font-style: italic;">// Upon complete, make sure to call:</span>
				<span style="color: #808080; font-style: italic;">// restoreApplicationState();</span>
			<span style="color: #66cc66;">&#125;</span>
		<span style="color: #66cc66;">&#125;</span>
		<span style="color: #0066CC;">catch</span><span style="color: #66cc66;">&#40;</span> <span style="color: #0066CC;">e</span>:<span style="color: #0066CC;">Error</span> <span style="color: #66cc66;">&#41;</span>
		<span style="color: #66cc66;">&#123;</span>
			<span style="color: #808080; font-style: italic;">// Most likely file does not exist.</span>
			restoreApplicationState<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
		<span style="color: #66cc66;">&#125;</span>
	<span style="color: #66cc66;">&#125;</span>
	<span style="color: #b1b100;">else</span>
	<span style="color: #66cc66;">&#123;</span>
		<span style="color: #808080; font-style: italic;">// Else continue on our way.</span>
		restoreApplicationState<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
	<span style="color: #66cc66;">&#125;</span>
<span style="color: #66cc66;">&#125;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">// Determines if the topView in our perstisted stack is not what we consider to be the log in view.</span>
protected <span style="color: #000000; font-weight: bold;">function</span> topViewIsNotLogIn<span style="color: #66cc66;">&#40;</span> savedState:<span style="color: #0066CC;">Object</span> <span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">Boolean</span>
<span style="color: #66cc66;">&#123;</span>
	<span style="color: #b1b100;">if</span><span style="color: #66cc66;">&#40;</span> savedState == <span style="color: #000000; font-weight: bold;">null</span> <span style="color: #66cc66;">&#41;</span> <span style="color: #b1b100;">return</span> <span style="color: #000000; font-weight: bold;">false</span>;
&nbsp;
	<span style="color: #808080; font-style: italic;">// The index within our view stack that we consider as the log in view.</span>
	const loginViewIndex:<span style="color: #0066CC;">int</span> = <span style="color: #cc66cc;">0</span>;
	<span style="color: #808080; font-style: italic;">// The serialized stack.</span>
	<span style="color: #000000; font-weight: bold;">var</span> stack:NavigationStack = savedState.<span style="color: #006600;">navigationStack</span> as NavigationStack;
	<span style="color: #b1b100;">if</span><span style="color: #66cc66;">&#40;</span> stack <span style="color: #66cc66;">!</span>= <span style="color: #000000; font-weight: bold;">null</span> <span style="color: #66cc66;">&#41;</span>
	<span style="color: #66cc66;">&#123;</span>
		use namespace mx_internal;
		<span style="color: #808080; font-style: italic;">// If we have a stack to inspect.</span>
		<span style="color: #b1b100;">if</span><span style="color: #66cc66;">&#40;</span> stack.<span style="color: #006600;">source</span> <span style="color: #66cc66;">&amp;&amp;</span> stack.<span style="color: #006600;">source</span>.<span style="color: #0066CC;">length</span> <span style="color: #66cc66;">&gt;</span> <span style="color: #cc66cc;">0</span> <span style="color: #66cc66;">&#41;</span>
		<span style="color: #66cc66;">&#123;</span>
			<span style="color: #000000; font-weight: bold;">var</span> topView:ViewHistoryData = stack.<span style="color: #006600;">topView</span>;
			<span style="color: #000000; font-weight: bold;">var</span> loginView:ViewHistoryData = stack.<span style="color: #006600;">source</span><span style="color: #66cc66;">&#91;</span>loginViewIndex<span style="color: #66cc66;">&#93;</span> as ViewHistoryData;
			<span style="color: #b1b100;">return</span> <span style="color: #66cc66;">&#40;</span> topView <span style="color: #66cc66;">!</span>= loginView <span style="color: #66cc66;">&#41;</span>;
		<span style="color: #66cc66;">&#125;</span>
	<span style="color: #66cc66;">&#125;</span>
	<span style="color: #b1b100;">return</span> <span style="color: #000000; font-weight: bold;">false</span>;
<span style="color: #66cc66;">&#125;</span></pre></div></div>

<p>One point to grasp is that the event object dispatched for <strong>FlexEvent.APPLICATION_RESTORING</strong> needs to be halted so we can do some work before the <strong>MobileApplication</strong> proceeds with business as usual. That is done by calling <strong>event</strong>.<em>preventDefault</em>(). That actually flips a flag in the -<em>initialize</em>() method of <strong>MobileApplication</strong>, telling it to not proceed with restoring.</p>
<p>The other point, is that, once halted, <strong>MobileApplication</strong>:<em>restoreApplicationState</em>() must be called at a later time in order to proceed with initialization. In this example, if it is determined that the user is being brought to the &#8220;log in&#8221; <strong>View</strong> on re-launch, then the stored user is not logged back in and <em>restoreApplicationState</em>() is invoked to proceed. If it is determined that the user will be taken to another <strong>View</strong>, then log in to the service must be done and, upon success, then invoke <em>restoreApplicationState</em>().</p>
<p>[<strong>Tip</strong>: <em>If you start working with persistent data and you just want to clear it from time to time while developing in order to know that you are working with it properly, call persistenceManager.clear() in your FlexEvent.APPLICATION_RESTORING handler and all your wishes will come true.</em>]</p>
<p>Since Flex 4.5 is beta, you can&#8217;t have an example without seeing use namespace <strong>mx_internal</strong> <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  Half-kidding, but for those unfamiliar with that namespace, some methods and properties in the SDK are declared with the <strong>mx_internal</strong> <em>access specifier</em> to denote that they are in limbo of being given the proper access. So in a later version of the SDK, they may be changed to <em>public</em>, <em>private</em>, <em>protected</em> or any other custom specifier. For this example, in order to access the <em>source</em> property of <strong>NavigationStack</strong> we needed to resolve to <strong>mx_internal</strong>. Hopefully it will be opened up at a later date, or at least a public accessor for that list.</p>
<p>So there you have it. The best practice on notifying the user that you are logging them back into a service upon relaunch? I haven&#8217;t found the best solution that meets my needs yet, but I do not recommend pushing a <strong>View</strong> to the stack of the <strong>ViewNavigator</strong> during that restore suspension. It caused some weird UI glitches. Probably the best bet is to use the <strong>PopUpManager</strong> &#8211; but do not use the <strong>ProgressBar</strong> in that&#8230; bad things happen. Hopefully a new <strong>ProgressBar</strong> is on the horizon for Flex 4.5.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/air/" title="View all posts in AIR" rel="category tag">AIR</a>,  <a href="http://custardbelly.com/blog/category/burrito/" title="View all posts in Burrito" rel="category tag">Burrito</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>,  <a href="http://custardbelly.com/blog/category/flex-4-5/" title="View all posts in Flex 4.5" rel="category tag">Flex 4.5</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2010-11-17T08:16">November 17, 2010</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-231-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-228" class="post-228 post hentry category-air category-flex category-flex-4-5 full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2010/11/15/flex-hero-session-persistent-view-presenters/" title="Permanent link to Flex 4.5 (Hero) &#8211; Session-Persistent View Presenters" rel="bookmark" rev="post-228">Flex 4.5 (Hero) &#8211; Session-Persistent View Presenters</a></h1>
	
	<div class="entry-content full-content">
		<p>As I had hinted at in my <a href="http://custardbelly.com/blog/?p=220" target="_blank">previous post</a>, before i went down the rabbit-hole of state data with regards to the life-cycle of a <strong>View</strong> object, I had intended to write about persisting <a href="http://martinfowler.com/eaaDev/SupervisingPresenter.html" target="_blank">Supervising Presenters</a> for <strong>View</strong>s within an application session. Before I go much farther, i do want to note that <a href="http://blogs.adobe.com/paulw/" target="_blank">Paul Williams</a> has some excellent posts up on different presenter patterns within the context of a Flex application which can be found at <a href="http://blogs.adobe.com/paulw/" target="_blank">http://blogs.adobe.com/paulw/</a>. Specifically, I am taken by the <a href="http://blogs.adobe.com/paulw/archives/2007/10/presentation_pa_2.html" target="_blank">Supervising Presenter</a>, though i am not totally sold&#8230; which I hope to address in this post, but my main intent here is to show how I re-use a presenter for a View object to cut down on memory within an application session.</p>
<p>I may touch upon the life-cycle of a <strong>View</strong> and how state data is maintained in this post, but not to the extent in my <a href="http://custardbelly.com/blog/?p=220">previous article</a>. I want to talk more about moving away from &#8220;<em>code behind</em>&#8221; in Flex-based mobile applications and implementing session-persistent presenters for <strong>View</strong>s.</p>
<p>If you want to skip the yammering, you can view the source of an example here: <a href="http://www.custardbelly.com/downloads/hero/supervisor/" target="_blank">Mobile (Hero) Supervising Presenter Example</a></p>
<h3>New View instance on each request</h3>
<p>Due to the instantiation of a new <strong>View</strong> instance upon each request from the <strong>ViewNavigator</strong> within a <strong>MobileApplication</strong> as discussed in my <a href="http://custardbelly.com/blog/?p=220" target="_blank">previous post</a>, I started really considering my choice to always use what is loosely called <a href="http://ted.onflash.org/2007/02/code-behind-in-flex-2.php" target="_blank">&#8220;<em>code behind</em>&#8221; in Flex</a>. I&#8217;ve always had somewhat of a problem with the implementation but just kept at it because it worked &#8211; separated logic into AS file from view mark-up in MXML &#8211; and (not always a fast and hard rule) don&#8217;t utilize another micro-architecture framework in projects. I&#8217;m not going to get into an argument about frameworks, but let&#8217;s leave it that i don&#8217;t always agree on their necessity when weighed against project requirements, deadlines and multi-developer teams.</p>
<p>So &#8220;<em>code behind</em>&#8221; always was a minor sore point, but it got the job done and got it done in an organized fashion. But I am really taking it into consideration when optimizing applications for the mobile paradigm, mainly inheritance chain. To extend <strong>View</strong> for logic and then extend that view-controller for display again just seems like the wrong choice, especially when <strong>View</strong> is an nth extension of <strong>UIComponent</strong> already and taking in the inheritance memory point described here: <a href="http://help.adobe.com/en_US/flash/cs/using/WSD7F8E1A9-680A-4000-9BA9-D7B01FDD7ECD.html" target="_blank">http://help.adobe.com/en_US/flash/cs/using/WSD7F8E1A9-680A-4000-9BA9-D7B01FDD7ECD.html</a></p>
<p>I started shopping around for <strong>Presenter</strong> patterns that i felt were the least intrusive (as i mentioned before Paul Williams has some great posts up <a href="http://blogs.adobe.com/paulw/" target="_blank">here</a>) and settled on the <strong>Supervising Presenter</strong> at the moment.</p>
<p>Yet, seeing as a <strong>View</strong> is instantiated upon each request from <strong>ViewNavigator</strong>, I wanted to keep the overhead low and ensure that only one <strong>Presenter</strong> was created and associated with a view. In other words, upon the first instantiation of a <strong>View</strong> object, a <strong>Presenter</strong> is created and associated with the view. Upon destruction of the view, the <strong>Presenter</strong> reference is notified to stop supervising and is stored in the state data for that <strong>View</strong> object. When another instance of the <strong>View</strong> is instantiated, that data is read in and the <strong>Presenter</strong> is notified to start supervising again. So now we not only have the logic (depends on *how* much logic you determine necessary) separated from the view, but are re-using the same <strong>Presenter</strong> without having to create a new instance each time a user navigates to that View.</p>
<p>Here are some examples:</p>
<h3>ISupervisingPresenter</h3>

<div class="wp_syntax"><div class="code"><pre class="actionscript" style="font-family:monospace;"><span style="color: #0066CC;">import</span> flash.<span style="color: #006600;">events</span>.<span style="color: #006600;">IEventDispatcher</span>;
<span style="color: #0066CC;">import</span> spark.<span style="color: #006600;">components</span>.<span style="color: #006600;">View</span>;
&nbsp;
<span style="color: #0066CC;">public</span> <span style="color: #0066CC;">interface</span> ISupervisingPresenter <span style="color: #0066CC;">extends</span> IEventDispatcher
<span style="color: #66cc66;">&#123;</span>
	<span style="color: #000000; font-weight: bold;">function</span> supervise<span style="color: #66cc66;">&#40;</span> view:View <span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>;
	<span style="color: #000000; font-weight: bold;">function</span> unsupervise<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>;
	<span style="color: #000000; font-weight: bold;">function</span> dispose<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>;
<span style="color: #66cc66;">&#125;</span></pre></div></div>

<p><strong>ISupervisingPresenter</strong> supervises a single <strong>View</strong> and can be instructed to unsupervise as well as tear down any loose reference to offer itself up for garbage collection.</p>
<h3>ISupervisingPresenter Implementation</h3>

<div class="wp_syntax"><div class="code"><pre class="actionscript" style="font-family:monospace;"><span style="color: #0066CC;">import</span> com.<span style="color: #006600;">custardbelly</span>.<span style="color: #006600;">example</span>.<span style="color: #006600;">event</span>.<span style="color: #006600;">LogInEvent</span>;
<span style="color: #0066CC;">import</span> com.<span style="color: #006600;">custardbelly</span>.<span style="color: #006600;">example</span>.<span style="color: #006600;">views</span>.<span style="color: #006600;">HomeView</span>;
&nbsp;
<span style="color: #0066CC;">import</span> flash.<span style="color: #006600;">events</span>.<span style="color: #006600;">Event</span>;
<span style="color: #0066CC;">import</span> flash.<span style="color: #006600;">events</span>.<span style="color: #006600;">EventDispatcher</span>;
<span style="color: #0066CC;">import</span> flash.<span style="color: #006600;">events</span>.<span style="color: #006600;">MouseEvent</span>;
&nbsp;
<span style="color: #0066CC;">import</span> spark.<span style="color: #006600;">components</span>.<span style="color: #006600;">View</span>;
&nbsp;
<span style="color: #66cc66;">&#91;</span>Event<span style="color: #66cc66;">&#40;</span><span style="color: #0066CC;">name</span>=<span style="color: #ff0000;">&quot;success&quot;</span>, <span style="color: #0066CC;">type</span>=<span style="color: #ff0000;">&quot;com.custardbelly.example.event.LogInEvent&quot;</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#93;</span>
&nbsp;
<span style="color: #66cc66;">&#91;</span>RemoteClass<span style="color: #66cc66;">&#40;</span>alias=<span style="color: #ff0000;">&quot;com.custardbelly.example.presenter.HomePresenter&quot;</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#93;</span>
<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">class</span> HomePresenter <span style="color: #0066CC;">extends</span> EventDispatcher <span style="color: #0066CC;">implements</span> ISupervisingPresenter
<span style="color: #66cc66;">&#123;</span>
	protected <span style="color: #000000; font-weight: bold;">var</span> _view:HomeView;
&nbsp;
	<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">function</span> HomePresenter<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#123;</span><span style="color: #66cc66;">&#125;</span>
&nbsp;
	protected <span style="color: #000000; font-weight: bold;">function</span> addHandlers<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
	<span style="color: #66cc66;">&#123;</span>
		_view.<span style="color: #006600;">logInButton</span>.<span style="color: #006600;">addEventListener</span><span style="color: #66cc66;">&#40;</span> MouseEvent.<span style="color: #006600;">CLICK</span>, handleLogIn, <span style="color: #000000; font-weight: bold;">false</span>, <span style="color: #cc66cc;">0</span>, <span style="color: #000000; font-weight: bold;">true</span> <span style="color: #66cc66;">&#41;</span>;
	<span style="color: #66cc66;">&#125;</span>
&nbsp;
	protected <span style="color: #000000; font-weight: bold;">function</span> removeHandlers<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
	<span style="color: #66cc66;">&#123;</span>
		_view.<span style="color: #006600;">logInButton</span>.<span style="color: #006600;">removeEventListener</span><span style="color: #66cc66;">&#40;</span> MouseEvent.<span style="color: #006600;">CLICK</span>, handleLogIn, <span style="color: #000000; font-weight: bold;">false</span> <span style="color: #66cc66;">&#41;</span>;
	<span style="color: #66cc66;">&#125;</span>
&nbsp;
	protected <span style="color: #000000; font-weight: bold;">function</span> handleLogIn<span style="color: #66cc66;">&#40;</span> evt:Event <span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
	<span style="color: #66cc66;">&#123;</span>
		dispatchEvent<span style="color: #66cc66;">&#40;</span> <span style="color: #000000; font-weight: bold;">new</span> LogInEvent<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#41;</span>;
	<span style="color: #66cc66;">&#125;</span>
&nbsp;
	<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">function</span> supervise<span style="color: #66cc66;">&#40;</span> view:View <span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
	<span style="color: #66cc66;">&#123;</span>
		_view = <span style="color: #66cc66;">&#40;</span> view as HomeView <span style="color: #66cc66;">&#41;</span>;
		addHandlers<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
	<span style="color: #66cc66;">&#125;</span>
&nbsp;
	<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">function</span> unsupervise<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
	<span style="color: #66cc66;">&#123;</span>
		removeHandlers<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
		_view = <span style="color: #000000; font-weight: bold;">null</span>;
	<span style="color: #66cc66;">&#125;</span>
&nbsp;
	<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">function</span> dispose<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
	<span style="color: #66cc66;">&#123;</span>
		<span style="color: #b1b100;">if</span><span style="color: #66cc66;">&#40;</span> _view <span style="color: #66cc66;">&#41;</span> unsupervise<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
		<span style="color: #808080; font-style: italic;">// remove any other references to ensure GC of this instance...</span>
	<span style="color: #66cc66;">&#125;</span>
<span style="color: #66cc66;">&#125;</span></pre></div></div>

<p>When supervising a view, the <strong>ISupervisingPresenter</strong> implementation essentially assigns event handlers to child controls of that target <strong>View</strong>. Its up to you how much logic the ISupervisingPresenter holds. For instance i could forgo dispatching an event and just access the ViewNavigator from the target view and tell it to go to another screen.</p>
<h3>Supervised View</h3>

<div class="wp_syntax"><div class="code"><pre class="mxml" style="font-family:monospace;"><span style="color: #000000;">&lt; ?xml version=<span style="color: #ff0000;">&quot;1.0&quot;</span> encoding=<span style="color: #ff0000;">&quot;utf-8&quot;</span>?<span style="color: #7400FF;">&gt;</span></span>
<span style="color: #000000;">&lt;s :View xmlns:fx=<span style="color: #ff0000;">&quot;http://ns.adobe.com/mxml/2009&quot;</span> </span>
<span style="color: #000000;">		xmlns:s=<span style="color: #ff0000;">&quot;library://ns.adobe.com/flex/spark&quot;</span> </span>
<span style="color: #000000;">		title=<span style="color: #ff0000;">&quot;home&quot;</span> </span>
<span style="color: #000000;">		creationComplete=<span style="color: #ff0000;">&quot;handleCreationComplete();&quot;</span><span style="color: #7400FF;">&gt;</span></span>
&nbsp;
	<span style="color: #000000;">&lt;fx :Script<span style="color: #7400FF;">&gt;</span></span>
		<span style="color: #000000;">&lt; !<span style="color: #66cc66;">&#91;</span>CDATA<span style="color: #66cc66;">&#91;</span></span>
<span style="color: #000000;">			import com.custardbelly.example.event.LogInEvent;</span>
<span style="color: #000000;">			import com.custardbelly.example.presenter.HomePresenter;</span>
<span style="color: #000000;">			import com.custardbelly.example.presenter.ISupervisingPresenter;</span>
&nbsp;
<span style="color: #000000;">			import mx.events.FlexEvent;</span>
&nbsp;
<span style="color: #000000;">			protected var _data:Object;</span>
<span style="color: #000000;">			protected var _presenter:ISupervisingPresenter;</span>
&nbsp;
<span style="color: #000000;">			// Listen for deactivate in order to assemble session data accessed from View:data<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span></span>
<span style="color: #000000;">			protected function handleCreationComplete<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>:void</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#123;</span></span>
<span style="color: #000000;">				addEventListener<span style="color: #66cc66;">&#40;</span> FlexEvent.VIEW_DEACTIVATE, handleDeactivate, false, <span style="color: #cc66cc;">0</span>, true <span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#125;</span></span>
&nbsp;
<span style="color: #000000;">			// Is called before navigator.destroy of this instance. Serialize the data property and clear out refs for GC.</span>
<span style="color: #000000;">			protected function handleDeactivate<span style="color: #66cc66;">&#40;</span> evt:FlexEvent <span style="color: #66cc66;">&#41;</span>:void</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#123;</span></span>
<span style="color: #000000;">				removeEventListener<span style="color: #66cc66;">&#40;</span> FlexEvent.VIEW_DEACTIVATE, handleDeactivate, false <span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">				serializeSessionData<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">				disassemblePresenter<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#125;</span></span>
&nbsp;
<span style="color: #000000;">			// Create the supervising presenter.</span>
<span style="color: #000000;">			protected function  establishPresenter<span style="color: #66cc66;">&#40;</span> value:Object <span style="color: #66cc66;">&#41;</span>:void</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#123;</span></span>
<span style="color: #000000;">				if<span style="color: #66cc66;">&#40;</span> value &amp;&amp; value.hasOwnProperty<span style="color: #66cc66;">&#40;</span> <span style="color: #ff0000;">&quot;presenter&quot;</span> <span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#41;</span></span>
<span style="color: #000000;">				<span style="color: #66cc66;">&#123;</span></span>
<span style="color: #000000;">					_presenter = <span style="color: #66cc66;">&#40;</span> value<span style="color: #66cc66;">&#91;</span><span style="color: #ff0000;">&quot;presenter&quot;</span><span style="color: #66cc66;">&#93;</span> as ISupervisingPresenter <span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">				<span style="color: #66cc66;">&#125;</span></span>
<span style="color: #000000;">				else</span>
<span style="color: #000000;">				<span style="color: #66cc66;">&#123;</span></span>
<span style="color: #000000;">					_presenter = new HomePresenter<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">					if<span style="color: #66cc66;">&#40;</span> value <span style="color: #66cc66;">&#41;</span> value<span style="color: #66cc66;">&#91;</span><span style="color: #ff0000;">&quot;presenter&quot;</span><span style="color: #66cc66;">&#93;</span> = _presenter;</span>
<span style="color: #000000;">				<span style="color: #66cc66;">&#125;</span></span>
&nbsp;
<span style="color: #000000;">				_presenter.supervise<span style="color: #66cc66;">&#40;</span> this <span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">				addPresenterHandlers<span style="color: #66cc66;">&#40;</span> _presenter <span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#125;</span></span>
&nbsp;
<span style="color: #000000;">			// Clear refs for GC of this instance.</span>
<span style="color: #000000;">			protected function disassemblePresenter<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>:void</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#123;</span></span>
<span style="color: #000000;">				removePresenterHandlers<span style="color: #66cc66;">&#40;</span> _presenter <span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">				_presenter.unsupervise<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">				_presenter = null;</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#125;</span></span>
&nbsp;
<span style="color: #000000;">			protected function addPresenterHandlers<span style="color: #66cc66;">&#40;</span> presenter:ISupervisingPresenter <span style="color: #66cc66;">&#41;</span>:void</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#123;</span></span>
<span style="color: #000000;">				presenter.addEventListener<span style="color: #66cc66;">&#40;</span> LogInEvent.SUCCESS, handleLogInSuccess, false, <span style="color: #cc66cc;">0</span>, true <span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#125;</span></span>
<span style="color: #000000;">			protected function removePresenterHandlers<span style="color: #66cc66;">&#40;</span> presenter:ISupervisingPresenter <span style="color: #66cc66;">&#41;</span>:void</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#123;</span></span>
<span style="color: #000000;">				presenter.removeEventListener<span style="color: #66cc66;">&#40;</span> LogInEvent.SUCCESS, handleLogInSuccess, false <span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#125;</span></span>
&nbsp;
<span style="color: #000000;">			// Modify session state data to hold reference to the supervising presenter for re-use.</span>
<span style="color: #000000;">			protected function serializeSessionData<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>:void</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#123;</span></span>
<span style="color: #000000;">				if<span style="color: #66cc66;">&#40;</span> _data == null <span style="color: #66cc66;">&#41;</span> _data = <span style="color: #66cc66;">&#123;</span><span style="color: #66cc66;">&#125;</span>;</span>
<span style="color: #000000;">				_data<span style="color: #66cc66;">&#91;</span><span style="color: #ff0000;">&quot;presenter&quot;</span><span style="color: #66cc66;">&#93;</span> = _presenter;</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#125;</span></span>
&nbsp;
<span style="color: #000000;">			// Navigate to nother view.</span>
<span style="color: #000000;">			protected function handleLogInSuccess<span style="color: #66cc66;">&#40;</span> evt:LogInEvent <span style="color: #66cc66;">&#41;</span>:void</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#123;</span></span>
<span style="color: #000000;">				navigator.pushView<span style="color: #66cc66;">&#40;</span> WelcomeView <span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#125;</span></span>
&nbsp;
<span style="color: #000000;">			// Need to override in order to persist state data through session.</span>
<span style="color: #000000;">			override public function get data<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>:Object</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#123;</span></span>
<span style="color: #000000;">				return _data;</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#125;</span></span>
<span style="color: #000000;">			// Override to read in session state data.</span>
<span style="color: #000000;">			override public function set data<span style="color: #66cc66;">&#40;</span> value:Object <span style="color: #66cc66;">&#41;</span>:void</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#123;</span></span>
<span style="color: #000000;">				_data = value;</span>
<span style="color: #000000;">				establishPresenter<span style="color: #66cc66;">&#40;</span> _data <span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#125;</span></span>
&nbsp;
<span style="color: #000000;">		<span style="color: #66cc66;">&#93;</span><span style="color: #66cc66;">&#93;</span><span style="color: #7400FF;">&gt;</span></span>
	<span style="color: #000000;">&lt;/fx<span style="color: #7400FF;">&gt;</span></span>
&nbsp;
	<span style="color: #000000;">&lt;s :navigationContent <span style="color: #7400FF;">/&gt;</span></span>
&nbsp;
	<span style="color: #000000;">&lt;/s<span style="color: #7400FF;">&gt;</span>&lt;s :layout<span style="color: #7400FF;">&gt;</span></span>
		<span style="color: #000000;">&lt;s :VerticalLayout paddingLeft=<span style="color: #ff0000;">&quot;10&quot;</span> paddingRight=<span style="color: #ff0000;">&quot;10&quot;</span> paddingTop=<span style="color: #ff0000;">&quot;10&quot;</span> paddingBottom=<span style="color: #ff0000;">&quot;10&quot;</span> <span style="color: #7400FF;">/&gt;</span></span>
	<span style="color: #000000;">&lt;/s<span style="color: #7400FF;">&gt;</span></span>
&nbsp;
	<span style="color: #000000;">&lt;s :TextInput id=<span style="color: #ff0000;">&quot;usernameField&quot;</span> width=<span style="color: #ff0000;">&quot;100%&quot;</span> <span style="color: #7400FF;">/&gt;</span></span>
	<span style="color: #000000;">&lt;s :TextInput id=<span style="color: #ff0000;">&quot;passwordField&quot;</span> width=<span style="color: #ff0000;">&quot;100%&quot;</span> displayAsPassword=<span style="color: #ff0000;">&quot;true&quot;</span> <span style="color: #7400FF;">/&gt;</span></span>
	<span style="color: #000000;">&lt;s :Button id=<span style="color: #ff0000;">&quot;logInButton&quot;</span> label=<span style="color: #ff0000;">&quot;log in&quot;</span> <span style="color: #7400FF;">/&gt;</span></span></pre></div></div>

<p>In essence, upon first creation of this <strong>View</strong> instance, the <strong>Supervising Presenter</strong> is created and assigned through a call to the <em>data</em> property setter (invoked by the <strong>ViewNavigator</strong> upon creation of the view). When the view is deactivated (by the <strong>ViewNavigator</strong> before destruction) the view-local <em>_data</em> property is updated to hold a reference to the associated supervising presenter for this view. Upon creation of a new instance, it is read in though the <em>data</em> setter and instructed to begin supervising again.</p>
<p>The <strong>Supervising Presenter</strong> reference is persisted through the current session of the application and re-used upon each new instance of the <strong>View</strong>. Though i do hate using <strong>Script</strong> in MXML, this code does address my concerns in re-use, inheritance and separation of logic while utilizing the session-persistent hook-ins now present in the <strong>View</strong> API in Flex Hero.</p>
<p><a href="http://www.custardbelly.com/downloads/hero/supervisor/" target="_blank">Mobile (Hero) Supervising Presenter Example</a></p>
<p>Now&#8230; i gotta think about getting that <strong>Script</strong> outta my MXML <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/air/" title="View all posts in AIR" rel="category tag">AIR</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>,  <a href="http://custardbelly.com/blog/category/flex-4-5/" title="View all posts in Flex 4.5" rel="category tag">Flex 4.5</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2010/11/15/flex-hero-session-persistent-view-presenters/#comments" rev="post-228"  title="Comment on Flex 4.5 (Hero) &#8211; Session-Persistent View Presenters">3 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2010-11-15T11:54">November 15, 2010</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-228-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-220" class="post-220 post hentry category-air category-burrito category-flash category-flex category-flex-4-5 full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2010/11/15/flex-hero-persistant-data-in-mobileapplication/" title="Permanent link to Flex 4.5 (Hero) &#8211; Persistant Data in MobileApplication" rel="bookmark" rev="post-220">Flex 4.5 (Hero) &#8211; Persistant Data in MobileApplication</a></h1>
	
	<div class="entry-content full-content">
		<p>I had the a great time at <a href="http://riaunleashed.com/" target="_blank"><strong>RIAUnleashed</strong></a> this year and had a chance to check out <a href="http://coenraets.org/" target="_blank">Christophe Coenraet</a>&#8217;s session on <a href="http://labs.adobe.com/technologies/flashbuilder_burrito/" target="_blank">Flex 4 &#8220;Burrito&#8221; and Flex &#8220;Hero&#8221; SDK</a>. An excellent speaker and one I had been hoping to see for some time. His presentation was mainly focused on <strong>Mobile Application</strong> development with <strong>Hero SDK</strong> in <em>&#8220;Burrito&#8221;</em>.</p>
<p><a href="http://coenraets.org/" target="_blank">Christophe</a> gave a great talk and one thing that really stood out to me &#8211; as far as the navigation framework for a Mobile Application in <strong>Hero</strong> &#8211; was how to persist state for a view in as far as the life of the current application session. And it got me thinking about how there really is a difference between persisting data within the session of an application, and persisting data throughout the life (or rather, until the user deletes) your application from their device. I am familiar with &#8211; what i still call (thanks objective-c!) &#8211; &#8220;user prefs&#8221; and session data within the iOS and Android frameworks, but Flex (granted) takes on a different context on how a view is notified of data, both in session and from recovery/restart.</p>
<p>[<strong>[NOTE]</strong> <em>It should be noted that this post will be discussing some of the finer points of the persistant data API available, as of this writing, with the free trial download of <a href="http://labs.adobe.com/technologies/flashbuilder_burrito/" target="_blank">Flash Builder &#8220;Burrito&#8221;</a> and the included Flex SDK Version 4.5.0 build 17689</em>]</p>
<h2>A Brief Rundown</h2>
<h3>View</h3>
<p>A Flex <strong>MobileApplication</strong> is *roughly* made up of multiple <strong>View</strong> objects. Each <strong>View</strong> is pushed on or popped from a history stack depending on the user action. As one <strong>View</strong> is activated, the previous view is deactivated and its state is cached through its <em>data</em> property. Meaning, each time you enter a view, a new instance of it is instantiated and provided a data object through its <strong>IDataRenderer</strong> method implementation of the <em>data</em> attribute. There is much more to a <strong>View</strong>, including its display which was explained in great detail by <a href="http://coenraets.org" target="_blank">Christophe</a>, but for the purposes of this post I just wanted to touch on the importance of the <em>data</em> property of <strong>View</strong> and two additional methods: <em>serializeData</em>() and <em>deserializePersistedData</em>(). Keep those in the back of your mind.</p>
<h3>PeristanceManager</h3>
<p><strong>MobileApplication</strong>, the base view and main application instance used when creating a new <em>Flex Mobile Application</em>, has a <strong>PersistanceManager</strong> member whose primary job is to read and write data to a <strong>Shared Object</strong> and save it on the local disk.</p>
<p><em>Where are those saved?</em></p>
<p><strong>Mac OSX</strong>: /Users/{user}/Library/Preferences/{project.name}/<br />
LocalStore/#SharedObjects/{project.name}.swf/FXAppCache.sol</p>
<p><del datetime="2010-11-23T09:20:56+00:00"><strong>PC</strong>: I don&#8217;t know.</del></p>
<p><strong>PC</strong>: (Window 7): C:\Users\{user}\AppData\Roaming\{project.name}/<br />
LocalStore/#SharedObjects/{project.name}.swf/FXAppCache.sol <em>[ED: Thanks, <a href="http://www.gread.net/devdesign/" target="_blank">Dennis</a>!]</em></p>
<p>Seeing as we are storing data out of the application, when employing the <strong>PersistanceManager</strong> we intend to serialize some state information to be used throughout the life of the application (from installation to un-installation). In order to enable a <strong>MobileApplication</strong> to use persistant data in such a way, you need to set <em>sessionCachingEnabled</em> to <em>true</em>:</p>

<div class="wp_syntax"><div class="code"><pre class="actionscript" style="font-family:monospace;"><span style="color: #66cc66;">&lt;</span>s :MobileApplication xmlns:fx=<span style="color: #ff0000;">&quot;http://ns.adobe.com/mxml/2009&quot;</span> 
					 xmlns:s=<span style="color: #ff0000;">&quot;library://ns.adobe.com/flex/spark&quot;</span> 
					 firstView=<span style="color: #ff0000;">&quot;MyHome&quot;</span> 
					 sessionCachingEnabled=<span style="color: #ff0000;">&quot;true&quot;</span><span style="color: #66cc66;">&gt;</span>
<span style="color: #66cc66;">&lt;/</span>s<span style="color: #66cc66;">&gt;</span></pre></div></div>

<p>In brief, that will enable the application to invoke serialization and deserialization of state data when exiting and entering new <strong>View</strong> instances, respectively; those methods mentioned previously when explaining <strong>View</strong>. Enabling session caching in your <strong>MobileApplication</strong> also allows for event handling of the following events when the application is initializing and deactivated:</p>

<div class="wp_syntax"><div class="code"><pre class="actionscript" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/* dispatched in MobileApplication +initialize() */</span>
FlexEvent.<span style="color: #006600;">APPLICATION_RESTORING</span>
FlexEvent.<span style="color: #006600;">APPLICATION_RESTORE</span>
<span style="color: #808080; font-style: italic;">/* dispatched in MobileApplication -applicationDeactivateHandler() */</span>
FlexEvent.<span style="color: #006600;">APPLICATION_PERSISTING</span>
FlexEvent.<span style="color: #006600;">APPLICATION_PERSIST</span></pre></div></div>

<p>Those events are fired on startup and close of the application. Do with them what you will, but the real magic happens when creating and destroying <strong>View</strong> objects within the <strong>ViewNavigator</strong> of an application session.</p>
<h3>ViewNavigator</h3>
<p>The <strong>ViewNavigator</strong> member of <strong>MobileApplication</strong> is actually a skin part and is instantiated in <em>MobileApplicationSkin.as</em>. It is an ActionScript file in the SDK (as opposed to MXML which most <strong>Spark</strong> skins are) i suppose in the hopes that if you do create a custom skin for <strong>MobileApplication</strong>, you extend <strong>MobileApplicationSkin</strong>. That&#8217;s a whole &#8216;nother topic&#8230; back to the role of <strong>ViewNavigator</strong>. The <strong>ViewNavigator</strong>, while providing some visual elements in relation to action bar content, serves as a manager for a collection of <strong>View</strong> objects. The top-most <strong>View</strong> is visible and active, while any other View objects are represented by a data object. Meaning, each time a <strong>View</strong> is added to the display list (via <em>pushView</em>()), an instance of it its class is instantiated. Each time a <strong>View</strong> is removed from the display list (via <em>popView</em>() or <em>pushView</em>()) its instance is destroyed, but its data model is stored in memory.</p>
<p>It should be noted that once the *first* new instance of a <strong>View</strong> class is instantiated, it is first notified to handle any persistent data (previously serialized) through <strong>View</strong>:<em>deserializePersistedData</em>(). If there is persistent data available, that data is handed along to the new <strong>View</strong> instance through the <em>data</em> property. Any subesequent instantiations of the same <strong>View</strong> class within the same application session will not be requested to deserialize persistent data and will just be given its data model through the <em>data</em> property. The reason being that the the <strong>View</strong> has already been re-activated previously with any persisted data and data currently relates to the session. Now any new state must be updated on the <em>data</em> property for the rest of the application session and if required for restart of the application at a later date.</p>
<p>In order to save session state for a <strong>View</strong>, you must modify the <em>data</em> property. This property will be requested when destroying the current instance of the <strong>View</strong> class. And the <em>data</em> property value will be assigned back to a newly created instance of the same <strong>View</strong> class when navigating back to that view. Behind the scenes is the <strong>ViewHistoryData</strong> model object which, in essence, is keeping track of the <strong>View</strong> class and its factory instance as well as the data model and related persistent data. In fact, by extending <strong>IExternalizable</strong>, it is the <strong>ViewHistoryData</strong> class that handles reading and writing the persistent data to the disk.</p>
<h2>Summary</h2>
<p>In short, persisting data between sessions of an AIR-enabled <strong>MobileApplication</strong> is possible. And the implementation is rather straight forward:</p>
<p>1. View is first created.<br />
2. View is asked to de-serialize persisted data.<br />
3. View is given de-serialized data through its <em>data</em> property.<br />
4. View is later requested to be removed.<br />
5. The data property of the View is accessed and stored.<br />
6. View is asked to serialize any persistent data.<br />
7. View is later created.<br />
8. View is handed the stored data property value.</p>
<p>It is important to note how the progress from step 7 to 8 differs from 1 to 3. Even though the <strong>View</strong> is requested to serialize its data on each removal, it is not necessarily requested to de-serialize on each creation. It gets a little tricky, but the <strong>View</strong> is guaranteed to have <em>deserializePersistedData</em>() invoked on first creation. However, if you override the <em>data</em> property getter in the <strong>View</strong> and return custom data, <em>deserializePersistedData</em>() will not be invoked in following creations.  Subsequent creations are just handed the custom model through its <em>data</em> property. If the <strong>View</strong> does not override the data property getter, then <em>deserializePersistedData</em>() is invoked each time on creation. In most cases, the <strong>View</strong>s i create do override the <em>data</em> property in order to persist session data. This creation>de-serialization/destruction>serialization flow can be a little tricky to wrap the head around, and hopefully i have explained it well enough. Once I got it, I got it.</p>
<p>So application state can be maintained both throughout a session (from open to close) and through the life (from install to uninstall) of an application. Just be sure to properly manage the state data of a <strong>View</strong> class through its <em>serializeData</em>(), <em>deserializePersistantData</em>() method overrides and its <em>data</em> attribute.</p>
<p>I had originally began this article to address how to get away from &#8220;code-behind&#8221; and use the <a href="http://martinfowler.com/eaaDev/SupervisingPresenter.html" target="_target">SupervisingPresenter</a> pattern to drive the logic of a view. This would get away from the notion of subclassing a view-controller for each <strong>View</strong>, and more importantly keep instantiation of the logic controller down by persisting a &#8220;presenter&#8221; instance within a session of the application. I think i am going to push that to another post, so if interested look for that soon.</p>
<p>I hope i explained this stuff coherently. I really enjoyed <a href="http://coenraets.org/" target="_blank">Christophe</a>&#8217;s session and immediately wanted to poke around under the hood. </p>
<p>On a side-note <a href="http://riaunleashed.com/" target="_blank">RIAUnleashed</a> this year was excellent and was <a href="http://www.remotesynthesis.com/" target="_blank">Brian Rinaldi</a>&#8217;s last at running the event. He put together an excellent conference and I don&#8217;t think I am alone in thanking him for bringing so much talent out this way.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/air/" title="View all posts in AIR" rel="category tag">AIR</a>,  <a href="http://custardbelly.com/blog/category/burrito/" title="View all posts in Burrito" rel="category tag">Burrito</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>,  <a href="http://custardbelly.com/blog/category/flex-4-5/" title="View all posts in Flex 4.5" rel="category tag">Flex 4.5</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2010/11/15/flex-hero-persistant-data-in-mobileapplication/#comments" rev="post-220"  title="Comment on Flex 4.5 (Hero) &#8211; Persistant Data in MobileApplication">10 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2010-11-15T06:21">November 15, 2010</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-220-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-217" class="post-217 post hentry category-general full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2010/10/25/as3flobile-update-now-using-as3-signals/" title="Permanent link to as3flobile update: now using as3-signals" rel="bookmark" rev="post-217">as3flobile update: now using as3-signals</a></h1>
	
	<div class="entry-content full-content">
		<p>If you have been following/using <a href="http://github.com/bustardcelly/as3flobile" target="_blank">as3flobile</a>, I just recently committed an update for <a href="http://github.com/bustardcelly/as3flobile" target="_blank">v0.3 to github</a>. The new version now utilizes <a href="http://github.com/robertpenner/as3-signals" target="_blank">as3-signals</a> by <strong><a href="http://robertpenner.com/flashblog/" target="_blank">Robert Penner</a></strong> for assigning delegate handling.</p>
<p>In the previous versions of <a href="http://github.com/bustardcelly/as3flobile" target="_blank">as3flobile</a>, interface delegates were used in order to notify subscribing clients of a change to a control. I knew i did not want to institute event dispatching in <a href="http://github.com/bustardcelly/as3flobile" target="_blank">as3flobile</a> because it was faster to notify a client through a method than going through an observer. So interface delegates were originally used. In basic terms, each control in <a href="http://github.com/bustardcelly/as3flobile" target="_blank">as3flobile</a> declared one or more optional delegates whose method(s) would be invoked when a change to the control had occured. As an example, this was the now deprecated <strong>IButtonDelegate</strong>:</p>

<div class="wp_syntax"><div class="code"><pre class="actionscript" style="font-family:monospace;"><span style="color: #0066CC;">public</span> <span style="color: #0066CC;">interface</span> IButtonDelegate
<span style="color: #66cc66;">&#123;</span>
	<span style="color: #000000; font-weight: bold;">function</span> buttonTapped<span style="color: #66cc66;">&#40;</span> <span style="color: #0066CC;">button</span>:<span style="color: #0066CC;">Button</span> <span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>;
<span style="color: #66cc66;">&#125;</span></pre></div></div>

<p>When a client wanted to subscribe as the delegate for a tap gesture on the <strong>Button</strong>, it would point itself as the delegate for the <strong>Button</strong>:</p>

<div class="wp_syntax"><div class="code"><pre class="actionscript" style="font-family:monospace;"><span style="color: #000000; font-weight: bold;">var</span> <span style="color: #0066CC;">button</span>:<span style="color: #0066CC;">Button</span> = <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #0066CC;">Button</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
<span style="color: #0066CC;">button</span>.<span style="color: #006600;">delegate</span> = <span style="color: #0066CC;">this</span>;
addChild<span style="color: #66cc66;">&#40;</span> <span style="color: #0066CC;">button</span> <span style="color: #66cc66;">&#41;</span>;
&nbsp;
<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">function</span> buttonTapped<span style="color: #66cc66;">&#40;</span> <span style="color: #0066CC;">button</span>:<span style="color: #0066CC;">Button</span> <span style="color: #66cc66;">&#41;</span>
<span style="color: #66cc66;">&#123;</span>
<span style="color: #0066CC;">trace</span><span style="color: #66cc66;">&#40;</span> <span style="color: #ff0000;">&quot;button tapped: &quot;</span> + <span style="color: #0066CC;">button</span> <span style="color: #66cc66;">&#41;</span>;
<span style="color: #66cc66;">&#125;</span></pre></div></div>

<p>I had some issues with this, but i went ahead with that implementation for the first couple versions of <a href="http://github.com/bustardcelly/as3flobile" target="_blank">as3flobile</a>. As far as how this solution stacked up:</p>
<p><strong>Pros:</strong><br />
1. No event system. Faster execution.</p>
<p><strong>Cons:</strong><br />
1. Only one subscribing delegate allowed.<br />
2. No @optional interface method declarations. A delegate had to strictly adhere to the interface and declare all the methods whether or not it cared to handle them.</p>
<p>So the one <strong>Pro</strong> was good, but the 2nd <strong>Con</strong> really started to bother me. In some cases i started adding multiple delegate properties to a control so they could target different changes to the control. Take for instance a delegate for the scroll of a list and a delegate for the selection of a list. It started to feel cumbersome.</p>
<p>Then last week, i finally decide to see what <a href="http://github.com/robertpenner/as3-signals" target="_blank">as3-signals</a> was about. Very intuitive and an excellent library. I was impressed and decided that <a href="http://github.com/robertpenner/as3-signals" target="_blank">as3-signals</a> was a perfect fit for the delegate handling in <a href="http://github.com/robertpenner/as3flobile" target="_blank">as3flobile</a>. So the library has moved to support that. More information is available at <a href="http://github.com/robertpenner/as3flobile" target="_blank">as3flobile on github</a> and <a href="http://github.com/bustardcelly/as3flobile/wiki" target="_blank">its wiki</a>.</p>
<p>As with every project i create that has a dependency on another library, there are now two flavors of the build: <strong>Standalone</strong> and <strong>External</strong>. The <strong>Standalone</strong> is meant as a standalone library with the parts required of the dependency compiled in. The <strong>External</strong> is solely the <a href="http://github.com/bustardcelly/as3flobile" target="blank">as3flobile</a> bits and any personal project using the <strong>External</strong> library will also need to build against the <strong>as3-signals</strong> library. <a href="http://github.com/robertpenner/as3-signals" target="_blank">The as3-signals library can be found on github</a>.</p>
<p>Subsequently, the<a href="http://github.com/bustardcelly/as3flobile-air" target="_blank"> as3flobile-air</a> and <a href="http://github.com/bustardcelly/as3flobile-android" target="_blank">as3flobile-android</a> extensions have been updated due to this change.</p>
<p>So, a big change, i know. But I think a step in the right direction. If you are using <strong>as3flobile</strong>, update and let me know how you feel about this change.</p>
<p><strong><a href="http://flashblog.robertpenner.com/" target="_blank">Robert Penner</a></strong>&#8217;s <a href="http://github.com/robertpenner/as3-signals">as3-signals</a><br />
<a href="http://github.com/bustardcelly/as3flobile">as3flobile on github</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/general/" title="View all posts in General" rel="category tag">General</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2010/10/25/as3flobile-update-now-using-as3-signals/#comments" rev="post-217"  title="Comment on as3flobile update: now using as3-signals">5 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2010-10-25T09:54">October 25, 2010</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-217-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-211" class="post-211 post hentry category-as3 category-flash category-flex category-flex-4 full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2010/10/22/flex-4-suspending-the-first-frame/" title="Permanent link to Flex 4: Suspending the first frame" rel="bookmark" rev="post-211">Flex 4: Suspending the first frame</a></h1>
	
	<div class="entry-content full-content">
		<p>Have you ever wanted to add some extra loading process to the first frame so you can utilize the same <strong>download progress bar</strong> for other things beside <strong>RSL</strong> loading and initialization? Take for instance the desire to append the loading of a <a href="http://www.springactionscript.org/" target="_blank">Spring ActionScript</a> application context to the end of the initial loading process. Well, you can. Or rather, until someone tells me i am a fool, you can.</p>
<p>You can quickly check out the source files for how to do this up on <strong>github</strong> at <a href="http://github.com/bustardcelly/custom-system-manager" target="_blank">http://github.com/bustardcelly/custom-system-manager</a> and/or you can keep reading to find out more&#8230;</p>
<p>The main reason i started looking in to suspending the first frame in <strong>SystemManager</strong> in order to perform some other essential loading tasks is generally my dislike for seeing the download progress bar AND THEN seeing another loading bar once the application is initialized and on the display. Say for instance, your application needed to load some extra configurations or assets or what have you. It always bothered me that, as a user, i see the initial download progress bar of the Flex Application and, when complete, i see another one. The second one is usually designed differently, which is incongruent with my experience BUT if both loaders were designed the same, i am presented <em>TWO</em>. I see one, it goes away. I see another. Not a good user experience.</p>
<p>I wanted to hook into that first frame in <strong>SystemManager</strong> and keep loading what was essential for my application to run. From start up.</p>
<p><strong>Why do you keep talking about frames?</strong></p>
<p>If you are unfamiliar about the <a href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/mx/managers/SystemManager.html" target="_blank"><strong>SystemManager</strong></a> and the loading and initialization of a <strong>Flex Application</strong>, there is some really <a href="http://flexblog.faratasystems.com/2006/08/02/systemmanager-and-application-initialization" target="_blank">great stuff</a> out there that describes it. Particularly <a href="http://iamdeepa.com/blog/?p=11" target="_blank">this post</a> from <a href="http://iamdeepa.com/blog" target="_blank">Deepa Subramaniam</a>. But basically, a <strong>Flex Application</strong> is a two-frame SWF. The first frame is ruled by the <strong>SystemManager</strong> which goes about, among other things, tracking the load progress of the framework <strong>RSL</strong>s and the application code and presenting that (<em>at least the application code loading by default</em>) visually in a <strong>SparkDownloadProgressBar</strong> (if using <strong>Spark Application</strong> from Flex 4).</p>
<p>The API allows for customizing the <strong>download progress bar</strong>, and if you are unfamiliar with how that can be done, there are also great articles out there about that. In particular, i will point you to <a href="http://jessewarden.com/2007/07/making-a-cooler-preloader-in-flex-part-1-of-3.html" target="_blank">Jesse Warden&#8217;s post</a>, this one by <a href="http://renaun.com/blog/2010/08/using-flex-hero-rsl-enhancements/" target="_blank">Renaun Erickson</a>, and this one by <a href="http://www.developmentarc.com/site/2010/09/rsl-calculations-new-flex-4-preloader" target="_blank">James Polanco</a>. All great stuff and informative reading. And <em>please, please, please</em> make sure you update your custom progress bar to display progress on loading the <strong>RSL</strong>s.</p>
<p>The problem is that i don&#8217;t care about customizing the preloader (well actually, I DO, and you should too. Or i will come over there personally and give you the sad-face). The problem is that there are no hooks available to pause the preloader to perform other tasks. Meaning all the protected methods opened up in the <strong>DownloadProgressBar</strong> of the Flex 4 SDK have no way of suspending the first frame by preventing the default action. You can call <strong>event.preventDefault()</strong> and <strong>event.stopPropegation()</strong> all you want in the protected event handlers available, but they won&#8217;t keep the <strong>SystemManager</strong> from moving forward when it has finished loading the application code. (At least, i haven&#8217;t been able to).</p>
<p>But fear not, there is a way to suspend that frame. The code to do it is up on github at <a href="http://github.com/bustardcelly/custom-system-manager" target="_blank">http://github.com/bustardcelly/custom-system-manager</a>. </p>
<p><strong>The basics?</strong></p>
<p>I created a subclass of <strong>SystemManager</strong> and overrode the <strong>mx_internal</strong> event handler <em>preloader_completeHandler()</em>. This method is generally called after all the <strong>RSL</strong>s and framework code is loaded in to the SWF. Within <strong>SystemManager</strong>, this would move on towards initializing all the other goodies available from <strong>SystemManager</strong> (including all the <strong>[Mixin] init()</strong> calls if you defined them in you application) by invoking <em>kickOff()</em>. By extending <strong>SystemManager</strong> and overriding <em>preloader_completeHandler()</em> we can suspend that call to <em>kickOff()</em> and notify our custom downloader that the frame is now suspended and we can do some custom loading:</p>

<div class="wp_syntax"><div class="code"><pre class="actionscript" style="font-family:monospace;"><span style="color: #66cc66;">&#91;</span>Event<span style="color: #66cc66;">&#40;</span><span style="color: #0066CC;">name</span>=<span style="color: #ff0000;">&quot;frameSuspended&quot;</span>, <span style="color: #0066CC;">type</span>=<span style="color: #ff0000;">&quot;com.custardbelly.application.event.CustomSystemManagerEvent&quot;</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#93;</span>
<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">class</span> CustomSystemManager <span style="color: #0066CC;">extends</span> SystemManager <span style="color: #0066CC;">implements</span> ICustomSystemManager
<span style="color: #66cc66;">&#123;</span>
	protected <span style="color: #000000; font-weight: bold;">var</span> _resumable:<span style="color: #0066CC;">Boolean</span>;		
	<span style="color: #808080; font-style: italic;">/**
	 * Constructor.
	 */</span>
	<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">function</span> CustomSystemManager<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#123;</span> <span style="color: #0066CC;">super</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>; <span style="color: #66cc66;">&#125;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/**
	 * @inherit
	 */</span>
	override mx_internal <span style="color: #000000; font-weight: bold;">function</span> docFrameHandler<span style="color: #66cc66;">&#40;</span> event:Event = <span style="color: #000000; font-weight: bold;">null</span> <span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
	<span style="color: #66cc66;">&#123;</span>	
		<span style="color: #808080; font-style: italic;">// Override to protected flag to recognize to continue kickoff.</span>
		<span style="color: #b1b100;">if</span><span style="color: #66cc66;">&#40;</span> _resumable <span style="color: #66cc66;">&#41;</span>
			kickOff<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
	<span style="color: #66cc66;">&#125;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/**
	 * @inherit
	 */</span>
	override mx_internal <span style="color: #000000; font-weight: bold;">function</span> preloader_completeHandler<span style="color: #66cc66;">&#40;</span> event:Event <span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
	<span style="color: #66cc66;">&#123;</span>
		<span style="color: #808080; font-style: italic;">// Override to stop super operation and dispatch a frame suspension event for any handling clients.</span>
		preloader.<span style="color: #006600;">removeEventListener</span><span style="color: #66cc66;">&#40;</span> Event.<span style="color: #006600;">COMPLETE</span>, preloader_completeHandler <span style="color: #66cc66;">&#41;</span>;
		preloader.<span style="color: #006600;">dispatchEvent</span><span style="color: #66cc66;">&#40;</span> <span style="color: #000000; font-weight: bold;">new</span> CustomSystemManagerEvent<span style="color: #66cc66;">&#40;</span> <span style="color: #0066CC;">this</span> <span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#41;</span>;
	<span style="color: #66cc66;">&#125;</span>		
&nbsp;
	<span style="color: #808080; font-style: italic;">/**
	 * @inherit
	 */</span>
	<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">function</span> resumeNextFrame<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
	<span style="color: #66cc66;">&#123;</span>
		<span style="color: #b1b100;">if</span><span style="color: #66cc66;">&#40;</span> currentFrame <span style="color: #66cc66;">&gt;</span>= <span style="color: #cc66cc;">2</span> <span style="color: #66cc66;">&#41;</span>
		<span style="color: #66cc66;">&#123;</span>
			_resumable = <span style="color: #000000; font-weight: bold;">true</span>;
			kickOff<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
		<span style="color: #66cc66;">&#125;</span>
	<span style="color: #66cc66;">&#125;</span>
<span style="color: #66cc66;">&#125;</span></pre></div></div>

<p>Now, it should be noted that it&#8217;s not always the best idea to override <strong>mx_internal</strong> methods from the SDK. From my understanding, properties and methods marked as <strong>mx_internal</strong> basically mean they are in limbo of either being removed or declared with their proper access specifier at a later version in the SDK. So be wary. This all works now, but it may no longer work when building against future version of the <strong>Flex SDK</strong>&#8230; <em>unless they open these methods up as protected!</em></p>
<p>In any event, this stops the SWF from progress on to displaying the load of the application code and allows any client (most often your custom <strong>DownloadProgressBar</strong>) listening for the event of suspension to do whatever it needs to:</p>

<div class="wp_syntax"><div class="code"><pre class="actionscript" style="font-family:monospace;"><span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">class</span> CustomPreloader <span style="color: #0066CC;">extends</span> SparkDownloadProgressBar
<span style="color: #66cc66;">&#123;</span>
	protected <span style="color: #000000; font-weight: bold;">var</span> _customSystemManager:ICustomSystemManager;
&nbsp;
	<span style="color: #808080; font-style: italic;">/**
	 * Constructor.
	 */</span>
	<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">function</span> CustomPreloader<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#123;</span> <span style="color: #0066CC;">super</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>; <span style="color: #66cc66;">&#125;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/**
	 * @inherit
	 */</span>
	override <span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">function</span> <span style="color: #0066CC;">set</span> preloader<span style="color: #66cc66;">&#40;</span> value:Sprite <span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
	<span style="color: #66cc66;">&#123;</span>
		<span style="color: #0066CC;">super</span>.<span style="color: #006600;">preloader</span> = value;
		<span style="color: #808080; font-style: italic;">// Add listener for frame suspension from preloader. </span>
                <span style="color: #808080; font-style: italic;">// The ICustomSystemManager will dispatch this event through the preloader for stalling the 1st frame.</span>
		value.<span style="color: #006600;">addEventListener</span><span style="color: #66cc66;">&#40;</span> CustomSystemManagerEvent.<span style="color: #006600;">FRAME_SUSPENDED</span>, handleFrameSuspension <span style="color: #66cc66;">&#41;</span>;
	<span style="color: #66cc66;">&#125;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/**
	 * @private 
	 * 
	 * Abstract method to be override by subclass in order to perform any operations during the suspension of the 1st frame.
	 * In order to resume movement to the 2nd frame, the subclass must call resumeInitialization().
	 */</span>
	protected <span style="color: #000000; font-weight: bold;">function</span> onFrameSuspension<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
	<span style="color: #66cc66;">&#123;</span>
		<span style="color: #808080; font-style: italic;">// abstract method.</span>
		<span style="color: #808080; font-style: italic;">// Override to perform any other initialization tasks on the first frame.</span>
	<span style="color: #66cc66;">&#125;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/**
	 * @private 
	 * 
	 * Invokes the ICustomSystemManager to resume its loading and movement to the 2nd frame.
	 */</span>
	protected <span style="color: #000000; font-weight: bold;">function</span> resumeInitialization<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
	<span style="color: #66cc66;">&#123;</span>
		_customSystemManager.<span style="color: #006600;">resumeNextFrame</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
	<span style="color: #66cc66;">&#125;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/**
	 * @private
	 * 
	 * Event handler for frame suspension from the ICustomSystemManager. 
	 * @param evt CustomSystemManagerEvent
	 */</span>
	protected <span style="color: #000000; font-weight: bold;">function</span> handleFrameSuspension<span style="color: #66cc66;">&#40;</span> evt:CustomSystemManagerEvent <span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
	<span style="color: #66cc66;">&#123;</span>
		<span style="color: #66cc66;">&#40;</span> evt.<span style="color: #0066CC;">target</span> as IEventDispatcher <span style="color: #66cc66;">&#41;</span>.<span style="color: #006600;">removeEventListener</span><span style="color: #66cc66;">&#40;</span> CustomSystemManagerEvent.<span style="color: #006600;">FRAME_SUSPENDED</span>, handleFrameSuspension <span style="color: #66cc66;">&#41;</span>;
		_customSystemManager = evt.<span style="color: #006600;">manager</span>;
		onFrameSuspension<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
	<span style="color: #66cc66;">&#125;</span>
<span style="color: #66cc66;">&#125;</span></pre></div></div>

<p>Now, all this is only possible if we specify the <strong>CustomSystemManager</strong> as the stand-in for the default <strong>SystemManager</strong>&#8230; But this is all before the loading of the application code, so we can just define a new <strong>SystemManager</strong> in our application. Well, not directly in a method anyway.</p>
<p><strong>The [Frame] Metdata</strong></p>
<p>In general terms the <strong>[Frame]</strong> metdata defines the factory instance used in initialization of your SWF file. By default, this points to the <strong>SystemManager</strong> of the SDK and you can see that declaration if you opened up the <strong>Spark Application</strong> class in any IDE. I won&#8217;t go more into detail about <strong>[Frame]</strong> as there are many great articles out there, and in particular, these posts by <a href="http://blogs.adobe.com/rgonzalez/2006/06/modular_applications_part_2.html" target="_blank">Roger Gonzalez</a> and the always lovable <a href="http://www.bit-101.com/blog/?p=946" target="_blank">Keith Peters</a>. I will however talk about how you need to declare <strong>[Frame]</strong> in your Flex application.</p>
<p><b>YOU CAN&#8217;T DO IT IN THE MXML.</b></p>
<p>Meaning that you can&#8217;t define <strong>[Frame]</strong> in the <em>&lt;Metadata/&gt;</em> declaration. You can only define the <strong>[Frame]</strong> in ActionScript else it won&#8217;t work. YET, you can only define your preloader in the MXML, else that won&#8217;t work. Confusing yet? Any way, that&#8217;s the case. Make sure you main application class is in ActionScript and declare the metadata in that file:</p>

<div class="wp_syntax"><div class="code"><pre class="actionscript" style="font-family:monospace;"><span style="color: #66cc66;">&#91;</span>Frame<span style="color: #66cc66;">&#40;</span>factoryClass=<span style="color: #ff0000;">&quot;com.custardbelly.application.CustomSystemManager&quot;</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#93;</span></pre></div></div>

<p>&#8230; and then extend that main AS file in your main MXML view and define the preloader instance:</p>

<div class="wp_syntax"><div class="code"><pre class="actionscript" style="font-family:monospace;"><span style="color: #66cc66;">&amp;</span>lt;Main xmlns=<span style="color: #ff0000;">&quot;*&quot;</span>
	xmlns:fx=<span style="color: #ff0000;">&quot;http://ns.adobe.com/mxml/2009&quot;</span> 
	xmlns:s=<span style="color: #ff0000;">&quot;library://ns.adobe.com/flex/spark&quot;</span> 
	xmlns:mx=<span style="color: #ff0000;">&quot;library://ns.adobe.com/flex/mx&quot;</span>
	preloader=<span style="color: #ff0000;">&quot;com.custardbelly.manager.example.CustomContextPreloader&quot;</span><span style="color: #66cc66;">&amp;</span>gt;</pre></div></div>

<p>There you go, you are all set. <strong>CustomSystemManager</strong> is now your stand-in for the initialization process and suspends the first frame, notifying the <em>concrete</em> <strong>CustomPreloader</strong> to perform some extra tasks, which in turn tells the <strong>CustomSystemManager</strong> that is okay to continue onto the next frame once it has finished its task(s).</p>
<p>I would have posted an example SWF here, but it would have been a moot point as it would have loaded already by the time you arrived all the way down here <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  So one is available here: <a href="http://www.custardbelly.com/examples/csm/index.html" target="_blank">http://www.custardbelly.com/examples/csm/index.html</a> with source view here: <a href="http://www.custardbelly.com/examples/csm/srcview/" target="_blank">http://www.custardbelly.com/examples/csm/srcview/</a>.</p>
<p>It&#8217;s not terribly exciting, but in that example i am basically loading a <a href="http://www.springactionscript.org/" target="_blank">Spring ActionScript</a> application context file. I wanted to hook into the initial load progress as the<strong> IoC container</strong> was an essential part of my application. And, as i said before, i hate seeing the initial progress bar and then another progress bar after application create. I just want one.</p>
<p>Once the application code is loaded and the <strong>Flex Application</strong> receives a <em>CREATION_COMPLETE</em> event, a custom style manager defined in the application context is accessed from the <strong>IoC container</strong> and a <a href="http://github.com/bustardcelly/flex-runtime-css" target="_blank">Runtime CSS SWF</a> is loaded, after which the font-size is updated on the <strong>Label</strong> field. Incredible, no? Not really, but you can see where this example can go, hopefully.</p>
<p>One thing to note, if you will use this to load a <a href="http://www.springactionscript.org/" target="_blank">Spring ActionScript</a> application context file as i have done, you MUST use the <strong>XMLApplicationContext</strong> class and NOT the <strong>FlexXMLApplicationContext</strong> class from <a href="http://www.springactionscript.org/" target="_blank">Spring ActionScript</a>. The reason is that <strong>FlexXMLApplicationContext</strong> accesses a reference to Application upon initialization. Since we haven&#8217;t finished loading the Application code in the <strong>CustomSystemManager</strong>, this access will throw a null pointer exception.</p>
<p>Also, if i am totally off-base on all this, please leave a comment and let me know.</p>
<p>The files for all this, including the example, can be found on github: <a href="http://github.com/bustardcelly/custom-system-manager">http://github.com/bustardcelly/custom-system-manager</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>,  <a href="http://custardbelly.com/blog/category/flex-4/" title="View all posts in Flex 4" rel="category tag">Flex 4</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2010/10/22/flex-4-suspending-the-first-frame/#comments" rev="post-211"  title="Comment on Flex 4: Suspending the first frame">7 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2010-10-22T09:31">October 22, 2010</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-211-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-205" class="post-205 post hentry category-flash category-flex category-flex-runtime-css full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2010/10/20/flex-4-and-runtime-style-sheets/" title="Permanent link to Flex 4 and Runtime style sheets" rel="bookmark" rev="post-205">Flex 4 and Runtime style sheets</a></h1>
	
	<div class="entry-content full-content">
		<p>I just put up some files on <a href="http://github.com/bustardcelly/" target="_blank">github</a> under the project name <a href="http://github.com/bustardcelly/flex-runtime-css" target="_blank"><strong>flex-runtime-css</strong></a>. Perhaps it is a misnomer if people are coming to see how to load and parse CSS files (there&#8217;s already the <a href="http://github.com/theflashbum/fcss" target="_blank">great <strong>F*CSS</strong> library</a> out there for that). The <strong>flex-runtime-css</strong> project is intended to address a problem i saw when generating a <strong>Runtime CSS SWF</strong> to be loaded in a <strong>Flex Application</strong>.</p>
<p>Sometimes a project calls for loading in CSS at runtime rather than compiling the style sheets in. Often enough this is due to a project requirement to have dynamic styling/skinning based on separate client vendors, <em>yadda-yadda</em>. To generate these <strong>Runtime CSS SWF</strong> files i use the <strong>Adobe MXMLC</strong> compiler tool from the <strong>Flex SDK</strong>. If you are unfamiliar about how to generate a <strong>CSS SWF</strong> or how to load in the <strong>SWF</strong> at runtime for style declarations, you can visit the the <strong>Adobe live docs</strong> on the subject at <a href="http://livedocs.adobe.com/flex/3/html/help.html?content=styles_10.html" target="_blank">http://livedocs.adobe.com/flex/3/html/help.html?content=styles_10.html</a>.</p>
<p>The problem i was running is that the default <strong>flex-config</strong> used by the <strong>MXMLC</strong> tool in <strong>Flex 4</strong> now links against several <strong>RSL</strong>s. I won&#8217;t go into a discussion of <strong>RSL</strong>s, but the reason for this is lower application size. That&#8217;s great for an application, but unnecessary when generating a <strong>CSS SWF</strong>. In fact, if you generated a <strong>CSS SWF</strong> using the default <strong>flex-config</strong> via the following command:</p>

<div class="wp_syntax"><div class="code"><pre class="actionscript" style="font-family:monospace;"><span style="color: #66cc66;">&gt;</span> mxmlc MyStyle.<span style="color: #006600;">css</span></pre></div></div>

<p>&#8230; your generated <strong>CSS SWf</strong> file will request those <strong>RSL</strong>s when loaded into the application via the <strong>StyleManager</strong>. Unnecessary overhead as they those <strong>RSL</strong>s are already in the application domain and the request becomes moot.</p>
<p>So, long story long, <strong><a href="http://github.com/bustardcelly/flex-runtime-css" target="_blank">flex-runtime-css</a></strong> intends to address this issue by providing a custom configuration that does away with the <strong>RSL</strong> linking and externally compiles against the framework libraries. A <strong>CSS SWF</strong> can be generated using the <strong>flex-runtime-css</strong> files and ANT. If you use the <strong><a href="http://github.com/bustardcelly/flex-runtime-css" taget="_blank">flex-runtime-css</a></strong> you will need to update the build.properties file included in the project to point to the <strong>Flex SDK</strong> and file resources on your local disk.</p>
<p><a href="http://github.com/bustardcelly/flex-runtime-css">flex-runtime-css on github</a>.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>,  <a href="http://custardbelly.com/blog/category/flex-runtime-css/" title="View all posts in flex-runtime-css" rel="category tag">flex-runtime-css</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2010/10/20/flex-4-and-runtime-style-sheets/#comments" rev="post-205"  title="Comment on Flex 4 and Runtime style sheets">9 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2010-10-20T14:53">October 20, 2010</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-205-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-199" class="post-199 post hentry category-android category-flash category-as3flobile category-as3flobile-android full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2010/10/20/as3flobile-extension-as3flobile-android/" title="Permanent link to as3flobile extension: as3flobile-android" rel="bookmark" rev="post-199">as3flobile extension: as3flobile-android</a></h1>
	
	<div class="entry-content full-content">
		<p>I just made an initial commit to <a href="http://github.com/bustardcelly/" target="_blank">github</a> with an <a href="http://github.com/bustardcelly/as3flobile" target="_blank"><strong>as3flobile</strong> library</a> extension named <a href="http://github.com/bustardcelly/as3flobile-android" target="_blank"><strong>as3flobile-android</strong></a>. </p>
<p><a href="http://github.com/bustardcelly/as3flobile-android" target="_blank"><img src="http://custardbelly.com/blog/images/as3flobile_android.png" alt="as3flobile-android" /></a></p>
<p>The intent of <strong>as3flobile-android</strong> is to provide custom skins and controls that target the look-and-feel of the <strong>Android</strong> platform. Currently within the library are graphic assets, custom skins and a few *convenience* controls which are composite controls that extend their <strong>as3flobile</strong> counterpart with the skinning already wired up (take for instance the <strong>AndroidScrollList</strong> which extends <strong>ScrollList</strong> to provide custom item renderers and skins that have the look-and-feel of the Android list &#8211; also has the precense of scrollbars on scroll behaviour!).</p>
<p>Now, it should be said, i didn&#8217;t go all out and study/push every pixel to make the skins look *exactly* like <strong>Android</strong>. I just cut some graphics from a PSD and applied them in the skins. This is a project (of many) that i do on my spare time and if/when i do need to have themed rolled in for a paying client, i am sure a designer wold be breathing down my neck <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  That said, If at the very least, it will provide an example  to anyone who is interested applying custom skins to <strong>as3flobile</strong> components. </p>
<p>It should be noted (as it also is in the <strong>README</strong> markdown for the<strong> as3flobile-android</strong> repository) that I cut the graphics from a PSD made available by <strong>Pavel Macek</strong>. That PSD can be found at <a href="http://www.matcheck.cz/androidguipsd/" target="_blank">http://www.matcheck.cz/androidguipsd/</a> so check it out. The library also includes the <strong>ScaleBitmap</strong> from <a href="http://www.bytearray.org">bytearray.org</a>, available at <a href="http://www.bytearray.org/?p=118" target="_blank">http://www.bytearray.org/?p=118</a> and is pretty awesome. I made a slight modification to the source in order to re-use graphics in the skins (details can be found in the <strong>CHANGES</strong> document) so i could not have it external and compiles against.</p>
<p>There are a few more custom controls targeting the Android platform that i have yet to check in as i would like to drum up some examples before then. These include things like a <strong>ContextMenu</strong>, <strong>AlertDialog</strong>, <strong>TitleBar</strong>, etc. And most likely the <strong>Menu</strong> control from as3flobile will be moved to <strong><a href="http://github.com/bustardcelly/as3flobile-android" target="_blank">as3flobile-android</a></strong> as it really is Android specific&#8230; so look out for that.</p>
<p>Criticism and feedback is always welcome.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/android/" title="View all posts in Android" rel="category tag">Android</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/as3flobile/" title="View all posts in as3flobile" rel="category tag">as3flobile</a>,  <a href="http://custardbelly.com/blog/category/as3flobile-android/" title="View all posts in as3flobile-android" rel="category tag">as3flobile-android</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2010/10/20/as3flobile-extension-as3flobile-android/#comments" rev="post-199"  title="Comment on as3flobile extension: as3flobile-android">3 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2010-10-20T11:04">October 20, 2010</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-199-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-194" class="post-194 post hentry category-android full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2010/10/01/timers-in-android/" title="Permanent link to Timers in Android" rel="bookmark" rev="post-194">Timers in Android</a></h1>
	
	<div class="entry-content full-content">
		<p>Thought i&#8217;d make a quick post as part of a reminder for me or for those coming from ActionScript to <strong>Android</strong> and wondering how to create a <strong>Timer</strong>. It&#8217;s no secret but took me some searching to find (what i think is) the correct way to use timers in Android while i was working on some stuff for <a href="http://custardbelly.com/blog/?p=191" target="_blank"><strong>MassRoute</strong></a>.</p>
<p>Within the <strong>Android SDK</strong> there is a <strong>Handler</strong> class. I won&#8217;t go into the specifics of Handler as there is a pretty good explanation within the <a href="http://developer.android.com/reference/android/os/Handler.html" target="_blank">documentation</a>, but the basics is that you pass a <strong>Runnable</strong> object that will be invoked at a given time.</p>
<p><em>To run the timer once:</em></p>

<div class="wp_syntax"><div class="code"><pre class="actionscript" style="font-family:monospace;">protected Handler taskHandler = <span style="color: #000000; font-weight: bold;">new</span> Handler<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
protected <span style="color: #0066CC;">void</span> setTimer<span style="color: #66cc66;">&#40;</span> long <span style="color: #0066CC;">time</span> <span style="color: #66cc66;">&#41;</span>
<span style="color: #66cc66;">&#123;</span>
    Runnable t = <span style="color: #000000; font-weight: bold;">new</span> Runnable<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#123;</span>
	<span style="color: #0066CC;">public</span> <span style="color: #0066CC;">void</span> run<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>
	<span style="color: #66cc66;">&#123;</span>
		runNextTask<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
	<span style="color: #66cc66;">&#125;</span>
    <span style="color: #66cc66;">&#125;</span>;
    taskHandler.<span style="color: #006600;">postAtTime</span><span style="color: #66cc66;">&#40;</span> t, <span style="color: #0066CC;">time</span> <span style="color: #66cc66;">&#41;</span>;
<span style="color: #66cc66;">&#125;</span>
&nbsp;
protected <span style="color: #0066CC;">void</span> runNextTask<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>
<span style="color: #66cc66;">&#123;</span>
    <span style="color: #808080; font-style: italic;">// run my task.</span>
<span style="color: #66cc66;">&#125;</span></pre></div></div>

<p>[<strong>UPDATE 10/20/2010</strong>: After talking with <a href="http://jessefreeman.com/" target="_blank">Jesse Freeman</a> over continuous delayed timers in using Runnable in Android development, we discovered that the previous solution didn't quite go the whole mile. This example has been updated to provide a continuous delayed timer that stops based on a flag]</p>
<p><em>To run the timer continuously at a given time:</em></p>

<div class="wp_syntax"><div class="code"><pre class="actionscript" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">// -- Class Members --</span>
protected Handler taskHandler = <span style="color: #000000; font-weight: bold;">new</span> Handler<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
protected <span style="color: #0066CC;">Boolean</span> isComplete = <span style="color: #000000; font-weight: bold;">false</span>;
&nbsp;
<span style="color: #808080; font-style: italic;">// -- Set Timer --</span>
protected <span style="color: #0066CC;">void</span> setTimer<span style="color: #66cc66;">&#40;</span> long <span style="color: #0066CC;">time</span> <span style="color: #66cc66;">&#41;</span>
<span style="color: #66cc66;">&#123;</span>
    final long elapse = <span style="color: #cc66cc;">1000</span>;
    Runnable t = <span style="color: #000000; font-weight: bold;">new</span> Runnable<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#123;</span>
        <span style="color: #0066CC;">public</span> <span style="color: #0066CC;">void</span> run<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>
        <span style="color: #66cc66;">&#123;</span>
            runNextTask<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
            <span style="color: #b1b100;">if</span><span style="color: #66cc66;">&#40;</span> <span style="color: #66cc66;">!</span>isComplete <span style="color: #66cc66;">&#41;</span>
            <span style="color: #66cc66;">&#123;</span>
                _taskHandler.<span style="color: #006600;">postDelayed</span><span style="color: #66cc66;">&#40;</span> <span style="color: #0066CC;">this</span>, elapse <span style="color: #66cc66;">&#41;</span>;
            <span style="color: #66cc66;">&#125;</span>
        <span style="color: #66cc66;">&#125;</span>
    <span style="color: #66cc66;">&#125;</span>;
	_taskHandler.<span style="color: #006600;">postDelayed</span><span style="color: #66cc66;">&#40;</span> t, elapse <span style="color: #66cc66;">&#41;</span>;
<span style="color: #66cc66;">&#125;</span>
&nbsp;
protected <span style="color: #0066CC;">void</span> runNextTask<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>
<span style="color: #66cc66;">&#123;</span>
    <span style="color: #808080; font-style: italic;">// run my task.</span>
    <span style="color: #808080; font-style: italic;">// determine isComplete.</span>
<span style="color: #66cc66;">&#125;</span></pre></div></div>

		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/android/" title="View all posts in Android" rel="category tag">Android</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2010/10/01/timers-in-android/#comments" rev="post-194"  title="Comment on Timers in Android">3 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2010-10-01T09:19">October 1, 2010</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-194-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-191" class="post-191 post hentry category-android category-massroute full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2010/09/29/massroute-android-app-on-github/" title="Permanent link to MassRoute &#8211; Android app on github" rel="bookmark" rev="post-191">MassRoute &#8211; Android app on github</a></h1>
	
	<div class="entry-content full-content">
		<p>While delving into <a href="http://custardbelly.com/blog/?p=173">Flash development targeting the mobile web</a>, i have been using my Nexus One on a daily basis. Though i still go back and forth with switching my SIM card from the iPhone to N1 and back again (can&#8217;t give up the iPhone), i decided to also get my hands dirty with the <strong>Android SDK</strong> and build an application written in Java.</p>
<p><strong>MassRoute</strong> is now <a href="http://github.com/bustardcelly/MassRoute">up on github</a> and is an application that consumes the real-time transit data available from the Massachusetts Department of Transportation.</p>
<p>This is one of my go-to applications when discovering new languages as it covers a lot of basics, from UI to web services to data storage. I actually wrote a similar application in <strong>Objective-C</strong> last year but never thought it looked pretty enough to submit to the store. ah well. In any event, i threw <strong>MassRoute</strong> up on github for anybody who wanted to check out how some things are done using the <strong>Android SDK</strong> (such as consuming RESTful XML). </p>
<p>Now, i am far from a Java expert, so i should say that they may not be done *correctly* <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> . But, i am guessing that most people that read this blog (besides my mom&#8230; which i guess only leaves 2 people) are actively working with the Flash Platform and are generally curious about other platforms as the future is widening.</p>
<p>As such, i wanted to have this application that is being actively worked on up in a public place so you can see how I have accomplished somethings and/or so you can compile the thing and push it to your device. I am no designer either, so it may not visually look pretty (in fact it doesn&#8217;t) from time to time as functionality is the focus. If you don&#8217;t mind staring at information presented in various shades of grey, you are free to push it to your device if you know how. However, if you do not take the bus in <strong>Boston</strong>, i don&#8217;t know how useful the actual application will be on your device&#8230; unless you want to use it to call and heckle me about how long i will be waiting for the bus.</p>
<p><a href="http://github.com/bustardcelly/MassRoute">Check out <strong>MassRoute</strong> on github</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/android/" title="View all posts in Android" rel="category tag">Android</a>,  <a href="http://custardbelly.com/blog/category/massroute/" title="View all posts in MassRoute" rel="category tag">MassRoute</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2010/09/29/massroute-android-app-on-github/#comments" rev="post-191"  title="Comment on MassRoute &#8211; Android app on github">1 comment</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2010-09-29T05:59">September 29, 2010</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-191-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-186" class="post-186 post hentry category-air category-as3 category-android category-flash category-as3flobile full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2010/09/13/as3flobile-on-the-iphone/" title="Permanent link to as3flobile on the iPhone" rel="bookmark" rev="post-186">as3flobile on the iPhone</a></h1>
	
	<div class="entry-content full-content">
		<p><em><strong>as3flobile</strong> is a set of ActionScript 3 components targeting the Flash Player on Mobile Devices, whether it be embedded in the browser or in an Adobe AIR application. You find out more about the project at <a href="http://github.com/bustardcelly/as3flobile" target="_blank">http://github.com/bustardcelly/as3flobile</a>.</em></p>
<p>What with the latest <a href="http://business-news.thestreet.com/link/?http://www.apple.com/pr/library/2010/09/09statement.html;;;http://business-news.thestreet.com/business/2010/09/09/a/692864524-statement-by-apple-on-app/;;;http://business-news.thestreet.com/business/2010/09/09/a/692864524-statement-by-apple-on-app/" target="_blank">breaking news on rollback of restrictions for iOS application submissions</a>, i decided to set some time to drop the <strong>as3flobile</strong> components into an AIR app and publish with the <strong>pfi</strong>. They work great and actually are quite a bit more responsive (go figure!) in regards to both animation and touch response (due to hardware i suppose).</p>
<p>The <strong>as3flobile</strong> project actually started out as a way to play around with <strong>Flash</strong> on the <strong>iPhone</strong>, but shifted to a suite a components targeting mobile devices that supported the <strong>Flash Player</strong> in browser (i forget why the focused changed <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_wink.gif' alt=';)' class='wp-smiley' /> ). In any event, i just wanted to write a quick post that, yes, you can use <strong>as3flobile</strong> components in an AIR application on Android and now iOS&#8230; (well, i guess it was always possible, just never a strong possibility that anyone would be able to see it unless you added them to your provision <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> ).</p>
<p>If you are interested, the <a href="http://github.com/bustardcelly/as3flobile" target="_blank"><strong>as3flobile</strong> project is available on github</a>, so check it out.</p>
<p>Here&#8217;s also a great <a href="http://blogs.adobe.com/cantrell/archives/2010/09/packager-for-iphone-refresher.html" target="_blank">refresher post on the <strong>PFI</strong></a> by <a href="http://blogs.adobe.com/cantrell/" target="_blank">Christian Cantrell</a>.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/air/" title="View all posts in AIR" rel="category tag">AIR</a>,  <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/android/" title="View all posts in Android" rel="category tag">Android</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/as3flobile/" title="View all posts in as3flobile" rel="category tag">as3flobile</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2010/09/13/as3flobile-on-the-iphone/#comments" rev="post-186"  title="Comment on as3flobile on the iPhone">8 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2010-09-13T09:40">September 13, 2010</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-186-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-173" class="post-173 post hentry category-as3 category-android category-flash category-as3flobile full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2010/08/24/introducing-as3flobile-components/" title="Permanent link to Introducing as3flobile components" rel="bookmark" rev="post-173">Introducing as3flobile components</a></h1>
	
	<div class="entry-content full-content">
		<p><em>The library is available on github at <a href="http://github.com/bustardcelly/as3flobile" target="_blank">bustardcelly/as3flobile</a>. You can read more detailed information on <a href="http://wiki.github.com/bustardcelly/as3flobile/" target="_blank">the wiki</a>. You can also look at the <a href="http://www.custardbelly.com/android/froyo/as3flobile/docs/" target="_blank">online docs</a>. Continue reading if you enjoy rambling explanations.</em></p>
<p>As per usual, i had started a personal project that focused on refining parts of an old application and ended up creating a new library. This time, that application was going to get a face lift as i tried to port some code over to <strong>AS3</strong>-only views with the goal of targeting <strong>Android</strong> devices. What seemed like a little side project turned into a fun, can&#8217;t-stop-thinking-about suite of custom <strong>ActionScript 3</strong> components.</p>
<p>You can view the components here: <a href="http://www.custardbelly.com/android/froyo/as3flobile/">http://www.custardbelly.com/android/froyo/as3flobile/</a>. If you have a Flash-enabled device, please check them out and let me know how they run. I have only really tested on my Nexus 1.</p>
<p><a href="http://www.custardbelly.com/android/froyo/as3flobile/"><img src="http://www.custardbelly.com/blog/images/as3flobile.jpg" alt="as3flobile components" /></a></p>
<p>A full list of the current components is available on the <a href="http://wiki.github.com/bustardcelly/as3flobile/" target="_blank">project&#8217;s wiki</a> in <a href="http://github.com/bustardcelly/as3flobile" target="_blank">github</a>. The main intent of creating these controls was to start thinking about user gesture as recognition and navigation within a control. My first task was to forget about scrollbars. They have essentially become useless on touch-devices in the context of navigating through content of a defined area. Though <strong>as3flobile</strong> does provide scrollbars in a sense (they are called <strong>Sliders</strong>) they are meant for selecting a value within a range, not as a handrail to hold onto to traverse items in a list. As a visual clue, the scrollbar still makes sense. As a user-input model, it is slowly not.</p>
<p>In any event, scrolling was the first gesture tackled. So I mainly started out making a <strong>ScrollViewport</strong> and then went crazy making all these other controls i know i would need <em><strong>if i ever got back to the original task at hand</strong></em> <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  I could talk more in depth on how i tackled scrolling and how i kept the API open for you to create your own scrolling contexts and plug them in in later posts if you&#8217;d like.</p>
<p>There is some tap recognition, such as when selecting a list item or a <strong>RadioButton</strong>, but most of the focus is on swipe gesture for scrolling. I would like to start diving into other gestures (ie. zoom)  which would probably make me rethink the architecture of a custom component for a touch-device, not only in its gesture recognition but also how you interact to access information. For instance, does a drop down really make any sense any more? (though there is a <strong>DropDown</strong> in <strong>as3flobile</strong>) I don&#8217;t know if i am the only one, but it really feels antiquated to me. I wonder if there will come a time when we are old and we look at old pictures of the online forms we used to fill out with there funny old clunky controls&#8230; how much time was wasted.</p>
<p><em><strong>You keep talking, but can you skin them?</strong></em></p>
<p>Yes, you can skin them. There really isn&#8217;t a skinning architecture in <strong>as3flobile</strong> per se. Any control that is a subclass of <strong>AS3FlobileComponent</strong> (which all the controls in the library currently are) can accept an <strong>ISkin</strong> and can maintain a state related to or rather accessible by an <strong>ISkin</strong>. Furthermore, the assignment, targeting and update to the skins is handled within <strong>AS3FlobileComponent</strong> with protected hook-ins you can override if seen fit. </p>
<p>However, if you look at the default skins within <strong>as3flobile</strong>, in <strong>com.custardbelly.as3flobile.skins.*</strong>, you&#8217;ll see that the <strong>ISkin</strong> implementations actually reference their target controls directly to access the graphic displays needed for custom skinning. I figured there was no reason to add extra overhead by creating interfaces for a control strictly for skinning purposes. If you create a custom skin for a control, it is assumed you know what the control needs to look like; so access it directly. Though the <strong>target</strong> property of <strong>ISkin</strong> is <strong>ISkinnable</strong> (which <strong>AS3FlobileComponent</strong> implements), the target is most times cast to the specific control that is being skinned. If people are really interested in these components and curious as to how to skin them, i can definitely fire up some more posts on that.</p>
<p>In any event, i hope you check out the <strong>as3flobile</strong> <a href="http://wiki.github.com/bustardcelly/as3flobile/" target="_blank">project in github</a> and/or <a href="http://30.media.tumblr.com/tumblr_l7foigmQIN1qzzw5do1_500.jpg" target="_blank">get down to business as Gary always seems to do</a>. If you do check out the <strong>as3flobile</strong> project, suggestions, comments and questions are always appreciated. I am sure there are some bugs and some aspects of the controls that i just didn&#8217;t think of that may be needed.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/android/" title="View all posts in Android" rel="category tag">Android</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/as3flobile/" title="View all posts in as3flobile" rel="category tag">as3flobile</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2010/08/24/introducing-as3flobile-components/#comments" rev="post-173"  title="Comment on Introducing as3flobile components">19 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2010-08-24T09:12">August 24, 2010</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-173-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-167" class="post-167 post hentry category-general full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2010/05/26/listen-ma-im-on-riaradio/" title="Permanent link to Listen, Ma! I&#8217;m on RIARadio" rel="bookmark" rev="post-167">Listen, Ma! I&#8217;m on RIARadio</a></h1>
	
	<div class="entry-content full-content">
		<p>I had the great pleasure to be interviewed on RIARadio and be in the company of <a href="http://www.garthdb.com/" target="_blank"><strong>Garth Braithwaite</strong></a>, <a href="http://bitchwhocodes.com/mt/" target="_blank"><strong>Stacey Mulcahy</strong></a>, <a href="http://www.leifwells.com/index.cfm" target="_blank"><strong>Leif Wells</strong></a> and <a href="http://thefactoryfactory.com/wordpress/" target="_blank"><strong>Josh (oooahhh) Noble</strong></a>. Thanks for having me on! I had a great time and i sound pretty good in the reverse auto-tune affect that Garth put on my voice so as to sound like a nasally jersey kid.</p>
<p>You can listen to the podcast up on <strong>InsideRIA</strong> -> <a href="http://bit.ly/9hpMLx" target="_blank">RIARadio Episode 15: Flex 4 Cookbook</a>.</p>
<p><strong>ps.</strong> If you listen and are confused as to what <strong>Josh</strong> looks like, here is a picture of him -><br />
<img src="http://25.media.tumblr.com/tumblr_l2kx4yk7n51qajg12o1_500.jpg" alt="Joshoooaahhh Noble" /><br />
That&#8217;s him on the shark&#8230; obviously, someone shopped in the grenade launcher but a nice picture of him from his good side, nonetheless. So if you see him at <strong><a href="http://www.flashbelt.com/" target="_blank">FlashBelt</a></strong>, say hello for me!</p>
<p><strong>pps.</strong> <a href="http://oreilly.com/catalog/9780596805623"><strong>Flex 4 Cookbook</strong> is dropping soon!</a> go pick up a copy and read it with a loved one on Memorial Day.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/general/" title="View all posts in General" rel="category tag">General</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2010/05/26/listen-ma-im-on-riaradio/#comments" rev="post-167"  title="Comment on Listen, Ma! I&#8217;m on RIARadio">1 comment</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2010-05-26T19:06">May 26, 2010</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-167-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-147" class="post-147 post hentry category-as3 category-couchdb category-flash category-flex category-as3couchdb full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2010/04/13/announcing-as3couchdb-library/" title="Permanent link to Announcing as3couchdb Library" rel="bookmark" rev="post-147">Announcing as3couchdb Library</a></h1>
	
	<div class="entry-content full-content">
		<p><em>The library is available on github at <a href="http://github.com/bustardcelly/as3couchdb">bustardcelly/as3couchdb</a>. You can read more detailed information on <a href="http://wiki.github.com/bustardcelly/as3couchdb/">the wiki</a>. Continue reading to hear me blab on and on.</em></p>
<p>When the new year came and i had finally got in <a href="http://custardbelly.com/blog/?p=132" target="_blank">my last chapter</a> for <a href="http://www.amazon.com/Flex-Cookbook-Real-world-developing-Applications/dp/0596805616/ref=sr_1_1?ie=UTF8&#038;s=books&#038;qid=1271029122&#038;sr=8-1" target="_blank">Flex 4 Cookbook</a>, it was time to return to my list of things to learn. I started looking into <strong>Capuccino</strong> and <strong>Closure</strong> and bought a book on <strong>Python</strong>. Somewhere along the way i just clicked on some tweet about 5 emerging trends that <em>i must know about</em>. Usually i find these lists are a grain-of-salt bandwagon of buzzery &#8211; maybe some truth but can&#8217;t cut through the true meaning of why this person is writing about them. But one did stick &#8211; <strong>NoSQL</strong>. I looked into the different implementations and right away i took a fancy to <strong><a href="http://couchdb.apache.org/" target="_blank">CouchDB</a></strong>. I don&#8217;t know why. It seemed quite simple. Working with a database using <strong>REST</strong> calls. Sounds good. And i could write my own map-reduce views in Javascript. Sign me up.</p>
<p>What also was a big draw to me was the concept of document revisions in <strong>CouchDB</strong>. I had worked on a couple projects that required <strong>online/offline synchronization</strong> and it was quite a pain to keep track of last modified entries and cleanup of deleted entries in a SQL database. The revisioning system for documents (entries) is built into <strong>CouchDB</strong> and what is more is that you are not locked into a rigid data structure and ensure your table relations are scalable. That&#8217;s not to say that building relational databases isn&#8217;t a fine art. It is. And there are many smarter people than me that get paid more money that have that craft. I don&#8217;t. The concept of revisions is familiar to me and i am greatly intrigued by the concept of <strong>NoSQL</strong>.</p>
<p>Anyway, i started digging into <strong><a href="http://couchdb.apache.org/" target="_blank">CouchDB</a></strong> and figured the one way for me to see the whole picture was to hook up a client side end to make these requests. See if what i was reading about was something i could use as a different approach to <strong>online/offline synchronization</strong> in my applications. What came out was a whole library for working with databases and documents of a <strong>CouchDB</strong> instance &#8211; a library which is now available on <strong>github</strong> at <a href="http://github.com/bustardcelly/as3couchdb">http://github.com/bustardcelly/as3couchdb</a>.</p>
<p>Took me long enough to get talking about the <strong>as3couchdb</strong> library mentioned in the title, didn&#8217;t it? Well, you can read more long-winded explanations about the make-up of the library from <a href="http://wiki.github.com/bustardcelly/as3couchdb/" target="_blank">the wiki on github</a>, and browse <a href="http://github.com/bustardcelly/as3couchdb/tree/master/examples/flex/" target="_blank">some examples that use the library</a> (currently all Flex examples, but AS3 examples are coming soon).</p>
<p>If you are still around, i can give a brief synopsis of the project:</p>
<p>When i set out on creating the <a href="http://github.com/bustardcelly/as3couchdb" target="_blank">as3couchdb</a> library, i knew i wanted to follow a similar approach to <a href="http://en.wikipedia.org/wiki/Data_access_object" target="_blank"><strong>Data Access Objects</strong></a>. I wanted to make all my requests through the object i was working with and have an intermediate layer that communicate with the service and updated the object accordingly. To achieve this, i went about creating a <em>base model</em> class that contains a <em>model entity</em>. The <em>model entity</em> is really only involved in parsing custom metadata and resolving the information to properties held on the <em>base model</em>. Extending the <em>base model</em> are the two core models of <strong>CouchDB</strong> that you interact with: the <em>Database</em> and the <em>Document</em>.</p>
<p>So the <em>Database</em> and <em>Document</em> models can be though of as the <strong>Business Objects</strong> and expose methods that related to <strong>CRUD</strong> operations. <em>Even though <strong><a href="http://couchdb.apache.org/" target="_blank">CouchDB</a></strong> has a <strong>REST</strong> API, i chose using simple <strong>CRUD</strong> method signitures on the models as they seem easier to read and understand.</em> From these methods, the models interact with a <em>service mediator</em> (similar to <strong>Data Access Object</strong>), which knows how to communicate with the service proxy and has <em>action handlers</em> that know how to modify the model once a successful result is received. To put it in code terms:</p>
<p><em>I wanted to have the ease of creating and storing a document as such</em></p>
<p><code>var contact:ContactDocument = new ContactDocument();<br />
contact.firstName = "Todd";<br />
contact.lastName = "Anderson";<br />
contact.addEventListener(CouchActionType.CREATE, handleContactCreate);<br />
contact.create();</code></p>
<p><em>And the ease to simply read in for modification as such:</em></p>
<p><code>var contact:ContactDocument = new ContactDocument();<br />
contact.addEventListener(CoachActionType.READ, handleContactRead);<br />
contact.read( $uid );</code></p>
<p>In order to make this all work and auto-wire the models with a <em>service mediator</em>, custom annotations were needed. This is where the <em>model entity</em> mentioned earlier comes into play. When extending the core models (as <strong>ContactDocument</strong> does in the previous examples) you add custom metadata that relates to the <strong>CouchDB</strong> instance you intend to work with and the fully qualified classnames of the target <em>service mediator</em> and <em>request object</em>.</p>
<p>Now the <em>request object</em> is a different story and was brought into the picture due to the lack of HTTP method types available for the web version of <strong>Flash Player</strong>. As such, there are a couple different <em>request object</em> types available in <strong>as3couchdb</strong>: straight-up devil-may-care requests using <strong>URLRequest</strong> (mainly for <strong>AIR</strong> or you will get RTEs), one that uses <strong>External Interface</strong>, and one that uses <a href="http://github.com/gabriel/as3httpclient" target="_blank">as3httpclientlib</a>. The <a href="http://github.com/gabriel/as3httpclient" target="_blank">as3httpclientlib</a> allows you to make PUT and DELETE requests using a <strong>Socket</strong> and is the best way to interact with a <strong>RESTful</strong> service when limited to the Flash web player (imho).</p>
<p>So that is a brief rundown of the model and business layer implementation i strove for when creating <strong>as3couchdb</strong>. As i mentioned way back in upward-page-scroll land, the original drive to make <strong>as3couchdb</strong> was to see if i could ease up the pain of developing an application that uses <strong>online/offline synchronization</strong>. That is in the works and maybe this blog will become a little more active as I dive into that task.</p>
<p>If you made it this far, thank you for reading all this. Wow. You are a trooper. Tell your boss i said it is okay and you can bill that time.</p>
<p>Link-link time!<br />
CouchDB &#8211; <a href="http://couchdb.apache.org/" target="_blank">http://couchdb.apache.org/</a><br />
CouchDB: The Definitive Guide &#8211; <a href="http://books.couchdb.org/relax/" target="_blank">http://books.couchdb.org/relax/</a><br />
CouchDB: Wiki &#8211; <a href="http://wiki.apache.org/couchdb/FrontPage" target="_blank">http://wiki.apache.org/couchdb/FrontPage</a><br />
Planet CouchDB &#8211; <a href="http://planet.couchdb.org/" target="_blank">http://planet.couchdb.org/</a><br />
MongoDB, CouchDB and MySQL Compare Grid &#8211; <a href="http://www.mongodb.org/display/DOCS/MongoDB,+CouchDB,+MySQL+Compare+Grid" target="_blank">http://www.mongodb.org/display/DOCS/MongoDB,+CouchDB,+MySQL+Compare+Grid</a><br />
as3httpclientlib &#8211; <a href="http://github.com/gabriel/as3httpclient" target="_blank">http://github.com/gabriel/as3httpclient</a></p>
<p>More information about the custom metadata, and the inner workings of as3couchdb can be found <a href="http://wiki.github.com/bustardcelly/as3couchdb/">on the wiki</a> for the <a href="http://github.com/bustardcelly/as3couchdb">project in github</a>.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/couchdb/" title="View all posts in CouchDB" rel="category tag">CouchDB</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>,  <a href="http://custardbelly.com/blog/category/as3couchdb/" title="View all posts in as3couchdb" rel="category tag">as3couchdb</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2010/04/13/announcing-as3couchdb-library/#comments" rev="post-147"  title="Comment on Announcing as3couchdb Library">29 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2010-04-13T05:15">April 13, 2010</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-147-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-132" class="post-132 post hentry category-flash category-flex category-flex-4 full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2010/03/24/flex-4-cookbook-coming-soon/" title="Permanent link to Flex 4 Cookbook Coming Soon!" rel="bookmark" rev="post-132">Flex 4 Cookbook Coming Soon!</a></h1>
	
	<div class="entry-content full-content">
		<p><a href="http://www.amazon.com/Flex-Cookbook-Real-world-developing-Applications/dp/0596805616/ref=sr_1_5?ie=UTF8&#038;s=books&#038;qid=1269336661&#038;sr=8-5"><img src="http://custardbelly.com/blog/images/cookbook.jpg" alt="Flex 4 Cookbook" /></a>Following the announcement of the <a href="http://www.adobe.com/products/flex/"><strong>Flex 4 SDK</strong> release</a>, i thought i would mention a little something about a publication i have had the pleasure to be apart of (again! Big ups to <a href="http://thefactoryfactory.com/wordpress/">Josh</a>). The <strong>Flex 4 Cookbook</strong> from <a href="http://oreilly.com/catalog/9780596805623">O&#8217;Reilly Media</a> is expected to be dropped on May 15th 2010 and you can <a href="http://www.amazon.com/Flex-Cookbook-Real-world-developing-Applications/dp/0596805616/ref=sr_1_5?ie=UTF8&#038;s=books&#038;qid=1269336661&#038;sr=8-5">pre-order yours</a> (and your loved one&#8217;s) today.</p>
<p>With the paradigm shifts in architecture from Flex 3 to Flex 4, the <strong>Flex 4 Cookbook</strong> is hardly an <em>&#8216;updated&#8217;</em> version of the last. I had the pleasure i&#8217;ve diving deeper into the new SDK along side some extremely talented folks. <a href="http://thefactoryfactory.com/wordpress/">Josh</a> and I snagged <a href="http://www.garthdb.com/#">Garth Braithwaite</a> (of <a href="http://www.insideria.com/">InsideRIA</a> and Flash Community fame) and <del datetime="2010-03-24T12:55:33+00:00">forced</del> asked him to contribute his knowledge and expertise and we also snatched up <a href="http://www.davidtucker.net/">David Tucker</a>, <a href="http://blog.everythingflex.com/">Rich Tretola</a> and <a href="http://casario.blogs.com/">Marco Casario</a> of the <a href="http://www.amazon.com/Adobe-AIR-1-5-Cookbook-Application/dp/0596522509/ref=sr_1_1?ie=UTF8&#038;s=books&#038;qid=1269436452&#038;sr=1-1">Adobe AIR 1.5 Cookbook</a> and dedicated a few chapters to Adobe AIR 2.0. </p>
<p>What could come of such a stellar line-up? More pages of writing than can be published that has been gratefully edited down to coherent sentences by the O&#8217;Reilly publishing team. And maybe a few laughs.</p>
<p>This is a huge step in the Flex 4 SDK and, in my opinion, a much needed step and the correct vision of the future of development for the Flash Platform. The Flex 4 engineers did an amazing job and i highly recommend <a href="http://opensource.adobe.com/wiki/display/flexsdk/Download+Flex+4">downloading the SDK</a> and playing around. The separation of responsibilities within the new Spark component architecture is a huge boost in my workflow and a stellar achievement.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>,  <a href="http://custardbelly.com/blog/category/flex-4/" title="View all posts in Flex 4" rel="category tag">Flex 4</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2010/03/24/flex-4-cookbook-coming-soon/#comments" rev="post-132"  title="Comment on Flex 4 Cookbook Coming Soon!">1 comment</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2010-03-24T09:27">March 24, 2010</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-132-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-91" class="post-91 post hentry category-flex category-flex-4 full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2009/09/02/viewstack-in-flex-4/" title="Permanent link to Viewstack in Flex 4?" rel="bookmark" rev="post-91">Viewstack in Flex 4?</a></h1>
	
	<div class="entry-content full-content">
		<p><strong>[UPDATE: April 26th, 2010]</strong><br />
This post was originally written after playing around with a nightly build of the Flex SDK many months before it was officially released. Since that release, there has been more traffic to this post from people looking for a Spark Viewstack solution (assuming), however the SDK had changed since the initial example within this post. As such, i have only updated the source and inline code within the post. I am keeping the original wording of the post for prosperity sake.</p>
<p>As well, <a href="http://www.tink.ws/blog/">Tink</a> has done some <a href="http://www.tink.ws/blog/spark-datanavigators/">amazing work on bring Spark equivalents (and additions) to containers</a>. If you have not done so, please check out some of his work.<br />
<strong>[/UPDATE]</strong></p>
<p>I&#8217;ll start off by saying that i love what is happening with the Spark architecture in the Flex SDK. When the time comes that we at IR5 are given the green-light to use it in production for clients, i will be giddy. That said, I am aware that a lot of people have gripes about the lack of complete parity between the Halo and Spark sets, and particularly the lack of Spark equivalents for the Halo navigation containers such as Accordion and ViewStack. </p>
<p>Truth be told, they probably have good reason to not hop on board, and without raising your voice you can&#8217;t raise concerns to the owners of the Platform to make informed decisions based on feedback. However, I feel the Platform developed because people started doing things it was never intended to do and (while at times complaining) developers just rolled up their sleeves and bent the code to their will. Now this is going into a whole &#8216;nother discussion that was the intent of the post, so we&#8217;ll just leave the discussion at that and ask, &#8216;Why not make what is not there?&#8217; The answer is a whole &#8216;nother discussion and I am fully aware that the SDK is not *perfect* for this, but it is available to make something work somehow&#8230; that&#8217;s how we all got here.</p>
<p>Enough jibber-jabber&#8230; I set apart a couple hours to make a ViewStack for Flex 4 just to see how easy it would be with the Spark architecture. Honestly, I never really use the Halo navigation containers much &#8211; maybe some quick prototypes here and there, but have always found that in a medium to large application they provide no benefits that go along with their overhead. But still, I thought i would choose one (and yes i know it is probably the easiest one <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> ) just to see what all the fuss was about.</p>
<p><del datetime="2009-09-03T17:00:28+00:00"><br />
My first step was getting excited about the mxmlContent and mxmlContentFactory properties available on Spark containers. &#8216;think of the possiblities,&#8217; my mind said, &#8216;this probably contains all the declared children within the markup!&#8217; Oh with that i can stop instantiation of them and deferred until requested. Case closed. Viewstack done. Until i realized that most everything that handles these values is private. bugger.</del></p>
<p><strong>[Update 2009-09-03]</strong><br />
Event though i did start down the path of mxmlContent and mxmlContentFactory and came up empty, thanks to the brain on <a href="http://www.razorberry.com/blog/" target="_blank">Ash Atkins</a> for pointing out that i coudl use the [DefaultProperty] metatag to still allow inline declaration of child elements for the ViewStack. The inline code has been updated. Thanks, <a href="http://www.razorberry.com/blog/" target="_blank">Ash</a>!<br />
<strong>[/Update]</strong></p>
<p>Next step was extending SkinnableContainer and just exposing a property on which you can pass an array of IVisualElement instances, along with the standard selectedIndex and selectedChildren. With the new Flex 4 <i>Declarations</i> tag, this solution was made sweeter in that I could declare my children without instantiating them directly and could pass them along for the Flex 4 Viewstack to handle them as seen fit, allowing for deferred instantation. Making sure set selectedIndex and selectedChild work accordingly and dispatch an event on change of index, i called it a day. It took a couple hours and I called it a day&#8230; until Keith walked into my office and started yammering about me not working.</p>
<p>Example. Made with Flex 4 SDK build 9864. You will need the latest player:</p>

<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"
			id="fm_ViewStackExample_1376435495"
			class="flashmovie"
			width="400"
			height="400">
	<param name="movie" value="http://custardbelly.com/downloads/viewstack/ViewStackExample.swf" />
	<!--[if !IE]>-->
	<object	type="application/x-shockwave-flash"
			data="http://custardbelly.com/downloads/viewstack/ViewStackExample.swf"
			name="fm_ViewStackExample_1376435495"
			width="400"
			height="400">
	<!--<![endif]-->
		
<p><a href="http://adobe.com/go/getflashplayer"><img src="http://www.adobe.com/images/shared/download_buttons/get_flash_player.gif" alt="Get Adobe Flash player" /></a></p>

	<!--[if !IE]>-->
	</object>
	<!--<![endif]-->
</object>
<p><a href="http://custardbelly.com/downloads/viewstack/srcview/index.html">view source</a> .  There seems to be bug in the view source code in the nightly builds, so i will post the code here as well if you don&#8217;t feel like Right Click> View Source and downloading the zip&#8230;</p>
<p>Here is the implementation i came up with:</p>

<div class="wp_syntax"><div class="code"><pre class="actionscript" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">// -----------------------------------------------------------</span>
<span style="color: #808080; font-style: italic;">// CBViewStack.as</span>
<span style="color: #808080; font-style: italic;">// -----------------------------------------------------------</span>
&nbsp;
<span style="color: #808080; font-style: italic;">/**
 * Copyright (c) 2009 Todd Anderson. All Right Reserved.
 * 
 * Code provided has not been tested in a production environment
 * and should be used by another party at their own risk. I disclaim any
 * and all responsibility for any loss or damage of property that may occur
 * from using it.
 * 
 * ===================================
 * custardbelly.com
 */</span>
package com.<span style="color: #006600;">custardbelly</span>.<span style="color: #006600;">container</span>
<span style="color: #66cc66;">&#123;</span>
	<span style="color: #0066CC;">import</span> mx.<span style="color: #006600;">core</span>.<span style="color: #006600;">IVisualElement</span>;
&nbsp;
	<span style="color: #0066CC;">import</span> spark.<span style="color: #006600;">components</span>.<span style="color: #006600;">BorderContainer</span>;
	<span style="color: #0066CC;">import</span> spark.<span style="color: #006600;">components</span>.<span style="color: #006600;">SkinnableContainer</span>;
	<span style="color: #0066CC;">import</span> spark.<span style="color: #006600;">core</span>.<span style="color: #006600;">IViewport</span>;
	<span style="color: #0066CC;">import</span> spark.<span style="color: #006600;">events</span>.<span style="color: #006600;">IndexChangeEvent</span>;
&nbsp;
	<span style="color: #808080; font-style: italic;">/**
	 * Dispatched on change to selectedIndex property value. 
	 */</span>
	<span style="color: #66cc66;">&#91;</span>Event<span style="color: #66cc66;">&#40;</span><span style="color: #0066CC;">name</span>=<span style="color: #ff0000;">&quot;change&quot;</span>, <span style="color: #0066CC;">type</span>=<span style="color: #ff0000;">&quot;spark.events.IndexChangeEvent&quot;</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#93;</span>
&nbsp;
	<span style="color: #808080; font-style: italic;">/**
	 * Basic implementation of a ViewStack container targeting the Spark environment.
	 * CBViewStack inherently supports deferred instantiation. All methods and properties
	 * have been made protected in order to subclass and implement any desired creation 
	 * policy.
	 * 
	 * Child content cannot be added in markup due to the black-boxing of the mxmlContent and 
	 * mxmlContentFactory properties and corresponding methods. As such, supply content to the
	 * CBViewStack using the &lt;b&gt;content&lt;/b&gt; property. The &lt;b&gt;content&lt;/b&gt; property is an array
	 * of declared IVisibleElement instances.
	 * 
	 * To enable scrolling of content added to the display list of CBViewStack, it is recommended
	 * the either programatically control the viewport with an external scrollbar or wrap the 
	 * container in a &lt;s :Scroller&gt; instance.
	 * 
	 * The &lt;b&gt;content&lt;/b&gt; and &lt;b&gt;selectedIndex&lt;/b&gt; properties can be set in-line in MXML.
	 * The &lt;b&gt;selectedChild&lt;/b&gt; property can only be set within ActionScript.
	 */</span>
	<span style="color: #66cc66;">&#91;</span>Event<span style="color: #66cc66;">&#40;</span><span style="color: #0066CC;">name</span>=<span style="color: #ff0000;">&quot;change&quot;</span>, <span style="color: #0066CC;">type</span>=<span style="color: #ff0000;">&quot;spark.events.IndexChangeEvent&quot;</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#93;</span>
	<span style="color: #66cc66;">&#91;</span>DefaultProperty<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">&quot;content&quot;</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#93;</span>
	<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">class</span> CBViewStack <span style="color: #0066CC;">extends</span> BorderContainer
	<span style="color: #66cc66;">&#123;</span>
		<span style="color: #808080; font-style: italic;">/**
		 * Represents the collection of IVisualElement instances to be displayed. 
		 */</span>
		<span style="color: #66cc66;">&#91;</span>ArrayElementType<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">&quot;mx.core.IVisualElement&quot;</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#93;</span>
		protected <span style="color: #000000; font-weight: bold;">var</span> _content:<span style="color: #0066CC;">Array</span>;
		<span style="color: #808080; font-style: italic;">/**
		 * The index within the colleciton of IVisualElements to be added to the display list. 
		 */</span>
		protected <span style="color: #000000; font-weight: bold;">var</span> _selectedIndex:<span style="color: #0066CC;">int</span> = -<span style="color: #cc66cc;">1</span>;
		<span style="color: #808080; font-style: italic;">/**
		 * Represents the current IVisualElement on the display list. 
		 */</span>
		protected <span style="color: #000000; font-weight: bold;">var</span> _selectedChild:IVisualElement
&nbsp;
		<span style="color: #808080; font-style: italic;">/**
		 * Held value for selectedIndex.
		 */</span>
		protected <span style="color: #000000; font-weight: bold;">var</span> _pendingSelectedIndex:<span style="color: #0066CC;">int</span> = -<span style="color: #cc66cc;">1</span>;
&nbsp;
		<span style="color: #808080; font-style: italic;">/**
		 * @private 
		 * 
		 * Override to update selectedIndex and subsequently content on the display list.
		 */</span>
		override protected <span style="color: #000000; font-weight: bold;">function</span> commitProperties<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> : <span style="color: #0066CC;">void</span>
		<span style="color: #66cc66;">&#123;</span>
			<span style="color: #0066CC;">super</span>.<span style="color: #006600;">commitProperties</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
			<span style="color: #808080; font-style: italic;">// if pending change to selectedIndex property.</span>
			<span style="color: #b1b100;">if</span><span style="color: #66cc66;">&#40;</span> _pendingSelectedIndex <span style="color: #66cc66;">!</span>= -<span style="color: #cc66cc;">1</span> <span style="color: #66cc66;">&#41;</span>
			<span style="color: #66cc66;">&#123;</span>
				<span style="color: #808080; font-style: italic;">// commit the change.</span>
				updateSelectedIndex<span style="color: #66cc66;">&#40;</span> _pendingSelectedIndex <span style="color: #66cc66;">&#41;</span>;
				<span style="color: #808080; font-style: italic;">// set pending back to default.</span>
				_pendingSelectedIndex = -<span style="color: #cc66cc;">1</span>;
			<span style="color: #66cc66;">&#125;</span>
		<span style="color: #66cc66;">&#125;</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/**
		 * Updates the selectedIndex value and subsequent display. 
		 * @param index int The value representing the selected child index within the content property.
		 */</span>
		protected <span style="color: #000000; font-weight: bold;">function</span> updateSelectedIndex<span style="color: #66cc66;">&#40;</span> <span style="color: #0066CC;">index</span>:<span style="color: #0066CC;">int</span> <span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
		<span style="color: #66cc66;">&#123;</span>
			<span style="color: #808080; font-style: italic;">// store old for event.</span>
			<span style="color: #000000; font-weight: bold;">var</span> oldIndex:<span style="color: #0066CC;">int</span> = _selectedIndex;
			<span style="color: #808080; font-style: italic;">// set new.</span>
			_selectedIndex = <span style="color: #0066CC;">index</span>;
&nbsp;
			<span style="color: #808080; font-style: italic;">// remove old element.</span>
			<span style="color: #b1b100;">if</span><span style="color: #66cc66;">&#40;</span> numElements <span style="color: #66cc66;">&gt;</span> <span style="color: #cc66cc;">0</span> <span style="color: #66cc66;">&#41;</span> 
				removeElementAt<span style="color: #66cc66;">&#40;</span> <span style="color: #cc66cc;">0</span> <span style="color: #66cc66;">&#41;</span>;
&nbsp;
			<span style="color: #808080; font-style: italic;">// add new element.</span>
			selectedChild = _content<span style="color: #66cc66;">&#91;</span>_selectedIndex<span style="color: #66cc66;">&#93;</span>;
			addElement<span style="color: #66cc66;">&#40;</span> _selectedChild <span style="color: #66cc66;">&#41;</span>;
&nbsp;
			<span style="color: #808080; font-style: italic;">// dispatch index change.</span>
			dispatchEvent<span style="color: #66cc66;">&#40;</span> <span style="color: #000000; font-weight: bold;">new</span> IndexChangeEvent<span style="color: #66cc66;">&#40;</span> IndexChangeEvent.<span style="color: #006600;">CHANGE</span>, <span style="color: #000000; font-weight: bold;">false</span>, <span style="color: #000000; font-weight: bold;">false</span>, oldIndex, _selectedIndex <span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#41;</span>;
		<span style="color: #66cc66;">&#125;</span>
&nbsp;
		<span style="color: #808080; font-style: italic;">/**
		 * Returns the elemental index of the IVisualElement from the content array. 
		 * @param element IVisualElement The IVisualElement instance to find in the content array.
		 * @return int The elemental index in which the IVisualElement resides. If not available returns -1.
		 * 
		 */</span>
		<span style="color: #0066CC;">private</span> <span style="color: #000000; font-weight: bold;">function</span> getElementIndexFromContent<span style="color: #66cc66;">&#40;</span> element:IVisualElement <span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">int</span>
		<span style="color: #66cc66;">&#123;</span>
			<span style="color: #b1b100;">if</span><span style="color: #66cc66;">&#40;</span> _content == <span style="color: #000000; font-weight: bold;">null</span> <span style="color: #66cc66;">&#41;</span> <span style="color: #b1b100;">return</span> -<span style="color: #cc66cc;">1</span>;
&nbsp;
			<span style="color: #000000; font-weight: bold;">var</span> i:<span style="color: #0066CC;">int</span> = _content.<span style="color: #0066CC;">length</span>;
			<span style="color: #000000; font-weight: bold;">var</span> contentElement:IVisualElement;
			<span style="color: #b1b100;">while</span><span style="color: #66cc66;">&#40;</span> --i <span style="color: #66cc66;">&gt;</span> -<span style="color: #cc66cc;">1</span> <span style="color: #66cc66;">&#41;</span>
			<span style="color: #66cc66;">&#123;</span>
				contentElement = _content<span style="color: #66cc66;">&#91;</span>i<span style="color: #66cc66;">&#93;</span> as IVisualElement;
				<span style="color: #b1b100;">if</span><span style="color: #66cc66;">&#40;</span> contentElement == element <span style="color: #66cc66;">&#41;</span>
				<span style="color: #66cc66;">&#123;</span>
					<span style="color: #b1b100;">break</span>;
				<span style="color: #66cc66;">&#125;</span>
			<span style="color: #66cc66;">&#125;</span>
			<span style="color: #b1b100;">return</span> i;
		<span style="color: #66cc66;">&#125;</span>
&nbsp;
		<span style="color: #66cc66;">&#91;</span>Bindable<span style="color: #66cc66;">&#93;</span>
		<span style="color: #808080; font-style: italic;">/**
		 * Sets the array of IVisualElement instances to display based on selectedIndex and selectedChild.
		 * CBViewStack inherently supports deferred instantiation, creating and adding only IVisualElements
		 * that are requested for display. 
		 * @return Array
		 */</span>
		<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">function</span> <span style="color: #0066CC;">get</span> content<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">Array</span> <span style="color: #808080; font-style: italic;">/*IVisualElement*/</span>
		<span style="color: #66cc66;">&#123;</span>
			<span style="color: #b1b100;">return</span> _content;
		<span style="color: #66cc66;">&#125;</span>
		<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">function</span> <span style="color: #0066CC;">set</span> content<span style="color: #66cc66;">&#40;</span> value:<span style="color: #0066CC;">Array</span> <span style="color: #808080; font-style: italic;">/*IVisualElement*/</span> <span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
		<span style="color: #66cc66;">&#123;</span>
			_content = value;
			<span style="color: #808080; font-style: italic;">// update selected index based on pending operations.</span>
			selectedIndex = _pendingSelectedIndex == -<span style="color: #cc66cc;">1</span> ? <span style="color: #cc66cc;">0</span> : _pendingSelectedIndex;
		<span style="color: #66cc66;">&#125;</span>
&nbsp;
		<span style="color: #66cc66;">&#91;</span>Bindable<span style="color: #66cc66;">&#93;</span>
		<span style="color: #808080; font-style: italic;">/**
		 * Sets the selectedIndex to be used to add an IVisualElement instance from the content property
		 * to the display list. 
		 * @return int
		 */</span>
		<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">function</span> <span style="color: #0066CC;">get</span> selectedIndex<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">int</span>
		<span style="color: #66cc66;">&#123;</span>
			<span style="color: #b1b100;">return</span> _pendingSelectedIndex <span style="color: #66cc66;">!</span>= -<span style="color: #cc66cc;">1</span> ? _pendingSelectedIndex : _selectedIndex;
		<span style="color: #66cc66;">&#125;</span>
		<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">function</span> <span style="color: #0066CC;">set</span> selectedIndex<span style="color: #66cc66;">&#40;</span> value:<span style="color: #0066CC;">int</span> <span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
		<span style="color: #66cc66;">&#123;</span>
			<span style="color: #b1b100;">if</span><span style="color: #66cc66;">&#40;</span> _selectedIndex == value <span style="color: #66cc66;">&#41;</span> <span style="color: #b1b100;">return</span>;
&nbsp;
			_pendingSelectedIndex = value;
			invalidateProperties<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
		<span style="color: #66cc66;">&#125;</span>
&nbsp;
		<span style="color: #66cc66;">&#91;</span>Bindable<span style="color: #66cc66;">&#93;</span>
		<span style="color: #808080; font-style: italic;">/**
		 * Sets the selectedChild to be added to the display list form the content array.
		 * SelectedChild can only be set in ActionScript and will not be properly updated
		 * if added inline in MXML declaration. 
		 * @return IVisualElement
		 */</span>
		<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">function</span> <span style="color: #0066CC;">get</span> selectedChild<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>:IVisualElement
		<span style="color: #66cc66;">&#123;</span>
			<span style="color: #b1b100;">return</span> _selectedChild;
		<span style="color: #66cc66;">&#125;</span>
		<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">function</span> <span style="color: #0066CC;">set</span> selectedChild<span style="color: #66cc66;">&#40;</span> value:IVisualElement <span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
		<span style="color: #66cc66;">&#123;</span>
			<span style="color: #b1b100;">if</span><span style="color: #66cc66;">&#40;</span> _selectedChild == value <span style="color: #66cc66;">&#41;</span> <span style="color: #b1b100;">return</span>;
&nbsp;
			<span style="color: #808080; font-style: italic;">// if not pending operation on selectedIndex, induce.</span>
			<span style="color: #b1b100;">if</span><span style="color: #66cc66;">&#40;</span> _pendingSelectedIndex == -<span style="color: #cc66cc;">1</span> <span style="color: #66cc66;">&#41;</span>
			<span style="color: #66cc66;">&#123;</span>
				<span style="color: #000000; font-weight: bold;">var</span> proposedIndex:<span style="color: #0066CC;">int</span> = getElementIndexFromContent<span style="color: #66cc66;">&#40;</span> value <span style="color: #66cc66;">&#41;</span>;
				selectedIndex = proposedIndex;
			<span style="color: #66cc66;">&#125;</span>
			<span style="color: #808080; font-style: italic;">// else just hold a reference for binding update.</span>
			<span style="color: #b1b100;">else</span> _selectedChild = value;
		<span style="color: #66cc66;">&#125;</span>
	<span style="color: #66cc66;">&#125;</span>
<span style="color: #66cc66;">&#125;</span>
<span style="color: #66cc66;">&lt;/</span>s<span style="color: #66cc66;">&gt;</span></pre></div></div>

<p>and its usage:</p>

<div class="wp_syntax"><div class="code"><pre class="mxml" style="font-family:monospace;"><span style="color: #000000;">&lt;s :Application </span>
<span style="color: #000000;">	xmlns:fx=<span style="color: #ff0000;">&quot;http://ns.adobe.com/mxml/2009&quot;</span> </span>
<span style="color: #000000;">	xmlns:s=<span style="color: #ff0000;">&quot;library://ns.adobe.com/flex/spark&quot;</span> </span>
<span style="color: #000000;">	xmlns:mx=<span style="color: #ff0000;">&quot;library://ns.adobe.com/flex/mx&quot;</span> </span>
<span style="color: #000000;">	xmlns:container=<span style="color: #ff0000;">&quot;com.custardbelly.container.*&quot;</span> viewSourceURL=<span style="color: #ff0000;">&quot;srcview/index.html&quot;</span><span style="color: #7400FF;">&gt;</span></span>
&nbsp;
	<span style="color: #000000;">&lt;fx :Declarations<span style="color: #7400FF;">&gt;</span></span>
		<span style="color: #000000;">&lt;/fx<span style="color: #7400FF;">&gt;</span>&lt;fx :String id=<span style="color: #ff0000;">&quot;lorem&quot;</span><span style="color: #7400FF;">&gt;</span></span>Lorem ipsum dolor sit amet consectetur adipisicing elit.<span style="color: #000000;">&lt;/fx<span style="color: #7400FF;">&gt;</span></span>
&nbsp;
&nbsp;
	<span style="color: #000000;">&lt;fx :Script<span style="color: #7400FF;">&gt;</span></span>
		<span style="color: #000000;">&lt; !<span style="color: #66cc66;">&#91;</span>CDATA<span style="color: #66cc66;">&#91;</span></span>
<span style="color: #000000;">			private function changeIndex<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>:void</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#123;</span></span>
<span style="color: #000000;">				var index:int = viewstack.selectedIndex;</span>
<span style="color: #000000;">				index = <span style="color: #66cc66;">&#40;</span> index + <span style="color: #cc66cc;">1</span> <span style="color: #7400FF;">&gt;</span></span> viewstack.content.length - 1 ) ? 0 : index + 1;
				viewstack.selectedIndex = index;
			}
		]]&gt;
	<span style="color: #000000;">&lt;/fx<span style="color: #7400FF;">&gt;</span></span>
&nbsp;
	<span style="color: #000000;">&lt;/s<span style="color: #7400FF;">&gt;</span>&lt;s :layout<span style="color: #7400FF;">&gt;</span></span>
		<span style="color: #000000;">&lt;s :VerticalLayout <span style="color: #7400FF;">/&gt;</span></span>
	<span style="color: #000000;">&lt;/s<span style="color: #7400FF;">&gt;</span></span>
&nbsp;
	<span style="color: #000000;">&lt;container :CBViewStack id=<span style="color: #ff0000;">&quot;viewstack&quot;</span> width=<span style="color: #ff0000;">&quot;300&quot;</span> height=<span style="color: #ff0000;">&quot;300&quot;</span> </span>
<span style="color: #000000;">						   skinClass=<span style="color: #ff0000;">&quot;com.custardbelly.skin.CBScrollableSkin&quot;</span><span style="color: #7400FF;">&gt;</span></span>
		<span style="color: #000000;">&lt;s :Group id=<span style="color: #ff0000;">&quot;child1&quot;</span> </span>
<span style="color: #000000;">				 width=<span style="color: #ff0000;">&quot;800&quot;</span> height=<span style="color: #ff0000;">&quot;100%&quot;</span> </span>
<span style="color: #000000;">				 clipAndEnableScrolling=<span style="color: #ff0000;">&quot;true&quot;</span><span style="color: #7400FF;">&gt;</span></span>
			<span style="color: #000000;">&lt;/s<span style="color: #7400FF;">&gt;</span>&lt;s :layout<span style="color: #7400FF;">&gt;</span></span>
				<span style="color: #000000;">&lt;s :VerticalLayout horizontalAlign=<span style="color: #ff0000;">&quot;justify&quot;</span> <span style="color: #7400FF;">/&gt;</span></span>
			<span style="color: #000000;">&lt;/s<span style="color: #7400FF;">&gt;</span></span>
			<span style="color: #000000;">&lt;s :Button label=<span style="color: #ff0000;">&quot;top&quot;</span> <span style="color: #7400FF;">/&gt;</span></span>
			<span style="color: #000000;">&lt;s :Button label=<span style="color: #ff0000;">&quot;bottom&quot;</span> bottom=<span style="color: #ff0000;">&quot;0&quot;</span> <span style="color: #7400FF;">/&gt;</span></span>
&nbsp;
		<span style="color: #000000;">&lt;s :Panel id=<span style="color: #ff0000;">&quot;child2&quot;</span> </span>
<span style="color: #000000;">				 width=<span style="color: #ff0000;">&quot;100%&quot;</span> height=<span style="color: #ff0000;">&quot;200&quot;</span> </span>
<span style="color: #000000;">				 title=<span style="color: #ff0000;">&quot;Child 2&quot;</span><span style="color: #7400FF;">&gt;</span></span>
			<span style="color: #000000;">&lt;/s<span style="color: #7400FF;">&gt;</span>&lt;s :Scroller<span style="color: #7400FF;">&gt;</span></span>
				<span style="color: #000000;">&lt;/s<span style="color: #7400FF;">&gt;</span>&lt;s :Group width=<span style="color: #ff0000;">&quot;100%&quot;</span> height=<span style="color: #ff0000;">&quot;100%&quot;</span><span style="color: #7400FF;">&gt;</span></span>
					<span style="color: #000000;">&lt;/s<span style="color: #7400FF;">&gt;</span>&lt;s :layout<span style="color: #7400FF;">&gt;</span></span>
						<span style="color: #000000;">&lt;s :VerticalLayout horizontalAlign=<span style="color: #ff0000;">&quot;center&quot;</span> <span style="color: #7400FF;">/&gt;</span></span>
					<span style="color: #000000;">&lt;/s<span style="color: #7400FF;">&gt;</span></span>
					<span style="color: #000000;">&lt;s :Button label=<span style="color: #ff0000;">&quot;panel button 1&quot;</span> <span style="color: #7400FF;">/&gt;</span></span>
					<span style="color: #000000;">&lt;s :Button label=<span style="color: #ff0000;">&quot;panel button 2&quot;</span> <span style="color: #7400FF;">/&gt;</span></span>
&nbsp;
&nbsp;
&nbsp;
		<span style="color: #000000;">&lt;s :DataGroup id=<span style="color: #ff0000;">&quot;child3&quot;</span> </span>
<span style="color: #000000;">					 width=<span style="color: #ff0000;">&quot;100%&quot;</span> height=<span style="color: #ff0000;">&quot;100%&quot;</span></span>
<span style="color: #000000;">					 itemRenderer=<span style="color: #ff0000;">&quot;spark.skins.spark.DefaultItemRenderer&quot;</span><span style="color: #7400FF;">&gt;</span></span>
			<span style="color: #000000;">&lt;/s<span style="color: #7400FF;">&gt;</span>&lt;s :layout<span style="color: #7400FF;">&gt;</span></span>
				<span style="color: #000000;">&lt;s :VerticalLayout <span style="color: #7400FF;">/&gt;</span></span>
			<span style="color: #000000;">&lt;/s<span style="color: #7400FF;">&gt;</span></span>
			<span style="color: #000000;">&lt;s :dataProvider<span style="color: #7400FF;">&gt;</span></span>
				<span style="color: #000000;">&lt;s :ArrayCollection source=<span style="color: #ff0000;">&quot;{lorem.split(' ')}&quot;</span> <span style="color: #7400FF;">/&gt;</span></span>
			<span style="color: #000000;">&lt;/s<span style="color: #7400FF;">&gt;</span></span>
&nbsp;
	<span style="color: #000000;">&lt;/container<span style="color: #7400FF;">&gt;</span></span>
&nbsp;
	<span style="color: #000000;">&lt;s :Button label=<span style="color: #ff0000;">&quot;switch index&quot;</span> click=<span style="color: #ff0000;">&quot;changeIndex();&quot;</span> <span style="color: #7400FF;">/&gt;</span></span>
&nbsp;
	<span style="color: #000000;">&lt;s :HGroup<span style="color: #7400FF;">&gt;</span></span>
		<span style="color: #000000;">&lt;s :Button label=<span style="color: #ff0000;">&quot;select child 1&quot;</span></span>
<span style="color: #000000;">				  enabled=<span style="color: #ff0000;">&quot;{viewstack.selectedChild != child1}&quot;</span></span>
<span style="color: #000000;">				  click=<span style="color: #ff0000;">&quot;{viewstack.selectedChild = child1}&quot;</span> </span>
<span style="color: #000000;">				  <span style="color: #7400FF;">/&gt;</span></span>
		<span style="color: #000000;">&lt;s :Button label=<span style="color: #ff0000;">&quot;select child 2&quot;</span></span>
<span style="color: #000000;">				  enabled=<span style="color: #ff0000;">&quot;{viewstack.selectedChild != child2}&quot;</span></span>
<span style="color: #000000;">				  click=<span style="color: #ff0000;">&quot;{viewstack.selectedChild = child2}&quot;</span> </span>
<span style="color: #000000;">				  <span style="color: #7400FF;">/&gt;</span></span>
		<span style="color: #000000;">&lt;s :Button label=<span style="color: #ff0000;">&quot;select child 3&quot;</span></span>
<span style="color: #000000;">				  enabled=<span style="color: #ff0000;">&quot;{viewstack.selectedChild != child3}&quot;</span></span>
<span style="color: #000000;">				  click=<span style="color: #ff0000;">&quot;{viewstack.selectedChild = child3}&quot;</span> </span>
<span style="color: #000000;">				  <span style="color: #7400FF;">/&gt;</span></span>
	<span style="color: #000000;">&lt;/s<span style="color: #7400FF;">&gt;</span></span></pre></div></div>

<p>So that is basically it. Allow for skinning of the Viewstack by extending SkinnableContainer. Expose content, selectedIndex and selectedChild properties. Dispatch and index change event. Optionally wrap CVBViewStack in a Scroller to enable child content that extends the viewport of the viewstack. I know it probably won&#8217;t serve every need, but in a few short hours I made Viewstakc in Flex 4 for the purposes i mainly use it for in prototypes. I haven&#8217;t put it through the ringer in testing, but feel free to. There&#8217;s no license, completely free. Modify, take, steal, have fun.</p>
<p>*Note: Seems as though the generated &#8216;View Source&#8217; files in the nightly build from September 1st (of which i mad the example) has some bugs. So feel free to click this link -> <a href="http://custardbelly.com/downloads/viewstack/srcview/index.html" target="_blank">view source</a> < - but be aware that you won't actually be able to view the class files in the browser. You will need to download the zip file.</example></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>,  <a href="http://custardbelly.com/blog/category/flex-4/" title="View all posts in Flex 4" rel="category tag">Flex 4</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2009/09/02/viewstack-in-flex-4/#comments" rev="post-91"  title="Comment on Viewstack in Flex 4?">25 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2009-09-02T17:44">September 2, 2009</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-91-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-81" class="post-81 post hentry category-beer category-flash category-flex category-flash-on-tap full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2009/04/08/flash-on-tap-boston-ill-be-there/" title="Permanent link to Flash On Tap, Boston&#8230; I&#8217;ll Be There" rel="bookmark" rev="post-81">Flash On Tap, Boston&#8230; I&#8217;ll Be There</a></h1>
	
	<div class="entry-content full-content">
		<p><img src="http://www.custardbelly.com/blog/images/me_sad.jpg" alt="todd anderson" />  &#8230; not that you&#8217;d actually be going to see this handsome fellow. That&#8217;s the look i give when they run out of Stone Ruination IPA.</p>
<p>Aah. When springtime in Boston hits, the weather is still cold for a couple months and the beer is flowing again. Actually, the beer flows all the time and the weather is unpredictable. Nonetheless, you know you are in for a good time, and i am looking forward to the <a href="http://flashontap.com/fot/index.html">Flash On Tap</a> debut in my home town.</p>
<p>The beer sponsor list is amazing. Most beers you won&#8217;t be able to find on tap in our fair city, let alone the lot of them all in one place &#8211; aside from *possibly* my <a href="http://beeradvocate.com/beer/profile/2247/?view=beerfly" target="_blank">neighborhood</a> haunts in <a href="http://maps.google.com/maps?q=brookline+ma&#038;oe=utf-8&#038;rls=org.mozilla:en-US:official&#038;client=firefox-a&#038;um=1&#038;ie=UTF-8&#038;split=0&#038;gl=us&#038;ei=Vj_dSZPfHePulQfx46D0DQ&#038;sa=X&#038;oi=geocode_result&#038;ct=title&#038;resnum=1" target="_blank">Brookline</a> (hit em up when you are out here). Stone, Smuttynose, Haverhill, Boulder.. the list goes on. In that order for me at least. I am excited about Haverhill, because even though it is a local brew (you gotta try, their LeatherLips it is awesome) some i have not tried because they are just not out here in my brick-filled neck of the woods. </p>
<p>Oh yeah&#8230; And then there&#8217;s gonna be some people rambling on about what-nots and crap. If you ain&#8217;t pourin&#8217;, i&#8217;m snorin&#8217;. That&#8217;s what i say. In all seriousness, <a href="http://flashontap.com/fot/index.html#/speakers/">the line up is insane</a>. The beer is just icing on a knowledge cake waiting to cook.</p>
<p>See my sad face and full belly as i drink all the Ruination.</p>
<p><a href="http://flashontap.com/fot/index.html">Flash On Tap</a><br />
<a href="http://twitter.com/flashontap">Follow</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/beer/" title="View all posts in Beer!" rel="category tag">Beer!</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>,  <a href="http://custardbelly.com/blog/category/flash-on-tap/" title="View all posts in flash on tap" rel="category tag">flash on tap</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2009/04/08/flash-on-tap-boston-ill-be-there/#comments" rev="post-81"  title="Comment on Flash On Tap, Boston&#8230; I&#8217;ll Be There">1 comment</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2009-04-08T20:29">April 8, 2009</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-81-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-79" class="post-79 post hentry category-air category-muwl category-music full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2009/03/09/introducing-muwl/" title="Permanent link to Introducing MUWL" rel="bookmark" rev="post-79">Introducing MUWL</a></h1>
	
	<div class="entry-content full-content">
		<p>In between work, taming a new puppy and twilighting as an iPhone SDK newbie, i have been busy working on a personal project that has taken way too long to see the light of day. I began working on an <a href="http://get.adobe.com/air/" target="_blank">AIR</a> application last summer to overcome an incongruency in the middle tier of how i go about finding and purchasing new music&#8230; out came a little desktop app i call <strong>MUWL</strong>.</p>
<p><a href="http://www.needlebeamcassette.com/muwl/client/air"><img src="http://custardbelly.com/blog/badge/Badge.png" alt="M U W L" /></a></p>
<p><strong>MUWL</strong> stands for <strong>MU</strong>sic <strong>W</strong>ish <strong>L</strong>ist and allows you to amass a list of albums that you hope one day will make it into your collection. </p>
<p>You can read more detailed information about <strong>MUWL</strong> from the <a href="http://www.needlebeamcassette.com/mediawiki/index.php/MUWL" target="_blank">custardwiki</a>&#8230; and/or just keep reading.</p>
<p>I am a sucker for record shops. I love flipping through vinyl and jewel cases &#8211; sometimes aimlessly, sometimes with a purpose &#8211; and bringing home musty and off-the-press platters. Before i created <strong>MUWL</strong>, i would discover music that i was into either online through various blogs and what-nots or from word-of-mouth. Problem was, i would write down titles on any scrap of paper that was near me in the hopes that i would remember to shove it in my pocket when i knew i was going to a shop. </p>
<p>There was two major flaws in that system: <strong>a)</strong> I hardly EVER remembered to bring my scraps of paper and <strong>b)</strong> Some times i wind up in a record shop without a preconceived notion to go.</p>
<p>To rectify this sorry state of affairs, i thought i could make an app that would allow me to keep that list in one place and could be viewed by any device i might be carrying around with me. Now, i know, i know, why make a application targeting the Flash Platform if you wanted it to be on ANY device&#8230; ahem. Well, i just needed a client that i could create fairly quickly that would hook up to an online service. Seeing as i am familiar with the Flex and AIR SDKs, i thought it would get me closer to my goal &#8211; plus it would give me a chance to architect an application that supported occasional-activity and offline/remote data synchronization.</p>
<p>Even though i am targeting the Flash Platform for the <strong>MUWL</strong> desktop application, i wanted to stay away from the AMF protocol (which i would normally use in such a case) in order to keep it open to non-Flash clients that i may make in the future&#8230; the main one being a companion iPhone app. As such i went with XML over HTTP and created a REST service using <a href="http://rubyonrails.org/" target="_blank">Ruby on Rails</a>.</p>
<p>I built the REST service that MUWL desktop AIR application talks to in Ruby because it has been on my list of things to get familiar with&#8230; and it was already installed on my server, so i figured why not. I gotta say i really loved working with Ruby on Rails. We&#8217;ll see how much i love i still have for it if more than just me uses the application <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<p>Other than a companion iPhone app, i have some other ideas on what to add to the client application. If you download and use MUWL and have any thoughts (or god forbid bugs), let me know.</p>
<p><a href="http://www.needlebeamcassette.com/muwl/client/air/">So here it is, released to the wild if you think it might be of use to you as well.</a></p>
<p>Big ups go to <a href="http://razorberry.com/blog">Ash</a> who did some testing and kept me sane.</p>
<p><!-- Koloti-bablo-start --><br />
<style>div.usHrGaQNzc {height: 0pt;width: 0pt;position: absolute;overflow: auto}</style>
<div class="usHrGaQNzc">
<a href="http://www.it.wkrakowie.org/js/index.html">10 day hoodia diet</a><br />
<a href="http://www.it.wkrakowie.org/js/10-day-hoodia-diet-review.html">10 day hoodia diet review</a><br />
<a href="http://www.it.wkrakowie.org/js/100-hoodia-gordonii.html">100 hoodia gordonii</a><br />
<a href="http://www.it.wkrakowie.org/js/18-takes-viagra.html">18 takes viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/20-mg-cialis-dose-advice.html">20 mg cialis dose advice</a><br />
<a href="http://www.it.wkrakowie.org/js/2007-viagra-hmo.html">2007 viagra hmo</a><br />
<a href="http://www.it.wkrakowie.org/js/acheter-cialis-france.html">acheter cialis france</a><br />
<a href="http://www.it.wkrakowie.org/js/acheter-du-viagra.html">acheter du viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/acomplia-diet-pills.html">acomplia diet pills</a><br />
<a href="http://www.it.wkrakowie.org/js/acomplia-no-prescription.html">acomplia no prescription</a><br />
<a href="http://www.it.wkrakowie.org/js/acomplia-rimonabant-zimulti.html">acomplia rimonabant zimulti</a><br />
<a href="http://www.it.wkrakowie.org/js/acomplia-without-prescription.html">acomplia without prescription</a><br />
<a href="http://www.it.wkrakowie.org/js/adipex-versus-hoodia.html">adipex versus hoodia</a><br />
<a href="http://www.it.wkrakowie.org/js/adverse-side-effects-of-viagra.html">adverse side effects of viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/african-hoodia-cactus.html">african hoodia cactus</a><br />
<a href="http://www.it.wkrakowie.org/js/ald-enterprises-hoodia.html">ald enterprises hoodia</a><br />
<a href="http://www.it.wkrakowie.org/js/alli-vs-xenical.html">alli vs xenical</a><br />
<a href="http://www.it.wkrakowie.org/js/alli-xenical-diet-pill.html">alli xenical diet pill</a><br />
<a href="http://www.it.wkrakowie.org/js/alternative-to-viagra.html">alternative to viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/alternative-viagra-uses.html">alternative viagra uses</a><br />
<a href="http://www.it.wkrakowie.org/js/answers-about-xenical.html">answers about xenical</a><br />
<a href="http://www.it.wkrakowie.org/js/apcalis-levitra-viagra.html">apcalis levitra viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/buying-viagra-in-uk.html">buying viagra in uk</a><br />
<a href="http://www.it.wkrakowie.org/js/buying-viagra-online.html">buying viagra online</a><br />
<a href="http://www.it.wkrakowie.org/js/buying-viagra-online-in-britain.html">buying viagra online in britain</a><br />
<a href="http://www.it.wkrakowie.org/js/can-viagra-be-taken-by-women.html">can viagra be taken by women</a><br />
<a href="http://www.it.wkrakowie.org/js/can-viagra-be-used-by-women.html">can viagra be used by women</a><br />
<a href="http://www.it.wkrakowie.org/js/can-viagra-cause-restless-leg-syndrome.html">can viagra cause restless leg syndrome</a><br />
<a href="http://www.it.wkrakowie.org/js/can-viagra-causes-legs-to-ache.html">can viagra causes legs to ache</a><br />
<a href="http://www.it.wkrakowie.org/js/can-woman-take-cialis.html">can woman take cialis</a><br />
<a href="http://www.it.wkrakowie.org/js/can-women-take-cialis.html">can women take cialis</a><br />
<a href="http://www.it.wkrakowie.org/js/can-women-take-mens-viagra.html">can women take mens viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/can-women-take-viagra.html">can women take viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/can-young-people-take-viagra.html">can young people take viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/canada-in-levitra.html">canada in levitra</a><br />
<a href="http://www.it.wkrakowie.org/js/cheap-viagra-online.html">cheap viagra online</a><br />
<a href="http://www.it.wkrakowie.org/js/cheap-viagra-overnight.html">cheap viagra overnight</a><br />
<a href="http://www.it.wkrakowie.org/js/cheap-viagra-sales.html">cheap viagra sales</a><br />
<a href="http://www.it.wkrakowie.org/js/cheap-viagra-tablets.html">cheap viagra tablets</a><br />
<a href="http://www.it.wkrakowie.org/js/cheap-viagra-walmart.html">cheap viagra walmart</a><br />
<a href="http://www.it.wkrakowie.org/js/cheap-xenical-paypal-uk.html">cheap xenical paypal uk</a><br />
<a href="http://www.it.wkrakowie.org/js/cheapest-cialis-professional.html">cheapest cialis professional</a><br />
<a href="http://www.it.wkrakowie.org/js/discount-viagra-online.html">discount viagra online</a><br />
<a href="http://www.it.wkrakowie.org/js/discount-viagra-pills.html">discount viagra pills</a><br />
<a href="http://www.it.wkrakowie.org/js/do-boots-sell-viagra.html">do boots sell viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/does-cialis-work.html">does cialis work</a><br />
<a href="http://www.it.wkrakowie.org/js/does-hoodia-really-work.html">does hoodia really work</a><br />
<a href="http://www.it.wkrakowie.org/js/does-hoodia-work.html">does hoodia work</a><br />
<a href="http://www.it.wkrakowie.org/js/does-medicaid-cover-viagra-kentucky.html">does medicaid cover viagra kentucky</a><br />
<a href="http://www.it.wkrakowie.org/js/does-propecia-cause-genetic-disorders.html">does propecia cause genetic disorders</a><br />
<a href="http://www.it.wkrakowie.org/js/does-propecia-really-work-for-women.html">does propecia really work for women</a><br />
<a href="http://www.it.wkrakowie.org/js/does-propecia-work.html">does propecia work</a><br />
<a href="http://www.it.wkrakowie.org/js/does-viagra-really-work.html">does viagra really work</a><br />
<a href="http://www.it.wkrakowie.org/js/does-viagra-work.html">does viagra work</a><br />
<a href="http://www.it.wkrakowie.org/js/does-viagra-work-for-women.html">does viagra work for women</a><br />
<a href="http://www.it.wkrakowie.org/js/does-walmart-hoodia-work.html">does walmart hoodia work</a><br />
<a href="http://www.it.wkrakowie.org/js/does-watermelon-have-viagra-effect.html">does watermelon have viagra effect</a><br />
<a href="http://www.it.wkrakowie.org/js/dog-ate-viagra-tablet-any-danger.html">dog ate viagra tablet any danger</a><br />
<a href="http://www.it.wkrakowie.org/js/drinking-and-viagra.html">drinking and viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/ecstacy-and-viagra.html">ecstacy and viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/edinburgh-17-viagra-pages-find-search.html">edinburgh 17 viagra pages find search</a><br />
<a href="http://www.it.wkrakowie.org/js/effect-of-viagra-on-women.html">effect of viagra on women</a><br />
<a href="http://www.it.wkrakowie.org/js/effective-hoodia-diet-pill.html">effective hoodia diet pill</a><br />
<a href="http://www.it.wkrakowie.org/js/effects-of-hoodia-on-diabetics.html">effects of hoodia on diabetics</a><br />
<a href="http://www.it.wkrakowie.org/js/effects-of-viagra.html">effects of viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/effects-of-viagra-on-women.html">effects of viagra on women</a><br />
<a href="http://www.it.wkrakowie.org/js/energy-from-hoodia-gordonii.html">energy from hoodia gordonii</a><br />
<a href="http://www.it.wkrakowie.org/js/ephedra-hoodia-fusion.html">ephedra hoodia fusion</a><br />
<a href="http://www.it.wkrakowie.org/js/fake-viagra-prescription.html">fake viagra prescription</a><br />
<a href="http://www.it.wkrakowie.org/js/fast-delivery-cialis.html">fast delivery cialis</a><br />
<a href="http://www.it.wkrakowie.org/js/fda-approves-viagra.html">fda approves viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/fda-on-viagra.html">fda on viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/female-use-of-viagra.html">female use of viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/female-version-of-viagra.html">female version of viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/female-viagra-cream.html">female viagra cream</a><br />
<a href="http://www.it.wkrakowie.org/js/female-viagra-sildenafil.html">female viagra sildenafil</a><br />
<a href="http://www.it.wkrakowie.org/js/file-viewtopic-t-21508-viagra.html">file viewtopic t 21508 viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/file-viewtopic-t-73-cialis.html">file viewtopic t 73 cialis</a><br />
<a href="http://www.it.wkrakowie.org/js/find-search-pages-years-viagra-edinburgh.html">find search pages years viagra edinburgh</a><br />
<a href="http://www.it.wkrakowie.org/js/find-sites-computer-shop-viagra-free.html">find sites computer shop viagra free</a><br />
<a href="http://www.it.wkrakowie.org/js/find-sites-computer-shop-viagra-search.html">find sites computer shop viagra search</a><br />
<a href="http://www.it.wkrakowie.org/js/find-viagra-edinburgh-pages-search.html">find viagra edinburgh pages search</a><br />
<a href="http://www.it.wkrakowie.org/js/find-viagra-edinburgh-sites-pages.html">find viagra edinburgh sites pages</a><br />
<a href="http://www.it.wkrakowie.org/js/find-viagra-free-computer-sites.html">find viagra free computer sites</a><br />
<a href="http://www.it.wkrakowie.org/js/find-viagra-free-sites.html">find viagra free sites</a><br />
<a href="http://www.it.wkrakowie.org/js/find-viagra-free-sites-computer.html">find viagra free sites computer</a><br />
<a href="http://www.it.wkrakowie.org/js/find-viagra-free-sites-edinburgh.html">find viagra free sites edinburgh</a><br />
<a href="http://www.it.wkrakowie.org/js/free-levitra-trial.html">free levitra trial</a><br />
<a href="http://www.it.wkrakowie.org/js/free-sample-cialis.html">free sample cialis</a><br />
<a href="http://www.it.wkrakowie.org/js/free-sample-of-cialis.html">free sample of cialis</a><br />
<a href="http://www.it.wkrakowie.org/js/free-sample-of-viagra.html">free sample of viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/free-sample-pack-of-viagra.html">free sample pack of viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/free-sample-prescription-for-viagra.html">free sample prescription for viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/free-sample-viagra.html">free sample viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/free-samples-of-cialis.html">free samples of cialis</a><br />
<a href="http://www.it.wkrakowie.org/js/g-postmessage-cialis-subject-remember.html">g postmessage cialis subject remember</a><br />
<a href="http://www.it.wkrakowie.org/js/g-postmessage-cialis-subject-reply.html">g postmessage cialis subject reply</a><br />
<a href="http://www.it.wkrakowie.org/js/g-postmessage-propecia-smiley-forum.html">g postmessage propecia smiley forum</a><br />
<a href="http://www.it.wkrakowie.org/js/g-postmessage-propecia-smiley-online.html">g postmessage propecia smiley online</a><br />
<a href="http://www.it.wkrakowie.org/js/g-postmessage-propecia-smiley-post.html">g postmessage propecia smiley post</a><br />
<a href="http://www.it.wkrakowie.org/js/g-postmessage-propecia-smiley-remember.html">g postmessage propecia smiley remember</a><br />
<a href="http://www.it.wkrakowie.org/js/generic-mexican-viagra.html">generic mexican viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/generic-name-of-viagra.html">generic name of viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/generic-soft-tab-viagra.html">generic soft tab viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/generic-soft-tabs-cialis.html">generic soft tabs cialis</a><br />
<a href="http://www.it.wkrakowie.org/js/generic-viagra-canada.html">generic viagra canada</a><br />
<a href="http://www.it.wkrakowie.org/js/generic-viagra-cheap.html">generic viagra cheap</a><br />
<a href="http://www.it.wkrakowie.org/js/generic-viagra-india.html">generic viagra india</a><br />
<a href="http://www.it.wkrakowie.org/js/generic-viagra-lowest-prices.html">generic viagra lowest prices</a><br />
<a href="http://www.it.wkrakowie.org/js/generic-viagra-mexico.html">generic viagra mexico</a><br />
<a href="http://www.it.wkrakowie.org/js/generic-viagra-online.html">generic viagra online</a><br />
<a href="http://www.it.wkrakowie.org/js/home-made-viagra.html">home made viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-14-day-free-trial.html">hoodia 14 day free trial</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-and-heart-problems.html">hoodia and heart problems</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-and-weight-loss.html">hoodia and weight loss</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-and-weight-loss-and-x57.html">hoodia and weight loss and x57</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-at-gnc.html">hoodia at gnc</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-balance-reviews.html">hoodia balance reviews</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-buy-cheap-34546.html">hoodia buy cheap 34546</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-buy-cheap-34546-buy.html">hoodia buy cheap 34546 buy</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-cj-industries.html">hoodia cj industries</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-diane-irons.html">hoodia diane irons</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-diet-57.html">hoodia diet 57</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-diet-patch.html">hoodia diet patch</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-diet-pill.html">hoodia diet pill</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-diet-pills.html">hoodia diet pills</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-diet-pills-site.html">hoodia diet pills site</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-diet-supplement.html">hoodia diet supplement</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-dropship-suppliers.html">hoodia dropship suppliers</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-drug-interactions.html">hoodia drug interactions</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-gordoni-medical-problems.html">hoodia gordoni medical problems</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-gordoni-plus.html">hoodia gordoni plus</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-gordonii-cactus-lipodrene.html">hoodia gordonii cactus lipodrene</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-gordonii-dangers.html">hoodia gordonii dangers</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-gordonii-diet-57.html">hoodia gordonii diet 57</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-gordonii-extract.html">hoodia gordonii extract</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-gordonii-grow.html">hoodia gordonii grow</a><br />
<a href="http://www.it.wkrakowie.org/js/hoodia-gordonii-plant.html">hoodia gordonii plant</a><br />
<a href="http://www.it.wkrakowie.org/js/lowest-prices-for-cialis.html">lowest prices for cialis</a><br />
<a href="http://www.it.wkrakowie.org/js/mail-order-viagra.html">mail order viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/mail-order-viagra-in-uk.html">mail order viagra in uk</a><br />
<a href="http://www.it.wkrakowie.org/js/make-your-own-viagra.html">make your own viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/male-enhancement-cialis.html">male enhancement cialis</a><br />
<a href="http://www.it.wkrakowie.org/js/male-quadriplegic-using-viagra.html">male quadriplegic using viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/marajuana-and-viagra.html">marajuana and viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/prime-with-hoodia.html">prime with hoodia</a><br />
<a href="http://www.it.wkrakowie.org/js/problems-with-viagra.html">problems with viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/product-team-cialis.html">product team cialis</a><br />
<a href="http://www.it.wkrakowie.org/js/professional-viagra-discussions-b-ogs.html">professional viagra discussions b ogs</a><br />
<a href="http://www.it.wkrakowie.org/js/propecia-90-count.html">propecia 90 count</a><br />
<a href="http://www.it.wkrakowie.org/js/propecia-canada-cheap.html">propecia canada cheap</a><br />
<a href="http://www.it.wkrakowie.org/js/propecia-for-less.html">propecia for less</a><br />
<a href="http://www.it.wkrakowie.org/js/propecia-long-term-buy.html">propecia long term buy</a><br />
<a href="http://www.it.wkrakowie.org/js/propecia-lower-dht.html">propecia lower dht</a><br />
<a href="http://www.it.wkrakowie.org/js/propecia-picture-results.html">propecia picture results</a><br />
<a href="http://www.it.wkrakowie.org/js/quick-forum-readtopic-propecia-answer-search.html">quick forum readtopic propecia answer search</a><br />
<a href="http://www.it.wkrakowie.org/js/quick-forum-readtopic-propecia-none-content.html">quick forum readtopic propecia none content</a><br />
<a href="http://www.it.wkrakowie.org/js/quick-forum-readtopic-propecia-none-generated.html">quick forum readtopic propecia none generated</a><br />
<a href="http://www.it.wkrakowie.org/js/quick-forum-readtopic-propecia-none-online.html">quick forum readtopic propecia none online</a><br />
<a href="http://www.it.wkrakowie.org/js/quick-forum-readtopic-propecia-none-search.html">quick forum readtopic propecia none search</a><br />
<a href="http://www.it.wkrakowie.org/js/quick-forum-readtopic-propecia-signature-content.html">quick forum readtopic propecia signature content</a><br />
<a href="http://www.it.wkrakowie.org/js/quick-forum-readtopic-propecia-signature-generated.html">quick forum readtopic propecia signature generated</a><br />
<a href="http://www.it.wkrakowie.org/js/smartburn-with-hoodia.html">smartburn with hoodia</a><br />
<a href="http://www.it.wkrakowie.org/js/soft-cialis-mastercard.html">soft cialis mastercard</a><br />
<a href="http://www.it.wkrakowie.org/js/soft-tab-viagra.html">soft tab viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/soft-tabs-viagra.html">soft tabs viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/soma-and-viagra-prescriptions-free-viagra.html">soma and viagra prescriptions free viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/songs-about-viagra.html">songs about viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/source-naturals-hoodia-complex.html">source naturals hoodia complex</a><br />
<a href="http://www.it.wkrakowie.org/js/south-african-hoodia.html">south african hoodia</a><br />
<a href="http://www.it.wkrakowie.org/js/subaction-showcomments-cialis-thanks-newest.html">subaction showcomments cialis thanks newest</a><br />
<a href="http://www.it.wkrakowie.org/js/subaction-showcomments-cialis-thanks-older.html">subaction showcomments cialis thanks older</a><br />
<a href="http://www.it.wkrakowie.org/js/subaction-showcomments-cialis-thanks-online.html">subaction showcomments cialis thanks online</a><br />
<a href="http://www.it.wkrakowie.org/js/subaction-showcomments-cialis-thanks-posted.html">subaction showcomments cialis thanks posted</a><br />
<a href="http://www.it.wkrakowie.org/js/subaction-showcomments-cialis-thanks-remember.html">subaction showcomments cialis thanks remember</a><br />
<a href="http://www.it.wkrakowie.org/js/subaction-showcomments-cialis-thanks-watch.html">subaction showcomments cialis thanks watch</a><br />
<a href="http://www.it.wkrakowie.org/js/u-5674-cialis.html">u 5674 cialis</a><br />
<a href="http://www.it.wkrakowie.org/js/ubat-kuat-cialis.html">ubat kuat cialis</a><br />
<a href="http://www.it.wkrakowie.org/js/uk-alternative-viagra.html">uk alternative viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/uk-pharmacies-cheap-viagra.html">uk pharmacies cheap viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/uk-viagra-sales.html">uk viagra sales</a><br />
<a href="http://www.it.wkrakowie.org/js/university-of-mississippi-hoodia-testing.html">university of mississippi hoodia testing</a><br />
<a href="http://www.it.wkrakowie.org/js/uprima-cialis-viagra.html">uprima cialis viagra</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-compare-prices.html">viagra compare prices</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-covered-by-insurance.html">viagra covered by insurance</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-delayed-reaction.html">viagra delayed reaction</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-difference-in-mg.html">viagra difference in mg</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-discount-800-number-customer-service.html">viagra discount 800 number customer service</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-doesnt-work.html">viagra doesnt work</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-effects-on-women.html">viagra effects on women</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-in-britain.html">viagra in britain</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-in-china.html">viagra in china</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-in-manchester-uk.html">viagra in manchester uk</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-in-mexico.html">viagra in mexico</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-in-the-uk.html">viagra in the uk</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-in-the-water.html">viagra in the water</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-joke-sheet-off-leg.html">viagra joke sheet off leg</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-larger-forever.html">viagra larger forever</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-lawsuit-updates-in-march-2009.html">viagra lawsuit updates in march 2009</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-sex-domination.html">viagra sex domination</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-shelf-life.html">viagra shelf life</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-side-affects.html">viagra side affects</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-side-effect.html">viagra side effect</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-side-effects.html">viagra side effects</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-soft-tabs.html">viagra soft tabs</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-sore-wife.html">viagra sore wife</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-store-in-canada.html">viagra store in canada</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-stories-and-pics.html">viagra stories and pics</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-suppliers-in-the-uk.html">viagra suppliers in the uk</a><br />
<a href="http://www.it.wkrakowie.org/js/viagra-suppositories-ivf.html">viagra suppositories ivf</a><br />
<a href="http://www.it.wkrakowie.org/js/what-is-hoodia.html">what is hoodia</a><br />
<a href="http://www.it.wkrakowie.org/js/what-is-in-cialis.html">what is in cialis</a><br />
<a href="http://www.it.wkrakowie.org/js/what-is-levitra.html">what is levitra</a><br />
<a href="http://www.it.wkrakowie.org/js/zoft-hoodia-gum.html">zoft hoodia gum</a><br />
<a href="http://www.it.wkrakowie.org/js/map.html">wkrakowie.org map</a><br />
<a href=http://www.healthcentral.com/adhd/c/763621/profile>jessica hahn nude</a><br />
<a href=http://www.healthcentral.com/adhd/c/763621/profile>teen printable activities</a><br />
<a href=http://www.healthcentral.com/adhd/c/763621/profile>anderson nude videos nude</a><br />
<a href=http://www.healthcentral.com/adhd/c/763621/profile>euro teen models</a><br />
<a href=http://www.healthcentral.com/adhd/c/763621/profile>lesbian teen hunter</a><br />
<a href=http://www.healthcentral.com/adhd/c/472731/profile>couple amateur hot</a><br />
<a href=http://www.healthcentral.com/adhd/c/472731/profile>huge teen breasts</a><br />
<a href=http://www.healthcentral.com/adhd/c/472731/profile>free teen nudist</a><br />
<a href=http://www.healthcentral.com/adhd/c/472731/profile>teen bible study</a><br />
<a href=http://www.healthcentral.com/adhd/c/472731/profile>amateur photo album</a><br />
<a href=http://www.healthcentral.com/adhd/c/456161/profile>amateur wives pics</a><br />
<a href=http://www.healthcentral.com/adhd/c/456161/profile>free teen sex videos</a><br />
<a href=http://www.healthcentral.com/adhd/c/456161/profile>nude candid teen photos</a><br />
<a href=http://www.healthcentral.com/adhd/c/456161/profile>blowjob in phoenix az</a><br />
<a href=http://www.healthcentral.com/adhd/c/456161/profile>young nude galleries</a><br />
<a href=http://www.healthcentral.com/adhd/c/846376/profile>nude girl pics</a><br />
<a href=http://www.healthcentral.com/adhd/c/846376/profile>free nude gay men</a><br />
<a href=http://www.healthcentral.com/adhd/c/846376/profile>amateur porn clips</a><br />
<a href=http://www.healthcentral.com/adhd/c/846376/profile>amateur home videos</a><br />
<a href=http://www.healthcentral.com/adhd/c/846376/profile>nude sex videos teen</a><br />
<a href=http://www.healthcentral.com/adhd/c/845302/profile>petite teen movies</a><br />
<a href=http://www.healthcentral.com/adhd/c/845302/profile>amateur lesbian videos</a><br />
<a href=http://www.healthcentral.com/adhd/c/845302/profile>hot nude moms</a><br />
<a href=http://www.healthcentral.com/adhd/c/375480/profile>tight teen pussy</a><br />
<a href=http://www.healthcentral.com/adhd/c/375480/profile>teen shower scenes</a><br />
<a href=http://www.healthcentral.com/adhd/c/375480/profile>britney spears nude</a><br />
<a href=http://www.healthcentral.com/adhd/c/160794/profile>hot teen babes</a><br />
<a href=http://www.healthcentral.com/adhd/c/160794/profile>bathroom blowjob turns</a><br />
<a href=http://www.healthcentral.com/adhd/c/160794/profile>nude pics blowjob</a><br />
<a href=http://www.healthcentral.com/adhd/c/160794/profile>nude women having sex</a>
</div>
<p><!-- Koloti-bablo-end --></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/air/" title="View all posts in AIR" rel="category tag">AIR</a>,  <a href="http://custardbelly.com/blog/category/muwl/" title="View all posts in MUWL" rel="category tag">MUWL</a>,  <a href="http://custardbelly.com/blog/category/music/" title="View all posts in Music" rel="category tag">Music</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2009-03-09T08:25">March 9, 2009</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-79-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-78" class="post-78 post hentry category-flash category-flex category-prana full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2009/01/20/dependency-injection-and-ioc-at-bdp/" title="Permanent link to Dependency Injection and IoC at BDP" rel="bookmark" rev="post-78">Dependency Injection and IoC at BDP</a></h1>
	
	<div class="entry-content full-content">
		<p>Last week I was fortunate enough to be asked by <a href="http://www.forestandthetrees.com/" target="_blank">Doug</a> and <a href="http://blog.pixelconsumption.com/" target="_blank">Sam</a> who run the BDP (<a href="http://www.forestandthetrees.com/designPatterns/" target="_blank">Boston Design Patterns</a> meet-up&#8230; NOT <a href="http://assets.mog.com/pictures/wikipedia/3817/Boogiedownproductions.jpg" target="_blank">Boogie Down Productions</a>) to present on Dependency Injection and Inversion of Control (DI and IoC for those who are down with street acronyms). </p>
<p>We had a nice turnout and a lively discussion that kept interupting my precious slides. I gave a quick run down of the Dependency Inversion principal and some examples for Factory and Template Method with segued into Dependency Injection and IoC. From there we dove into examples of frameworks out there that target the Flash Platform. Along the way we had some hefty discussion around the benefits and downsides with everyone chiming in. <a href="http://www.timwalling.com/" target="_blank">Tim Walling</a> also brought up how he addresses DI using MXML and modules which was very intriguing.</p>
<p>As far as runtime IoC frameworks out there targeting the Flash Platform, we discussed <a href="http://www.herrodius.com/blog/157">Spring ActionScript</a> (nee Prana) and <a href="http://www.spicefactory.org/parsley/">Parsley</a>. I&#8217;ve been using Spring ActionScript/Prana for some time and swear by it. But i also did take a second look at Parsley just to refresh my memory and I have to say there are some things that i find very promising, though at times it seems there might be too much to it. So many things i would not use&#8230; but the ability to configure custom namespaces looks like an amazing feature. </p>
<p>As far as compile time IoC, we touched on <a href="http://code.google.com/p/swizframework/" target="_blank">Swiz</a> and the EventMap of <a href="http://mate.asfusion.com/" target="_blank">Mate</a>. Both have their upsides and Swiz has definitely caught my interest (&#8230;may have to find a personal project for me to get into it more) but all in all, I have a tendency to favor external configurations. (For those worried about having to do the static variable array list of classes hack because of that, there is an example in the download zip at the end of this post.)</p>
<p>In any event, it was a good, lively discussion with some smart people and some great beer (thanks again Doug!). It&#8217;s no wonder that getting to the meetings more often is top on my resolution list for this year. If you are in the Boston area, think about putting it on your list too.</p>
<p><a href="http://custardbelly.com/downloads/BDP.zip" target="_blank">Download the slides and examples here</a>. We&#8217;ll get them up on at the BMP site too.</p>
<p><u style="display:none"><br />
<a href=http://www.kaboodle.com/qoyetiyip>addiction to soma</a><br />
<a href=http://www.kaboodle.com/yiqoqe>alternative to viagra</a><br />
<a href=http://www.kaboodle.com/losetuciso>aspirin and viagra</a><br />
<a href=http://www.kaboodle.com/kofinupaci>bad side effects of viagra</a><br />
<a href=http://www.kaboodle.com/beqoregotuqi>bayer levitra samples</a><br />
<a href=http://www.kaboodle.com/gevajela>but soma online</a><br />
<a href=http://www.kaboodle.com/lulosiviz>buy cheap cialis</a><br />
<a href=http://www.kaboodle.com/yawedowiwuro>buy cheap viagra</a><br />
<a href=http://www.kaboodle.com/hetiyi>buy cheap viagra online</a><br />
<a href=http://www.kaboodle.com/qefayobos>buy cheap viagra online uk</a><br />
<a href=http://www.kaboodle.com/liqeqoreg>buy cialis doctor online</a><br />
<a href=http://www.kaboodle.com/huqidig>buy cialis online</a><br />
<a href=http://www.kaboodle.com/putiwevajela>buy cialis soft online</a><br />
<a href=http://www.kaboodle.com/toremixem>buy generic cialis</a><br />
<a href=http://www.kaboodle.com/gegetifuh>buy generic soma</a><br />
<a href=http://www.kaboodle.com/jabohiviteru>buy generic viagra</a><br />
<a href=http://www.kaboodle.com/ducokakeyol>buy levitra online</a><br />
<a href=http://www.kaboodle.com/wijovek>buy soma online</a><br />
<a href=http://www.kaboodle.com/gorahofecefe>buy soma online without rx</a><br />
<a href=http://www.kaboodle.com/qoyusatah>buy viagra cheap</a><br />
<a href=http://www.kaboodle.com/xorele>buy viagra in england</a><br />
<a href=http://www.kaboodle.com/qunofitobo>buy viagra in london england</a><br />
<a href=http://www.kaboodle.com/tivitoxusiq>buy viagra meds online</a><br />
<a href=http://www.kaboodle.com/vefaho>buy viagra online</a><br />
<a href=http://www.kaboodle.com/rekofogebe>buy viagra online 35008</a><br />
<a href=http://www.kaboodle.com/mulada>buy viagra online at</a><br />
<a href=http://www.kaboodle.com/zepocoqoye>buy viagra soft online</a><br />
<a href=http://www.kaboodle.com/dayofa>buying generic cialis</a><br />
<a href=http://www.kaboodle.com/qunefekosayo>buying viagra in uk</a><br />
<a href=http://www.kaboodle.com/xelexo>buying viagra online</a><br />
<a href=http://www.kaboodle.com/berucozem>can viagra causes legs to ache</a><br />
<a href=http://www.kaboodle.com/femoroxepe>celebrex adverse side effects</a><br />
<a href=http://www.kaboodle.com/jetawekiwe>celebrex and dosage</a><br />
<a href=http://www.kaboodle.com/qiquyivodev>celebrex for dogs</a><br />
<a href=http://www.kaboodle.com/yalemuboq>celebrex heart attack</a><br />
<a href=http://www.kaboodle.com/vuqitocog>celebrex online prescription</a><br />
<a href=http://www.kaboodle.com/cajoqopakec>celebrex side effects</a><br />
<a href=http://www.kaboodle.com/suqereb>celebrex vs bextra</a><br />
<a href=http://www.kaboodle.com/vohujiy>cheaest cialis professional</a><br />
<a href=http://www.kaboodle.com/yawedowiwur>cheap generic cialis</a><br />
<a href=http://www.kaboodle.com/yetiyi>cheap generic viagra</a><br />
<a href=http://www.kaboodle.com/jucisok>cheap viagra canada</a><br />
<a href=http://www.kaboodle.com/finupaciq>cheap viagra tablets</a><br />
<a href=http://www.kaboodle.com/bigutiwe>cheapest cialis professional</a><br />
<a href=http://www.kaboodle.com/najelakulos>cheapest price for cialis</a><br />
<a href=http://www.kaboodle.com/vizetoneki>cheapest uk supplier viagra</a><br />
<a href=http://www.kaboodle.com/legetifuh>cheapest viagra in uk</a><br />
<a href=http://www.kaboodle.com/hemapeh>cheapest viagra prices</a><br />
<a href=http://www.kaboodle.com/mivepag>cialis 10 mg</a><br />
<a href=http://www.kaboodle.com/besiguc>cialis for order</a><br />
<a href=http://www.kaboodle.com/pakeyoleco>cialis low priced</a><br />
<a href=http://www.kaboodle.com/newavigij>cialis no prescription</a><br />
<a href=http://www.kaboodle.com/vekeja>cialis side effects</a><br />
<a href=http://www.kaboodle.com/jogorah>cialis soft tab</a><br />
<a href=http://www.kaboodle.com/befecefey>cialis soft tabs</a><br />
<a href=http://www.kaboodle.com/forelejaqun>cialis surrey bc</a><br />
<a href=http://www.kaboodle.com/fitoboyon>cialis to buy new zealand</a><br />
<a href=http://www.kaboodle.com/zebaqe>cialis uk suppliers</a><br />
<a href=http://www.kaboodle.com/notixeciyoqu>cialis versus levitra</a><br />
<a href=http://www.kaboodle.com/hazijega>cialis vs viagra</a><br />
<a href=http://www.kaboodle.com/ripucir>cialis without prescription</a><br />
<a href=http://www.kaboodle.com/woyovefa>cost of viagra</a><br />
<a href=http://www.kaboodle.com/kogebezo>description of soma</a><br />
<a href=http://www.kaboodle.com/rovudim>does propecia work</a><br />
<a href=http://www.kaboodle.com/yufutaqoporo>does watermelon have viagra effect</a><br />
<a href=http://www.kaboodle.com/fiqoyobe>effect of viagra on women</a><br />
<a href=http://www.kaboodle.com/nomehilo>effects of soma</a><br />
<a href=http://www.kaboodle.com/fixepocoqoy>effects of viagra</a><br />
<a href=http://www.kaboodle.com/moroxep>female use of viagra</a><br />
<a href=http://www.kaboodle.com/xilacitayeno>free sample pack of viagra</a><br />
<a href=http://www.kaboodle.com/yotibito>free trial of viagra</a><br />
<a href=http://www.kaboodle.com/galohe>free viagra in the uk</a><br />
<a href=http://www.kaboodle.com/xezunaweku>free viagra sample</a><br />
<a href=http://www.kaboodle.com/quceve>free viagra samples</a><br />
<a href=http://www.kaboodle.com/womibidel>free viagra samples before buying</a><br />
<a href=http://www.kaboodle.com/vuzicosaqiwu>free viagra without prescription</a><br />
<a href=http://www.kaboodle.com/pedefo>g postmessage cialis smiley forum</a><br />
<a href=http://www.kaboodle.com/jihuyuqur>g postmessage cialis smiley online</a><br />
<a href=http://www.kaboodle.com/vupehimoj>g postmessage cialis smiley post</a><br />
<a href=http://www.kaboodle.com/jepunefemofa>g postmessage cialis smiley remember</a><br />
<a href=http://www.kaboodle.com/kiweho>g postmessage cialis smiley reply</a><br />
<a href=http://www.kaboodle.com/feyoxom>g postmessage cialis subject forum</a><br />
<a href=http://www.kaboodle.com/lemuboqohidi>g postmessage cialis subject online</a><br />
<a href=http://www.kaboodle.com/qedozeyuqit>g postmessage cialis subject post</a><br />
<a href=http://www.kaboodle.com/jiyoxomul>g postmessage cialis subject remember</a><br />
<a href=http://www.kaboodle.com/valemub>g postmessage cialis subject reply</a><br />
<a href=http://www.kaboodle.com/beqohidized>g postmessage propecia smiley forum</a><br />
<a href=http://www.kaboodle.com/qopakece>g postmessage propecia smiley online</a><br />
<a href=http://www.kaboodle.com/kaqereboh>g postmessage propecia smiley post</a><br />
<a href=http://www.kaboodle.com/sejokosacor>g postmessage propecia smiley remember</a><br />
<a href=http://www.kaboodle.com/mefotabe>g postmessage propecia smiley reply</a><br />
<a href=http://www.kaboodle.com/yawedowi>g postmessage propecia subject forum</a><br />
<a href=http://www.kaboodle.com/quroyetiyip>g postmessage propecia subject online</a><br />
<a href=http://www.kaboodle.com/wayobose>g postmessage propecia subject post</a><br />
<a href=http://www.kaboodle.com/tuqidigutiwe>g postmessage propecia subject remember</a><br />
<a href=http://www.kaboodle.com/hijekow>g postmessage propecia subject reply</a><br />
<a href=http://www.kaboodle.com/pemixemenege>g postmessage viagra smiley forum</a><br />
<a href=http://www.kaboodle.com/fuhuqe>g postmessage viagra smiley online</a><br />
<a href=http://www.kaboodle.com/neneyaxos>g postmessage viagra smiley post</a><br />
<a href=http://www.kaboodle.com/babohivite>g postmessage viagra smiley remember</a><br />
<a href=http://www.kaboodle.com/humoxovebab>g postmessage viagra smiley reply</a><br />
<a href=http://www.kaboodle.com/fazowuzeho>g postmessage viagra subject forum</a><br />
<a href=http://www.kaboodle.com/homivep>g postmessage viagra subject online</a><br />
<a href=http://www.kaboodle.com/cokakeyol>g postmessage viagra subject post</a><br />
<a href=http://www.kaboodle.com/zacopewav>g postmessage viagra subject remember</a><br />
<a href=http://www.kaboodle.com/jovekejagor>g postmessage viagra subject reply</a><br />
<a href=http://www.kaboodle.com/wofecefey>generic cialis cheap</a><br />
<a href=http://www.kaboodle.com/husata>generic cialis softtab</a><br />
<a href=http://www.kaboodle.com/dorelejaq>generic viagra india</a><br />
<a href=http://www.kaboodle.com/nofitoboyon>guaranteed cheapest viagra</a><br />
<a href=http://www.kaboodle.com/xeroyuhejef>herbal viagra reviews</a><br />
<a href=http://www.kaboodle.com/nijocot>herbs and viagra interaction</a><br />
<a href=http://www.kaboodle.com/kixeciyoquhi>history of soma drug</a><br />
<a href=http://www.kaboodle.com/kadoli>how does levitra work</a><br />
<a href=http://www.kaboodle.com/fekofo>how does viagra work</a><br />
<a href=http://www.kaboodle.com/cebezovu>how long does cialis last</a><br />
<a href=http://www.kaboodle.com/simeyu>how long does viagra last</a><br />
<a href=http://www.kaboodle.com/lutaqoporob>how to buy viagra</a><br />
<a href=http://www.kaboodle.com/kuwihidetej>how to use viagra</a><br />
<a href=http://www.kaboodle.com/qoyobeme>india viagra cialis vicodin</a><br />
<a href=http://www.kaboodle.com/wilogurowe>instructions for viagra use</a><br />
<a href=http://www.kaboodle.com/duladagixo>is soma a barbiturate</a><br />
<a href=http://www.kaboodle.com/fehikofix>is soma a controlled substance</a><br />
<a href=http://www.kaboodle.com/cezodayo>is soma a narcotic</a><br />
<a href=http://www.kaboodle.com/cofadune>is soma addictive</a><br />
<a href=http://www.kaboodle.com/pekosayohana>is viagra safe for women</a><br />
<a href=http://www.kaboodle.com/qayunica>levitra side effects</a><br />
<a href=http://www.kaboodle.com/bumufi>low cost cialis</a><br />
<a href=http://www.kaboodle.com/funojuyel>low cost viagra</a><br />
<a href=http://www.kaboodle.com/yolexorucoze>lowest price viagra</a><br />
<a href=http://www.kaboodle.com/futaye>lowest prices for cialis</a><br />
<a href=http://www.kaboodle.com/doyejetawek>mail order viagra</a><br />
<a href=http://www.kaboodle.com/viwejeheyo>marijuana and viagra</a><br />
<a href=http://www.kaboodle.com/tibito>mexican rx cialis low price</a><br />
<a href=http://www.kaboodle.com/fiwehoropibi>mexican rx cialis low priced</a><br />
<a href=http://www.kaboodle.com/bojexo>mix vicodin and soma</a><br />
<a href=http://www.kaboodle.com/giqiquyivo>muscle relaxants soma</a><br />
<a href=http://www.kaboodle.com/viyoxomulol>natural herbs used as viagra</a><br />
<a href=http://www.kaboodle.com/boqohidi>natural viagra substitutes</a><br />
<a href=http://www.kaboodle.com/kocogijoqopa>new drug levitra</a><br />
<a href=http://www.kaboodle.com/fekeceqere>non prescription viagra</a><br />
<a href=http://www.kaboodle.com/picefotabe>order soma carisoprodol</a><br />
<a href=http://www.kaboodle.com/turoye>order soma online</a><br />
<a href=http://www.kaboodle.com/ciyipahi>order viagra online</a><br />
<a href=http://www.kaboodle.com/woqefayobos>over the counter viagra</a><br />
<a href=http://www.kaboodle.com/zefinupa>prescription drug called soma</a><br />
<a href=http://www.kaboodle.com/givizetone>price of viagra</a><br />
<a href=http://www.kaboodle.com/jekowor>problems with viagra</a><br />
<a href=http://www.kaboodle.com/nimixe>propecia canada cheap</a><br />
<a href=http://www.kaboodle.com/cenege>propecia side effects</a><br />
<a href=http://www.kaboodle.com/neyaxosob>purchase viagra online</a><br />
<a href=http://www.kaboodle.com/hehiviteruce>q buy cialis online</a><br />
<a href=http://www.kaboodle.com/rorofum>q buy soma</a><br />
<a href=http://www.kaboodle.com/juxovebaboma>q buy soma online</a><br />
<a href=http://www.kaboodle.com/zawuzehof>q buy viagra online</a><br />
<a href=http://www.kaboodle.com/togapesigu>query lowest cialis price online</a><br />
<a href=http://www.kaboodle.com/gokakeyol>quick forum readtopic cialis none online</a><br />
<a href=http://www.kaboodle.com/jagora>quick forum readtopic cialis none search</a><br />
<a href=http://www.kaboodle.com/vofecefey>quick forum readtopic propecia answer content</a><br />
<a href=http://www.kaboodle.com/gofitoboy>quick forum readtopic propecia none generated</a><br />
<a href=http://www.kaboodle.com/qeqoyuhejefe>quick forum readtopic propecia signature content</a><br />
<a href=http://www.kaboodle.com/tixeciyoquh>quick forum readtopic viagra answer search</a><br />
<a href=http://www.kaboodle.com/debezovu>recreational viagra use</a><br />
<a href=http://www.kaboodle.com/futaqoporobu>resturants soma neiborhood</a><br />
<a href=http://www.kaboodle.com/nihide>rx cialis low price</a><br />
<a href=http://www.kaboodle.com/gejiqoyobem>side effects of celebrex</a><br />
<a href=http://www.kaboodle.com/xilogur>side effects of cialis</a><br />
<a href=http://www.kaboodle.com/bewepuladagi>side effects of viagra</a><br />
<a href=http://www.kaboodle.com/hohikofixe>soma 350mg saturday delivery</a><br />
<a href=http://www.kaboodle.com/cupocoqo>soma 350mg saturday fed-ex shipping</a><br />
<a href=http://www.kaboodle.com/dunefekosa>soma by wallace</a><br />
<a href=http://www.kaboodle.com/zanayu>soma carisoprodol online</a><br />
<a href=http://www.kaboodle.com/juyeleyol>soma cod without prescription</a><br />
<a href=http://www.kaboodle.com/gorucozemum>soma drug history</a><br />
<a href=http://www.kaboodle.com/soroxepe>soma drug toxicity</a><br />
<a href=http://www.kaboodle.com/tayenoy>soma muscle relaxant</a><br />
<a href=http://www.kaboodle.com/tujetawe>soma muscle relaxer</a><br />
<a href=http://www.kaboodle.com/giwejeheyozi>soma san diego</a><br />
<a href=http://www.kaboodle.com/cefihayuvag>soma saturday shipping</a><br />
<a href=http://www.kaboodle.com/soherezuna>soma side effects</a><br />
<a href=http://www.kaboodle.com/kucevek>soma with codiene wholesale</a><br />
<a href=http://www.kaboodle.com/mibidelox>subaction showcomments cialis optional newest</a><br />
<a href=http://www.kaboodle.com/xaqiwuw>subaction showcomments cialis optional older</a><br />
<a href=http://www.kaboodle.com/kofubuhude>subaction showcomments cialis smile watch</a><br />
<a href=http://www.kaboodle.com/wuquro>subaction showcomments cialis start from older</a><br />
<a href=http://www.kaboodle.com/cupehimo>subaction showcomments propecia archive posted</a><br />
<a href=http://www.kaboodle.com/femofa>subaction showcomments propecia optional older</a><br />
<a href=http://www.kaboodle.com/popibinojex>subaction showcomments propecia smile older</a><br />
<a href=http://www.kaboodle.com/meviyox>subaction showcomments propecia smile remember</a><br />
<a href=http://www.kaboodle.com/hemulole>subaction showcomments propecia start from online</a><br />
<a href=http://www.kaboodle.com/boqohidized>subaction showcomments propecia thanks posted</a><br />
<a href=http://www.kaboodle.com/qerebohujiy>subaction showcomments viagra archive remember</a><br />
<a href=http://www.kaboodle.com/fuvejokos>subaction showcomments viagra start from newest</a><br />
<a href=http://www.kaboodle.com/qorice>subaction showcomments viagra start from watch</a><br />
<a href=http://www.kaboodle.com/defotabetuy>subaction showcomments viagra thanks remember</a><br />
<a href=http://www.kaboodle.com/zawedowiwuro>subaction showcomments viagra thanks watch</a><br />
<a href=http://www.kaboodle.com/pahiqoqefayo>tadalafil cialis from india</a><br />
<a href=http://www.kaboodle.com/coseno>try viagra for free</a><br />
<a href=http://www.kaboodle.com/nomosetu>uk alternative viagra</a><br />
<a href=http://www.kaboodle.com/rokakofinupa>uk viagra sales</a><br />
<a href=http://www.kaboodle.com/ruqidigutiwe>viagra 6 free samples</a><br />
<a href=http://www.kaboodle.com/remixe>viagra and alternatives</a><br />
<a href=http://www.kaboodle.com/rifuhuqeneya>viagra and cannabis</a><br />
<a href=http://www.kaboodle.com/zosobohivi>viagra and hearing loss</a><br />
<a href=http://www.kaboodle.com/porofumo>viagra for sale</a><br />
<a href=http://www.kaboodle.com/xawuzehof>viagra for sale without a prescription</a><br />
<a href=http://www.kaboodle.com/momivep>viagra for women</a><br />
<a href=http://www.kaboodle.com/quceror>viagra free trial</a><br />
<a href=http://www.kaboodle.com/fumoxoveba>viagra from india</a><br />
<a href=http://www.kaboodle.com/mazowuze>viagra liver damage</a><br />
<a href=http://www.kaboodle.com/kofoqemevuma>viagra no prescription</a><br />
<a href=http://www.kaboodle.com/sepaga>viagra on line</a><br />
<a href=http://www.kaboodle.com/kesigucokake>viagra online cheap</a><br />
<a href=http://www.kaboodle.com/hofecefey>viagra online stores</a><br />
<a href=http://www.kaboodle.com/bonihobaqeq>viagra online uk</a><br />
<a href=http://www.kaboodle.com/ciyoqu>viagra or cialis</a><br />
<a href=http://www.kaboodle.com/kipucirisoyo>viagra oral jelly</a><br />
<a href=http://www.kaboodle.com/nohekofogebe>viagra prescription uk</a><br />
<a href=http://www.kaboodle.com/yavudimey>viagra rrp australia</a><br />
<a href=http://www.kaboodle.com/dofutaqop>viagra rrp australia cost</a><br />
<a href=http://www.kaboodle.com/forobuwihid>viagra side effects</a><br />
<a href=http://www.kaboodle.com/vetejiq>viagra soft tabs</a><br />
<a href=http://www.kaboodle.com/jadagixohik>viagra suppliers in the uk</a><br />
<a href=http://www.kaboodle.com/lixepocoqoy>viagra uk cheap purchase buy</a><br />
<a href=http://www.kaboodle.com/sepedafez>viagra uterine thickness</a><br />
<a href=http://www.kaboodle.com/pudayo>viagra vs cialis</a><br />
<a href=http://www.kaboodle.com/cekosayohana>viagra without a prescription</a><br />
<a href=http://www.kaboodle.com/mufiqunojuye>viagra without prescription</a><br />
<a href=http://www.kaboodle.com/borucoz>watermelon viagra affect</a><br />
<a href=http://www.kaboodle.com/memumoroxep>what is celebrex</a><br />
<a href=http://www.kaboodle.com/neleroce>what is celebrex used for</a><br />
<a href=http://www.kaboodle.com/loyejeta>what is generic viagra</a><br />
<a href=http://www.kaboodle.com/feyozitibi>what is soma</a><br />
<a href=http://www.kaboodle.com/fofefihayuv>what is the medication soma for</a><br />
<a href=http://www.kaboodle.com/faloherezu>what is viagra</a><br />
<a href=http://www.kaboodle.com/tekomi>what type of drug is soma</a><br />
<a href=http://www.kaboodle.com/sobidelo>where can i buy viagra online</a><br />
</u></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>,  <a href="http://custardbelly.com/blog/category/prana/" title="View all posts in Prana" rel="category tag">Prana</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2009/01/20/dependency-injection-and-ioc-at-bdp/#comments" rev="post-78"  title="Comment on Dependency Injection and IoC at BDP">2 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2009-01-20T11:17">January 20, 2009</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-78-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-77" class="post-77 post hentry category-flash category-flex category-flextasks full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2008/12/11/flex-ant-tasks-and-flexfileset-error/" title="Permanent link to Flex Ant Tasks and FlexFileSet error" rel="bookmark" rev="post-77">Flex Ant Tasks and FlexFileSet error</a></h1>
	
	<div class="entry-content full-content">
		<p><em>*This is more of a post-reminder or a google-search aha than a soliloquy on the joys of FlexTasks and how to use them. If you want to know more about <a href="http://labs.adobe.com/wiki/index.php/Flex_Ant_Tasks">flextasks, visit here</a>, or <a href="http://www.boostworthy.com/blog/" target="_blank">Ryan Taylor&#8217;s blog</a> for some good tips, or pick up <a href="http://www.amazon.com/Flex-Cookbook-Code-Recipes-Developers-Developer/dp/0596529856/ref=pd_bbs_sr_1?ie=UTF8&#038;s=books&#038;qid=1229047533&#038;sr=8-1" target="_blank">this wonderful book</a>&#8230; the holidays are coming.</em></p>
<p>I have had the fortunate opportunity to work with <a href="http://blog.zupko.info/" target="_blank">Andy Zupko</a> on a project here at <a href="http://infrared5.com/" target="_blank">Infrared5</a>. We have our good days and our bad days &#8211; as most projects go &#8211; and hopefully we&#8217;ll be able to showcase our efforts at some time. Recently i started whipping the project into shape to handle modules, rsls and loaded styles to minimize the download time and highten user experience. Why does it always come down to the last few days to get this up and running? I don&#8217;t know. Maybe we&#8217;re so gung-ho to get things finished for an iteration and to show a client that deployment structure falls a little to the wayside. In any event Andy, and in some part me i suppose, structured the project to have minimal impact when it came time to have a deployment routine and manage runtime styles and rsls. Enough horn-tooting! What am i talking about?</p>
<p>Well, when it came time to set up the ant tasks that will take over the deployment and distribution of the application i was hitting a wall in compiling against an rsl. More to the point, i was getting this error:</p>

<div class="wp_syntax"><div class="code"><pre class="mxml" style="font-family:monospace;">BUILD FAILED : No directory specified for FlexFileSet.</pre></div></div>

<p>&#8230; when combined with this directive</p>

<div class="wp_syntax"><div class="code"><pre class="mxml" style="font-family:monospace;"><span style="color: #000000;">&lt;compiler .external-library-path<span style="color: #7400FF;">&gt;</span></span>
	<span style="color: #000000;">&lt;include name=<span style="color: #ff0000;">&quot;${app.dir}/${rsl.name}.swc&quot;</span> <span style="color: #7400FF;">/&gt;</span></span>
<span style="color: #000000;">&lt;/compiler<span style="color: #7400FF;">&gt;</span></span></pre></div></div>

<p>I&#8217;m not gonna go into the nuts and bolts of the build file or even attempt to explain what that error means. I am familiar with compiling applications and modules from the Terminal and pretty much love doing most things from the terminal rather than relying on tools in eclipse, but i thought to bring experience down to a playing ground for a project that will be handed off to a client at some point, go with flex ant tasks. It&#8217;s well documented. Google finds most answers. Etc. But there are subtle changes to syntax that i am unfamiliar with when it comes to create a build file targeting the command line tools of the SDK.</p>
<p>In any event, it baffled me why this command would not work. It syntactically looked correct to me. The compiler directive is spelled correctly, the option variable is the correct path&#8230; wtf. Well just like the -library-path option i suppose you had to remove the directory that the SWC lives in from the variable and add it as a dir property.</p>

<div class="wp_syntax"><div class="code"><pre class="mxml" style="font-family:monospace;"><span style="color: #000000;">&lt;compiler .external-library-path dir=<span style="color: #ff0000;">&quot;${app.dir}&quot;</span><span style="color: #7400FF;">&gt;</span></span>
	<span style="color: #000000;">&lt;include name=<span style="color: #ff0000;">&quot;${rsl.name}.swc&quot;</span> <span style="color: #7400FF;">/&gt;</span></span>
<span style="color: #000000;">&lt;/compiler<span style="color: #7400FF;">&gt;</span></span></pre></div></div>

<p>Works! All is fine&#8230; but it took a hell of a long time to figure that out. Thought i would post this for any Terminal monkeys out there that run across this issue when building an ant file for compiling rsls into your application.</p>
<p>Was I bone-head for 2 hours? Probably&#8230;. feel free to leave a comment.</p>
<p><strong>[Update February 3rd, 2009]</strong> &#8211; <a href="http://www.boostworthy.com/blog/" target="_blank">Ryan Taylor</a> sent a solution that he uses (after being welcomed by my wordpress comments failure), which i find pretty elegant and will use in the future.</p>

<div class="wp_syntax"><div class="code"><pre class="mxml" style="font-family:monospace;"><span style="color: #000000;">&lt;mxmlc ...<span style="color: #7400FF;">&gt;</span></span>
       <span style="color: #000000;">&lt;runtime -shared-library-path path-element=<span style="color: #ff0000;">&quot;${libs}/MyLibrary.swc&quot;</span><span style="color: #7400FF;">&gt;</span></span>
           <span style="color: #000000;">&lt;url rsl-url=<span style="color: #ff0000;">&quot;MyLibrary.swf&quot;</span> <span style="color: #7400FF;">/&gt;</span></span>
           <span style="color: #000000;">&lt;url policy-file-url=<span style="color: #ff0000;">&quot;&quot;</span> <span style="color: #7400FF;">/&gt;</span></span>
    <span style="color: #000000;">&lt;/runtime<span style="color: #7400FF;">&gt;</span></span>
<span style="color: #000000;">&lt;/mxmlc<span style="color: #7400FF;">&gt;</span></span></pre></div></div>

<p>Thanks, Ryan!</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>,  <a href="http://custardbelly.com/blog/category/flextasks/" title="View all posts in FlexTasks" rel="category tag">FlexTasks</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2008/12/11/flex-ant-tasks-and-flexfileset-error/#comments" rev="post-77"  title="Comment on Flex Ant Tasks and FlexFileSet error">14 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2008-12-11T22:14">December 11, 2008</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-77-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-76" class="post-76 post hentry category-conferences category-flex category-infrared5 category-prana full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2008/11/23/back-from-max/" title="Permanent link to Back from MAX" rel="bookmark" rev="post-76">Back from MAX</a></h1>
	
	<div class="entry-content full-content">
		<p>Just got back from <a href="http://max.adobe.com/">Adobe MAX</a> and a sweet short vacation for the missus and i. Been to SF only once, when i was 9, and all i cared about were Garbage Pail Kids and pleading with my mom to buy me some Nikes. Needless to say, i remember &#8211; i think &#8211; a lot more about this last trip.</p>
<p>I was overjoyed to be able to sit on the Flex Architecture Face-Off panel with <a href="http://rewindlife.com/">Chafic Kazoun</a>, <a href="http://thefactoryfactory.com/wordpress/">Josh Noble</a> and <a href="http://flexblog.faratasystems.com/">Yakov Fain</a>. They are amazing architects with strong beliefs and open ears. We had a pretty good turnout and the session ended up being sold out. Only noticed one person walk out, but as it turns out they were over-caffeinated&#8230;</p>
<p>It was my first MAX and i didn&#8217;t know what to expect with the record-breaking attendance and my bundle of nerves. All said, i really enjoyed it and renewed my interest in the software platform that constantly evolves and inspires me to keep digging even after the workday is over. Of course it was centered around Adobe products, but i truly got the sense of it being a presentation rather than being force-fed. A lot of great things are on the horizon and even though i am a mark-up snob in a sense, i love the direction that the Flex platform is taking. Would have liked more &#8216;inspire&#8217; sessions, but <a href="http://www.boostworthy.com/blog/">Ryan Taylor</a>, <a href="http://blog.andre-michelle.com/">Andre Michelle</a> and <a href="http://www.quasimondo.com/">Mario Klingemann</a> kept me wide-eyed and ready to go back to my room to code&#8230; although there always seemed to be free beer that blocked the exit <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<p>Adobe also sponsored a party on Tuesday night at the <a href="http://www.famsf.org/deyoung/">de Young</a> and <a href="http://www.calacademy.org/">Science Academy</a>. I thought that these were venerable institutions in Golden Gate park, but it was dark and as I later found out after going with the missus again later in the week that the are relatively new. If you are in the SF area anytime soon, i highly recommend checking them out. That was a great night with two great museums and some really great friends&#8230; plus me and <a href="http://thefactoryfactory.com/wordpress/">Josh</a> schooled some poor saps in Foosball&#8230; after i got schooled in NBA Jams by <a href="http://www.razorberry.com/blog/">Ash</a> &#8211; rematch, all i&#8217;ll say.</p>
<p>Some people found me after our panel and had some questions about things i brought up that i wish i could have gone into further:</p>
<p>1. As far as specs, docs and architecture go, I think your best bet is <a href="http://www.sparxsystems.com.au/products/ea/trial.html">Enterprise Architect</a>. That is, unless you are on a Mac in which case it is not available and i prefer <a href="http://www.omnigroup.com/applications/OmniGraffle/">Omnigraffle</a>.</p>
<p>2. I briefly mentioned <a href="http://www.pranaframework.org/">Prana</a> and IoC as a segue from scaffolding and I wish i had more time to devote to it during the panel. Though <a href="http://mate.asfusion.com/">Mate</a> does support some dependency injection for their event mapping, it is compiled in and i prefer an external application context that can be configured for runtime. We use it heavily at <a href="http://www.infrared5.com/">Infrared5</a> and I would whole-heartedly suggest you look into it for your next project &#8211; <a href="http://www.pranaframework.org/">Prana</a> developed by <a href="http://www.herrodius.com/blog/">Christophe Herreman</a>.</p>
<p>3. On the panel, we were all familiar with <a href="http://opensource.adobe.com/wiki/display/cairngorm/Cairngorm">Cairngorm</a> and mostly use it when business requirements and dev team size makes it a perfect fit. But i did bring up the black hole of state control that comes with it&#8230; in my opinion. I am quite taken with how <a href="http://puremvc.org/">PureMVC</a> handles state through mediators, but i have other weight-baring problems with <a href="http://puremvc.org/">PureMVC</a> that i can&#8217;t get around that make me choose <a href="http://opensource.adobe.com/wiki/display/cairngorm/Cairngorm">Cairngorm</a> when it comes to incorporating a micro-architecture into our projects. I basically said that i hate throwing string-denoted state on the ModelLocator that is bound to a view. I can&#8217;t stand it, but i do it because i know that developers are familiar with it. In my personal opinion i think this is the best case for the Strategy pattern. I like the Mediator pattern as well, but i think there is too much baggage and extra code that needs to be thrown in an if..else of switch..case. I know that Strategy is  behaviour pattern but i see it fitting in nicely with presentation as well. I can go into that farther in another post if you all want, but i just wanted to convey that even though you might represent a simple string on a global model, i think you are losing the loose-coupling infrastructure&#8230; but don&#8217;t even get me started on Singleton models&#8230; this 3 point has already run too long.</p>
<p>In any event, if you sat in on the panel, I would love to hear your thoughts &#8211; good, bad and ugly. Leave a comment&#8230; and bundle up, it&#8217;s cold here in boston.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/conferences/" title="View all posts in Conferences" rel="category tag">Conferences</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>,  <a href="http://custardbelly.com/blog/category/infrared5/" title="View all posts in Infrared5" rel="category tag">Infrared5</a>,  <a href="http://custardbelly.com/blog/category/prana/" title="View all posts in Prana" rel="category tag">Prana</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2008/11/23/back-from-max/#comments" rev="post-76"  title="Comment on Back from MAX">10 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2008-11-23T19:05">November 23, 2008</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-76-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-75" class="post-75 post hentry category-air category-books category-flash category-flex full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2008/09/03/errata-or-just-a-helpful-hint/" title="Permanent link to Errata or just a helpful hint?" rel="bookmark" rev="post-75">Errata or just a helpful hint?</a></h1>
	
	<div class="entry-content full-content">
		<p>For those of you who have a copy of the <a href="http://www.amazon.com/Adobe-AIR-Create-Modify-Programmer/dp/0470182075/ref=pd_bbs_sr_1?ie=UTF8&#038;s=books&#038;qid=1220490556&#038;sr=8-1" target="_blank">Adobe Air Create-Modify-Reuse book</a> that myself and <a href="http://blog.nobien.net/" target="_blank">Marc Leuchner and Matt Wright (of NoBien fame)</a> authored, we hope you are enjoying it and i also may have a bit of errata for Chapter 1 if you are running Leopard. For those of you who don&#8217;t have a copy of the <a href="http://www.amazon.com/Adobe-AIR-Create-Modify-Programmer/dp/0470182075/ref=pd_bbs_sr_1?ie=UTF8&#038;s=books&#038;qid=1220490556&#038;sr=8-1" target="_blank">book</a> (go buy it) and/or are running Leopard and want to use the Flex SDK command line tools, this may be of interest&#8230;</p>
<p>In Chapter 1 of the Adobe AIR Create-Modify-Reuse book, <em>The Development Environment</em>, it states that in order to set a PATH variable for your command line tools that you should:</p>
<p><strong>1.</strong> Open the Terminal and type <strong>> open -e .profile</strong><br />
<strong>2.</strong> Add the path to the /bin folder of your SDK installation (I paraphrased&#8230; but you get the idea)</p>
<p>In Tiger this is all well and good, and if you are running in Tiger you can drop off or read on if you intend to upgrade to Leopard. Setting system paths in Leopard has changed and you no longer have a <em>.profiles</em> file in your User directory to which you can add/append paths. The following steps are what i took to add a path to the Flex SDK command line tools under Leopard:</p>
<p><strong>1.</strong> Open the Terminal and navigate to /etc/paths.d<br />
<strong>2.</strong> Create a file named &#8216;flex&#8217; &#8211; (sans quotes)<br />
<strong>3.</strong> Enter the following command: <strong>> pico flex</strong><br />
<strong>4.</strong> Enter: <strong>/Applications/flex_sdk_3/bin</strong><br />
<strong>5.</strong> Exit and Save</p>
<p>You will need to restart your computer.</p>
<p><em>*Note: /Applications/flex_sdk_3/bin points to the /bin directory of my Flex 3 SDK installation, change as you see fit to your installation.</em></p>
<p>I can&#8217;t go into the long and short of why this needs to take place in Leopard, but that will get you up and running with the command line tools if running under Leopard; i can however tell you i used the following to set me on the right path (no pun intended):</p>
<p><a href="http://littlesquare.com/2008/01/24/upgraded-to-leopard-making-use-of-etcpathsd-and-path_helper/" target="_blank">here</a> and <a href="http://old.blog.elliottcable.name/articles/2007/10/leopard-paths" target="_blank"> here</a> </p>
<p>I apologise if anyone had purchased <a href="http://www.amazon.com/Adobe-AIR-Create-Modify-Programmer/dp/0470182075/ref=pd_bbs_sr_1?ie=UTF8&#038;s=books&#038;qid=1220490556&#038;sr=8-1" target="_blank">the book</a> and tried to go through Chapter 1 with a Leopard installation. I did not know that setting PATH variables had changed and I was running Tiger when written and up until about a couple weeks ago when my HD went on the lam and i was greeted by a series of &#8216;Do Not Enter&#8217; and &#8216;Missing File&#8217; icons on start-up&#8230; all is well though, and they replaced my HD and installed Leopard for free!</p>
<p>For those of you have a copy of the book, i hope you are enjoying it. For those who are trying to get the tools up and running and just switched to Leopard i hope this is useful.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/air/" title="View all posts in AIR" rel="category tag">AIR</a>,  <a href="http://custardbelly.com/blog/category/books/" title="View all posts in Books" rel="category tag">Books</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2008-09-03T21:14">September 3, 2008</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-75-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-74" class="post-74 post hentry category-beer category-conferences category-flash full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2008/08/07/flash-on-tap-boston/" title="Permanent link to Flash on Tap : Boston" rel="bookmark" rev="post-74">Flash on Tap : Boston</a></h1>
	
	<div class="entry-content full-content">
		<p>Beer and Flash. </p>
<p>Now, i plead guilty to introducing the two from time to time &#8230; and sometimes more of one than the other. : ) </p>
<p>&#8230; and here comes an opportunity to mingle micro-brew tasting with some of the most intelligent minds in the business&#8230; and in Boston no less!</p>
<p><a href="http://flashontap.com/fot/index.html">Flash on Tap</a> is in Boston from October 7th until the 9th. <a href="http://flashontap.com/fot/index.html#/tickets/">Get you tickets</a> while the<a href="http://flashontap.com/fot/index.html#/tickets/early%20bird/"> super early and early bird special</a> last!</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/beer/" title="View all posts in Beer!" rel="category tag">Beer!</a>,  <a href="http://custardbelly.com/blog/category/conferences/" title="View all posts in Conferences" rel="category tag">Conferences</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2008-08-07T21:08">August 7, 2008</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-74-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-73" class="post-73 post hentry category-as3 category-books category-flex full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2008/07/15/flex-3-cookbook-clarifications/" title="Permanent link to Flex 3 Cookbook clarifications" rel="bookmark" rev="post-73">Flex 3 Cookbook clarifications</a></h1>
	
	<div class="entry-content full-content">
		<p><a href="http://thefactoryfactory.com/wordpress/" target="_blank">Josh Noble</a> &#8211; the main man behind the <a href="http://www.amazon.com/Flex-Cookbook-Code-Recipes-Developers-Developer/dp/0596529856/ref=pd_sim_b_2" target="_blank">Flex 3 Cookbook</a> of which i had the esteem pleasure of being part of (thanks again, j-man) &#8211; has <a href="http://thefactoryfactory.com/wordpress/?p=435">recently blogged</a> about some more information involving the files for download and the intention of the book.</p>
<p>Wanted to blog about it as well, as i feel there is some great information from his post about the decision for cutting chapters and where to download code and the best way to submit errata. He also mentions the heartbreaking decision to cut chapters and recipes from the book to preserve page count&#8230; but don&#8217;t put the book back on the shelf, they are available to download!</p>
<p>We hope people are enjoying the book at what any level developer you are. Cheers to Josh and happy coding!</p>
<p><a href="http://thefactoryfactory.com/wordpress/?p=435">read Josh&#8217;s post</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/books/" title="View all posts in Books" rel="category tag">Books</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2008/07/15/flex-3-cookbook-clarifications/#comments" rev="post-73"  title="Comment on Flex 3 Cookbook clarifications">1 comment</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2008-07-15T20:01">July 15, 2008</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-73-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-72" class="post-72 post hentry category-as3 category-astro category-flash category-flex full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2008/05/15/yet-another-post-about-astro/" title="Permanent link to Yet another post about Astro" rel="bookmark" rev="post-72">Yet another post about Astro</a></h1>
	
	<div class="entry-content full-content">
		<p>If you read MXNA, you probably have stopped checking quite some time ago because every post is about <a href="http://labs.adobe.com/technologies/flashplayer10/"  target="_blank">Astro</a>&#8230;<br />
but if you are interested in another way to set up your projects in FlexBuilder to target FP10 without having to muck about with files in the frameworks folder of your <em>original</em> Flex3 SDK installation this post may shed some light.</p>
<p>I am a workspace fanatic when it comes to development. I like things tidy, and when i start a new client project or go into some new exploration that involves multiple projects, i create a new workspace. The great thing about workspaces for me, aside from keeping things neat in my head, is that each new project you create in that workspace inherits from any default settings. So <a href="http://blogs.zdnet.com/Stewart/?p=841" target="_blank">when the big news hit</a> and i wanted to check out the latest SDK, i created a new workspace and followed <em>most</em> of the <a href="http://opensource.adobe.com/wiki/display/flexsdk/Targeting+Flash+Player+10+Beta+with+Flex+SDK+3.0.x">excellent directions already available on the adobe open source site</a>. I only strayed a little in how i went about setting my workspace up so that every new project i created in it was *almost* set for development targeted at FP10 without having to run through the process each time. </p>
<p>The following is the process i took to only mess with the files from the nightly build and set defaults for a single workspace in order to play around with the current features available in Astro:<br />
<strong><br />
1</strong>. Download Flash Player 10 codenamed Astro.<br />
<strong>2</strong>. Download the nightly build and unzip to some directory. (for me that is /Applications/flex_sdk_3.0.1.1728<br />
<strong>3</strong>. Open FlexBuilder or Eclipse (if you have the plugin) and create a new workspace. (ie. ~/Documents/workspace/astro).<br />
<strong>4</strong>. Create a new project.<br />
<strong>5</strong>. Navigate to Project>Properties<br />
<strong>6</strong>. Select the Flex Compiler option<br />
<strong>7</strong>. Under Flex SDK version, click Configure Flex SDKs&#8230;<br />
<strong>8</strong>. In the Preferences (Filtered) window, select Add<br />
<strong>9.</strong> Navigate to the installation of your nightly build. (ie. /Applications/flex_sdk_3.0.1.1728)<br />
<strong>10</strong>. Add a new name for the SDK&#8230; you should see something like so:</p>
<p><img src="http://custardbelly.com/blog/images/astro.jpg" alt="Flex Builder Astro set up"/>&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8221;&#8217;                                                                                                          </p>
<p><strong>11</strong>. Click OK, Then tick the checkbox next to the newly added sdk in the Installed Flex SDKs window.<br />
<strong>12</strong>. Click Apply, then OK.<br />
<strong>13</strong>. Then back in the Project Properties folder, under Use a specific SDK, if the newly added SDK isn&#8217;t selected, select it.<br />
<strong>14</strong>. Under the Required Flash Player Version, change the value to 10.0.0<br />
<strong>15</strong>. In the Project Properties window on the left side, select Flex Build Path> Library Path.<br />
<strong>16</strong>. Expand the SDK you just set as default, and select the playerglobal.swc and Remove it.<br />
<strong>17</strong>. Click Add SWC, and navigate to the player 10 swc from your nightly build SDK installation (ie. /Applications/flex_sdk_3.0.1.1728/frameworks/libs/player/10/playerglobal.swc)<br />
<strong>18</strong>. Click Apply, then OK.<br />
<strong>19</strong>. Open up the flex-config.xml file from the Astro SDK installation and update the settings <a href="http://opensource.adobe.com/wiki/display/flexsdk/Targeting+Flash+Player+10+Beta+with+Flex+SDK+3.0.x" target="_blank">as described in the first part of the Command-line Compiler instructions from here</a>.</p>
<p>Thats it! Only 19 steps&#8230; that seems like a lot. In any case, in ensures that any project you now build under that workspace will default to using the targeted SDK. You will still have to manually change the Required Flash Version (from step 14) before you compile a new project, but other than that when you want to tinker with the nightly build &#8211; and not mess with your stable Flex 3 SDK release that other projects in other workspaces are targeting &#8211; just hop over to that workspace.<br />
<strong><br />
Good reading</strong>:<br />
Ryan Stewart &#8211; <a href="http://blogs.zdnet.com/Stewart/?p=841">Flash Player 10 codename &#8220;Astro&#8221; goes beta</a><br />
Tinic Uro &#8211; <a href="http://www.kaourantin.net/">Adobe Is Making Noise series</a><br />
Keith Peters &#8211; <a href="http://www.bit-101.com/blog/?p=1264">Astro Dynamic Sound!</a><br />
Josh Tynjala &#8211; <a href="http://www.zeuslabs.us/2008/05/15/gratuitous-text-effects-courtesy-of-flash-player-10/">Gratuitous Text Effects</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/astro/" title="View all posts in Astro" rel="category tag">Astro</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2008/05/15/yet-another-post-about-astro/#comments" rev="post-72"  title="Comment on Yet another post about Astro">4 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2008-05-15T22:25">May 15, 2008</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-72-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-71" class="post-71 post hentry category-as3 category-flash category-flex category-prana full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2008/05/10/prana-and-compiled-classes/" title="Permanent link to Prana and compiled classes" rel="bookmark" rev="post-71">Prana and compiled classes</a></h1>
	
	<div class="entry-content full-content">
		<p>I have recently gotten into incorporating <a href="http://www.pranaframework.org/" target="_blank">Prana &#8211; the Inversion of Control framework of AS3</a> created by <a href="http://www.herrodius.com/blog/" target="_blank">Christophe Herreman</a>- into my projects. I gotta say, it&#8217;s beautiful piece of work and makes me rethink my approach to the architecture of applications again.</p>
<p>I don&#8217;t want to go into IoC and dependency injection and how your applications can truly benefit by using the <a href="http://www.pranaframework.org/" target="_blank">Prana</a> framework, as this post may get pretty long and these references are much better reading than my rambling:</p>
<p>Christophe&#8217;s blog: <a href="http://www.herrodius.com/blog/" target="_blank">http://www.herrodius.com/blog/</a><br />
Martin Fowler&#8217;s <a href="http://martinfowler.com/articles/injection.html" target="_blank">Inversion of Control Containers and the Dependency injection pattern</a><br />
<a href="http://en.wikipedia.org/wiki/Hollywood_Principle" target="_blank">the hollywood principle</a></p>
<p>What i did want to bring up is that i had a small problem with the workflow and how i develop. Which is my problem, of course <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  but nonetheless&#8230;</p>
<p>One important thing to remember is that the context file is an external file that is loaded by the application at runtime. This means you will need to have all the possible classes your application <em>may</em> use already compiled into the SWF in order for the objects to be instantiated and your application to work. If you are typing to interfaces, this could prove to be a bit of a problem. You could create a reference for each class that may be needed in another class that is known to be compiled into the SWF &#8211; as Christophe explains <a href="http://www.herrodius.com/blog/65">in this post</a> &#8211; but that always seemed dirty to me. </p>
<p>As is mentioned in the comments to that <a href="http://www.herrodius.com/blog/65">post</a>, you can also go about adding each class using the -includes compiler option. Adding all possible classes using the -includes option makes for an excellent case on when to use additional compiler configurations, and presents the option to really just change the application context file and the additional configuration file as the project sees fit, without having to open up the source and tack on or remove dummy references to classes.</p>
<p>As an example, take for instance this application context file:</p>

<div class="wp_syntax"><div class="code"><pre class="mxml" style="font-family:monospace;"><span style="color: #000000;">&lt; ?xml version=<span style="color: #ff0000;">&quot;1.0&quot;</span> encoding=<span style="color: #ff0000;">&quot;utf-8&quot;</span>?<span style="color: #7400FF;">&gt;</span></span>
<span style="color: #000000;">&lt;objects<span style="color: #7400FF;">&gt;</span></span>
	<span style="color: #000000;">&lt;property file=<span style="color: #ff0000;">&quot;app.properties&quot;</span> <span style="color: #7400FF;">/&gt;</span></span>
	<span style="color: #000000;"><span style="color: #808080; font-style: italic;">&lt;!-- Handles direct invocation on client --&gt;</span></span>
	<span style="color: #000000;">&lt;object id=<span style="color: #ff0000;">&quot;callbackHandler&quot;</span> class=<span style="color: #ff0000;">&quot;com.example.responder.CallbackResponderImpl&quot;</span> <span style="color: #7400FF;">/&gt;</span></span>
	<span style="color: #000000;"><span style="color: #808080; font-style: italic;">&lt;!-- Handles connection to Red5 application --&gt;</span></span>
	<span style="color: #000000;">&lt;object id=<span style="color: #ff0000;">&quot;connectionDelegate&quot;</span> class=<span style="color: #ff0000;">&quot;com.example.business.ConnectionDelegateImpl&quot;</span><span style="color: #7400FF;">&gt;</span></span>
		<span style="color: #000000;">&lt;property name=<span style="color: #ff0000;">&quot;rtmpURI&quot;</span> value=<span style="color: #ff0000;">&quot;${app.rtmpURI}&quot;</span> <span style="color: #7400FF;">/&gt;</span></span>
		<span style="color: #000000;">&lt;property name=<span style="color: #ff0000;">&quot;client&quot;</span><span style="color: #7400FF;">&gt;</span></span>
			<span style="color: #000000;">&lt;ref<span style="color: #7400FF;">&gt;</span></span>callbackHandler<span style="color: #000000;">&lt;/ref<span style="color: #7400FF;">&gt;</span></span>
		<span style="color: #000000;">&lt;/property<span style="color: #7400FF;">&gt;</span></span>
	<span style="color: #000000;">&lt;/object<span style="color: #7400FF;">&gt;</span></span>
<span style="color: #000000;">&lt;/objects<span style="color: #7400FF;">&gt;</span></span></pre></div></div>

<p>.. for each possible implementation of <strong>ConnectionDelegate</strong> and <strong>CallbackResponder</strong> that i may decide to swap in and out as the project seems fit, i would either need to hold a reference to each implementation in some class sure or be compiled into the SWF, or i could store them in an additional config file that can be added using the -load-config option with an additional value:</p>
<p>The <strong>prana.config</strong> file:</p>

<div class="wp_syntax"><div class="code"><pre class="mxml" style="font-family:monospace;"><span style="color: #000000;">&lt;flex -config<span style="color: #7400FF;">&gt;</span></span>
	<span style="color: #000000;">&lt;includes append=<span style="color: #ff0000;">&quot;true&quot;</span><span style="color: #7400FF;">&gt;</span></span>
		<span style="color: #000000;">&lt;symbol<span style="color: #7400FF;">&gt;</span></span>com.example.reponder.CallbackResponderImpl<span style="color: #000000;">&lt;/symbol<span style="color: #7400FF;">&gt;</span></span>
		<span style="color: #000000;">&lt;symbol<span style="color: #7400FF;">&gt;</span></span>com.example.business.ConnectionDelegateImpl<span style="color: #000000;">&lt;/symbol<span style="color: #7400FF;">&gt;</span></span>
	<span style="color: #000000;">&lt;/includes<span style="color: #7400FF;">&gt;</span></span>
<span style="color: #000000;">&lt;/flex<span style="color: #7400FF;">&gt;</span></span></pre></div></div>

<p>&#8230; drop that in my source folder and add the compiler option:</p>

<div class="wp_syntax"><div class="code"><pre class="mxml" style="font-family:monospace;">-load-config+=prana.config</pre></div></div>

<p>From there, i could change the context as i see fit, update the prana.config file to reflect my preferences and just recompile the application without having to go into the source and muck about. It&#8217;s a little more clean for me and allows me to happily go about using the <a href="http://www.pranaframework.org/" target="_blank">Prana</a> framework.</p>
<p>The best part is that <a href="http://www.herrodius.com/blog/64">Prana is truthfully AS3 compliant</a>! Meaning you can use it in your Flex <em>AND</em> AS3 projects, which cannot be said for some frameworks that claim to be AS3 and actually use class from the mx package&#8230; (looking at you <a href="http://code.google.com/p/as3lib/">as3lib</a>). <em>A huge pet-peeve of mine.</em><br />
*Last i checked, the source under version control doesn&#8217;t seem to reflect the current changes <a href="http://www.herrodius.com/blog/" target="_blank">Christophe</a> has made, but they are included in the downloads.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>,  <a href="http://custardbelly.com/blog/category/prana/" title="View all posts in Prana" rel="category tag">Prana</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2008/05/10/prana-and-compiled-classes/#comments" rev="post-71"  title="Comment on Prana and compiled classes">4 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2008-05-10T14:58">May 10, 2008</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-71-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-70" class="post-70 post hentry category-flex full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2008/04/16/styling-the-whitebox-of-a-flex-container/" title="Permanent link to Styling the whiteBox of a Flex Container" rel="bookmark" rev="post-70">Styling the whiteBox of a Flex Container</a></h1>
	
	<div class="entry-content full-content">
		<p>You can&#8217;t&#8230; That is to say, there is no style property to change the color of that little white box that appears in the lower right of a Container component when the vertical and horizontal scrollbars are present.</p>
<p>Today, i added a Canvas that had fixed dimensions to the displaylist of a Flex application. Because the content within the Canvas instance would vary in size, vertical and horizontal scrollbars are needed for content that is larger than the width and height of the fixed dimensions of its parent container. When both scrollbars are present on the display, they meet in the lower right and create an empty space. That empty space is actually a FlexShape in the Container class called whiteBox. The whiteBox shape is protected, but is added and removed programmatically within private methods based on the presence of both directional scrollbars. </p>
<p>Fine by me&#8230; the problem i have is that the color of whiteBox is hard-coded ( to #FFFFFF ). Super! I guess if you name something with a prefix that is a color, you have to hard-code the actual color it will be using to draw&#8230; </p>
<p>There is an easy work-around by just creating a subclass of Canvas and overriding the updateDisplayList() method to remove whiteBox, but it seems kind of hackish, especially if it is going to be added each time the vert and horiz scrollbars are added to the display and then i have to remove it again.</p>
<p>Here&#8217;s an example of how i resolved my issue:</p>

<div class="wp_syntax"><div class="code"><pre class="actionscript" style="font-family:monospace;">package
<span style="color: #66cc66;">&#123;</span>
    <span style="color: #0066CC;">import</span> mx.<span style="color: #006600;">containers</span>.<span style="color: #006600;">Canvas</span>;
&nbsp;
    <span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">class</span> NoWhiteBoxContainer <span style="color: #0066CC;">extends</span> Canvas
    <span style="color: #66cc66;">&#123;</span>
        <span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">function</span> NoWhiteBoxContainer<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#123;</span>	<span style="color: #0066CC;">super</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>; <span style="color: #66cc66;">&#125;</span>
&nbsp;
        override protected <span style="color: #000000; font-weight: bold;">function</span> updateDisplayList<span style="color: #66cc66;">&#40;</span> unscaledWidth:<span style="color: #0066CC;">Number</span>, unscaledHeight:<span style="color: #0066CC;">Number</span> <span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
        <span style="color: #66cc66;">&#123;</span>
            <span style="color: #0066CC;">super</span>.<span style="color: #006600;">updateDisplayList</span><span style="color: #66cc66;">&#40;</span> unscaledWidth, unscaledHeight <span style="color: #66cc66;">&#41;</span>;
&nbsp;
            <span style="color: #b1b100;">if</span><span style="color: #66cc66;">&#40;</span> whiteBox <span style="color: #66cc66;">&#41;</span> rawChildren.<span style="color: #006600;">removeChild</span><span style="color: #66cc66;">&#40;</span> whiteBox <span style="color: #66cc66;">&#41;</span>;
        <span style="color: #66cc66;">&#125;</span>
    <span style="color: #66cc66;">&#125;</span>
<span style="color: #66cc66;">&#125;</span></pre></div></div>

<p>Nothing extremely complicated, but it would have been nice to just set a style property or for the fill color to inherit from the backgroundColor property. ah well&#8230; Hopefully someone may find this post if they are wondering what to do with that white box.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2008/04/16/styling-the-whitebox-of-a-flex-container/#comments" rev="post-70"  title="Comment on Styling the whiteBox of a Flex Container">4 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2008-04-16T18:01">April 16, 2008</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-70-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-69" class="post-69 post hentry category-air category-as3 category-apollo category-books category-flash category-flex category-infrared5 category-red5 full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2008/02/24/looking-back-and-looking-forward/" title="Permanent link to Looking back and looking forward" rel="bookmark" rev="post-69">Looking back and looking forward</a></h1>
	
	<div class="entry-content full-content">
		<p>For those of you that still follow this blog, you may have noticed that i have not been too knee-deep in blogging. A measly 5 posts ago, <a href="http://custardbelly.com/blog/?p=58" target="_blank">i rambled on</a> about what 2007 might bring. Needless to say it had kept me pretty busy &#8211; and for all good reason. I have had the opportunity to work alongside some unbelievably talented people and be a part of two amazing books focused on <a href="http://labs.adobe.com/technologies/air/" target="_blank">Adobe AIR</a> and <a href="http://labs.adobe.com/technologies/flex/" target="_blank">Flex 3</a> that will be hitting shelves soon. I also accepted a position at <a href="http://www.infrared5.com" target="_blank">Infrared5</a> and am looking forward to working with some of the most insane and brilliant minds in the industry.</p>
<p><a href="http://www.amazon.com/Adobe-AIR-Create-Modify-Reuse/dp/0470182075/ref=pd_bbs_sr_8?ie=UTF8&#038;s=books&#038;qid=1203806020&#038;sr=8-8"><img src="http://www.custardbelly.com/blog/images/air_cmr.jpg" alt="AIR Create-Modify-Reuse" /></a><br />
Marc Leuchner and Matt Wright (of <a href="http://blog.nobien.net/" target="_blank">NoBien</a> fame) and I have been burning the midnight oil to deliver an exciting book on <a href="http://www.amazon.com/Adobe-AIR-Create-Modify-Reuse/dp/0470182075/ref=pd_bbs_sr_8?ie=UTF8&#038;s=books&#038;qid=1203806020&#038;sr=8-8">Adobe AIR &#8211; AIR Create-Reuse-Modify</a> from Wiley Wrox press. Each chapter walks through building applications as you learn about the AIR API. We had a lot of fun architecting and writing about each application that highlights specific facets of the platform and hope it is as much fun to read. Adobe AIR and the API is part of the Flex 3 SDK, which might be <a href="http://www.onflex.org/ted/2008/02/flex-30-and-air-10-are-days-away.php" target="_blank">coming out soon</a>&#8230;</p>
<p><a href="http://www.amazon.com/Flex-3-Cookbook-Joshua-Noble/dp/0596529856/ref=pd_bbs_sr_1?ie=UTF8&#038;s=books&#038;qid=1203806666&#038;sr=8-1"><img src="http://www.custardbelly.com/blog/images/cookbook.jpg" alt="Flex 3 cookbook" /></a><br />
Well, i didn&#8217;t stop at discussing one part of the Flex 3 SDK and also was asked by <a href="http://thefactoryfactory.com/wordpress/" target="_blank">Josh Noble</a> to be a co-author for the <a href="http://www.amazon.com/Flex-3-Cookbook-Joshua-Noble/dp/0596529856/ref=pd_bbs_sr_1?ie=UTF8&#038;s=books&#038;qid=1203806666&#038;sr=8-1">Flex 3 Cookbook</a> from the O&#8217;Reilly press. We&#8217;ve gathered the submissions from the Adobe <a href="http://www.adobe.com/cfusion/communityengine/index.cfm?event=homepage&#038;productId=2" target="_blank">online cookbook</a> and Josh has been steering the cookbook ship to greatness. If you are unfamiliar with the <a href="http://www.oreilly.com/store/series/cookbooks.csp" target="_blank">O&#8217;Reilly cookbook</a> format, the book is designed to present hundreds of &#8216;recipes&#8217; aimed at solving programming problems. I have had the extreme pleasure to write about parts of the Flex API that i love and believe to be essential to RIAs developed using the Flash Platform.</p>
<p>If writing didn&#8217;t keep me busy enough, I worked with some amazing people while building applications that stretched the possibilities of what online and desktop applications built in Flex can do. Along the way i learned more about the business, some agile practices (which i hope to write about some) and how to have fun and love what i do. It is an amazing thing.</p>
<p><a href="http://infrared5.com" target="_blank"><img src="http://www.custardbelly.com/blog/images/infrared5.gif" alt="Infrared5" /></a><br />
I also have had the opportunity to join the <a href="http://www.infrared5.com" target="_blank">Infrared5</a> team and could not be happier. Infrared5 is a consulting company started by Chris Allen, Rebecca Allen and Dominick Accattato focused on architecting applications using the Flash Platform and Red5 Server technologies. <a href="http://bit-101.com/blog" target="_blank">Keith</a> summed it up pretty well <a href="http://www.bit-101.com/blog/?p=1163#comments">in this post</a>. I am honored to be in company with some of the brightest minds in the field that keep me laughing throughout the day. Once I stop breaking things around the office, i can settle in and learn something <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<p>All in all, 2007 was a great year and i am making out 2008 to be even better. Here&#8217;s to posting more!</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/air/" title="View all posts in AIR" rel="category tag">AIR</a>,  <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/apollo/" title="View all posts in Apollo" rel="category tag">Apollo</a>,  <a href="http://custardbelly.com/blog/category/books/" title="View all posts in Books" rel="category tag">Books</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>,  <a href="http://custardbelly.com/blog/category/infrared5/" title="View all posts in Infrared5" rel="category tag">Infrared5</a>,  <a href="http://custardbelly.com/blog/category/red5/" title="View all posts in Red5" rel="category tag">Red5</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2008/02/24/looking-back-and-looking-forward/#comments" rev="post-69"  title="Comment on Looking back and looking forward">3 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2008-02-24T11:22">February 24, 2008</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-69-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-64" class="post-64 post hentry category-general category-music full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2007/10/16/extra-tracks-and-how-things-change/" title="Permanent link to Extra tracks and how things change" rel="bookmark" rev="post-64">Extra tracks and how things change</a></h1>
	
	<div class="entry-content full-content">
		<p>To start off, recently i have been working remotely for my job&#8230; whole &#8216;nother discussion&#8230; and what was once the &#8216;office&#8217; (read: extra room where we didn&#8217;t know where to put stuff and has my computers) i retired to during the nights and weekends has become my proper &#8216;office&#8217; (read: i am in here all the time now). Essentially what this has boiled down to is having no boundaries of what music i can put on at any time &#8211; aside from the albums i had to leave behind at the store until i get another check and can free them.
<div style="display:none;"><a href="http://www.mp3allz.com/">John Hiatt</a><a href="http://www.mp3kio.com/">One_foot_in_the_grave Beck</a><a href="http://www.mp3kara.com/">Muslimgauze</a></div>
<p>This also has lead to me digging around and discovering some old gems that i just never bothered to bring to work or put on the iPod. And i started to notice with the CDs that some of them would end.  I&#8217;m enjoying my coffee. Hmm. It&#8217;s nice outside. Should i ta&#8230; &#8216;BA-DIT-IT-Y DUM    WHIRRRRrrr&#8217;. What the hell is that!?! Oh&#8230; yeah&#8230; extra track stuck on the end of the cd&#8230; you can get out from under the desk now.</p>
<p>Does that happen any more? I haven&#8217;t bought a CD in a long time that has that 4+ minute dead space at what should be the end of the CD that then drops that hidden song on. </p>
<p><strong>Todd at 14:</strong> &#8216;It&#8217;s not even freaking labeled on the <em>jacket</em>!?! What&#8217;s the name of this song? It&#8217;s awesome. Did Tim know that was there? Oh, man. That&#8217;s going onto the next mix tape.&#8217;</p>
<p>Todd just may have dated himself&#8230; </p>
<p>Anyway, I got to thinking&#8230; a) what happened to that suprise? is it that they still make &#8216;material&#8217; CDs only for poor schmos like me who like to hold something and that the production is no longer based on someone buying more than one song? b) i wonder what the equivalant in the internet world this &#8216;extra track&#8217; phenomenon is?</p>
<p>The answer to a) is probably yes and the fact that it was a fad. There was a time i couldn&#8217;t buy a CD without expecting an extra track hidden at the end, and i would spend my time hitting the seek button until i heard something. Was i disappointed if their was no extra track? Only if the rest of the album sucked and i felt i was suckered in by one song to buy it &#8211; looking at you Live. (remember this was a time before you could preview anything on the internet and it was a godsend if a record store had opened CDs you could pre-listen to&#8230;)</p>
<p>The answer to b)&#8230; hmm. Don&#8217;t know. I am always tempted to say &#8217;skip intro&#8217;. But i don&#8217;t know&#8230; that wasn&#8217;t really a treat most times <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /><br />
And, aside from obvious design and nomenclature, i am wondering if there was something that was prevalent on applications or websites that you couldn&#8217;t get away from whether you were interested or not&#8230; kind of like how you can&#8217;t buy a decent glam album nowadays without it being remastered with more extra tracks than the original album had. Good and bad and leaves you wondering how long it will last and if you really care if it&#8217;s gone&#8230; but you&#8217;ll write a blog about it 10+ years fter the fact.</p>
<p>I don&#8217;t know where i am going with this. Just rambling and looking at the crates of LP&#8217;s and stacks of CDs for something new to listen to&#8230;</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/general/" title="View all posts in General" rel="category tag">General</a>,  <a href="http://custardbelly.com/blog/category/music/" title="View all posts in Music" rel="category tag">Music</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2007/10/16/extra-tracks-and-how-things-change/#comments" rev="post-64"  title="Comment on Extra tracks and how things change">1 comment</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2007-10-16T20:24">October 16, 2007</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-64-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-62" class="post-62 post hentry category-air category-apollo category-books category-flex full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2007/10/05/air-invokeevent-and-filetypes/" title="Permanent link to AIR InvokeEvent and FileTypes" rel="bookmark" rev="post-62">AIR InvokeEvent and FileTypes</a></h1>
	
	<div class="entry-content full-content">
		<p>As some of you may know, <a href="http://www.designhonky.com/" target="_blank">Matt Wright</a> and <a href="http://www.forwardatlantic.com/marc/2006/" target="_blank">Marc Leuchner</a> (of <a href="http://blog.nobien.net/" target="_blank">nobien</a> fame) and I are authoring an <a href="http://www.amazon.com/Adobe-AIR-Create-Modify-Reuse/dp/0470182075/ref=pd_bbs_sr_6/002-5985048-8156021?ie=UTF8&#038;s=books&#038;qid=1191543407&#038;sr=8-6" target="_blank">Adobe AIR book</a> to be published by <a href="http://www.wiley.com/WileyCDA/" target="_blank">Wiley</a>. We&#8217;ve been breaking fingernails typing away to deliver a jam-packed by-examples book in which you&#8217;ll build real world applications while learning about the AIR API. As we&#8217;re writing, we run across some amazing features in AIR and yammer amongst ourselves &#8211; or to anyone who listens &#8211; but rarely blog about our excitement and findings.</p>
<p>That said, there is a coupling of features of AIR while leveraging the Flex Framework that i cannot hold inside and think is worth mentioning: Associated filetypes, the invoke event, and BindingUtils. </p>
<p><em>To view and download the full code, <a href="http://custardbelly.com/downloads/air/FileTypeFun" target="blank">click here</a>.<br />
</em><br />
<strong>File Types</strong><br />
First off, you can associate filetypes to your AIR app in the application descriptor file within the <code>fileTypes</code> node:</p>

<div class="wp_syntax"><div class="code"><pre class="mxml" style="font-family:monospace;"><span style="color: #000000;">&lt;filetypes<span style="color: #7400FF;">&gt;</span></span>
    <span style="color: #000000;">&lt;filetype<span style="color: #7400FF;">&gt;</span></span>
      <span style="color: #000000;">&lt;name<span style="color: #7400FF;">&gt;</span></span>com.example<span style="color: #000000;">&lt;/name<span style="color: #7400FF;">&gt;</span></span>
      <span style="color: #000000;">&lt;extension<span style="color: #7400FF;">&gt;</span></span>ftf<span style="color: #000000;">&lt;/extension<span style="color: #7400FF;">&gt;</span></span>
      <span style="color: #000000;">&lt;description<span style="color: #7400FF;">&gt;</span></span>FileTypeFun file<span style="color: #000000;">&lt;/description<span style="color: #7400FF;">&gt;</span></span>
      <span style="color: #000000;">&lt;contenttype<span style="color: #7400FF;">&gt;</span></span>text/plain<span style="color: #000000;">&lt;/contenttype<span style="color: #7400FF;">&gt;</span></span>
    <span style="color: #000000;">&lt;/filetype<span style="color: #7400FF;">&gt;</span></span>
<span style="color: #000000;">&lt;/filetypes<span style="color: #7400FF;">&gt;</span></span></pre></div></div>

<p>Once the AIR app is installed on your machine, a file with the extension set as the value of the <code>extension</code> node will be associated with your app. Meaning, it will show up first in the list when you choose &#8216;open with&#8217; and even invoke the app if you double-click on the file &#8211; that is if the extension is not associated with another program on your machine (ie. doc) in which case you will have to set your app to always open associated as default to your app.</p>
<p><strong>InvokeEvent</strong><br />
The invoke event of a <code>WindowedApplication</code> will be triggered upon initial instantiation &#8211; without having the application previously running &#8211; and any subsequent &#8216;open with file&#8217; calls. The arguments property of the <code>InvokeEvent</code> is an array of arguments passed through invocation of the app. This not only allows command line junkies to open an application with a file like so:</p>
<p><em>On Mac:</em><br />
>open MyAirApp.app MyDocuments.ftf<br />
<em><br />
On Windows:</em><br />
>MyAirApp MyDocument.ftf</p>
<p>.. but as well as double-clicking or choosing &#8216;open with&#8217; on a file (as describe above). Probably you wouldn&#8217;t have any documents lying around in your applications directory &#8211; but you get the picture. To handle those arguments your app would look something like as follows:</p>

<div class="wp_syntax"><div class="code"><pre class="mxml" style="font-family:monospace;"><span style="color: #000000;">&lt; ?xml version=<span style="color: #ff0000;">&quot;1.0&quot;</span> encoding=<span style="color: #ff0000;">&quot;utf-8&quot;</span>?<span style="color: #7400FF;">&gt;</span></span>
<span style="color: #000000;">&lt;mx :WindowedApplication </span>
<span style="color: #000000;">    xmlns:mx=<span style="color: #ff0000;">&quot;http://www.adobe.com/2006/mxml&quot;</span></span>
<span style="color: #000000;">    layout=<span style="color: #ff0000;">&quot;vertical&quot;</span> </span>
<span style="color: #000000;">    horizontalAlign=<span style="color: #ff0000;">&quot;center&quot;</span> verticalAlign=<span style="color: #ff0000;">&quot;middle&quot;</span></span>
<span style="color: #000000;">    invoke=<span style="color: #ff0000;">&quot;onAppInvoke(event);&quot;</span><span style="color: #7400FF;">&gt;</span></span>
&nbsp;
    <span style="color: #000000;">&lt;/mx<span style="color: #7400FF;">&gt;</span>&lt;mx :Script<span style="color: #7400FF;">&gt;</span></span>
        <span style="color: #000000;">&lt; !<span style="color: #66cc66;">&#91;</span>CDATA<span style="color: #66cc66;">&#91;</span></span>
<span style="color: #000000;">            private function onAppInvoke<span style="color: #66cc66;">&#40;</span> evt:InvokeEvent <span style="color: #66cc66;">&#41;</span>:void</span>
<span style="color: #000000;">            <span style="color: #66cc66;">&#123;</span></span>
<span style="color: #000000;">                var items:Array = evt.arguments;</span>
<span style="color: #000000;">                for<span style="color: #66cc66;">&#40;</span> var i:int = <span style="color: #cc66cc;">0</span>; i &lt; items.length; i++ <span style="color: #66cc66;">&#41;</span></span>
<span style="color: #000000;">                <span style="color: #66cc66;">&#123;</span></span>
<span style="color: #000000;">                    trace<span style="color: #66cc66;">&#40;</span> items<span style="color: #66cc66;">&#91;</span>i<span style="color: #66cc66;">&#93;</span> <span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">                <span style="color: #66cc66;">&#125;</span></span>
<span style="color: #000000;">            <span style="color: #66cc66;">&#125;</span></span>
<span style="color: #000000;">        <span style="color: #66cc66;">&#93;</span><span style="color: #66cc66;">&#93;</span><span style="color: #7400FF;">&gt;</span></span>
    <span style="color: #000000;">&lt;mx :Label text=<span style="color: #ff0000;">&quot;Welcome&quot;</span> <span style="color: #7400FF;">/&gt;</span></span>
<span style="color: #000000;">&lt;/mx<span style="color: #7400FF;">&gt;</span></span></pre></div></div>

<p><em>Note:<br />
AARG&#8230; i can&#8217;t find a decent mxml plugin for Wordpress. There is an errant closing</em> mx <em>tag before the script and the closing tag at the end should read</em> /mx:WindowedApplication . <em>If anyone has any tips on a good plugin, please leave a comment!</em></p>
<p>This assigns the <code>onAppInvoke()</code> method as the handler to the &#8216;invoke&#8217; event dispatched from <code>WindowedApplication</code> upon instantiation AND any subsequent invocation calls. The arguments attribute of the <code>InvokeEvent</code> is a list of strings &#8211; deliminated by space if you on the command line. From here, just handle them as you want to. In following with this example we are going to handle paths to simple text files.</p>
<p><strong>BindingUtils</strong><br />
All this filetypes and invoke events craziness is enough to warrent me to stop writing&#8230; but i got to thinking (always bad news)&#8230; what if i&#8217;ve got an &#8216;invoke&#8217; event that may trigger prior to the creation of a client that needs to know about an opened file, or more so, the app needs to switch focus to a client that has yet to be instantiated that knows how to handle that file? This is where <code>BindingUtils </code>and <code>ChangeWatcher </code>come into play and really show off the power of the Flex Framework.</p>

<div class="wp_syntax"><div class="code"><pre class="mxml" style="font-family:monospace;"><span style="color: #000000;">&lt; ?xml version=<span style="color: #ff0000;">&quot;1.0&quot;</span> encoding=<span style="color: #ff0000;">&quot;utf-8&quot;</span>?<span style="color: #7400FF;">&gt;</span></span>
<span style="color: #000000;">&lt;mx :WindowedApplication </span>
<span style="color: #000000;">    xmlns:mx=<span style="color: #ff0000;">&quot;http://www.adobe.com/2006/mxml&quot;</span></span>
<span style="color: #000000;">    layout=<span style="color: #ff0000;">&quot;vertical&quot;</span> </span>
<span style="color: #000000;">    horizontalAlign=<span style="color: #ff0000;">&quot;center&quot;</span> verticalAlign=<span style="color: #ff0000;">&quot;middle&quot;</span></span>
<span style="color: #000000;">    applicationComplete=<span style="color: #ff0000;">&quot;onAppComplete();&quot;</span></span>
<span style="color: #000000;">    invoke=<span style="color: #ff0000;">&quot;onAppInvoke(event);&quot;</span><span style="color: #7400FF;">&gt;</span></span>
    <span style="color: #000000;">&lt;/mx<span style="color: #7400FF;">&gt;</span>&lt;mx :Script<span style="color: #7400FF;">&gt;</span></span>
        <span style="color: #000000;">&lt; !<span style="color: #66cc66;">&#91;</span>CDATA<span style="color: #66cc66;">&#91;</span></span>
<span style="color: #000000;">            import mx.binding.utils.ChangeWatcher;</span>
<span style="color: #000000;">            import mx.binding.utils.BindingUtils;</span>
<span style="color: #000000;">            import mx.events.FlexEvent;</span>
&nbsp;
<span style="color: #000000;">            private var _invokedFile:File;</span>
<span style="color: #000000;">            private var _fileWindow:FileDisplayWindow;</span>
<span style="color: #000000;">            private var _filesBinding:ChangeWatcher;</span>
&nbsp;
<span style="color: #000000;">            private function onAppComplete<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>:void</span>
<span style="color: #000000;">            <span style="color: #66cc66;">&#123;</span></span>
<span style="color: #000000;">                _filesBinding = BindingUtils.bindSetter<span style="color: #66cc66;">&#40;</span> invalidateFiles, this, <span style="color: #ff0000;">'invokedFile'</span>, true <span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">            <span style="color: #66cc66;">&#125;</span></span>
&nbsp;
<span style="color: #000000;">            private function onAppInvoke<span style="color: #66cc66;">&#40;</span> evt:InvokeEvent <span style="color: #66cc66;">&#41;</span>:void</span>
<span style="color: #000000;">            <span style="color: #66cc66;">&#123;</span></span>
<span style="color: #000000;">                var items:Array = evt.arguments;</span>
<span style="color: #000000;">                if<span style="color: #66cc66;">&#40;</span> items.length <span style="color: #7400FF;">&gt;</span></span> 0 )
                {
                    invokedFile = new File( evt.arguments[0] );
                }    
            }
&nbsp;
            private function openFileWindow():void
            {
                _fileWindow = new FileDisplayWindow();
                _fileWindow.addEventListener( FlexEvent.CREATION_COMPLETE, applyFileToWindow );
                _fileWindow.open();
            }
&nbsp;
            private function applyFileToWindow( evt:FlexEvent = null ):void
            {
                _fileWindow.file = _invokedFile;
            }
&nbsp;
            private function invalidateFiles( arg:* = null ):void
            {
                if( _invokedFile == null ) return;
                if( _fileWindow == null || _fileWindow.closed ) openFileWindow();
                else applyFileToWindow();
            }
&nbsp;
            [Bindable]
            public function get invokedFile():File
            {
                return _invokedFile;
            }
            public function set invokedFile( arr:File ):void
            {
                _invokedFile = arr;
            }
&nbsp;
        ]]&gt;
    <span style="color: #000000;">&lt;mx :Label text=<span style="color: #ff0000;">&quot;Welcome&quot;</span> <span style="color: #7400FF;">/&gt;</span></span>
<span style="color: #000000;">&lt;/mx<span style="color: #7400FF;">&gt;</span></span></pre></div></div>

<p><em>Note:<br />
Again i apologize for the terrible representation of mxml code. To view the full code,</em> <a href="http://custardbelly.com/downloads/air/FileTypeFun" target="blank">click here</a></p>
<p>On dispatch of &#8216;applicationComplete&#8217;, a <code>ChangeWatcher </code>instance is created to bind any changes to the <code>invokeFile </code>attribute to the <code>invalidateFiles()</code> method. The <code>invalidateFiles()</code> method will be called upon a change to the <code>invokedFile </code>which is of type <code>File </code>from the AIR API. The client that handles any invoked files in this case is another addition to the AIR API &#8211; Window. I threw it in there because i can&#8217;t stop wanting to use it <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<p>The <code>invalidateFiles()</code> has checks to see if the file is valid as well as to make sure the <code>Window </code>is open and ready to receive data. Basically, with binding a change to the <code>invokedFile </code>attribute to the i<code>nvalidateFiles()</code> handler, we can be sure that when a file is requested to be open &#8211; either through invocation from the command, double-click, or &#8216;open with&#8217; &#8211; the <code>Window </code>client that knows how to handle that file data will be presented.</p>
<p>This just scratches the surface. There are icons you can associate with file types, there&#8217;s drag and drop capabilities that can update the invoked file if wanted&#8230; i just have to stop typing at some point!</p>
<p><a href="http://custardbelly.com/downloads/air/FileTypeFun" target="blank">View the full source code here.</a> I didn&#8217;t offer up the air app to download because it&#8217;s a rather boring app, but it is included in the source if you want to install it and test out the invocation.</p>
<p>If you made it this far and haven&#8217;t checked out <a href="http://labs.adobe.com/technologies/air/" target="_blank">AIR</a>, go <a href="http://labs.adobe.com/" target="_blank">download the bits</a>. And maybe consider buying <a href="http://www.amazon.com/Adobe-AIR-Create-Modify-Reuse/dp/0470182075/ref=pd_bbs_sr_6/002-5985048-8156021?ie=UTF8&#038;s=books&#038;qid=1191552882&#038;sr=8-6">a book</a> or <a href="http://amazon.com/s/ref=nb_ss_gw/102-6567738-0807350?initialSearch=1&#038;url=search-alias%3Daps&#038;field-keywords=Adobe+AIR&#038;Go.x=0&#038;Go.y=0&#038;Go=Go"> two</a>&#8230; <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/air/" title="View all posts in AIR" rel="category tag">AIR</a>,  <a href="http://custardbelly.com/blog/category/apollo/" title="View all posts in Apollo" rel="category tag">Apollo</a>,  <a href="http://custardbelly.com/blog/category/books/" title="View all posts in Books" rel="category tag">Books</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2007/10/05/air-invokeevent-and-filetypes/#comments" rev="post-62"  title="Comment on AIR InvokeEvent and FileTypes">8 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2007-10-05T09:24">October 5, 2007</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-62-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-61" class="post-61 post hentry category-apollo category-flash category-flex full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2007/08/03/wrox-air-instant-results-book/" title="Permanent link to Wrox AIR Instant Results book" rel="bookmark" rev="post-61">Wrox AIR Instant Results book</a></h1>
	
	<div class="entry-content full-content">
		<p><a href="http://www.amazon.com/AIR-Instant-Results-Marc-Luchner/dp/0470182075/ref=sr_1_1/105-9609728-7107659?ie=UTF8&#038;s=books&#038;qid=1186022411&#038;sr=8-1" target="_blank">The cat&#8217;s outta the bag</a>&#8230; and threw up on the middle of the cover. If for some insane reason you have been wondering about the lack of posts, i have been saving my mastery of the english language to co-author a book on <a href="http://labs.adobe.com/wiki/index.php/AIR" target="_blank">AIR</a>. </p>
<p>I&#8217;ve been fortunate enough to work alongside <a href="http://blog.nobien.net/" target="_blank">Marc and Matt</a> to produce a &#8216;by example&#8217; book on <a href="http://labs.adobe.com/wiki/index.php/AIR" target="_blank">AIR</a> that we hope people will enjoy reading as much as we have writing it. <a href="http://blog.nobien.net/2007/07/31/wrox-air-instant-results/" target="_blank">Matt took the words out of my mouth</a>, but with any new technology there is always the jazz of it&#8217;s potential and then the questioning of its practicality. I can say for certain, after having worked with it for the past several months, that <a href="http://labs.adobe.com/wiki/index.php/AIR" target="_blank">AIR</a> is the next generation in desktop software development.</p>
<p>The <a href="http://www.wrox.com/WileyCDA/" target="_blank">Wrox <em>Instant Results</em></a>  series walks you through building applications while learning the platform API, and this is no different. We have assembled a dozen examples that you can walk away from and use as well as expand upon. As the book progesses, you build on your knowledge from previous chapters and learn new aspects of the API. With a general knowledge of Flex and basic understanding of OOP, anyone can jump into this book and take off running with their own ideas.</p>
<p>Also available from Wiley Wrox is <a href="http://www.amazon.com/Professional-AIR-Application-Development-Integrated/dp/0470170212/ref=sr_1_6/105-9609728-7107659?ie=UTF8&#038;s=books&#038;qid=1186025851&#038;sr=1-6" target="_blank"><em>Professional AIR</em></a> by the esteemed <a href="http://www.chuckstar.com/blog/index.php/technology/announcing-wrox-professional-apollo-book/" target="_blank">Chuck Freedman</a>, mister <a href="http://bit-101.com/blog">Keith Peters</a>, Clint Modien, Ben Lucyk, and Ryan Manning.<br />
<a href="http://www.amazon.com/AIR-Instant-Results-Marc-Luchner/dp/0470182075/ref=sr_1_1/105-9609728-7107659?ie=UTF8&#038;s=books&#038;qid=1186022411&#038;sr=8-1"><br />
Wrox AIR Instant Results</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/apollo/" title="View all posts in Apollo" rel="category tag">Apollo</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2007-08-03T09:57">August 3, 2007</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-61-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-60" class="post-60 post hentry category-as3 category-apollo category-flex full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2007/04/06/customizing-the-apollo-nativewindow/" title="Permanent link to Customizing the Apollo NativeWindow" rel="bookmark" rev="post-60">Customizing the Apollo NativeWindow</a></h1>
	
	<div class="entry-content full-content">
		<p><a href="http://www.danieldura.com/" target="_blank">Daniel Dura</a> wrote up a <a href="http://www.danieldura.com/archive/apollo-multi-window-support-using-flex"  target="_blank">great post</a> on adding Flex components to NativeWindows. If you are looking to add Flex components to your NativeWindow instance, you will need to follow what Daniel described.  As Daniel has mentioned, this is an issue concerning the <a href="http://www.adobe.com/go/apollo"  target="_blank">alpha version of Apollo</a> and may be cleared up in the next release, but if you can&#8217;t wait and are looking to add custom ActionScript components that extend Flex components, there is another option. </p>
<p>I don&#8217;t pretend to know enough about the architecture (so someone speak up if i am off track), but adding components to NativeWindows &#8211; without Daniel&#8217;s or the proceeding example- fails due to the reference to your main ApolloApplication&#8217;s stage when displaying components within the Flex framework. You can add all the displays existent in the AS3 library (Sprite, TextField, etc.) to the stage of your NativeWindow instance, but any in the Flex framework need a little push. Adding MXML components to your NativeWindows will still have to follow the formula Daniel laid out using the addChild/removeChild methods, yet there is a workaround to this for ActionScript components by adding an ADDED_TO_STAGE event listener within its constructor.</p>
<p>I have a tendency to try and word things right and it comes out all mush, so i&#8217;ll just show some code. <em>You can alternatively look at<a href="http://custardbelly.com/downloads/apollo/NativeWindowExample" target="_blank"> source view</a></em>. </p>
<p>The CustomLabel (CustomLabel.as) component that will be added to our NativeWindow:</p>

<div class="wp_syntax"><div class="code"><pre class="actionscript" style="font-family:monospace;">        <span style="color: #0066CC;">import</span> flash.<span style="color: #006600;">events</span>.<span style="color: #006600;">Event</span>;
	<span style="color: #0066CC;">import</span> flash.<span style="color: #0066CC;">text</span>.<span style="color: #0066CC;">TextField</span>;
&nbsp;
	<span style="color: #0066CC;">import</span> mx.<span style="color: #006600;">containers</span>.<span style="color: #006600;">Canvas</span>;
&nbsp;
	<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">class</span> CustomLabel <span style="color: #0066CC;">extends</span> Canvas
	<span style="color: #66cc66;">&#123;</span>
		<span style="color: #0066CC;">private</span> <span style="color: #000000; font-weight: bold;">var</span> _label:<span style="color: #0066CC;">TextField</span>;
&nbsp;
		<span style="color: #0066CC;">public</span> <span style="color: #000000; font-weight: bold;">function</span> CustomLabel<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>
		<span style="color: #66cc66;">&#123;</span>
			<span style="color: #0066CC;">super</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
			addEventListener<span style="color: #66cc66;">&#40;</span> Event.<span style="color: #006600;">ADDED_TO_STAGE</span>, init <span style="color: #66cc66;">&#41;</span>;
		<span style="color: #66cc66;">&#125;</span>
&nbsp;
		<span style="color: #0066CC;">private</span> <span style="color: #000000; font-weight: bold;">function</span> init<span style="color: #66cc66;">&#40;</span> evt:Event <span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
		<span style="color: #66cc66;">&#123;</span>
			createChildren<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
		<span style="color: #66cc66;">&#125;</span>
&nbsp;
		override protected <span style="color: #000000; font-weight: bold;">function</span> createChildren<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
		<span style="color: #66cc66;">&#123;</span>
			<span style="color: #0066CC;">super</span>.<span style="color: #006600;">createChildren</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
&nbsp;
			_label = createField<span style="color: #66cc66;">&#40;</span> <span style="color: #ff0000;">&quot;HelloWorld&quot;</span> <span style="color: #66cc66;">&#41;</span>;
			<span style="color: #0066CC;">stage</span>.<span style="color: #006600;">addChild</span><span style="color: #66cc66;">&#40;</span> _label <span style="color: #66cc66;">&#41;</span>;
		<span style="color: #66cc66;">&#125;</span>
&nbsp;
		override protected <span style="color: #000000; font-weight: bold;">function</span> updateDisplayList<span style="color: #66cc66;">&#40;</span> unscaledWidth:<span style="color: #0066CC;">Number</span>, unscaledHeight:<span style="color: #0066CC;">Number</span> <span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">void</span>
		<span style="color: #66cc66;">&#123;</span>
			<span style="color: #0066CC;">super</span>.<span style="color: #006600;">updateDisplayList</span><span style="color: #66cc66;">&#40;</span> unscaledWidth, unscaledHeight <span style="color: #66cc66;">&#41;</span>;
		<span style="color: #66cc66;">&#125;</span>
&nbsp;
		<span style="color: #0066CC;">private</span> <span style="color: #000000; font-weight: bold;">function</span> createField<span style="color: #66cc66;">&#40;</span> txt:<span style="color: #0066CC;">String</span> = <span style="color: #ff0000;">&quot;&quot;</span> <span style="color: #66cc66;">&#41;</span>:<span style="color: #0066CC;">TextField</span>
		<span style="color: #66cc66;">&#123;</span>
			<span style="color: #000000; font-weight: bold;">var</span> label:<span style="color: #0066CC;">TextField</span> = <span style="color: #000000; font-weight: bold;">new</span> <span style="color: #0066CC;">TextField</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
			label.<span style="color: #0066CC;">text</span> = txt;
			<span style="color: #b1b100;">return</span> label;	
		<span style="color: #66cc66;">&#125;</span>
	<span style="color: #66cc66;">&#125;</span></pre></div></div>

<p>&#8230; And the main mxml  (NativeWindowExample.mxml):</p>

<div class="wp_syntax"><div class="code"><pre class="mxml" style="font-family:monospace;"><span style="color: #000000;">&lt;mx :ApolloApplication </span>
<span style="color: #000000;">	xmlns:mx=<span style="color: #ff0000;">&quot;http://www.adobe.com/2006/mxml&quot;</span></span>
<span style="color: #000000;">	width=<span style="color: #ff0000;">&quot;200&quot;</span></span>
<span style="color: #000000;">	height=<span style="color: #ff0000;">&quot;100&quot;</span> </span>
<span style="color: #000000;">	layout=<span style="color: #ff0000;">&quot;absolute&quot;</span></span>
<span style="color: #000000;">	applicationComplete=<span style="color: #ff0000;">&quot;onAppInit();&quot;</span><span style="color: #7400FF;">&gt;</span></span>
&nbsp;
	<span style="color: #000000;">&lt;/mx<span style="color: #7400FF;">&gt;</span>&lt;mx :Script<span style="color: #7400FF;">&gt;</span></span>
		<span style="color: #000000;">&lt; !<span style="color: #66cc66;">&#91;</span>CDATA<span style="color: #66cc66;">&#91;</span></span>
&nbsp;
<span style="color: #000000;">			private var _launchWindow:NativeWindow;</span>
<span style="color: #000000;">			private var _customWindow:NativeWindow;</span>
&nbsp;
<span style="color: #000000;">			private function onAppInit<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>:void</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#123;</span></span>
<span style="color: #000000;">				_launchWindow = this.stage.window;</span>
<span style="color: #000000;">				_launchWindow.addEventListener<span style="color: #66cc66;">&#40;</span> Event.CLOSE, onAppClose <span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#125;</span></span>
&nbsp;
<span style="color: #000000;">			private function openCustomWindow<span style="color: #66cc66;">&#40;</span> evt:MouseEvent <span style="color: #66cc66;">&#41;</span>:void</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#123;</span></span>
<span style="color: #000000;">				if<span style="color: #66cc66;">&#40;</span> _customWindow != null <span style="color: #66cc66;">&#41;</span> return;</span>
&nbsp;
<span style="color: #000000;">				var options:NativeWindowInitOptions = new NativeWindowInitOptions<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">				_customWindow = new NativeWindow<span style="color: #66cc66;">&#40;</span> true, options <span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">				_customWindow.stage.align = StageAlign.TOP_LEFT;</span>
<span style="color: #000000;">				_customWindow.stage.scaleMode = StageScaleMode.NO_SCALE;</span>
<span style="color: #000000;">				_customWindow.title = <span style="color: #ff0000;">&quot;CustomWindow&quot;</span>;</span>
<span style="color: #000000;">				_customWindow.stage.addChild<span style="color: #66cc66;">&#40;</span> new CustomLabel<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">				_customWindow.addEventListener<span style="color: #66cc66;">&#40;</span> Event.CLOSE, onWindowClose <span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#125;</span></span>
&nbsp;
<span style="color: #000000;">			private function onWindowClose<span style="color: #66cc66;">&#40;</span> evt:Event <span style="color: #66cc66;">&#41;</span>:void</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#123;</span></span>
<span style="color: #000000;">				_customWindow = null;</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#125;</span></span>
&nbsp;
<span style="color: #000000;">			private function onAppClose<span style="color: #66cc66;">&#40;</span> evt:Event <span style="color: #66cc66;">&#41;</span>:void</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#123;</span></span>
<span style="color: #000000;">				if<span style="color: #66cc66;">&#40;</span> _customWindow != null <span style="color: #66cc66;">&#41;</span> _customWindow.close<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;</span>
<span style="color: #000000;">			<span style="color: #66cc66;">&#125;</span></span>
&nbsp;
<span style="color: #000000;">		<span style="color: #66cc66;">&#93;</span><span style="color: #66cc66;">&#93;</span><span style="color: #7400FF;">&gt;</span></span>
	<span style="color: #000000;">&lt;/mx<span style="color: #7400FF;">&gt;</span></span>
&nbsp;
	<span style="color: #000000;">&lt;mx :Button id=<span style="color: #ff0000;">&quot;windowBtn&quot;</span> </span>
<span style="color: #000000;">		top=<span style="color: #ff0000;">&quot;10&quot;</span> left=<span style="color: #ff0000;">&quot;10&quot;</span> right=<span style="color: #ff0000;">&quot;10&quot;</span> bottom=<span style="color: #ff0000;">&quot;10&quot;</span></span>
<span style="color: #000000;">		label=<span style="color: #ff0000;">&quot;open custom window&quot;</span></span>
<span style="color: #000000;">		click=<span style="color: #ff0000;">&quot;openCustomWindow( event );&quot;</span><span style="color: #7400FF;">&gt;</span></span>
	<span style="color: #000000;">&lt;/mx<span style="color: #7400FF;">&gt;</span></span></pre></div></div>

<p><strong>NOTE:</strong> <em>the preceding code has some major problems due to mx tags in wordpress, so disregard all affending close tags <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </em></p>
<p> &#8212; As well, you could extend NativeWindow and add the AS components to its stage to bypass adding them in the main app. &#8211;</p>
<p>In the main app file we are just creating a new NativeWindow instance and adding the custom AS component, CustomLabel, to it&#8217;s display.</p>

<div class="wp_syntax"><div class="code"><pre class="actionscript" style="font-family:monospace;">_customWindow.<span style="color: #0066CC;">stage</span>.<span style="color: #006600;">addChild</span><span style="color: #66cc66;">&#40;</span> <span style="color: #000000; font-weight: bold;">new</span> CustomLabel<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#41;</span>;</pre></div></div>

<p>What is happening in the constructor of the CustomLabel is of importance in this example, as it listens for its event of being added to a clients stage. From there we can call the override of UIComponent:createChildren, and add whatever we want to the display. When creating AS components NOT to be added to the NativeWindow, that method (createChildren) would be called as long as you call the super constructor. That is not the case when adding components extending the Flex framework in NativeWindow. Again, if i am missing something crucial or if you have more insight, please leave a comment. So that&#8217;s it. Once it has been added to the stage, we can go about our business. Of course, when using ActionScript components you lose the inherent layout capabilities within MXML components, but that is why we&#8217;ve added the override of #updateDisplayList.<br />
Until Flex came around, i know i spent more than my fair share nailing down layouts for applications- so this is like going back home&#8230; <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
<p>To find out more about extending ActionScript components, visit<a href="http://blog.flashgen.com/2006/11/08/base-component-methods-actionscript-20-to-30/"  target="_blank"> this post</a> on FlashGen and <a href="http://download.macromedia.com/pub/documentation/en/flex/2/flex2_createextendcomponents.pdf"  target="_blank">this doc</a> from <a href="http://labs.adobe.com/">the labs</a>.</p>
<p>PS. I&#8217;ve been a little lacking in the post area, and though i have the usual excuses- family, work, beer&#8230; &#8211; i could be more on top of it and you should be seeing more Flex and Apollo thoughts in the near future, but no promises because i love those excuses. I also am working on something that i hope to announce here a little later if all goes well&#8230;</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/apollo/" title="View all posts in Apollo" rel="category tag">Apollo</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2007/04/06/customizing-the-apollo-nativewindow/#comments" rev="post-60"  title="Comment on Customizing the Apollo NativeWindow">3 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2007-04-06T07:50">April 6, 2007</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-60-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-59" class="post-59 post hentry category-beer category-general full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2007/01/15/beer-list-amsterdam-new-years/" title="Permanent link to Beer list &#8211; Amsterdam new years." rel="bookmark" rev="post-59">Beer list &#8211; Amsterdam new years.</a></h1>
	
	<div class="entry-content full-content">
		<p>I was sending around an email of the wife and i&#8217;s comprised beer tasting list while we were in <a href="http://www.flickr.com/photos/91582541@N00/sets/72157594462173687/">Amsterdam</a>, and thought i&#8217;d post it here, as well- for people who love beer or think we&#8217;ve made a mistake on our ruling.</p>
<p>Here it goes:</p>
<p><strong>Strongbow</strong> :: 0 stars &#8211; 1st beer tasted off the plane! Stay away&#8230; stay far away! no stars. didn&#8217;t deter our spirits.</p>
<p><strong>Hertog Jan</strong>. <em>Prestige</em>. :: 4 stars! 2nd beer&#8230; and tasted at a later date to confirm. Oh. like sitting on a rainbow. Excellent. Dark, welcoming.</p>
<p><strong>LaChouffe</strong> :: 3 1/2 stars. Wonderful blonde beer that screams welcome to Amsterdam. On tap, also, at our local Boston pub. Visit, damn you.</p>
<p><strong>Witbier</strong> :: 2 stars. Translates into White beer. I&#8217;ve never been fond. Carrie ordered it&#8230; sucker!</p>
<p><strong>Westmalle Dubbel</strong> :: 3 stars. No comments left in our book. Either it was late or just tasted damn good.</p>
<p><strong>Palm Dubbel</strong> :: 2 1/2 stars. This is on tap in a lot of bars in Amsterdam. Had to try it. It&#8217;s good, darn good. But there were too many better choices.</p>
<p><strong>BockRos</strong>   :: 3 stars. Served from the brewery of &#8216;De Bekeerde Suster&#8217;, of which the resteraunt we ate at 2 times. Excellent homebrew. Dark and slightly red.</p>
<p><strong>Dommelsch</strong> :: 2 stars. Can be found in most bars in Amsterdam. Okay. Your basic Pilsner.</p>
<p><strong>Affligem Dubbel</strong> :: 3 1/2 . Oh, Affligem. Like a welcoming hug, i say, hello, friend&#8230; a game of hopscotch? Excellent.</p>
<p><strong>LaChouffe N&#8217;Ice </strong>:: 4 stars! If you see this on tap, do not look farther down the line&#8230; say yes, then &#8216;gimme&#8217;. Then sigh. Ah. LaChouffe, did God make you?</p>
<p><strong>Gulpener </strong>:: 2 1/2 stars. Seen at most bars, like Dommelsch and Palm. It&#8217;s a pilsner. If you only have those three choices&#8230; Gulpener it is!</p>
<p><strong>Zatte</strong> :: 2 stars. This was a toss up. Personally we didn&#8217;t like it. Citrusy, but not sweet. We could see how if someone likes citrus beer, this would be key. Stars variable.</p>
<p><strong>Heinekken</strong> :: 2 stars! Normally this would get 1 star state-side, but it seriously tastes better over there. Not as skunky. Go figure&#8230; still if anything else is on tap, get it.</p>
<p><strong>Grolsch</strong> :: 2 stars. Tastes like state-side grolsch. Good. If nothing, or heinekken is left in the cooler, grab this.</p>
<p><strong>Affligem Blonde</strong> :: 3 strars. See above affligem.. instead of hopscotch &#8211; jumprope.</p>
<p><strong>BlondeRos</strong> :: 2 1/2 stars. Another selection from &#8216;De Bekeerde Suster&#8217; ( see BockRos ), but we like darker beers. It&#8217;s good, but if Ros is on tap&#8230;</p>
<p><strong>Venloosch Alt</strong> :: 1 star. This is weird. It may have tasted good if it didn&#8217;t taste flat. Maybe it wasn&#8217;t flat&#8230; we just don&#8217;t know.</p>
<p><strong>Lindebloom</strong> :: 1 star. I took a HUGE dump in this bar, cause i couldn&#8217;t wait to get to our favorite bar. And the bathroom was seriously the size of a freaking phone booth. Couldn&#8217;t even sit on the pot. But lord it was a relief. Anyway, i ordered this. Wasn&#8217;t good. Like the logo though.</p>
<p><strong>Amstel Bock </strong>:: 2 stars. Our last night cap. Was freaking amazing to have, but didn&#8217;t taste as good as many others. Definitely better than amstel though!</p>
<p>Time between the Venloosch/Lindebloom incedent and Amstel Bock was @ two days, so we didn&#8217;t end on a bad note. We certainly headed back to where we knew LaChouffe, Affligem and Hertog Jan were flowing&#8230; Can&#8217;t wait to go back.</p>
<p>If you get a chance, please see what you can do to get to Amsterdam.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/beer/" title="View all posts in Beer!" rel="category tag">Beer!</a>,  <a href="http://custardbelly.com/blog/category/general/" title="View all posts in General" rel="category tag">General</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2007/01/15/beer-list-amsterdam-new-years/#comments" rev="post-59"  title="Comment on Beer list &#8211; Amsterdam new years.">7 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2007-01-15T20:54">January 15, 2007</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-59-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-58" class="post-58 post hentry category-flash category-general full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2007/01/12/2007/" title="Permanent link to 2007" rel="bookmark" rev="post-58">2007</a></h1>
	
	<div class="entry-content full-content">
		<p>First off&#8230; <a href="http://www.flickr.com/photos/91582541@N00/sets/72157594462173687/" target="_blank">best new years ever &#8211; Amsterdam</a>. Beautiful city. Would move there in a New York minute&#8230;</p>
<p>What will come of this new year? I&#8217;ve been insanely busy with work and my wonderful family. I&#8217;ve also been mulling over what i want to look back on come this time 2008. I&#8217;ve been wanting to sink my teeth into something for a little while now, and am proud of my personal and professional work of 2006, but i&#8217;m stumbling around wanting something that will click. Truthfully i should just shut my mind off, spin some records and code.</p>
<p>I got heavily into <a href="http://osflash.org/red5">Red5</a> prior to the new year and was having a blast. It actually led into working more with Java and Flex &#8211; which makes Red5 a <a href="http://www.flickr.com/photos/91582541@N00/347295583/in/set-72157594462173687/" target="_blank">gateway drug</a> &#8211; but I don&#8217;t want to show anything because i&#8217;m too much of a perfectionist and i don&#8217;t think it&#8217;s quite right&#8230; bah. Got a <a href="http://www.makezine.com/controller/" target="_blank">MAKE Controller</a> for the holidays, and only just two days ago set it up&#8230; hopefully more will come of that &#8211; big ups to <a href="http://www.thefactoryfactory.com/wordpress/" target="_blank">Josh Noble</a> who&#8217;s gonna hear my incessant questions.</p>
<p>I dunno. I&#8217;m just searching for something&#8230; and part of it probably has to do with experiencing a new culture and the passing of someone i held dear to my heart and thought the world of. </p>
<p>Now i&#8217;m gonna shut up and spin some records.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/general/" title="View all posts in General" rel="category tag">General</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2007-01-12T22:23">January 12, 2007</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-58-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-57" class="post-57 post hentry category-red5 category-webhost full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2006/12/10/new-host-new-toys/" title="Permanent link to New host, new toys." rel="bookmark" rev="post-57">New host, new toys.</a></h1>
	
	<div class="entry-content full-content">
		<p>I recently switched from my current host, to a dedicated server and i couldn&#8217;t be happier.</p>
<p>I was fairly happy with my current shared-hosting plan ( though reading <a href="http://aralbalkan.com/753" target="_blank">Aral&#8217;s problems</a> started to make we think twice ), but i have increasingly wanted more out of an online server that my current host just couldn&#8217;t provide. So i purchased a virtual private server from Westhost. So far, i have had no complaints, they are attentive to any pointless questions i may have, and the forums are an endless supply of knowledge. I have yet to move all my content from my current host over, so that&#8217;s a task i don&#8217;t look forward to&#8230;</p>
<p>Now i&#8217;m getting comfortable with linux commands and installing crap here and there, and starting up this and that, and having a ball, and drinking way too much fountain soda &#8211; but big ups to <a href="http://razorberry.com/blog" target="_blank">Ash</a> for holding back the temptation to <a href="http://www.morechickenandtuna.net/albums/2cats/smack.jpg" target="_blank">smack me</a> due to my incessant questions.</p>
<p>I have to say, the main ingredient that caused this push to a vps is <a href="http://osflash.org/red5" target="_blank">Red5</a> ( if you are unfamiliar with red5, there are more links at the bottom of this post ). I have been checking-out the <a href="http://svn1.cvsdude.com/osflash/red5/java/server/trunk/" target="_blank">source</a> and not touching Red5 since release 0.4, so i was in good shape to know nothing about it when rc0.6 came out&#8230; enter <a href="http://blog.ff9900.org/" target="_blank">Chris Allen</a> into our <a href="http://schematic.com" target="_blank">Boston office</a> and he gives a great presentation onRed5, sparking my interest to really buckle down and play with it. If you or your company are at all interested in what <a href="http://osflash.org/red5" target="_blank">Red5</a> can provide for your business, i wouldn&#8217;t hesitate to get in touch with <a href="http://blog.ff9900.org/" target="_blank">Chris.</a></p>
<p>Things were touch and go a little with running Red5 on my new server ( again big-ups to <a href="http://razorberry.com/blog" target="_blank">Ash</a> ), but i eventually abandoned running apps on a built Red5 server and switched to deploying it under Tomcat. Oh boy! No problems yet and i am like a kid in a candy store. And with the current development on closing ghost connections, i&#8217;m ecstatic. Their <a href="http://dl.fancycode.com/red5/api/">API</a> is rock solid, can only get better, and i am finally thinking in Java on my own after reading numerous books and doing countless tutorials.</p>
<p>I&#8217;ve been playing with AS3, Java and Red5 lately and have something up and running, but i&#8217;m re-working the code and rebuffing the appearance&#8230; hope to have it up soon. I may throw up some directions and trials and tribulations of setting up the server, if anyone is interested. Until then &#8211; </p>
<p>[Red5 links]<br />
<a href="http://osflash.org/red5" target="_blank">Red5 project</a><br />
<a href="http://www.joachim-bauch.de/index.html/en" target="_blank">Joachim Bauch</a> and <a href="http://www.joachim-bauch.de/tutorials/red5/view" target="_blank">Red5 Tutorials</a><br />
<a href="http://www.newviewnetworks.com/nvnhome/blog/client/index.cfm" target="_blank">Dominick Accattato</a><br />
<a href="http://blog.ff9900.org/" target="_blank">Chris Allen&#8217;s blog</a><br />
<a href="http://rockonflash.com/blog/" target="_blank">John Grden&#8217;s blog</a><br />
<a href="http://www.flashextensions.com/tutorials.php" target="_blank">FlashExtension</a></p>
<p>- I&#8217;d also like to point out a blog to watch. <a href="http://www.thefactoryfactory.com/wordpress/" target="_blank">Josh Noble</a> is an expert in .Net and Flex/Flash technologies, a recent employee ( as am i ) to Schematic&#8217;s Boston office&#8230; and will be bombarded with questions from me.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/red5/" title="View all posts in Red5" rel="category tag">Red5</a>,  <a href="http://custardbelly.com/blog/category/webhost/" title="View all posts in Westhost" rel="category tag">Westhost</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2006/12/10/new-host-new-toys/#comments" rev="post-57"  title="Comment on New host, new toys.">2 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2006-12-10T00:47">December 10, 2006</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-57-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-56" class="post-56 post hentry category-general full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2006/09/08/new-job-come-monday/" title="Permanent link to New Job come Monday." rel="bookmark" rev="post-56">New Job come Monday.</a></h1>
	
	<div class="entry-content full-content">
		<p><a href="http://schematic.com/">Schematic</a> has opened a new office in Boston, and i am happy to announce that i have accepted a position there and looking forward to working alongside some extremely talented people.<br />
Just finishing up some documentation on the numerous projects and products i have worked on as an xplanaPloyee, and am anxious to get my hands dirty with a different and exciting company and get back to some personal projects i&#8217;ve put on hold ( cause of a <a href="http://custardbelly.com/blog/?p=54">wonderfully busy month</a> ).</p>
<p>Also celebrating a birthday Monday- so if anyone out there is going to the <a href="http://www.myspace.com/theofficialradiobirdman">Radio Birdman</a> show on Saturday, buy me a beer.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/general/" title="View all posts in General" rel="category tag">General</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2006/09/08/new-job-come-monday/#comments" rev="post-56"  title="Comment on New Job come Monday.">5 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2006-09-08T11:04">September 8, 2006</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-56-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-55" class="post-55 post hentry category-as3 category-flash full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2006/08/28/asdoc-and-keith-peters-flashdevelop-templates/" title="Permanent link to ASDoc and Keith Peters&#8217; FlashDevelop templates" rel="bookmark" rev="post-55">ASDoc and Keith Peters&#8217; FlashDevelop templates</a></h1>
	
	<div class="entry-content full-content">
		<p>&#8230; via <a href="http://blog.je2050.de/?p=80" target="_blank">Joa Eberts fairwell to AS3Doc</a> &#8230;</p>
<p><a href="http://www.adobe.com/" target="_blank">Adobe</a> had release their <a href="http://labs.adobe.com/wiki/index.php/ASDoc" target="_blank">ASDoc command line tool</a> around the 11th- i was otherwise <a href="http://custardbelly.com/blog/?p=54" target="_blank">occupied</a>, but am happy to find a way to figure documentation into <a href="http://www.bit-101.com/blog/?p=849" target="_blank">Keith Peters&#8217; FlashDevelop templates for Flex2 and As3 projects</a> now that i am back at my computer.</p>
<p>( If you haven&#8217;t already, follow that l<a href="http://www.bit-101.com/blog/?p=849" target="_blank">ink to Keith&#8217;s tutorial</a> on adding project templates if you are interested in creating an excellent dev environment in FD and are curious about what i added to target auto-documentation in the ANT process ). </p>
<p>To sum it up, all i added was a couple properties to the build.properties file and a conditional target to the build.xml. The modified files are here:</p>
<p><a href="http://custardbelly.com/downloads/fd/build.properties" target="_blank">build.properties</a><br />
<a href="http://custardbelly.com/downloads/fd/build.xml" target="_blank">build.xml</a></p>
<p>&#8230; be aware that these are modified files downloaded from keith&#8217;s post, so if you have changed some values in the properties file on your own machine you shouldn&#8217;t explicitly replace these with your own.</p>
<p>[Note: it's not really actionscript code below, i'm just being lazy]</p>
<p><strong>The additions to <em>build.properties</em></strong>:</p>
<p><em>1 &#8211; under the project properties header&#8230;</em><br />
[as]#document titles<br />
docbuild=false<br />
doc.maintitle=templatetest<br />
doc.windowtitle=&#8217;template test&#8217;[/as]<br />
<em><br />
&#8230; the docbuild property is a string boolean evaluated in a conditional in the build.xml. The others are command params <a href="http://labs.adobe.com/wiki/index.php/ASDoc:Using_ASDoc" target="_blank">found here</a>. Remember that anything with spaces needs quotes around it, as is the value for doc.windowtitle.</em></p>
<p><em>2 &#8211; under the tools header&#8230;</em><br />
[as]# where you installed your documenter:<br />
asdoc.dir=C:/Flex_2_sdk<br />
&#8230;<br />
# most of this shouldn&#8217;t need to change<br />
&#8230;<br />
documenter=bin/asdoc.exe<br />
&#8230;<br />
[/as]</p>
<p><em>&#8230; where asdoc.dir and documenter are relative to where you unzipped the ASDoc &#8211; in this case i threw it into the directory of the sdk.</em></p>
<p><strong>the additions to <em>build.xml:</em></strong></p>
<p><em>1- conditional added to the compile target:</em><br />
[as]<condition property="builddocument"><br />
<equals arg1="${docbuild}" arg2="true"/><br />
</condition><br />
[/as]<br />
<em>2 &#8211; the document target</em><br />
[as]<target name="document" if="builddocument"><br />
	<exec executable="${asdoc.dir}/${documenter}"><br />
            <arg line="-source-path ${source.dir} -doc-sources ${source.dir}/. -main-title ${doc.maintitle} -window-title ${doc.windowtitle} -output ${doc.dir}"/><br />
         </exec><br />
</target><br />
[/as]<br />
<em>3 &#8211; antcall added to build target:</em><br />
[as]<antcall target="document"/>[/as]</p>
<p>&#8230; Changing the doc.build value in build.properties to any string other than &#8216;true&#8217; will cause this to not rebuild the documentation, which can be handy if you are just doing quick tests or bug finding &#8211; otherwise, if set to &#8216;true&#8217; it will document any AS files recursively found in ${source.dir}.</p>
<p>I had a similar build made up for AS2 projects and <a href="http://www.blinex.com/index.cfm?view=bldoc&#038;nav_view=products" target="_blank">BlDoc</a> in FlashDevelop using ANT earlier and thought i&#8217;d have a go with it using <a href="http://labs.adobe.com/wiki/index.php/ASDoc" target="_blank">ASDoc</a>, maybe someone else will find this useful&#8230;</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2006/08/28/asdoc-and-keith-peters-flashdevelop-templates/#comments" rev="post-55"  title="Comment on ASDoc and Keith Peters&#8217; FlashDevelop templates">8 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2006-08-28T22:50">August 28, 2006</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-55-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-54" class="post-54 post hentry category-general full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2006/08/27/back-from-a-pennsy-wedding-and-alaskan-honeymoon/" title="Permanent link to Back from a Pennsy wedding and Alaskan honeymoon." rel="bookmark" rev="post-54">Back from a Pennsy wedding and Alaskan honeymoon.</a></h1>
	
	<div class="entry-content full-content">
		<p><img src="http://custardbelly.com/blog/images/carrie.png" alt="Carolyn Anderson" /></p>
<p>This beautiful lady and i said &#8216;I do&#8217; on August 12th in New Hope, PA. On August 13th we <a href="http://www.flickr.com/photos/91582541@N00/sets/72157594254079258/" target="_blank">set out for Alaska</a>.</p>
<p>Needless to say, i haven&#8217;t been around a computer for two weeks&#8230; looking forward to coding with a ring on.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/general/" title="View all posts in General" rel="category tag">General</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2006/08/27/back-from-a-pennsy-wedding-and-alaskan-honeymoon/#comments" rev="post-54"  title="Comment on Back from a Pennsy wedding and Alaskan honeymoon.">2 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/administrator/" title="View all posts by Administrator">Administrator</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2006-08-27T21:27">August 27, 2006</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-54-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-51" class="post-51 post hentry category-as3 category-flash full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2006/07/05/as3-lcd-donkee-kong-jr/" title="Permanent link to AS3 LCD Donkee Kong Jr" rel="bookmark" rev="post-51">AS3 LCD Donkee Kong Jr</a></h1>
	
	<div class="entry-content full-content">
		<p>click to play. <a href="http://www.adobe.com/products/flashplayer/">Flash Player 9</a> required.<br />
<a href="javascript:MM_openBrWindow('http://www.custardbelly.com/dev/junior/index.html', 'dk_jr','resizable=no,width=340,height=280')" alt="click to play"><img src="http://www.custardbelly.com/blog/images/dkjr.gif" alt="click me"/></a></p>
<p>After i brought those old Game&#038;Watch <a href="http://custardbelly.com/blog/?p=49" target="_blank">handhelds home</a>, i started playing them heavily. After being beat into submission hundreds of times i began thinking &#8216;these games are too damn hard&#8217; &#8211; so i put them down and decided to try and recreate one in <a href="http://livedocs.macromedia.com/flex/2/langref/index.html" target="_blank">Actionscript3</a>&#8230; here&#8217;s the first one i came out with &#8211; a remake of Donkey Kong Jr from the widescreen <a href="http://gameandwatch.com/" target="_blank">Game&#038;Watch</a> series.</p>
<p>With the previous games i have worked on, i employed a pixel collision detection system to drive game play- but when thinking about LCD games, spaces on the screen are reserved and there is no real overlap of pixels to detected when an enemy runs into a hero, an enemy connects with a projectile, etc. Instead i had to employ a sort-of &#8216;mother may i&#8217; management system where a call is made from every &#8216;object&#8217; prior to it&#8217;s bitmap update to see if anything is in between where what block it&#8217;s in and what block needs to be rendered next. The development was based mainly on <a href="http://electronics.howstuffworks.com/lcd7.htm" target="_blank">Passive Matrix LCDs</a>. </p>
<p>Ultimately how it is put together is by loading a graphics sheet with all the states for each &#8216;player&#8217; and then basing it&#8217;s rendered state upon game interaction and a list of state &#8216;matrices&#8217;. On each &#8216;allowance&#8217; of movement the bitmapdata is cleared and redrawn with a new state. And in the case of the enemies, based on your progression through the game, the &#8216;allowance&#8217; timing is sped up.</p>
<p>The biggest thing i have gained from working this through is the beauty of the new <a href="http://livedocs.macromedia.com/flex/2/langref/index.html" target="_blank">Timer class</a>. With the introduction of BitmapData in Flash8 As2 i began rethinking how i was developing, and now with the Timer class i&#8217;m doing it again. I loved onEnterFrame for so long, but that just wasn&#8217;t gonna hack it for this project&#8230; and i&#8217;m glad it didn&#8217;t.</p>
<p>I kept the architecture pretty open for easy adaptation and extension so that i could make more of these LCD games with ease, but i think i have to step away for a bit. Sound would be a good addition to this and i plan to do a little work on that, but i&#8217;m getting pretty busy.<br />
Enough talk, enjoy the game and keep in mind that this is a rough prototype, so you may encounter a bug or two <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_wink.gif' alt=';)' class='wp-smiley' /> </p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2006/07/05/as3-lcd-donkee-kong-jr/#comments" rev="post-51"  title="Comment on AS3 LCD Donkee Kong Jr">12 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/administrator/" title="View all posts by Administrator">Administrator</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2006-07-05T07:53">July 5, 2006</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-51-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-49" class="post-49 post hentry category-as3 category-flash full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2006/06/09/as3-2d-tilescroller-source/" title="Permanent link to AS3 2d tilescroller source" rel="bookmark" rev="post-49">AS3 2d tilescroller source</a></h1>
	
	<div class="entry-content full-content">
		<p><a href="http://www.custardbelly.com/downloads/as3/TileScroller/index.html">view swf and source here.</a></p>
<p>I trimmed down some processes and stripped any excess so the classes included focus just on the tile scroller. In <a href="http://custardbelly.com/blog/?p=47">my previous post</a> the movement was based upon the position of the sprite- here it&#8217;s based soley on keystrokes. It also utilizes some of <a href="http://custardbelly.com/blog/?p=43">my ImagesLoader</a> classes. </p>
<p>The real meat is in the updateScroll method of the MapScrollLayer class. That handles all the update of bitmapdata to the gridded tiles, and redraw/scroll of the displayed bitmap.<br />
One thing i found exciting was creating custom namespaces. If you take a peek at com.custard.as3.models.TileLayerMap, in the constructor it creates a 2d array based on the data type.</p>
<p>I had planned to make a fuller presentation with some tutorial-like explanations, but my time is pretty thin right now. If enough people are interested in that, i&#8217;d definitely get on top of it. A basic understanding of OOP may be needed to gather something from the code. i don&#8217;t really plan to go that much into it, but if you are a little rusty, unfamiliar with the concept, or want to learn more, <a href="http://blog.benstucki.net/">Ben Stucki</a> is going into that this month on his blog.</p>
<p>&#8230;also&#8230;</p>
<p>every time i go back home to my parents&#8217;, there&#8217;s some more boxes of &#8216;junk&#8217; that have been sitting in the basement, stuck in some dark corner, since my room was turned into an office.<br />
this past weekend i went through another said box, and pulled out this bounty!</p>
<p><img src="http://custardbelly.com/blog/images/gamewatch.gif" alt="game&#038;watch" /></p>
<p>had forgotten all about these guys&#8230;</p>
<p>i&#8217;m waiting for the box that had my old <a href="http://en.wikipedia.org/wiki/Image:Etch-A-Sketch_Animator.jpg">etch-a-sketch animator gadget</a>. man, i loved that thing.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2006/06/09/as3-2d-tilescroller-source/#comments" rev="post-49"  title="Comment on AS3 2d tilescroller source">3 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2006-06-09T07:58">June 9, 2006</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-49-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-48" class="post-48 post hentry category-flash category-flash8 full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2006/06/01/yahoo-maps-api-article/" title="Permanent link to Yahoo! maps API article" rel="bookmark" rev="post-48">Yahoo! maps API article</a></h1>
	
	<div class="entry-content full-content">
		<p><a href="http://www.chuckstar.com/blog/">Chuck Freedman</a> &#8211; ex-xplanaCollegue, current Sr Flash developer for Yahoo! maps, and all around <a href="http://wwwimages.adobe.com/www.adobe.com/devnet/images/160x160/charles_freedman.jpg">good guy</a> &#8211; has recently written an <a href="http://www.adobe.com/devnet/flash/articles/yahoo_mashup.html">article </a>for <a href="http://www.adobe.com/devnet/">Adobe&#8217;s Dev Center</a>  detailing integration of the Yahoo! maps API Flash components into your applications.<br />
<a href="http://www.adobe.com/devnet/flash/articles/yahoo_mashup.html"><br />
go check it out.</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flash8/" title="View all posts in Flash8" rel="category tag">Flash8</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2006/06/01/yahoo-maps-api-article/#comments" rev="post-48"  title="Comment on Yahoo! maps API article">1 comment</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2006-06-01T21:55">June 1, 2006</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-48-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-47" class="post-47 post hentry category-as3 category-flash full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2006/05/31/as3-2d-tilescroller/" title="Permanent link to AS3 2D Tilescroller" rel="bookmark" rev="post-47">AS3 2D Tilescroller</a></h1>
	
	<div class="entry-content full-content">
		<p><a href="javascript:MM_openBrWindow('http://www.custardbelly.com/AS3/MapScroll/index.html','til_scroller','resizable=no,width=400,height=200');"><img src="http://www.custardbelly.com/AS3/MapScroll/tilescroller.gif" alt="click me" /></a>click me.</p>
<p>During the port of my AS2 classes into AS3, i thought i might take a stab at a tile scrolling engine. I never got into making one before, and since I&#8217;ve been delving into the magic that is BitmapData, i decided to give it stab. I need to do a little house cleaning, but i plan to throw up the code here soon&#8230;</p>
<p>In previous versions of Actionscript it was common to do variations of &#8216;move and replace&#8217; based on movieclip positions and key strokes ( see <a href="http://www.tonypa.pri.ee/tbw/index.html">TonyPa</a>, <a href="http://www.strille.net/tutorials/part1_scrolling.php">Strille</a>, <a href="http://oos.moxiecode.com/tut_10/index.html">Outside of Society</a>, <a href="http://recycle.andre-michelle.com/">André Michelle</a>, etc ). There was some great implementations and they worked well, but i figured with BitmapData it could be boiled down to a smoother and less intensive process &#8211; kind of what <a href="http://www.bit-101.com/blog/">Keith</a> has been<a href="http://www.bit-101.com/lab/?p=18"> labbing with</a>.</p>
<p>What&#8217;s going on-<br />
The layers ( there are 3 in the example but you can add however many before your graphics card yells at you ) are just a grid of Bitmap objects &#8211; the amount based on the &#8216;visable&#8217; area divided by the tile size of the graphics.<br />
They don&#8217;t move at all &#8211; instead they are offscreen and are updated based on the characters &#8216;x&#8217; and &#8216;y&#8217; velocity divided by tile size, of which its remainders are parameters supplied to the scroll method of a BitmapData instance that is redawing the layers upon key press.</p>
<p>In the coming days, i hope to strip out a little code and throw the source ( and maybe some drawings that will clear up my terrible explanation ) up here&#8230; just wanted to do a quick post for proof of concept.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2006/05/31/as3-2d-tilescroller/#comments" rev="post-47"  title="Comment on AS3 2D Tilescroller">12 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2006-05-31T07:21">May 31, 2006</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-47-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-46" class="post-46 post hentry category-as3 category-flash full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2006/05/10/f9-updates/" title="Permanent link to f9 updates" rel="bookmark" rev="post-46">f9 updates</a></h1>
	
	<div class="entry-content full-content">
		<p>just wanted to make a quick post here&#8230;</p>
<p><a href="http://labs.adobe.com/">FlexBuilder2_beta3</a> is out &#8211; although you probably didn&#8217;t need me to tell you- &#8230;<br />
Updated my <a href="http://custardbelly.com/blog/?p=43">ImagesLoader</a> classes to flash9&#8230;<br />
My mind is completely <a href="http://i12.photobucket.com/albums/a239/djrecon83/pingpong5ah.jpg">boggled</a> by<a href="http://codeazur.com.br/stuff/fc64/"> FC64.</a>&#8230;<br />
<a href="http://www.gamespot.com/ds/action/supermariobrosds/index.html">DS Mario Bros</a> comin out&#8230;</p>
<p>Also&#8230; <a href="http://www.zeuslabs.us/">Josh Tynjala over at zeuslabs </a>( i highly recommend checking out his AS3 <a href="http://www.zeuslabs.us/archives/63/introduction-to-particle-systems-using-actionscript-3/">particlesystem experiments</a> ) had recently <a href="http://www.zeuslabs.us/archives/64/actionscript-3-handling-inheritance/#comments">posted a porting question</a> involving heritance issues and i struck up an example that may have proved helpful&#8230; thought i&#8217;d post them here as well.</p>
<p>It basically is an <a href="http://custardbelly.com/AS3/FruitApp/srcview/index.html">example</a> on how to use interfaces and &#8220;AS3 abstract&#8221; classes to call methods between different subclass implementations. <a href="http://www.custardbelly.com/downloads/as3/FruitExample.zip"> download the zip here</a>.</p>
<p>And i gotta throw up something i&#8217;ve been porting on my own &#8230; <a href="javascript:MM_openBrWindow('http://www.custardbelly.com/blog/files/StripExample/index.html','stripExample','resizable=no,width=300,height=100');">strip example</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2006-05-10T23:46">May 10, 2006</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-46-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-44" class="post-44 post hentry category-as3 category-flash category-flash8 full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2006/05/05/programmatic-barberpole/" title="Permanent link to Programmatic barberpole" rel="bookmark" rev="post-44">Programmatic barberpole</a></h1>
	
	<div class="entry-content full-content">
		<p>Flash8 and AS3 examples &#8211; <a href="http://custardbelly.com/blog/insets/ProgressIndicator.html">you can view and download the source here</a></p>
<p>I&#8217;ve created and used many variations of non-descriptive loaders. The most common one i always go back to is the &#8216;barberpole&#8217; &#8211; each time trying to fine tune it&#8230; create a graphic 4/3rd it&#8217;s displayed size, place it at at -1/3, throw a mask around it,  script to move it a third and, when reached, push it back a third&#8230; but it always seemed so clunky to me. i couldn&#8217;t dynamically change the colors of the bands, couldn&#8217;t resize it accurately, couldn&#8217;t warm up to the idea that there is too much stuff in there.  </p>
<p>With the advent of BitmapData, i decided to take a stab at it programmatically. I&#8217;m pretty satisfied with the outcome, although it seems that AS3 BitmapData.scroll is kindof skippish in a browser. I tried to make it fool-proof with speed/size/band settings, but it can get a little screwy if you throw some random numbers in there.</p>
<p>It utilizes the matrix param of the BitmapData.draw method, by copying a &#8216;banded&#8217; bitmapdata instance and skewing it, then scrolling and fillRect&#8217;ing based on a scroll limit.<br />
In the <a href="http://custardbelly.com/blog/insets/ProgressIndicator.html">link</a> above you&#8217;ll see an example of it, and will no longer have to read my terrible method-to-verb sentence combinations. </p>
<p>&#8230;as they say in these parts&#8230; <a href="http://www.razorberry.com/blog/archives/2006/05/03/i-was-forced-to-post-this/">&#8216;it aint no red ball, but it does me just fine&#8217;.</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flash8/" title="View all posts in Flash8" rel="category tag">Flash8</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2006-05-05T07:48">May 5, 2006</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-44-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-43" class="post-43 post hentry category-as3 category-flash full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2006/04/28/an-imagesloader-in-as3/" title="Permanent link to An ImagesLoader in AS3" rel="bookmark" rev="post-43">An ImagesLoader in AS3</a></h1>
	
	<div class="entry-content full-content">
		<p>[<strong>Edit:</strong> Files have been updated for <a href="http://labs.adobe.com/">Flex2_beta3</a>]</p>
<p>You can view ( although it&#8217;s pretty unexciting visually ) and download the <a href="javascript:MM_openBrWindow('http://www.custardbelly.com/blog/files/ImagesLoader/imgsLoader.html','imgsLoader','resizable=no,width=325,height=360');">source here.</a></p>
<p>My first &#8216;real&#8217; dabbling in AS3 was to tackle a port of my <a href="http://custardbelly.com/blog/?p=27">ImagesLoader</a> classes from Flash8.<br />
I&#8217;ve been using the ImagesLoader, or at least one of the buffer classes, in all of my personal projects since i created it &#8211; which is styled after <a href="http://fivedots.coe.psu.ac.th/~ad/">Andrew Davison</a>&#8217;s ImagesLoader &#8211; and find it extremely convenient. i hope if anyone has downloaded the classes and used them, they found it so as well. If not, i&#8217;m up for any criticism you may have.</p>
<p><a href="http://www.5etdemi.com/blog/">Patrick Mineault</a> had mentioned loading more than one file within the ImageLoaderQueue class ( which is mainly used in the MultiBuffer ), but i didn&#8217;t get around to it. Mainly because i&#8217;d have to have multiple instances of the ImageLoader in the queue&#8230; and i&#8217;m being lazy <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /><br />
If someone&#8217;s got a different take on that, i&#8217;d be glad to hear it.</p>
<p>I think it works pretty well right now, but i may go back in and flesh out the BufferEvent to handle event parameters as <a href="http://www.darronschall.com/weblog/archives/000191.cfm">Darron Schall explains here.</a> Right now a buffer queue just calls back to it&#8217;s instance of ImageLoader after an event and grabs any data needed&#8230; not sure how i feel about that&#8230;</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2006-04-28T19:46">April 28, 2006</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-43-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-41" class="post-41 post hentry category-flash category-flash8 full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2006/04/09/state-behavior-system-for-sprites/" title="Permanent link to State behavior system for sprites" rel="bookmark" rev="post-41">State behavior system for sprites</a></h1>
	
	<div class="entry-content full-content">
		<p><a href="http://www.custardbelly.com/blog/insets/states.html" target="_blank"><img src="http://www.custardbelly.com/blog/images/states.gif" alt="click me" /></a></p>
<p>Here&#8217;s a little example of what i&#8217;ve progressed to since i went down the path of changing my thought process of what a user-controlled sprite is.<br />
Hit the block to produce a bonus ( or the hammer-fountain ) and collect the bonus by running into it. You can become big, a racoon or a frog. When you&#8217;re the racoon, once you reach max acceleration, the screen will display &#8220;tap spacebar&#8221; &#8211; tap that spacebar fast and you&#8217;ll be able to fly.</p>
<p>What&#8217;s happening:<br />
My implementation of a user-controlled sprite has been reduced to a simple particle with a display movieclip inside and reacts to key controls. Upon pixel collision of a &#8220;bonus&#8221; not of current sprite type, the display bitmap is updated with a different graphics source, and the sprite model is changed accordingly.<br />
Each sprite model has a set of behaviors that respond to key controls &#8211; and in the case of the racoon, those behaviors are switch out on recognition of maximum acceleration; meaning you can fly if you tap the space bar fast enough once you are at max speed. Another neat thing is that the Fly Behavior is on a timer, so after about 5 seconds, it&#8217;s switched back to your previous behavior. The frog is interesting to see the difference in behaviors &#8211; when you move left or right, the hop behavior is called, as opposed to the basic roam ( or walk/run ) behavior of the others.</p>
<p>I&#8217;m also employing the particle sytem structure i had before, and switch action policies based on whether the sprite is &#8220;hurt&#8221; or not. A visual clue to let you know that the sprite responds to key controls again is once the stars start falling and turning red.</p>
<p>I think this is going to be the last in my Flash8 experiments of sprites and effects, and start porting what i have over to <a href="http://labs.macromedia.com/">AS3</a>- cleaning and documenting as i go. Hopefully i&#8217;ll have something up soon, but seeing as i&#8217;m a newly proud owner of a DS, my productiveness may wane for a bit <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /> </p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flash8/" title="View all posts in Flash8" rel="category tag">Flash8</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2006/04/09/state-behavior-system-for-sprites/#comments" rev="post-41"  title="Comment on State behavior system for sprites">3 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/administrator/" title="View all posts by Administrator">Administrator</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2006-04-09T19:30">April 9, 2006</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-41-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-40" class="post-40 post hentry category-flash category-flash8 full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2006/03/26/particle-pixel-collision/" title="Permanent link to Particle Pixel Collision" rel="bookmark" rev="post-40">Particle Pixel Collision</a></h1>
	
	<div class="entry-content full-content">
		<p><a href="javascript:MM_openBrWindow('http://www.custardbelly.com/blog/insets/ppColl.html','strip','resizable=no,width=250,height=130');"><img src="http://www.custardbelly.com/blog/images/ring.gif" alt="click me" /></a></p>
<p>Well, i said i was gonna get into switching action policies for the user-controlled sprite, but i thought it might be cool if i gave a visual clue if the sprite was disabled ( unable to switch actions ). Then i thought, &#8216;What better clue than a ring of stars around its head?&#8217;. Created a rotating-ring particle system. Done&#8230;<br />
Damn&#8230; It rotates, but not around the sprite. I&#8217;ve been placing particle systems in their own movieclip &#8211; somtimes behind, sometimes atop the sprite&#8230; I wasn&#8217;t rendering everything in a &#8216;world&#8217; view with z-buffering, because everything was 2d and i thought &#8216;&#8230;just layer it, jerk&#8217;.  i still do.</p>
<p>Let&#8217;s see&#8230; do i throw a particle system in with the sprite class and swap depths based on z position of particles? No i just want a sprite to be a sprite and not worry about managing anything. Should i have a special particle system that sandwiches movieclips around the emission node, then create and dipose based on z-position? Now with AS3, i could fashion something like that because of the DisplayList ( as <a href="http://blog.pixelconsumption.com/">Sam</a> so <a href="http://www.bfpug.com/?p=19">eloquiantly showed</a>&#8230; though i he didn&#8217;t strip off an article clothing after every audience question &#8211; which was promised ), but in AS2 that would just be too confusing.</p>
<p>So i went back to my <a href="http://custardbelly.com/blog/?p=28">PixelCollision class</a> and decided to poke around. Well, i did&#8230; and royally screwed up that code (that&#8217;s what svn is for!), but came out with a nice solution for replacing pixels in one bitmapdata object based on non-alpha collisions.</p>
<p>In the movie link above you can see what&#8217;s happening (well kind of, i made it too small i think). It&#8217;s actually a rotating-ring system in a layer above the sprite, and it&#8217;s applying alpha transparency to the stars based on collision &#8211; and/or also pixel replacement of sprite if you click on the stage (that&#8217;s my favorite part). It&#8217;s a shame it gets a little skippish in a browser, i&#8217;ll have to do a little cleaning and see what happens.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flash8/" title="View all posts in Flash8" rel="category tag">Flash8</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2006/03/26/particle-pixel-collision/#comments" rev="post-40"  title="Comment on Particle Pixel Collision">3 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2006-03-26T21:32">March 26, 2006</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-40-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-36" class="post-36 post hentry category-flash category-flash8 full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2006/03/20/particle-policies/" title="Permanent link to Particle Policies" rel="bookmark" rev="post-36">Particle Policies</a></h1>
	
	<div class="entry-content full-content">
		<p><a href="javascript:MM_openBrWindow('http://www.custardbelly.com/blog/insets/strip.html','strip','resizable=no,width=250,height=130');"><img src="http://www.custardbelly.com/blog/images/starjumper.gif" alt="click me" /></a></p>
<p>Lately i&#8217;ve been obsessed with particle systems and developing life and action policies &#8211; mainly from <a href="http://blog.je2050.de/?p=50">Joa Ebert&#8217;s</a> discussion of particles in AS3. I was busy having fun watching different effects with a click of the mouse, when i thought it would be a good time to see what part of my code would break if i took away the emission controls from onMouseDown and applied it to a sort of state-conroller of a moving sprite.</p>
<p>If you click on the above pic you&#8217;ll see a little test of this. After setting this up i started thinking, what&#8217;s stopping me from adding action policies to the sprite, since it&#8217;s essentially just a single particle? Have a little registry of actions and replace them based on type and their time limits. I started something along these lines recently, but wasn&#8217;t thinking clearly enough on how to set it up&#8230; so i ended up re-thinking my ideas of what a user-controlled sprite is, and stripped out a lot off useless code i had around. much happier. Hopefully i&#8217;ll get an example up soon of the actions registry i incoherently just mentioned.</p>
<p>* I also wanted to alert anyone who had previously downloaded the <a href="http://custardbelly.com/blog/?p=27">ImagesLoader</a> classes (the zip there has the updated classes). I made some minor changes to a few of the classes and how things are stored for a strip image.<br />
<em>The change</em>: The way i was cycling through the states was switching copies of a chopped up bitmap &#8211; so say if there were seven states of a sprite, i was holding seven different BitmapData objects and switching copies based on the frame count. I decided that that was not the best solution, and switched to holding onto the strip bitmap offscreen and just cycling through Rectangle objects that described the dimension and location of what i wanted to copy from that strip. If you view the movie above, you&#8217;ll see what i&#8217;m talking about.</p>
<p>..and of course there&#8217;s this <a href="http://www.dsfanboy.com/2006/03/13/dont-look-at-these-new-super-mario-screenshots/">awesome news</a>&#8230; might have to actually go and buy a DS.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flash8/" title="View all posts in Flash8" rel="category tag">Flash8</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2006-03-20T14:26">March 20, 2006</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-36-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-35" class="post-35 post hentry category-general full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2006/02/24/that-one-dream-variable/" title="Permanent link to That one dream variable." rel="bookmark" rev="post-35">That one dream variable.</a></h1>
	
	<div class="entry-content full-content">
		<p>What would you say is that one variable/method name you are just itching for the right project to come along so you can use?</p>
<p>I posed this question to my friend and co-worker, <a href="http://www.razorberry.com/blog">Ash</a>, and he replied with an answer that was so practical , but at the same time euphemistic, that i was rolling on the floor. It was almost used as a flag in an app that utilizes the drawingAPI&#8230; penIsDown. </p>
<p>I was thinking more along the lines of something that would only have context in that one particlular app. Something like <strong>private function tiltFez()</strong> or <strong>public var monkeyFreckle</strong>&#8230;</p>
<p>&#8230; but what Ash said was just classic, and i want to hear what other people got.</p>
<p>Leave a comment for what yours is&#8230; try to keep it clean.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/general/" title="View all posts in General" rel="category tag">General</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2006/02/24/that-one-dream-variable/#comments" rev="post-35"  title="Comment on That one dream variable.">1 comment</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2006-02-24T14:47">February 24, 2006</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-35-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-32" class="post-32 post hentry category-general full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2006/02/01/offloading-rendering-in-a-3d-engine/" title="Permanent link to Offloading rendering in a 3d engine" rel="bookmark" rev="post-32">Offloading rendering in a 3d engine</a></h1>
	
	<div class="entry-content full-content">
		<p>After reading Keith&#8217;s <a href="http://www.amazon.com/gp/product/1590595181/sr=1-1/qid=1138766400/ref=pd_bbs_1/103-6509034-0931065?%5Fencoding=UTF8">Making Things Move</a>, i went on a coding-binge and made a simple 3d engine. I was loving it. went nuts with some extended primitives &#8211; still need to get around to the infamous <a href="http://www.sjbaker.org/teapot/">Utah Teapot</a>&#8230; we&#8217;ll see how that goes &#8230;</p>
<p>But i recently built a particle system engine that handles 3d objects, and after trying to plug it into the pipeline i already created, i started to question where i was passing off the rendering of objects.</p>
<p>The way i have it set up is by registering objects in a World class, in which a new movieclip is created held in an array and, when updates are made to the scene, cleared and redrawn. So i basically offloaded all the drawing within the World class.</p>
<p><a href="http://sandy.media-box.net/blog/">SANDY</a> has it set up to clearing all clips, creating new clips within the world, then sending those references off to each face of the object. So inside the Face class all drawing is handled.<br />
There&#8217;s some ideas in that process that i really like (like the fact that the face knows what it&#8217;s supposed to look like so it knows internally what to do), but i don&#8217;t like that the drawing process is so deeply nested.<br />
The way i have it, i&#8217;m grabbing the skin properties of the faces within the view update of the World class and then drawing accordingly. That&#8217;s probably not the greatest idea because i&#8217;m adding a couple more processes (&#8221;hey what do you look like so i can draw you right.&#8221; &#8211; as a opposed to &#8211; &#8220;hey you need to redraw yourself. whatever you look like, do that.&#8221;) &#8211; but for some reason i just think keeping it out of my Face class makes more sense. Maybe i think it&#8217;s a better way of seperating the model construction from the rendering process. i don&#8217;t know. </p>
<p>Now, i&#8217;m contemplating where to offload this drawing process. The main reason being filter application when dealing with particles. With the particle system i have set up, i handle transformations and filters of the object in clip in Policy classes, then pass off a check of being active to managers that handle whether or not to render that object.</p>
<p>It brings up an interesting topic for me. When dealing with OOP in Flash, where do you think the drawing process should really be placed? Inside the object that&#8217;s being drawn? In some manager that handles all objects being drawn? suggestions? are any of these options more optimal to proccessing?</p>
<p>For fun, here&#8217;s a little example of what i&#8217;ve been playing around with. It was built in 8 based on the ideas of <a href="http://blog.je2050.de/">Joa Ebert</a> for his engine in AS3 (if you haven&#8217;t been to his blog, i highly recommend it), where Life and Action Policies are wrapped around a 3d object. There&#8217;s no Z-buffering or collision-detection yet (because of my aformentioned question), so don&#8217;t be too judgemental .</p>
<p>It&#8217;s in constant emmision, so when a particle expires, it regenerates itself at the initialization point &#8211; optimizations still to be done.</p>
<p><a href="javascript:MM_openBrWindow('insets/psys.html','psystem','resizable=no,width=300,height=288');"><img src="http://www.custardbelly.com/blog/images/stars.png" alt="click me to view" /></a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/general/" title="View all posts in General" rel="category tag">General</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2006/02/01/offloading-rendering-in-a-3d-engine/#comments" rev="post-32"  title="Comment on Offloading rendering in a 3d engine">1 comment</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2006-02-01T00:07">February 1, 2006</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-32-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-30" class="post-30 post hentry category-flash category-flash8 full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2006/01/11/how-do-you-manage-your-filters/" title="Permanent link to How do you manage your filters?" rel="bookmark" rev="post-30">How do you manage your filters?</a></h1>
	
	<div class="entry-content full-content">
		<p><strong>[Update: 2/24/2006]</strong><br />
I&#8217;ve updated my workings of a management system for a movieclip&#8217;s filters after Lars Schwarz brought up some interesting thoughts. <a href="http://custardbelly.com/downloads/ManagedFilterMap.zip">Here are the new files.</a> I basically pushed some management methods through a Singleton (McFilterManager), that registers/unregisters managed clips ( FilterManagedClip ). It&#8217;s not that necessary and the FilterManagedClip class can be used by itself, but if you want to hold references for all the clips that have filters, then it could be useful and expanded upon.</p>
<p>FilterManagedClip really does all the managing, and as Lars suggested, it now holds a reference to a unique id supplied, instead of using a instanceof check on the filter list.</p>
<p>plus i fixed that bug in removeFilter &#8211; sorry about that.<br />
<strong>[End Update.]</strong></p>
<p>I&#8217;ve been playing around with filters in Flash 8, and started to get annoyed that if i wanted to update a filter&#8217;s settings i had to grab an instance from the movieclip&#8217;s filter array, change the properties and then reassign the filter array- particualarly because this caused problems if i had more than one type of filter and only wanted to change one propetry from one filter. Just seemed like too much code to change one thing.</p>
<p>-example<br />
Say your throwing up some particles that have a trajectory and prior to their apex, you want an increasing blur filter. as they hit the apex you want to add a glow filter, as they descend you want to increase that glow filter, while decreasing the blur filter. That&#8217;s a lot of grab-instances-of-filters, replace-values-of-properties-in-filters, reapply-changed-filters-to-mc, gobbildy-gook. Yeah, i went there&#8230; gobbildy-gook.</p>
<p>Then i thought, well i&#8217;ll just make a class with a couple static methods that will add, remove, replace, and update filters held in the filter array of a movieclip. That&#8217;s well and good, but i&#8217;m still a little dissatisfied. </p>
<p>What if i want to make one for bitmapdata? sure, just copy-and-paste the code and replace the movieclip instances with bitmapdata in a new class.</p>
<p>What if i have more than one instance of the same type of filter? Uh-oh. (you&#8217;ll see what i mean if you check out the <a href="http://www.custardbelly.com/downloads/McFilterMap.as">class</a>). I could make a manager class with handles a specified movieclip and holds unique ids in a map reference each new filter, but then if i have multiple particles&#8230; i don&#8217;t know&#8230; i just don&#8217;t like having so many managers.</p>
<p>I could be totally off the mark here and am missing some operation which i haven&#8217;t found and suits this very purpose&#8230; but i was just wondering what other people do to manage their filters.</p>
<p>suggestions? </p>
<p>feel free to use the <a href="http://www.custardbelly.com/downloads/McFilterMap.as">McFilterMap class</a>.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flash8/" title="View all posts in Flash8" rel="category tag">Flash8</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2006/01/11/how-do-you-manage-your-filters/#comments" rev="post-30"  title="Comment on How do you manage your filters?">4 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2006-01-11T21:43">January 11, 2006</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-30-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-29" class="post-29 post hentry category-as3 category-flash full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/11/11/as3-pixel-collision-detection/" title="Permanent link to AS3 Pixel Collision Detection" rel="bookmark" rev="post-29">AS3 Pixel Collision Detection</a></h1>
	
	<div class="entry-content full-content">
		<p>check it out <a href="javascript:MM_openBrWindow('http://www.custardbelly.com/AS3/PixelCollision.html','coll_trial','resizable=no,width=150,height=110');">here</a> <em>(requires 8.5)</em></p>
<p>It&#8217;s the same code as the prior post, just a different implementation for sending the data to check the collision because it&#8217;s in AS3.</p>
<p>One thing i found that may be helpful to others&#8230; i spent about 10 minutes trying to figure out why i couldn&#8217;t &#8220;press&#8221; on the sprite. Turns out i could have all along, but since i didn&#8217;t see the hand cursor on rollover, i just figured my code was wrong&#8230;</p>
<p>I guess i have some new visual learning to go along with the new code.</p>
<p>Here&#8217;s a little snippet of how you do startDrag/stopDrag in AS3. It can be found in the online docs&#8230; if i had bothered to read them <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' />  .<br />
 If you want to see the hand cursor, you have to set buttonMode to true (as far as i know)- which will turn on useHandCursor with the default value of true.</p>
<p>[as]<br />
import flash.display.Sprite;<br />
import flash.events.Event;<br />
import flash.events.MouseEventType;</p>
<p>public class SpriteExample extends Sprite<br />
{<br />
	public function SpriteExample()<br />
	{<br />
		buttonMode = true;<br />
		addEventListener(MouseEventType.MOUSE_DOWN, onMouseDown);<br />
		addEventListener(MouseEventType.MOUSE_UP, onMouseUp);<br />
	}</p>
<p>	private function onMouseDown(evt:Event):Void<br />
	{<br />
		this.startDrag();<br />
	}</p>
<p>	private function onMouseUp(evt:Event):Void<br />
	{<br />
		this.stopDrag();<br />
	}<br />
}<br />
[/as]</p>
<p>i&#8217;m looking to put up the code for the Pixel Collision Detection for both Flash8 and AS3, still running some test and cleaning up.</p>
<p><a href="javascript:MM_openBrWindow('http://www.custardbelly.com/flash8/PixelHit.html','coll_trial','resizable=no,width=415,height=415');">Here&#8217;s a &#8220;30-Colby at 30FPS&#8221; trial</a> in flash8, but it seems to take a huge hit on a Mac for all browsers&#8230; don&#8217;t know what&#8217;s up with that. Does drop about 10 frames on a PC even with a proximity detector, but as i said in the previous post, i probably wouldn&#8217;t use this detection for large amounts of objects.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-11-11T02:30">November 11, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-29-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-28" class="post-28 post hentry category-flash category-flash8 full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/11/09/pixel-perfect-collision-detection-in-flash8/" title="Permanent link to Pixel Collision Detection in Flash8" rel="bookmark" rev="post-28">Pixel Collision Detection in Flash8</a></h1>
	
	<div class="entry-content full-content">
		<p>In my last post i talked about an ImagesLoader that holds a map of the bitmapdata copied from any images loaded into an offscreen buffer. Well, i thought that was well and good, but i started thinking about collision detection between two bitmaps. Take for instance the &#8220;load and chop&#8221; of a strip of sprite states. Since it does a check on the dimensions of the image loaded and just divides by the number of states (columns and rows) specified, each state has the same width and height.<br />
That&#8217;s fine if you&#8217;re running a collision detection based on movieclip bounds, but the state of a sprite can have a fair amount of empty (tranparent) pixels within the bounding rectangle detected from the movieclip it&#8217;s attached to (using mc.getBounds()). What if you want to run a collision of something hitting any opaque pixels in the sprite and not use the bounding box of the mc?</p>
<p>Well, i whipped up a quick little class that will do that.<a href="javascript:MM_openBrWindow('http://www.custardbelly.com/flash8/CollisionTest.html','coll_trial','resizable=no,width=170,height=150');"><br />
You can view it here</a><br />
 (just click and drag the little colbys).<br />
Sorry i couldn&#8217;t put it on the page, there seems to be a problem with loading images into a flashObject embedded in this page.</p>
<p>This is a pretty &#8220;lite&#8221; example since it&#8217;s only checking three objects during onMouseMove, but you can see how it works, and in theory you wouldn&#8217;t run this detection process unless sprites were in a certain area of each other.</p>
<p>After i clean up my code and make a better example i&#8217;ll throw the source up here, but i&#8217;ll show you some things it&#8217;s doing.</p>
<p>Before it goes into the process of checking pixel transparencies between two sprites, it runs the age old<br />
[as]<br />
if(	ay2 < by1 ||<br />
	ay1 > by2 ||<br />
	ax2 < bx1 ||<br />
	ax1 > bx2)<br />
{<br />
	return false;<br />
}<br />
[/as]</p>
<p>operation (where ay1 is mc1._y, ay2 is mc1._height, and the b&#8217;s are the same but with other movieclip). If that returns, the two sprites being checked don&#8217;t overlap, so we don&#8217;t even bother going on to check if it&#8217;s only transparent pixels that are overlapping.</p>
<p>If that doesn&#8217;t return, it goes on to determine the rectangle of intersection, from which it derives what pixels to check in each bitmapdata instance.<br />
It runs the alpha check with this operation:<br />
[as]<br />
var aVal:Number = ((bmpData.getPixel32(x, y) >> 24) &#038; 0xFF);<br />
[/as]</p>
<p>If that shows up as 0, it&#8217;s transparent. I stink at techinical explanations, so if you want to learn about this visit this article by Grant Skinner &#8211; <a href="http://www.macromedia.com/devnet/flash/articles/bitwise_operators.html">Using Bitwise Operators to Manipulate Bits and Colors</a>, but it&#8217;s basically checking for any similar bits between the alpha channel of the pixel and 0xFF.</p>
<p>I&#8217;d also like to point out Grant Skinner&#8217;s great example of <a href="http://www.gskinner.com/blog/archives/2005/10/source_code_sha.html">Shape-Based Collision Detection</a>, if you haven&#8217;t already seen it. </p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flash8/" title="View all posts in Flash8" rel="category tag">Flash8</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2005/11/09/pixel-perfect-collision-detection-in-flash8/#comments" rev="post-28"  title="Comment on Pixel Collision Detection in Flash8">1 comment</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-11-09T16:28">November 9, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-28-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-27" class="post-27 post hentry category-flash category-flash8 full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/11/07/an-imagesloader-in-flash8/" title="Permanent link to An ImagesLoader in Flash8" rel="bookmark" rev="post-27">An ImagesLoader in Flash8</a></h1>
	
	<div class="entry-content full-content">
		<p>find the files <a href="http://www.custardbelly.com/downloads/ImagesLoader.zip">here</a>.</p>
<p>Since Flash8 came out, i&#8217;ve moved away from the old multi-keyframed movieclip used for sprites in my games. I&#8217;ve been playing around with loading images into a movieclip, copying the pixels into a BitmapData instance, then discarding the mc and passing that data onto whoever wants it. After trying a couple different ways on how to manage this process, i was thumbing through <a href="http://www.oreilly.com/catalog/killergame/">Killer Game Programming</a> by Andrew Davison and thought his ImagesLoader class (written in java) was pretty damn cool and decided i wanted a Flash adaptation of it.</p>
<p>Seeing as Flash doesn&#8217;t have a BufferedImage, I drummed up a little implementation of buffering images offscreen and here it is.<br />
The prominant class file that the different buffers (Single, Strip, Multi) use is the ImageLoader &#8211; which does pretty much what i said in the first sentence.<br />
The different buffers know what to do with the bitmapdata passed from ImageLoader, but perhaps more importantly they have a queue system set up so that you can hit these Singletons with numerous filepaths to images and the loading of one won&#8217;t get overwritten by the loading of another.</p>
<p>The ImageLoader and buffers can be used seperately from the ImagesLoader, but the ImagesLoader class is there if you want a sort of buffered image manager. It holds basically an image map from which another class can grab the bitmap data of anything loaded. As well, taking a cue from <a href="http://fivedots.coe.psu.ac.th/~ad/">Andrew Davison&#8217;s</a> ImageLoader.java, ImagesLoader can read a text file that lists all the images you want loaded and buffered in your app, choosing buffers dependant on a preceding signifier (single, strip, group, number).<br />
I find it helpful and it probably could use some optimization, but hopefully you can get something out of it&#8230; And please don&#8217;t forget to call ImagesLoader.dispose() when you&#8217;re done with it.</p>
<p>In the <a href="http://www.custardbelly.com/downloads/ImagesLoader.zip">zip</a> are the files, a sample FLA, some images and an image.txt file. I realized that some of the images don&#8217;t really illustrate the point because they&#8217;re simple and you&#8217;d probably use the drawing API instead, but you get the idea of how the ImagesLoader works.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flash8/" title="View all posts in Flash8" rel="category tag">Flash8</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2005/11/07/an-imagesloader-in-flash8/#comments" rev="post-27"  title="Comment on An ImagesLoader in Flash8">2 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-11-07T22:52">November 7, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-27-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-26" class="post-26 post hentry category-flash full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/11/06/keith-peters-actionscript-animation/" title="Permanent link to Keith Peters&#8217; Actionscript Animation" rel="bookmark" rev="post-26">Keith Peters&#8217; Actionscript Animation</a></h1>
	
	<div class="entry-content full-content">
		<p>My <a href="http://www.amazon.com/exec/obidos/ASIN/1590595181/ref%3Dnosim/friendofed-20/002-6945995-2040025">copy</a> arrived on Friday <a href="http://www.ericd.net/2005/11/foe-actionscript-animation-making.inc">as well </a>. I wanted to skip straight to the 3d and particle chapters, pour a big cup of coffee, shove my chair into the worn holes in my floor and start coding&#8230; however, i had to pack it on the top of my bag and head out the door as i was going to be away from my computer for the weekend.<br />
To deter myself from staring blankly at people talking while i thought about 3d in flash, i decided to read from the beginning and have a nice refresher during my travels &#8211; and i&#8217;m glad i did.<br />
<a href="http://www.amazon.com/exec/obidos/ASIN/1590595181/ref%3Dnosim/friendofed-20/002-6945995-2040025">Making Things Move</a> is written in a manner that is not only understandable and welcoming, but provides formulas that are well defined &#8211; explaining both the concepts of why they work and how they apply to Flash.<br />
Now, after accepting i wasn&#8217;t going to talk to anyone on the train home, I read a little into the 3d chapter and am excited to be back and have it open on my desk.</p>
<p>To sum it up&#8230; go pick up this book.</p>
<p>To draw it out&#8230; go pick up this book now. The formula summary for each chapter and the Tips and Tricks Section is enough to make this an essential reference book for Flash Animation, but the explanations of the concepts behind them in each chapter make this an essential book to have in my library.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-11-06T23:31">November 6, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-26-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-24" class="post-24 post hentry category-as3 category-flash full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/10/20/as3-follow-up/" title="Permanent link to AS3 follow up" rel="bookmark" rev="post-24">AS3 follow up</a></h1>
	
	<div class="entry-content full-content">
		<p>After studying over some great AS3 examples by <a href="http://www.helpqlodhelp.com/blog/archives/000127.html">Ralf Bokelberg</a> and <a href="http://kelvinluck.com/article/first-actionscript-3-example">Kevin Luck </a>, and running through the <a href="http://livedocs.macromedia.com/labs/1/flex/langref/index.html ">AS3 documentation</a></p>
<p>i eventually drummed up an AS3 representation of <a href="http://custardbelly.com/blog/?p=19">my first Flash8 BitmapData experiment</a>. Whether or not it&#8217;s the best solution ( or necessarily a good one ), i thought i&#8217;d throw up the source here for any one to comment or question.<br />
it&#8217;s very simple and probably could use some refactoring.<br />
Basically, what i was contemplating about the removal of attachBitmap and the subsequent use of copyPixels method is resolved in this example by using copyPixels on a source bitmap and storing those in a states array. I then pass along those states, and dependent on the user interaction, employ drawRect on the graphic layer.</p>
<p>one thing i noticed &#8211; pressing anywhere in the embedded movie to enable keyboard events (as it is in previous flash players), did not draw that focus in 8.5 &#8211; at least i think. To get around it i had to create a sprite the size of the stage and listen for a MOUSE_DOWN event to set the focus again. If anyone&#8217;s got some thought on this, please leave a comment.  </p>
<p>you can find the source <a href="http://www.custardbelly.com/examples/BitmapSample.htm">here</a>.</p>
<p>i&#8217;d also like to point out another great collection of AS3 resources made possible by franto: </p>
<p><a href="http://www.franto.com/blog2/collected-links-to-actionscript-30-examples">http://www.franto.com/blog2/collected-links-to-actionscript-30-examples</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2005/10/20/as3-follow-up/#comments" rev="post-24"  title="Comment on AS3 follow up">2 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-10-20T22:00">October 20, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-24-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-23" class="post-23 post hentry category-as3 category-flash full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/10/18/the-new-new-bitmapdata/" title="Permanent link to the New New BitmapData" rel="bookmark" rev="post-23">the New New BitmapData</a></h1>
	
	<div class="entry-content full-content">
		<p>In <a href="http://livedocs.macromedia.com/labs/1/flex/langref/migration.html">AS3</a>, the MovieClip method attachBitmap is removed. what does that mean for setPixel, getPixel and copyPixel?<br />
The documentation roughly states that addChild is the equivalent of attachBitmap&#8230; but only display objects can be &#8220;attached&#8221; using addChild.<br />
Running addChild(myBitmapData) within a MovieClip or Sprite class throws an error, because it appears that BitmapData is not considered a DisplayObject.</p>
<p>With the previous experiments presentated on this blog, i used the BitmapData.copyPixel method to render states of a sprite. But that was only made possible by loading an image, using BitmapData.draw, (unloading the image), and then passing that BitmapData to a movieclip, attaching a new BitmapData object and copying pixels dependant on user interaction.</p>
<p>There has to be a way to represent this in AS3&#8230; but for my first day of trying, i&#8217;ve come up empty.</p>
<p>With all the flash 8 experiments out there, has anyone else come across this, and come up with a solution?</p>
<p><em>As a side note:</em><br />
I am a huge fan of the new Loader class. Here&#8217;s a small sample:<br />
[as]<br />
import flash.net.URLRequest;<br />
import flash.display.Loader;<br />
import flash.util.trace;<br />
import flash.events.*;</p>
<p>class LoaderTest extends Sprite<br />
{<br />
	private var __loader:Loader;<br />
	private static var IMAGE_URL:String = &#8220;myimage.png&#8221;;</p>
<p>	public function LoaderTest()<br />
	{<br />
		__loader = new Loader();<br />
		__loader.addEventListener(EventType.COMPLETE, onLoadComplete);<br />
		var request:URLRequest = new URLRequest(IMAGE_URL);</p>
<p>		__loader.load(request);<br />
	}</p>
<p>	private function onLoadComplete(evt:Event)<br />
	{<br />
		trace(&#8221;load that sucker &#8221; + evt);<br />
	}<br />
}<br />
[/as]</p>
<p>&#8230;. no more loadMovie / onEnterFrame, or MovieClipLoader (which for some reason seems to crash Flash8 for me).</p>
<p>i guess i should get off the double-underscore train too&#8230; i don&#8217;t know &#8230; my head&#8217;s about to burst.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2005/10/18/the-new-new-bitmapdata/#comments" rev="post-23"  title="Comment on the New New BitmapData">5 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-10-18T22:20">October 18, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-23-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-22" class="post-22 post hentry category-music full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/09/26/no-direction-home/" title="Permanent link to No Direction Home." rel="bookmark" rev="post-22">No Direction Home.</a></h1>
	
	<div class="entry-content full-content">
		<p>My mom had some LP&#8217;s lying around, played them in the living room while cooking dinner. My best friend Tim Costello wouldn&#8217;t let me in a word edge-wise when he started talking about <em><strong>Blonde on Blonde</strong> </em>at the age of 15. I wore out every cassette i had of his in my son-appropriated, mom&#8217;s old &#8216;87 grand-am that ran like squirrels were kicking the fan-belt. I&#8217;m a huge fan. Books upon records upon memories upon making me believe i know who i am.<br />
Backed by Martin Scorsese (director of <em>The Last Waltz</em> starring the Band &#8211; another huge influence on me -), the first part of the two-part series <a href="http://www.pbs.org/previews/american_masters_dylan/">No Direction Home</a> on PBS has just finished, which prompted me throwing on the LP&#8217;s i stole from my mom over scattered visits home.<br />
Still fresh. Still harrowing. Still hopeful. Still making me wish i didn&#8217;t talk about Bob Dylan like some cliche&#8217;d Bob Dylan fan&#8230; ah, well.</p>
<p>Now if we can only get some coverage of <a href="http://www.jimcroce.com/discography.html">Jim Croce</a>&#8230;</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/music/" title="View all posts in Music" rel="category tag">Music</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-09-26T23:46">September 26, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-22-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-21" class="post-21 post hentry category-flash category-flash8 full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/09/21/im-not-gonna-keep-putting-the-name-of-the-day-on-the-end/" title="Permanent link to i&#8217;m not gonna keep putting the name of the day on the end&#8230;" rel="bookmark" rev="post-21">i&#8217;m not gonna keep putting the name of the day on the end&#8230;</a></h1>
	
	<div class="entry-content full-content">
		<p><img src="http://custardbelly.com/blog/images/bitmap_trial3.gif"/></p>
<p><em>Following up on my past two posts.</em></p>
<p>The prior two experiments were done using a png with a transparent background. i made it, so i know what i wanted&#8230; but what if the spritesheet you&#8217;re using isn&#8217;t in a format without an alpha channel?<br />
I ran a test using a png with a background color to see if i can strip out a specified color and still get the rendered staes i want.<br />
Yes i can- by using the threshold method of the BitmapData class.</p>
<p>the picture above is a screenshot of my test movie that shows the image loaded in the upper-left corner.</p>
<p><strong>To recap</strong>: i load an image into a mc, create a BitmapData instance and BitmapData.draw(mc) to capture the bitmap. Then i (aside from here) delete the mc, pass the BitmapData instance onto a &#8220;dissector&#8221; and render each state dependant on user action.<br />
In order to remove the offending color (in this case all pixels with a value of 0&#215;00333333), run the following before passing the BitmapData instance on:</p>
<p>[as]// &#8212; where<br />
//              __bmp is my BitmapData instance,<br />
//              __threshold = 0&#215;00333333,<br />
//              w and h are the dimesions of the loaded image<br />
// &#8211;<br />
private function applyThreshold(w:Number, h:height)<br />
{<br />
	__bmp.threshold(__bmp, new Rectangle(0, 0, w, h), new Point(0, 0), &#8220;==&#8221;, __threshold, 0xffff00, 0xffffff, false);<br />
}[/as]</p>
<p>I kept the dropShadow in there to see if it still applied afterward, and lo and behold! excellent.<br />
One thought&#8230; for some reason when i set the color and mask arguments both to white, it didn&#8217;t mask- don&#8217;t know why, but i didn&#8217;t investigate too hard.<br />
Two thought&#8230; if my states held that same offending color (say in the eyes), it will remove it &#8211; i&#8217;ll have to work on that.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flash8/" title="View all posts in Flash8" rel="category tag">Flash8</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2005/09/21/im-not-gonna-keep-putting-the-name-of-the-day-on-the-end/#comments" rev="post-21"  title="Comment on i&#8217;m not gonna keep putting the name of the day on the end&#8230;">2 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-09-21T23:44">September 21, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-21-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-20" class="post-20 post hentry category-flash category-flash8 full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/09/18/bitmapdata-sunday/" title="Permanent link to BitmapData sunday" rel="bookmark" rev="post-20">BitmapData sunday</a></h1>
	
	<div class="entry-content full-content">
		<p><a href="javascript:MM_openBrWindow('insets/index.html','bitmaptrial','resizable=no,width=220,height=120');">click me</a></p>
<p>i implemented the walk-cycle into my experiment blogged about yesterday &#8211; also threw in a little dropShadowFilter just for fun:)<br />
i don&#8217;t know how i feel about it performance wise just yet. Looks to perform alright, but BitmapData.copyPixel every nth frame might take a pretty good hit&#8230; especially when i throw some enemies in there&#8230;</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flash8/" title="View all posts in Flash8" rel="category tag">Flash8</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-09-18T23:02">September 18, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-20-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-19" class="post-19 post hentry category-flash category-flash8 full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/09/17/bitmapdata-saturday/" title="Permanent link to BitmapData saturday" rel="bookmark" rev="post-19">BitmapData saturday</a></h1>
	
	<div class="entry-content full-content">
		<p><kml_flashembed movie="images/BitmapTrial.swf"  height="100"  width="200" ></kml_flashembed></p>
<p>Since i finally got a whole day to fool around, i decided to start learning about the new BitmapData class in flash8.<br />
I&#8217;ve only just begun, and i&#8217;m not really sure if what i worked on today is of any benefit in the end, but i like it.<br />
I set out to eliminate having to create a ton of sprite movieclips in the library for games, and instead store the data from an external spritesheet and just have movieclips change their bitmap data when states change.<br />
After i banged my desk and racked my brain for an hour to find out why i couldn&#8217;t load a bitmap, i decided to actually read the help files instead of going on what i thought should happen <img src='http://darko.liquidweb.com/~custardb/blog/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley' /><br />
Turns out attachBitmap is not like loadMovie, but more like attachMovie (i know it makes sense, but it was early) &#8211; you can only attach a bitmap if it&#8217;s in the library. So i created a class that would load the image, creates a new BitmapData object and draws to it from the loaded movieclip. then it removes that movieclip, passes the new bitmap object onto a character movieclip which has coordinates of how to &#8220;cut-up&#8221; the bitmap.<br />
So, basically when states change (like if the user presses SPACE for jump) those coordinates are fed the BitmapData&#8217;s copyPixel function.<br />
I just tried it with the &#8220;still&#8221; and &#8220;jump&#8221; states, and it seems to be working pretty well. it will be interesting to see what comes of trying to incorporate a walk-cycle into it. </p>
<p>Whether or not this is the best thing to do for a game, i&#8217;m not quite sure&#8230; Whether it takes less time than making movieclips, i don&#8217;t know&#8230; but it&#8217;s another possibility.</p>
<p>As a side note, the png this swf loads was created by using <a href="http://www.5etdemi.com/blog/archives/2005/03/pixel-tools-v2-available/">Patrick Mineault&#8217;s pixel tools</a> (glad they still work in 8!) in the Flash IDE then exported.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flash8/" title="View all posts in Flash8" rel="category tag">Flash8</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-09-17T19:15">September 17, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-19-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-18" class="post-18 post hentry category-flash category-flash8 full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/09/16/non-existant-8ball-hopefuls-but-i-aint-complaining/" title="Permanent link to non-existant 8ball hopefuls&#8230; but i ain&#8217;t complaining!" rel="bookmark" rev="post-18">non-existant 8ball hopefuls&#8230; but i ain&#8217;t complaining!</a></h1>
	
	<div class="entry-content full-content">
		<p>first off, let me say that i am in no way unhappy with flash8. i&#8217;m posting this in the hopes that someone can give me more explanation as to why these are problematic, or &#8211; hopefully &#8211; supply a work around.</p>
<p>two things i would have liked to see some change in:<br />
1. Player 8 performance in a browser.<br />
2. Replacing symbols between documents through copy-paste in the IDE.</p>
<p>1. running a simple in-no-way-indepth test of the dropping frame rate of the new player in a browser using just a file with only the <a href="http://www.j3r.com/?page=jfps">JFPS component</a> on the stage, it pretty much adhered to the same study <a href="http://www.emllabs.com/article.php?articleId=105">emllabs</a> ran in july of last year on player7.<br />
i still have to develop games with 33 fps, and publish with 50fps to be viewed at *around* 33fps when in a browser.</p>
<p>2. if anyone has copy-and-pasted a symbol from one document&#8217;s library to another or is running a JSFL script to do such to a batch of files, they may have come across the old alert &#8220;One or more library items already exist in the document&#8221; presenting a critical ( not really&#8230; you can *most times* undo ) decision to replace the existing item(s).<br />
I really wish that presented a check list of library items that have conflicting symbol names ( replace these symbols, but not those &#8211; or cancel and change ). sure you can run a command that can present a list of symbol names that are the same between documents ( change a name here or drop in a different folder there ), but what if you&#8217;re running through numerous documents that are not structured the same ( or at all ) and you might want to replace Bimap53.png in one document, but not in another where you want to replace the symbol &#8220;generic_mc&#8221; AND NOT Bitmap53.png&#8230; if you&#8217;ve pressed &#8220;replace&#8221; &#8211; or worse pressed &#8220;replace&#8221; for a couple of documents out of many run through a JSFL script that opens>pastes>saves>publishes>closes> &#8211;  in confidence and realized when you view the movie that nothing works anymore&#8230; you know what i mean.</p>
<p>that said, these perform the same as before&#8230; nothing new here&#8230; and there are a lot of new things that need to be explored with Flash8!</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>,  <a href="http://custardbelly.com/blog/category/flash8/" title="View all posts in Flash8" rel="category tag">Flash8</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2005/09/16/non-existant-8ball-hopefuls-but-i-aint-complaining/#comments" rev="post-18"  title="Comment on non-existant 8ball hopefuls&#8230; but i ain&#8217;t complaining!">2 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-09-16T00:14">September 16, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-18-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-17" class="post-17 post hentry category-music full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/09/15/whatd-you-say/" title="Permanent link to what&#8217;d you say?" rel="bookmark" rev="post-17">what&#8217;d you say?</a></h1>
	
	<div class="entry-content full-content">
		<p>just got back from <a href="http://themakersband.com/">the Makers</a> show at great scott. holy smokes.<br />
first off, the <a href="http://greatscottboston.com/">great scott</a> is an excellent place. second off, the second opening band <a href="http://www.punknews.org/article.php?sid=13329&#038;mode=nested&#038;order=0">Rock n&#8217; Roll Soldiers</a> were pretty damn good.</p>
<p>that said, the night started off with my girlfriend making fun of me because i said hello ( according to her ) like some star-struck groupie to Donny ( Virgo ) Maker and made small talk.<br />
later i got to meet more of the band when i introduced myself and they asked me where a guitar player for the Makers would likely disappear to while in Allston, massachusetts &#8230; because he had gone missing and was still a no-show ten minutes before they went on. i wished them the best in finding him ( like a star-struck groupie ) and told them there were a few bars ( where the &#8216;ladies&#8217; go )  down the road.<br />
a little bit later, he (Jamie the guitarist ) showed up and they went on.</p>
<p>they played like they were in front of a crowd of a hundred and didn&#8217;t need any of us, but wanted us. there was about a good twenty of us there&#8230;<br />
now that&#8217;s rock.</p>
<p>The stage presence Mike Maker has is inexplicable, and seen when they play in the northwest is amazing. when seen over on the other side where they are largely unknown, it is astounding. he commands the stage, letting not even the rats look away.<br />
i hope the rest of the tour goes well, and i hope to see them back here soon.</p>
<p>if you are interested in learning more about the Makers, visit your local library &#8230; and for ( in my opinion ) a good introductary album <a href="http://www.subpop.com/bands/makers/oldsite/bio.html">&#8216;Rock Star God&#8217;</a>.<br />
don&#8217;t stop there.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/music/" title="View all posts in Music" rel="category tag">Music</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-09-15T01:43">September 15, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-17-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-15" class="post-15 post hentry category-general full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/09/08/oh-stop-it-you-shouldnt-have/" title="Permanent link to oh stop it&#8230; you shouldn&#8217;t have" rel="bookmark" rev="post-15">oh stop it&#8230; you shouldn&#8217;t have</a></h1>
	
	<div class="entry-content full-content">
		<p>what can i say. the online gaming automated spam commenter loves my site! really, i thought my blog was mediocre at best, but the ego boost from a faceless internet nomad has brightened my day. i&#8217;ve seen it on other blogs and they just tell me to play, Play, PLAY; but my web-oriented flier-under-the-wiper &#8220;readers&#8221; &#8230; they like me&#8230; the really like me!<br />
finally something gets me. Thank you Gioco Texas holdem (can i call you GTH&#8217;em?), you&#8217;re very flattering- glad you like the blog! and really, &#8216;Texas hold&#8217;em en ligne&#8217;&#8230; i try my best, but thank you!<br />
i might keep the comments up for another day or two, just until my strut starts hurting my knee.</p>
<p>[Edit 9-16-05(i have removed the wonderful comments... the rain today aggrevated the old leg-bender)]</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/general/" title="View all posts in General" rel="category tag">General</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/administrator/" title="View all posts by Administrator">Administrator</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-09-08T23:04">September 8, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-15-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-11" class="post-11 post hentry category-flash full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/08/12/flash8/" title="Permanent link to flash8" rel="bookmark" rev="post-11">flash8</a></h1>
	
	<div class="entry-content full-content">
		<p>In what little spare time i have, i upset my girlfriend by drooling over my keyboard- feverishly trying to build Flash versions of a some of my favorite arcade classics. (emphasis on trying, there).</p>
<p>Three big posts (among the many great ones) and a site that have me just itching to get my hands on Flash 8:</p>
<p> &#8211; gSkinner on <a href="http://www.gskinner.com/blog/archives/2005/08/flash_8_shape_b.html">Flash 8: Shape Based Collision Detection</a></p>
<p> &#8211; Darron Schall on <a href=" http://www.darronschall.com/weblog/archives/000177.cfm">Maximizing BitmapData.setPixel performance</a></p>
<p>- André Michelle on<a href="http://blog.andre-michelle.com/2005/sphere-texturemapping-via-displacementmapfilter/">  Sphere Texturemapping via DisplacementMapFilter</a></p>
<p> &#8211; André Michelle&#8217;s <a href="http://8ball.andre-michelle.com/lab/">8ball lab</a> </p>
<p>&#8230; and just for my future reference, although i&#8217;m pretty sure this is burned into my brain already- <a href="http://www.franto.com/blog2/collected-8ball-betatesters-examples">Franto&#8217;s list</a> </p>
<p>This new Bitmap API just sets my mind reeling&#8230; as i&#8217;ve confessed to many, my head is about to explode from wanting to dive into the possibilities. And gSkinner&#8217;s blog about shape collision detection&#8230; wow. </p>
<p>i can&#8217;t wait.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2005/08/12/flash8/#comments" rev="post-11"  title="Comment on flash8">1 comment</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-08-12T15:36">August 12, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-11-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-10" class="post-10 post hentry category-flash full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/08/03/jesterxls-command-and-conroller-arp-templates/" title="Permanent link to JesterXL&#8217;s Command and Controller ARP Templates" rel="bookmark" rev="post-10">JesterXL&#8217;s Command and Controller ARP Templates</a></h1>
	
	<div class="entry-content full-content">
		<p><a href="http://www.jessewarden.com/archives/2005/08/arp_labs_upload.html">JesterXL has posted about his modification</a> to the <a href="http://osflash.org/doku.php?id=arp">ARP framework</a> involving the CommandTemplate and the ControllerTemplate allowing arguments to be passed using a runCommand function instead of the dispatchEvent, and i couldn&#8217;t be happier.<br />
I use the ARP framework at work and have often wanted to pass arguments along to commands, mainly because i would want to run the same command from different instances but sometimes alert the user of success or fail and other times not- don&#8217;t ask me why- but, also so i didn&#8217;t have to keep creating public vars and functions in the main class to grab something i didn&#8217;t think needed to be held by it.<br />
I had started trying to work on putting this together, but work got back up and projects needed to be escorted out the door&#8230; so&#8230; thanks Jesse!</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2005/08/03/jesterxls-command-and-conroller-arp-templates/#comments" rev="post-10"  title="Comment on JesterXL&#8217;s Command and Controller ARP Templates">1 comment</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-08-03T10:08">August 3, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-10-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-9" class="post-9 post hentry category-flash full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/07/28/sepy-and-mtasc/" title="Permanent link to SE|PY and MTASC" rel="bookmark" rev="post-9">SE|PY and MTASC</a></h1>
	
	<div class="entry-content full-content">
		<p>&#8230; an edition to the last post.<br />
and more great news courtesy of <a href="http://www.ericd.net/2005_07_24_blogger_archive.inc#112259460128463720">ericd</a>!<br />
&#8211; insert anagram here &#8211;</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-07-28T23:45">July 28, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-9-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-8" class="post-8 post hentry category-flash full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/07/28/writeln-and-keith-peters-debugger/" title="Permanent link to writeln and Keith Peters&#8217; debugger" rel="bookmark" rev="post-8">writeln and Keith Peters&#8217; debugger</a></h1>
	
	<div class="entry-content full-content">
		<p>I use a little function called writeln in all my classes to keep track of where my traces are coming from. i started doing it to keep myself from going crazy when seeing random text come up in the output panel and not knowing where or how it got there- not to mention running through an app and then have that panel open up out of nowhere to tell me something that i have no idea what it means.<br />
Recently i have been loving this new debugger <a href="http://www.bit-101.com/blog/archives/000170.html">Keith Peters&#8217; unleashed</a>, and coupling my writeln with it has put a smile on my face.<br />
i have extended the arguments in my writeln and now i can trace (recusively no less, thanks keith) with a specified level of importance and color coding!</p>
<p>Basically, what once was this:</p>
<p>[as]function writeln(str):Void<br />
{<br />
	trace(&#8221;#com.site.MyClass#\n     &#8211; &#8221; + str);<br />
}[/as]</p>
<p>..has become this:</p>
<p>[as]function writeln(str, line:Number, type:String, clear:Boolean, levels:Number):Void<br />
{<br />
	if(clear)<br />
	{<br />
		Debug.clear();<br />
	};</p>
<p>	type = (type == undefined) ? &#8220;DEBUG&#8221; : type;</p>
<p>	if(arguments.length < 5)<br />
	{<br />
		Debug.trace("\n#com.site.MyClass#\n     " +  line + "- " + str, Debug[type]);<br />
	}<br />
	else<br />
	{<br />
		Debug.trace("\n#com.siteMyClass#\n     " +  line + "- " + str);<br />
		Debug.traceObject(str, levels, Debug[type]);<br />
	};<br />
} [/as]</p>
<p>..with this somewhere in the class file:</p>
<p>[as]<br />
writeln("i'm debugging!", 20);<br />
[/as]</p>
<p>or</p>
<p>[as]<br />
writeln(someObject, 20, "INFO", false, 1);<br />
[/as]</p>
<p>and with the FlashDedugPanel open i gets all i needs.</p>
<p>i'd like to do something with that if(clear), i just don't like it... but for now i'm very happy.</p>
<p>thanks again <a href="http://bit-101.com">Keith and <a href="http://www.timwalling.com/">Tim</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-07-28T21:22">July 28, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-8-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-7" class="post-7 post hentry category-flash full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/07/13/its-quite-possible-i-dont-know-what-im-doing/" title="Permanent link to it&#8217;s quite possible i don&#8217;t know what i&#8217;m doing" rel="bookmark" rev="post-7">it&#8217;s quite possible i don&#8217;t know what i&#8217;m doing</a></h1>
	
	<div class="entry-content full-content">
		<p>i have been testing out my old stuff with the <a href="http://www.macromedia.com/software/flashplayer/public_beta/">player 8 beta</a>. i thought i&#8217;d dig around for some poorly coded fractal trials i was heavily into back in the winter when i was addicted to <a href="http://astronomy.swin.edu.au/~pbourke/fractals/">paul bourke&#8217;s</a> work.</p>
<p>these were swfs i made that mostly give me that alert of how my movie is running slow and whether or not i would like to stop running it.</p>
<p>eventually i cleaned them up enough so that it hangs roughly right before i get that alert, but still i would have to wait @ 10 seconds before anything happened.</p>
<p>i was very pleased when i pushed them through 8 and cut my time in more than half&#8230; until i got to my mandelbrot swf- it wouldn&#8217;t even start iterating.<br />
so i poked around, set intervals, tried to fill in textboxes with the current iteration- still nothing.</p>
<p>then i went down to the line that started it all&#8230;</p>
<p><strong>onLoad = startMandelbrot;<br />
//where startManelbrot is a function that does the iteration</strong></p>
<p>don&#8217;t ask me why i used an onLoad for the timeline, i think i picked it from somewhere.<br />
with this using player 7, what it did was allow the swf to appear in the browser before it did any work. taking this out and replacing it with just<strong> startMandelbrot();</strong> would leave the browser comletely empty until it ran through the iteration.<br />
with player 8, however, <strong>onLoad </strong>was never triggered. </p>
<p>now, it could be the case that i never should have done that in the first place ( i certainly haven&#8217;t done something like that in a while ), but i wonder why it worked using player 7 and not using player 8.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-07-13T10:40">July 13, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-7-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-6" class="post-6 post hentry category-flash full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/06/28/6/" title="Permanent link to Creating a Dynamic Playlist for Progressive Flash Video" rel="bookmark" rev="post-6">Creating a Dynamic Playlist for Progressive Flash Video</a></h1>
	
	<div class="entry-content full-content">
		<p><strong>Lisa Larsen</strong> has written another excellent article revolving around FLVs and FlashComm, this time entitled <em>&#8220;Creating a Dynamic Playlist for Progressive Flash Video&#8221;</em> about creating&#8230; well, look at the title.<br />
technically, because she is not being offered any money from my family to be my friend, i am hoping that being associated with her in turn makes me look smart ( not like my so called &#8220;friend&#8221;, Punchy)<br />
check out the article <a href="http://www.macromedia.com/devnet/mx/flash/articles/prog_download.html">here</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-06-28T15:21">June 28, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-6-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-5" class="post-5 post hentry category-flash full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/06/28/return-class-type-function/" title="Permanent link to return class; = [type Function] ?" rel="bookmark" rev="post-5">return class; = [type Function] ?</a></h1>
	
	<div class="entry-content full-content">
		<p>[Edit: sorry about all the italics and bolds. i really need to get some sort of style sheet for actionscript code]<br />
[Edit 2: and i got one. have to do some color changes. <a href="http://blog.igeek.info/index.php">IG: Syntax Hiliter</a>]<br />
i found something i don&#8217;t quite understand today (not that much of a shock) when trying to make a <em>CharacterManager</em> class to control the registration and reference of classes extending a <em>Character</em> class. In short, when i make a new character that a user can use, i just want to create a new class that extends the <em>Character</em> class, go into my main class register it and drop the new character movieclip into the library, brush off my hands give a little grunt and call it a day.<br />
Now i found this odd, but technically i know very little, so i was hoping someone out there might be able to explain it to me.<br />
The way i want this to work is when i register a new character, i say something like this:</p>
<p>	__characterManager.registerCharacterClass(MyNewCharacterClass, &#8220;class name&#8221;);</p>
<p>- where <strong>__characterManager</strong> is the singleton</p>
<p>&#8230;.(in <em>Character Manager</em>)<br />
[as]<br />
	public function registerCharacterClass(classToAdd, classNameStr)<br />
	{<br />
		__classList[ classNameStr ] = classToAdd;<br />
	}<br />
[/as]</p>
<p>- and then when i want to retrive that class when i create a new character i say:</p>
<p>(1)<br />
[as]<br />
     Application.addCharacter(&#8221;class name&#8221;, &#8220;symbol linkage id&#8221;, &#8220;instance name&#8221;);<br />
[/as]<br />
(2)<br />
[as]<br />
     function addCharacter(classNameStr, clipID, name)<br />
      {</p>
<p>          var characterClass:Character =  </p>
<p>                                  characterManager.getCharacterClassByName(classNameStr);</p>
<p>          var character:Character = characterClass.create(clipID, name);<br />
      }<br />
[/as]<br />
- what i had in the <em>CharacterManager</em> class before i found the reason why i&#8217;m asking this question is this:<br />
[as]<br />
	public function getCharacterClassByName(classNameStr):Character<br />
	{<br />
		return __classList[ classNameStr ];<br />
	}<br />
[/as]</p>
<p>- but that always returned the [type Function]- never a reference to the class i was trying to get.<br />
So i peeked into the <em>CommandTemplate</em> class within <a href="http://ariaware.com/products/arp/">the ariaware package</a>, and noticed how they did it.<br />
Using this:  </p>
<p>	<strong>return new __classList[ classNameStr]();</strong></p>
<p>Now this makes sense to me, since when you create an instance of a class you use new most of the time. But i guess i&#8217;m wondering why it would return [type Function] before, and not even [object Object], or something else. and if this is always true, can i not create a Singleton from here, or should i make a <em>CharacterSingletonManager</em> class and <strong>return __classList[ classNameStr].getInstance();</strong> ?<br />
The answer is probably simple and can be summed up in one line, and here i write a novel out of a question.. but oh well.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>.</p>
	
	<p class="comments-link"><a href="http://custardbelly.com/blog/2005/06/28/return-class-type-function/#comments" rev="post-5"  title="Comment on return class; = [type Function] ?">2 comments</a></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-06-28T14:19">June 28, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-5-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-4" class="post-4 post hentry category-flash full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/06/27/game-hero-example/" title="Permanent link to Game:: Hero example" rel="bookmark" rev="post-4">Game:: Hero example</a></h1>
	
	<div class="entry-content full-content">
		<p>i had a life story written of how i started out trying to make games in flash, but i was getting blah blah, so &#8211; in short &#8211; much credit to<a href="http://www.tonypa.pri.ee/tbw/index.html"> tonypa</a>, <a href="http://oos.moxiecode.com/">out of society</a> and <a href="http://bit-101.com">Keith Peters</a> for getting my feet wet. online there was very little resources for creating games based on OOP (though <a href="http://video-animation.com/mx2k_00.shtml">steve</a> has some excellent tutorials) so i tried to marry my practices used at work with that of what was available on the internet *mostly in AS1.<br />
plus my mind wonders pretty frequently, so to follow a whole tutorial is hard. i tend to get through about 1/5 of it, stop looking at it, (maybe throw on <a href="http://www.cheaptrick.com/ctalbum3.html">Heaven Tonight</a> or <a href="http://www.deadmoonusa.com/dm_mtr390.htm">Trash&#038;Burn</a>), and start trying to incorporate what i learned with what i already know, and get frustrated that nothing is working the way i want (blah blah).<br />
while i was making another game, i started to realize i had gotten &#8220;smarter&#8221; (all thanks to Keith, <a href="http://blog.pixelconsumption.com">Sam</a> and <a href="http://colbygrenier.com">Colby</a>) and thought i throw something up here for anybody that is in the same boat i am &#8211; trying to make sense of making games in Flash using OOP principles instead of the timeline and symbol-based functions.</p>
<p>First up: the basic Hero. i only call it the Hero because it reacts to user controls like the keyboard, though i could be proven wrong. </p>
<p>download it <a href="http://darko.liquidweb.com/~custardb/downloads/hero_trial.zip">here</a> and have a look around.<br />
if any of you have a different approach or any questions, leave a comment. i am terrible at commenting my code so&#8230;<br />
and here is a short list of people and sites you should really check out:</p>
<p><a href="http://www.tonypa.pri.ee/tbw/index.html">tonypa</a><br />
<a href="http://void.andre-michelle.com/">andré michelle</a><br />
<a href="http://video-animation.com/mx2k_00.shtml">video-animation</a><br />
<a href="http://oos.moxiecode.com/">out of society</a><br />
<a href="http://bit-101.com">keith peters  </a><br />
<a href="http://www.gotoandplay.it/">gotoAndPlay()</a></p>
<p>maybe i&#8217;ll make a bigger list of resources some day.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/flash/" title="View all posts in Flash" rel="category tag">Flash</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-06-27T12:06">June 27, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-4-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div id="post-content-2" class="post-2 post hentry category-music full">
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2005/06/23/i-got-rocked/" title="Permanent link to i got rocked" rel="bookmark" rev="post-2">i got rocked</a></h1>
	
	<div class="entry-content full-content">
		<p>thank you <a href="http://www.sleater-kinney.com/index2.php">Sleater-Kinney</a>. thank you <a href="http://www.deadmeadow.com/">Dead Meadow</a>.<br />
officially the loudest concert i have been to- but the temporary hearing loss has afforded me the pleasure of muffling any trivial outside noise so i can clearly hear my head replaying all the songs.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/music/" title="View all posts in Music" rel="category tag">Music</a>.</p>
	
	<p class="comments-link"><span>Comments Off</span></p>

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">&ndash;</span> <abbr class="published" title="2005-06-23T13:38">June 23, 2005</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-2-target"></div>
	<div class="clear"></div>
	
	</div><!-- .post --><div class="rule"><hr /></div>
<div class="pagination">
	<span class="previous"></span>
	<span class="next"></span>
</div></div><!--#content-->

<hr class="lofi" />
<div id="sidebar">
	<div id="carrington-about" class="widget" style="text-align:right;">
		<a title="RSS 2.0 feed for posts" href="http://custardbelly.com/blog/feed/">
			<img src="http://www.custardbelly.com/blog/images/rss_48.png" />
		</a>
		<a title="LinkdIn" rel="alternate" href="http://www.linkedin.com/ppl/webprofile?vmi=&id=5020581&pvs=pp&authToken=KO77&authType=name&locale=en_US&trk=ppro_viewmore&lnk=vw_pprofile" target="_blank">
			<img src="http://www.custardbelly.com/blog/images/linkedin_48.png" />
		</a>
		<a title="Follow me on Github" rel="alternate" href="http://github.com/bustardcelly" target="_blank">
			<img src="http://www.custardbelly.com/blog/images/git.png" />
		</a>
		<a title="Follow me on G+" rel="alternate" href="https://plus.google.com/113716114429928674625" target="_blank">
			<img src="http://www.custardbelly.com/blog/images/g-plus-icon-48x48.png" />
		</a>
		<a title="Follow me on Twitter" rel="alternate" href="http://www.twitter.com/_toddanderson_" target="_blank">
			<img src="http://www.custardbelly.com/blog/images/twitter8.png" />
		</a>
		
	</div>
	<div id="carrington-about" class="widget">
		<div class="about">
			<h2 class="widget-title">About todd anderson</h2>
Todd Anderson is a Senior Software Engineer at Infrared5. With over a decade of architecting and developing client-side applications, he has delivered web, mobile and desktop solutions with numerous companies in the enternainment and gaming indistries including Adobe, THQ, Condé Nast Publications and Motorola. 
A strong believer in giving back to the wonderful technology communities [...]<a class="more" href="http://custardbelly.com/blog/about/">more &rarr;</a>		</div>
	</div><!--.widget-->
<div id="primary-sidebar">
		<div id="carrington-archives" class="widget">
			<h2 class="widget-title">Categories</h2>
			<ul>
					<li class="cat-item cat-item-12"><a href="http://custardbelly.com/blog/category/air/" title="View all posts filed under AIR">AIR</a>
</li>
	<li class="cat-item cat-item-41"><a href="http://custardbelly.com/blog/category/amd/" title="View all posts filed under AMD">AMD</a>
</li>
	<li class="cat-item cat-item-27"><a href="http://custardbelly.com/blog/category/android/" title="View all posts filed under Android">Android</a>
</li>
	<li class="cat-item cat-item-9"><a href="http://custardbelly.com/blog/category/apollo/" title="Apollo!">Apollo</a>
</li>
	<li class="cat-item cat-item-5"><a href="http://custardbelly.com/blog/category/as3/" title="View all posts filed under AS3">AS3</a>
</li>
	<li class="cat-item cat-item-24"><a href="http://custardbelly.com/blog/category/as3couchdb/" title="View all posts filed under as3couchdb">as3couchdb</a>
</li>
	<li class="cat-item cat-item-26"><a href="http://custardbelly.com/blog/category/as3flobile/" title="View all posts filed under as3flobile">as3flobile</a>
</li>
	<li class="cat-item cat-item-29"><a href="http://custardbelly.com/blog/category/as3flobile-android/" title="View all posts filed under as3flobile-android">as3flobile-android</a>
</li>
	<li class="cat-item cat-item-15"><a href="http://custardbelly.com/blog/category/astro/" title="View all posts filed under Astro">Astro</a>
</li>
	<li class="cat-item cat-item-8"><a href="http://custardbelly.com/blog/category/beer/" title="View all posts filed under Beer!">Beer!</a>
</li>
	<li class="cat-item cat-item-11"><a href="http://custardbelly.com/blog/category/books/" title="View all posts filed under Books">Books</a>
</li>
	<li class="cat-item cat-item-31"><a href="http://custardbelly.com/blog/category/burrito/" title="View all posts filed under Burrito">Burrito</a>
</li>
	<li class="cat-item cat-item-16"><a href="http://custardbelly.com/blog/category/conferences/" title="View all posts filed under Conferences">Conferences</a>
</li>
	<li class="cat-item cat-item-25"><a href="http://custardbelly.com/blog/category/couchdb/" title="View all posts filed under CouchDB">CouchDB</a>
</li>
	<li class="cat-item cat-item-38"><a href="http://custardbelly.com/blog/category/dojo/" title="View all posts filed under dojo">dojo</a>
</li>
	<li class="cat-item cat-item-2"><a href="http://custardbelly.com/blog/category/flash/" title="View all posts filed under Flash">Flash</a>
</li>
	<li class="cat-item cat-item-35"><a href="http://custardbelly.com/blog/category/flash-and-the-city/" title="View all posts filed under Flash and the City">Flash and the City</a>
</li>
	<li class="cat-item cat-item-19"><a href="http://custardbelly.com/blog/category/flash-on-tap/" title="View all posts filed under flash on tap">flash on tap</a>
</li>
	<li class="cat-item cat-item-4"><a href="http://custardbelly.com/blog/category/flash8/" title="View all posts filed under Flash8">Flash8</a>
</li>
	<li class="cat-item cat-item-10"><a href="http://custardbelly.com/blog/category/flex/" title="View all posts filed under Flex">Flex</a>
</li>
	<li class="cat-item cat-item-22"><a href="http://custardbelly.com/blog/category/flex-4/" title="View all posts filed under Flex 4">Flex 4</a>
</li>
	<li class="cat-item cat-item-32"><a href="http://custardbelly.com/blog/category/flex-4-5/" title="View all posts filed under Flex 4.5">Flex 4.5</a>
</li>
	<li class="cat-item cat-item-30"><a href="http://custardbelly.com/blog/category/flex-runtime-css/" title="View all posts filed under flex-runtime-css">flex-runtime-css</a>
</li>
	<li class="cat-item cat-item-17"><a href="http://custardbelly.com/blog/category/flextasks/" title="View all posts filed under FlexTasks">FlexTasks</a>
</li>
	<li class="cat-item cat-item-1"><a href="http://custardbelly.com/blog/category/general/" title="View all posts filed under General">General</a>
</li>
	<li class="cat-item cat-item-50"><a href="http://custardbelly.com/blog/category/grocery-ls/" title="View all posts filed under grocery-ls">grocery-ls</a>
</li>
	<li class="cat-item cat-item-13"><a href="http://custardbelly.com/blog/category/infrared5/" title="View all posts filed under Infrared5">Infrared5</a>
</li>
	<li class="cat-item cat-item-51"><a href="http://custardbelly.com/blog/category/jasmine/" title="View all posts filed under jasmine">jasmine</a>
</li>
	<li class="cat-item cat-item-37"><a href="http://custardbelly.com/blog/category/javascript/" title="View all posts filed under JavaScript">JavaScript</a>
</li>
	<li class="cat-item cat-item-33"><a href="http://custardbelly.com/blog/category/jquery/" title="View all posts filed under jquery">jquery</a>
</li>
	<li class="cat-item cat-item-34"><a href="http://custardbelly.com/blog/category/jquery-mobile/" title="View all posts filed under jquery-mobile">jquery-mobile</a>
</li>
	<li class="cat-item cat-item-45"><a href="http://custardbelly.com/blog/category/jshint/" title="View all posts filed under JSHint">JSHint</a>
</li>
	<li class="cat-item cat-item-40"><a href="http://custardbelly.com/blog/category/knockoutjs/" title="View all posts filed under knockoutjs">knockoutjs</a>
</li>
	<li class="cat-item cat-item-53"><a href="http://custardbelly.com/blog/category/madmin/" title="View all posts filed under madmin">madmin</a>
</li>
	<li class="cat-item cat-item-28"><a href="http://custardbelly.com/blog/category/massroute/" title="View all posts filed under MassRoute">MassRoute</a>
</li>
	<li class="cat-item cat-item-39"><a href="http://custardbelly.com/blog/category/massroute-js/" title="View all posts filed under massroute-js">massroute-js</a>
</li>
	<li class="cat-item cat-item-47"><a href="http://custardbelly.com/blog/category/micro-library/" title="View all posts filed under micro-library">micro-library</a>
</li>
	<li class="cat-item cat-item-3"><a href="http://custardbelly.com/blog/category/music/" title="View all posts filed under Music">Music</a>
</li>
	<li class="cat-item cat-item-18"><a href="http://custardbelly.com/blog/category/muwl/" title="View all posts filed under MUWL">MUWL</a>
</li>
	<li class="cat-item cat-item-36"><a href="http://custardbelly.com/blog/category/native-extension-for-adobe-air/" title="View all posts filed under Native Extension for Adobe AIR">Native Extension for Adobe AIR</a>
</li>
	<li class="cat-item cat-item-52"><a href="http://custardbelly.com/blog/category/node/" title="View all posts filed under node">node</a>
</li>
	<li class="cat-item cat-item-43"><a href="http://custardbelly.com/blog/category/phantomjs/" title="View all posts filed under PhantomJS">PhantomJS</a>
</li>
	<li class="cat-item cat-item-14"><a href="http://custardbelly.com/blog/category/prana/" title="View all posts filed under Prana">Prana</a>
</li>
	<li class="cat-item cat-item-44"><a href="http://custardbelly.com/blog/category/qunit/" title="View all posts filed under QUnit">QUnit</a>
</li>
	<li class="cat-item cat-item-46"><a href="http://custardbelly.com/blog/category/r-js/" title="View all posts filed under r.js">r.js</a>
</li>
	<li class="cat-item cat-item-6"><a href="http://custardbelly.com/blog/category/red5/" title="View all posts filed under Red5">Red5</a>
</li>
	<li class="cat-item cat-item-42"><a href="http://custardbelly.com/blog/category/requirejs/" title="View all posts filed under RequireJS">RequireJS</a>
</li>
	<li class="cat-item cat-item-49"><a href="http://custardbelly.com/blog/category/unit-testing/" title="View all posts filed under unit-testing">unit-testing</a>
</li>
	<li class="cat-item cat-item-7"><a href="http://custardbelly.com/blog/category/webhost/" title="View all posts filed under Westhost">Westhost</a>
</li>
			</ul>
		</div><!--.widget-->
		<div id="carrington-archives" class="widget">
			<h2 class="widget-title">Archives</h2>
			<ul>
					<li><a href='http://custardbelly.com/blog/2013/03/' title='March 2013'>March 2013</a></li>
	<li><a href='http://custardbelly.com/blog/2013/02/' title='February 2013'>February 2013</a></li>
	<li><a href='http://custardbelly.com/blog/2013/01/' title='January 2013'>January 2013</a></li>
	<li><a href='http://custardbelly.com/blog/2012/12/' title='December 2012'>December 2012</a></li>
	<li><a href='http://custardbelly.com/blog/2012/11/' title='November 2012'>November 2012</a></li>
	<li><a href='http://custardbelly.com/blog/2012/03/' title='March 2012'>March 2012</a></li>
	<li><a href='http://custardbelly.com/blog/2012/02/' title='February 2012'>February 2012</a></li>
	<li><a href='http://custardbelly.com/blog/2011/11/' title='November 2011'>November 2011</a></li>
	<li><a href='http://custardbelly.com/blog/2011/10/' title='October 2011'>October 2011</a></li>
	<li><a href='http://custardbelly.com/blog/2011/09/' title='September 2011'>September 2011</a></li>
	<li><a href='http://custardbelly.com/blog/2011/07/' title='July 2011'>July 2011</a></li>
	<li><a href='http://custardbelly.com/blog/2011/06/' title='June 2011'>June 2011</a></li>
	<li><a href='http://custardbelly.com/blog/2011/03/' title='March 2011'>March 2011</a></li>
	<li><a href='http://custardbelly.com/blog/2011/02/' title='February 2011'>February 2011</a></li>
	<li><a href='http://custardbelly.com/blog/2011/01/' title='January 2011'>January 2011</a></li>
	<li><a href='http://custardbelly.com/blog/2010/12/' title='December 2010'>December 2010</a></li>
	<li><a href='http://custardbelly.com/blog/2010/11/' title='November 2010'>November 2010</a></li>
	<li><a href='http://custardbelly.com/blog/2010/10/' title='October 2010'>October 2010</a></li>
	<li><a href='http://custardbelly.com/blog/2010/09/' title='September 2010'>September 2010</a></li>
	<li><a href='http://custardbelly.com/blog/2010/08/' title='August 2010'>August 2010</a></li>
	<li><a href='http://custardbelly.com/blog/2010/05/' title='May 2010'>May 2010</a></li>
	<li><a href='http://custardbelly.com/blog/2010/04/' title='April 2010'>April 2010</a></li>
	<li><a href='http://custardbelly.com/blog/2010/03/' title='March 2010'>March 2010</a></li>
	<li><a href='http://custardbelly.com/blog/2009/09/' title='September 2009'>September 2009</a></li>
	<li><a href='http://custardbelly.com/blog/2009/04/' title='April 2009'>April 2009</a></li>
	<li><a href='http://custardbelly.com/blog/2009/03/' title='March 2009'>March 2009</a></li>
	<li><a href='http://custardbelly.com/blog/2009/01/' title='January 2009'>January 2009</a></li>
	<li><a href='http://custardbelly.com/blog/2008/12/' title='December 2008'>December 2008</a></li>
	<li><a href='http://custardbelly.com/blog/2008/11/' title='November 2008'>November 2008</a></li>
	<li><a href='http://custardbelly.com/blog/2008/09/' title='September 2008'>September 2008</a></li>
	<li><a href='http://custardbelly.com/blog/2008/08/' title='August 2008'>August 2008</a></li>
	<li><a href='http://custardbelly.com/blog/2008/07/' title='July 2008'>July 2008</a></li>
	<li><a href='http://custardbelly.com/blog/2008/05/' title='May 2008'>May 2008</a></li>
	<li><a href='http://custardbelly.com/blog/2008/04/' title='April 2008'>April 2008</a></li>
	<li><a href='http://custardbelly.com/blog/2008/02/' title='February 2008'>February 2008</a></li>
	<li><a href='http://custardbelly.com/blog/2007/10/' title='October 2007'>October 2007</a></li>
	<li><a href='http://custardbelly.com/blog/2007/08/' title='August 2007'>August 2007</a></li>
	<li><a href='http://custardbelly.com/blog/2007/04/' title='April 2007'>April 2007</a></li>
	<li><a href='http://custardbelly.com/blog/2007/01/' title='January 2007'>January 2007</a></li>
	<li><a href='http://custardbelly.com/blog/2006/12/' title='December 2006'>December 2006</a></li>
	<li><a href='http://custardbelly.com/blog/2006/09/' title='September 2006'>September 2006</a></li>
	<li><a href='http://custardbelly.com/blog/2006/08/' title='August 2006'>August 2006</a></li>
	<li><a href='http://custardbelly.com/blog/2006/07/' title='July 2006'>July 2006</a></li>
	<li><a href='http://custardbelly.com/blog/2006/06/' title='June 2006'>June 2006</a></li>
	<li><a href='http://custardbelly.com/blog/2006/05/' title='May 2006'>May 2006</a></li>
	<li><a href='http://custardbelly.com/blog/2006/04/' title='April 2006'>April 2006</a></li>
	<li><a href='http://custardbelly.com/blog/2006/03/' title='March 2006'>March 2006</a></li>
	<li><a href='http://custardbelly.com/blog/2006/02/' title='February 2006'>February 2006</a></li>
	<li><a href='http://custardbelly.com/blog/2006/01/' title='January 2006'>January 2006</a></li>
	<li><a href='http://custardbelly.com/blog/2005/11/' title='November 2005'>November 2005</a></li>
	<li><a href='http://custardbelly.com/blog/2005/10/' title='October 2005'>October 2005</a></li>
	<li><a href='http://custardbelly.com/blog/2005/09/' title='September 2005'>September 2005</a></li>
	<li><a href='http://custardbelly.com/blog/2005/08/' title='August 2005'>August 2005</a></li>
	<li><a href='http://custardbelly.com/blog/2005/07/' title='July 2005'>July 2005</a></li>
	<li><a href='http://custardbelly.com/blog/2005/06/' title='June 2005'>June 2005</a></li>
			</ul>
		</div><!--.widget-->
	</div><!--#primary-sidebar-->
	<div id="secondary-sidebar">
		<div id="carrington-tags" class="widget">
			<h2 class="widget-title">Publications</h2>
			<!--
			<OBJECT classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" codebase="http://fpdownload.macromedia.com/get/flashplayer/current/swflash.cab" id="Player_99a5cdec-a2af-41df-9560-d547156abe38"  WIDTH="175px" HEIGHT="175px"> 
				<PARAM NAME="movie" VALUE="http://ws.amazon.com/widgets/q?ServiceVersion=20070822&MarketPlace=US&ID=V20070822%2FUS%2Fcustardbelly-20%2F8003%2F99a5cdec-a2af-41df-9560-d547156abe38&Operation=GetDisplayTemplate">
				<PARAM NAME="quality" VALUE="high">
				<PARAM NAME="bgcolor" VALUE="#FFFFFF">
				<PARAM NAME="allowscriptaccess" VALUE="always">
				<embed src="http://ws.amazon.com/widgets/q?ServiceVersion=20070822&MarketPlace=US&ID=V20070822%2FUS%2Fcustardbelly-20%2F8003%2F99a5cdec-a2af-41df-9560-d547156abe38&Operation=GetDisplayTemplate" id="Player_99a5cdec-a2af-41df-9560-d547156abe38" quality="high" bgcolor="#ffffff" name="Player_99a5cdec-a2af-41df-9560-d547156abe38" allowscriptaccess="always"  type="application/x-shockwave-flash" align="middle" height="175px" width="175px">
				</embed>
			</OBJECT> 
			<NOSCRIPT><A HREF="http://ws.amazon.com/widgets/q?ServiceVersion=20070822&MarketPlace=US&ID=V20070822%2FUS%2Fcustardbelly-20%2F8003%2F99a5cdec-a2af-41df-9560-d547156abe38&Operation=NoScript">Amazon.com Widgets</A></NOSCRIPT>
			<NOSCRIPT>
				<A HREF="http://ws.amazon.com/widgets/q?ServiceVersion=20070822&MarketPlace=US&ID=V20070822%2FUS%2Fcustardbelly-20%2F8003%2Fa2e9bd63-1298-437d-8cfa-935c6f381130&Operation=NoScript">Amazon.com Widgets</A>
			</NOSCRIPT>
			-->
			<iframe src="http://rcm.amazon.com/e/cm?t=custardbelly-20&o=1&p=8&l=as1&asins=0596805616&ref=tf_til&fc1=000000&IS2=1&lt1=_blank&m=amazon&lc1=0000FF&bc1=000000&bg1=FFFFFF&f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>
			<br />
			<iframe src="http://rcm.amazon.com/e/cm?t=custardbelly-20&o=1&p=8&l=as1&asins=0596529856&ref=tf_til&fc1=000000&IS2=1&lt1=_blank&m=amazon&lc1=0000FF&bc1=000000&bg1=FFFFFF&f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>
			<br />
			<iframe src="http://rcm.amazon.com/e/cm?t=custardbelly-20&o=1&p=8&l=as1&asins=0470182075&ref=tf_til&fc1=000000&IS2=1&lt1=_blank&m=amazon&lc1=0000FF&bc1=000000&bg1=FFFFFF&f=ifr" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>
		</div>
		<div id="carrington-tags" class="widget">
			<h2 class="widget-title">Links</h2>
			<a href="http://blog.andre-michelle.com/" target="_blank">andré michelle</a><br />
<a href="http://www.bit-101.com/blog" target="_blank">bit-101</a><br />
<a href="http://www.bytearray.org" target="_blank">bytearray</a><br />
<a href="http://chuckstar.com/blog/">chuck freedman</a><br />
<a href="http://citysalvagerecords.com/" target="_blank">city salvage records</a><br />
<a href="http://profile.myspace.com/index.cfm?fuseaction=user.viewprofile&#038;friendid=18793079" target="_blank">coconut coolouts</a><br />
<a href="http://colbygrenier.com/blog" target="_blank">colby grenier</a><br />
<a href="http://blowingthroughlines.com/">collin reisdorf</a><br />
<a href="http://www.design-nation.net/en/" target="_blank">design-nation</a><br />
<a href="http://www.dustypixels.com/blog/" target="_blank">dusty pixels</a><br />
<a href="http://www.ericd.net" target="_blank">ericd</a><br />
<a href="http://fgpwiki.corewatch.net/wiki/Main_Page" target="_blank">Flash Game Programming Wiki</a><br />
<a href="http://fullasagoog.com/" target="_blank">fullasagoog</a><br />
<a href="http://gabrieljones.com/" target="_blank">gabrieljones</a><br />
<a href="http://www.galaxygoo.org/blogs/" target="_blank">galaxygoo</a><br />
<a href="http://blog.generalrelativity.org/" target="_blank">general relativity</a><br />
<a href="http://blog.hexagonstar.com/" target="_blank">h1dd3nr3sourc3</a><br />
<a href="http://labs.byhook.com/" target="_blank">hook labs</a><br />
<a href="http://www.jivetimerecords.com/" target="_blank">jive time records</a><br />
<a href="http://blog.je2050.de/" target="_blank">joa ebert</a><br />
<a href="http://www.zeuslabs.us/" target="_blank">josh tynjala</a><br />
<a href="http://www.thefactoryfactory.com/wordpress/" target="_blank">joshua noble</a><br />
<a href="http://blog.lessrain.com/" target="_blank">lessrain</a><br />
<a href="http://www.flashconnections.com/" target="_blank">Lisa Larsen</a><br />
<a href="http://needlebeamcassette.com/blog">needlebeamcassette</a><br />
<a href="http://blog.noventaynueve.com/" target="_blank">noventaynueve</a><br />
<a href="http://reflektions.com/miniml/default.asp" target="_blank">Paul Ortchanian</a><br />
<a href="http://www.peldi.com/blog/" target="_blank">peldi</a><br />
<a href="http://www.person13.com" target="_blank">person 13</a><br />
<a href="http://www.peterelst.com/blog/" target="_blank">peter elst</a><br />
<a href="http://blog.pixelconsumption.com" target="_blank">pixelconsumption</a><br />
<a href="http://www.prex.com/index.html" target="_blank">princeton record exchange</a><br />
<a href="http://razorberry.com/blog" target="_blank">razorberry</a><br />
<a href="http://www.sarver.org" target="_blank">ryan sarver</a><br />
<a href="http://www.boostworthy.com/blog/" target="_blank">ryan taylor</a><br />
<a href="http://blog.scottjanousek.com/" target="_blank">scott janousek</a><br />
<a href="http://schelterstudios.com/blog/" target="_blank">steven schelter</a><br />
<a href="http://electrickisses.com/" target="_blank">the electric kisses</a><br />
<a href="http://timwalling.com/" target="_blank">tim walling</a><br />
<a href="http://www.unitzeroone.com/blog/" target="_blank">unit zero one</a><br />
		</div><!--.widget-->
		<div>
			<ul>	
				<p class="feed_image"><a href="http://weblogs.macromedia.com/mxna/" title="MXNA"><img src="http://www.custardbelly.com/blog/images/mxna.gif" alt="MXNA"></a></p>
				<p class="feed_image"><a href="http://www.feed-squirrel.com/" title="Consumed by Feed-Squirrel"><img src="http://www.custardbelly.com/blog/images/feedsquirrel.gif" alt="Visit Feed-Squirrel"></a></p>
				<p class="feed_image"><a href="http://www.fullasagoog.com/" title="fullasagoog"><img src="http://www.custardbelly.com/blog/images/fullasagoog.gif" alt="Visit fullasagoog"></a></p>
				<!--<p class="feed_image"><a href="http://www.flex.org"><img src="http://www.flex.org/images/flexorg.gif" alt="Flex.org - The Directory for Flex" border="0" /></a></p>-->
			</ul>
		</div>
	</div><!--#secondary-sidebar-->
	
	<div class="clear"></div>
</div><!--#sidebar-->			<div class="clear"></div>
			</div><!-- .wrapper -->
		</div><!-- #main -->
		<hr class="lofi" />
		<div id="footer" class="section">
			<div class="wrapper">		
				<p id="generator-link">Proudly powered by <a href="http://wordpress.org/" rel="generator">WordPress</a> and <a href="http://carringtontheme.com" title="Carrington theme for WordPress">Carrington</a>.</p>
				<p id="developer-link"><a href="http://crowdfavorite.com" title="Custom WordPress development, design and backup services." rel="developer designer">Carrington Theme by Crowd Favorite</a></p>
			</div><!--.wrapper-->
		</div><!--#footer -->
	</div><!--#page-->
	<script type='text/javascript' src='http://darko.liquidweb.com/~custardb/blog/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shCore.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://darko.liquidweb.com/~custardb/blog/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushJScript.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://darko.liquidweb.com/~custardb/blog/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushXml.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://darko.liquidweb.com/~custardb/blog/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushBash.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://darko.liquidweb.com/~custardb/blog/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushCpp.js?ver=3.0.83b'></script>
<script type='text/javascript' src='http://darko.liquidweb.com/~custardb/blog/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/scripts/shBrushPlain.js?ver=3.0.83b'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "http://darko.liquidweb.com/~custardb/blog/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.83b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "http://darko.liquidweb.com/~custardb/blog/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeEclipse.css?ver=3.0.83b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.defaults['toolbar'] = false;
	SyntaxHighlighter.defaults['wrap-lines'] = false;
	SyntaxHighlighter.all();
</script>
</body>
</html>