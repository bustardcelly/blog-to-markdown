<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <meta content="width=device-width, initial-scale=1, user-scalable=no" name="viewport">
    <meta name="description" content="Todd Anderson makes things for web, mobile, desktop and land with a passion of application architecture and development workflows.">
    <meta name="keywords" content="todd anderson, anderson, programmer, developer, architect, engineer, software, software development, programming, application, ria, architecture, javascript, html5, css, web, mobile, desktop, arduino, actionscript, flex, flash, python">
    <link rel="stylesheet" type="text/css" href="http://custardbelly.com/blog/style/main.css" media="all" />
    <link rel="stylesheet" type="text/css" href="http://custardbelly.com/blog/lib/highlight/styles/github.css" media="all" />
    <link rel="alternate" type="application/rss+xml" title="Todd Anderson - feed" href="http://custardbelly.com/blog/index.xml" />
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Playfair+Display">
    <title>Todd Anderson - jQuery Mobile + CouchDB: Part 7.2 – Authorization and Validation</title>
  </head>
  <body>
    <header>
      <h1><a class="header-link" href="http://custardbelly.com/blog/">Todd Anderson</a></h1>
      <h2>I make things for the web, mobile, desktop and land.</h2>
      <ul id="media-list">
        <li>
          <a href="http://custardbelly.com/blog/index.xml">
            <img src="http://custardbelly.com/blog/asset/social70.svg" onerror="this.src=http://custardbelly.com/blog/asset/social70.png" width="32" height="32">
          </a>
        </li>
        <li>
          <a href="http://twitter.com/_toddanderson_">
            <img src="http://custardbelly.com/blog/asset/twitter12.svg" onerror="this.src=http://custardbelly.com/blog/asset/twitter12.png" width="32" height="32">
          </a>
        </li>
        <li>
          <a href="https://github.com/bustardcelly">
            <img src="http://custardbelly.com/blog/asset/github7.svg" onerror="this.src=http://custardbelly.com/blog/asset/github7.png" width="32" height="32">
          </a>
        </li>
        <li>
          <a href="https://plus.google.com/113716114429928674625/posts">
            <img src="http://custardbelly.com/blog/asset/google21.svg" onerror="this.src=http://custardbelly.com/blog/asset/google21.png" width="32" height="32">
          </a>
        </li>
        <li>
          <a href="http://lnkd.in/6GCvvR">
            <img src="http://custardbelly.com/blog/asset/linkedin2.svg" onerror="this.src=http://custardbelly.com/blog/asset/linkedin2.png" width="32" height="32">
          </a>
        </li>
      </ul>
    </header>
    <nav>
      <a href="http://custardbelly.com/blog/">home</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="http://custardbelly.com/blog/archive.html">archives</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="http://custardbelly.com/blog/blog-pages/about.html">about</a>
    </nav>

    <article class="post">
  <div class="title">
    <h1><a href="http://custardbelly.com/blog/blog-posts/2011/03/04/jquery-mobile-couchdb-part-7-2-authorization-and-validation/index.html">jQuery Mobile + CouchDB: Part 7.2 – Authorization and Validation</a></h1>
    <p>
      2011 March 4th
      
        by todd anderson
      
    </p>
  </div>
  <section>
    <p>In my <a href="http://custardbelly.com/blog/?p=360">previous post</a>, I covered authorization and validation on the <a href="http://couchdb.apache.org/">CouchDB</a> side. We set up an administrator, created a user or two and established a <strong>user-role</strong> for our <strong>albums</strong> database that will be used in validation on document operations based on the user context of a session. We got to write some code – our <strong>validate_doc_update</strong> – but mainly it was all clicking around and filling in fields in <a href="http://127.0.0.1:5984/_utils/">Futon</a>. Necessary stuff, mind you… but let’s get back to code. More importantly, let’s get back to our <a href="http://jquerymobile.com/">jQuery Mobile</a> application. We didn’t even touch it in the last mini-series in a series.</p>
<p>In this article I am going to address showing a <strong>Log In/Sign Up</strong> dialog in our <a href="http://jquerymobile.com/">jQuery Mobile</a> application. Instead of forcing a user to log in upon first landing on our application (as we saw when setting up <strong>Security</strong> on our database in the past article), we are going to present the dialog when a user tries to perform an operation that requires session and user validation. The way we have set up the <strong>albums</strong> database in <a href="http://couchdb.apache.org/">CouchDB</a> is that everyone can view all the <strong>album</strong> documents, but only users of the <strong>albums</strong> database (those assigned with a <strong>user-role</strong> of “<em>albums-user</em>“) are allowed to add new <strong>album</strong> documents and only those associated users of a document are allowed to edit and delete their <strong>album</strong> document. So, from a client-side perspective, the dialog will be shown on <strong>Add</strong>, <strong>Edit</strong> and <strong>Delete</strong> if a previous session for the user has not been established.</p>
<p>Actually, it is probably a little misleading to say we will be doing all this in <a href="http://jquerymobile.com/">jQuery Mobile</a>. I am actually going to incorporate <a href="http://jquery.com/">jQuery</a> concepts into our <a href="http://jquerymobile.com/">jQuery Mobile</a> application. We are going to present the dialog as a <a href="http://jquery.com/">jQuery</a> <strong>widget</strong> and manage the communication through a <a href="http://jquery.com/">jQuery</a> <strong>plugin</strong> for our application. So as far as the <a href="http://jquerymobile.com/">jQuery Mobile</a> framework is concerned, we won’t be learning anything new per se – we’ll be learning how to incorporate <a href="http://jquery.com/">jQuery</a> <strong>widgets</strong> and <strong>plugins</strong> into our application. In previous articles, the main bulk of <a href="http://jquery.com/">jQuery</a> we have employed has been using accessors and modifiers for elements/events within our <a href="http://jquerymobile.com/">jQuery Mobile</a> application. We have also gotten familiar with the <em>jquery.couch</em> plugin that comes with <a href="http://couchdb.apache.org/">CouchDB</a> and handles most (if not all) the communication points we need for our application. So working with the <a href="http://jquery.com/">jQuery</a> library is not all that unfamiliar.</p>
<p>Right. Didn’t i say there will be more coding in this article? What am i doing yammering on? Its time to put your <a href="http://jquery.com/">jQuery</a> hats on, because its about to get a whole lot more fun*!</p>
<p><em>*guarantees not included.</em></p>
<h2 id="template">Template</h2>
<p>We are going to create a <strong>login dialog</strong> pretty much as your standard form with the option to either “<em>log in</em>” or “<em>sign up</em>” (if i ever don’t use the space in those and it bothers you, i apologize. its become a little habit). In our planning, we currently want the dialog to appear in at least 3 places based on an operation that requires session and user validation – <strong>Add</strong>, <strong>Edit</strong> and <strong>Delete</strong>. Down the road, there could be more. We could add a login button to some or every page to allow to login at any time within the application. We’ll stick to the 3 operations for now, but in knowing that the same visual piece will be used in multiple places throughout the application, it makes for a good case to use a template for the UI of our login dialog.</p>
<p>We learned about templates on the <a href="http://couchdb.apache.org/">CouchDB</a> side previously – using <a href="https://github.com/janl/mustache.js/">Mustache</a> and <strong>Partials</strong> to create our views. Same concept. We want to be able to declare some mark-up in one place that will be rendered in the <strong>DOM</strong> upon request from anywhere in the application. To do that, we’ll use the <a href="http://github.com/jquery/jquery-tmpl">jquery.tmpl</a> plugin available at: <a href="http://github.com/jquery/jquery-tmpl"><a href="http://github.com/jquery/jquery-tmpl">http://github.com/jquery/jquery-tmpl</a></a>. Why jquery.tmpl? It is simple to use and – though still in beta – is considered an <a href="http://www.borismoore.com/2010/10/jquery-templates-is-now-official-jquery.html">official jQuery plugin</a>, so documentation can be found on the <a href="http://jquery.com/">jQuery</a> site at: <a href="http://api.jquery.com/jquery.tmpl/"><a href="http://api.jquery.com/jquery.tmpl/">http://api.jquery.com/jquery.tmpl/</a></a>. In any event, make sure to download the jquery.tmpl plugin from <a href="http://github.com/jquery/jquery-tmpl"><a href="http://github.com/jquery/jquery-tmpl">http://github.com/jquery/jquery-tmpl</a></a> as we are going to use it for our login dialog.</p>
<p>With <em>jquery.tmpl</em> downloaded and added to the <em>/vendor/couchapp/_attachments/</em> folder of our <strong>albums</strong> <a href="http://couchapp.org/page/index">coucapp</a> directory (in following the examples within this series, for me that directory is <em>/Documents/workspace/custardbelly/couchdb/albums</em>), open up the <em>loader.js</em> file from that same directory and save the following modification to include the <em>jquery.tmpl</em>:</p>
<p><em>/vendor/couchapp/_attachments/loader.js</em></p>
<pre><code><span class="function"><span class="keyword">function</span> <span class="title">couchapp_load</span><span class="params">(scripts)</span> {</span>

  <span class="keyword">for</span> (var <span class="built_in">i</span>=<span class="number">0</span>; <span class="built_in">i</span> &lt; <span class="transposed_variable">scripts.</span><span class="built_in">length</span>; <span class="built_in">i</span>++) <span class="cell">{

    document.write(<span class="string">'&lt;script src="'</span>+scripts[i]+<span class="string">'"&gt;&lt;\/script&gt;'</span>)

  }</span>;

};



couchapp_load(<span class="matrix">[

  "/_utils/script/sha1.js",

  "/_utils/script/json2.js",

  "vendor/couchapp/jquery-<span class="number">1.4</span><span class="number">.4</span>.js",

  "/_utils/script/jquery.couch.js",

  "vendor/couchapp/jquery.couch.app.js",

  "vendor/couchapp/jquery.couch.app.util.js",

  "vendor/couchapp/jquery.mustache.js",

  "vendor/couchapp/jquery.evently.js",

  "vendor/couchapp/jquery.mobile-<span class="number">1.0</span>a2.js",

  "vendor/couchapp/jquery.tmpl.js"

]</span>);</code></pre>
<p>Pretty straight forward; just adding the <em>jquery.tmpl</em> <strong>plugin</strong> to be loaded into the <strong>DOM</strong>. Now we need to declare the mark-up for our <strong>login dialog</strong>. We’ll just add it to our main page and its usage will be revealed later. For now, open up the <em>/_attachments/index.html</em> file and save the following script tag and content between the previously declared script tags for the <em>loader.js</em> and our application script:</p>
<pre><code><span class="xml"><span class="tag">&lt;<span class="title">script</span> <span class="attribute">src</span>=<span class="value">"vendor/couchapp/loader.js"</span>&gt;</span><span class="javascript"></span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>

<span class="tag">&lt;<span class="title">script</span> <span class="attribute">id</span>=<span class="value">"loginSignupDialog"</span> <span class="attribute">type</span>=<span class="value">"text/x-jquery-tmpl"</span>&gt;</span><span class="javascript">

    &lt;div role=<span class="string">"dialog"</span> data-backbtn=<span class="string">"false"</span> class=<span class="string">"ui-dialog ui-body-a"</span>&gt;

      <span class="xml"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"ui-header ui-bar-a ui-corner-top ui-overlay-shadow"</span>&gt;</span>

    <span class="tag">&lt;<span class="title">h1</span> <span class="attribute">class</span>=<span class="value">"ui-title"</span>&gt;</span><span class="tag">&lt;/<span class="title">h1</span>&gt;</span>

    <span class="tag">&lt;<span class="title">a</span> <span class="attribute">id</span>=<span class="value">"dialogCloseButton"</span> <span class="attribute">href</span>=<span class="value">"#"</span> <span class="attribute">data-icon</span>=<span class="value">"delete"</span> <span class="attribute">data-iconpos</span>=<span class="value">"notext"</span> <span class="attribute">style</span>=<span class="value">"left: </span></span></span><span class="number">15</span><span class="xml">px; top: </span><span class="number">.4</span><span class="xml">em; position: absolute;" /&gt;

      <span class="tag">&lt;/<span class="title">div</span>&gt;</span>

      <span class="tag">&lt;<span class="title">div</span> <span class="attribute">data-role</span>=<span class="value">"content"</span> <span class="attribute">class</span>=<span class="value">"ui-body-c ui-corner-bottom ui-overlay-shadow"</span>&gt;</span>

        <span class="tag">&lt;<span class="title">p</span>&gt;</span>You need to be logged in to do that!<span class="tag">&lt;/<span class="title">p</span>&gt;</span>

        <span class="tag">&lt;<span class="title">form</span> <span class="attribute">action</span>=<span class="value">"#"</span> <span class="attribute">method</span>=<span class="value">"post"</span>&gt;</span>

          <span class="tag">&lt;<span class="title">label</span> <span class="attribute">for</span>=<span class="value">"username"</span>&gt;</span>Username:<span class="tag">&lt;/<span class="title">label</span>&gt;</span>

          <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">name</span>=<span class="value">"username"</span> <span class="attribute">id</span>=<span class="value">"username"</span> <span class="attribute">value</span>=<span class="value">""</span>  /&gt;</span>

          <span class="tag">&lt;<span class="title">label</span> <span class="attribute">for</span>=<span class="value">"password"</span>&gt;</span>Password:<span class="tag">&lt;/<span class="title">label</span>&gt;</span>

          <span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"password"</span> <span class="attribute">name</span>=<span class="value">"password"</span> <span class="attribute">id</span>=<span class="value">"password"</span> <span class="attribute">value</span>=<span class="value">""</span> /&gt;</span>

          <span class="tag">&lt;<span class="title">a</span> <span class="attribute">id</span>=<span class="value">"submitButton"</span> <span class="attribute">href</span>=<span class="value">"#"</span> <span class="attribute">type</span>=<span class="value">"submit"</span> <span class="attribute">data-role</span>=<span class="value">"button"</span> <span class="attribute">data-theme</span>=<span class="value">"b"</span>&gt;</span>Submit<span class="tag">&lt;/<span class="title">a</span>&gt;</span>

          <span class="tag">&lt;<span class="title">hr</span>/&gt;</span>

          <span class="tag">&lt;<span class="title">a</span> <span class="attribute">id</span>=<span class="value">"optionLinkButton"</span> <span class="attribute">href</span>=<span class="value">"#"</span> /&gt;</span>

        <span class="tag">&lt;/<span class="title">form</span>&gt;</span>

      <span class="tag">&lt;/<span class="title">div</span>&gt;</span>

      <span class="tag">&lt;<span class="title">div</span> <span class="attribute">data-role</span>=<span class="value">"footer"</span> /&gt;</span>

    <span class="tag">&lt;/<span class="title">div</span>&gt;</span>

<span class="tag">&lt;/<span class="title">script</span>&gt;</span>

<span class="tag">&lt;<span class="title">script</span> <span class="attribute">type</span>=<span class="value">"text/javascript"</span> <span class="attribute">charset</span>=<span class="value">"utf-</span><span class="number">8</span><span class="xml">"&gt;

     </span><span class="variable">$db</span><span class="xml"> = </span><span class="variable">$.couch.db</span><span class="xml">("albums");</span></code></pre>
<p>The <strong>loginSignupDialog</strong> template looks pretty familiar if you have been following along in this series. It is just a hacked up <a href="http://jquerymobile.com/">jQuery Mobile</a> page dialog with a form – looks pretty much what our <em>albumdelete.html</em> <strong>template</strong> we created before but with a form in it. You may notice that the header and <strong>optionLinkButton</strong> have no textual content. That will be updated based on the state of the dialog (login or signup). We’ll get to that later. What is important is to know that this template declaration can be rendered using the following:</p>
<pre><code><span class="variable">$(</span><span class="string">"#loginSignupDialog"</span>).tmpl()</code></pre>
<p>Once it has been rendered it can be added to the <strong>DOM</strong> as you normally would with <a href="http://jquery.com/">jQuery</a> (eg, <em>appendTo</em>()), but since we are developing in the context of a <a href="http://jquerymobile.com/">jQuery Mobile</a> application, we will treating it as a page in the application. Things to remember and will act upon later.</p>
<p>Also important to note is the type attribute of the <strong>template</strong> declaration – <em>text/x-jquery-tmpl</em>. That is so the <strong>HTML</strong> parser knows to treat that markup as a string and not try to parse and add to the <strong>DOM</strong>. Without that type, you likely will get a parse error when viewing your application in a browser. The plugin does not search for the explicit type value of <em>text/x-jquery-tmpl</em> in order to due its rendering, it just needs to have some denotation for the browser engine to recognize not to render the content to the <strong>DOM</strong> – <em>text/x-jquery-tmpl</em> is just easier to recognize what is being reserved as a <a href="http://jquery.com/">jQuery</a> template by human readers.</p>
<h2 id="organization-and-re-use">Organization and Re-use</h2>
<p>Up to this point in the series, if you have been following along, the extent of our working with <a href="http://jquery.com/">jQuery</a> has been in accessing and modifying the <strong>DOM</strong>. We’ve used the <a href="http://jquerymobile.com/">jQuery Mobile</a> API mainly to listen for events and change pages. The extent of working with the <a href="http://jquery.com/">jQuery Mobile</a> framework has been more under the hood – which i believe is the intent – though we have employed some hacks to get things to work as we would like. So, the <strong>JavaScript</strong> we have done up until this point has been to manipulate the <strong>DOM</strong> associated with a particular view – we created our <strong>Partials</strong> as quasi-view controllers and we have some script related to the <a href="http://jquerymobile.com/">jQuery Mobile</a> pages we have defined in <em>index.html</em>.</p>
<p>That’s fine. I might do some things a little different if this was going to get my seal of approval, but we were having fun. I’m gonna get a little more organized now, however, and use some great functionality and <strong>API</strong> available to us just by loading <a href="http://jquery.com/">jQuery</a> and <a href="http://jquerymobile.com/">jQuery Mobile</a> that we have been foolishly ignoring. Not really ignoring… we just never had a really strong use case to address it until now.</p>
<p>We are going to employ two architectural concepts of jQuery in order to present our login dialog and authenticate session with our <a href="http://couchdb.apache.org/">CouchDB</a> instance: <strong>widgets</strong> and <strong>plugins</strong>.</p>
<p>Before we dive into some code, perhaps I should clarify how I interpret each concept as really they can be somewhat interchangeable and used in the same fashion. For instance they both can target an element like so:</p>
<pre><code>$(<span class="string">"#myElement"</span>)<span class="preprocessor">.something</span>()<span class="comment">;</span></code></pre>
<p>It is typically the <em>something</em>() invocation, for me, that sets them apart (aside from the code behind the <em>something</em>()). If it is a directive to manipulate the element or its ancestry in the <strong>DOM</strong>, then it is a plugin. If it is a call to decorate the element in such a way that it looks and behaves in a manner usually not associated with that element, then i consider it a <strong>widget</strong> <em>(in fact, as we will discuss later, there is more to this in terms of a factory/builder plugin for widgets)</em>. Say for instance: <strong>$(”#myElement”)</strong>.<em>slider</em>() would manipulate the contents of <strong>#myElement</strong> to behave like a slider control.</p>
<p>And then of course, plugins can declare a global access variable and define an <strong>API</strong>, as we have seen with <strong>$.mobile</strong> (<em>jquery-mobile-1.0a2.js</em>) and <strong>$.couch</strong> (<em>jquery.couch.js</em>), which takes the <strong>plugin</strong> concept from being more of a “utility” method on element(s) to that of a library.</p>
<p>Of course, I could be totally off-base in how i interpret these concepts and am open to discussion. If you have different interpretations or more insight please leave a comment.</p>
<h2 id="widget">Widget</h2>
<p>Truthfully, a <strong>widget</strong> is more tied with the <a href="http://jqueryui.com/">jQuery UI</a> library. Included in the development-bundle source for <a href="http://jqueryui.com/">jQuery UI</a> is a <em>jquery.ui.widget</em> script that defines the <strong>widget</strong> factory/builder and the defined UI <strong>widget</strong> elements with the <strong>jquery.ui.*</strong> namespaced file name. We are not going to load the <a href="http://jqueryui.com/">jQuery UI</a> library as well, since <a href="http://jquerymobile.com/">jQuery Mobile</a> basically contains that script from <em>jquery.ui.widget</em> and extends it to <strong>mobile.widget</strong> to preform some string manipulation on the data attribute. In fact, most of the controls (and even page!) that are “mobilized” are widgets.</p>
<p>So we have <strong>$.widget</strong> at our disposal (thanks to <a href="http://jquerymobile.com/">jQuery Mobile</a>). We’ll use the <strong>$.widget</strong> factory to create a <strong>login dialog</strong> widget to provide functional logic to our <strong>login template</strong> create previously in this article. In this sense, you can think of the <strong>login dialog widget</strong>, itself, as a sort of presenter. We can go about mucking around with the layout and such of our template and wire up our widget to respond to events from elements in our view.</p>
<p>Before we dive right in to some code, I wanted to touch on some finer points so when we take a look at how our <strong>login dialog widget</strong> is created we might have a clearer understanding of its construction. <strong>$.widget</strong> is considered a factory method to create custom widgets and is an extension of <strong>$.Widget</strong> (capital W). <strong>$.Widget</strong> itself acts as sort of a builder. Upon widget-ization of an element, <strong>init_() and </strong>create<em>() hook methods are invoked and available for override in our custom <strong>widget</strong>. There are also some methods for options, enablement, and for triggering events (__trigger</em>()) to name a few. But most importantly, there is a <em>destroy</em>() method. To squash any memory leaks, we must tidy up our mess. </p>
<p>So, to break it down, <strong>$.Widget</strong> provides a lifecycle method template and is the builder of our <strong>widget</strong>. <strong>$.widget</strong> is a factory method for creating custom widgets and allows us to widget-ize elements based on the name of our widget. <em>What the hell does that mean?</em> If we create a widget using the <strong>$.widget</strong> factory and provide it a name of “<em>albums.loginDialog</em>“, we can widget-ize our template as such:</p>
<pre><code>$(<span class="string">"#loginSignupDialog"</span>)<span class="variable">.tmpl</span>()<span class="variable">.loginDialog</span>()</code></pre>
<p>In fact, that is essentially what we are going to do… but we first lets cover how we’re going to do it. For some extra reading, this is a great article form <a href="http://jqueryui.com/">jQuery UI</a> explaining the widget factory: <a href="http://jqueryui.com/docs/Developer_Guide"><a href="http://jqueryui.com/docs/Developer_Guide">http://jqueryui.com/docs/Developer_Guide</a></a>. There is also this excellent write up i found by <a href="http://www.erichynds.com">Eric Hynds</a>: <a href="http://www.erichynds.com/jquery/tips-for-developing-jquery-ui-widgets/"><a href="http://www.erichynds.com/jquery/tips-for-developing-jquery-ui-widgets/">http://www.erichynds.com/jquery/tips-for-developing-jquery-ui-widgets/</a></a>.</p>
<p>Less talk. More code. Open up your favorite editor and save the following snippet as <em>jquery.albums.loginDialog.js</em> in the <em>/_attachments/script</em> directory of the <strong>albums</strong> <a href="http://couchapp.org/page/index">couchapp</a> (for me that directory is <em>/Documents/workspace/custardbelly/couchdb/albums</em>):</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<pre><code><span class="list">(<span class="title">function</span><span class="body"><span class="list">(<span class="body"> $ )</span></span> {



  $.widget<span class="list">(<span class="body"> <span class="string">"albums.loginDialog"</span>, {



    options: {

      state: <span class="number">0</span>, // <span class="number">0</span> - log in state. <span class="number">1</span> - sign up state.

      loginText: <span class="string">"Log In"</span>,

      signUpText: <span class="string">"Sign Up"</span>

    },



    _create: function<span class="list">(<span class="body">)</span></span> {

      var ops = this.options<span class="comment">;</span>

      var $element = this.element<span class="comment">;</span>



      // Current page reference.

      var currentPage = $.mobile.activePage<span class="comment">;</span>

      var pageLink = currentPage.attr<span class="list">(<span class="body"> <span class="string">"id"</span> )</span></span><span class="comment">;</span>

      // It is an internal page link.

      if<span class="list">(<span class="body"> pageLink.indexOf<span class="list">(<span class="body"> <span class="string">".html"</span> )</span></span> == <span class="number">-1</span> )</span></span> pageLink = <span class="string">"#"</span> + pageLink<span class="comment">;</span>

      var closeButton = $element.find<span class="list">(<span class="body"> <span class="string">"div[class*='ui-header'] a#dialogCloseButton"</span> )</span></span>

                                .attr<span class="list">(<span class="body"> <span class="string">"href"</span>, pageLink )</span></span><span class="comment">;</span>

      // Hold reference in custom data expando.

      $element.data<span class="list">(<span class="body"><span class="string">"previous"</span>, pageLink )</span></span><span class="comment">;</span>



      // Wrap the content in a dialog page.

      var wrapper = this._wrapDialog<span class="list">(<span class="body"> $element )</span></span><span class="comment">;</span>

      // Wire interactions.

      this._wire<span class="list">(<span class="body">)</span></span><span class="comment">;</span>

      this._changeState<span class="list">(<span class="body"> ops.state )</span></span><span class="comment">;</span>

      // For some reason, i have to add it to the DOM in order to changePage<span class="list">(<span class="body">)</span></span> to it.

      $<span class="list">(<span class="body"><span class="string">"body[class*=\"ui-mobile-viewport\"]"</span>)</span></span>.append<span class="list">(<span class="title">wrapper</span><span class="body">)</span></span><span class="comment">;</span>

      $.mobile.changePage<span class="list">(<span class="body"> [currentPage, wrapper], <span class="string">"pop"</span>, false )</span></span><span class="comment">;</span>

    },



    _setOption: function<span class="list">(<span class="body"> key, value )</span></span> {

      this._changeState<span class="list">(<span class="body"> <span class="list">(<span class="body"> key == <span class="string">"state"</span> )</span></span> ? value : this.options.state )</span></span><span class="comment">;</span>

      jQuery.Widget.prototype._setOption.apply<span class="list">(<span class="body"> this, arguments )</span></span><span class="comment">;</span>

    },



    _wrapDialog: function<span class="list">(<span class="body"> dialogElement )</span></span> {

      // Page wrapper usually created on external page.

      var dialogPage = $<span class="list">(<span class="body"><span class="string">"&lt;div data-role=\"page\"&gt;"</span>)</span></span><span class="comment">;</span>

      dialogPage.append<span class="list">(<span class="body"> dialogElement )</span></span><span class="comment">;</span>

      dialogPage.page<span class="list">(<span class="body">)</span></span><span class="comment">;</span>



      dialogPage.bind<span class="list">(<span class="body"> <span class="string">"pagebeforeshow"</span>, function<span class="list">(<span class="body">)</span></span> {

          dialogPage.unbind<span class="list">(<span class="body"> <span class="string">"pagebeforeshow"</span> )</span></span><span class="comment">;</span>

          var h = parseFloat<span class="list">(<span class="title">dialogPage</span><span class="body">.innerHeight<span class="list">(<span class="body">)</span></span>)</span></span><span class="comment">;</span>

          h -= <span class="list">(<span class="body"> parseFloat<span class="list">(<span class="title">dialogElement</span><span class="body">.css<span class="list">(<span class="body"><span class="string">"border-top-width"</span>)</span></span>)</span></span> + parseFloat<span class="list">(<span class="title">dialogElement</span><span class="body">.css<span class="list">(<span class="body"><span class="string">"border-bottom-width"</span>)</span></span>)</span></span> )</span></span><span class="comment">;</span>

          // define the height based on innerHeight of wrapping parent page and the border styles applied to a dialog.

          dialogElement.css<span class="list">(<span class="body"> <span class="string">"height"</span>, h + <span class="string">"px"</span> )</span></span><span class="comment">;</span>

      })</span></span><span class="comment">;</span>

      dialogPage.bind<span class="list">(<span class="body"> <span class="string">"pagehide"</span>, function<span class="list">(<span class="body">)</span></span> {

          dialogPage.unbind<span class="list">(<span class="body"> <span class="string">"pagehide"</span> )</span></span><span class="comment">;</span>

          dialogPage.empty<span class="list">(<span class="body">)</span></span><span class="comment">;</span>

          dialogPage.remove<span class="list">(<span class="body">)</span></span><span class="comment">;</span>

      })</span></span><span class="comment">;</span>

      return dialogPage<span class="comment">;</span>

    },



    _changeState: function<span class="list">(<span class="body"> state )</span></span> {

      var mainText = <span class="list">(<span class="body"> state == <span class="number">0</span> )</span></span> ? this.options.loginText : this.options.signUpText<span class="comment">;</span>

      var optionText = <span class="list">(<span class="body"> state == <span class="number">0</span> )</span></span> ? this.options.signUpText : this.options.loginText<span class="comment">;</span>

      var $element = this.element<span class="comment">;</span>

      var header = $element.find<span class="list">(<span class="body"> <span class="string">"div[class*='ui-header']"</span> )</span></span><span class="comment">;</span>

      var page = $element.find<span class="list">(<span class="body"> <span class="string">"div[data-role='content']"</span> )</span></span><span class="comment">;</span>

      var title = header.find<span class="list">(<span class="body"> <span class="string">"[class*='ui-title']"</span> )</span></span><span class="comment">;</span>

      var optionLinkButton =  page.find<span class="list">(<span class="body"> <span class="string">"#optionLinkButton"</span> )</span></span><span class="comment">;</span>

      var submitButton = page.find<span class="list">(<span class="body"> <span class="string">"a[aria-label='submit']"</span> )</span></span><span class="comment">;</span>

      title.html<span class="list">(<span class="body"> mainText )</span></span><span class="comment">;</span>

      optionLinkButton.html<span class="list">(<span class="body"> optionText + <span class="string">"?"</span> )</span></span><span class="comment">;</span>

      submitButton.html<span class="list">(<span class="body"> mainText )</span></span><span class="comment">;</span>

      submitButton.buttonMarkup<span class="list">(<span class="body">)</span></span><span class="comment">;</span>

    },



    _wire: function<span class="list">(<span class="body">)</span></span> {

      var ref = this<span class="comment">;</span>

      var $element = ref.element<span class="comment">;</span>

      var ops = ref.options<span class="comment">;</span>

      var page = $element.find<span class="list">(<span class="body"><span class="string">"div[data-role='content']"</span>)</span></span><span class="comment">;</span>

      var optionLinkButton = page.find<span class="list">(<span class="body"> <span class="string">"#optionLinkButton"</span> )</span></span><span class="comment">;</span>



      optionLinkButton.bind<span class="list">(<span class="body"> <span class="string">"click"</span>, function<span class="list">(<span class="title">event</span><span class="body">)</span></span> {

        event.preventDefault<span class="list">(<span class="body">)</span></span><span class="comment">;</span>

        // toggle state.

        ref._setOption<span class="list">(<span class="body"> <span class="string">"state"</span>, <span class="list">(<span class="body"> ops.state == <span class="number">1</span> )</span></span> ? <span class="number">0</span> : <span class="number">1</span> )</span></span><span class="comment">;</span>

        return false<span class="comment">;</span>

      })</span></span><span class="comment">;</span>



      $element.bind<span class="list">(<span class="body"> <span class="string">"submit"</span>, function<span class="list">(<span class="title">event</span><span class="body">)</span></span> {

        event.preventDefault<span class="list">(<span class="body">)</span></span><span class="comment">;</span>

        var username = $element.find<span class="list">(<span class="body"> <span class="string">"input#username"</span> )</span></span>.val<span class="list">(<span class="body">)</span></span><span class="comment">;</span>

        var password = $element.find<span class="list">(<span class="body"> <span class="string">"input#password"</span> )</span></span>.val<span class="list">(<span class="body">)</span></span><span class="comment">;</span>

        var uievent = <span class="list">(<span class="body"> ops.state == <span class="number">0</span> )</span></span> ? <span class="string">"login"</span> : <span class="string">"signup"</span><span class="comment">;</span>

        var ui = {name<span class="keyword">:username</span>, password<span class="keyword">:password</span>}<span class="comment">;</span>

        ref._trigger<span class="list">(<span class="body"> uievent, {type<span class="keyword">:uievent</span>}, ui )</span></span><span class="comment">;</span>

        return false<span class="comment">;</span>

      })</span></span><span class="comment">;</span>

    },



    _unwire: function<span class="list">(<span class="body">)</span></span> {

      var $element = this.element<span class="comment">;</span>

      var page = $element.find<span class="list">(<span class="body"> <span class="string">"div[data-role='content']"</span> )</span></span><span class="comment">;</span>

      var optionLinkButton =  page.find<span class="list">(<span class="body"> <span class="string">"#optionLinkButton"</span> )</span></span><span class="comment">;</span>

      optionLinkButton.unbind<span class="list">(<span class="body"> <span class="string">"click"</span> )</span></span><span class="comment">;</span>

      $element.unbind<span class="list">(<span class="body"> <span class="string">"submit"</span> )</span></span><span class="comment">;</span>

    },



    close: function<span class="list">(<span class="body">)</span></span> {

      var $element = this.element<span class="comment">;</span>

      this._trigger<span class="list">(<span class="body"> <span class="string">"close"</span>, {type:<span class="string">"close"</span>} )</span></span><span class="comment">;</span>

      $.mobile.changePage<span class="list">(<span class="body"> $element.data<span class="list">(<span class="body"><span class="string">"previous"</span>)</span></span>, undefined, false )</span></span><span class="comment">;</span>

    },



    destroy: function<span class="list">(<span class="body">)</span></span> {

      this._unwire<span class="list">(<span class="body">)</span></span><span class="comment">;</span>

      // jQuery Mobile keeps adding a Submit button substitue to the template upon show,

      // Lets remove it here.

      var $element = this.element<span class="comment">;</span>

      var page = $element.find<span class="list">(<span class="body"> <span class="string">"div[data-role='content']"</span> )</span></span><span class="comment">;</span>

      var submitButton = page.find<span class="list">(<span class="body"> <span class="string">"a[aria-label='submit']"</span> )</span></span><span class="comment">;</span>

      submitButton.remove<span class="list">(<span class="body">)</span></span><span class="comment">;</span>

      // super destroy.

      jQuery.Widget.prototype.destroy.call<span class="list">(<span class="body"> this )</span></span><span class="comment">;</span>

      this.element = null<span class="comment">;</span>

    }



  })</span></span><span class="comment">;</span>



})</span></span><span class="list">(<span class="title">jQuery</span><span class="body">)</span></span></code></pre>
<p>You wanted code? You got it <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)"> I am not going to go into explaining the under-workings of <strong>$.widget</strong> or <strong>$.Widget</strong> but more the work we have here that relates to <a href="http://jquerymobile.com/">jQuery Mobile</a> and our application. Again, if you are curious, <a href="http://jqueryui.com/">jQuery UI</a> has some great documentation at <a href="http://jqueryui.com/docs/Developer_Guide"><a href="http://jqueryui.com/docs/Developer_Guide">http://jqueryui.com/docs/Developer_Guide</a></a> and you can also look at the <strong>JavaScript</strong> source for <a href="http://jquerymobile.com/">jQuery Mobile</a>. That is chock full of widgets. And then there is this awesome write up by <a href="http://www.erichynds.com">Eric Hynds</a>: <a href="http://www.erichynds.com/jquery/tips-for-developing-jquery-ui-widgets/"><a href="http://www.erichynds.com/jquery/tips-for-developing-jquery-ui-widgets/">http://www.erichynds.com/jquery/tips-for-developing-jquery-ui-widgets/</a></a>.</p>
<p>Now, let’s step through it… If you are being introduced to <a href="http://jquery.com/">jQuery</a> by this article series: <strong>a)</strong> i hope i have not mislead you in my explanations and <strong>b)</strong> this might be the first time you have seen this anonymous function declaration:</p>
<pre><code>(<span class="keyword">function</span>( $ ) {

<span class="keyword">...</span>

})(jQuery)</code></pre>
<p>There is more going on here (conflict resolution) than i will explain, but in essence this is a self-executing method that has a reference to <a href="http://jquery.com/">jQuery</a>. Basically, upon load any code within this anonymous function will be run and have access to <a href="http://jquery.com/">jQuery</a> using the <strong>$</strong> token; once <em>jquery.albums.loginDialog.js</em> is loaded, we invoke the <strong>$.widget</strong> factory method to create a <strong>widget</strong> accessible via <em>loginDialog</em>() on an element reference:</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<pre><code>$.widget( <span class="string">"albums.loginDialog"</span>, {

<span class="keyword">...</span>

} );</code></pre>
<p>The second argument to <strong>$.widget</strong> – the whole big object – is basically the meat of our <strong>widget</strong>; its got some declared default options, overidden inherited methods and some other private and public methods to make our <strong>loginDialog</strong> work. Our options are just some default values to set the initial state (either to <em>login</em> or <em>signup</em>) and the textual content associated with the state. Our <strong>login dialog</strong> isn’t going to be very pretty or contain much content other than a form and a way to switch between <em>login</em> and <em>signup</em>.</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<pre><code><span class="attribute">options</span>: <span class="string">{</span>

<span class="http">  <span class="attribute">state</span>: <span class="string">0, // 0 - log in state. 1 - sign up state.</span>

<span class="http">  <span class="attribute">loginText</span>: <span class="string">"Log In",</span>

<span class="http">  <span class="attribute">signUpText</span>: <span class="string">"Sign Up"</span>

<span class="undefined">},</span></span></span></span></code></pre>
<p>When it enters <em>_create</em>() (inheritance call from <strong>$.Widget</strong>), is when we do some real magic:</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<pre><code>var $element = this<span class="preprocessor">.element</span><span class="comment">;</span>



// Current page reference.

var currentPage = $<span class="preprocessor">.mobile</span><span class="preprocessor">.activePage</span><span class="comment">;</span>

var pageLink = currentPage<span class="preprocessor">.attr</span>( <span class="string">"id"</span> )<span class="comment">;</span>

// It is an internal page link.

if( pageLink<span class="preprocessor">.indexOf</span>( <span class="string">".html"</span> ) == -<span class="number">1</span> ) pageLink = <span class="string">"#"</span> + pageLink<span class="comment">;</span>

var closeButton = $element<span class="preprocessor">.find</span>( <span class="string">"div[class*='ui-header'] a#dialogCloseButton"</span> )

                          <span class="preprocessor">.attr</span>( <span class="string">"href"</span>, pageLink )<span class="comment">;</span>

// Hold reference <span class="keyword">in</span> custom data expando.

$element<span class="preprocessor">.data</span>(<span class="string">"previous"</span>, pageLink )<span class="comment">;</span></code></pre>
<p>The target element (the one widget-ized by calling <strong>$(”#myElement”)</strong>.<em>loginDialog</em>()) is accessed using the this keyword and is available through the life of the <strong>widget</strong>. In order to get a reference to the current page prior to opening the <strong>loginDialog</strong>, we access the id value of <strong>$.mobile</strong>.<em>activePage</em> and determine if it is an external or internal page. We then pass that as the href value for the close button on the <strong>loginDialog</strong> and add a <strong>data-previous</strong> attribute to the target element. </p>
<p>After the previous page has been determined to return to after login or signup, we then wrap the <strong>dialog template</strong> element in a page <strong>div</strong> listen for events, change the state to the default defined in options and change the page to the <strong>loginDialog</strong>:</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<pre><code><span class="comment">// Wrap the content in a dialog page.</span>

var wrapper = <span class="keyword">this</span><span class="variable">._wrapDialog</span>( $element );

<span class="comment">// Wire interactions.</span>

<span class="keyword">this</span><span class="variable">._wire</span>();

<span class="keyword">this</span><span class="variable">._changeState</span>( ops<span class="variable">.state</span> );

<span class="comment">// For some reason, i have to add it to the DOM in order to changePage() to it.</span>

$(<span class="string">"body[class*=\"ui-mobile-viewport\"]"</span>)<span class="variable">.append</span>(wrapper);

$<span class="variable">.mobile</span><span class="variable">.changePage</span>( [currentPage, wrapper], <span class="string">"pop"</span>, <span class="literal">false</span> );</code></pre>
<p>You see that funky append before <strong>$.mobile</strong>.<em>changePage</em>()?</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<pre><code><span class="formula">$("body<span class="special">[</span>class*=<span class="command">\"</span>ui-mobile-viewport<span class="command">\"</span><span class="special">]</span>").append(wrapper);</code></pre>
<p>The comment above that line explains it, but for some reason i couldn’t just switch to this dynamically created page. Instead i had to add it quickly at the end of the body (accessed by the <em>ui-mobile-viewport</em> class) and then was able to switch from the previous page to show a <strong>loginDialog</strong>. No big deal, just something to look out for. </p>
<p>Most of what is in <em>jquery.albums.loginDialog</em>, if you have been following along, may be pretty familiar to you. We do the same sizing on <em>pagebeforeshow</em> and emptying on <em>pagehide</em>, and change values based on state using <a href="http://jquery.com/">jQuery</a>. Your basic fanfare. I just wanted to touch on two more methods in <em>jquery.albums.loginDialog</em>: <em>close</em> and <em>destroy</em>:</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<pre><code><span class="attribute">close</span>: <span class="string">function() {</span>

<span class="objectivec">var $element = <span class="keyword">this</span><span class="variable">.element</span>;

<span class="keyword">this</span><span class="variable">._trigger</span>( <span class="string">"close"</span>, {type:<span class="string">"close"</span>} );

$<span class="variable">.mobile</span><span class="variable">.changePage</span>( $element<span class="variable">.data</span>(<span class="string">"previous"</span>), undefined, <span class="literal">false</span> );

},



destroy: function() {

  <span class="keyword">this</span><span class="variable">._unwire</span>();

  <span class="comment">// jQuery Mobile keeps adding a Submit button substitue to the template upon show,</span>

  <span class="comment">// Lets remove it here.</span>

  var $element = <span class="keyword">this</span><span class="variable">.element</span>;

  var page = $element<span class="variable">.find</span>( <span class="string">"div[data-role='content']"</span> );

  var submitButton = page<span class="variable">.find</span>( <span class="string">"a[aria-label='submit']"</span> );

  submitButton<span class="variable">.remove</span>();

  <span class="comment">// super destroy.</span>

  jQuery<span class="variable">.Widget</span><span class="variable">.prototype</span><span class="variable">.destroy</span><span class="variable">.call</span>( <span class="keyword">this</span> );

  <span class="keyword">this</span><span class="variable">.element</span> = null;

}</span></code></pre>
<p>The <em>close</em>() method we have exposed and is not part of <strong>$.Widget</strong>. That just allows access to anyone with a reference to the created <strong>loginDialog</strong> to directly close it (as opposed to explicitly closing it within the dialog). You can see that we change the page by using the previous data value set on the element within <strong>create<em>(). We also dispatch a “_close</em>” event using </strong>trigger<em>(). The __trigger</em>() method is part of <strong>$.Widget</strong> and can be bound to like other events, yet the type is slightly different within the context of a <strong>widget</strong>. The type value is actually appended to the <strong>widget</strong> name, so if you were to listen for close on this:</p>
<pre><code>$(<span class="string">"#loginSignupDialog"</span>)<span class="preprocessor">.tmpl</span>()<span class="preprocessor">.loginDialog</span>()<span class="preprocessor">.bind</span>( <span class="string">"logindialogclose"</span>, handleLoginDialogClose )<span class="comment">;</span></code></pre>
<p>That’s one way to do it, though i often assign handlers by passing in a <strong>callback</strong> object like so:</p>
<pre><code>$(<span class="string">"#loginSignupDialog"</span>).tmpl().loginDialog( {

        close: <span class="keyword">function</span>( evt, ui ) {

            <span class="keyword">...</span>

        }

});</code></pre>
<p>We actually trigger two other events within our <strong>loginDialog</strong> – “<em>login</em>” and “<em>signup</em>” – which are dispatched upon submit based on current state. We’ll see how all this is handled a little later on in more code, but i quickly wanted to touch on something that looks odd in the <em>destroy</em>() override:</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<pre><code>var $element = this<span class="preprocessor">.element</span><span class="comment">;</span>

var page = $element<span class="preprocessor">.find</span>( <span class="string">"div[data-role='content']"</span> )<span class="comment">;</span>

var submitButton = page<span class="preprocessor">.find</span>( <span class="string">"a[aria-label='submit']"</span> )<span class="comment">;</span>

submitButton<span class="preprocessor">.remove</span>()<span class="comment">;</span></code></pre>
<p>When a form is added top the <strong>DOM</strong> through <a href="http://jquerymobile.com/">jQuery Mobile</a>, it actually duplicates and hides the originally declared <strong>submit</strong> button and decorates a that duplicate for display. In that decoration, it is given the <strong>aria-label</strong> attribute for accessibility. Not entirely a huge issue, but if you were to show the template form more than once, you would start to see n+ times the amount of submit buttons! So we just remove it in our <em>destroy</em> override and move on.</p>
<p>Alright. Hopefully you are still with me. You may or may not have created your first <a href="http://jquery.com/">jQuery</a> <strong>widget</strong>. Isn’t it glorious or not glorious, respectively? With our <strong>template</strong> and <strong>widget</strong> defined, now begs the question: <em>When do we show this thing?</em></p>
<h2 id="plugin">Plugin</h2>
<p>So you thought introducing two new concepts (<a href="http://jquery.com/">jQuery</a> <strong>templates</strong> and <strong>widgets</strong>) was enough for one article? Well, in the words of television’s <strong>Emeril</strong>, ‘<em>We’re going to kick it up a notch!</em>‘ That’s actually probably a paraphrase. I don’t know the exact words he said and i don’t feel like googling it. I was just pandering to the developer crowd who enjoys watching cooking shows… Its a low point in this article and i am not proud of it. Let’s keep going.</p>
<p>If we step back and remember why we started doing all this business in this mini-series, we wanted to use validation on operations to our database documents. In the previous article we spoke of <strong>user context</strong>s, and updated our <strong>album</strong> document to require a user field. So, our main intent with this <strong>loginDialog</strong> is to verify a current session and then either login or signup a user. If the session is valid (user previously logged in) then, the user reference is stored and – dependent on the action – used in further transactions.</p>
<p>Now, we could just open the <strong>loginDialog</strong> all willy-nilly, here and there, and try to track down the persisted user across actions, but a saner approach (for me at least) is to encapsulate this logic in a <strong>plugin</strong>. You may be familiar with <a href="http://jquery.com/">jQuery</a> <strong>plugins</strong>… actually we have been using them throughout this whole series. We just haven’t directly looked at how they are made or work. Like I did with our <strong>widget</strong> example, I am not going to go into a discussion of <a href="http://jquery.com/">jQuery</a> <strong>plugins</strong> per se – I am going to try and focus on the task at hand and provide explanations as to how it pertains to our application as a whole. That said, to read more about <a href="http://jquery.com/">jQuery</a> <strong>plugins</strong>, this is always a great place to start: <a href="http://docs.jquery.com/Plugins/Authoring"><a href="http://docs.jquery.com/Plugins/Authoring">http://docs.jquery.com/Plugins/Authoring</a></a>.</p>
<p>Alright, we are going to take a little piecemeal approach to fleshing out our <strong>plugin</strong>, explaining as we go along, and I’ll provide it in its entirety afterward. To start, open up your favorite editor, create a file named <em>jquery.albums.app.js</em> and save it in the <em>/_attachments/script</em> folder of our <strong>albums</strong> <a href="http://couchapp.org/page/index">couchapp</a> directory. Add the following:</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<pre><code><span class="list">(<span class="title">function</span><span class="body"><span class="list">(<span class="body">$)</span></span> {



  $.albums = $.albums || {}<span class="comment">;</span>

  $.extend<span class="list">(<span class="body"> $.albums, {

  })</span></span><span class="comment">;</span>



})</span></span><span class="list">(<span class="title">jQuery</span><span class="body">)</span></span></code></pre>
<p>That is the start of our <strong>albums</strong> <strong>plugin</strong> which will be accessible by <strong>$.albums</strong>. We’re extending our (hopefully) newly created <strong>$.albums</strong> object to flesh out its public <strong>API</strong>. <strong>$.albums</strong> will serve as a facade/adaptor to the <strong>$.couch</strong> plugin and handle the display and event from the <strong>loginDialog</strong>. So there are roughly five main functions of out <strong>$.albums</strong> plugin:</p>
<ul>
<li>Log In – Direct log in request.</li>
<li>Log Out – Direct log out request</li>
<li>Save Document – Request to Create or Update a document.</li>
<li>Delete Document – Request to Delete a document.</li>
</ul>
<p>The <strong>Log In</strong> and <strong>Log Out</strong> methods mainly interface directly with <strong>$.couch</strong> and won’t deal with any UI. They are just facades to track the logged in user so we can properly send user data when creating or updating documents. The <strong>Save Document</strong> and <strong>Delete Document</strong> methods are more adaptors for <strong>$.couch</strong> communication – checking session and presenting the <strong>loginDialog</strong> if necessary. Update the <em>jquery.albums.app.js</em> with the following:</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<pre><code><span class="list">(<span class="title">function</span><span class="body"><span class="list">(<span class="body">$)</span></span> {



  $.albums = $.albums || {}<span class="comment">;</span>

  $.extend<span class="list">(<span class="body"> $.albums, {



    dialog: undefined,

    database: undefined,



    logIn: function<span class="list">(<span class="body"> name, password, options )</span></span> {

      doLogIn<span class="list">(<span class="body"> name, password, options )</span></span><span class="comment">;</span>

    },



    logOut: function<span class="list">(<span class="body"> options )</span></span> {

      doLogOut<span class="list">(<span class="body"> options )</span></span><span class="comment">;</span>

    },



    saveDocument: function<span class="list">(<span class="body"> document, options )</span></span> {

      checkSession<span class="list">(<span class="body"> {

        available: function<span class="list">(<span class="body"> userCtx )</span></span> {

          document.user = user<span class="comment">;</span>

          $.albums.database.saveDoc<span class="list">(<span class="body"> document, options )</span></span><span class="comment">;</span>

        },

        unavailable: function<span class="list">(<span class="body">)</span></span> {

          showDialog<span class="list">(<span class="body"> options )</span></span><span class="comment">;</span>

        }

      })</span></span><span class="comment">;</span>

    },



    deleteDocument: function<span class="list">(<span class="body"> document, options )</span></span> {

      checkSession<span class="list">(<span class="body"> {

        available: function<span class="list">(<span class="body"> userCtx )</span></span> {

          $.albums.database.removeDoc<span class="list">(<span class="body"> document, options )</span></span><span class="comment">;</span>

        },

        unavailable: function<span class="list">(<span class="body">)</span></span> {

          showDialog<span class="list">(<span class="body"> options )</span></span><span class="comment">;</span>

        }

      })</span></span><span class="comment">;</span>

    }



  })</span></span><span class="comment">;</span>



})</span></span><span class="list">(<span class="title">jQuery</span><span class="body">)</span></span></code></pre>
<p>So there we have our 4 public methods of <strong>$.albums</strong>. We have also added to public properties: <strong>dialog</strong> and <strong>database</strong>. These two will be the targets to the <strong>loginDialog</strong> template and a reference to our <strong>albums</strong> database, respectively. This is so we don’t rely so heavily on globally declared variables to do what we need in our nice little encapsulated <strong>plugin</strong>. In any event, if you have looked at the contents of these methods, they all call other functions that we haven’t declared yet. Lets start with <em>checkSession</em>() in <strong>saveDocument</strong> and <strong>deleteDocument</strong>. Add the following after the <strong>$.extend</strong> declaration and prior to close of <em>function</em>():</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<pre><code>function checkSession( options ) {

    options = options || {}<span class="comment">;</span>

    $<span class="preprocessor">.couch</span><span class="preprocessor">.session</span>( {

      success: function( response ) {

        var context = response<span class="preprocessor">.userCtx</span><span class="comment">;</span>

        if( context<span class="preprocessor">.name</span> == null ) {

          if( options<span class="preprocessor">.unavailable</span> ) options<span class="preprocessor">.unavailable</span>()<span class="comment">;</span>

        }

        else{

          if( options<span class="preprocessor">.available</span> ) options<span class="preprocessor">.available</span>( context )<span class="comment">;</span>

        }

      },

      error: function( status, error, reason ) {

        if( options<span class="preprocessor">.unavailable</span> ) options<span class="preprocessor">.unavailable</span>()<span class="comment">;</span>

      }

    })<span class="comment">;</span>

}</code></pre>
<p>The <em>checkSession</em>() does just that: request the current session established by our client through the <strong>$.couch</strong> plugin. If the <strong>userCtx</strong> comes back as null, there is no session and no logged in user on our end. We can try this out using <strong>curl</strong> on the command line:</p>
<pre><code>&gt; curl -vX <span class="constant">GET</span> <span class="symbol">http:</span>/<span class="regexp">/127.0.0.1:5984/</span>_session

&lt; {<span class="string">"ok"</span><span class="symbol">:true</span>,<span class="string">"userCtx"</span><span class="symbol">:</span>{<span class="string">"name"</span><span class="symbol">:null</span>,<span class="string">"roles"</span><span class="symbol">:[]</span>},<span class="string">"info"</span><span class="symbol">:</span>{<span class="string">"authentication_db"</span><span class="symbol">:<span class="string">"_users"</span></span>,<span class="string">"authentication_handlers"</span><span class="symbol">:</span>[<span class="string">"oauth"</span>,<span class="string">"cookie"</span>,<span class="string">"default"</span>]}}</code></pre>
<p>Depending on the value of <strong>userCtx</strong>, <em>checkSession</em>() will invoke an <em>available</em>() or <em>unavailable</em>() <strong>callback</strong> method on the anonymous options argument. The available responder on <em>saveDocument</em>() and <em>deleteDocument</em>() is different – one saves, the other deletes – but if unavailable is entered, they both call <em>showDialog</em>(). Append the following script to <em>jquery.albums.app.js</em> after the <em>checkSession</em>() declaration:</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<pre><code>function showDialog( options ) {

    $<span class="preprocessor">.albums</span><span class="preprocessor">.dialog</span><span class="preprocessor">.loginDialog</span>( {

      login: function( evt, ui ) {

        doLogIn( ui<span class="preprocessor">.name</span>, ui<span class="preprocessor">.password</span>, {

          success: function( response ) {

            $<span class="preprocessor">.albums</span><span class="preprocessor">.dialog</span><span class="preprocessor">.loginDialog</span>( <span class="string">"close"</span> )<span class="comment">;</span>

          },

          error: function( status, error, reason ) {

            alert( <span class="string">"Error: "</span> + error + <span class="string">", "</span> + reason )<span class="comment">;</span>

          }

        })<span class="comment">;</span>

      },

      signup: function( evt, ui ) {

        doSignUp( ui<span class="preprocessor">.name</span>, ui<span class="preprocessor">.password</span>, {

          success: function( response ) {

            $<span class="preprocessor">.albums</span><span class="preprocessor">.dialog</span><span class="preprocessor">.loginDialog</span>( <span class="string">"close"</span> )<span class="comment">;</span>

          },

          error: function( status, error, reason ) {

            alert( <span class="string">"Error: "</span> + error + <span class="string">", "</span> + reason )<span class="comment">;</span>

          }

        })<span class="comment">;</span>

      }

    })<span class="comment">;</span>

}</code></pre>
<p>Hey! That’s using our <strong>widget</strong>! I don’t know why i seriously get excited when i see that… In any event, there it is in all its glory. The <strong>login template</strong> will be handed to <strong>$.albums</strong> and we’ll widget-ize it within the <em>showDialog</em>() invocation:</p>
<pre><code>$.albums.dialog.loginDialog( {

<span class="keyword">...</span>

});</code></pre>
<p>If you remember back when we created the <strong>widget</strong>, it will dispatch two events when submitted based on state: <em>login</em> and <em>signup</em>. Here we have added the <strong>callbacks</strong> to those events which in turn call either <em>doLogIn</em>() or <em>doSignUp</em>(). We’ll get to that in a bit, but i wanted to point out the success responders in the anonymous <strong>callback</strong> objects we pass to those methods:</p>
<pre><code><span class="attribute">success</span>: <span class="string">function( response ) {</span>

<span class="avrasm">    $<span class="preprocessor">.albums</span><span class="preprocessor">.dialog</span><span class="preprocessor">.loginDialog</span>( <span class="string">"close"</span> )<span class="comment">;</span>

}</span></code></pre>
<p>If we have passed being logged in/signed up, we close the <strong>loginDialog</strong>. We exposed the <em>close</em>() method in <em>jquery.albums.loginDialog.js</em>, but its important to note that you cannot call <em>close</em>() using dot-notation like a property. The reason is that we are not holding a reference to the <strong>loginDialog</strong>. Calling <strong>$(”#myElement”)</strong>.<em>loginDialog</em>() just decorates the target element on the <strong>DOM</strong>. We can still interface with <strong>$(”#myElement”)</strong> but those methods associated with the <strong>widget</strong> are not then accessible on the target element. So we call a public method through <em>loginDialog</em>().</p>
<p>OK. So <em>doLogin</em>(), <em>doLogout</em>() and <em>doSignUp</em>() are yet to be covered. For some reason i have this convention where if it is considered an internal response to a public invocation i prepend ‘<em>d<em>o’ to the public method name. Some people prefer “_</em></em>“. To each his own. Just if you are wondering… Let’s tackle the login and logout first, as they are easy. Add the following script to <em>jquery.albums.app.js</em> somewhere after the <strong>$.extend</strong> declaration and prior to the end of the <em>function</em>() block:</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<pre><code>var user; /* _user &gt; document.name */



<span class="keyword">function</span> doLogIn( name, password, options ) {

    options = options || {};

    var loginObj = {

      name:name,

      password:password,

      success: <span class="keyword">function</span>( <span class="built_in">response</span> ) {

        user = <span class="built_in">response</span>.name;

        <span class="keyword">if</span>( options.success ) options.success( <span class="built_in">response</span> );

      },

      <span class="keyword">error</span>: <span class="keyword">function</span>( status, <span class="keyword">error</span>, reason ) {

        <span class="keyword">if</span>( options.<span class="keyword">error</span> ) options.<span class="keyword">error</span>( status, <span class="keyword">error</span>, reason );

      }

    };

    $.couch.login( loginObj );

}



<span class="keyword">function</span> doLogOut( options ) {

    options = options || {};

    $.couch.logout( {

      success: <span class="keyword">function</span>( <span class="built_in">response</span> ) {

        user = undefined;

        <span class="keyword">if</span>( options.success ) options.success( <span class="built_in">response</span> );

      },

      <span class="keyword">error</span>: <span class="keyword">function</span>( status, <span class="keyword">error</span>, reason ) {

        <span class="keyword">if</span>( options.<span class="keyword">error</span> ) options.<span class="keyword">error</span>( status, <span class="keyword">error</span>, reason );

      }

    })

}</code></pre>
<p>Again, we are just interfacing with the <strong>$.couch</strong> plugin to perform the <em>login</em>() and <em>logout</em>(). The only reason we go through <strong>$.albums</strong> instead of <strong>$.couch</strong> directly is to maintain the <strong>user</strong>, which we have privately declared. That user value is the one assigned to the user field of a document when a new <strong>album</strong> document will be created and saved through <strong>$.albums</strong> using <em>saveDocument</em>().</p>
<p>Alright, <strong>Sign Up</strong> is where the magic happens. Signing a user up through <strong>$.couch</strong> is a little trickier. In <a href="http://127.0.0.1:5984/_utils">Futon</a> it is all easy-peasy as we saw in the last article in this mini-series in a series. Now that we have taken our <a href="http://couchdb.apache.org/">CouchDB</a> instance out of <strong>Admin Party</strong> mode, the <strong>$.couch</strong>.<em>signUp</em>() method won’t work unless we are logged in as an admin. We don’t want to take the approach of <a href="http://127.0.0.1:5984/_utils">Futon</a> for the User Experience for our little application here. Our application shouldn’t act as an admin console to the <a href="http://couchdb.apache.org/">CouchDB</a> database as well as its current function of just adding, updating and deleting <strong>album</strong> documents. </p>
<p>We going to secretly log in as an admin behind the scenes and set our new user up for gold and start adding documents. So, <strong>Sign Up</strong> is actually going to be a series of commands just to sign someone up, assign their proper <strong>user-role</strong> and create their session to allow them to start working with <strong>album</strong> documents. That sequence in readable terms is:</p>
<ol>
<li>Log In as Admin</li>
<li>Sign Up new User</li>
<li>Open new User document</li>
<li>Add “albums-user” User Role to new User</li>
<li>Log Out as Admin</li>
<li>Log In as new User</li>
</ol>
<p>Maybe the <em>jquery.couch</em> plugin has changed since the last revision i checked out, but that is the order of things to <em>signup</em> and <em>login</em> a new user as far as i understand. The signature for <strong>$.couch</strong>.<em>signUp</em>() method has no arguments for administration to do this more streamlined, so we are going to create a chain of commands to signup a new user a little more efficiently. Now, in actuality, i would turn to a server-side developer and ask pretty-please that they implement a proxy in whatever language to do this and not handle it all in <strong>JavaScript</strong> (especially since we are going to expose our admin credentials – <em>HIDE YOUR CHILDREN</em>!), but we’re having fun and not going to production with this, right? We’re taking some liberties to explore what we have…</p>
<p>Now, if you have not figured out yet in following these articles, i can get a little anal. But it isn’t about everything. I seem to get focused on one thing that really irks me. And one of those things is deeply nested anonymous <strong>callbacks</strong>. Sure i am guilty of doing it and when i do it i feel dirty, but i usually let it go if its not nesting too deep. This sequence of actions for <strong>Sign Up</strong>, however, i can foresee being really ugly if we just went with anonymous <strong>callback</strong> objects down the line. So what i did was create <strong>Queue</strong> and <strong>Command</strong> “classes” to keep my sanity. The following is the script for that. Open a new document in your favorite editor (we’ll get back to <em>jquery.albums.app.js</em> in a bit) and save the following script as <em>command_queue.js</em> in <em>/_attachments/script</em>:</p>
<p><em>/_attachments/script/command_queue.js</em></p>
<pre><code><span class="list">(<span class="title">function</span><span class="body"><span class="list">(<span class="title">window</span><span class="body">)</span></span> {



    function Commandable<span class="list">(<span class="body">)</span></span> {}

    Commandable.prototype.execute = function<span class="list">(<span class="body"> data )</span></span>{}<span class="comment">;</span>



    function Queue<span class="list">(<span class="body"> ops )</span></span> {

        this.options = ops || {}<span class="comment">;</span>

        this.list = []<span class="comment">;</span>

        this.command<span class="comment">;</span>



        this.addCommand = function<span class="list">(<span class="body"> command )</span></span> {

            var length = this.list.length<span class="comment">;</span>

            if<span class="list">(<span class="body"> length &gt; <span class="number">0</span> )</span></span> {

                this.list[length<span class="number">-1</span>].nextCommand = this<span class="comment">;</span>

            }

            this.list.push<span class="list">(<span class="body"> command )</span></span><span class="comment">;</span>

        }

    }

    var q = Queue.prototype = new Commandable<span class="list">(<span class="body">)</span></span><span class="comment">;</span>

    q.options = undefined<span class="comment">;</span>

    q.list = undefined<span class="comment">;</span>

    q.command = undefined<span class="comment">;</span>

    q.constructor = Queue<span class="comment">;</span>

    q.execute = function<span class="list">(<span class="body"> data )</span></span> {

        if<span class="list">(<span class="body"> this.list.length &gt; <span class="number">0</span> )</span></span> {

            this.command = this.list.shift<span class="list">(<span class="body">)</span></span><span class="comment">;</span>

            this.command.execute<span class="list">(<span class="body"> data )</span></span><span class="comment">;</span>

        }

        else {

            this.command = undefined<span class="comment">;</span>

            if<span class="list">(<span class="body"> this.options.complete )</span></span> {

                this.options.complete<span class="list">(<span class="body">)</span></span><span class="comment">;</span>

            }

        }

    }



    function Command<span class="list">(<span class="body"> target, args, ops )</span></span> {

        this.target = target<span class="comment">;</span>

        this.args = args || []<span class="comment">;</span>

        this.options = ops || {}<span class="comment">;</span>

        this.nextCommand = undefined<span class="comment">;</span>

    }

    var c = Command.prototype = new Commandable<span class="list">(<span class="body">)</span></span><span class="comment">;</span>

    c.constructor = Command<span class="comment">;</span>

    c.getCommandOptions = function<span class="list">(<span class="body"> options, nextCommand )</span></span> {

        var responder = {

            ops: options,

            success: function<span class="list">(<span class="body"> response )</span></span> {

                if<span class="list">(<span class="body"> options <span class="keyword">&amp;&amp;</span> options.success )</span></span> options.success<span class="list">(<span class="body"> response )</span></span><span class="comment">;</span>

                if<span class="list">(<span class="body"> nextCommand )</span></span> {

                    nextCommand.execute<span class="list">(<span class="body"> response )</span></span><span class="comment">;</span>

                }

            },

            error: function<span class="list">(<span class="body"> status, error, reason )</span></span> {

                if<span class="list">(<span class="body"> options <span class="keyword">&amp;&amp;</span> options.error )</span></span> options.error<span class="list">(<span class="body"> status, error, reason )</span></span><span class="comment">;</span>

            }

        }<span class="comment">;</span>

        return $.extend<span class="list">(<span class="body"> {}, this.options, responder )</span></span><span class="comment">;</span>

    }

    c.execute = function<span class="list">(<span class="body"> data )</span></span> {

        this.args.push<span class="list">(<span class="body"> this.getCommandOptions<span class="list">(<span class="body"> this.options, this.nextCommand )</span></span> )</span></span><span class="comment">;</span>

        this.target.apply<span class="list">(<span class="body"> this, this.args )</span></span><span class="comment">;</span>

    }



window.Queue = Queue<span class="comment">;</span>

window.Command = Command<span class="comment">;</span>



}<span class="list">(<span class="title">window</span><span class="body">)</span></span>)</span></span><span class="comment">;</span></code></pre>
<p>I’m not going to say it’s sophisticated by any means, but this is a simple implementation to allow us to chain commands together. That is done by adding <strong>Commands</strong> to the <strong>Queue</strong> using <em>addCommand</em>(), which then appends a command using the <em>nextCommand</em> property of the previous (if available) <strong>Command</strong>. Both <strong>Queue</strong> and <strong>Command</strong> have a method called <em>execute</em>() (as extensions of <strong>Commandable</strong>). Executing a <strong>Queue</strong> will start the chain of commands; executing a <strong>Command</strong> will invoke whatever <strong>target</strong> method supplied in the constructor. If this needs more explanation, please leave a comment. We’ll see how we use this by implementing our <em>doSignUp</em>() method in <em>jquery.albums.app.js</em>. Open up <em>jquery.albums.app.js</em> in your favorite editor and add the following script somewhere after the <strong>$.execute</strong> declaration and before the end of the <em>function</em>() block:</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<pre><code>function doSignUp( name, password, options ) {

    options = options || {}<span class="comment">;</span>

    var queueOptions = {

      complete: function() {

        if( options<span class="preprocessor">.success</span> ) options<span class="preprocessor">.success</span>()<span class="comment">;</span>

      }

    }

    var queue = new Queue( queueOptions )<span class="comment">;</span>

    queue<span class="preprocessor">.addCommand</span>( new Command( $<span class="preprocessor">.albums</span><span class="preprocessor">.logIn</span>, [<span class="string">"toddanderson"</span>, <span class="string">"admin123"</span>] ) )<span class="comment">;</span>

    queue<span class="preprocessor">.addCommand</span>( new Command( $<span class="preprocessor">.couch</span><span class="preprocessor">.signup</span>, [{name:name}, password] ) )<span class="comment">;</span>

    queue<span class="preprocessor">.addCommand</span>( new OpenUserDocCommand() )<span class="comment">;</span>

    queue<span class="preprocessor">.addCommand</span>( new AssignRoleCommand() )<span class="comment">;</span>

    queue<span class="preprocessor">.addCommand</span>( new Command( $<span class="preprocessor">.albums</span><span class="preprocessor">.logOut</span> ) )<span class="comment">;</span>

    queue<span class="preprocessor">.addCommand</span>( new Command( $<span class="preprocessor">.albums</span><span class="preprocessor">.logIn</span>, [name, password], options ) )<span class="comment">;</span>

    queue<span class="preprocessor">.execute</span>()<span class="comment">;</span>

}</code></pre>
<p>There we have our sequence of command described earlier. You can see how we pass the target method and arguments to the <strong>Command</strong> to be executed and the queue of commands is assembled using <strong>Queue</strong>:<em>addCommand</em>(). Again, our admin credentials are exposed and available to all – I do not recommend this practice in real life. Its just us here. So, there are two commands there in the middle that we haven’t discussed and aren’t declared in <em>command_queue.js</em>. They are specific to our <strong>albums</strong> application, so we will define them in <em>jquery.albums.app.js</em>. With the file still open, add the following script after (or before) the <em>doSignUp</em>() declaration:</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<pre><code><span class="title">function</span> <span class="type">OpenUserDocCommand</span>( target, args, options ) {}

<span class="type">OpenUserDocCommand</span>.prototype = new <span class="type">Command</span>();

<span class="type">OpenUserDocCommand</span>.prototype.execute = function( <span class="typedef"><span class="keyword">data</span> ) <span class="container">{

      <span class="title">var</span> $<span class="title">userDB</span> = $.<span class="title">couch</span>.<span class="title">db</span>("<span class="title">_users</span>");

      $<span class="title">userDB</span>.<span class="title">openDoc</span>( <span class="title">data</span>.<span class="title">id</span>, <span class="title">this</span>.<span class="title">getCommandOptions</span>( <span class="title">this</span>.<span class="title">options</span>, <span class="title">this</span>.<span class="title">nextCommand</span> ) );

}</span></span>



<span class="title">function</span> <span class="type">AssignRoleCommand</span>( target, args, options ) {}

<span class="type">AssignRoleCommand</span>.prototype = new <span class="type">Command</span>();

<span class="type">AssignRoleCommand</span>.prototype.execute = function( <span class="typedef"><span class="keyword">data</span> ) <span class="container">{

      <span class="title">data</span>.<span class="title">roles</span> = ["<span class="title">albums</span>-<span class="title">user</span>"];

      <span class="title">var</span> $<span class="title">userDB</span> = $.<span class="title">couch</span>.<span class="title">db</span>("<span class="title">_users</span>");

      $<span class="title">userDB</span>.<span class="title">saveDoc</span>( <span class="title">data</span>, <span class="title">this</span>.<span class="title">getCommandOptions</span>( <span class="title">this</span>.<span class="title">options</span>, <span class="title">this</span>.<span class="title">nextCommand</span> ) );

}</span></span></code></pre>
<p>Nothing too crazy going on in <strong>OpenUserDocCommand</strong> or <strong>AssignRoleCommand</strong>, just needed to do some work with the <strong>_users</strong> database of our <a href="http://couchdb.apache.org/">CouchDB</a> instance as an admin.</p>
<p>Guess what? That’s it! We’re done with <em>jquery.albums.app.js</em>. Whew! If you have stuck around, i am quite humbled. Seriously. A lot of code and rambling on. I don’t know if i would have made it. Anyway, here is <em>jquery.albums.app.js</em> in full:</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<pre><code><span class="list">(<span class="title">function</span><span class="body"><span class="list">(<span class="body">$)</span></span> {



  $.albums = $.albums || {}<span class="comment">;</span>

  $.extend<span class="list">(<span class="body"> $.albums, {



    dialog: undefined,

    database: undefined,



    logIn: function<span class="list">(<span class="body"> name, password, options )</span></span> {

      doLogIn<span class="list">(<span class="body"> name, password, options )</span></span><span class="comment">;</span>

    },



    logOut: function<span class="list">(<span class="body"> options )</span></span> {

      doLogOut<span class="list">(<span class="body"> options )</span></span><span class="comment">;</span>

    },



    saveDocument: function<span class="list">(<span class="body"> document, options )</span></span> {

      checkSession<span class="list">(<span class="body"> {

        available: function<span class="list">(<span class="body"> userCtx )</span></span> {

          document.user = user<span class="comment">;</span>

          $.albums.database.saveDoc<span class="list">(<span class="body"> document, options )</span></span><span class="comment">;</span>

        },

        unavailable: function<span class="list">(<span class="body">)</span></span> {

          showDialog<span class="list">(<span class="body"> options )</span></span><span class="comment">;</span>

        }

      })</span></span><span class="comment">;</span>

    },



    deleteDocument: function<span class="list">(<span class="body"> document, options )</span></span> {

      checkSession<span class="list">(<span class="body"> {

        available: function<span class="list">(<span class="body"> userCtx )</span></span> {

          $.albums.database.removeDoc<span class="list">(<span class="body"> document, options )</span></span><span class="comment">;</span>

        },

        unavailable: function<span class="list">(<span class="body">)</span></span> {

          showDialog<span class="list">(<span class="body"> options )</span></span><span class="comment">;</span>

        }

      })</span></span><span class="comment">;</span>

    }



  })</span></span><span class="comment">;</span>



  var user<span class="comment">; /* _user &gt; document.name */</span>



  function OpenUserDocCommand<span class="list">(<span class="body"> target, args, options )</span></span> {}

  OpenUserDocCommand.prototype = new Command<span class="list">(<span class="body">)</span></span><span class="comment">;</span>

  OpenUserDocCommand.prototype.execute = function<span class="list">(<span class="body"> data )</span></span> {

      var $userDB = $.couch.db<span class="list">(<span class="body"><span class="string">"_users"</span>)</span></span><span class="comment">;</span>

      $userDB.openDoc<span class="list">(<span class="body"> data.id, this.getCommandOptions<span class="list">(<span class="body"> this.options, this.nextCommand )</span></span> )</span></span><span class="comment">;</span>

  }



  function AssignRoleCommand<span class="list">(<span class="body"> target, args, options )</span></span> {}

  AssignRoleCommand.prototype = new Command<span class="list">(<span class="body">)</span></span><span class="comment">;</span>

  AssignRoleCommand.prototype.execute = function<span class="list">(<span class="body"> data )</span></span> {

      data.roles = [<span class="string">"albums-user"</span>]<span class="comment">;</span>

      var $userDB = $.couch.db<span class="list">(<span class="body"><span class="string">"_users"</span>)</span></span><span class="comment">;</span>

      $userDB.saveDoc<span class="list">(<span class="body"> data, this.getCommandOptions<span class="list">(<span class="body"> this.options, this.nextCommand )</span></span> )</span></span><span class="comment">;</span>

  }



  function checkSession<span class="list">(<span class="body"> options )</span></span> {

    options = options || {}<span class="comment">;</span>

    $.couch.session<span class="list">(<span class="body"> {

      success: function<span class="list">(<span class="body"> response )</span></span> {

        var context = response.userCtx<span class="comment">;</span>

        if<span class="list">(<span class="body"> context.name == null )</span></span> {

          if<span class="list">(<span class="body"> options.unavailable )</span></span> options.unavailable<span class="list">(<span class="body">)</span></span><span class="comment">;</span>

        }

        else{

          if<span class="list">(<span class="body"> options.available )</span></span> options.available<span class="list">(<span class="body"> context )</span></span><span class="comment">;</span>

        }

      },

      error: function<span class="list">(<span class="body"> status, error, reason )</span></span> {

        if<span class="list">(<span class="body"> options.unavailable )</span></span> options.unavailable<span class="list">(<span class="body">)</span></span><span class="comment">;</span>

      }

    })</span></span><span class="comment">;</span>

  }



  function doLogIn<span class="list">(<span class="body"> name, password, options )</span></span> {

    options = options || {}<span class="comment">;</span>

    var loginObj = {

      name<span class="keyword">:name</span>,

      password<span class="keyword">:password</span>,

      success: function<span class="list">(<span class="body"> response )</span></span> {

        user = response.name<span class="comment">;</span>

        if<span class="list">(<span class="body"> options.success )</span></span> options.success<span class="list">(<span class="body"> response )</span></span><span class="comment">;</span>

      },

      error: function<span class="list">(<span class="body"> status, error, reason )</span></span> {

        if<span class="list">(<span class="body"> options.error )</span></span> options.error<span class="list">(<span class="body"> status, error, reason )</span></span><span class="comment">;</span>

      }

    }<span class="comment">;</span>

    $.couch.login<span class="list">(<span class="body"> loginObj )</span></span><span class="comment">;</span>

  }



  function doLogOut<span class="list">(<span class="body"> options )</span></span> {

    options = options || {}<span class="comment">;</span>

    $.couch.logout<span class="list">(<span class="body"> {

      success: function<span class="list">(<span class="body"> response )</span></span> {

        user = undefined<span class="comment">;</span>

        if<span class="list">(<span class="body"> options.success )</span></span> options.success<span class="list">(<span class="body"> response )</span></span><span class="comment">;</span>

      },

      error: function<span class="list">(<span class="body"> status, error, reason )</span></span> {

        if<span class="list">(<span class="body"> options.error )</span></span> options.error<span class="list">(<span class="body"> status, error, reason )</span></span><span class="comment">;</span>

      }

    })</span></span>

  }



  function doSignUp<span class="list">(<span class="body"> name, password, options )</span></span> {

    options = options || {}<span class="comment">;</span>

    var queueOptions = {

      complete: function<span class="list">(<span class="body">)</span></span> {

        if<span class="list">(<span class="body"> options.success )</span></span> options.success<span class="list">(<span class="body">)</span></span><span class="comment">;</span>

      }

    }

    var queue = new Queue<span class="list">(<span class="body"> queueOptions )</span></span><span class="comment">;</span>

    queue.addCommand<span class="list">(<span class="body"> new Command<span class="list">(<span class="body"> $.albums.logIn, [<span class="string">"toddanderson"</span>, <span class="string">"admin123"</span>] )</span></span> )</span></span><span class="comment">;</span>

    queue.addCommand<span class="list">(<span class="body"> new Command<span class="list">(<span class="body"> $.couch.signup, [{name<span class="keyword">:name</span>}, password] )</span></span> )</span></span><span class="comment">;</span>

    queue.addCommand<span class="list">(<span class="body"> new OpenUserDocCommand<span class="list">(<span class="body">)</span></span> )</span></span><span class="comment">;</span>

    queue.addCommand<span class="list">(<span class="body"> new AssignRoleCommand<span class="list">(<span class="body">)</span></span> )</span></span><span class="comment">;</span>

    queue.addCommand<span class="list">(<span class="body"> new Command<span class="list">(<span class="body"> $.albums.logOut )</span></span> )</span></span><span class="comment">;</span>

    queue.addCommand<span class="list">(<span class="body"> new Command<span class="list">(<span class="body"> $.albums.logIn, [name, password], options )</span></span> )</span></span><span class="comment">;</span>

    queue.execute<span class="list">(<span class="body">)</span></span><span class="comment">;</span>

  }



  function showDialog<span class="list">(<span class="body"> options )</span></span> {

    $.albums.dialog.loginDialog<span class="list">(<span class="body"> {

      login: function<span class="list">(<span class="body"> evt, ui )</span></span> {

        doLogIn<span class="list">(<span class="body"> ui.name, ui.password, {

          success: function<span class="list">(<span class="body"> response )</span></span> {

            $.albums.dialog.loginDialog<span class="list">(<span class="body"> <span class="string">"close"</span> )</span></span><span class="comment">;</span>

          },

          error: function<span class="list">(<span class="body"> status, error, reason )</span></span> {

            alert<span class="list">(<span class="body"> <span class="string">"Error: "</span> + error + <span class="string">", "</span> + reason )</span></span><span class="comment">;</span>

          }

        })</span></span><span class="comment">;</span>

      },

      signup: function<span class="list">(<span class="body"> evt, ui )</span></span> {

        doSignUp<span class="list">(<span class="body"> ui.name, ui.password, {

          success: function<span class="list">(<span class="body"> response )</span></span> {

            $.albums.dialog.loginDialog<span class="list">(<span class="body"> <span class="string">"close"</span> )</span></span><span class="comment">;</span>

          },

          error: function<span class="list">(<span class="body"> status, error, reason )</span></span> {

            alert<span class="list">(<span class="body"> <span class="string">"Error: "</span> + error + <span class="string">", "</span> + reason )</span></span><span class="comment">;</span>

          }

        })</span></span><span class="comment">;</span>

      }

    })</span></span><span class="comment">;</span>

  }



})</span></span><span class="list">(<span class="title">jQuery</span><span class="body">)</span></span></code></pre>
<p>Now before you run off, kiss your significant other and tell him/her that you will soon be billionaires, we have a little more work to do to get this up and running in our <strong>Albums</strong> application.</p>
<h2 id="loader-and-index">Loader and Index</h2>
<p>We kind of went off the deep-end there and dove right into code that code stand on its own outside of our current design of the <strong>Albums</strong> application. That’s good, but now we gotta reel it back in and wire it up. To start, lets add our new scripts in the <em>loader</em>. Open up <em>/vendor/couchapp/_attachments/loader.js</em> and save the following modifications:</p>
<p><em>/vendor/couchapp/_attachments/loader.js</em></p>
<pre><code><span class="function"><span class="keyword">function</span> <span class="title">couchapp_load</span><span class="params">(scripts)</span> {</span>

  <span class="keyword">for</span> (var <span class="built_in">i</span>=<span class="number">0</span>; <span class="built_in">i</span> &lt; <span class="transposed_variable">scripts.</span><span class="built_in">length</span>; <span class="built_in">i</span>++) <span class="cell">{

    document.write(<span class="string">'&lt;script src="'</span>+scripts[i]+<span class="string">'"&gt;&lt;\/script&gt;'</span>)

  }</span>;

};



couchapp_load(<span class="matrix">[

  "/_utils/script/sha1.js",

  "/_utils/script/json2.js",

  "vendor/couchapp/jquery-<span class="number">1.4</span><span class="number">.4</span>.js",

  "/_utils/script/jquery.couch.js",

  "vendor/couchapp/jquery.couch.app.js",

  "vendor/couchapp/jquery.couch.app.util.js",

  "vendor/couchapp/jquery.mustache.js",

  "vendor/couchapp/jquery.evently.js",

  "vendor/couchapp/jquery.mobile-<span class="number">1.0</span>a2.js",

  "vendor/couchapp/jquery.tmpl.js",

  "script/command_queue.js",

  "script/jquery.albums.app.js",

  "script/jquery.albums.loginDialog.js"

]</span>);</code></pre>
<p>We’ve just added the last three files we have been working on: the <em>command_queue</em> script and our <strong>$.albums</strong> plugin and <strong>loginDialog</strong> widget. Now we’re going to make some modifications to the inline script on our <em>index.html</em> document. In a <a href="http://custardbelly.com/blog/?p=332">previous article</a> we hooked up the saving of a new album document to the internal <a href="http://jquerymobile.com/">jQuery Mobile</a> <strong>addAlbum</strong> page, and were using the <em>jquery.couch</em> plugin directly to save the document. Now we are just going to go through our <strong>$.albums</strong> plugin to perform that action which will open the <strong>loginDialog</strong> if a session is currently not available on our client. Open the <em>/_attachments/index.html</em> file in your favorite editor and save the following modifications in the <em>handleDocumentReady</em>() function:</p>
<p><em>/attachments/index.html</em></p>
<pre><code>function handleDocumentReady()

{

    $(<span class="string">"#home"</span>)<span class="preprocessor">.bind</span>( <span class="string">"pagebeforeshow"</span>, refreshAlbums )<span class="comment">;</span>

    refreshAlbums()<span class="comment">;</span>



    // <span class="keyword">Set</span> database reference <span class="keyword">and</span> dialog template on albums.

    $<span class="preprocessor">.extend</span>( $<span class="preprocessor">.albums</span>, {

        database: $db,

        dialog:  $(<span class="string">"#loginSignupDialog"</span>)<span class="preprocessor">.tmpl</span>()

    })<span class="comment">;</span>



    $(<span class="string">"#addSubmitButton"</span>)<span class="preprocessor">.live</span>( <span class="string">"click"</span>, function( event ) {

        event<span class="preprocessor">.preventDefault</span>()<span class="comment">;</span>

        var document = {}<span class="comment">;</span>

        document<span class="preprocessor">.artist</span> = $(<span class="string">"input#addArtistField"</span>)<span class="preprocessor">.val</span>()<span class="comment">;</span>

        document<span class="preprocessor">.title</span> = $(<span class="string">"input#addTitleField"</span>)<span class="preprocessor">.val</span>()<span class="comment">;</span>

        document<span class="preprocessor">.description</span> = $(<span class="string">"textarea#addDescriptionField"</span>)<span class="preprocessor">.val</span>()<span class="comment">;</span>

        document<span class="preprocessor">.creation</span>_date = ( new Date() )<span class="preprocessor">.getTime</span>()<span class="comment">;</span>

        $<span class="preprocessor">.albums</span><span class="preprocessor">.saveDocument</span>( document, {

            success: function() {

                $<span class="preprocessor">.mobile</span><span class="preprocessor">.changePage</span>( <span class="string">"#home"</span>, <span class="string">"slidedown"</span>, true, true )<span class="comment">;</span>

            },

            error: function( status, error, reason ) {

                alert( <span class="string">"Cannot save new document.\n"</span> + status + <span class="string">", "</span> + reason + <span class="string">", "</span> + error )<span class="comment">;</span>

            }

        })<span class="comment">;</span>

        return false<span class="comment">;</span>

    })<span class="comment">;</span>



    $(<span class="string">"#addAlbum"</span>)<span class="preprocessor">.bind</span>( <span class="string">"pagehide"</span>, function() {

        $(<span class="string">"input#addArtistField"</span>)<span class="preprocessor">.val</span>( <span class="string">""</span> )<span class="comment">;</span>

        $(<span class="string">"input#addTitleField"</span>)<span class="preprocessor">.val</span>( <span class="string">""</span> )<span class="comment">;</span>

        $(<span class="string">"textarea#addDescriptionField"</span>)<span class="preprocessor">.val</span>( <span class="string">""</span> )<span class="comment">;</span>

    })<span class="comment">;</span>

}</code></pre>
<p>Not that much to change. First we assign the default properties for the dialog <strong>template</strong> and database reference for our <strong>$.albums</strong> plugin and then we replace the call to save the document using <em>jquery.couch</em> to that of our <strong>$.albums</strong> plugin. Ta-da! Now we can add new documents as a logged in user.</p>
<p>There is, however, two more places that we need to interact with our <strong>$.albums</strong> plugin: the <strong>edit</strong> page and the <strong>delete</strong> page. Without modifying those and with the new authorization and validation we have introduced, we’d only be able to create and read documents… </p>
<p><em>Oh nos! There are tons of albums that i entered in late at night in a different state of mind! I am second guessing my decision on wanting <strong>Hall &amp; Oates</strong>‘</em> War Babies! </p>
<p>These are the type of exclamations i am assuming are going through your head… because i would never…</p>
<h2 id="album-delete-and-album-edit">album-delete and album-edit</h2>
<p>If you go way back in this article series and have been following along, you may remember that we create quasi-view controllers for our <a href="http://couchapp.org/page/index">couchapp</a> <strong>template</strong> pages and included the as <strong>partials</strong> in the <strong>show function</strong>. There are two that we need to modify with our recent changes to using the <strong>$.albums</strong> plugin to verify session: <em>/_attachments/script/album-delete-dialog.js</em> and <em>/_attachments/script/album-edit-page.js</em>. They will be small changes, but once deployed will give our application a little more security on who can perform modifications on <strong>album</strong> documents.</p>
<p>Open up <em>/_attachments/script/album-delete-dialog.js</em> in your favorite editor and save the following change to the <em>handleDelete</em>() function:</p>
<p><em>/_attachments/script/album-delete-dialog.js</em></p>
<pre><code>function handleDelete( event )

{

    event<span class="preprocessor">.preventDefault</span>()<span class="comment">;</span>

    var docId = $(<span class="string">"#dialogContent"</span>)<span class="preprocessor">.data</span>(<span class="string">"identity"</span>)<span class="comment">;</span>

    // First open doc based on ID <span class="keyword">in</span> order to get full document.

    $db<span class="preprocessor">.openDoc</span>( docId, {

        success: function( document ) {

            // Then use the opened doc as reference to remove.

            $<span class="preprocessor">.albums</span><span class="preprocessor">.deleteDocument</span>( document, {

                success: function() {

                    $<span class="preprocessor">.mobile</span><span class="preprocessor">.changePage</span>( <span class="string">"#home"</span>, <span class="string">"slide"</span>, true, true )<span class="comment">;</span>

                },

                error: function() {

                    alert( <span class="string">"Could not remove document with id: "</span> + docId )<span class="comment">;</span>

                }

            })<span class="comment">;</span>

        },

        error: function() {

            alert( <span class="string">"Could not find document with id: "</span> + docId )<span class="comment">;</span>

        }

    })<span class="comment">;</span>

    return false<span class="comment">;</span>

}</code></pre>
<p>Open up <em>/_attachments/script/album-edit-page.js</em> in your favorite editor and save the following change to <em>saveDocument</em>():</p>
<p><em>/_attachments/script/album-edit-page.js</em></p>
<pre><code><span class="function"><span class="keyword">function</span> <span class="title">saveDocument</span><span class="params">( document )</span></span>

<span class="cell">{

    $.albums.saveDocument( document, {

        success: function( response )  {

            updateEditableAlbum( document );

            navigateToAlbumPage( document._id );

        }</span>,

        error: <span class="keyword">function</span>( status, error, reason ) <span class="cell">{

            alert( "Cannot save document: " + document._id + "\n" + reason );

        }</span>

    });

}</code></pre>
<p>That’s all! basically moved away from actions through the reference to our <strong>albums</strong> database to using the <strong>$.albums</strong> plugin. Finally. Now let’s push all this to our <a href="http://couchdb.apache.org/">CouchDB</a> instance so we can play around with it.</p>
<h2 id="deployment">Deployment</h2>
<p>If you remember from the last article when we introduced authorization, we need to pass our credentials when we push our couchapp to the <a href="http://couchdb.apache.org/">CouchDB</a> instance:</p>
<pre><code><span class="title">couchapp</span> push albums <span class="url">http://toddanderson:admin123@127.0.0.1:5984/albums</code></pre>
<p>You’ll will have to replace to username and password, but once we have pushed we can now checkout our application at <a href="http://127.0.0.1:5984/albums/_design/albums/index.html"><a href="http://127.0.0.1:5984/albums/_design/albums/index.html">http://127.0.0.1:5984/albums/_design/albums/index.html</a></a>. If you visit your application and try to either add, edit or delete a document and have not previously logged in, you will see something on the following:</p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_7_2_2.png" alt="Log In"><br><em>[Log In]</em></p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_7_2_1.png" alt="Log In"><br><em>[Sign Up]</em></p>
<h2 id="conclusion">Conclusion</h2>
<p>We have come a long way! We now have authorization and user validation in our <a href="http://jquerymobile.com/">jQuery Mobile</a> <strong>albums</strong> application ensuring that a user must be logged in to create a new <strong>album</strong> document and that the owner of a document is the only one that can make modifications or delete the document from the database. Fun stuff.</p>
<p>I think this is going to be the last article of this series. Of course if this application were to go live, it would need a lot more work. For instance, the ability to log in and log out persisted on every page and information about who is logged in, etc. – but i will leave that up to you if you want to keep going. Hope you had fun and gleaned some useful information that i hope is not misleading.</p>
<p>Thanks again if you have actually took the time to follow along in this series. I am truly humbled if you sat through it all.</p>
<p>Cheers!</p>
<p><em>[Note] This post was written against the following software versions:</em><br><strong>CouchDB </strong>– 1.0.1<br><strong>CouchApp</strong> – 0.7.2<br><strong>jQuery</strong> – 1.4.4<br><strong>jQuery Mobile</strong> – 1.0a2<br><strong>jQuery Templates Plugin</strong> 1.0.0pre<br><em>If you have found this post and any piece has moved forward, hopefully the examples are still viable/useful. I will not be updating the examples in this post in parellel with updates to any of the previously mentioned software, unless explicitly noted.</em></p>
<p><strong>Articles in this series:</strong></p>
<ol>
<li><a href="http://custardbelly.com/blog/?p=244">Getting Started</a></li>
<li><a href="http://custardbelly.com/blog/?p=278">Displaying a page detail of a single album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=297">Templates and Mustache</a></li>
<li><a href="http://custardbelly.com/blog/?p=318">Displaying an editable page of an album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=332">Creating and Adding an album document.</a></li>
<li><a href="http://custardbelly.com/blog/?p=344">Deleting an album document</a></li>
<li><a href="http://custardbelly.com/blog/?p=360">Authorization and Validation – Part 1</a></li>
<li><a href="http://custardbelly.com/blog/?p=394">Authorization and Validation – Part 2</a></li>
</ol>
<p><a href="http://custardbelly.com/downloads/couchapp/jqm_couchdb_albums.zip">Full source for albums couchapp available here</a></p>
<p>Posted in <a href="http://custardbelly.com/blog/category/couchdb/">CouchDB</a>, <a href="http://custardbelly.com/blog/category/jquery/">jquery</a>, <a href="http://custardbelly.com/blog/category/jquery-mobile/">jquery-mobile</a>.</p>

  </section>
  <section class="navigation">
      
        <span class="newer"><a href="http://custardbelly.com/blog/blog-posts/2011/06/15/flash-and-the-city-jquery-mobile/index.html">&#8672;&nbsp;newer</a></span>
      
      
        <span class="older"><a href="http://custardbelly.com/blog/blog-posts/2011/03/04/jquery-mobile-couchdb-part-7-1-authorization-and-validation/index.html">older&nbsp;&#8674;</a></span>
      
    </section>
  <section class="comments">
    
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        window.disqus_identifier="";
        window.disqus_url="http://custardbelly.com/blog/blog-posts/2011/03/04/jquery-mobile-couchdb-part-7-2-authorization-and-validation/index.html";
        window.disqus_title="jQuery Mobile + CouchDB: Part 7.2 – Authorization and Validation";
      </script>
        <script type="text/javascript" src="http://disqus.com/forums/custardbelly/embed.js"></script>
        <noscript><a href="http://custardbelly.disqus.com/?url=ref">View the discussion thread.</a></noscript>
    
  </section>
</article>

    <footer>
      Copyright Todd Anderson, 2014.
      <div>Icon made by <a href="http://www.flaticon.com/free-icon/google-plus-symbol-in-a-circle_24171" title="Icomoon">Icomoon</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a></div>
      <div>Icon made by <a href="http://www.flaticon.com/free-icon/social-rss-circle-internet_10010" title="Elegant Themes">Elegant Themes</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a></div>
    </footer>
    <script src="http://custardbelly.com/blog/lib/highlight/highlight.pack.js"></script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-29061897-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </body>
</html>
