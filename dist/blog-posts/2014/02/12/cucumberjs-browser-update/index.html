<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <meta content="width=device-width, initial-scale=1, user-scalable=no" name="viewport">
    <meta name="description" content="Todd Anderson makes things for web, mobile, desktop and land with a passion of application architecture and development workflows.">
    <meta name="keywords" content="todd anderson, anderson, programmer, developer, architect, engineer, software, software development, programming, application, ria, architecture, javascript, html5, css, web, mobile, desktop, arduino, actionscript, flex, flash, python">
    <link rel="stylesheet" type="text/css" href="http://custardbelly.com/blog/style/main.css" media="all" />
    <link rel="stylesheet" type="text/css" href="http://custardbelly.com/blog/lib/highlight/styles/github.css" media="all" />
    <link rel="alternate" type="application/rss+xml" title="Todd Anderson - feed" href="http://custardbelly.com/blog/index.xml" />
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Playfair+Display">
    <title>Todd Anderson - BDD in JavaScript V: CucumberJS and The Browser, II</title>
  </head>
  <body>
    <header>
      <h1><a class="header-link" href="http://custardbelly.com/blog/">Todd Anderson</a></h1>
      <h2>I make things for the web, mobile, desktop and land.</h2>
      <ul id="media-list">
        <li>
          <a href="http://custardbelly.com/blog/index.xml">
            <img src="http://custardbelly.com/blog/asset/social70.svg" onerror="this.src=http://custardbelly.com/blog/asset/social70.png" width="32" height="32">
          </a>
        </li>
        <li>
          <a href="http://twitter.com/_toddanderson_">
            <img src="http://custardbelly.com/blog/asset/twitter12.svg" onerror="this.src=http://custardbelly.com/blog/asset/twitter12.png" width="32" height="32">
          </a>
        </li>
        <li>
          <a href="https://github.com/bustardcelly">
            <img src="http://custardbelly.com/blog/asset/github7.svg" onerror="this.src=http://custardbelly.com/blog/asset/github7.png" width="32" height="32">
          </a>
        </li>
        <li>
          <a href="https://plus.google.com/113716114429928674625/posts">
            <img src="http://custardbelly.com/blog/asset/google21.svg" onerror="this.src=http://custardbelly.com/blog/asset/google21.png" width="32" height="32">
          </a>
        </li>
        <li>
          <a href="http://lnkd.in/6GCvvR">
            <img src="http://custardbelly.com/blog/asset/linkedin2.svg" onerror="this.src=http://custardbelly.com/blog/asset/linkedin2.png" width="32" height="32">
          </a>
        </li>
      </ul>
    </header>
    <nav>
      <a href="http://custardbelly.com/blog/">home</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="http://custardbelly.com/blog/archive.html">archives</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href="http://custardbelly.com/blog/blog-pages/about.html">about</a>
    </nav>

    <article class="post">
  <div class="title">
    <h1><a href="http://custardbelly.com/blog/blog-posts/2014/02/12/cucumberjs-browser-update/index.html">BDD in JavaScript V: CucumberJS and The Browser, II</a></h1>
    <p>
      2014 February 12th
      
        by todd anderson
      
    </p>
  </div>
  <section>
    <p><em>&quot;Whoa. Whoa. Whoa. You can&#39;t just use roman numerals all over the place in your post titles...&quot;</em></p>
<p>In the <a href="http://custardbelly.com/blog/blog-posts/2014/02/10/cucumberjs-tests-browser/index.html">previous article</a> I addressed the available libraries and practices to have your <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> specs running in a browser environment, as well as introduced a new project begun by me: <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a>.</p>
<p>I had originally had the entirety of this post in the previous post, but felt that it was a little bit of information overload. As such, I decided to split them into two posts.</p>
<p>The intent of this article is to address incorporating <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> into our current Grocery List Application example and continue developing features that involve User Interaction with the DOM.</p>
<h3 id="-gt-code">&gt; code</h3>
<p>Supported files related to this and any subsequent posts on this topic will be available at:<br><a href="https://github.com/bustardcelly/cucumberjs-examples"><a href="https://github.com/bustardcelly/cucumberjs-examples">https://github.com/bustardcelly/cucumberjs-examples</a></a></p>
<h2 id="cucumberjs-browser">cucumberjs-browser</h2>
<p>The <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> CLI tool was created to provide a means in which to write my <strong>Features</strong>, <strong>Step Definitions</strong> and support files as I normally would for a project, and bundle them to be run in a browser and provide custom reporting.</p>
<p>First order of business for incorporating the <strong>cucumberjs-browser</strong> tool into the Grocery List applicaiton project we have been working through in this series is to install the tool:</p>
<pre><code><span class="hljs-variable">$npm</span> install <span class="hljs-attribute">-g</span> cucumberjs<span class="hljs-attribute">-browser</span>
</code></pre><p>(you may need to <code>sudo</code>) </p>
<p>That should install the tool and now be accessible from the command line. The <a href="https://github.com/bustardcelly/cucumberjs-browser/blob/master/README.md">README</a> is the best place to find the most up-to-date infromation about the tool, but the general usage is as follows:</p>
<pre><code>$ <span class="hljs-tag">cucumberjs-browser</span> <span class="hljs-attr_selector">[-o outdir]</span> <span class="hljs-attr_selector">[-f format]</span> <span class="hljs-attr_selector">[--tmpl template]</span> <span class="hljs-attr_selector">[--features features]</span>
</code></pre><p>We&#39;ll get into how we will use it with our project and the options in a bit, but before then...</p>
<h2 id="fail-first">Fail first</h2>
<p>In a pervious article in this series, we added an <code>add-item</code> feature that detailed the scenarios of adding and accessible an item from a collection of the Grocery List application. This is still a valid logical feature that normally I would not modify to incorporate User Interaction when incorporating <strong>Features</strong> related to the application being browser-based. Instead, I would create a new <strong>Feature</strong> that details how a User can add and view new item in a browser environment.</p>
<p>Let&#39;s define our spec:</p>
<p><em>/features/add-item-view.feature</em></p>
<pre><code>Feature: Shopper can add <span class="hljs-keyword">and</span> view new <span class="hljs-property">item</span> <span class="hljs-keyword">in</span> Grocery List
  As a shopper using <span class="hljs-keyword">the</span> browser-based app
  I want <span class="hljs-keyword">to</span> add an <span class="hljs-property">item</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">my</span> grocery <span class="hljs-type">list</span> view
  So <span class="hljs-keyword">that</span> I can remember <span class="hljs-keyword">to</span> buy <span class="hljs-keyword">that</span> <span class="hljs-property">item</span> <span class="hljs-keyword">at</span> <span class="hljs-keyword">the</span> grocery store

  Background: Grocery List Application <span class="hljs-keyword">is</span> Open
    Given I have opened <span class="hljs-keyword">the</span> grocery <span class="hljs-type">list</span> <span class="hljs-type">application</span>

  Scenario: Submit <span class="hljs-keyword">of</span> valid <span class="hljs-property">item</span> adds <span class="hljs-property">item</span> <span class="hljs-keyword">to</span> <span class="hljs-type">list</span>
    Given I have an empty grocery <span class="hljs-type">list</span> view
    When I provide a valid grocery <span class="hljs-type">list</span> <span class="hljs-property">item</span> <span class="hljs-property">name</span>
    And I select <span class="hljs-keyword">to</span> add an <span class="hljs-property">item</span>
    Then The <span class="hljs-property">item</span> <span class="hljs-keyword">is</span> added <span class="hljs-keyword">to</span> <span class="hljs-keyword">the</span> grocery <span class="hljs-type">list</span> view

  Scenario: Submit <span class="hljs-keyword">of</span> valid <span class="hljs-property">item</span> adds <span class="hljs-property">item</span> <span class="hljs-keyword">to</span> collection
    Given I have an empty grocery <span class="hljs-type">list</span> view
    When I provide a valid grocery <span class="hljs-type">list</span> <span class="hljs-property">item</span> <span class="hljs-property">name</span>
    And I select <span class="hljs-keyword">to</span> add an <span class="hljs-property">item</span>
    Then The <span class="hljs-property">item</span> <span class="hljs-keyword">is</span> accessible <span class="hljs-keyword">from</span> <span class="hljs-keyword">the</span> grocery <span class="hljs-type">list</span> collection
</code></pre><p>We have declared two <strong>Scenarios</strong> that define the <strong>Feature</strong> criteria in which a User interacts with DOM elements to add and view a new item to the Grocery List application.</p>
<p>Running that produces the expected <code>undefined</code> steps notification:</p>
<pre><code>$ npm run test
<span class="hljs-preprocessor">.UUU</span><span class="hljs-preprocessor">.UUUU</span><span class="hljs-preprocessor">.UUUU</span>........

<span class="hljs-number">4</span> scenarios (<span class="hljs-number">2</span> undefined, <span class="hljs-number">2</span> passed)
<span class="hljs-number">21</span> steps (<span class="hljs-number">10</span> undefined, <span class="hljs-number">11</span> passed)
</code></pre><h3 id="given-i-have-an-empty-grocery-list-view">Given I have an empty grocery list view</h3>
<p>We have a few things we need to address, but before we get into the nitty-gritty, let&#39;s turn this <span style="color:red;">red</span> in true TDD fashion while filling out our API expectation of the <em>Given</em> in each of the <strong>Scenarios</strong></p>
<p><em>/features/step_definitions/add-item-view.steps.js</em></p>
<pre><code><span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>);

module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
<span class="hljs-pi">  'use strict'</span>;

  <span class="hljs-keyword">this</span>.World = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../support/world'</span>).World;

  <span class="hljs-keyword">this</span>.Given(<span class="hljs-regexp">/^I have an empty grocery list view$/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
    <span class="hljs-keyword">this</span>.emptyGroceryListView();
    assert.equal(<span class="hljs-keyword">this</span>.getGroceryListView().childNodes.length, <span class="hljs-number">0</span>);
    callback();
  });

});
</code></pre><pre><code>$ npm run test
.F.F.F........

(::) failed steps (::)
<span class="hljs-keyword">...</span>
Failing scenarios:
/Users/toddanderson/Documents/workspace/custardbelly/cucumberjs-example/features/add-item-view.feature:<span class="hljs-number">9</span> <span class="hljs-comment"># Scenario: Select of Add Item opens input</span>
/Users/toddanderson/Documents/workspace/custardbelly/cucumberjs-example/features/add-item-view.feature:<span class="hljs-number">14</span> <span class="hljs-comment"># Scenario: Submit of valid item adds item to list</span>
/Users/toddanderson/Documents/workspace/custardbelly/cucumberjs-example/features/add-item-view.feature:<span class="hljs-number">20</span> <span class="hljs-comment"># Scenario: Submit of valid item adds item to collection</span>

<span class="hljs-number">5</span> scenarios (<span class="hljs-number">3</span> failed, <span class="hljs-number">2</span> passed)
<span class="hljs-number">22</span> steps (<span class="hljs-number">3</span> failed, <span class="hljs-number">8</span> skipped, <span class="hljs-number">11</span> passed)
</code></pre><p>Huge explosion. Red everywhere. Dogs and cats, living together. Mass hysteria.</p>
<p>That&#39;s good, we expect the world to crash with nothing to support our claims of an &quot;empty grocery list view&quot;. What does that even mean in the current context? We haven&#39;t even a web page to view our Grocery List. These all are issues we need to address in resolving just this single <strong>Step Definition</strong>.</p>
<h2 id="client-side-script">Client-Side Script</h2>
<p>This is a good point to discuss the client-side script that will act as our main entry point for the browser-based Grocery List Application. </p>
<p>If you have been following along with the examples in this series, we have been slowly building up specs for our Grocery List Application, yet it has been done so while testing under the <a href="http://nodejs.org">Node</a>-based <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> CLI tool. Nothing wrong with that, and in fact we have a good starting point in which we can ensure that a proper collection model is maintained with regards to adding and accessing items.</p>
<p>However, now we are moving to a browser environment and need to address how we will load and interact with our application within the browser context. Because we have been developing node modules (to be tested under CucumberJS specs) which utilize the <a href="http://wiki.commonjs.org/wiki/Modules/1.1">CommonJS module format</a> we can easily bundle our scripts for the browser using the wonderful <a href="http://browserify.org/">browserify</a> tool.</p>
<p><em>Disclaimer: Hats off to <a href="http://benclinkinbeard.com/">Ben Clinkenbeard</a> for finally persuading me to look into <a href="http://browserify.org/">browserify</a> over my years-long obsession with <a href="http://requirejs.org/">RequireJS</a>.</em></p>
<h3 id="browserify">Browserify</h3>
<p>It is too much for this article to address <a href="http://browserify.org/">browserify</a> and its history and attributes. There are several articles that are google-able that explain what <strong>browserify</strong> is, how to use it, and its virtues and disadvantages over AMD. I implore you to check them out and make a sound judgement as it relates to your team and project requirements.</p>
<p>That said, I have found <a href="http://browserify.org/">browserify</a> extremely beneficial and am going to use it for the examples in this series in delivering the client-side scripts.</p>
<p>First order of business is to install <strong>browserify</strong> as you would any project-local node module:</p>
<pre><code><span class="hljs-variable">$ </span>npm install browserify
</code></pre><p>Now we need to define how we want our module to be bundled for the browser. If we are talking a single entry point - which most main files are - I prefer to define a global name to assign our module so it is easily accessible on the DOM. Keeping in mind that we are primarily bundling our code so we can do TDD, we define an proper output directory that won&#39;t get mixed up with our distribution:</p>
<pre><code>$ mkdir test/script &amp;&amp; \
  node node_modules/<span class="hljs-preprocessor">.bin</span>/browserify script/app<span class="hljs-preprocessor">.js</span> -o test/script/app<span class="hljs-preprocessor">.js</span> -s grocerylist
</code></pre><p>With that command, we created the output directory for our main file - <code>app.js</code> - and bundled the <em>script/app.js</em> file with any dependencies (which currently were only <em>script/model/grocery-list.js</em>). As well, our module is accessible on the <code>window</code> object as <code>grocerylist</code>.</p>
<h2 id="index-file">Index File</h2>
<p>So we have our bundled scripts and an exposed entry to our application through <code>window.grocerylist</code>, and now we need a way to access and view the application - an html file.</p>
<p>Because we will be using the <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> tool to bundle our features and specs to be run under a browser environment, we will copy and modify the default template shipped with that tool to suit our needs for our application.</p>
<p>At this stage, we are simply going to add a <code>script</code> tag for our application bundle we created in the previous section:</p>
<p><em>template/testrunner.html</em></p>
<pre><code><span class="hljs-doctype">&lt;!doctype html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">http-equiv</span>=<span class="hljs-value">"Content-Type"</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">"text/html;charset=utf-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"lib/cucumber.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"features.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
    <span class="vbscript">&lt;% _.<span class="hljs-keyword">each</span>(modules, <span class="hljs-keyword">function</span>(module) { %&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"&lt;%= module.filepath %&gt;"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
    <span class="vbscript">&lt;% }); %&gt;</span>
    <span class="vbscript">&lt;% <span class="hljs-keyword">if</span>(listener.exists) { %&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"script/&lt;%= listener.filename %&gt;"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
    <span class="vbscript">&lt;% }; %&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="javascript">
      (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(window)</span> {</span>

        <span class="hljs-comment">// Need to concat all *.features &gt; browserify.standalone = cukefeatures</span>
        <span class="hljs-keyword">var</span> features = window.cukefeatures.split(<span class="hljs-string">'&amp;crarr'</span>).join(<span class="hljs-string">'\n'</span>);

        <span class="hljs-comment">// Need to concat all support + step_definitions, and export as a function</span>
        <span class="hljs-keyword">var</span> support = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
          <span class="hljs-keyword">this</span>.Given = <span class="hljs-keyword">this</span>.When = <span class="hljs-keyword">this</span>.Then = <span class="hljs-keyword">this</span>.defineStep;
          <span class="hljs-comment">// Would be put on window if /support/world found.</span>
          <span class="hljs-keyword">if</span>(<span class="hljs-string">'world'</span> <span class="hljs-keyword">in</span> window) {
            <span class="hljs-keyword">this</span>.World = window[<span class="hljs-string">'world'</span>].World;
          }
          &lt;% _.each(steps, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(step)</span> {</span> %&gt;
          window[<span class="hljs-string">'&lt;%= step.name %&gt;'</span>].call(<span class="hljs-keyword">this</span>);
          <span class="xml"><span class="vbscript">&lt;% }); %&gt;</span>
        };

        var runtime = Cucumber(features, support);
        <span class="vbscript">&lt;% <span class="hljs-keyword">if</span>(listener.exists) { %&gt;</span>
        runtime.attachListener(window.cukelistener.instance());
        <span class="vbscript">&lt;% }; %&gt;</span>
        runtime.start(function(){
          <span class="vbscript">&lt;% <span class="hljs-keyword">if</span>(listener.exists) { %&gt;</span>
          window.cukelistener.instance().complete();
          <span class="vbscript">&lt;% } <span class="hljs-keyword">else</span> { %&gt;</span>
          console.log(Array.prototype.slice.call(arguments));
          <span class="vbscript">&lt;% }; %&gt;</span>
        });
      }(window));
    </span></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"./script/app.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span>
</code></pre><p>Most of what is in this page template is copied from the <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> project. The only addition - at this point - is the script appended within the <code>body</code> that will load our app bundle.</p>
<p>If we were to run the <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> tool and generate our bundled app, specs and template:</p>
<pre><code>$ cucumberjs<span class="hljs-attribute">-browser</span> <span class="hljs-attribute">-o</span> test <span class="hljs-subst">--</span>tmpl template/testrunner<span class="hljs-built_in">.</span>html <span class="hljs-attribute">-f</span> tap
</code></pre><p>That will generate the JavaScript bundle files for the <strong>Features</strong>, <strong>Step Definitions</strong> and support files we have been creating and curating in this series, along with the templated HTML file with our resources defined and place them in a <em>/test</em> directory.</p>
<p>If we were to open that HTML file - <em>/test/cucumberjs-testrunner.html</em> - and opened the Console of our developer tools, we would see a <a href="http://en.wikipedia.org/wiki/Test_Anything_Protocol">TAP</a> report of our test... <span style="color: red;">failing</span> :)</p>
<p>If we were to change the format option:</p>
<pre><code>$ cucumberjs<span class="hljs-attribute">-browser</span> <span class="hljs-attribute">-o</span> test <span class="hljs-subst">--</span>tmpl template/testrunner<span class="hljs-built_in">.</span>html <span class="hljs-attribute">-f</span> ui
</code></pre><p>We would see those same <span style="color:red;">failing</span> tests, but this time on the DOM.</p>
<div style="width: 100%; overflow-x: scroll; background-color:#fff; text-align: center;">
  <img src="http://custardbelly.com/blog/images/cucumberjs-browser-2.png" alt="cucumberjs in the browser, failing">
</div>

<p>We have gone from failing on the command line to failing in the browser... isn&#39;t it glorious :)</p>
<h2 id="automate-all-the-things">Automate all the things</h2>
<p>We had <a href="http://custardbelly.com/blog/blog-posts/2014/01/29/cucumberjs-build/index.html">previously automated our testing</a> under the node-based environment; it was a simple as setting up a file watcher and issuing a command to run the <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> CLI tool on change.</p>
<p>Our process has now become a little more involved, but not anything too complex (<em>thanks to the wonderful <a href="https://www.npmjs.org/">npm</a> community!</em>) that an automated build and test procedure couldn&#39;t be implemented. The only difference is that feedback will now reside in the DOM and/or Console of a browser - so instead of coding in an editor and watching it fail on the command line, we are now going to need to focus on failures reported in the browser as we TDD.</p>
<h3 id="watch-script">watch script</h3>
<p>Just as we had done in a <a href="http://custardbelly.com/blog/blog-posts/2014/01/29/cucumberjs-build/index.html">previous article</a>, we are going to create a new script that will essentially do the following:</p>
<ol>
<li>start a livereload server</li>
<li>start a local server to serve the testrunner</li>
<li>launch the testrunner in a browser</li>
<li>bundle the app and run the cucumberjs-browser tool</li>
<li>watch and reload the testrunner in the browser on change to source files</li>
</ol>
<p>To accomplish this task, we are going to use a couple more npm modules; in particular:</p>
<ol>
<li><a href="https://github.com/mklabs/tiny-lr">tiny-lr</a></li>
<li><a href="https://github.com/senchalabs/connect">connect</a></li>
<li><a href="https://github.com/jjrdn/node-open">open</a></li>
</ol>
<p>I invite you to go check each of those projects out as I won&#39;t go into much detail about each of them in this article. It should be noted, however, that you will need to install the <a href="http://livereload.com/">LiveReload</a> <a href="http://feedback.livereload.com/knowledgebase/articles/86242-how-do-i-install-and-use-the-browser-extensions-">browser extension(s)</a> in order to properly use the <code>watch</code> script:</p>
<p><em>cuke-browser-watcher.js</em></p>
<pre><code>#!<span class="hljs-regexp">/usr/</span>bin/env node
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> watch = <span class="hljs-built_in">require</span>(<span class="hljs-string">'node-watch'</span>);
<span class="hljs-keyword">var</span> child_process = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>);
<span class="hljs-keyword">var</span> mkdirp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mkdirp'</span>);
<span class="hljs-keyword">var</span> browserify = <span class="hljs-built_in">require</span>(<span class="hljs-string">'browserify'</span>);

<span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);
<span class="hljs-keyword">var</span> tinylr = <span class="hljs-built_in">require</span>(<span class="hljs-string">'tiny-lr'</span>);
<span class="hljs-keyword">var</span> connect = <span class="hljs-built_in">require</span>(<span class="hljs-string">'connect'</span>);
<span class="hljs-keyword">var</span> open = <span class="hljs-built_in">require</span>(<span class="hljs-string">'open'</span>);
<span class="hljs-keyword">var</span> S = <span class="hljs-built_in">require</span>(<span class="hljs-string">'string'</span>);

<span class="hljs-keyword">var</span> outdir = <span class="hljs-string">'test'</span>;
<span class="hljs-keyword">var</span> browserCukes;

<span class="hljs-keyword">var</span> livereloadPort = <span class="hljs-number">35729</span>;
<span class="hljs-keyword">var</span> connectPort = <span class="hljs-number">8080</span>;
<span class="hljs-keyword">var</span> JS_EXT = <span class="hljs-regexp">/^.*\.js/i</span>;
<span class="hljs-keyword">var</span> options = [<span class="hljs-string">'-f'</span>, <span class="hljs-string">'ui'</span>,
               <span class="hljs-string">'-o'</span>, outdir,
               <span class="hljs-string">'--tmpl'</span>, <span class="hljs-string">'template/testrunner.html'</span>];

<span class="hljs-comment">// [TASKS]</span>
<span class="hljs-comment">// a. re-bundle the app.</span>
<span class="hljs-keyword">var</span> bundleApplication = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f, callback)</span> {</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    browserify(__dirname + <span class="hljs-string">'/script/app.js'</span>)
      .bundle({
        standalone: <span class="hljs-string">'app'</span>
      })
      .pipe(fs.createWriteStream(path.resolve(outdir + <span class="hljs-string">'/script/app.js'</span>)))
      .on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        console.log(<span class="hljs-string">'changed app.js...'</span>);
        <span class="hljs-keyword">if</span>(callback) {
          callback();
        }
      });
  };
};
<span class="hljs-comment">// b. rerun cucumberjs-browser tool.</span>
<span class="hljs-keyword">var</span> cuke = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f, callback)</span> {</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> filename = S(path.basename(f, <span class="hljs-string">'.js'</span>).split(<span class="hljs-string">'.'</span>).join(<span class="hljs-string">'-'</span>)).camelize().s;
    browserCukes = child_process.spawn(<span class="hljs-string">'cucumberjs-browser'</span>, options)
      .on(<span class="hljs-string">'exit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        console.log(<span class="hljs-string">'changed '</span> + filename + <span class="hljs-string">'...'</span>);
        <span class="hljs-keyword">if</span>(callback) {
          callback();
        }
      });
  };
};

<span class="hljs-comment">// 1. Recursive mkdir /test/script if not exist.</span>
mkdirp.sync(outdir + <span class="hljs-string">'/script'</span>);

<span class="hljs-comment">// 2. Create tiny-livereload server.</span>
<span class="hljs-keyword">var</span> lr = tinylr();
lr.listen(livereloadPort, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  console.log(<span class="hljs-string">'livereload listening on '</span> + livereloadPort + <span class="hljs-string">'...'</span>);
});

<span class="hljs-comment">// 3. Start server on localhost.</span>
<span class="hljs-keyword">var</span> app = connect().use(connect.static(__dirname + <span class="hljs-string">'/test'</span>));
<span class="hljs-keyword">var</span> server = http.createServer(app).listen(connectPort, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  console.log(<span class="hljs-string">'local server started on '</span> + connectPort + <span class="hljs-string">'...'</span>);
  console.log(<span class="hljs-string">'Note: Remember to start the livereload browser extension!'</span>);
  console.log(<span class="hljs-string">'http://feedback.livereload.com/knowledgebase/articles/86242-how-do-i-install-and-use-the-browser-extensions-'</span>);
  cuke(<span class="hljs-string">'./features/support/world'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    bundleApplication(<span class="hljs-string">'./script/app.js'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      open(<span class="hljs-string">'http://localhost:'</span> + connectPort + <span class="hljs-string">'/cucumber-testrunner.html'</span>);  
    })();
  })();
});

<span class="hljs-comment">// 4. Watch source and generate bundles.</span>
watch([<span class="hljs-string">'./features'</span>, <span class="hljs-string">'./script'</span>], {recursive:<span class="hljs-literal">true</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(filename)</span> {</span>
  <span class="hljs-comment">// Used to resolve when running operation(s) are complete.</span>
  <span class="hljs-keyword">var</span> resolver;
  <span class="hljs-keyword">var</span> running = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> resolveWatch = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(limit)</span> {</span>
    <span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span>;
    running = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">if</span>(++count === limit) {
        count = <span class="hljs-number">0</span>;
        running = <span class="hljs-literal">false</span>;
      }
      <span class="hljs-keyword">else</span> {
        running = <span class="hljs-literal">true</span>;
      }
    };
  };

  <span class="hljs-keyword">if</span>(!running &amp;&amp; filename.match(JS_EXT)) {
    <span class="hljs-keyword">var</span> bundleAppInvoke = bundleApplication(filename, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      lr.changed({
        body: {
          files: [<span class="hljs-string">'script/app'</span>]
        }
      });
      resolver();
    });
    <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/^script?/i</span>.test(filename)) {
      resolver = resolveWatch(<span class="hljs-number">1</span>);
      bundleAppInvoke();
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/^features?/i</span>.test(filename)) {
      resolver = resolveWatch(<span class="hljs-number">2</span>);
      cuke(filename, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        lr.changed({
          body: {
            files: [filename]
          }
        });
        resolver();
        bundleAppInvoke();
      })();
    }
  }

});
</code></pre><p>This <code>watch</code> script is very similar to the one we created previously. Aside from moving the bundler tasks outside of the <code>watch()</code>, the main difference is that we now start a <code>tiny-livereload</code> server and <code>http</code> server running on port 8080 before starting the <code>watch</code> task.</p>
<p>Running this will also automatically launch the testrunner in your default browser. It is important to note that, in order for the reload on file change to work, you must enable the <a href="http://livereload.com/">LiveReload</a> <a href="http://feedback.livereload.com/knowledgebase/articles/86242-how-do-i-install-and-use-the-browser-extensions-">browser extension for that browser</a>.</p>
<p>As we have done before, we can add this to our package <code>scripts</code>:</p>
<p><em>package.json</em></p>
<pre><code>{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"cucumberjs-examples"</span>,
<span class="hljs-keyword">...</span>
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"test"</span>: <span class="hljs-string">"node node_modules/.bin/cucumber-js"</span>,
    <span class="hljs-string">"watch"</span>: <span class="hljs-string">"node cuke-watcher.js"</span>,
    <span class="hljs-string">"watch-browser"</span>: <span class="hljs-string">"node cuke-browser-watcher"</span>
  }
<span class="hljs-keyword">...</span>
}
</code></pre><p>Open up the terminal and enter the following command:</p>
<pre><code><span class="hljs-variable">$ </span>npm run watch-browser
</code></pre><p>... and we are all set to keep TDD&#39;ing with an automated <code>watch</code> script that will reload the browser on change to our step definitions and application source files!</p>
<h2 id="back-to-passing">Back to Passing</h2>
<p>We side-stepped our development to address a few key issues: bundling scripts for the browser and automating tests against <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a>. With our <code>watch</code> script up and running, we can see we are in the <span style="color:red;">red</span> still - let&#39;s start turning steps <span style="color:green">green</span> :)</p>
<p>First order of business is that our first <strong>Given</strong> step for the Add Item View <strong>Feature</strong> is interfacing with a currently non-existant API on the <strong>World</strong>. We eschewed the need for an additional Web Driver library which would provide a conventient API through a browser facade. At this stage, I think we can reasonably have our <strong>World</strong> provide that API and not need to include more external libraries. </p>
<p><em>It might even be a reasonable discussion that such Web Drivers are not needed at all in such circumstances, but I won&#39;t go there for the moment as that gets into a discussion about integration testing vs unit testing and BDD practice - ie, a can of worms ;)</em></p>
<h3 id="modifying-our-world">Modifying Our World</h3>
<p>Now that we know we are running our tests in the browser, we have access to the global <code>window</code> and can reference the DOM without restriction to running <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> under <a href="http://nodejs.org">node</a>.</p>
<p>Let&#39;s modify our <strong>World</strong> to expose the API we are invoking from our <strong>Given</strong> in the Add Item View __Feature:</p>
<p><em>/features/support/world.js</em></p>
<pre><code><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> World = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">World</span><span class="hljs-params">(callback)</span> {</span>

  <span class="hljs-keyword">this</span>.window = window;
  <span class="hljs-keyword">this</span>.app = window.app;
  <span class="hljs-keyword">this</span>.groceryListApplication = <span class="hljs-literal">undefined</span>;

  <span class="hljs-keyword">this</span>.openGroceryList = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.app.newSession();
  };
  <span class="hljs-keyword">this</span>.createGroceryItem = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'apple'</span>;
  };

  <span class="hljs-keyword">this</span>.emptyGroceryListView = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.app.empty();
  };

  callback();

};

module.exports.World = World;
</code></pre><p>There is actually a quite bit changed from our previous <strong>World</strong>:</p>
<ol>
<li>Removed <code>require()</code> of app module</li>
<li>Added access to <code>app</code> reference on <code>window</code> from our browserified bundle</li>
<li>Changed reference to <code>app</code> that creates a new session</li>
<li>Added <code>emptyGroceryListView</code> method to World</li>
</ol>
<p>So we took the <strong>World</strong> into a browser environment with its referencing the app, but we are still (as expected) failing - this time alerting us to:</p>
<p><span style="color:red;">- Cannot call method &#39;newSession&#39; of undefined at World.openGroceryList</span></p>

<p>which is stemming from our previously defined <strong>Background</strong> step definition:</p>
<pre><code><span class="hljs-keyword">Background</span>: Grocery <span class="hljs-keyword">List</span> Application is <span class="hljs-keyword">Open</span>
  Given <span class="hljs-keyword">I</span> have opened the grocery list application
</code></pre><p>This actually stems from a much larger problem: accessing the the application module on the <code>window</code> before it has finished being loaded by the browser. As such, we will need to modify this step definition to ensure that the DOM has completed load before we can move forward in interactinf with the <strong>World</strong> API that now exposes communication to the DOM.</p>
<p><em>/features/step_definitions/background-open-application.step.js</em></p>
<pre><code><span class="hljs-pi">'use strict'</span>;
<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>);

module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>

  <span class="hljs-keyword">this</span>.World = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../support/world'</span>).World;

  <span class="hljs-keyword">this</span>.Given(<span class="hljs-regexp">/^I have opened the grocery list application$/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
    (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(world)</span> {</span>
      world.domload(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        world.groceryListApplication = world.openGroceryList();
        assert(world.groceryListApplication, <span class="hljs-string">'Grocery List Application is required to be open for editability.'</span>);
        callback();
      });
    }(<span class="hljs-keyword">this</span>));
  });

};
</code></pre><p>Now we are offloading our assertion and callback to the complete of DOM load through the <strong>World</strong> to ensure that we have successfully loaded the application.</p>
<p>This will now fail on <span style="color: red;">- Object #&lt;World&gt; has no method &#39;domload&#39;</span>, so let&#39;s get that fixed up:</p>
<p><em>/features/support/world.js</em></p>
<pre><code><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> World = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">World</span><span class="hljs-params">(callback)</span> {</span>

  <span class="hljs-keyword">this</span>.window = process.browser ? window : {};
  <span class="hljs-keyword">this</span>.app = <span class="hljs-literal">undefined</span>;
  <span class="hljs-keyword">this</span>.groceryListApplication = <span class="hljs-literal">undefined</span>;

  <span class="hljs-keyword">var</span> defineGlobals = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(w, doc)</span> {</span>
    <span class="hljs-keyword">this</span>.app = w.app;
  };

  <span class="hljs-keyword">this</span>.domload = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
    (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(world)</span> {</span>
      <span class="hljs-keyword">if</span>(document.readyState === <span class="hljs-string">'complete'</span>) {
        defineGlobals.call(world, window, document);
        callback();  
      }
      <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> delegate = document.addEventListener ? <span class="hljs-string">'addEventListener'</span> : <span class="hljs-string">'attachEvent'</span>;
        <span class="hljs-keyword">var</span> eventType = document.addEventListener ? <span class="hljs-string">'load'</span> : <span class="hljs-string">'onload'</span>;
        window[delegate](eventType, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
          defineGlobals.call(world, window, document);
          callback();
        });
      }
    }(<span class="hljs-keyword">this</span>));
  };

  <span class="hljs-keyword">this</span>.openGroceryList = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.app.newSession();
  };
  <span class="hljs-keyword">this</span>.createGroceryItem = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'apple'</span>;
  };

  callback();

};

module.exports.World = World;
</code></pre><p>Woohoo! Now we are back with the exception <span style="color: red;">Object #&lt;World&gt; has no method &#39;emptyGroceryListView&#39;</span> that got us in this mess... <em>BUT</em> the previous tests we had <span style="color: green;">passing</span> are now passing again :)</p>
<p>For the sake of getting too &quot;noisy&quot; with code and explanations, for the following edits - unless an explanation is deemed worthy - I will just roll along with modifications to the test and source and show the series of <span style="color: red;">failures</span>.</p>
<p><em>/features/support/world.js</em></p>
<pre><code><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> World = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">World</span><span class="hljs-params">(callback)</span> {</span>

  <span class="hljs-keyword">this</span>.window = process.browser ? window : {};
  <span class="hljs-keyword">this</span>.app = <span class="hljs-literal">undefined</span>;
  <span class="hljs-keyword">this</span>.groceryListApplication = <span class="hljs-literal">undefined</span>;

...

  <span class="hljs-keyword">this</span>.emptyGroceryListView = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.groceryListApplication.empty();
  };

  callback();

};

module.exports.World = World;
</code></pre><p><span style="color: red;">- Object #&lt;World&gt; has no method &#39;empty&#39; at World.emptyGroceryListView</span></p>

<p><em>/script/app.js</em></p>
<pre><code><span class="hljs-keyword">...</span>

var application = {
  init: <span class="hljs-keyword">function</span>(list) {
    this.list = list;
    <span class="hljs-keyword">return</span> this;
  },
  empty: <span class="hljs-keyword">function</span>() {
    this.list.empty();
  }
};

<span class="hljs-keyword">...</span>
</code></pre><p><span style="color: red;">- Object #&lt;World&gt; has no method &#39;getGroceryListView&#39; at World</span></p>

<p><em>/features/support/world.js</em></p>
<pre><code><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> World = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">World</span><span class="hljs-params">(callback)</span> {</span>

  <span class="hljs-keyword">this</span>.window = process.browser ? window : {};
  <span class="hljs-keyword">this</span>.app = <span class="hljs-literal">undefined</span>;
  <span class="hljs-keyword">this</span>.groceryListApplication = <span class="hljs-literal">undefined</span>;

...

  <span class="hljs-keyword">this</span>.getGroceryListView = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.groceryListApplication.$listview;
  };

  callback();

};

module.exports.World = World;
</code></pre><p><span style="color: red;">- Cannot read property &#39;childNodes&#39; of undefined at World</span></p>

<p><em>/script/app.js</em></p>
<pre><code><span class="hljs-keyword">...</span>

var application = {
  init: <span class="hljs-keyword">function</span>(list) {
    this.list = list;
    this.$listview = document.querySelector(<span class="hljs-string">'#grocery-list'</span>);
    <span class="hljs-keyword">return</span> this;
  },
  empty: <span class="hljs-keyword">function</span>() {
    var gl = this.$listview;
    <span class="hljs-keyword">while</span> (gl.hasChildNodes()) {
      gl.removeChild(gl.lastChild);
    }
    this.list.empty();
  }
};

<span class="hljs-keyword">...</span>
</code></pre><p><span style="color: red;">- Cannot read property &#39;childNodes&#39; of null at World</span></p>

<p><em>/template/testrunner.html</em></p>
<pre><code><span class="hljs-doctype">&lt;!doctype html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
    ...
    <span class="hljs-tag">&lt;<span class="hljs-title">ul</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"grocery-list"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"./script/app.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span>
</code></pre><p>And we are back to <span style="color: green;">green</span>!... and <span style="color: rgb(117, 117, 37);">pending</span>. Let&#39;s move on to our next step definition:</p>
<h3 id="when-i-provide-a-valid-grocery-list-item-name">When I provide a valid grocery list item name</h3>
<p><em>/features/step_definitions/add-item-view.steps.js</em></p>
<pre><code><span class="hljs-keyword">...</span>

var enteredItem;

this.Given(/^I have an empty grocery list view$/, <span class="hljs-keyword">function</span>(callback) {
  this.emptyGroceryListView();
  assert.equal(this.getGroceryListView().childNodes.length, <span class="hljs-number">0</span>);
  callback();
});

this.When(/^I provide a valid grocery list item name$/, <span class="hljs-keyword">function</span>(callback) {
  enteredItem = this.createGroceryItem();
  this.enterNewGorceryListItem(enteredItem);
  callback();
});

<span class="hljs-keyword">...</span>
</code></pre><p>Back in the <span style="color: red;">red</span>!  </p>
<p><span style="color: red;">- Object #&lt;World&gt; has no method &#39;enterNewGorceryListItem&#39; at World</span></p>

<p><em>/features/support/world.js</em></p>
<pre><code><span class="hljs-keyword">var</span> World = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">World</span><span class="hljs-params">(callback)</span> {</span>

  <span class="hljs-keyword">this</span>.window = process.browser ? window : {};
  <span class="hljs-keyword">this</span>.app = <span class="hljs-literal">undefined</span>;
  <span class="hljs-keyword">this</span>.groceryListApplication = <span class="hljs-literal">undefined</span>;

  <span class="hljs-keyword">var</span> defineGlobals = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(w, doc)</span> {</span>
    <span class="hljs-keyword">this</span>.app = w.app;
  };

...

  <span class="hljs-keyword">this</span>.enterNewGorceryListItem = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span> {</span>
    <span class="hljs-keyword">this</span>.groceryListApplication.enterNewItem(item);
  };

  callback();

};

module.exports.World = World;
</code></pre><p><span style="color: red;">- Object #&lt;Object&gt; has no method &#39;enterNewItem&#39; at World.enterNewGorceryListItem</span></p>

<p><em>/script/app.js</em></p>
<pre><code><span class="hljs-keyword">...</span>

var application = {
  init: <span class="hljs-keyword">function</span>(list) {
    this.list = list;
    this.$listview = document.querySelector(<span class="hljs-string">'#grocery-list'</span>);
    this.$itemInputView = document.querySelector(<span class="hljs-string">'#item-input'</span>);
    <span class="hljs-keyword">return</span> this;
  },
  empty: <span class="hljs-keyword">function</span>() {
    var gl = this.$listview;
    <span class="hljs-keyword">while</span> (gl.hasChildNodes()) {
      gl.removeChild(gl.lastChild);
    }
    this.list.empty();
  },
  enterNewItem: <span class="hljs-keyword">function</span>(item) {
    this.$itemInputView.value = item;
  }
};

<span class="hljs-keyword">...</span>
</code></pre><p><span style="color: red;">- Cannot set property &#39;value&#39; of null at Object.application.enterNewItem</span></p>

<p><em>/template/testrunner.html</em></p>
<pre><code><span class="hljs-doctype">&lt;!doctype html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
    ...
    <span class="hljs-tag">&lt;<span class="hljs-title">ul</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"grocery-list"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">form</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">label</span> <span class="hljs-attribute">for</span>=<span class="hljs-value">"itemInput"</span>&gt;</span>Item name:<span class="hljs-tag">&lt;/<span class="hljs-title">label</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"item-input"</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"itemInput"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">item</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"./script/app.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span>
</code></pre><p>Back to <span style="color: rgb(117, 117, 37);">pending</span>! Next step:</p>
<h3 id="and-i-select-to-add-an-item">And I select to add an item</h3>
<p><em>/features/step_definitions/add-item-view.steps.js</em></p>
<pre><code><span class="hljs-keyword">...</span>

this.When(/^I select to add an item$/, <span class="hljs-keyword">function</span>(callback) {
  this.clickAddGroceryListItem();
  callback();
});

<span class="hljs-keyword">...</span>
</code></pre><p><span style="color: red;">- Object #&lt;World&gt; has no method &#39;clickAddGroceryListItem&#39; at World.</span></p>

<p><em>/features/support/world.js</em></p>
<pre><code><span class="hljs-keyword">var</span> World = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">World</span><span class="hljs-params">(callback)</span> {</span>

  <span class="hljs-keyword">this</span>.window = process.browser ? window : {};
  <span class="hljs-keyword">this</span>.app = <span class="hljs-literal">undefined</span>;
  <span class="hljs-keyword">this</span>.groceryListApplication = <span class="hljs-literal">undefined</span>;

  <span class="hljs-keyword">var</span> defineGlobals = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(w, doc)</span> {</span>
    <span class="hljs-keyword">this</span>.app = w.app;
  };

...

  <span class="hljs-keyword">this</span>.createClickEvent = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> event = document.createEvent(<span class="hljs-string">'MouseEvents'</span>);
    event.initEvent(<span class="hljs-string">'click'</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);
    <span class="hljs-keyword">return</span> event;
  };

  <span class="hljs-keyword">this</span>.clickAddGroceryListItem = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> clickevent = <span class="hljs-keyword">this</span>.createClickEvent();
    <span class="hljs-keyword">this</span>.groceryListApplication.$addbutton.dispatchEvent(clickevent);
  };

...

  callback();

};

module.exports.World = World;
</code></pre><p><span style="color: red;">- Cannot call method &#39;dispatchEvent&#39; of undefined at World.clickAddGroceryListItem</span></p>

<p><em>/script/app.js</em></p>
<pre><code><span class="hljs-keyword">var</span> application = {
  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(list)</span> {</span>
    this.<span class="hljs-keyword">list</span> = <span class="hljs-keyword">list</span>;
    this.<span class="hljs-variable">$listview</span> = document.querySelector(<span class="hljs-string">'#grocery-list'</span>);
    this.<span class="hljs-variable">$itemInputView</span> = document.querySelector(<span class="hljs-string">'#item-input'</span>);
    this.<span class="hljs-variable">$addbutton</span> = document.querySelector(<span class="hljs-string">'#add-button'</span>);
    <span class="hljs-keyword">return</span> this;
  },
  <span class="hljs-keyword">empty</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> gl = this.<span class="hljs-variable">$listview</span>;
    <span class="hljs-keyword">while</span> (gl.hasChildNodes()) {
      gl.removeChild(gl.lastChild);
    }
    this.<span class="hljs-keyword">list</span>.<span class="hljs-keyword">empty</span>();
  },
  enterNewItem: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span> {</span>
    this.<span class="hljs-variable">$itemInputView</span>.value = item;
  }
};
</code></pre><p><span style="color: red;">- Cannot call method &#39;dispatchEvent&#39; of null at World.clickAddGroceryListItem</span></p>

<p><em>/template/testrunner.html</em></p>
<pre><code><span class="hljs-doctype">&lt;!doctype html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
    ...
    <span class="hljs-tag">&lt;<span class="hljs-title">ul</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"grocery-list"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">form</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">label</span> <span class="hljs-attribute">for</span>=<span class="hljs-value">"itemInput"</span>&gt;</span>Item name:<span class="hljs-tag">&lt;/<span class="hljs-title">label</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"item-input"</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"itemInput"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">item</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">button</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"add-button"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"button"</span>&gt;</span>add<span class="hljs-tag">&lt;/<span class="hljs-title">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"./script/app.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span>
</code></pre><p>Back to <span style="color: rgb(117, 117, 37);">pending</span>! We&#39;re getting into assertion territory :) Next step:</p>
<h3 id="then-the-item-is-added-to-the-grocery-list-view">Then The item is added to the grocery list view</h3>
<p><em>/features/step_definitions/add-item-view.steps.js</em></p>
<pre><code><span class="hljs-keyword">...</span>

this.Then(/^The item is added to the grocery list view$/, <span class="hljs-keyword">function</span>(callback) {
  assert.equal(this.getGroceryListViewItemAtIndex(<span class="hljs-number">0</span>), enteredItem, <span class="hljs-string">'Entered item should be first in empty list.'</span>);
  callback();
});

<span class="hljs-keyword">...</span>
</code></pre><p><span style="color: red;">- Object #&lt;World&gt; has no method &#39;getGroceryListViewItemAtIndex&#39; at World</span></p>

<p><em>/features/support/world.js</em></p>
<pre><code>var World = <span class="hljs-keyword">function</span> World(callback) {

  this.window = process.browser ? window : {};
  this.app = undefined;
  this.groceryListApplication = undefined;

  var defineGlobals = <span class="hljs-keyword">function</span>(w, doc) {
    this.app = w.app;
  };

<span class="hljs-keyword">...</span>

  this.getGroceryListViewItemAtIndex = <span class="hljs-keyword">function</span>(index) {
    <span class="hljs-keyword">return</span> this.groceryListApplication.$listview.childNodes[index].textContent;
  }

<span class="hljs-keyword">...</span>

  callback();

};

module.exports.World = World;
</code></pre><p><span style="color: red;">- Cannot read property &#39;textContent&#39; of undefined at World.getGroceryListViewItemAtIndex</span></p>

<p><em>/script/app.js</em></p>
<pre><code>...

<span class="hljs-keyword">var</span> application = {
  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(list)</span> {</span>
    this.<span class="hljs-keyword">list</span> = <span class="hljs-keyword">list</span>;
    this.<span class="hljs-variable">$listview</span> = document.querySelector(<span class="hljs-string">'#grocery-list'</span>);
    this.<span class="hljs-variable">$itemInputView</span> = document.querySelector(<span class="hljs-string">'#item-input'</span>);
    this.<span class="hljs-variable">$addbutton</span> = document.querySelector(<span class="hljs-string">'#add-button'</span>);
    (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app)</span> {</span>
      app.<span class="hljs-variable">$addbutton</span>.addEventListener(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
        <span class="hljs-keyword">var</span> item = app.<span class="hljs-variable">$itemInputView</span>.value;
        app.addItemToView(item);
      });
    }(this));
    <span class="hljs-keyword">return</span> this;
  },
  <span class="hljs-keyword">empty</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> gl = this.<span class="hljs-variable">$listview</span>;
    <span class="hljs-keyword">while</span> (gl.hasChildNodes()) {
      gl.removeChild(gl.lastChild);
    }
    this.<span class="hljs-keyword">list</span>.<span class="hljs-keyword">empty</span>();
  },
  enterNewItem: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span> {</span>
    this.<span class="hljs-variable">$itemInputView</span>.value = item;
  },
  addItemToView: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span> {</span>
    <span class="hljs-keyword">var</span> li = document.createElement(<span class="hljs-string">'li'</span>);
    <span class="hljs-keyword">var</span> text = document.createTextNode(item);
    li.appendChild(text);
    this.<span class="hljs-variable">$listview</span>.appendChild(li);
  }
};

...
</code></pre><p>By adding a <code>click</code> handler to the <code>button</code>, we are updating the view by adding a <code>li</code> element to the list view.</p>
<p>And we&#39;re back to <span style="color: rgb(117, 117, 37);">pending</span>! One last step:</p>
<h3 id="then-the-item-is-accessible-from-the-grocery-list-collection">Then The item is accessible from the grocery list collection</h3>
<p><em>/features/step_definitions/add-item-view.steps.js</em></p>
<pre><code><span class="hljs-keyword">...</span>

this.Then(/^The item is accessible from the grocery list collection$/, <span class="hljs-keyword">function</span>(callback) {
  assert.equal(this.groceryListApplication.list.getItemIndex(enteredItem), <span class="hljs-number">0</span>, <span class="hljs-string">'Added item should be found at first index.'</span>);
  callback();
});

<span class="hljs-keyword">...</span>
</code></pre><p>Utilizing the <code>getItemIndex()</code> method we created in passing the collection features from a previous article, we get back to failing.</p>
<p><span style="color: red;">- Added item should be found at first index. at World</span></p>
<p><em>/script/app.js</em></p>
<pre><code><span class="hljs-keyword">...</span>

var application = {
  init: <span class="hljs-keyword">function</span>(list) {
    this.list = list;
    this.$listview = document.querySelector(<span class="hljs-string">'#grocery-list'</span>);
    this.$itemInputView = document.querySelector(<span class="hljs-string">'#item-input'</span>);
    this.$addbutton = document.querySelector(<span class="hljs-string">'#add-button'</span>);
    (<span class="hljs-keyword">function</span>(app) {
      app.$addbutton.addEventListener(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(event) {
        var item = app.$itemInputView.value;
        app.addItemToView(item);
        app.list.add(item);
      });
    }(this));
    <span class="hljs-keyword">return</span> this;
  },
  <span class="hljs-keyword">...</span>
};

<span class="hljs-keyword">...</span>
</code></pre><p>In adding a call to <code>list.add()</code> in the button handler within we just defined an update to the view, we bring ourselves to full <span style="color: green;">green</span>!</p>
<div style="width: 100%; overflow-x: scroll; background-color:#fff; text-align: center;">
  <img src="http://custardbelly.com/blog/images/cucumberjs-browser-3.png" alt="cucumberjs in the browser, passing">
</div>

<h2 id="considerations">Considerations</h2>
<p>If you have following along in getting these new browser-based <strong>Features</strong> to pass in that environment, I have taken some liberties with regards to architecture and process with the hopes to not add noise to the task at hand.</p>
<p>In reality, we should consider the next phase as a <em>Refactor</em>. The particular areas in which I see issues that I would address and.or discuss with my team are:</p>
<ul>
<li>Implementing view update based on collection events</li>
<li>Templatize-ing the main view to be wrapped in production and injecting as a partial to the testrunner template</li>
<li>Building the application to be deployed as a web-based application and User Tested</li>
</ul>
<p>I am sure there are more, and that you have a few ideas as well, but these are at least three aspects of the architecture of the project and product that can be tackled with assurance now that we have a test harness for the features criteria :)</p>
<h2 id="conclusion">Conclusion</h2>
<p>If you made it down this far, I do appreciate you taking the time to follow along - I know this was a bit of a long one.</p>
<p>I hoped to have demonstrated the process of going from <strong>Features</strong> to <strong>Step Definitions</strong> to implementation code to pass criteria all while living in a real browser environment using the <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> and test automation. On the surface, it may seem like quite a process, but my personal experience is that BDD forces you into thinking about minimilistic design while putting your code under a test harness from which you can maintain and add new features with assurance.</p>
<p>Source for examples related to this post can be found in the <a href="https://github.com/bustardcelly/cucumberjs-examples/tree/0.5.0.post">0.5.0.post tag on my Github account</a>.</p>
<h2 id="to-come">To Come</h2>
<p>There are a few extra productivity tidbits I have picked up while working with the wondeful <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> tool in developing several applications for both the web and server.</p>
<p>Who knows... I have had a blast going through the articles in this series demonstrating TDD using the BDD tool, <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a>. I might just continue to evolve the example to a fully-functional application just as I had done in the <a href="http://custardbelly.com/blog/blog-pages/category/grocery-ls.html">Making of a Test-Driven Grocery List Application</a> series which focused on the <a href="http://jasmine.github.io/2.0/introduction.html">Jasmine</a> library.</p>
<p>Additionally, I am invested in the <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> I created during (and as a result) of this series and hope to write some more articles on its structure, usage and any additions/fixes that are made and I welcome you to help me in making <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> a great tool in being able run your specs in a real browser environment without having to change your current workflow in defining <strong>Features</strong>, <strong>Step Definitions</strong> and support files.</p>
<p>Cheers!</p>

  </section>
  <section class="navigation">
      
        <span class="newer"><a href="http://custardbelly.com/blog/blog-posts/2014/02/18/cucumberjs-testling/index.html">&#8672;&nbsp;newer</a></span>
      
      
        <span class="older"><a href="http://custardbelly.com/blog/blog-posts/2014/02/10/cucumberjs-tests-browser/index.html">older&nbsp;&#8674;</a></span>
      
    </section>
  <section class="comments">
    
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        window.disqus_identifier="";
        window.disqus_url="http://custardbelly.com/blog/blog-posts/2014/02/12/cucumberjs-browser-update/index.html";
        window.disqus_title="BDD in JavaScript V: CucumberJS and The Browser, II";
      </script>
        <script type="text/javascript" src="http://disqus.com/forums/custardbelly/embed.js"></script>
        <noscript><a href="http://custardbelly.disqus.com/?url=ref">View the discussion thread.</a></noscript>
    
  </section>
</article>

    <footer>
      Copyright Todd Anderson, 2014.
      <div>Icon made by <a href="http://www.flaticon.com/free-icon/google-plus-symbol-in-a-circle_24171" title="Icomoon">Icomoon</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a></div>
      <div>Icon made by <a href="http://www.flaticon.com/free-icon/social-rss-circle-internet_10010" title="Elegant Themes">Elegant Themes</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a></div>
    </footer>
    <script src="http://custardbelly.com/blog/lib/highlight/highlight.pack.js"></script>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-29061897-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
  </body>
</html>
