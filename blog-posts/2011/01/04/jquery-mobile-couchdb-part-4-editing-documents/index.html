
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2011/01/04/jquery-mobile-couchdb-part-4-editing-documents/" title="Permanent link to jQuery Mobile + CouchDB: Part 4 – Editing Documents" rel="bookmark" rev="post-318">jQuery Mobile + CouchDB: Part 4 – Editing Documents</a></h1>
	
	<div class="entry-content full-content">
		<p>In the <a href="http://custardbelly.com/blog/?p=297" target="_blank">previous post</a>, I addressed using templates to generate the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> external pages. Though it addressed a fundamental (imo) part of serving up <strong>HTML</strong> from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance and had a few nice tricks for <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a>, it essentially was organization and cleanup so I could move forward in developing the application without it getting to cluttered for my development and workflow.</p>
<p>In this article, I am going to take the templating structure established in the <a href="http://custardbelly.com/blog/?p=297" target="_blank">previous post</a> and add another external page to the<a href="http://jquerymobile.com/" target="_blank"> jQuery Mobile</a> application – one in which I will be able to edit the document served up from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database. Along with this, I’ll discuss assigning event handlers to <strong>DOM</strong> elements using <a href="http://jquery.com/" target="_blank">jQuery</a>, adding buttons to footers and headers, and clearing external <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> pages from cache to ensure a user is looking at the most recent changes to a document.</p>
<h2>Edit Template</h2>
<p>In the <a href="http://custardbelly.com/blog/?p=297">previous post</a>, we moved from returning <strong>HTML</strong> from <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> using a <strong>show function</strong> and string manipulation to moving mark-up over to a <strong>template</strong> and utilizing <a href="https://github.com/janl/mustache.js" target="_blank">Mustache</a> to render the served up <strong>jQuery Mobile</strong> external page. We are going to use the same technique to deliver another page that will allow a user to edit a target <strong>CouchDB</strong> document, with the option to either cancel or submit their changes.</p>
<p>Open up your favorite text editor, add the following snippet and save the file as <em>albumedit.html</em> in the <em>/templates</em> directory of your <strong>albums</strong> <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> (eg. <em>/Documents/workspace/custardbelly/couchdb/albums/templates/albumedit.html</em>):</p>
<p><em>/templates/albumedit.html</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"page"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albumedit"</code> <code class="xml color1">data-nobackbtn</code><code class="xml plain">=</code><code class="xml string">"true"</code><code class="xml plain">&gt;</code></div><div class="line number2 index1 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"header"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albumheader"</code><code class="xml plain">&gt;</code></div><div class="line number3 index2 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">a</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"cancelBackButton"</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#"</code> <code class="xml color1">data-icon</code><code class="xml plain">=</code><code class="xml string">"delete"</code><code class="xml plain">&gt;Close&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;</code></div><div class="line number4 index3 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">h1</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"albumtitle"</code><code class="xml plain">&gt;{{title}}&lt;/</code><code class="xml keyword">h1</code><code class="xml plain">&gt;</code></div><div class="line number5 index4 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number6 index5 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"content"</code> <code class="xml color1">data-theme</code><code class="xml plain">=</code><code class="xml string">"c"</code> <code class="xml color1">style</code><code class="xml plain">=</code><code class="xml string">"padding:0em;"</code><code class="xml plain">&gt;</code></div><div class="line number7 index6 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">form</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albumform"</code> <code class="xml color1">action</code><code class="xml plain">=</code><code class="xml string">"#"</code> <code class="xml color1">method</code><code class="xml plain">=</code><code class="xml string">"get"</code> <code class="xml color1">data-identity</code><code class="xml plain">=</code><code class="xml string">"{{document}}"</code><code class="xml plain">&gt;</code></div><div class="line number8 index7 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"fieldcontain"</code><code class="xml plain">&gt;</code></div><div class="line number9 index8 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">label</code> <code class="xml color1">for</code><code class="xml plain">=</code><code class="xml string">"artist"</code><code class="xml plain">&gt;Artist:&lt;/</code><code class="xml keyword">label</code><code class="xml plain">&gt;</code></div><div class="line number10 index9 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">input</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"artistField"</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">"artist"</code> <code class="xml color1">type</code><code class="xml plain">=</code><code class="xml string">"text"</code> <code class="xml color1">value</code><code class="xml plain">=</code><code class="xml string">"{{artist}}"</code> <code class="xml plain">/&gt;</code></div><div class="line number11 index10 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number12 index11 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"fieldcontain"</code><code class="xml plain">&gt;</code></div><div class="line number13 index12 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">label</code> <code class="xml color1">for</code><code class="xml plain">=</code><code class="xml string">"title"</code><code class="xml plain">&gt;Title:&lt;/</code><code class="xml keyword">label</code><code class="xml plain">&gt;</code></div><div class="line number14 index13 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">input</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"titleField"</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">"title"</code> <code class="xml color1">type</code><code class="xml plain">=</code><code class="xml string">"text"</code> <code class="xml color1">value</code><code class="xml plain">=</code><code class="xml string">"{{title}}"</code> <code class="xml plain">/&gt;</code></div><div class="line number15 index14 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number16 index15 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"fieldcontain"</code><code class="xml plain">&gt;</code></div><div class="line number17 index16 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">label</code> <code class="xml color1">for</code><code class="xml plain">=</code><code class="xml string">"description"</code><code class="xml plain">&gt;Description:&lt;/</code><code class="xml keyword">label</code><code class="xml plain">&gt;</code></div><div class="line number18 index17 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">textarea</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"descriptionField"</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">"description"</code> <code class="xml color1">cols</code><code class="xml plain">=</code><code class="xml string">"40"</code> <code class="xml color1">rows</code><code class="xml plain">=</code><code class="xml string">"8"</code><code class="xml plain">&gt;{{description}}&lt;/</code><code class="xml keyword">textarea</code><code class="xml plain">&gt;</code></div><div class="line number19 index18 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number20 index19 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-body ui-body-b"</code><code class="xml plain">&gt;</code></div><div class="line number21 index20 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">fieldset</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-grid-a"</code><code class="xml plain">&gt;</code></div><div class="line number22 index21 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-block-a"</code><code class="xml plain">&gt;</code></div><div class="line number23 index22 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">p</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"cancelButton"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"button"</code> <code class="xml color1">data-theme</code><code class="xml plain">=</code><code class="xml string">"d"</code><code class="xml plain">&gt;Cancel&lt;/</code><code class="xml keyword">p</code><code class="xml plain">&gt;</code></div><div class="line number24 index23 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number25 index24 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-block-b"</code><code class="xml plain">&gt;</code></div><div class="line number26 index25 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">p</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"submitButton"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"button"</code> <code class="xml color1">data-theme</code><code class="xml plain">=</code><code class="xml string">"a"</code><code class="xml plain">&gt;Submit&lt;/</code><code class="xml keyword">p</code><code class="xml plain">&gt;</code></div><div class="line number27 index26 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number28 index27 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">fieldset</code><code class="xml plain">&gt;</code></div><div class="line number29 index28 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number30 index29 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">form</code><code class="xml plain">&gt;</code></div><div class="line number31 index30 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number32 index31 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"footer"</code> <code class="xml plain">/&gt;</code></div><div class="line number33 index32 alt2"><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number34 index33 alt1"><code class="xml plain">{{&gt;scripts}}</code></div></pre></div>
<p>That is some pretty hefty mark-up in relation to the relatively small (element count-wise) pages we have previously created. What should be familiar are the <strong>{{mustache}}</strong> tokens which will be dynamically filled with content using <a href="https://github.com/janl/mustache.js" target="_blank">mustache.js</a> in our soon-to-be created <strong>show function</strong> for the <em>album edit</em> page; but there are a few <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> tidbits in here that we should take a little deeper of a look at.</p>
<h3>Page &amp; Header</h3>
<p><em>/templates/albumedit.html</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"page"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albumedit"</code> <code class="xml color1">data-nobackbtn</code><code class="xml plain">=</code><code class="xml string">"true"</code><code class="xml plain">&gt;</code></div><div class="line number2 index1 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"header"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albumheader"</code><code class="xml plain">&gt;</code></div><div class="line number3 index2 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">a</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"cancelBackButton"</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#"</code> <code class="xml color1">data-icon</code><code class="xml plain">=</code><code class="xml string">"delete"</code><code class="xml plain">&gt;Close&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;</code></div><div class="line number4 index3 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">h1</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"albumtitle"</code><code class="xml plain">&gt;{{title}}&lt;/</code><code class="xml keyword">h1</code><code class="xml plain">&gt;</code></div><div class="line number5 index4 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div></pre></div>
<p>A <strong>data-role</strong> of <em>page</em> is set as usual to declare a <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page and an <strong>id</strong> attribute is assigned for a reason that will be discussed shortly. What is of note in the page <strong>div</strong> is the <strong>data-nobackbtn</strong> attribute. If set the a value of <em>true</em>, this declaration will remove the default <strong>Back</strong> button from the header and allow us to customize the options. For this case, we have replaced the <strong>Back</strong> button with a <strong>Close</strong> button:</p>
<p><em>/templates/albumedit.html</em></p>
<div><pre><div class="line number3 index0 alt2"><code class="xml plain">&lt;</code><code class="xml keyword">a</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"cancelBackButton"</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#"</code> <code class="xml color1">data-icon</code><code class="xml plain">=</code><code class="xml string">"delete"</code><code class="xml plain">&gt;Close&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;</code></div></pre></div>
<p>Without specifying a style <strong>class</strong>, the <strong>Close</strong> button will be positioned to the left in the header. The <strong>href</strong> is set to an empty anchor. Essentially this is just a placeholder for an action defaulted to a link in the header. When we create the controller script for the <em>album edit</em> page later in this article, we will prevent the default behaviour and handle the close manually.</p>
<h3>Content Form</h3>
<p><a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> has some great organization and styling when it comes to <strong>form</strong> elements. Positioning and aligning fields is all handled by the framework and, unless you want to get fancy, you basically just have to declare the desired element or assign the desired role/layout in order to achieve a fairly simple form. What we have done for our <em>album edit</em> page template is pretty basic:</p>
<p><em>/templates/albumedit.html</em></p>
<div><pre><div class="line number7 index0 alt2"><code class="xml plain">&lt;</code><code class="xml keyword">form</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albumform"</code> <code class="xml color1">action</code><code class="xml plain">=</code><code class="xml string">"#"</code> <code class="xml color1">method</code><code class="xml plain">=</code><code class="xml string">"get"</code> <code class="xml color1">data-identity</code><code class="xml plain">=</code><code class="xml string">"{{document}}"</code><code class="xml plain">&gt;</code></div><div class="line number8 index1 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"fieldcontain"</code><code class="xml plain">&gt;</code></div><div class="line number9 index2 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">label</code> <code class="xml color1">for</code><code class="xml plain">=</code><code class="xml string">"artist"</code><code class="xml plain">&gt;Artist:&lt;/</code><code class="xml keyword">label</code><code class="xml plain">&gt;</code></div><div class="line number10 index3 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">input</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"artistField"</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">"artist"</code> <code class="xml color1">type</code><code class="xml plain">=</code><code class="xml string">"text"</code> <code class="xml color1">value</code><code class="xml plain">=</code><code class="xml string">"{{artist}}"</code> <code class="xml plain">/&gt;</code></div><div class="line number11 index4 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number12 index5 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"fieldcontain"</code><code class="xml plain">&gt;</code></div><div class="line number13 index6 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">label</code> <code class="xml color1">for</code><code class="xml plain">=</code><code class="xml string">"title"</code><code class="xml plain">&gt;Title:&lt;/</code><code class="xml keyword">label</code><code class="xml plain">&gt;</code></div><div class="line number14 index7 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">input</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"titleField"</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">"title"</code> <code class="xml color1">type</code><code class="xml plain">=</code><code class="xml string">"text"</code> <code class="xml color1">value</code><code class="xml plain">=</code><code class="xml string">"{{title}}"</code> <code class="xml plain">/&gt;</code></div><div class="line number15 index8 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number16 index9 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"fieldcontain"</code><code class="xml plain">&gt;</code></div><div class="line number17 index10 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">label</code> <code class="xml color1">for</code><code class="xml plain">=</code><code class="xml string">"description"</code><code class="xml plain">&gt;Description:&lt;/</code><code class="xml keyword">label</code><code class="xml plain">&gt;</code></div><div class="line number18 index11 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">textarea</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"descriptionField"</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">"description"</code> <code class="xml color1">cols</code><code class="xml plain">=</code><code class="xml string">"40"</code> <code class="xml color1">rows</code><code class="xml plain">=</code><code class="xml string">"8"</code><code class="xml plain">&gt;{{description}}&lt;/</code><code class="xml keyword">textarea</code><code class="xml plain">&gt;</code></div><div class="line number19 index12 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number20 index13 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-body ui-body-b"</code><code class="xml plain">&gt;</code></div><div class="line number21 index14 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">fieldset</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-grid-a"</code><code class="xml plain">&gt;</code></div><div class="line number22 index15 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-block-a"</code><code class="xml plain">&gt;</code></div><div class="line number23 index16 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">p</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"cancelButton"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"button"</code> <code class="xml color1">data-theme</code><code class="xml plain">=</code><code class="xml string">"d"</code><code class="xml plain">&gt;Cancel&lt;/</code><code class="xml keyword">p</code><code class="xml plain">&gt;</code></div><div class="line number24 index17 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number25 index18 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-block-b"</code><code class="xml plain">&gt;</code></div><div class="line number26 index19 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">p</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"submitButton"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"button"</code> <code class="xml color1">data-theme</code><code class="xml plain">=</code><code class="xml string">"a"</code><code class="xml plain">&gt;Submit&lt;/</code><code class="xml keyword">p</code><code class="xml plain">&gt;</code></div><div class="line number27 index20 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number28 index21 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">fieldset</code><code class="xml plain">&gt;</code></div><div class="line number29 index22 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number30 index23 alt1"><code class="xml plain">&lt;/</code><code class="xml keyword">form</code><code class="xml plain">&gt;</code></div></pre></div>
<p>The input fields are populated with the dynamic values from our <strong>show function</strong> (discussed later) and two buttons are presented to either <strong>Cancel</strong> or <strong>Submit</strong> any changes to those values. By marking each <strong>div</strong> with a <strong>data-role</strong> of <em>fieldcontain</em>, the label/input pair will be styled and aligned with each other <strong>div</strong> with a horizontal bar to delimit them vertically. The <strong>Cancel</strong> and <strong>Submit</strong> buttons are held in a <strong>fieldset</strong> with a grid layout assigned:</p>
<p><em>/templates/albumedit.html</em></p>
<div><pre><div class="line number21 index0 alt2"><code class="xml plain">&lt;</code><code class="xml keyword">fieldset</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-grid-a"</code><code class="xml plain">&gt;</code></div><div class="line number22 index1 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-block-a"</code><code class="xml plain">&gt;</code></div><div class="line number23 index2 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">p</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"cancelButton"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"button"</code> <code class="xml color1">data-theme</code><code class="xml plain">=</code><code class="xml string">"d"</code><code class="xml plain">&gt;Cancel&lt;/</code><code class="xml keyword">p</code><code class="xml plain">&gt;</code></div><div class="line number24 index3 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number25 index4 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-block-b"</code><code class="xml plain">&gt;</code></div><div class="line number26 index5 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">p</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"submitButton"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"button"</code> <code class="xml color1">data-theme</code><code class="xml plain">=</code><code class="xml string">"a"</code><code class="xml plain">&gt;Submit&lt;/</code><code class="xml keyword">p</code><code class="xml plain">&gt;</code></div><div class="line number27 index6 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number28 index7 alt1"><code class="xml plain">&lt;/</code><code class="xml keyword">fieldset</code><code class="xml plain">&gt;</code></div></pre></div>
<p>By assigning a <em>ui-block</em> value to each <strong>div</strong> in the <strong>fieldset</strong>, they will essentially be sized at 50% within the grid and positioned accordingly – <strong>Cancel</strong> to the left of <strong>Submit</strong>. You may notice that the “buttons” are not a link elements nor button elements. The reason being that both of those within a context of a form element were somehow being overridden to always perform a submit action. We will want to trap the user interaction with these elements in order to either <strong>a)</strong> reset the field values or <strong>b)</strong> submit our changes to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database. So, they have been declared as <strong>p</strong> elements with a <strong>data-role</strong> of button so as to have the proper styling, but not the default action role of submittal of form without being captured and prevented first. </p>
<p>We will get into the submission of an edited document in a bit when we discuss the associated script with the <em>album edit</em> page, but until then take notice of the <strong>Partial</strong> inclusion in our <em>albumedit</em> template:</p>
<p><em>/templates/albumedit.html</em></p>
<div><pre><div class="line number34 index0 alt1"><code class="xml plain">{{&gt;scripts}}</code></div></pre></div>
<p>… and let’s dive into creating our <strong>show function</strong> for editable album pages.</p>
<h2>Edit Show Function</h2>
<p>If you have been following along with the <a href="http://custardbelly.com/blog/?p=297" target="_blank">previous post</a>, you will remember that we removed the string-manipulated mark-up from the <strong>show function</strong> for the <em>album view</em> page and replaced it with <a href="https://github.com/janl/mustache.js" target="_blank">Mustache</a> templating. The <strong>show function</strong> we will create for the <em>album edit</em> page will largely look the same as the one created for the <em>album view</em> page. In fact, the only difference will be the target template and partial include.</p>
<p>Open up your favorite text editor, create a new file, add the following snippet and save the file as <em>album-edit.js</em> in the <em>/shows</em> directory of your albums <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> (eg. <em>/Documents/workspace/custardbelly/couchdb/albums/shows/album-edit.js</em>):</p>
<p><em>/shows/album-edit.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">function</code><code class="jscript plain">(doc, req) {</code></div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">Mustache = require(</code><code class="jscript string">"vendor/couchapp/lib/mustache"</code><code class="jscript plain">);</code></div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">stash = {</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">artist: doc.artist,</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">title : doc.title,</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">description: doc.description,</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document: doc._id</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">Mustache.to_html(</code><code class="jscript keyword">this</code><code class="jscript plain">.templates.albumedit, stash, </code><code class="jscript keyword">this</code><code class="jscript plain">.templates.partials.albumedit);</code></div><div class="line number10 index9 alt1"><code class="jscript plain">}</code></div></pre></div>
<p>Again, if you have been following along with previous posts, this would look relatively familiar. Essentially, we are using the <a href="https://github.com/janl/mustache.js" target="_blank">mustache.js</a> template plugin to deliver <strong>HTML</strong> mark-up of the previously created <em>albumedit.html</em> <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page. The associated document is retrieved from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database by passing the <strong>_id</strong> of the document in the request (eg. <a href="http://127.0.0.1:5984/albums/_design/albums/_show/album-edit/db04eb7e5c845ee0aa791ae1ed001e4d" target="_blank">http://127.0.0.1:5984/albums/_design/albums/_show/<br>
album-edit/db04eb7e5c845ee0aa791ae1ed001e4d</a>). </p>
<p>The previously created <em>/templates/albumedit.html</em> will be used as the template and is supplied as the first argument in <strong>Mustache</strong>.<em>to_html()</em>. The <strong>stash</strong> object (second argument) is used to dynamically filled the values of the fields upon load and the specified properties of the <strong>album document</strong> are available for editing: <strong>artist name</strong>, <strong>album title</strong> and <strong>personal description</strong>. The third argument is the <strong>Partial</strong> includes directory that will be substituted in the <strong>{{&gt;}}</strong> declarations of the <em>/templates/albumedit.html</em> document. There is only one <strong>Partial</strong> defined in <em>albumedit.html</em> – <strong>{{&gt;scripts}}</strong> – which will essentially declare a <strong>JavaScript</strong> file with actions associated with the <em>album edit</em> page.</p>
<h2>Scripts Partial</h2>
<p>Open up your favorite text editor and save the following snippet as <em>scripts.html</em> in <em>/templates/partials/albumedit</em>:</p>
<p><em>/templates/partials/albumedit/scripts.html</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="xml plain">&lt;</code><code class="xml keyword">script</code> <code class="xml color1">src</code><code class="xml plain">=</code><code class="xml string">"../../script/album-edit-page.js"</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">script</code><code class="xml plain">&gt;</code></div></pre></div>
<p>If you have followed along with create the <strong>show function</strong>, template and partial for the <em>album view</em> page, this again will look similar. We are essentially loading an associated <strong>JavaScript</strong> file for the <em>album edit</em> page. As explained in the <a href="http://custardbelly.com/blog/?p=297" target="_blank">previous post</a>, the script could be included here and not redirected to a <strong>js</strong> file, but for my own organizational habits I create a separate <strong>JavaScript</strong> file and have it residing in the <em>/_attachments/script/</em> directory of my <strong>albums</strong> <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> (eg. <em>/Documents/workspace/custardbelly/couchdb/albums/<br>
_attachments/script/album-edit-page.js</em>).</p>
<h2>album-edit-page.js</h2>
<p>If we think about the role of our <em>album edit</em> page in the scheme of the application, we want to present the user with the ability to edit the album document from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> <strong>albums</strong> database. The form will initially be filled with the latest editable values and the user has the ability to either submit changes or cancel any pending changes. A <strong>Cancel</strong> action will return the fields back to the original values and return the user to the <em>album view</em> page. To ensure that the user is presented with the latest changes to the document from the database, we will also need to clear the page from the page cache just as we have done with the <em>album view</em> page. With these requirements in mind, let’s start creating the associated script for the album edit <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page served up from the <em>album-edit</em> <strong>show function</strong>.</p>
<h3>AlbumEditPageController</h3>
<p>We’ll start by creating a quasi-view-controller for the <em>album edit</em> page in the similar fashion as the one used for the <em>album view</em> page (created in the <a href="http://custardbelly.com/blog/?p=297" target="_blank">previous post</a>). Initially, it will handle recognizing once the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page <strong>div</strong> is shown and remove it from the page cache once it is hidden (by navigating away from the page).</p>
<p>Open your favorite text editor and save the following snippet as <em>album-edit-page.js</em> in the <em>/_attachments/script/</em> directory:</p>
<p><em>/_attachments/script/album-edit-page.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">AlbumEditPageController = </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleEditPageViewHide()</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumform"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">pageCache =&nbsp; $(document.getElementById(</code><code class="jscript string">"_show/album-edit/"</code> <code class="jscript plain">+ docId));</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">pageCache.unbind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, handleEditPageViewHide );</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">pageCache.empty();</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">pageCache.remove();</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleEditView()</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Watch for bound hide of page to clear from cache.</code></div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumform"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">albumPage = $(document.getElementById(</code><code class="jscript string">"_show/album-edit/"</code> <code class="jscript plain">+ docId));</code></div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">albumPage.bind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, handleEditPageViewHide );</code></div><div class="line number18 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">{</code></div><div class="line number21 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">initialize: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number22 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).live( </code><code class="jscript string">"pageshow"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number23 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).die( </code><code class="jscript string">"pageshow"</code> <code class="jscript plain">);</code></div><div class="line number24 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">handleEditView();</code></div><div class="line number25 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number26 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number27 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number28 index27 alt1"><code class="jscript plain">}();</code></div><div class="line number29 index28 alt2">&nbsp;</div><div class="line number30 index29 alt1"><code class="jscript keyword">function</code> <code class="jscript plain">handleEditPageReady()</code></div><div class="line number31 index30 alt2"><code class="jscript plain">{</code></div><div class="line number32 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">AlbumEditPageController.initialize();</code></div><div class="line number33 index32 alt2"><code class="jscript plain">}</code></div><div class="line number34 index33 alt1"><code class="jscript plain">$().ready( handleEditPageReady )</code></div></pre></div>
<p>Once the page is loaded, the <strong>AlbumEditPageController</strong> is initialized an a <em>pageshow</em> event handler is assigned to recognize when the <em>albumedit</em> <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page is shown. We access the page in the <strong>DOM</strong> using the standard <strong>data-role</strong> attribute value for a <strong>jQuery Mobile</strong> page. I stumbled upon this solution from these two forum posts – <a href="http://forum.jquery.com/topic/force-page-update" target="_blank">http://forum.jquery.com/topic/force-page-update</a> and <a href="http://forum.jquery.com/topic/binding-events-to-buttons-in-a-dialog" target="_blank">http://forum.jquery.com/topic/binding-events-to-buttons-in-a-dialog</a> – and seem to be the current agreed upon solution for accessing a loading <strong>jQuery Mobile</strong> page. In the <em>handleEditView()</em> handler, the page in the <strong>DOM</strong> is accessed using <strong>document</strong>.<em>getElementById()</em> and assigned an event handler for <em>pagehide</em> to clear it from the page (ie. <strong>DOM</strong>) cache. Aside from the external page <strong>id</strong> used to access the element, this is pretty much identical to the solution from the previous post.</p>
<p>One of the requirements for the <em>album edit</em> page is the ability to cancel and clear any edited fields by the user. In order to do so, we will stored a local object with the provided name/value pairs so the fields can be easily reverted.</p>
<p>With <em>album-edit-page.js</em> open in your favorite text editor, make the following modifications and save the file:</p>
<p><em>/_attachments/script/album-edit-page.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">AlbumEditPageController = </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">editableAlbum;</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleEditPageViewHide()</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">editableAlbum = </code><code class="jscript keyword">null</code><code class="jscript plain">;</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumform"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">pageCache =&nbsp; $(document.getElementById(</code><code class="jscript string">"_show/album-edit/"</code> <code class="jscript plain">+ docId));</code></div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">pageCache.unbind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, handleEditPageViewHide );</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">pageCache.empty();</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">pageCache.remove();</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleEditView()</code></div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number18 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Watch for bound hide of page to clear from cache.</code></div><div class="line number19 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumform"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number20 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">albumPage = $(document.getElementById(</code><code class="jscript string">"_show/album-edit/"</code> <code class="jscript plain">+ docId));</code></div><div class="line number21 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">albumPage.bind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, handleEditPageViewHide );</code></div><div class="line number22 index21 alt1">&nbsp;</div><div class="line number23 index22 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">storeUneditedDocument();</code></div><div class="line number24 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">storeUneditedDocument()</code></div><div class="line number27 index26 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number28 index27 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">artist = $(</code><code class="jscript string">"input#artistField"</code><code class="jscript plain">).val();</code></div><div class="line number29 index28 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">album = $(</code><code class="jscript string">"input#titleField"</code><code class="jscript plain">).val();</code></div><div class="line number30 index29 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">description = $(</code><code class="jscript string">"textarea#descriptionField"</code><code class="jscript plain">).val();</code></div><div class="line number31 index30 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">editableAlbum = {artist:artist, album:album, description:description};</code></div><div class="line number32 index31 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number33 index32 alt2">&nbsp;</div><div class="line number34 index33 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">{</code></div><div class="line number35 index34 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">initialize: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number36 index35 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).live( </code><code class="jscript string">"pageshow"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number37 index36 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).die( </code><code class="jscript string">"pageshow"</code> <code class="jscript plain">);</code></div><div class="line number38 index37 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">handleEditView();</code></div><div class="line number39 index38 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number40 index39 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number41 index40 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number42 index41 alt1"><code class="jscript plain">}();</code></div><div class="line number43 index42 alt2">&nbsp;</div><div class="line number44 index43 alt1"><code class="jscript keyword">function</code> <code class="jscript plain">handleEditPageReady()</code></div><div class="line number45 index44 alt2"><code class="jscript plain">{</code></div><div class="line number46 index45 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">AlbumEditPageController.initialize();</code></div><div class="line number47 index46 alt2"><code class="jscript plain">}</code></div><div class="line number48 index47 alt1"><code class="jscript plain">$().ready( handleEditPageReady )</code></div></pre></div>
<p>An <strong>editableAlbum</strong> member is declared and updated upon <em>pageshow</em> in the <em>storeUneditedDocument()</em> method. With the original values stored in this externally-immutable we can ensure that whenever a user decides to cancel the editing of the <strong>album document</strong> we can revert the field values to the original document values. Let’s hook up the <strong>cancelBackButton</strong> and <strong>cancelButton</strong> elements declared in the <em>albumedit.html</em> template with <em>click</em> event handlers in order to handle the revert action back to the original values.</p>
<p>Save the following modifications to <em>album-edit-page.js</em>:</p>
<p><em>/_attachments/script/album-edit-page.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">AlbumEditPageController = </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">editableAlbum;</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleEditPageViewHide()</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number7 index6 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#cancelButton"</code><code class="jscript plain">).die( </code><code class="jscript string">"click"</code><code class="jscript plain">, handleCancelEdit );</code></div><div class="line number8 index7 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#cancelBackButton"</code><code class="jscript plain">).die( </code><code class="jscript string">"click"</code> <code class="jscript plain">);</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">editableAlbum = </code><code class="jscript keyword">null</code><code class="jscript plain">;</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumform"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">pageCache =&nbsp; $(document.getElementById(</code><code class="jscript string">"_show/album-edit/"</code> <code class="jscript plain">+ docId));</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">pageCache.unbind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, handleEditPageViewHide );</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">pageCache.empty();</code></div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">pageCache.remove();</code></div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleEditView()</code></div><div class="line number19 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number20 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Watch for bound hide of page to clear from cache.</code></div><div class="line number21 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumform"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number22 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">albumPage = $(document.getElementById(</code><code class="jscript string">"_show/album-edit/"</code> <code class="jscript plain">+ docId));</code></div><div class="line number23 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">albumPage.bind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, handleEditPageViewHide );</code></div><div class="line number24 index23 alt1">&nbsp;</div><div class="line number25 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">storeUneditedDocument();</code></div><div class="line number26 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number27 index26 alt2">&nbsp;</div><div class="line number28 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">storeUneditedDocument()</code></div><div class="line number29 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number30 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">artist = $(</code><code class="jscript string">"input#artistField"</code><code class="jscript plain">).val();</code></div><div class="line number31 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">album = $(</code><code class="jscript string">"input#titleField"</code><code class="jscript plain">).val();</code></div><div class="line number32 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">description = $(</code><code class="jscript string">"textarea#descriptionField"</code><code class="jscript plain">).val();</code></div><div class="line number33 index32 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">editableAlbum = {artist:artist, album:album, description:description};</code></div><div class="line number34 index33 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number35 index34 alt2">&nbsp;</div><div class="line number36 index35 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">revertEdits()</code></div><div class="line number37 index36 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number38 index37 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"input#artistField"</code><code class="jscript plain">).val( editableAlbum.artist );</code></div><div class="line number39 index38 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"input#titleField"</code><code class="jscript plain">).val( editableAlbum.album );</code></div><div class="line number40 index39 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"textarea#descriptionField"</code><code class="jscript plain">).val( editableAlbum.description );</code></div><div class="line number41 index40 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number42 index41 alt1 highlighted">&nbsp;</div><div class="line number43 index42 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleCancelEdit()</code></div><div class="line number44 index43 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number45 index44 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">revertEdits();</code></div><div class="line number46 index45 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number47 index46 alt2">&nbsp;</div><div class="line number48 index47 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">{</code></div><div class="line number49 index48 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">initialize: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number50 index49 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#cancelButton"</code><code class="jscript plain">).live( </code><code class="jscript string">"click"</code><code class="jscript plain">, handleCancelEdit );</code></div><div class="line number51 index50 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#cancelBackButton"</code><code class="jscript plain">).live( </code><code class="jscript string">"click"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">( event ) {</code></div><div class="line number52 index51 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">event.preventDefault();</code></div><div class="line number53 index52 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">handleCancelEdit();</code></div><div class="line number54 index53 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">false</code><code class="jscript plain">;</code></div><div class="line number55 index54 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number56 index55 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).live( </code><code class="jscript string">"pageshow"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number57 index56 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).die( </code><code class="jscript string">"pageshow"</code> <code class="jscript plain">);</code></div><div class="line number58 index57 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">handleEditView();</code></div><div class="line number59 index58 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number60 index59 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number61 index60 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number62 index61 alt1"><code class="jscript plain">}();</code></div><div class="line number63 index62 alt2">&nbsp;</div><div class="line number64 index63 alt1"><code class="jscript keyword">function</code> <code class="jscript plain">handleEditPageReady()</code></div><div class="line number65 index64 alt2"><code class="jscript plain">{</code></div><div class="line number66 index65 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">AlbumEditPageController.initialize();</code></div><div class="line number67 index66 alt2"><code class="jscript plain">}</code></div><div class="line number68 index67 alt1"><code class="jscript plain">$().ready( handleEditPageReady )</code></div></pre></div>
<p>In this snippet, we have wired the two cancelable button elements up to invoke the <em>handleCancelEdit()</em> method upon a click event. All <em>revertEdits()</em> does is reset the field values based on the stored values in <strong>editableAlbum</strong>. We also take care to kill those event listeners when the page is hidden. Now that we have one requirement fulfilled (cancel-ability) for the <em>album edit</em> page, let’s move on to original intent of the page – submitting document changes.</p>
<h3>Submit</h3>
<p>To submit changes to the target album document form the album edit page we will use the database API provided in the<em> jquery.couchdb</em> library plugin. That library is automatically loaded from the <strong>loader</strong> script created by <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> if remember back to the first post where we accessed the list of available <strong>album documents</strong> from the <strong>albums</strong> database in our <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance. We resolved the <strong>$db</strong> member in the <em>index.html</em> to the <strong>albums</strong> database when the page is loaded. When submitting from the <em>album edit</em> page, we will just use that instance to load, modify and save the target document back to the database.</p>
<p>Make the following modifications to <em>album-edit-page.js</em> and save:</p>
<p><em>/_attachments/script/album-edit-page.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">AlbumEditPageController = </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">editableAlbum;</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleEditPageViewHide()</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#cancelButton"</code><code class="jscript plain">).die( </code><code class="jscript string">"click"</code><code class="jscript plain">, handleCancelEdit );</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#cancelBackButton"</code><code class="jscript plain">).die( </code><code class="jscript string">"click"</code> <code class="jscript plain">);</code></div><div class="line number9 index8 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#submitButton"</code><code class="jscript plain">).die( </code><code class="jscript string">"click"</code> <code class="jscript plain">);</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">editableAlbum = </code><code class="jscript keyword">null</code><code class="jscript plain">;</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumform"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">pageCache =&nbsp; $(document.getElementById(</code><code class="jscript string">"_show/album-edit/"</code> <code class="jscript plain">+ docId));</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">pageCache.unbind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, handleEditPageViewHide );</code></div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">pageCache.empty();</code></div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">pageCache.remove();</code></div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleEditView()</code></div><div class="line number20 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number21 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Watch for bound hide of page to clear from cache.</code></div><div class="line number22 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumform"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number23 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">albumPage = $(document.getElementById(</code><code class="jscript string">"_show/album-edit/"</code> <code class="jscript plain">+ docId));</code></div><div class="line number24 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">albumPage.bind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, handleEditPageViewHide );</code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">storeUneditedDocument();</code></div><div class="line number27 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number28 index27 alt1">&nbsp;</div><div class="line number29 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">storeUneditedDocument()</code></div><div class="line number30 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number31 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">artist = $(</code><code class="jscript string">"input#artistField"</code><code class="jscript plain">).val();</code></div><div class="line number32 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">album = $(</code><code class="jscript string">"input#titleField"</code><code class="jscript plain">).val();</code></div><div class="line number33 index32 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">description = $(</code><code class="jscript string">"textarea#descriptionField"</code><code class="jscript plain">).val();</code></div><div class="line number34 index33 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">editableAlbum = {artist:artist, album:album, description:description};</code></div><div class="line number35 index34 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number36 index35 alt1">&nbsp;</div><div class="line number37 index36 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">saveDocument( document )</code></div><div class="line number38 index37 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number39 index38 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$db.saveDoc( document, {</code></div><div class="line number40 index39 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( response )&nbsp; {</code></div><div class="line number41 index40 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">updateEditableAlbum( document );</code></div><div class="line number42 index41 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number43 index42 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number44 index43 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">alert( </code><code class="jscript string">"Cannot save document: "</code> <code class="jscript plain">+ document._id );</code></div><div class="line number45 index44 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number46 index45 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number47 index46 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number48 index47 alt1 highlighted">&nbsp;</div><div class="line number49 index48 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">updateEditableAlbum( document )</code></div><div class="line number50 index49 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number51 index50 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">editableAlbum.artist = document.artist;</code></div><div class="line number52 index51 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">editableAlbum.album = document.album;</code></div><div class="line number53 index52 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">editableAlbum.description = document.description;</code></div><div class="line number54 index53 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number55 index54 alt2">&nbsp;</div><div class="line number56 index55 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">revertEdits()</code></div><div class="line number57 index56 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number58 index57 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"input#artistField"</code><code class="jscript plain">).val( editableAlbum.artist );</code></div><div class="line number59 index58 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"input#titleField"</code><code class="jscript plain">).val( editableAlbum.album );</code></div><div class="line number60 index59 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"textarea#descriptionField"</code><code class="jscript plain">).val( editableAlbum.description );</code></div><div class="line number61 index60 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number62 index61 alt1">&nbsp;</div><div class="line number63 index62 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleCancelEdit()</code></div><div class="line number64 index63 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number65 index64 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">revertEdits();</code></div><div class="line number66 index65 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number67 index66 alt2">&nbsp;</div><div class="line number68 index67 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">{</code></div><div class="line number69 index68 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">initialize: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number70 index69 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#cancelButton"</code><code class="jscript plain">).live( </code><code class="jscript string">"click"</code><code class="jscript plain">, handleCancelEdit );</code></div><div class="line number71 index70 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#cancelBackButton"</code><code class="jscript plain">).live( </code><code class="jscript string">"click"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">( event ) {</code></div><div class="line number72 index71 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">event.preventDefault();</code></div><div class="line number73 index72 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">handleCancelEdit();</code></div><div class="line number74 index73 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">false</code><code class="jscript plain">;</code></div><div class="line number75 index74 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number76 index75 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#submitButton"</code><code class="jscript plain">).live( </code><code class="jscript string">"click"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">( event ) {</code></div><div class="line number77 index76 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumform"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number78 index77 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$db.openDoc( docId, {</code></div><div class="line number79 index78 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( document ) {</code></div><div class="line number80 index79 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.artist = $(</code><code class="jscript string">"input#artistField"</code><code class="jscript plain">).val();</code></div><div class="line number81 index80 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.album = $(</code><code class="jscript string">"input#titleField"</code><code class="jscript plain">).val();</code></div><div class="line number82 index81 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.description = $(</code><code class="jscript string">"textarea#descriptionField"</code><code class="jscript plain">).val();</code></div><div class="line number83 index82 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">saveDocument( document );</code></div><div class="line number84 index83 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number85 index84 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number86 index85 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">alert( </code><code class="jscript string">"Cannot open document: "</code> <code class="jscript plain">+ docId );</code></div><div class="line number87 index86 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number88 index87 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number89 index88 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number90 index89 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).live( </code><code class="jscript string">"pageshow"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number91 index90 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).die( </code><code class="jscript string">"pageshow"</code> <code class="jscript plain">);</code></div><div class="line number92 index91 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">handleEditView();</code></div><div class="line number93 index92 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number94 index93 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number95 index94 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number96 index95 alt1"><code class="jscript plain">}();</code></div><div class="line number97 index96 alt2">&nbsp;</div><div class="line number98 index97 alt1"><code class="jscript keyword">function</code> <code class="jscript plain">handleEditPageReady()</code></div><div class="line number99 index98 alt2"><code class="jscript plain">{</code></div><div class="line number100 index99 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">AlbumEditPageController.initialize();</code></div><div class="line number101 index100 alt2"><code class="jscript plain">}</code></div><div class="line number102 index101 alt1"><code class="jscript plain">$().ready( handleEditPageReady )</code></div></pre></div>
<p>A click event handler is assigned to the <strong>submitButton</strong> element, from which the document is loaded and assigned the associated field values. Upon update to the new values, <strong>$db</strong>.<em>saveDoc()</em> is invoked with a <strong>success</strong> handler that updates the privately held <strong>editableAlbum</strong> object. This ensures that the values are properly restored back to any saved changes if the user decides to cancel at any time after the successful save.<br>
Almost there. We will just finish off our controller by navigating the user to the <em>album view</em> page upon <strong>Cancel</strong> or <strong>Submit</strong>.</p>
<p>The following is the full <em>album-edit-page.js</em> file with the last modifications highlighted. Save the following changes to <em>album-edit-page.js</em>:</p>
<p><em>/_attachments/script/album-edit-page.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">AlbumEditPageController = </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">editableAlbum;</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleEditPageViewHide()</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#cancelButton"</code><code class="jscript plain">).die( </code><code class="jscript string">"click"</code><code class="jscript plain">, handleCancelEdit );</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#cancelBackButton"</code><code class="jscript plain">).die( </code><code class="jscript string">"click"</code> <code class="jscript plain">);</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#submitButton"</code><code class="jscript plain">).die( </code><code class="jscript string">"click"</code> <code class="jscript plain">);</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">editableAlbum = </code><code class="jscript keyword">null</code><code class="jscript plain">;</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumform"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">pageCache =&nbsp; $(document.getElementById(</code><code class="jscript string">"_show/album-edit/"</code> <code class="jscript plain">+ docId));</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">pageCache.unbind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, handleEditPageViewHide );</code></div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">pageCache.empty();</code></div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">pageCache.remove();</code></div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleEditView()</code></div><div class="line number20 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number21 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Watch for bound hide of page to clear from cache.</code></div><div class="line number22 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumform"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number23 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">albumPage = $(document.getElementById(</code><code class="jscript string">"_show/album-edit/"</code> <code class="jscript plain">+ docId));</code></div><div class="line number24 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">albumPage.bind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, handleEditPageViewHide );</code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">storeUneditedDocument();</code></div><div class="line number27 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number28 index27 alt1">&nbsp;</div><div class="line number29 index28 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">navigateToAlbumPage( docId )</code></div><div class="line number30 index29 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number31 index30 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.mobile.changePage( </code><code class="jscript string">"_show/album/"</code> <code class="jscript plain">+ docId, </code><code class="jscript string">"slide"</code><code class="jscript plain">, </code><code class="jscript keyword">true</code><code class="jscript plain">, </code><code class="jscript keyword">true</code> <code class="jscript plain">);</code></div><div class="line number32 index31 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number33 index32 alt2">&nbsp;</div><div class="line number34 index33 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">storeUneditedDocument()</code></div><div class="line number35 index34 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number36 index35 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">artist = $(</code><code class="jscript string">"input#artistField"</code><code class="jscript plain">).val();</code></div><div class="line number37 index36 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">album = $(</code><code class="jscript string">"input#titleField"</code><code class="jscript plain">).val();</code></div><div class="line number38 index37 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">description = $(</code><code class="jscript string">"textarea#descriptionField"</code><code class="jscript plain">).val();</code></div><div class="line number39 index38 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">editableAlbum = {artist:artist, album:album, description:description};</code></div><div class="line number40 index39 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number41 index40 alt2">&nbsp;</div><div class="line number42 index41 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">saveDocument( document )</code></div><div class="line number43 index42 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number44 index43 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$db.saveDoc( document, {</code></div><div class="line number45 index44 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( response )&nbsp; {</code></div><div class="line number46 index45 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">updateEditableAlbum( document );</code></div><div class="line number47 index46 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">navigateToAlbumPage( document._id );</code></div><div class="line number48 index47 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number49 index48 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number50 index49 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">alert( </code><code class="jscript string">"Cannot save document: "</code> <code class="jscript plain">+ document._id );</code></div><div class="line number51 index50 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number52 index51 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number53 index52 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number54 index53 alt1">&nbsp;</div><div class="line number55 index54 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">updateEditableAlbum( document )</code></div><div class="line number56 index55 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number57 index56 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">editableAlbum.artist = document.artist;</code></div><div class="line number58 index57 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">editableAlbum.album = document.album;</code></div><div class="line number59 index58 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">editableAlbum.description = document.description;</code></div><div class="line number60 index59 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number61 index60 alt2">&nbsp;</div><div class="line number62 index61 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">revertEdits()</code></div><div class="line number63 index62 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number64 index63 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"input#artistField"</code><code class="jscript plain">).val( editableAlbum.artist );</code></div><div class="line number65 index64 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"input#titleField"</code><code class="jscript plain">).val( editableAlbum.album );</code></div><div class="line number66 index65 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"textarea#descriptionField"</code><code class="jscript plain">).val( editableAlbum.description );</code></div><div class="line number67 index66 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number68 index67 alt1">&nbsp;</div><div class="line number69 index68 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleCancelEdit()</code></div><div class="line number70 index69 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number71 index70 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">revertEdits();</code></div><div class="line number72 index71 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumform"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number73 index72 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">navigateToAlbumPage( docId );</code></div><div class="line number74 index73 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number75 index74 alt2">&nbsp;</div><div class="line number76 index75 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">{</code></div><div class="line number77 index76 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">initialize: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number78 index77 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#cancelButton"</code><code class="jscript plain">).live( </code><code class="jscript string">"click"</code><code class="jscript plain">, handleCancelEdit );</code></div><div class="line number79 index78 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#cancelBackButton"</code><code class="jscript plain">).live( </code><code class="jscript string">"click"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">( event ) {</code></div><div class="line number80 index79 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">event.preventDefault();</code></div><div class="line number81 index80 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">handleCancelEdit();</code></div><div class="line number82 index81 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">false</code><code class="jscript plain">;</code></div><div class="line number83 index82 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number84 index83 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#submitButton"</code><code class="jscript plain">).live( </code><code class="jscript string">"click"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">( event ) {</code></div><div class="line number85 index84 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumform"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number86 index85 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$db.openDoc( docId, {</code></div><div class="line number87 index86 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( document ) {</code></div><div class="line number88 index87 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.artist = $(</code><code class="jscript string">"input#artistField"</code><code class="jscript plain">).val();</code></div><div class="line number89 index88 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.album = $(</code><code class="jscript string">"input#titleField"</code><code class="jscript plain">).val();</code></div><div class="line number90 index89 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.description = $(</code><code class="jscript string">"textarea#descriptionField"</code><code class="jscript plain">).val();</code></div><div class="line number91 index90 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">saveDocument( document );</code></div><div class="line number92 index91 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number93 index92 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number94 index93 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">alert( </code><code class="jscript string">"Cannot open document: "</code> <code class="jscript plain">+ docId );</code></div><div class="line number95 index94 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number96 index95 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number97 index96 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number98 index97 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).live( </code><code class="jscript string">"pageshow"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number99 index98 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).die( </code><code class="jscript string">"pageshow"</code> <code class="jscript plain">);</code></div><div class="line number100 index99 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">handleEditView();</code></div><div class="line number101 index100 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number102 index101 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number103 index102 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number104 index103 alt1"><code class="jscript plain">}();</code></div><div class="line number105 index104 alt2">&nbsp;</div><div class="line number106 index105 alt1"><code class="jscript keyword">function</code> <code class="jscript plain">handleEditPageReady()</code></div><div class="line number107 index106 alt2"><code class="jscript plain">{</code></div><div class="line number108 index107 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">AlbumEditPageController.initialize();</code></div><div class="line number109 index108 alt2"><code class="jscript plain">}</code></div><div class="line number110 index109 alt1"><code class="jscript plain">$().ready( handleEditPageReady )</code></div></pre></div>
<p>In <em>navigateToAlbumPage()</em> we use <strong>$.mobile</strong>.<em>changePage()</em> to navigate the user to the external <em>album view</em> page using the <strong>show function</strong> of our <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> application based on the <strong>_id</strong> of the target document that is loaded in the <em>album edit</em> page.</p>
<p>That should be it… aside from one thing. Although (once we push our changes) we can access the page using the <strong>#_show/album-edit/${id}</strong> location, as the application currently stands, there is no way to access the <em>album edit</em> page from any other page in the application. To remedy that, we will make some modifications to the <em>album.html</em> template and the <em>album-page.js</em> script to navigate the user to the <em>album edit</em> page.</p>
<h2>Accessing the Album Edit Page</h2>
<p>I am going to assume that you have been following along with <a href="http://custardbelly.com/blog/?p=297" target="_blank">previous posts</a> here and that you already have the <em>/templates/album.html</em> and <em>/_attachments/script/album-page.js</em> files. We are going to make modifications to them to include an <strong>edit button</strong> in the <em>album view</em> page and assign a <em>click</em> handler to navigate to the <em>album edit</em> page.</p>
<h3>album.html</h3>
<p>Open up the <em>/templates/album.html</em> file in your favorite text editor and save the following modifications:</p>
<p><em>/templates/album.html</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"page"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albumview"</code> <code class="xml color1">data-position</code><code class="xml plain">=</code><code class="xml string">"inline"</code> <code class="xml color1">data-back</code><code class="xml plain">=</code><code class="xml string">"true"</code><code class="xml plain">&gt;</code></div><div class="line number2 index1 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"header"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albumheader"</code><code class="xml plain">&gt;</code></div><div class="line number3 index2 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">h1</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"albumtitle"</code><code class="xml plain">&gt;{{title}}&lt;/</code><code class="xml keyword">h1</code><code class="xml plain">&gt;</code></div><div class="line number4 index3 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">a</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#home"</code> <code class="xml color1">data-icon</code><code class="xml plain">=</code><code class="xml string">"grid"</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-btn-right"</code><code class="xml plain">&gt;Home&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;</code></div><div class="line number5 index4 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number6 index5 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"content"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albumcontent"</code> <code class="xml color1">data-identity</code><code class="xml plain">=</code><code class="xml string">"{{document}}"</code><code class="xml plain">&gt;</code></div><div class="line number7 index6 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">h2</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"artist"</code><code class="xml plain">&gt;{{artist}}&lt;/</code><code class="xml keyword">h2</code><code class="xml plain">&gt;</code></div><div class="line number8 index7 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">p</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"title"</code><code class="xml plain">&gt;{{title}}&lt;/</code><code class="xml keyword">p</code><code class="xml plain">&gt;</code></div><div class="line number9 index8 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">p</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"description"</code><code class="xml plain">&gt;{{description}}&lt;/</code><code class="xml keyword">p</code><code class="xml plain">&gt;</code></div><div class="line number10 index9 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">p</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"editbutton"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"button"</code> <code class="xml color1">data-theme</code><code class="xml plain">=</code><code class="xml string">"a"</code><code class="xml plain">&gt;Edit&lt;/</code><code class="xml keyword">p</code><code class="xml plain">&gt;</code></div><div class="line number11 index10 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number12 index11 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"footer"</code> <code class="xml plain">/&gt;</code></div><div class="line number13 index12 alt2"><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number14 index13 alt1"><code class="xml plain">{{&gt;scripts}}</code></div></pre></div>
<p>The only modification to the <em>album.html</em> template e have made is the inclusion of an <strong>Edit</strong> button which is a <strong>p</strong> element attributed with the <strong>data-role</strong> of <em>button</em>. The <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework will handle styling the <strong>Edit</strong> button to have consistency in look-and-feel with the other buttons throughout the application. Now let’s hook up a <em>click</em> event listener for that button element to take the user to the <em>album edit</em> page.</p>
<h3>album-page.js</h3>
<p>Open up <em>/_attachments/script/album-page.js</em> in your favorite text editor and save the following modifications:</p>
<p><em>/_attachments/script/album-page.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">AlbumPageController = </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleView()</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number5 index4 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#editbutton"</code><code class="jscript plain">).live( </code><code class="jscript string">"click"</code><code class="jscript plain">, handleEdit );</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Watch for bound hide of page to clear from cache.</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumcontent"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">albumPage = $(document.getElementById(</code><code class="jscript string">"_show/album/"</code> <code class="jscript plain">+ docId));</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">albumPage.bind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, handlePageViewHide );</code></div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleEdit( event )</code></div><div class="line number14 index13 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number15 index14 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Prevent default link event.</code></div><div class="line number16 index15 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">event.preventDefault();</code></div><div class="line number17 index16 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Access document id from data-identity.</code></div><div class="line number18 index17 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumcontent"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number19 index18 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Change page.</code></div><div class="line number20 index19 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.mobile.changePage( </code><code class="jscript string">"_show/album-edit/"</code> <code class="jscript plain">+ docId, </code><code class="jscript string">"slide"</code><code class="jscript plain">, </code><code class="jscript keyword">false</code><code class="jscript plain">, </code><code class="jscript keyword">true</code> <code class="jscript plain">);</code></div><div class="line number21 index20 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">false</code><code class="jscript plain">;</code></div><div class="line number22 index21 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number23 index22 alt2">&nbsp;</div><div class="line number24 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handlePageViewHide()</code></div><div class="line number25 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number26 index25 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#editbutton"</code><code class="jscript plain">).die( </code><code class="jscript string">"click"</code><code class="jscript plain">, handleEdit );</code></div><div class="line number27 index26 alt2">&nbsp;</div><div class="line number28 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumcontent"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number29 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">albumPageCache =&nbsp; $(document.getElementById(</code><code class="jscript string">"_show/album/"</code> <code class="jscript plain">+ docId));</code></div><div class="line number30 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">albumPageCache.unbind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, handlePageViewHide );</code></div><div class="line number31 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">albumPageCache.empty();</code></div><div class="line number32 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">albumPageCache.remove();</code></div><div class="line number33 index32 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number34 index33 alt1">&nbsp;</div><div class="line number35 index34 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">{</code></div><div class="line number36 index35 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">initialize : </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number37 index36 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).live( </code><code class="jscript string">"pageshow"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number38 index37 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).die( </code><code class="jscript string">"pageshow"</code> <code class="jscript plain">);</code></div><div class="line number39 index38 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">handleView();</code></div><div class="line number40 index39 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number41 index40 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number42 index41 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number43 index42 alt2"><code class="jscript plain">}();</code></div><div class="line number44 index43 alt1">&nbsp;</div><div class="line number45 index44 alt2"><code class="jscript keyword">function</code> <code class="jscript plain">handlePageViewReady()</code></div><div class="line number46 index45 alt1"><code class="jscript plain">{</code></div><div class="line number47 index46 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">AlbumPageController.initialize();</code></div><div class="line number48 index47 alt1"><code class="jscript plain">}</code></div><div class="line number49 index48 alt2"><code class="jscript plain">$().ready( handlePageViewReady );</code></div></pre></div>
<p>The <em>handleEdit()</em> handler navigates to the album edit page using the <strong>$.mobile</strong>.<em>changePage()</em> method pointing to the page created by the <strong>show function</strong> using the target document <strong>id</strong> that is used to show the <em>album view</em> page.</p>
<p>Now that we have implemented a way to navigate to the album edit page from the application through the album view page, we can deploy our changes to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance for our <strong>albums</strong> application.</p>
<h2>Deployment</h2>
<p>Our <strong>Albums</strong> application has been modified to allow a user to modify properties of an <strong>album document</strong> from an <em>album edit</em> page. That page can be accessed by clicking an <strong>Edit</strong> button from the <em>album view</em> page accessible from a selection of an album from the list presented on the landing <em>index.html</em>. With these modifications saved, we can now push to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database using the <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> utility. Open a terminal and navigate to the directory where you create your <strong>CouchApp</strong> applications (for me that is <em>/Documents/workspace/custardbelly/couchdb</em> and in there i have a folder named <em>albums</em> which is the <strong>CouchApp</strong> application directory for these examples). Enter the following command to push the changes to the <strong>CouchDB</strong> instance:</p>
<div><pre><div class="line number1 index0 alt2"><code class="bash plain">couchapp push albums http:</code><code class="bash plain">//127</code><code class="bash plain">.0.0.1:5984</code><code class="bash plain">/albums</code></div></pre></div>
<p>If all was successful and you now go to <a href="http://127.0.0.1:5984/albums/_design/albums/index.html" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html</a>, click on an album from the list and select to edit that document. From the <em>album edit</em> page you are able to either cancel any edits or submit the changes to the target <strong>album document</strong>. What a thing of beauty <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley">  Let’s take a look at the current state of the application:</p>
<p><em>index.html (aka #home)</em>:<br>
<img src="http://www.custardbelly.com/blog/images/couchapp_six.png" alt="index.html"></p>
<p><em>album view page</em>:<br>
<img src="http://www.custardbelly.com/blog/images/couchapp_seven.png" alt="album view page"></p>
<p><em>album edit page</em>:<br>
<img src="http://www.custardbelly.com/blog/images/couchapp_eight.png" alt="album edit page"></p>
<h2>Conclusion</h2>
<p>This post got a lot longer than I had anticipated… which just goes to show what a wind-bag i am <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley">  All joking aside, I think we covered some good ground, especially about saving modifications to a document back to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database. We also covered, again, how to monitor pages so as to remove them from cache and ensure that the user is always presented with the latest document information. We also delved into assigning event listeners to button elements. All good fun… well, hopefully, it was to you.</p>
<p><em>[Note] This post was written against the following software versions:</em><br>
<strong>CouchDB </strong>– 1.0.1<br>
<strong>CouchApp</strong> – 0.7.2<br>
<strong>jQuery</strong> – 1.4.4<br>
<strong>jQuery Mobile</strong> – 1.0a2<br>
<em>If you have found this post and any piece has moved forward, hopefully the examples are still viable/useful. I will not be updating the examples in this post in parellel with updates to any of the previously mentioned software, unless explicitly noted.</em></p>
<p><strong>Articles in this series:</strong></p>
<ol>
<li><a href="http://custardbelly.com/blog/?p=244" target="_blank">Getting Started</a></li>
<li><a href="http://custardbelly.com/blog/?p=278" target="_blank">Displaying a page detail of a single album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=297" target="_blank">Templates and Mustache</a></li>
<li><a href="http://custardbelly.com/blog/?p=318" target="_blank">Displaying an editable page of an album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=332" target="_blank">Creating and Adding an album document.</a></li>
<li><a href="http://custardbelly.com/blog/?p=344" target="_blank">Deleting an album document</a></li>
<li><a href="http://custardbelly.com/blog/?p=360" target="_blank">Authorization and Validation – Part 1</a></li>
<li><a href="http://custardbelly.com/blog/?p=394">Authorization and Validation – Part 2</a></li>
</ol>
<p><a href="http://custardbelly.com/downloads/couchapp/jqm_couchdb_albums.zip">Full source for albums couchapp here.</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/couchdb/" title="View all posts in CouchDB" rel="category tag">CouchDB</a>,  <a href="http://custardbelly.com/blog/category/jquery/" title="View all posts in jquery" rel="category tag">jquery</a>,  <a href="http://custardbelly.com/blog/category/jquery-mobile/" title="View all posts in jquery-mobile" rel="category tag">jquery-mobile</a>.</p>
	
	

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">–</span> <abbr class="published" title="2011-01-04T06:26">January 4, 2011</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-318-target"></div>
	<div class="clear"></div>
	
	