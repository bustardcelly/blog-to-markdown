
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2013/02/15/the-making-of-a-test-driven-grocery-list-application-in-js-part-ix/" title="Permanent link to The Making of a Test-Driven Grocery List Application in JS: Part IX" rel="bookmark" rev="post-777">The Making of a Test-Driven Grocery List Application in JS: Part IX</a></h1>
	
	<div class="entry-content full-content">
		<p><em>This is the ninth installment in a series of building a Test-Driven Grocery List application using <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> and <a href="http://requirejs.org" target="_blank">RequireJS</a>. To learn more about the intent and general concept of the series please visit <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i/">The Making of a Test-Driven Grocery List Application in JavaScript: Part I</a></em><br>
—</p>
<h1>Introduction</h1>
<p>In the <a href="http://custardbelly.com/blog/2013/01/22/the-making-of-a-test-driven-grocery-list-application-part-viii/" target="_blank">previous article</a>, we pretty much wrapped up all the user-based functionality and ended with a working <strong>Grocery List</strong> application that we could start using. There is one little snag though… no persistance. If you made this gloriously elaborate list that detailed everything you needed at the store, then closed the browser and reopened it, the list was gone! That will not do.</p>
<p>There are many factors and paradigms to consider in choosing the level of persistence when it comes to handling session and user based applications. Without introducing a discussion about authentication, when approaching the integration persistence you have to take into account system-based vs user-based persistence, client-side vs server-side storage, and – nowadays, more commonly – the cross pollination of the two: <a href="http://en.wikipedia.org/wiki/Occasionally_connected_computing" target="_blank">occasional-connectivity</a>. (<em>not to mention browser support in all this</em>) We won’t be getting into all of that <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley">  We’ll be using the <code>localStorage</code> of today’s modern browser.</p>
<p>The intent of this article in the series is to implement client-side, browser-based persistence for the <strong>Grocery List</strong> application. It would be nice to store our list remotely so it can be accessed by all browsers on all devices, but I feel it would introduce too many new libraries, software and concepts to this series. I will most likely add it personally after this series is over, and I invite you to as well – keeping in mind to do it using TDD <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley">  The most I can offer at this point, is to keep the code we will write clean enough to support such future endeavours.</p>
<h1>What Tests to Modify to Get Us There?</h1>
<p>Good question. Let’s first think about what actions will prompt an update to the list in storage. Actually, if we look at the feature specs we have created throughout this series and separated out into the <code>/feature</code> directory itself, we pretty much have all the defined actions that will trigger an update to the stored list:<br>
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_1.png" alt="Spec listing"></p>
<p>All of these features are a result from interacting with the <code>list-controller</code>. My first inkling is to add responsibility to the <code>list-controller</code> so that, along with the other operations it handles in list management, it communicates with a service layer to update the <strong>Grocery List</strong> in storage. However, I think that would add too much burden on the <code>list-controller</code> and, when taking into account that requirements around storage may change, the introduction of such complexity into the <code>list-controller</code> may quickly make our tests feel chaotic.</p>
<p>As such, I propose that we should start off with the expectation that the <code>list-controller</code> will notify of its underlying collection having been modified, not only upon its change in length, but of the items within the collection, as well. We can then capture those events and forward them on to whichever service implementation we have without having to pass that dependency into the <code>list-controller</code> and burdening it with such communication.</p>
<h2>New Expectation for Add Item</h2>
<p>To start, let’s add a quick spec to the <em>Add Item</em> feature that defines an expectation from the <code>list-controller</code> to notify when an item has been added:</p>
<p><em>/test/jasmine/spec/feature/additem.spec.js</em></p>
<div><pre><div class="line number45 index0 alt2"><code class="jscript plain">async.it(</code><code class="jscript string">'should dispatch a save-item event'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number46 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">newItem;</code></div><div class="line number47 index2 alt2">&nbsp;</div><div class="line number48 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">$(listController).on(</code><code class="jscript string">'save-item'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(event) {</code></div><div class="line number49 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(event.item).not.toBeUndefined();</code></div><div class="line number50 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(listController).off(</code><code class="jscript string">'save-item'</code><code class="jscript plain">);</code></div><div class="line number51 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number52 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number53 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">newItem = listController.createNewItem();</code></div><div class="line number54 index9 alt1"><code class="jscript plain">});</code></div></pre></div>
<p>In creating this expectation, we have also begun to define the actual make-up of the event we intend to receive: the event type being <code>save-item</code> and the access of the <code>item</code> that was saved.</p>
<p>Run it and we are red, as expected:<br>
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_2.png" alt="Failing test on add item event response"></p>
<p>Taking what we have defined as our expectation when an item is added, we’ll modify the list-controller to get this passing. First we’ll add a factory method to generate <code>save-item</code> events:</p>
<p><em>/script/controller/list-controller.js</em></p>
<div><pre><div class="line number5 index0 alt2"><code class="jscript keyword">function</code> <code class="jscript plain">createSaveEvent(item) {</code></div><div class="line number6 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">event = $.Event(</code><code class="jscript string">'save-item'</code><code class="jscript plain">);</code></div><div class="line number7 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">event.item = item;</code></div><div class="line number8 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">event;</code></div><div class="line number9 index4 alt2"><code class="jscript plain">}</code></div></pre></div>
<p>Fairly straight-forward and similar to other event factory methods declared previously in this series. Since we are addressing an expectation of event notification on add of item, we know where in the list-controller we can add that dispatch – in response to the addition of an item on the collection:</p>
<p><em>/script/controller/list-controller.js</em></p>
<div><pre><div class="line number61 index0 alt2"><code class="jscript plain">$itemView.appendTo(listController.$view);</code></div><div class="line number62 index1 alt1"><code class="jscript plain">rendererList.addItem(itemController);</code></div><div class="line number63 index2 alt2 highlighted"><code class="jscript plain">$(listController).trigger(createSaveEvent(model));</code></div><div class="line number64 index3 alt1"><code class="jscript plain">itemController.state = itemControllerFactory.state.EDITABLE;</code></div></pre></div>
<p>Back in business.<br>
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_3.png" alt="Passing test on add item event response"></p>
<h2>New Expectation for Remove Item</h2>
<p>Let’s quickly just do a similar modification to the <code>list-controller</code> with regards to the <em>Remove Item</em> feature. First we’ll append a spec in the <em>removeitem.spec</em> suite with an expectation of being notified on <code>remove-item</code>:</p>
<p><em>/test/jasmine/spec/feature/removeitem.spec.js</em></p>
<div><pre><div class="line number30 index0 alt1"><code class="jscript plain">async.it(</code><code class="jscript string">'should dispatch a remove-item event'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number31 index1 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">removedItem;</code></div><div class="line number32 index2 alt1">&nbsp;</div><div class="line number33 index3 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">$(listController).on(</code><code class="jscript string">'remove-item'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(event) {</code></div><div class="line number34 index4 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(event.item).not.toBeUndefined();</code></div><div class="line number35 index5 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(listController).off(</code><code class="jscript string">'remove-item'</code><code class="jscript plain">);</code></div><div class="line number36 index6 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number37 index7 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number38 index8 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">removedItem = listController.removeItem(groceryItem);</code></div><div class="line number39 index9 alt2"><code class="jscript plain">});</code></div></pre></div>
<p>Sparing you another image of the specrunner turning <span style="color: red;">red</span>, that will fail with the timeout that we saw before. We’ll fix that up by adding a trigger in the removal of an item from the collection handler in <code>list-controller</code>. First with the addition of a factory method for the <code>remove-item</code> event:</p>
<p><em>/script/controller/list-controller.js</em></p>
<div><pre><div class="line number11 index0 alt2"><code class="jscript keyword">function</code> <code class="jscript plain">createRemoveEvent(item) {</code></div><div class="line number12 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">event = $.Event(</code><code class="jscript string">'remove-item'</code><code class="jscript plain">);</code></div><div class="line number13 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">event.item = item;</code></div><div class="line number14 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">event;</code></div><div class="line number15 index4 alt2"><code class="jscript plain">}</code></div></pre></div>
<p>And then with an additional line to the <code>remove</code> response on the collection:</p>
<p><em>/script/controller/list-controller.js</em></p>
<div><pre><div class="line number81 index0 alt2"><code class="jscript keyword">case</code> <code class="jscript plain">EventKindEnum.REMOVE:</code></div><div class="line number82 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">model = event.items.shift();</code></div><div class="line number83 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">itemController = listController.getRendererFromItem(model),</code></div><div class="line number84 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">$itemController = $(itemController);</code></div><div class="line number85 index4 alt2">&nbsp;</div><div class="line number86 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">(itemController) {</code></div><div class="line number87 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$itemView = itemController.parentView;</code></div><div class="line number88 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$itemView.remove();</code></div><div class="line number89 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemController.dispose();</code></div><div class="line number90 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$itemController.off(</code><code class="jscript string">'remove'</code><code class="jscript plain">);</code></div><div class="line number91 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$itemController.off(</code><code class="jscript string">'commit'</code><code class="jscript plain">);</code></div><div class="line number92 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">rendererList.removeItem(itemController);</code></div><div class="line number93 index12 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(listController).trigger(createRemoveEvent(model));</code></div><div class="line number94 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number95 index14 alt2"><code class="jscript keyword">break</code><code class="jscript plain">;</code></div></pre></div>
<p>Run the tests, and we are back to passing:<br>
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_4.png" alt="Passing on removal event from list-controller"></p>
<h2>New Expectation for Save Item</h2>
<p>Sort of repetitive, but we are on a roll… let’s go through the similar process to ensure that a notification for <code>save-item</code> is dispatched when the user has modified its name and committed it to the list – the <em>Save Item</em> feature we added in the <a href="http://custardbelly.com/blog/2013/01/22/the-making-of-a-test-driven-grocery-list-application-part-viii/" target="_blank">last article</a>.</p>
<p><em>/test/jasmine/spec/feature/saveitem.spec.js</em></p>
<div><pre><div class="line number79 index0 alt2"><code class="jscript plain">async.it(</code><code class="jscript string">'should dispatch a save-item event'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number80 index1 alt1">&nbsp;</div><div class="line number81 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">$(listController).on(</code><code class="jscript string">'save-item'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(event) {</code></div><div class="line number82 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(event.item).toEqual(item);</code></div><div class="line number83 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(listController).off(</code><code class="jscript string">'save-item'</code><code class="jscript plain">);</code></div><div class="line number84 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number85 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number86 index7 alt1">&nbsp;</div><div class="line number87 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">item.name = itemName;</code></div><div class="line number88 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">itemRenderer.state = itemControllerFactory.state.UNEDITABLE;</code></div><div class="line number89 index10 alt2"><code class="jscript plain">});</code></div></pre></div>
<p>That’ll put us in the <span style="color: red;">red</span> with the same old timeout issue. Getting back to green, we’ll trigger the <code>save-item</code> event upon committal of the item to the list, which if you remember – and is described in the test – is in response to the <code>list-item-controller</code> notifying of change to the item model:</p>
<p><em>/test/jasmine/spec/feature/list-controller.js</em></p>
<div><pre><div class="line number75 index0 alt2"><code class="jscript plain">$itemController.on(</code><code class="jscript string">'commit'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(event) {</code></div><div class="line number76 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">(!isValidValue(model.name)) {</code></div><div class="line number77 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">listController.removeItem(model);</code></div><div class="line number78 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number79 index4 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">else</code> <code class="jscript plain">{</code></div><div class="line number80 index5 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(listController).trigger(createSaveEvent(model));</code></div><div class="line number81 index6 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number82 index7 alt1"><code class="jscript plain">});</code></div></pre></div>
<p>Back to green!<br>
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_5.png" alt="Passing on commital of item form list-item-controller"></p>
<p>The amount of those little dots just keeps growing. Makes you feel all warm inside. Cherish that, ’cause it will go away…</p>
<h3>Hold Up</h3>
<p>Just stepping back, it may seem a little odd that we are calling <code>save-item</code> when we add and commit the item to the list; after all they are the same item, we do we need to notify on save multiple times? The reason being is that upon any modification to an item – including its existence – the store needs to be modified. We haven’t gotten into the service layer for storage yet, but it will be abstracted out that a response from save-item will be internally handled as whether to append the item (from add) or to update an item already existant (from commit). Until we get to that service layer implementation for <code>localStorage</code>, we’ll go about setting expectations of <code>save-item</code> notification on modification to an item.</p>
<p>Which actually brings up a good point… what about marking off an item? We will need to notify on change of an item being marked off, as well.</p>
<h2>New Expectation for Mark-Off Item</h2>
<p>We tackled the <em>Mark-Off Item</em> feature a <a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii/" target="_blank">while back</a> in this series. Just a quick refresher on the story:</p>
<p><em>// story</em><br>
—<br>
<strong>Story</strong>: Item is marked off on grocery list</p>
<p><strong>In order to</strong> remember what items have already made it to the cart<br>
<strong>As a</strong> grocery shopper<br>
<strong>I want to</strong> mark an item as being attained on the grocery list.<br>
—</p>
<p>We implemented the feature, and upon user press of the item while in non-edit mode, it toggles its <code>marked</code> property on the model and updates the UI to add or remove a <del datetime="2013-02-01T10:32:47+00:00">strikethrough</del> on the label.</p>
<p>We’ve got a spec suite for the <em>Mark-Off Item</em> feature already, so we’ll append an expectation for <code>save-item</code> to it just as we have done with the other feature specs in this article:</p>
<p><em>/test/jasmine/spec/feature/markitem.spec.js</em></p>
<div><pre><div class="line number44 index0 alt1"><code class="jscript plain">async.it(</code><code class="jscript string">'should dispatch a save-item event'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number45 index1 alt2">&nbsp;</div><div class="line number46 index2 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">timeout = setTimeout(</code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number47 index3 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">clearTimeout(timeout);</code></div><div class="line number48 index4 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(listController).off(</code><code class="jscript string">'save-item'</code><code class="jscript plain">);</code></div><div class="line number49 index5 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}, jasmine.DEFAULT_TIMEOUT_INTERNAL);</code></div><div class="line number50 index6 alt1">&nbsp;</div><div class="line number51 index7 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">$(listController).on(</code><code class="jscript string">'save-item'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(event) {</code></div><div class="line number52 index8 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(event.item).toBe(item);</code></div><div class="line number53 index9 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(listController).off(</code><code class="jscript string">'save-item'</code><code class="jscript plain">);</code></div><div class="line number54 index10 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number55 index11 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number56 index12 alt1">&nbsp;</div><div class="line number57 index13 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">item.marked = </code><code class="jscript keyword">true</code><code class="jscript plain">;</code></div><div class="line number58 index14 alt1"><code class="jscript plain">});</code></div></pre></div>
<p>… and that will bring us back to <span style="color: red;">failing</span>.<br>
<small>The <code>timeout</code> placed in there is just to ensure that listener(s) to the <code>save-item</code> event are removed regardless of the async test timing out.</small></p>
<p>The resolution to the issue is a trickier one than those of the previous in this article, however. Currently the <code>list-item-controller</code> is the only component that actually concerned with this change in marked status. It is not concerned with notifying any other party of the change to its model. The model does, however, notify of any property changes. I see two ways in which we can get back to <span style="color: green;">passing</span>:</p>
<ol type="a">
<li>Assign a handler for <code>property-change</code> on model when it is first created and returned from <code>listController.createNewItem()</code></li>
<li>Dispatch a <code>commit</code> event from <code>list-item-controller</code> on change to <code>marked</code> property on the underlying model</li>
</ol>
<p>While both options will most likely get us where we need to be, the former adds additional management to the <code>list-controller</code>; its already listening in on <code>commit</code> from its <code>list-item-controller</code> instance, so modifying the <code>list-item-controller</code> to notify of change to the <code>marked</code> property seems to be the path of least resistance.</p>
<p>We had previously set up the <code>commit</code> notification on response from leaving the <code>EDITABLE</code> state of the <code>list-item-controller</code>:</p>
<p><em>/script/controller/list-item-controller.js</em></p>
<div><pre><div class="line number45 index0 alt2"><code class="jscript comments">// append state-based item.</code></div><div class="line number46 index1 alt1"><code class="jscript keyword">if</code><code class="jscript plain">(event.newState === stateEnum.UNEDITABLE) {</code></div><div class="line number47 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">controller.parentView.append(controller.$uneditableView);</code></div><div class="line number48 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">controller.save();</code></div><div class="line number49 index4 alt2"><code class="jscript plain">}</code></div></pre></div>
<p>That implementation got us to passing previously in which we described the expectation of a user committing an item to the list with a valid name (un-empty string). Our issue at hand is to also invoke the <code>save()</code> method on <code>list-item-controller</code> when the <code>marked</code> property is modified. In thinking about it now, while the committal of an item is tied to the change of state, it runs a validation on the <code>name</code> property to ensure that the item can be added/kept in the collection – so, in actuality <code>commit</code> can be tied to property updates to the item model.</p>
<p>As such, let’s remove line <code>48</code> from the above snippet and insert the invocation of <code>save()</code> to the handler in <code>list-item-controller</code> for <code>property-change</code> on the model:</p>
<p><em>/script/controller/list-item-controller.js</em></p>
<div><pre><div class="line number102 index0 alt1"><code class="jscript plain">$(</code><code class="jscript keyword">this</code><code class="jscript plain">.model).on(</code><code class="jscript string">'property-change'</code><code class="jscript plain">, (</code><code class="jscript keyword">function</code><code class="jscript plain">(controller) {</code></div><div class="line number103 index1 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">function</code><code class="jscript plain">(event) {</code></div><div class="line number104 index2 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">handlePropertyChange.call(</code><code class="jscript keyword">null</code><code class="jscript plain">, controller, event);</code></div><div class="line number105 index3 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">controller.save();</code></div><div class="line number106 index4 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number107 index5 alt2"><code class="jscript plain">}(</code><code class="jscript keyword">this</code><code class="jscript plain">)));</code></div></pre></div>
<p>Run the specrunner again…<br>
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_5_fail.png" alt="We broke it"></p>
<p>… and we broke it <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_sad.gif" alt=":(" class="wp-smiley"> </p>
<p>The reason for those <span style="color: red;">X</span>’s is due to the logic we have held in <code>list-controller</code> on save of an item: it checks it’s <code>name</code> property and removes it from the list if considered an invalid value – which an empty string is.</p>
<p>I sense some modification to such logic in the future, but for now we can get the tests back to passing by providing a <code>name</code> property value to the created item in our mark-item spec:</p>
<p>/tests/jasmine/spec/feature/markitem.spec.js</p>
<div><pre><div class="line number9 index0 alt2"><code class="jscript plain">beforeEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number10 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">item = listController.createNewItem();</code></div><div class="line number11 index2 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">item.name = </code><code class="jscript string">'apples'</code><code class="jscript plain">;</code></div><div class="line number12 index3 alt1"><code class="jscript plain">});</code></div></pre></div>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_ix_6.png" alt="Passing on model property update"></p>
<p>We’re green!</p>
<p>Tagged <strong>0.1.13</strong>: <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.13" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.13</a></p>
<h3>Settle Down</h3>
<p>We have verified our expectations of <code>save-item</code> and <code>remove-item</code> events being dispatched from <code>list-controller</code> – new and model updates issuing the former, removal issuing the later. The work we have done was to separate concerns and not burden the <code>list-controller</code> itself with service communication for persisting the <strong>Grocery List</strong> items across browser sessions, but we have yet to address the actual service layer implementation that will take all these notifications.</p>
<h2>Storage Service</h2>
<p>The <code>storage-service</code> will provide a service layer for communication with storage – whether that be remote or local. It will serve as a facade to an existing storage of grocery list items persisted somewhere other than the current application session. For the purposes of this article, that persistence layer is going to be the <code>localStorage</code> of the browser.</p>
<p>While fleshing out the storage service and its API, we’ll <em>loosely</em> use the technique of <a href="http://coderetreat.org/facilitating/activities/tdd-as-if-you-meant-it" target="_blank">‘TDD as if you meant it’</a>. I say <em>loosely</em> in part because to fully do it and explain each step would be a lot of noise for this article; the main practice point to take away – and I hope I express – is that the component you are testing is actually being built while you make the expectations for it pass.</p>
<h3>Tests</h3>
<p>To start, we’ll create a bare-bones module for our service layer:</p>
<p><em>/script/service/storage-service</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">define([</code><code class="jscript string">'jquery'</code><code class="jscript plain">], </code><code class="jscript keyword">function</code><code class="jscript plain">($) {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">store = {};</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">store;</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="jscript plain">});</code></div></pre></div>
<p>And let’s create the beginnings of our test:</p>
<p><em>/test/jasmine/spec/storage-service.spec.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">define([</code><code class="jscript string">'jquery'</code><code class="jscript plain">, </code><code class="jscript string">'script/service/storage-service'</code><code class="jscript plain">, </code><code class="jscript string">'script/model/grocery-ls-item'</code><code class="jscript plain">],</code></div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code><code class="jscript plain">($, store, modelFactory) {</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">describe(</code><code class="jscript string">'Grocery List storage-service'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">describe(</code><code class="jscript string">'getItems()'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">it(</code><code class="jscript string">'should return of type array'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(</code><code class="jscript keyword">false</code><code class="jscript plain">).toEqual(</code><code class="jscript keyword">true</code><code class="jscript plain">);</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">it(</code><code class="jscript string">'should return array of grocery-ls-item types'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(</code><code class="jscript keyword">false</code><code class="jscript plain">).toEqual(</code><code class="jscript keyword">true</code><code class="jscript plain">);</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="jscript plain">});</code></div></pre></div>
<p>In the test we have set up some tests for the <code>getItems()</code> method for the service. Prior to any implementation, it should be known that communication with the <code>storage-service</code> will be considered asynchronous – meaning all operations will return a <a href="http://api.jquery.com/category/deferred-object/" target="_blank">jQuery Deferred</a>. This will abstract out the storage proxy that will be employed by the <code>storage-service</code> and will respond in an asynchronous manner regardless of whether the store is immediately accessible – as in the case of <code>localStorage</code> – or remote.</p>
<p><small>Truthfully, in practice, I should only do one tests at a time, but we are testing the expectations for access of the same item listing; to save you from reading the ramblings of adding another test, I declared them both at the start.</small></p>
<p>Let’s stub out the API and start testing and building the <code>storage-service</code>:</p>
<p><em>/test/jasmine/spec/storage-service.spec.js</em></p>
<div><pre><div class="line number6 index0 alt1"><code class="jscript plain">describe(</code><code class="jscript string">'getItems()'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number7 index1 alt2">&nbsp;</div><div class="line number8 index2 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">items,</code></div><div class="line number9 index3 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemOne = modelFactory.create(),</code></div><div class="line number10 index4 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemTwo = modelFactory.create(),</code></div><div class="line number11 index5 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">async = </code><code class="jscript keyword">new</code> <code class="jscript plain">AsyncSpec(</code><code class="jscript keyword">this</code><code class="jscript plain">);</code></div><div class="line number12 index6 alt1 highlighted">&nbsp;</div><div class="line number13 index7 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">async.beforeEach( </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number14 index8 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">deferred = $.Deferred(),</code></div><div class="line number15 index9 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">getStub = sinon.stub().returns(deferred);</code></div><div class="line number16 index10 alt1 highlighted">&nbsp;</div><div class="line number17 index11 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred.resolve([itemOne, itemTwo]);</code></div><div class="line number18 index12 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.getItems = getStub;</code></div><div class="line number19 index13 alt2 highlighted">&nbsp;</div><div class="line number20 index14 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.getItems().then(</code><code class="jscript keyword">function</code><code class="jscript plain">(list) {</code></div><div class="line number21 index15 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">items = list;</code></div><div class="line number22 index16 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number23 index17 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number24 index18 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number25 index19 alt2 highlighted">&nbsp;</div><div class="line number26 index20 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">afterEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number27 index21 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">//</code></div><div class="line number28 index22 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number29 index23 alt2">&nbsp;</div><div class="line number30 index24 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">it(</code><code class="jscript string">'should return of type array'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number31 index25 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(Array.isArray(items)).toEqual(</code><code class="jscript keyword">true</code><code class="jscript plain">);</code></div><div class="line number32 index26 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(items.length).toEqual(2);</code></div><div class="line number33 index27 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number34 index28 alt1">&nbsp;</div><div class="line number35 index29 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">it(</code><code class="jscript string">'should return array of grocery-ls-item types'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number36 index30 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(items[0]).toBe(itemOne);</code></div><div class="line number37 index31 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(items[1]).toBe(itemTwo);</code></div><div class="line number38 index32 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number39 index33 alt2">&nbsp;</div><div class="line number40 index34 alt1"><code class="jscript plain">});</code></div></pre></div>
<p>In the <code>beforeEach()</code>, we’re using anonymous stubs from <a href="http://sinonjs.org/" target="_blank">SinonJS</a>, which allow us to stub out methods that may not necessarily already exist on an object. I have used it previously in this series, but we’ll be using it pretty much exclusively while we stub out the API for the <code>storage-service</code>.</p>
<p>Staying true to our idea that the service will provide an asynchronous communication layer, <code>getItems()</code> returns a deferred which has resolved to a listing of two <code>grocery-ls-item</code> instances in our tests.</p>
<p>Sometimes when working with a single feature, I like to isolate it out from my tests for a bit. Here is what the specrunner reports with running just <strong>storage-service.spec</strong>:<br>
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_7.png" alt="Passing on succss of getItems() in service"></p>
<p>We could move that implementation to <code>storage-service</code> module now, but we are sort of in a <a href="http://en.wikipedia.org/wiki/Chicken_or_the_egg" target="_blank">chicken-or-the-egg</a> scenario. We’ve canned the resolved <code>grocery-ls-item</code> list in the test, but how does the list get filled up in an actual scenario for <code>storage-service</code>? It’s an excellent question, and something I often puzzle myself with. I mean, we’ll need a <code>saveItem()</code> method no doubt in order to add items to the store. But shouldn’t that method now be stubbed out in a new test? And how do I test that <code>saveItem()</code> works without <code>getItems()</code> being already tested and verified? I could go in circles…</p>
<p>Let’s just stub out an <code>saveItem()</code> method on <code>storage-service</code> and, afterward, set expectations in another spec suite:</p>
<p><em>/test/jasmine/spec/storage-service.spec.js</em></p>
<div><pre><div class="line number13 index0 alt2"><code class="jscript plain">async.beforeEach( </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number14 index1 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">call = 0,</code></div><div class="line number15 index2 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">tempList = [],</code></div><div class="line number16 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred = $.Deferred(),</code></div><div class="line number17 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">getStub = sinon.stub().returns(deferred),</code></div><div class="line number18 index5 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">saveStub = sinon.stub().callsArgOn(0, store),</code></div><div class="line number19 index6 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">appendItem = </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number20 index7 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">tempList.push((call++%2 === 0) ? itemOne : itemTwo);</code></div><div class="line number21 index8 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number22 index9 alt1">&nbsp;</div><div class="line number23 index10 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">store.saveItem = saveStub;</code></div><div class="line number24 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">store.getItems = getStub;</code></div><div class="line number25 index12 alt2">&nbsp;</div><div class="line number26 index13 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">store.saveItem(appendItem);</code></div><div class="line number27 index14 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">store.saveItem(appendItem);</code></div><div class="line number28 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">store.getItems().then(</code><code class="jscript keyword">function</code><code class="jscript plain">(list) {</code></div><div class="line number29 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">items = list;</code></div><div class="line number30 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number31 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number32 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">deferred.resolve(tempList);</code></div><div class="line number33 index20 alt2"><code class="jscript plain">});</code></div></pre></div>
<p>With these modifications, we have assigned an anonymous stub – <code>saveStub</code> – as the <code>saveItem</code> method on the <code>store</code> and specified that the function-local <code>appendItem</code> method should be invoked, appending items to the list prior to each of our tests. </p>
<p>A little more work in setup and slightly unrealistic in telling of the arguments to be given to <code>saveItem()</code>, but it kept us on green without having to hard code the result; it’s a litte truer to life than the previous setup, and still passes:</p>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_ix_7.png" alt="Passing on succss of getItems() in service"></p>
<h3>Implementation</h3>
<p>Alright, so I think we should move this out to <code>storage-service</code> now and trash the stubbing in the test – we’ve got our expectations:</p>
<p><em>/script/service/storage-service.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">define([</code><code class="jscript string">'jquery'</code><code class="jscript plain">], </code><code class="jscript keyword">function</code><code class="jscript plain">($) {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">itemCache = [],</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store = {</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">saveItem: </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">deferred = $.Deferred();</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemCache[itemCache.length] = item;</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">deferred.resolve(item);</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">getItems: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">deferred = $.Deferred();</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred.resolve(itemCache);</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">deferred;</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">store;</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="jscript plain">});</code></div></pre></div>
<p><em>/test/jasmine/spec/storage-service.spec.js</em></p>
<div><pre><div class="line number6 index0 alt1"><code class="jscript plain">describe(</code><code class="jscript string">'getItems()'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number7 index1 alt2">&nbsp;</div><div class="line number8 index2 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">items,</code></div><div class="line number9 index3 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemOne = modelFactory.create(),</code></div><div class="line number10 index4 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemTwo = modelFactory.create(),</code></div><div class="line number11 index5 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">async = </code><code class="jscript keyword">new</code> <code class="jscript plain">AsyncSpec(</code><code class="jscript keyword">this</code><code class="jscript plain">);</code></div><div class="line number12 index6 alt1">&nbsp;</div><div class="line number13 index7 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">async.beforeEach( </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number14 index8 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.saveItem(itemOne);</code></div><div class="line number15 index9 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.saveItem(itemTwo);</code></div><div class="line number16 index10 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.getItems().then(</code><code class="jscript keyword">function</code><code class="jscript plain">(value) {</code></div><div class="line number17 index11 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">items = value;</code></div><div class="line number18 index12 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number19 index13 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number20 index14 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number21 index15 alt2">&nbsp;</div><div class="line number22 index16 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">afterEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number23 index17 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">//</code></div><div class="line number24 index18 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number25 index19 alt2">&nbsp;</div><div class="line number26 index20 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">it(</code><code class="jscript string">'should return of type array'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number27 index21 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(Array.isArray(items)).toEqual(</code><code class="jscript keyword">true</code><code class="jscript plain">);</code></div><div class="line number28 index22 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(items.length).toEqual(2);</code></div><div class="line number29 index23 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number30 index24 alt1">&nbsp;</div><div class="line number31 index25 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">it(</code><code class="jscript string">'should return array of grocery-ls-item types'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number32 index26 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(items[0]).toBe(itemOne);</code></div><div class="line number33 index27 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(items[1]).toBe(itemTwo);</code></div><div class="line number34 index28 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number35 index29 alt2">&nbsp;</div><div class="line number36 index30 alt1"><code class="jscript plain">});</code></div></pre></div>
<p>Run that, and we are still green!<br>
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_7.png" alt="Passing on succss of getItems() in service"></p>
<h3>Tests</h3>
<p>Now that we can verify that <code>saveItem()</code> is working enough for our <code>getItem</code> spec, let’s properly set the expectations for <code>saveItem</code>, as well, in our tests:</p>
<p><em>/test/jasmine/spec/storage-service.spec.js</em></p>
<div><pre><div class="line number0 index0 alt1 break"><code class="jscript plain">describe(</code><code class="jscript string">'saveItem()'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number1 index1 alt2">&nbsp;</div><div class="line number2 index2 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">itemOne = modelFactory.create(),</code></div><div class="line number3 index3 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemTwo = modelFactory.create(),</code></div><div class="line number4 index4 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">async = </code><code class="jscript keyword">new</code> <code class="jscript plain">AsyncSpec(</code><code class="jscript keyword">this</code><code class="jscript plain">);</code></div><div class="line number5 index5 alt2">&nbsp;</div><div class="line number6 index6 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">beforeEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number7 index7 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.saveItem(itemOne);</code></div><div class="line number8 index8 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number9 index9 alt2">&nbsp;</div><div class="line number10 index10 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">afterEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number11 index11 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">//</code></div><div class="line number12 index12 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number13 index13 alt2">&nbsp;</div><div class="line number14 index14 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">async.it(</code><code class="jscript string">'should be grow the length of items'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number15 index15 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.getItems().then( </code><code class="jscript keyword">function</code><code class="jscript plain">(items) {</code></div><div class="line number16 index16 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(items.length).toEqual(1);</code></div><div class="line number17 index17 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number18 index18 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number19 index19 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number20 index20 alt1">&nbsp;</div><div class="line number21 index21 alt2"><code class="jscript plain">});</code></div></pre></div>
<p>Simple enough. Back to the specrunner:<br>
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_8.png" alt="Failing on saveItem of storage-service"></p>
<p>Oh noes! Our expectation is that the length of items is only 1. We have only specified one addition of an item in the setup… where did the length of 5 come from!? Put down the abacus – there are better things to throw. But before that, I have an explanation: we haven’t been cleaning up. We have let <code>afterEach()</code> just quietly be invoked without a job to do.</p>
<p>To do just enough in getting our tests pass, we can update the <code>afterEach()</code> declarations in each spec suite to the following:</p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">async.afterEach( </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">store.getItems().then(</code><code class="jscript keyword">function</code><code class="jscript plain">(items) {</code></div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">items.length = 0;</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number6 index5 alt1"><code class="jscript plain">});</code></div></pre></div>
<p>That will get us back to passing:<br>
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_9.png" alt="Passing on saveItem spec."></p>
<p>I am not particularly fond of that solution, however. Mainly because I think it conveys a usage of the API on <code>storage-service</code> that I would not condone: directly mutating the underlying list of <code>storage-service</code> from another party. </p>
<p>I’m not gonna get crazy with the lock-down and privacy of properties and start introducing the latest-and-greatest framework that tries to tout that they really are just a library all in the attempt to stop someone from directly accessing the underlying array of items on <code>storage-service</code>. If some developers gonna go crazy and do so, hopefully we can find it in more tests later or they can look at our tests as a guideline of how to do what they want. </p>
<p>As such, I think we should add a method to <code>storage-service</code> that simply allows for emptying the list. First the expectation:</p>
<p><em>/test/jasmine/spec/storage-service.spec.js</em></p>
<div><pre><div class="line number61 index0 alt2"><code class="jscript plain">describe(</code><code class="jscript string">'empty()'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number62 index1 alt1">&nbsp;</div><div class="line number63 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">itemOne = modelFactory.create(),</code></div><div class="line number64 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemTwo = modelFactory.create(),</code></div><div class="line number65 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">async = </code><code class="jscript keyword">new</code> <code class="jscript plain">AsyncSpec(</code><code class="jscript keyword">this</code><code class="jscript plain">);</code></div><div class="line number66 index5 alt1">&nbsp;</div><div class="line number67 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">beforeEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number68 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.saveItem(itemOne);</code></div><div class="line number69 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.saveItem(itemTwo);</code></div><div class="line number70 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number71 index10 alt2">&nbsp;</div><div class="line number72 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">afterEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number73 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.empty();</code></div><div class="line number74 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number75 index14 alt2">&nbsp;</div><div class="line number76 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">async.it(</code><code class="jscript string">'should be appended to the list of items'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number77 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.empty().then( </code><code class="jscript keyword">function</code><code class="jscript plain">(items) {</code></div><div class="line number78 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(items.length).toEqual(0);</code></div><div class="line number79 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number80 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number81 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number82 index21 alt1">&nbsp;</div><div class="line number83 index22 alt2"><code class="jscript plain">});</code></div></pre></div>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_ix_10.png" alt="Failing on empty()"></p>
<p><em>/script/service/storage-service.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">define([</code><code class="jscript string">'jquery'</code><code class="jscript plain">], </code><code class="jscript keyword">function</code><code class="jscript plain">($) {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">itemCache = [],</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store = {</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">saveItem: </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">deferred = $.Deferred();</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemCache[itemCache.length] = item;</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">deferred.resolve(item);</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">getItems: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">deferred = $.Deferred();</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred.resolve(itemCache);</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">deferred;</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number15 index14 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">empty: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number16 index15 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">deferred = $.Deferred();</code></div><div class="line number17 index16 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemCache.length = 0;</code></div><div class="line number18 index17 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred.resolve(itemCache);</code></div><div class="line number19 index18 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">deferred;</code></div><div class="line number20 index19 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number21 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number22 index21 alt1">&nbsp;</div><div class="line number23 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">store;</code></div><div class="line number24 index23 alt1"><code class="jscript plain">});</code></div></pre></div>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_ix_11.png" alt="Passing on empty()"></p>
<p>Alright! We are passing expectations on three parts of the API for <code>storage-service</code>. Now let’s think of what else we need… I think only a <code>removeItem()</code> method will suffice. In working as we have previously in this article – stubbing out methods to be added to the <code>storage-service</code> implementation – we can add a spec suite for <code>removeItem()</code> such as the following:</p>
<p><em>/test/jasmine/spec/storage-service.spec.js</em></p>
<div><pre><div class="line number85 index0 alt2"><code class="jscript plain">describe(</code><code class="jscript string">'removeItem()'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number86 index1 alt1">&nbsp;</div><div class="line number87 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">items,</code></div><div class="line number88 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemOne = modelFactory.create(),</code></div><div class="line number89 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemTwo = modelFactory.create(),</code></div><div class="line number90 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">async = </code><code class="jscript keyword">new</code> <code class="jscript plain">AsyncSpec(</code><code class="jscript keyword">this</code><code class="jscript plain">),</code></div><div class="line number91 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred = $.Deferred(),</code></div><div class="line number92 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">removeItemFromList = </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number93 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred.resolve(items.splice(0, 1));</code></div><div class="line number94 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number95 index10 alt2">&nbsp;</div><div class="line number96 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">async.beforeEach( </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number97 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">removeItemStub = sinon.stub().returns(deferred).callsArgOn(0, store);</code></div><div class="line number98 index13 alt1">&nbsp;</div><div class="line number99 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.saveItem(itemOne);</code></div><div class="line number100 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.saveItem(itemTwo);</code></div><div class="line number101 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.removeItem = removeItemStub;</code></div><div class="line number102 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.getItems().then( </code><code class="jscript keyword">function</code><code class="jscript plain">(value) {</code></div><div class="line number103 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">items = value;</code></div><div class="line number104 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number105 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number106 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number107 index22 alt2">&nbsp;</div><div class="line number108 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">afterEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number109 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.empty();</code></div><div class="line number110 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number111 index26 alt2">&nbsp;</div><div class="line number112 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">async.it(</code><code class="jscript string">'should shorten length of the list'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number113 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.removeItem(removeItemFromList).then( </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number114 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.getItems().then( </code><code class="jscript keyword">function</code><code class="jscript plain">(items) {</code></div><div class="line number115 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(items.length).toEqual(1);</code></div><div class="line number116 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number117 index32 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number118 index33 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number119 index34 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number120 index35 alt1">&nbsp;</div><div class="line number121 index36 alt2"><code class="jscript plain">});</code></div></pre></div>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_ix_12.png" alt="Passing on initial removeItem()"></p>
<p>I think there are more expectations to assert for the <code>removeItem()</code> spec suite, but for now we are passing and we’ll move the implementation over to <code>storage-service</code>:</p>
<p><em>/script/service/storage-service.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">define([</code><code class="jscript string">'jquery'</code><code class="jscript plain">], </code><code class="jscript keyword">function</code><code class="jscript plain">($) {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">itemCache = [],</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store = {</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">saveItem: </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">deferred = $.Deferred();</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemCache[itemCache.length] = item;</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">deferred.resolve(item);</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number10 index9 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">removeItem: </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number11 index10 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">deferred = $.Deferred(),</code></div><div class="line number12 index11 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemIndex = itemCache.indexOf(item),</code></div><div class="line number13 index12 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">removedItem;</code></div><div class="line number14 index13 alt1 highlighted">&nbsp;</div><div class="line number15 index14 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">(itemIndex &gt; -1) {</code></div><div class="line number16 index15 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemCache.splice(itemIndex, 1);</code></div><div class="line number17 index16 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">removedItem = item;</code></div><div class="line number18 index17 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number19 index18 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">deferred.resolve(removedItem);</code></div><div class="line number20 index19 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number21 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">getItems: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number22 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">deferred = $.Deferred();</code></div><div class="line number23 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred.resolve(itemCache);</code></div><div class="line number24 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">deferred;</code></div><div class="line number25 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number26 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">empty: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number27 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">deferred = $.Deferred();</code></div><div class="line number28 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemCache.length = 0;</code></div><div class="line number29 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred.resolve(itemCache);</code></div><div class="line number30 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">deferred;</code></div><div class="line number31 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number32 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number33 index32 alt2">&nbsp;</div><div class="line number34 index33 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">store;</code></div><div class="line number35 index34 alt2">&nbsp;</div><div class="line number36 index35 alt1"><code class="jscript plain">});</code></div></pre></div>
<p>Now, we’ll update the spec suite for <code>removeItem()</code> and add a few more expectations to ensure the item removal process is correct:</p>
<p><em>/test/jasmine/spec/storage-service.spec.js</em></p>
<div><pre><div class="line number85 index0 alt2"><code class="jscript plain">describe(</code><code class="jscript string">'removeItem()'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number86 index1 alt1">&nbsp;</div><div class="line number87 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">itemOne = modelFactory.create(),</code></div><div class="line number88 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemTwo = modelFactory.create(),</code></div><div class="line number89 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">async = </code><code class="jscript keyword">new</code> <code class="jscript plain">AsyncSpec(</code><code class="jscript keyword">this</code><code class="jscript plain">);</code></div><div class="line number90 index5 alt1">&nbsp;</div><div class="line number91 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">beforeEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number92 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemOne.name = </code><code class="jscript string">'one'</code><code class="jscript plain">;</code></div><div class="line number93 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.saveItem(itemOne);</code></div><div class="line number94 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.saveItem(itemTwo);</code></div><div class="line number95 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number96 index11 alt1">&nbsp;</div><div class="line number97 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">afterEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number98 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.empty();</code></div><div class="line number99 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number100 index15 alt1">&nbsp;</div><div class="line number101 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">async.it(</code><code class="jscript string">'should shorten length of the list'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number102 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.removeItem(itemOne).then( </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number103 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.getItems().then( </code><code class="jscript keyword">function</code><code class="jscript plain">(items) {</code></div><div class="line number104 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(items.length).toEqual(1);</code></div><div class="line number105 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number106 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number107 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number108 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number109 index24 alt2">&nbsp;</div><div class="line number110 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">async.it(</code><code class="jscript string">'should remove item specified from the list'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number111 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.removeItem(itemOne).then( </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number112 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.getItems().then( </code><code class="jscript keyword">function</code><code class="jscript plain">(items) {</code></div><div class="line number113 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(items.indexOf(itemOne)).toEqual(-1);</code></div><div class="line number114 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number115 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number116 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number117 index32 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number118 index33 alt1">&nbsp;</div><div class="line number119 index34 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">async.it(</code><code class="jscript string">'should return the item removed if found'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number120 index35 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.removeItem(itemOne).then( </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number121 index36 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(item).toEqual(itemOne);</code></div><div class="line number122 index37 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number123 index38 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number124 index39 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number125 index40 alt2">&nbsp;</div><div class="line number126 index41 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">async.it(</code><code class="jscript string">'should return undefined if item not found'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number127 index42 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.removeItem(modelFactory.create()).then( </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number128 index43 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(item).toBeUndefined();</code></div><div class="line number129 index44 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number130 index45 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number131 index46 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number132 index47 alt1">&nbsp;</div><div class="line number133 index48 alt2"><code class="jscript plain">});</code></div></pre></div>
<p>… and we’re still in business!<br>
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_13.png" alt="Complete and passing removeItem specs"></p>
<h3>Revisiting saveItem()</h3>
<p>When we setup the <code>saveItem</code> stub for our <code>getItem()</code> spec suite, we really only focused on getting the expectations to pass. To get back to <span style="color: green;">green</span> – at the time – we were only concerned with appending items to the list. I think this needs to be looked at again.</p>
<p>If we remember back to the notifications we set up for the <code>list-controller</code>, it will dispatch a <code>save-item</code> event upon the existence of a new item, as well as the modification to an existing item. So we will pass that item through the <code>storage-service</code> using <code>saveItem()</code> but we don’t want to continually append items that are previously stored to the list – if so, we’d be buying a lot of <del datetime="2013-02-07T10:18:31+00:00">spinich</del> <del datetime="2013-02-07T10:18:31+00:00">spinnash</del> spinach.</p>
<p><small>Normally I wouldn’t cut corners: a feature spec should be written up for what I have described here prior to modifying the tests. To save you some scrolling, however, I decided to not include walking through one and letting the expectations that we define in the following speak for the specification.</small></p>
<p><em>/test/jasmine/spec/storage-service.spec.js</em></p>
<div><pre><div class="line number38 index0 alt1"><code class="jscript plain">describe(</code><code class="jscript string">'saveItem()'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number39 index1 alt2">&nbsp;</div><div class="line number40 index2 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">itemOne = modelFactory.create(),</code></div><div class="line number41 index3 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemTwo = modelFactory.create(),</code></div><div class="line number42 index4 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">async = </code><code class="jscript keyword">new</code> <code class="jscript plain">AsyncSpec(</code><code class="jscript keyword">this</code><code class="jscript plain">);</code></div><div class="line number43 index5 alt2">&nbsp;</div><div class="line number44 index6 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">beforeEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number45 index7 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.saveItem(itemOne);</code></div><div class="line number46 index8 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number47 index9 alt2">&nbsp;</div><div class="line number48 index10 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">afterEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number49 index11 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.empty();</code></div><div class="line number50 index12 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number51 index13 alt2">&nbsp;</div><div class="line number52 index14 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">async.it(</code><code class="jscript string">'should grow the length of items on new item'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number53 index15 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.getItems().then( </code><code class="jscript keyword">function</code><code class="jscript plain">(items) {</code></div><div class="line number54 index16 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(items.length).toEqual(1);</code></div><div class="line number55 index17 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number56 index18 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number57 index19 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number58 index20 alt1">&nbsp;</div><div class="line number59 index21 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">async.it(</code><code class="jscript string">'should not grow the length of items on pre-existing item'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number60 index22 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemOne.name = </code><code class="jscript string">'oranges'</code><code class="jscript plain">;</code></div><div class="line number61 index23 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.saveItem(itemOne).then( </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number62 index24 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.getItems().then( </code><code class="jscript keyword">function</code><code class="jscript plain">(items) {</code></div><div class="line number63 index25 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(items.length).toEqual(1);</code></div><div class="line number64 index26 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number65 index27 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number66 index28 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number67 index29 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number68 index30 alt1">&nbsp;</div><div class="line number69 index31 alt2"><code class="jscript plain">});</code></div></pre></div>
<p>We modified the description of the original expectation to state that the items list should only grow on new existence and added a new expectation that previously stored items do not get appended to the stored list:</p>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_ix_14.png" alt="Failing update to saveItem() specs."></p>
<p>As expected <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley">  Let’s update <code>saveItem()</code> on the <code>storage-service</code> to account for this:</p>
<p><em>/script/service/storage-service.js</em></p>
<div><pre><div class="line number5 index0 alt2"><code class="jscript plain">saveItem: </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number6 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">deferred = $.Deferred(),</code></div><div class="line number7 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">index = itemCache.indexOf(item);</code></div><div class="line number8 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">(index === -1) {</code></div><div class="line number9 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemCache[itemCache.length] = item;</code></div><div class="line number10 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number11 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">deferred.resolve(item);</code></div><div class="line number12 index7 alt1"><code class="jscript plain">}</code></div></pre></div>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_ix_15.png" alt="Passing on new expectation for saveItem()"></p>
<p>Not leaving any to chance, let’s add a couple more expectations as to how items are placed and how they remain in their places:</p>
<p><em>/test/jasmine/spec/storage-service.spec.js</em></p>
<div><pre><div class="line number71 index0 alt2"><code class="jscript plain">describe(</code><code class="jscript string">'saveItem() multiples'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number72 index1 alt1">&nbsp;</div><div class="line number73 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">itemOne = modelFactory.create(),</code></div><div class="line number74 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemTwo = modelFactory.create(),</code></div><div class="line number75 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">async = </code><code class="jscript keyword">new</code> <code class="jscript plain">AsyncSpec(</code><code class="jscript keyword">this</code><code class="jscript plain">);</code></div><div class="line number76 index5 alt1">&nbsp;</div><div class="line number77 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">beforeEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number78 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.saveItem(itemOne);</code></div><div class="line number79 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.saveItem(itemTwo);</code></div><div class="line number80 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number81 index10 alt2">&nbsp;</div><div class="line number82 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">afterEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number83 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.empty();</code></div><div class="line number84 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number85 index14 alt2">&nbsp;</div><div class="line number86 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">async.it(</code><code class="jscript string">'should append new items to the end of the list'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number87 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.getItems().then( </code><code class="jscript keyword">function</code><code class="jscript plain">(items) {</code></div><div class="line number88 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(items[items.length-1]).toBe(itemTwo);</code></div><div class="line number89 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number90 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number91 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number92 index21 alt1">&nbsp;</div><div class="line number93 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">async.it(</code><code class="jscript string">'should update existing item at position'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number94 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemOne.name = </code><code class="jscript string">'oranges'</code><code class="jscript plain">;</code></div><div class="line number95 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.saveItem(itemOne).then( </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number96 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store.getItems().then( </code><code class="jscript keyword">function</code><code class="jscript plain">(items) {</code></div><div class="line number97 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(items.indexOf(itemOne)).toEqual(0);</code></div><div class="line number98 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number99 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number100 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number101 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number102 index31 alt1">&nbsp;</div><div class="line number103 index32 alt2"><code class="jscript plain">});</code></div></pre></div>
<p>I had begun to add these expectations for multiple items in the list to the <code>saveItem()</code> spec suite, but I saw a similar setup for them both that differed from the origin setup for the <code>saveItem()</code> suite. As such, I moved these expectations to their own spec suite and particular setup.</p>
<p>Without any new modification to <code>storage-service</code> implementation, run that and we are still green!<br>
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_16.png" alt="Passing with new expectations for saveItem()"></p>
<p>Tagged <strong>0.1.14</strong>: <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.14" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.14</a></p>
<h2>This Is All Great But We Still Haven’t Done Anything</h2>
<p>In other words, what this subsection header is trying to say, the <code>storage-service</code> – even after we hook up communication to it from <code>list-controller</code> events – will do <em>nothing</em> but keep a session-cache of items: <strong>there still is no persistence across sessions</strong>.</p>
<p>Seeing as this is the case, let’s start integrating communication with <code>localStorage</code> into our <code>storage-service</code>. I am not going to modify the tests in order to verify the utilization of <code>localStorage</code> in relation to the operations available on <code>storage-service</code> – I am simply going to modify the <code>storage-service</code> and posible change expectations. The reason being that I do not really care about whether the storage-service relies on <code>localStorage</code> or a remote resource to read and write items to storage; I am only concerned with communication to <code>storage-service</code> being supported. </p>
<p><small>In truth, if this were a real world application and had to support occasional connectivity, i’d have two service modules: local-storage-service and remove-storage-service. They would both support the same API and there would be a service layer facade that would manage the ‘live’ instance and sync of both. That is a little too much for this series, so we’ll stick with a proxy to <code>localStorage</code> without modifying our tests to assume that the <code>storage-service</code> requires communication with it.</small></p>
<h3>storage-service modification</h3>
<p>To begin with, a <code>String</code> value is used as a key to read and write to an object held on <a href="https://developer.mozilla.org/en-US/docs/DOM/Storage" target="_blank">localStorage</a>. The API of <code>localStorage</code> is fairly simple and we’ll only be concerned with <code>getItem()</code> and <code>setItem()</code> to read and write to the store, respectively. We’ll use a key that we hope is unique to our application and won’t overwrite any object stored previously by another and use that key to access the stored grocery list items:</p>
<p><em>/script/service/storage-service.js</em></p>
<div><pre><div class="line number1 index0 alt2 highlighted"><code class="jscript plain">define([</code><code class="jscript string">'jquery'</code><code class="jscript plain">, </code><code class="jscript string">'script/model/grocery-ls-item'</code><code class="jscript plain">], </code><code class="jscript keyword">function</code><code class="jscript plain">($, modelFactory) {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">itemCache,</code></div><div class="line number4 index3 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">groceryListKey = </code><code class="jscript string">'com.custardbelly.grocerylist'</code><code class="jscript plain">,</code></div><div class="line number5 index4 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">parseToCollection = </code><code class="jscript keyword">function</code><code class="jscript plain">(json) {</code></div><div class="line number6 index5 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">i,</code></div><div class="line number7 index6 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">length,</code></div><div class="line number8 index7 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">list = (json &amp;&amp; </code><code class="jscript keyword">typeof</code> <code class="jscript plain">json === </code><code class="jscript string">'string'</code><code class="jscript plain">) ? JSON.parse(json) : [];</code></div><div class="line number9 index8 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">length = list.length;</code></div><div class="line number10 index9 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">for</code><code class="jscript plain">(i = 0; i &lt; length; i++) {</code></div><div class="line number11 index10 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">list[i] = $.extend(modelFactory.create(), list[i]);</code></div><div class="line number12 index11 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number13 index12 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">list;</code></div><div class="line number14 index13 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store = {</code></div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">saveItem: </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">deferred = $.Deferred();</code></div><div class="line number18 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">deferred.resolve(item);</code></div><div class="line number19 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number20 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">removeItem: </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number21 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">deferred = $.Deferred(),</code></div><div class="line number22 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemIndex = itemCache.indexOf(item),</code></div><div class="line number23 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">removedItem;</code></div><div class="line number24 index23 alt1">&nbsp;</div><div class="line number25 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">(itemIndex &gt; -1) {</code></div><div class="line number26 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemCache.splice(itemIndex, 1);</code></div><div class="line number27 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">removedItem = item;</code></div><div class="line number28 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number29 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">deferred.resolve(removedItem);</code></div><div class="line number30 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number31 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">getItems: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number32 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">deferred = $.Deferred();</code></div><div class="line number33 index32 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">(itemCache === undefined) {</code></div><div class="line number34 index33 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">try</code> <code class="jscript plain">{</code></div><div class="line number35 index34 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemCache = parseToCollection(window.localStorage.getItem(groceryListKey));</code></div><div class="line number36 index35 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred.resolve(itemCache);</code></div><div class="line number37 index36 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number38 index37 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">catch</code><code class="jscript plain">(e) {</code></div><div class="line number39 index38 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred.reject(</code><code class="jscript string">'Could not access items: '</code> <code class="jscript plain">+ e.message);</code></div><div class="line number40 index39 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number41 index40 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number42 index41 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">else</code> <code class="jscript plain">{</code></div><div class="line number43 index42 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred.resolve(itemCache);</code></div><div class="line number44 index43 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number45 index44 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">deferred;</code></div><div class="line number46 index45 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number47 index46 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">empty: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number48 index47 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">deferred = $.Deferred();</code></div><div class="line number49 index48 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemCache.length = 0;</code></div><div class="line number50 index49 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred.resolve(itemCache);</code></div><div class="line number51 index50 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">deferred;</code></div><div class="line number52 index51 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number53 index52 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number54 index53 alt1">&nbsp;</div><div class="line number55 index54 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">store;</code></div><div class="line number56 index55 alt1">&nbsp;</div><div class="line number57 index56 alt2"><code class="jscript plain">});</code></div></pre></div>
<p>That will light up our tests in pretty <span style="color: red;">red</span>… but that was expected. Actually, if it didn’t make our tests fail horribly, I would have been worried.<br>
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_23.png" alt="Failing on sotrage modification."></p>
<p>There are a couple things going on in this modification to <code>storage-service</code> that we should go over, however – the first being <code>parseToCollection()</code>:</p>
<p><em>/script/service/storage-service.js</em></p>
<div><pre><div class="line number5 index0 alt2"><code class="jscript plain">parseToCollection = </code><code class="jscript keyword">function</code><code class="jscript plain">(json) {</code></div><div class="line number6 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">i,</code></div><div class="line number7 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">length,</code></div><div class="line number8 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">list = (json &amp;&amp; </code><code class="jscript keyword">typeof</code> <code class="jscript plain">json === </code><code class="jscript string">'string'</code><code class="jscript plain">) ? JSON.parse(json) : [];</code></div><div class="line number9 index4 alt2">&nbsp;</div><div class="line number10 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">length = list.length;</code></div><div class="line number11 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">for</code><code class="jscript plain">(i = 0; i &lt; length; i++) {</code></div><div class="line number12 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">list[i] = $.extend(modelFactory.create(), list[i]);</code></div><div class="line number13 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number14 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">list;</code></div><div class="line number15 index10 alt2"><code class="jscript plain">}</code></div></pre></div>
<p>This method is invoked from <code>getItems()</code> and is provided the value of the object held in <code>localStorage</code> with the key <code>com.custardbelly.grocerylist</code>. We’ll be saving our data down in <a href="http://www.json.org/" target="_blank">JSON</a> format, and as such, <code>parseCollection()</code> is responsible for parsing that data back out; as well, if it is the first time accessing the data it will be coming in as undefined so a new list is created. What is particularly important in this parsing is how the objects on the list held in <code>localStorage</code> are converted to instances of our <code>grocery-ls-item</code> model: we create a new instance using the <code>modelFactory</code> and extend it with the object values from the item held on the list. The reason for this is because <code>grocery-ls-items</code> are decorated with getters and setters to allow for <code>property-change</code> events to be notified. In serializing down to JSON, this object structure is not perserved – it is just a <strong>POJSO</strong>.</p>
<p>The <code>parseToCollection()</code> method is invoked from <code>getItems()</code>:</p>
<p><em>/script/service/storage-service.js</em></p>
<div><pre><div class="line number31 index0 alt2"><code class="jscript plain">getItems: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number32 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">deferred = $.Deferred();</code></div><div class="line number33 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">(itemCache === undefined) {</code></div><div class="line number34 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">try</code> <code class="jscript plain">{</code></div><div class="line number35 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemCache = parseToCollection(window.localStorage.getItem(groceryListKey));</code></div><div class="line number36 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred.resolve(itemCache);</code></div><div class="line number37 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number38 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">catch</code><code class="jscript plain">(e) {</code></div><div class="line number39 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred.reject(</code><code class="jscript string">'Could not access items: '</code> <code class="jscript plain">+ e.message);</code></div><div class="line number40 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number41 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number42 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">else</code> <code class="jscript plain">{</code></div><div class="line number43 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred.resolve(itemCache);</code></div><div class="line number44 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number45 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">deferred;</code></div><div class="line number46 index15 alt1"><code class="jscript plain">}</code></div></pre></div>
<p>When <code>getItems()</code> is first invoked in a session, it will go about trying to access and parse the data held on <code>localStorage</code>; any subsequent invocations will immediately return the currently held reference to the store. In essence, during a session of creating and curating a <strong>Grocery List</strong>, we are working with live and current data so there is no need to keep accessing the list of grocery items from local storage every time – we’ll just return the live record.</p>
<p>Speaking of which, a lot of the failing tests I suspect are due to not actually not saving the list down to <code>localStorage</code>. Let’s just modify <code>storage-service</code> a little to do so and see where that gets us:</p>
<p><em>/script/service/storage-service.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">define([</code><code class="jscript string">'jquery'</code><code class="jscript plain">, </code><code class="jscript string">'script/model/grocery-ls-item'</code><code class="jscript plain">], </code><code class="jscript keyword">function</code><code class="jscript plain">($, modelFactory) {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">itemCache,</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">groceryListKey = </code><code class="jscript string">'com.custardbelly.grocerylist'</code><code class="jscript plain">,</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">parseToCollection = </code><code class="jscript keyword">function</code><code class="jscript plain">(json) {</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">i,</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">length,</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">list = (json &amp;&amp; </code><code class="jscript keyword">typeof</code> <code class="jscript plain">json === </code><code class="jscript string">'string'</code><code class="jscript plain">) ? JSON.parse(json) : [];</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">length = list.length;</code></div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">for</code><code class="jscript plain">(i = 0; i &lt; length; i++) {</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">list[i] = $.extend(modelFactory.create(), list[i]);</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">list;</code></div><div class="line number15 index14 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number16 index15 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">serialize = </code><code class="jscript keyword">function</code><code class="jscript plain">(key, data) {</code></div><div class="line number17 index16 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">window.localStorage.setItem(key, JSON.stringify(data));</code></div><div class="line number18 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number19 index18 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">store = {</code></div><div class="line number20 index19 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">saveItem: </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number21 index20 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">deferred = $.Deferred();</code></div><div class="line number22 index21 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.when(</code><code class="jscript keyword">this</code><code class="jscript plain">.getItems()).then(</code><code class="jscript keyword">function</code><code class="jscript plain">(cache) {</code></div><div class="line number23 index22 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">index = cache.indexOf(item);</code></div><div class="line number24 index23 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">try</code> <code class="jscript plain">{</code></div><div class="line number25 index24 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">(index === -1) {</code></div><div class="line number26 index25 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">cache[cache.length] = item;</code></div><div class="line number27 index26 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number28 index27 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">serialize(groceryListKey, cache);</code></div><div class="line number29 index28 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred.resolve(item);</code></div><div class="line number30 index29 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number31 index30 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">catch</code><code class="jscript plain">(e) {</code></div><div class="line number32 index31 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred.reject(</code><code class="jscript string">'Could not save item: '</code> <code class="jscript plain">+ e.message);</code></div><div class="line number33 index32 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number34 index33 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number35 index34 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">deferred;</code></div><div class="line number36 index35 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number37 index36 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">removeItem: </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number38 index37 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// implementation removed to reduce noise</code></div><div class="line number39 index38 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number40 index39 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">getItems: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number41 index40 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// implementation removed to reduce noise</code></div><div class="line number42 index41 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number43 index42 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">empty: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number44 index43 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// implementation removed to reduce noise</code></div><div class="line number45 index44 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number46 index45 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number47 index46 alt2">&nbsp;</div><div class="line number48 index47 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">store;</code></div><div class="line number49 index48 alt2">&nbsp;</div><div class="line number50 index49 alt1"><code class="jscript plain">});</code></div></pre></div>
<p><code>saveItem()</code> was modified to access the held list using <code>getItems()</code>, operate on that list as it had done previously and then try to serialize the list back to storage. Fairly simple. It’s important to note that we don’t access the <code>itemCache</code> directly in saveItem(), the reason being that we can’t ensure that <code>saveItem()</code> will only be called after a request to <code>getItems()</code>. As such, we need to be sure we’re always working with the same data and do so by requesting that cached list from <code>getItems()</code> within <code>saveItem()</code>.</p>
<p>That gets us closer to <span style="color: green;">green</span>, but we still have some work to do…<br>
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_24.png" alt="Closer to green for storage-service modifications."></p>
<p>Let’s modify <code>removeItem()</code> and <code>empty()</code> to work with the cached list returned from <code>getItems()</code> just as the modification to <code>saveItems()</code> has:</p>
<p><em>/script/service/storage-service.js</em></p>
<div><pre><div class="line number36 index0 alt1"><code class="jscript plain">removeItem: </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number37 index1 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">deferred = $.Deferred();</code></div><div class="line number38 index2 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">$.when(</code><code class="jscript keyword">this</code><code class="jscript plain">.getItems()).then(</code><code class="jscript keyword">function</code><code class="jscript plain">(cache) {</code></div><div class="line number39 index3 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">itemIndex = cache.indexOf(item),</code></div><div class="line number40 index4 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">removedItem;</code></div><div class="line number41 index5 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">try</code> <code class="jscript plain">{</code></div><div class="line number42 index6 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">(itemIndex &gt; -1) {</code></div><div class="line number43 index7 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">cache.splice(itemIndex, 1);</code></div><div class="line number44 index8 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">removedItem = item;</code></div><div class="line number45 index9 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">serialize(groceryListKey, cache);</code></div><div class="line number46 index10 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number47 index11 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred.resolve(removedItem);</code></div><div class="line number48 index12 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number49 index13 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">catch</code><code class="jscript plain">(e) {</code></div><div class="line number50 index14 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">cache.splice(itemIndex, 0, removedItem);</code></div><div class="line number51 index15 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred.reject(</code><code class="jscript string">'Could not remove item: '</code> <code class="jscript plain">+ e.message);</code></div><div class="line number52 index16 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number53 index17 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number54 index18 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">deferred;</code></div><div class="line number55 index19 alt2"><code class="jscript plain">}</code></div></pre></div>
<p><em>/script/service/storage-service.js</em></p>
<div><pre><div class="line number72 index0 alt1"><code class="jscript plain">empty: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number73 index1 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">deferred = $.Deferred();</code></div><div class="line number74 index2 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">$.when(</code><code class="jscript keyword">this</code><code class="jscript plain">.getItems()).then(</code><code class="jscript keyword">function</code><code class="jscript plain">(cache) {</code></div><div class="line number75 index3 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">try</code> <code class="jscript plain">{</code></div><div class="line number76 index4 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">cache.length = 0;</code></div><div class="line number77 index5 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">serialize(groceryListKey, cache);</code></div><div class="line number78 index6 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred.resolve(cache);</code></div><div class="line number79 index7 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number80 index8 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">catch</code><code class="jscript plain">(e) {</code></div><div class="line number81 index9 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deferred.reject(</code><code class="jscript string">'Could not empty cache: '</code> <code class="jscript plain">+ e.message);</code></div><div class="line number82 index10 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number83 index11 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number84 index12 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">deferred;</code></div><div class="line number85 index13 alt2"><code class="jscript plain">}</code></div></pre></div>
<p>That oughta do. Basically doing the same as we had done with <code>saveItem()</code>: accessing the cached list through <code>getItems()</code>, then modifying that list and serializing back done to <code>localStorage</code>.</p>
<p>Run those tests again, and we are back to <span style="color: green">green</span>!<br>
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_25.png" alt="Passing storage-service tests after modification!"></p>
<p>… at least for our <code>storage-service</code>. Let’s turn on all our tests again and see if our previous expectations are met:<br>
<img src="http://custardbelly.com/blog/images/tdd_js/part_ix_26.png" alt="Passing tests!"></p>
<p>Whoopie!</p>
<p>Tagged <strong>0.1.15</strong>: <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.15" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.15</a></p>
<p>We’re not done yet: we have still to hook up <code>list-controller</code> notification to <code>storage-service</code> operations. However, I want to end this article here on a good note <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley"> </p>
<h2>Conclusion</h2>
<p>We have yet to reach our goal of incorporating session persistence within our <strong>Grocery List</strong> application – but that is not to say we have gotten nowhere. We implemented our <code>storage-service</code> layer for <code>localStorage</code> communication and modified the <code>list-controller</code> to notify of change events to its collection related to <code>grocery-ls-item</code> existence. Not to shabby. </p>
<p>I know we want to get a finished product out the door, but we’ll get there… just a few more things to tie up in the next article…</p>
<p>Cheers! </p>
<p>—-</p>
<h1>Link Dump</h1>
<h2>Reference</h2>
<p><a href="http://tddjs.com/" target="_blank">Test-Driven JavaScript Development by Christian Johansen</a><br>
<a href="http://dannorth.net/introducing-bdd/" target="_blank">Introducing BDD by Dan North</a><br>
<a href="http://cumulative-hypotheses.org/2011/08/30/tdd-as-if-you-meant-it/">TDD as if you Meant it by Keith Braithwaite</a><br>
<a href="http://requirejs.org/" target="_blank">RequireJS</a><br>
<a href="https://github.com/amdjs/amdjs-api/wiki/AMD" target="_blank">AMD</a><br>
<a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a><br>
<a href="http://sinonjs.org/" target="_blank">Sinon</a><br>
<a href="https://github.com/derickbailey/jasmine.async" target="_blank">Jasmine.Async</a></p>
<h2>Post Series</h2>
<p><a href="https://github.com/bustardcelly/grocery-ls">grocery-ls github repo</a><br>
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i" target="_blank">Part I – Introduction</a><br>
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii">Part II – Feature: Add Item</a><br>
<a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii">Part III – Feature: Mark-Off Item</a><br>
<a href="http://custardbelly.com/blog/2012/12/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-iv">Part IV – Feature: List-Item-Controller</a><br>
<a href="http://custardbelly.com/blog/2012/12/31/the-making-of-a-test-driven-grocery-list-application-in-js-part-v/">Part V – Feature: List-Controller Refactoring</a><br>
<a href="http://custardbelly.com/blog/2013/01/08/the-making-of-a-test-driven-grocery-list-application-in-js-part-vi/" target="_blank">Part VI – Back to Passing</a><br>
<a href="http://custardbelly.com/blog/2013/01/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-vii/">Part VII – Remove Item</a><br>
<a href="http://custardbelly.com/blog/2013/01/22/the-making-of-a-test-driven-grocery-list-application-part-viii/">Part VIII – Bug Fixing</a><br>
<a href="http://custardbelly.com/blog/2013/02/15/the-making-of-a-test-driven-grocery-list-application-in-js-part-ix/">Part IX – Persistence</a><br>
<a href="http://custardbelly.com/blog/2013/03/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-x/">Part X – It Lives!</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/amd/" title="View all posts in AMD" rel="category tag">AMD</a>,  <a href="http://custardbelly.com/blog/category/javascript/" title="View all posts in JavaScript" rel="category tag">JavaScript</a>,  <a href="http://custardbelly.com/blog/category/requirejs/" title="View all posts in RequireJS" rel="category tag">RequireJS</a>,  <a href="http://custardbelly.com/blog/category/grocery-ls/" title="View all posts in grocery-ls" rel="category tag">grocery-ls</a>,  <a href="http://custardbelly.com/blog/category/jasmine/" title="View all posts in jasmine" rel="category tag">jasmine</a>,  <a href="http://custardbelly.com/blog/category/unit-testing/" title="View all posts in unit-testing" rel="category tag">unit-testing</a>.</p>
	
	

	<!--/by-line-->

	<div id="post-comments-777-target"></div>
	<div class="clear"></div>
	
	