
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2012/12/31/the-making-of-a-test-driven-grocery-list-application-in-js-part-v/" title="Permanent link to The Making of a Test-Driven Grocery List Application in JS: Part V" rel="bookmark" rev="post-686">The Making of a Test-Driven Grocery List Application in JS: Part V</a></h1>
	
	<div class="entry-content full-content">
		<p><em>This is the fifth installment in a series of building a Test-Driven Grocery List application using <a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a> and <a href="http://requirejs.org" target="_blank">RequireJS</a>. To learn more about the intent and general concept of the series please visit <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i/">The Making of a Test-Driven Grocery List Application in JavaScript: Part I</a></em><br>
—</p>
<h2>Introduction</h2>
<p>The <a href="http://custardbelly.com/blog/2012/12/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-iv" target="_blank">previous article</a> was prefaced to be a refactoring effort to remove responsibilities of item management from the <em>list-controller</em> to instances of a <em>list-item-controller</em>. We designed the list-item-controller through specs, moved the factory to its own AMD and modified not only the <em>grocery-ls-item</em> model, but how the <em>list-item-controller</em> responded to changes of it.</p>
<p>All important and – in my view – much needed changes. However, we fell short on our goal. Sure, the tests still passed, but we modified nothing within the <em>list-controller</em> to reflect this transfer of responsibility. Part of the reason for this is my attempt at not overloading each article in this series with information. The other part is that I wanted a little time to stew over how I actually saw the revision of <em>list-controller</em>.</p>
<p>We still want to keep our feature specs of <em>Add Item</em> and <em>Mark Item</em> (and we have a few more features still to address), but I begin to question if it is really necessary to expose that functionality on the API of the <em>list-controller</em>. I am starting to see that those features are really part of a collection of <em>grocery-ls-item</em> models, and the controllers are just responders to changes on the collection and models themselves – the basis of MVC design.</p>
<p>Just as we implemented <em>list-item-controller</em> in the previous article with a design to respond to changes on a provided <em>grocery-ls-item</em> model and update its state accordingly, I propose so should we refactor the <em>list-controller</em> to respond to changes on a collection of <em>grocery-ls-item</em> models.</p>
<h2>Collection</h2>
<p>A generic collection is basically an object that provides a higher-level API to interact with an array of items. The API can provide a more readable way of adding and removing items on an underlying <a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a> instance instead of using methods like <em>push</em> or <em>splice</em> – which are base level and don’t use a nomenclature that is best suited for the action taken – but more importantly, the API provides a facade to operations on an array of items from which it can internally have stricter rules over such actions. </p>
<p>There are various libraries and frameworks out there that support collections, and even different type of collections – ie, sets, linked lists, etc. As has been mentioned in previous posts, I am trying not to introduce new libraries into this series as it may add unnecessary noise to the task at hand. This also allows for us to keep the <em>Collection</em> implementation lean and customizable for the <strong>Grocery List</strong> application; we’re also going to support event notification from the collection, which is not inherent in the JavaScript <a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/Array" target="_blank">Array</a> object.</p>
<h3>Tests</h3>
<p>We will create the design of a <em>Collection</em> object piecemeal as we write the specs for it. To start, we know that it is to be a wrapper around an Array source:</p>
<p><em>/test/jasmine/spec/collection.spec.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">define( [</code><code class="jscript string">'jquery'</code><code class="jscript plain">], </code><code class="jscript keyword">function</code><code class="jscript plain">($) {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">collectionImpl = {</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemLength: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">this</code><code class="jscript plain">.list.length;</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collectionFactory = {</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">create: </code><code class="jscript keyword">function</code><code class="jscript plain">(source) {</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">instance = Object.create(collectionImpl, {</code></div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"list"</code><code class="jscript plain">: {</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">value: Array.isArray(source) ? source : [],</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">writable: </code><code class="jscript keyword">true</code><code class="jscript plain">,</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">enumerable: </code><code class="jscript keyword">true</code></div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">instance;</code></div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number18 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">describe(</code><code class="jscript string">'Collection'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number21 index20 alt2">&nbsp;</div><div class="line number22 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">describe(</code><code class="jscript string">'collection factory instance creation'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number23 index22 alt2">&nbsp;</div><div class="line number24 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">it(</code><code class="jscript string">'should create unique instances of collection from create()'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number25 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">collectionOne = collectionFactory.create(),</code></div><div class="line number26 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collectionTwo = collectionFactory.create();</code></div><div class="line number27 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(collectionOne).not.toBe(collectionTwo);</code></div><div class="line number28 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number29 index28 alt2">&nbsp;</div><div class="line number30 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">it(</code><code class="jscript string">'should create an empty collection without source array provided'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number31 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">collection = collectionFactory.create();</code></div><div class="line number32 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(collection).not.toBeUndefined();</code></div><div class="line number33 index32 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(collection.itemLength()).toBe(0);</code></div><div class="line number34 index33 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number35 index34 alt2">&nbsp;</div><div class="line number36 index35 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">it(</code><code class="jscript string">'should create a collection from source array provided'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number37 index36 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">items = [</code><code class="jscript string">'apples'</code><code class="jscript plain">, </code><code class="jscript string">'oranges'</code><code class="jscript plain">],</code></div><div class="line number38 index37 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection = collectionFactory.create(items);</code></div><div class="line number39 index38 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(collection.itemLength()).toBe(2);</code></div><div class="line number40 index39 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number41 index40 alt2">&nbsp;</div><div class="line number42 index41 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number43 index42 alt2">&nbsp;</div><div class="line number44 index43 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number45 index44 alt2">&nbsp;</div><div class="line number46 index45 alt1"><code class="jscript plain">});</code></div></pre></div>
<p>We have defined two specs that involve testing the wrapped Array source for a collection. Upon creation, the array should be empty if no source array supplied or filled with items if source provided. Pretty straight forward.<br>
<small>Again, we are only concerned with the latest-and-greatest browsers, so you may notice the use of  <a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/Array/isArray" target="_blank">Array.isArray</a> when the <em>list</em> property is defined within the check the <em>source</em> argument on the <em>collectionFactory.create()</em> call.</small></p>
<h4>aside</h4>
<p>We could get into a lengthy discussion about the design of <em>collectionImpl</em>, and in particular that the <em>list</em> property is publicly accessible – i mean, after all, are we not defeating the point of providing an API to manipulate the list if some developer could just come along and access it directly? A valid point, and one I struggle with often. We could – and I would recommend, at times – using the functional inheritance pattern to ‘privately’ hold the underlying list within the collection. For example:</p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">collectionImpl = (</code><code class="jscript keyword">function</code><code class="jscript plain">(source) {</code></div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">list = source;</code></div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">{</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemLength: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">list.length;</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number8 index7 alt1"><code class="jscript plain">});</code></div><div class="line number9 index8 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">instance = collectionImpl([]);</code></div></pre></div>
<p>That would ‘<em>conveniently</em>‘ make the underlying array ‘private’, but there are an arguable list of pros and cons to this approach – the biggest con is the creation of a new object with new functions and new properties each call, rather then a shared inheritance. In essence, each new instance of collection created using this pattern could then modify, add and/or remove methods so that the API is not the same across all ‘instances’ of the collection – that’s a big con for me.</p>
<p>For our implementation, let’s just take it with a grain of salt that we don’t expect anyone to maliciously access the source array of the collection and use the API we are defining in our tests <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley"> </p>
<h4>end aside</h4>
<p>Even though in the last spec, we aren’t concerned with the underlying list being strictly equal to the provided source, we should probably check that the list has the correct items and is in the correct order:</p>
<p><em>/test/jasmine/spec/collection.spec.js</em></p>
<div><pre><div class="line number3 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">collectionImpl = {</code></div><div class="line number4 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">itemLength: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number5 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">this</code><code class="jscript plain">.list.length;</code></div><div class="line number6 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number7 index4 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">getItemAt: </code><code class="jscript keyword">function</code><code class="jscript plain">( index ) {</code></div><div class="line number8 index5 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( index &lt; 0 || (index &gt; </code><code class="jscript keyword">this</code><code class="jscript plain">.itemLength() - 1) ) {</code></div><div class="line number9 index6 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">undefined;</code></div><div class="line number10 index7 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number11 index8 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">this</code><code class="jscript plain">.list[index];</code></div><div class="line number12 index9 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number13 index10 alt2"><code class="jscript plain">}</code></div></pre></div>
<p>The <em>getItemAt()</em> method first verifies that the supplied index within the range of the wrapped array and returns undefined if not or the item held in the array at the supplied index. We can ensure that method works properly by adding a couple tests to the spec we already have for verifying the source provided on creation:</p>
<p><em>/test/jasmine/spec/collection.spec.js</em></p>
<div><pre><div class="line number35 index0 alt2"><code class="jscript plain">it(</code><code class="jscript string">'should create a collection from source array'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number36 index1 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">itemOne = </code><code class="jscript string">'apples'</code><code class="jscript plain">,</code></div><div class="line number37 index2 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemTwo = </code><code class="jscript string">'oranges'</code><code class="jscript plain">,</code></div><div class="line number38 index3 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection = collectionFactory.create([itemOne, itemTwo]);</code></div><div class="line number39 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">expect(collection.itemLength()).toBe(2);</code></div><div class="line number40 index5 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">expect(collection.getItemAt(0)).toEqual(itemOne);</code></div><div class="line number41 index6 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">expect(collection.getItemAt(1)).toEqual(itemTwo);</code></div><div class="line number42 index7 alt1"><code class="jscript plain">});</code></div></pre></div>
<p>Let’s go ahead and add some useful methods that will aid in adding and removing items to and from the collection:</p>
<p><em>/test/jasmine/spec/collection.spec.js</em></p>
<div><pre><div class="line number3 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">collectionImpl = {</code></div><div class="line number4 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">itemLength: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number5 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">this</code><code class="jscript plain">.list.length;</code></div><div class="line number6 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number7 index4 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">addItem: </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number8 index5 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.list.push(item);</code></div><div class="line number9 index6 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">item;</code></div><div class="line number10 index7 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number11 index8 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">removeItem: </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number12 index9 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">index = </code><code class="jscript keyword">this</code><code class="jscript plain">.list.indexOf(item);</code></div><div class="line number13 index10 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( index &gt; -1 ) {</code></div><div class="line number14 index11 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.list.splice(index, 1);</code></div><div class="line number15 index12 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">item;</code></div><div class="line number16 index13 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number17 index14 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">undefined;</code></div><div class="line number18 index15 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number19 index16 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">removeAll: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number20 index17 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.list.length = [];</code></div><div class="line number21 index18 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number22 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">getItemAt: </code><code class="jscript keyword">function</code><code class="jscript plain">( index ) {</code></div><div class="line number23 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( index &lt; 0 || (index &gt; </code><code class="jscript keyword">this</code><code class="jscript plain">.itemLength() - 1) ) {</code></div><div class="line number24 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">undefined;</code></div><div class="line number25 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number26 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">this</code><code class="jscript plain">.list[index];</code></div><div class="line number27 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number28 index25 alt1"><code class="jscript plain">}</code></div></pre></div>
<p>We could add some specs for <em>addItem()</em> to ensure that the list does grow with each item appended to the end:</p>
<p><em>/test/jasmine/spec/collection.spec.js</em></p>
<div><pre><div class="line number69 index0 alt2"><code class="jscript plain">describe(</code><code class="jscript string">'collection item addition'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number70 index1 alt1">&nbsp;</div><div class="line number71 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">collection;</code></div><div class="line number72 index3 alt1">&nbsp;</div><div class="line number73 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">beforeEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number74 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection = collectionFactory.create();</code></div><div class="line number75 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number76 index7 alt1">&nbsp;</div><div class="line number77 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">it(</code><code class="jscript string">'should append item to list from addItem()'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number78 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">item = </code><code class="jscript string">'grapes'</code><code class="jscript plain">;</code></div><div class="line number79 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection.addItem(item);</code></div><div class="line number80 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(collection.itemLength()).toBe(1);</code></div><div class="line number81 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(collection.getItemAt(0)).toEqual(item);</code></div><div class="line number82 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number83 index14 alt2">&nbsp;</div><div class="line number84 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">it(</code><code class="jscript string">'should maintain order during multiple additions'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number85 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">itemOne = </code><code class="jscript string">'grapes'</code><code class="jscript plain">,</code></div><div class="line number86 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemTwo = </code><code class="jscript string">'grapefruit'</code><code class="jscript plain">;</code></div><div class="line number87 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection.addItem(itemOne);</code></div><div class="line number88 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection.addItem(itemTwo);</code></div><div class="line number89 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(collection.itemLength()).toBe(2);</code></div><div class="line number90 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(collection.getItemAt(1)).toEqual(itemTwo);</code></div><div class="line number91 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number92 index23 alt1">&nbsp;</div><div class="line number93 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">afterEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number94 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection = undefined;</code></div><div class="line number95 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number96 index27 alt1">&nbsp;</div><div class="line number97 index28 alt2"><code class="jscript plain">});</code></div></pre></div>
<p>… and throw in a spec suite for testing the removal API on the <em>Collection</em>:</p>
<p><em>/test/jasmine/spec/collection.spec.js</em></p>
<div><pre><div class="line number99 index0 alt2"><code class="jscript plain">describe(</code><code class="jscript string">'collection item removal'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number100 index1 alt1">&nbsp;</div><div class="line number101 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">collection,</code></div><div class="line number102 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemOne = </code><code class="jscript string">'pineapple'</code><code class="jscript plain">,</code></div><div class="line number103 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemTwo = </code><code class="jscript string">'pear'</code><code class="jscript plain">;</code></div><div class="line number104 index5 alt1">&nbsp;</div><div class="line number105 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">beforeEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number106 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection = collectionFactory.create();</code></div><div class="line number107 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection.addItem(itemOne);</code></div><div class="line number108 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number109 index10 alt2">&nbsp;</div><div class="line number110 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">it(</code><code class="jscript string">'should remove only specified item and report length of 0 from removeItem()'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number111 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection.removeItem(itemOne);</code></div><div class="line number112 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(collection.itemLength()).toBe(0);</code></div><div class="line number113 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number114 index15 alt1">&nbsp;</div><div class="line number115 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">it(</code><code class="jscript string">'should remove specified item from proper index'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number116 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection.addItem(itemTwo);</code></div><div class="line number117 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection.removeItem(itemOne);</code></div><div class="line number118 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(collection.itemLength()).toBe(1);</code></div><div class="line number119 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(collection.getItemAt(0)).toEqual(itemTwo);</code></div><div class="line number120 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number121 index22 alt2">&nbsp;</div><div class="line number122 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">it(</code><code class="jscript string">'should retain items in collection if item provided to removeItem() is not found'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number123 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection.addItem(itemTwo);</code></div><div class="line number124 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection.removeItem(</code><code class="jscript string">'watermelon'</code><code class="jscript plain">);</code></div><div class="line number125 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(collection.itemLength()).toBe(2);</code></div><div class="line number126 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number127 index28 alt2">&nbsp;</div><div class="line number128 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">it(</code><code class="jscript string">'should empty the list on removeAll()'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number129 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection.addItem(itemTwo);</code></div><div class="line number130 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection.removeAll();</code></div><div class="line number131 index32 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(collection.itemLength()).toBe(0);</code></div><div class="line number132 index33 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number133 index34 alt2">&nbsp;</div><div class="line number134 index35 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">afterEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number135 index36 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection = undefined;</code></div><div class="line number136 index37 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number137 index38 alt2">&nbsp;</div><div class="line number138 index39 alt1"><code class="jscript plain">});</code></div></pre></div>
<p>With that, we have roughly designed and verified the API for our custom <em>Collection</em> object. Let’s add it to our list of specs to run:</p>
<p><em>/test/jasmine/specrunner.html</em></p>
<div><pre><div class="line number34 index0 alt1"><code class="jscript plain">require( [</code><code class="jscript string">'spec/newitem.spec.js'</code><code class="jscript plain">, </code><code class="jscript string">'spec/markitem.spec.js'</code><code class="jscript plain">,</code></div><div class="line number35 index1 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">'spec/item-controller.spec.js'</code><code class="jscript plain">, </code><code class="jscript string">'spec/grocery-ls-item.spec.js'</code><code class="jscript plain">,</code></div><div class="line number36 index2 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">'spec/collection.spec.js'</code><code class="jscript plain">], </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number37 index3 alt2">&nbsp;</div><div class="line number38 index4 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">jasmineEnv = jasmine.getEnv(),</code></div><div class="line number39 index5 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">...</code></div><div class="line number40 index6 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">jasmineEnv.execute();</code></div><div class="line number41 index7 alt2">&nbsp;</div><div class="line number42 index8 alt1"><code class="jscript plain">});</code></div></pre></div>
<p>Run it and all is green!<br>
<img src="http://custardbelly.com/blog/images/tdd_js/part_v_1.png" alt="Passing collection suite"></p>
<p>Whoa. Settle down… we’re not done yet <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley"> </p>
<h4>Collection Events</h4>
<p>If we think back to why we even started down this path of creating a Collection object, we’ll remember that its role in the <strong>Grocery List</strong> application is to serve as the model for the <em>list-controller</em>. It is the intention to eventually modify the <em>list-controller</em> to not only offload the responsibility of managing the relationship and interaction between individual <em>grocery-ls-item</em> models to their views, but also to respond to changes on the collection of <em>grocery-ls-item</em>s accordingly. As such, we will incorporate event notification into our <em>Collection</em> object, from which the <em>list-controller</em> can assign response delegates to changes on the collection.</p>
<p>Using <a href="http://api.jquery.com/category/Events/?rdfrom=http%3A%2F%2Fdocs.jquery.com%2Fmw%2Findex.php%3Ftitle%3DAPI%2F1.3%2FEvents%26redirect%3Dno" target="_blank">jQuery Event</a> as we have previously in the development of this application throughout this series, we’ll create a factory method that returns an event object based provided arguments. If you are familiar with collections from the <a href="http://www.adobe.com/devnet/flex/flex-sdk-download.html" target="_blank">Flex SDK</a>, you might notice something similar <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley">  :</p>
<p><em>/test/jasmine/spec/collection.spec.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">function</code> <code class="jscript plain">createEvent(kind, items) {</code></div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">event = </code><code class="jscript keyword">new</code> <code class="jscript plain">$.Event(</code><code class="jscript string">'collection-change'</code><code class="jscript plain">);</code></div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">event.kind = kind;</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">event.items = items;</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">event;</code></div><div class="line number6 index5 alt1"><code class="jscript plain">}</code></div></pre></div>
<p>Basically, any event dispatched from the collection object will be of the same type, and its operation can be differentiated from the <em>kind</em> property. The items affected upon the associated operation (<em>kind</em>) are provided in an array as some operations may involve multiple items.</p>
<p>With the API we have defined for the collection, there are three operations that can modify the the list of items:</p>
<ul>
<li>add</li>
<li>remove</li>
<li>reset</li>
</ul>
<p>The methods associated with add and remove are pretty self-explanatory and we will consider <em>removeAll()</em> as a reset on the collection. With this in mind, let’s append a couple tests to our spec suites for these event notifications:</p>
<p><em>/test/jasmine/spec/collection.spec.js</em></p>
<div><pre><div class="line number121 index0 alt2"><code class="jscript plain">describe(</code><code class="jscript string">'collection item addition'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number122 index1 alt1"><code class="jscript plain">...</code></div><div class="line number123 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">async.it(</code><code class="jscript string">'should notify on addition of item'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number124 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">item = </code><code class="jscript string">'grapes'</code><code class="jscript plain">;</code></div><div class="line number125 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(collection).on(</code><code class="jscript string">'collection-change'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(event) {</code></div><div class="line number126 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(event.kind).toBe(</code><code class="jscript string">'add'</code><code class="jscript plain">);</code></div><div class="line number127 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(event.items.length).toBe(1);</code></div><div class="line number128 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(event.items[0]).toEqual(item);</code></div><div class="line number129 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(collection).off(</code><code class="jscript string">'collection-change'</code><code class="jscript plain">);</code></div><div class="line number130 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number131 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number132 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection.addItem(item);</code></div><div class="line number133 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number134 index13 alt1"><code class="jscript plain">...</code></div><div class="line number135 index14 alt2"><code class="jscript plain">});</code></div><div class="line number136 index15 alt1"><code class="jscript plain">...</code></div><div class="line number137 index16 alt2"><code class="jscript plain">describe(</code><code class="jscript string">'collection item removal'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number138 index17 alt1"><code class="jscript plain">...</code></div><div class="line number139 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">async.it(</code><code class="jscript string">'should notify on removal of item'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number140 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection.addItem(itemTwo);</code></div><div class="line number141 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(collection).on(</code><code class="jscript string">'collection-change'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(event) {</code></div><div class="line number142 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(event.kind).toBe(</code><code class="jscript string">'remove'</code><code class="jscript plain">);</code></div><div class="line number143 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(event.items.length).toBe(1);</code></div><div class="line number144 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(event.items[0]).toEqual(itemOne);</code></div><div class="line number145 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(collection).off(</code><code class="jscript string">'collection-change'</code><code class="jscript plain">);</code></div><div class="line number146 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number147 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number148 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection.removeItem(itemOne);</code></div><div class="line number149 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number150 index29 alt1">&nbsp;</div><div class="line number151 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">async.it(</code><code class="jscript string">'should notify on reset of collection'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(done) {</code></div><div class="line number152 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(collection).on(</code><code class="jscript string">'collection-change'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(event) {</code></div><div class="line number153 index32 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(event.kind).toBe(</code><code class="jscript string">'reset'</code><code class="jscript plain">);</code></div><div class="line number154 index33 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(event.items.length).toBe(0);</code></div><div class="line number155 index34 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(collection).off(</code><code class="jscript string">'collection-change'</code><code class="jscript plain">);</code></div><div class="line number156 index35 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">done();</code></div><div class="line number157 index36 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number158 index37 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection.removeAll();</code></div><div class="line number159 index38 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number160 index39 alt1">&nbsp;</div><div class="line number161 index40 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">afterEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number162 index41 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection = undefined;</code></div><div class="line number163 index42 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number164 index43 alt1"><code class="jscript plain">...</code></div><div class="line number165 index44 alt2"><code class="jscript plain">});</code></div></pre></div>
<p>If you were to run the tests now, you would see a couple execute then hang intermittently as it waits for the async tests to timeout… because we haven’t implemented the dispatching of events from the collection yet <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley"> </p>
<p><em>/test/jasmine/spec/collection.spec.js</em></p>
<div><pre><div class="line number10 index0 alt1"><code class="jscript keyword">var</code> <code class="jscript plain">collectionImpl = {</code></div><div class="line number11 index1 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">itemLength: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number12 index2 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">this</code><code class="jscript plain">.list.length;</code></div><div class="line number13 index3 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number14 index4 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">addItem: </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number15 index5 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.list.push(item);</code></div><div class="line number16 index6 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript keyword">this</code><code class="jscript plain">).trigger(createEvent(</code><code class="jscript string">'add'</code><code class="jscript plain">, [item]));</code></div><div class="line number17 index7 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">item;</code></div><div class="line number18 index8 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number19 index9 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">removeItem: </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number20 index10 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">index = </code><code class="jscript keyword">this</code><code class="jscript plain">.list.indexOf(item);</code></div><div class="line number21 index11 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( index &gt; -1 ) {</code></div><div class="line number22 index12 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.list.splice(index, 1);</code></div><div class="line number23 index13 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript keyword">this</code><code class="jscript plain">).trigger(createEvent(</code><code class="jscript string">'remove'</code><code class="jscript plain">, [item]));</code></div><div class="line number24 index14 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">item;</code></div><div class="line number25 index15 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number26 index16 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">undefined;</code></div><div class="line number27 index17 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number28 index18 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">removeAll: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number29 index19 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.list.length = [];</code></div><div class="line number30 index20 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript keyword">this</code><code class="jscript plain">).trigger(createEvent(</code><code class="jscript string">'reset'</code><code class="jscript plain">, </code><code class="jscript keyword">this</code><code class="jscript plain">.list));</code></div><div class="line number31 index21 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number32 index22 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">getItemAt: </code><code class="jscript keyword">function</code><code class="jscript plain">( index ) {</code></div><div class="line number33 index23 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( index &lt; 0 || (index &gt; </code><code class="jscript keyword">this</code><code class="jscript plain">.itemLength() - 1) ) {</code></div><div class="line number34 index24 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">undefined;</code></div><div class="line number35 index25 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number36 index26 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">this</code><code class="jscript plain">.list[index];</code></div><div class="line number37 index27 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number38 index28 alt1"><code class="jscript plain">}</code></div></pre></div>
<p>Now, if you were to run the tests, all should be happy.</p>
<h3>Collection Module Implementation</h3>
<p>Just as we have done with the <em>list-item-controller</em> from the <a href="http://custardbelly.com/blog/2012/12/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-iv/" target="_blank">previous article</a>, we are going to take the work we had done in implementing the collection object within our tests and move it to an AMD module. This way, if we <em>ever</em> get around to refactoring the <em>list-controller</em>, we’ll be able to utilize the collection module:</p>
<p><em>/script/collection/collection.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">define([</code><code class="jscript string">'jquery'</code><code class="jscript plain">], </code><code class="jscript keyword">function</code><code class="jscript plain">($) {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">createEvent(kind, items) {</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">event = $.Event(</code><code class="jscript string">'collection-change'</code><code class="jscript plain">);</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">event.kind = kind;</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">event.items = items;</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">event;</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">_collectionEventKind = {</code></div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">ADD: </code><code class="jscript string">'add'</code><code class="jscript plain">,</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">REMOVE: </code><code class="jscript string">'remove'</code><code class="jscript plain">,</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">RESET: </code><code class="jscript string">'reset'</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection = {</code></div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemLength: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">this</code><code class="jscript plain">.list.length;</code></div><div class="line number18 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number19 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">addItem: </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number20 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.list.push(item);</code></div><div class="line number21 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript keyword">this</code><code class="jscript plain">).trigger(createEvent(_collectionEventKind.ADD, [item]));</code></div><div class="line number22 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">item;</code></div><div class="line number23 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number24 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">removeItem: </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number25 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">index = </code><code class="jscript keyword">this</code><code class="jscript plain">.getItemIndex(item);</code></div><div class="line number26 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( index &gt; -1 ) {</code></div><div class="line number27 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.list.splice(index, 1);</code></div><div class="line number28 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript keyword">this</code><code class="jscript plain">).trigger(createEvent(_collectionEventKind.REMOVE, [item]));</code></div><div class="line number29 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">item;</code></div><div class="line number30 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number31 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">undefined;</code></div><div class="line number32 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number33 index32 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">removeAll: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number34 index33 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.list.length = 0;</code></div><div class="line number35 index34 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript keyword">this</code><code class="jscript plain">).trigger(createEvent(_collectionEventKind.RESET, </code><code class="jscript keyword">this</code><code class="jscript plain">.list));</code></div><div class="line number36 index35 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number37 index36 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">getItemAt: </code><code class="jscript keyword">function</code><code class="jscript plain">(index) {</code></div><div class="line number38 index37 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( index &lt; 0 || (index &gt; </code><code class="jscript keyword">this</code><code class="jscript plain">.itemLength() - 1) ) {</code></div><div class="line number39 index38 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">undefined;</code></div><div class="line number40 index39 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number41 index40 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">this</code><code class="jscript plain">.list[index];</code></div><div class="line number42 index41 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number43 index42 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">getItemIndex: </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number44 index43 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">this</code><code class="jscript plain">.list.indexOf(item);</code></div><div class="line number45 index44 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number46 index45 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">contains: </code><code class="jscript keyword">function</code><code class="jscript plain">(item) {</code></div><div class="line number47 index46 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">this</code><code class="jscript plain">.getItemIndex(item) != -1;</code></div><div class="line number48 index47 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number49 index48 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number50 index49 alt1">&nbsp;</div><div class="line number51 index50 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">{</code></div><div class="line number52 index51 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collectionEventKind: _collectionEventKind,</code></div><div class="line number53 index52 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">create: </code><code class="jscript keyword">function</code><code class="jscript plain">(source) {</code></div><div class="line number54 index53 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">instance = Object.create(collection);</code></div><div class="line number55 index54 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">Object.defineProperty(instance, </code><code class="jscript string">"list"</code><code class="jscript plain">, {</code></div><div class="line number56 index55 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">value: Array.isArray(source) ? source : [],</code></div><div class="line number57 index56 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">writable: </code><code class="jscript keyword">true</code><code class="jscript plain">,</code></div><div class="line number58 index57 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">enumerable: </code><code class="jscript keyword">true</code></div><div class="line number59 index58 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number60 index59 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">instance;</code></div><div class="line number61 index60 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number62 index61 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number63 index62 alt2">&nbsp;</div><div class="line number64 index63 alt1"><code class="jscript plain">});</code></div></pre></div>
<p>We have basically ripped the collection and factory out from our test implementation and dropped it into its own file, returning the event kind enumeration object and the <em>create()</em> factory method to generate new collections for this AMD module.</p>
<p>To verify that our <em>Collection</em> module works correctly, let’s replace the implementation in the test with this module reference and run our tests again:</p>
<p><em>/test/jasmine/spec/collection.spec.js</em></p>
<div><pre><div class="line number1 index0 alt2 highlighted"><code class="jscript plain">define( [</code><code class="jscript string">'jquery'</code><code class="jscript plain">, </code><code class="jscript string">'script/collection/collection'</code><code class="jscript plain">], </code><code class="jscript keyword">function</code><code class="jscript plain">($, collectionFactory) {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">describe(</code><code class="jscript string">'Collection'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">...</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="jscript plain">});</code></div></pre></div>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_v_2.png" alt="Passing collection tests on AMD module"></p>
<p>Tagged: <strong>0.1.6</strong> <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.6" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.6</a></p>
<h2>list-controller Refactoring</h2>
<p>Passing tests are great! But currently, they are lying to us. Well… not <em>really</em>,  but we have gone about all these new additions to our application and have yet still to refactor <em>list-controller</em> to utilize them. However, before we just start chopping out and inserting code from <em>list-controller</em>, I want to go over the API and specs currently defined and see if they still hold water – meaning we might be able to cut some tests out. We might not. We might even add more. Let’s see…</p>
<h3>newitem.spec</h3>
<p>As we designed the <a href="https://github.com/bustardcelly/grocery-ls/blob/0.1.3/script/controller/list-controller.js" target="_blank"><em>list-controller</em></a> from a <a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii" target="_blank">previous article</a>, it oversaw the state of list items, list item views, and sort of supported a quasi-state of <em>‘editability’</em>. While this provided an API to create a new item, it was forced into exposing an <em>editableItem</em> that was then mutable based on other parts of its API – ie, <em>editFocusedItem()</em> and <em>saveFocusedItem()</em>. All well and good to support the feature requirements at the time, but we have now moved the item and item view management – as well as the editable state – to the latest <em>list-item-controller</em> as can be seen in the repo <a href="https://github.com/bustardcelly/grocery-ls/blob/0.1.5/script/controller/list-item-controller.js" target="_blank">tagged at 0.1.5</a>. As such, I feel not only the <em>list-controller</em>, itself, should change to reflect these modifications, but also its API.</p>
<p>We are going to stick with our feature request to be able to add a new item to the <strong>Grocery List</strong> application through the <em>list-controller</em>, but will revisit how that is done in accordance to the new functionality of both the <em>list-item-controller</em> and <em>list-controller</em>; mainly we want to keep in mind that both should be driven by their respective model: <em>grocery-ls-item</em> and <em>collection</em>.</p>
<p>Let’s first revisit the specs we defined for new item feature from <a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii/" target="_blank">the second post</a> in this series:</p>
<p><em>// spec</em><br>
—<br>
<strong>Scenario 1:</strong> Item added to list<br>
<strong>Given</strong> a user requests to add an item to the list<br>
<strong>And</strong> has provided a name for the item<br>
<strong>When</strong> she requests to save the item<br>
<strong>Then</strong> the list has grown by one item<br>
<strong>And</strong> the list contains the item appended at the end<br>
—</p>
<p><em>// spec</em><br>
—<br>
<strong>Scenario 2:</strong> Item not added to list<br>
<strong>Given</strong> the list has a single item<br>
<strong>And</strong> a user requests to add an item to the list<br>
<strong>And</strong> has not provided a name for the item<br>
<strong>When</strong> she requests to save the item<br>
<strong>Then</strong> the list has the same items as stored previously<br>
<strong>And</strong> the list does not add an empty-named item<br>
—</p>
<p>In looking at them now, I feel that the actual <em>Add Item</em> feature is hidden in the <strong>Given</strong>s. A slight oversight now that we have progressed – perhaps one at the time as well, but we were delivering to features using TDD, so I have no qualms with features and implementations revisited and revised as the functionality of the application is fleshed out. In any event, I feel like these feature specs are more for a <em>Save Item</em> story, especially seeing as a User can edit an existing item. We’ll tackle the <em>Save Item</em> specifications for a later post, for now I want to revise the specifications for the <em>Add Item</em> feature.</p>
<h4>Tests</h4>
<p>The original story does not change, but we want to ensure that a <em>grocery-ls-item</em> model is returned on the API to create a new item from <em>list-controller </em>. With such a drastic refactor to the functionality of <em>list-controller</em>, I tend to do my thinking and designing within the tests and move to implementation – just as I have done previously with other components. Let’s take a look at the change to <em>newitem.spec.js</em> as a whole and then discuss the specs singularly:</p>
<p><em>/test/jasmine/spec/feature.newitem.spec.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">define([</code><code class="jscript string">'jquery'</code><code class="jscript plain">, </code><code class="jscript string">'script/controller/list-controller'</code><code class="jscript plain">, </code><code class="jscript string">'script/controller/list-item-controller'</code><code class="jscript plain">,</code></div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">'script/collection/collection'</code><code class="jscript plain">, </code><code class="jscript string">'script/model/grocery-ls-item'</code><code class="jscript plain">],</code></div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code><code class="jscript plain">($, listController, itemControllerFactory, collectionFactory, modelFactory) {</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">describe(</code><code class="jscript string">'New item creation from listController.createNewItem()'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">newModel,</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">newItemController,</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">listControllerStub,</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$listView = $(</code><code class="jscript string">'&lt;ul/&gt;'</code><code class="jscript plain">),</code></div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemCollection = collectionFactory.create();</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">beforeEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">$itemView = $(</code><code class="jscript string">'&lt;li&gt;'</code><code class="jscript plain">);</code></div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">newModel = modelFactory.create();</code></div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">newItemController = itemControllerFactory.create($itemView, newModel);</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">listControllerStub = sinon.stub(listController, </code><code class="jscript string">'createNewItem'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number20 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">listController.getItemList().addItem(newModel);</code></div><div class="line number21 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$itemView.appendTo($listView);</code></div><div class="line number22 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">newModel;</code></div><div class="line number23 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number24 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">listController.getItemList = sinon.stub().returns(itemCollection);</code></div><div class="line number25 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">listController.setView($listView);</code></div><div class="line number26 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number27 index26 alt2">&nbsp;</div><div class="line number28 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">it(</code><code class="jscript string">'should return newly created model'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number29 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">newItem = listController.createNewItem();</code></div><div class="line number30 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// loosely (duck-ly) verifying grocery-ls-item type.</code></div><div class="line number31 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(newItem).toEqual(jasmine.any(Object));</code></div><div class="line number32 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(newItem.hasOwnProperty(</code><code class="jscript string">'name'</code><code class="jscript plain">)).toBe(</code><code class="jscript keyword">true</code><code class="jscript plain">);</code></div><div class="line number33 index32 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(newItem.hasOwnProperty(</code><code class="jscript string">'id'</code><code class="jscript plain">)).toBe(</code><code class="jscript keyword">true</code><code class="jscript plain">);</code></div><div class="line number34 index33 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(newItem.id).not.toBeUndefined();</code></div><div class="line number35 index34 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number36 index35 alt1">&nbsp;</div><div class="line number37 index36 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">it(</code><code class="jscript string">'should add newly created item to collection'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number38 index37 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">newItem = listController.createNewItem(),</code></div><div class="line number39 index38 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemList = listController.getItemList();</code></div><div class="line number40 index39 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(itemList.itemLength()).not.toBe(0);</code></div><div class="line number41 index40 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(itemList.getItemAt(itemList.itemLength()-1)).toEqual(newItem);</code></div><div class="line number42 index41 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number43 index42 alt2">&nbsp;</div><div class="line number44 index43 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">it(</code><code class="jscript string">'should add new item controller to view'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number45 index44 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">listController.createNewItem();</code></div><div class="line number46 index45 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect($listView.children().length).toBe(1);</code></div><div class="line number47 index46 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number48 index47 alt1">&nbsp;</div><div class="line number49 index48 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">afterEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number50 index49 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$listView.empty();</code></div><div class="line number51 index50 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">newModel = undefined;</code></div><div class="line number52 index51 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">newItemController = undefined;</code></div><div class="line number53 index52 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemCollection.removeAll();</code></div><div class="line number54 index53 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">listController.createNewItem.restore();</code></div><div class="line number55 index54 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number56 index55 alt1">&nbsp;</div><div class="line number57 index56 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number58 index57 alt1">&nbsp;</div><div class="line number59 index58 alt2"><code class="jscript plain">});</code></div></pre></div>
<p>First off, you may notice that we are pulling in, as dependencies, every component we have basically created up to this point. Then, within the <em>beforeEach()</em> of the spec suite, using <a href="http://sinonjs.org/" target="_blank">SinonJS</a> we stub out the redesign and addition(s) to the API of <em>list-controller</em>; we are redefining the functionality of <em>createNewItem()</em> (which currently exists on <em>list-controller</em>) to return a <em>grocery-ls-item</em> instance and stubbing the <em>getItemList(</em>) method which will return the underlying collection model.</p>
<p>You may notice that i am using sinon.stub in two different ways:</p>
<div><pre><div class="line number19 index0 alt2"><code class="jscript plain">listControllerStub = sinon.stub(listController, </code><code class="jscript string">'createNewItem'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div></pre></div>
<div><pre><div class="line number24 index0 alt1"><code class="jscript plain">listController.getItemList = sinon.stub().returns(itemCollection);</code></div></pre></div>
<p>The former allows for you to redefine the function invoked upon the public method – in this case ‘<em>createNewItem</em>‘. In order to properly define a stub in such a manner without being shown errors in executing the tests, the method must already be available on the object you are stubbing. The latter allows you to stub a method that is not currently on the object. As you may notice, the instantiation of the two different stubs are different in their assignment on the object being stubbed. The operations within these stubs shouldn’t be taken as set in stone – they may change once we get to implementation in <em>list-controller</em> – but they setup our expectations that will be verified in the specifications. The first of which ensures the return of a <em>grocery-ls-item</em> through property assertions:</p>
<p><em>/test/jasmine/spec/feature/newitem.spec.js</em></p>
<div><pre><div class="line number28 index0 alt1"><code class="jscript plain">it(</code><code class="jscript string">'should return newly created model'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number29 index1 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">newItem = listController.createNewItem();</code></div><div class="line number30 index2 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">// loosely (duck-ly) verifying grocery-ls-item type.</code></div><div class="line number31 index3 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">expect(newItem).toEqual(jasmine.any(Object));</code></div><div class="line number32 index4 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">expect(newItem.hasOwnProperty(</code><code class="jscript string">'name'</code><code class="jscript plain">)).toBe(</code><code class="jscript keyword">true</code><code class="jscript plain">);</code></div><div class="line number33 index5 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">expect(newItem.hasOwnProperty(</code><code class="jscript string">'id'</code><code class="jscript plain">)).toBe(</code><code class="jscript keyword">true</code><code class="jscript plain">);</code></div><div class="line number34 index6 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">expect(newItem.id).not.toBeUndefined();</code></div><div class="line number35 index7 alt2"><code class="jscript plain">});</code></div></pre></div>
<p>The second spec tests that the newly created item is added to the collection exposed on list-controller:<br>
<em>/test/jasmine/spec/feature/newitem.spec.js</em></p>
<div><pre><div class="line number37 index0 alt2"><code class="jscript plain">it(</code><code class="jscript string">'should add newly created item to collection'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number38 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">newItem = listController.createNewItem(),</code></div><div class="line number39 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemList = listController.getItemList();</code></div><div class="line number40 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">expect(itemList.itemLength()).not.toBe(0);</code></div><div class="line number41 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">expect(itemList.getItemAt(itemList.itemLength()-1)).toEqual(newItem);</code></div><div class="line number42 index5 alt1"><code class="jscript plain">});</code></div></pre></div>
<p>And the third spec… well, it starts to address some of the expectations a User may have when using the <strong>Grocery List</strong> application, something we really haven’t tested for as of yet – you have to start somewhere, though, right? We are testing that in addition to a new model added to the collection, there is an associated view in the UI (or at least presumably):<br>
<em>/test/jasmine/spec/feature/newitem.spec.js</em></p>
<div><pre><div class="line number44 index0 alt1"><code class="jscript plain">it(</code><code class="jscript string">'should add new item controller to view'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number45 index1 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">listController.createNewItem();</code></div><div class="line number46 index2 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">expect($listView.children().length).toBe(1);</code></div><div class="line number47 index3 alt2"><code class="jscript plain">});</code></div></pre></div>
<p>I think we will start to see more of these type of tests as we start fleshing out the features more. </p>
<p>Actually, I have started taking steps in moving the separation of <em>integration tests</em> from <em>feature tests</em>, if you haven’t already noticed the update to the location of <em>newitem.spec.js</em>. In my mind, the difference is between what I consider tests of how a component behaves itself (and with others) and test which describe the actual use of the application, respectively.</p>
<p>Run the tests just as you have before with the updates to the feature spec locations:<br>
<em>/test/jasmine/specrunner.html</em></p>
<div><pre><div class="line number34 index0 alt1 highlighted"><code class="jscript plain">require( [</code><code class="jscript string">'spec/feature/additem.spec.js'</code><code class="jscript plain">, </code><code class="jscript string">'spec/feature/markitem.spec.js'</code><code class="jscript plain">,</code></div><div class="line number35 index1 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">'spec/item-controller.spec.js'</code><code class="jscript plain">, </code><code class="jscript string">'spec/grocery-ls-item.spec.js'</code><code class="jscript plain">,</code></div><div class="line number36 index2 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">'spec/collection.spec.js'</code><code class="jscript plain">], </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number37 index3 alt2">&nbsp;</div><div class="line number38 index4 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">jasmineEnv = jasmine.getEnv(),</code></div><div class="line number39 index5 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">...</code></div><div class="line number40 index6 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">jasmineEnv.execute();</code></div><div class="line number41 index7 alt2">&nbsp;</div><div class="line number42 index8 alt1"><code class="jscript plain">});</code></div></pre></div>
<p>And all is green! <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley"> </p>
<p>Tagged <strong>0.1.7</strong> – <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.7" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.7</a></p>
<h3>list-controller Revisted</h3>
<p>It’s great that the tests still pass, but we have yet to <strong>still</strong> modify <em>list-controller</em>. I can’t put it off any longer. If you have put up with the last couple posts and promises to get somewhere, you are very kind. The wait is over! … but it is also just the tip of the iceberg. sorry to be a downer <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley"> </p>
<p>In looking at the API on <em>list-controller</em> we stubbed out from the <em>beforeEach()</em> of the <em>newitem.spec</em> and the expectations of its functionality verified in the specs, we are basically boiling down the responsibilities of the <em>list-controller</em> to:</p>
<ul>
<li>Create a new item</li>
<li>Add item views to a provided element</li>
<li>Manage and respond to changes on a collection of <em>grocery-ls-item</em></li>
</ul>
<p>As a start, we can include the new dependencies and refactor the <em>list-controller</em> component to support these requirements:<br>
<em>/script/controller/list-controller.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">define([</code><code class="jscript string">'jquery'</code><code class="jscript plain">, </code><code class="jscript string">'script/controller/list-item-controller'</code><code class="jscript plain">, </code><code class="jscript string">'script/collection/collection'</code><code class="jscript plain">, </code><code class="jscript string">'script/model/grocery-ls-item'</code><code class="jscript plain">],</code></div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code><code class="jscript plain">($, itemControllerFactory, collectionFactory, modelFactory) {</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">collection = collectionFactory.create(),</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">listController = {</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$view: undefined,</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">getItemList: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">collection;</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">createNewItem: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">model = modelFactory.create();</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection.addItem(model);</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">model;</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">setView: </code><code class="jscript keyword">function</code><code class="jscript plain">(view) {</code></div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.$view = (view </code><code class="jscript keyword">instanceof</code> <code class="jscript plain">$) ? view : $(view);</code></div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number18 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">listController;</code></div><div class="line number21 index20 alt2">&nbsp;</div><div class="line number22 index21 alt1"><code class="jscript plain">});</code></div></pre></div>
<p>Differing from the stub created for <em>createNewItem()</em> in the <em>newitem.spec</em>, the <em>list-controller</em> is only concerned with updating the collection model here. This is because the change to the collection will drive updates to the UI and we don’t want to have the UI operations within the <em>createNewItem()</em> method – that will basically create a doubling-up of efforts. It will be the responsibility of this module to observe changes to the collection and update state. That is done by adding an event handler to <em>collection-change</em> and operating accordingly based on event <em>kind</em>:</p>
<p><em>/script/controller/list-controller.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">define([</code><code class="jscript string">'jquery'</code><code class="jscript plain">, </code><code class="jscript string">'script/controller/list-item-controller'</code><code class="jscript plain">, </code><code class="jscript string">'script/collection/collection'</code><code class="jscript plain">, </code><code class="jscript string">'script/model/grocery-ls-item'</code><code class="jscript plain">],</code></div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code><code class="jscript plain">($, itemControllerFactory, collectionFactory, modelFactory) {</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">collection = collectionFactory.create(),</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">listController = {</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$view: undefined,</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">getItemList: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">collection;</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">createNewItem: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">model = modelFactory.create();</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">collection.addItem(model);</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">model;</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">setView: </code><code class="jscript keyword">function</code><code class="jscript plain">(view) {</code></div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.$view = (view </code><code class="jscript keyword">instanceof</code> <code class="jscript plain">$) ? view : $(view);</code></div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number18 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">(</code><code class="jscript keyword">function</code> <code class="jscript plain">assignCollectionHandlers($collection) {</code></div><div class="line number21 index20 alt2 highlighted">&nbsp;</div><div class="line number22 index21 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">EventKindEnum = collectionFactory.collectionEventKind;</code></div><div class="line number23 index22 alt2 highlighted">&nbsp;</div><div class="line number24 index23 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$collection.on(</code><code class="jscript string">'collection-change'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(event) {</code></div><div class="line number25 index24 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">switch</code><code class="jscript plain">( event.kind ) {</code></div><div class="line number26 index25 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">case</code> <code class="jscript plain">EventKindEnum.ADD:</code></div><div class="line number27 index26 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">model = event.items.shift(),</code></div><div class="line number28 index27 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$itemView = $(</code><code class="jscript string">'&lt;li&gt;'</code><code class="jscript plain">),</code></div><div class="line number29 index28 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemController = itemControllerFactory.create($itemView, model);</code></div><div class="line number30 index29 alt1 highlighted">&nbsp;</div><div class="line number31 index30 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$itemView.appendTo(listController.$view);</code></div><div class="line number32 index31 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemController.state = itemControllerFactory.state.EDITABLE;</code></div><div class="line number33 index32 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">break</code><code class="jscript plain">;</code></div><div class="line number34 index33 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">case</code> <code class="jscript plain">EventKindEnum.REMOVE:</code></div><div class="line number35 index34 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">break</code><code class="jscript plain">;</code></div><div class="line number36 index35 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">case</code> <code class="jscript plain">EventKindEnum.RESET:</code></div><div class="line number37 index36 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">break</code><code class="jscript plain">;</code></div><div class="line number38 index37 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number39 index38 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number40 index39 alt1 highlighted">&nbsp;</div><div class="line number41 index40 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">}($(collection)));</code></div><div class="line number42 index41 alt1">&nbsp;</div><div class="line number43 index42 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">listController;</code></div><div class="line number44 index43 alt1">&nbsp;</div><div class="line number45 index44 alt2"><code class="jscript plain">});</code></div></pre></div>
<p>We are calling an <strong><a href="http://benalman.com/news/2010/11/immediately-invoked-function-expression/" target="_blank">IIFE</a></strong> with the <a href="http://jquery.org" target="_blank">jQuery</a> wrapped collection object and assigning an event handler to <em>collection-change</em> on the collection. Depending on the kind of <em>collection-change</em> event that has occurred, defined clauses with specified operations are entered – for the purposes of the current task and tests at hand, that is only the <em>ADD</em> event.</p>
<p>In the <em>EventKindEnum.ADD</em> switch..case you will see the UI modification, with the addition of the list item view and the editability state of its associated <em>list-item-controller</em> set to allow the User to edit the new item.</p>
<p>Now, with the implementation of the <em>Add Item</em> feature moved to <em>list-controller</em>, we can clean up our <em>newitem.spec.js</em>:<br>
<em>/test/jasmine/spec/feature/newitem.spec.js</em></p>
<div><pre><div class="line number1 index0 alt2 highlighted"><code class="jscript plain">define([</code><code class="jscript string">'jquery'</code><code class="jscript plain">, </code><code class="jscript string">'script/controller/list-controller'</code><code class="jscript plain">],</code></div><div class="line number2 index1 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code><code class="jscript plain">($, listController) {</code></div><div class="line number3 index2 alt2">&nbsp;</div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">describe(</code><code class="jscript string">'New item creation from listController.createNewItem()'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">$listView = $(</code><code class="jscript string">'&lt;ul/&gt;'</code><code class="jscript plain">);</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">beforeEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number9 index8 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">listController.setView($listView);</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">it(</code><code class="jscript string">'should return newly created model'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">newItem = listController.createNewItem();</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// loosely (duck-ly) verifying grocery-ls-item type.</code></div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(newItem).toEqual(jasmine.any(Object));</code></div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(newItem.hasOwnProperty(</code><code class="jscript string">'name'</code><code class="jscript plain">)).toBe(</code><code class="jscript keyword">true</code><code class="jscript plain">);</code></div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(newItem.hasOwnProperty(</code><code class="jscript string">'id'</code><code class="jscript plain">)).toBe(</code><code class="jscript keyword">true</code><code class="jscript plain">);</code></div><div class="line number18 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(newItem.id).not.toBeUndefined();</code></div><div class="line number19 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number20 index19 alt1">&nbsp;</div><div class="line number21 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">it(</code><code class="jscript string">'should add newly created item to collection'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number22 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">newItem = listController.createNewItem(),</code></div><div class="line number23 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">itemList = listController.getItemList();</code></div><div class="line number24 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(itemList.itemLength()).not.toBe(0);</code></div><div class="line number25 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect(itemList.getItemAt(itemList.itemLength()-1)).toEqual(newItem);</code></div><div class="line number26 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number27 index26 alt2">&nbsp;</div><div class="line number28 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">it(</code><code class="jscript string">'should add new item controller to view'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number29 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">listController.createNewItem();</code></div><div class="line number30 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">expect($listView.children().length).toBe(1);</code></div><div class="line number31 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number32 index31 alt1">&nbsp;</div><div class="line number33 index32 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">afterEach( </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number34 index33 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$listView.empty();</code></div><div class="line number35 index34 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number36 index35 alt1">&nbsp;</div><div class="line number37 index36 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number38 index37 alt1">&nbsp;</div><div class="line number39 index38 alt2"><code class="jscript plain">});</code></div></pre></div>
<p>And we’ll modify the main application module to reflect the change to the <em>list-controller</em> now only governing over a list DOM element and not to manage events from the add button on the DOM:</p>
<p><em>/script/grocery-ls.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">(</code><code class="jscript keyword">function</code><code class="jscript plain">(window, require) {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">require.config({</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">baseUrl: </code><code class="jscript string">"."</code><code class="jscript plain">,</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">paths: {</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"lib"</code><code class="jscript plain">: </code><code class="jscript string">"./lib"</code><code class="jscript plain">,</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"script"</code><code class="jscript plain">: </code><code class="jscript string">"./script"</code><code class="jscript plain">,</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"jquery"</code><code class="jscript plain">: </code><code class="jscript string">"./lib/jquery-1.8.3.min"</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">require( [</code><code class="jscript string">'jquery'</code><code class="jscript plain">, </code><code class="jscript string">'script/controller/list-controller'</code><code class="jscript plain">, </code><code class="jscript string">'script/collection/collection'</code><code class="jscript plain">],</code></div><div class="line number13 index12 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code><code class="jscript plain">($, listController, collectionFactory) {</code></div><div class="line number14 index13 alt1 highlighted">&nbsp;</div><div class="line number15 index14 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">listController.setView($(</code><code class="jscript string">'section.groceries ul'</code><code class="jscript plain">));</code></div><div class="line number16 index15 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">'section.groceries #add-item-button'</code><code class="jscript plain">).on(</code><code class="jscript string">'click'</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(event) {</code></div><div class="line number17 index16 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">listController.createNewItem();</code></div><div class="line number18 index17 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number19 index18 alt2 highlighted">&nbsp;</div><div class="line number20 index19 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number21 index20 alt2">&nbsp;</div><div class="line number22 index21 alt1"><code class="jscript plain">}(window, requirejs));</code></div></pre></div>
<p>Run the tests… and it will fail! Yay!<br>
<img src="http://custardbelly.com/blog/images/tdd_js/part_v_3.png" alt="Failing tests on list-controller refactor"></p>
<p><em>wait, what?!</em></p>
<p>Actually, most will pass – including the <em>newitem.spec</em> tests. It is the <em>markitem.spec</em> tests that will fail. We have modified the <em>list-controller</em> to accomodate the changes to the <em>Add Item</em> feature, but have not addressed the <em>Mark Off Item</em> feature in our refactoring.</p>
<p><img src="http://custardbelly.com/blog/images/tdd_js/part_v_4.png" alt="Mark-Off Item failure on list-controller refactor"></p>
<p>However, run the application and it will be just as usable as it was before – no change will be perceived by the end-user. The only thing that will change is now I have a <span style="color: red;">nagging feeling knowing my tests are failing</span>. Some naysayers may interject here and half-heartedly tell me to get rid of the tests, then. To them I say, ‘<em>pfffft</em>‘ <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley">  </p>
<p>I hate to see the tests in such a state, but this post is rather long as it is. Also, I like to joke that sometimes having failing tests to look at first thing in the morning is the best way to pick up from where you left off. I promise we’ll get these to go green in the next article of this series, and invite you to get them to pass if you are for it.</p>
<p>Tagged <strong>0.1.8</strong> – <a href="https://github.com/bustardcelly/grocery-ls/tree/0.1.8" target="_blank">https://github.com/bustardcelly/grocery-ls/tree/0.1.8</a></p>
<h2>Conclusion</h2>
<p>We finally got around to refactoring the <em>list-controller</em> to relieve it of item model management and state. In the course of doing so, we created a <em>Collection</em> object that will serve as the model for the <em>list-controller</em>. </p>
<p>This post was a lengthy one, and I appreciate you sticking through my yackity-yack. I think we are in fine shape now to approach previously defined and new features, get our tests passing again, and finalize the <strong>Grocery List</strong> application… in as far as first iteration deliverables go <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley"> </p>
<p>‘Til next time…</p>
<p>—</p>
<h1>Link Dump</h1>
<h2>Reference</h2>
<p><a href="http://tddjs.com/" target="_blank">Test-Driven JavaScript Development by Christian Johansen</a><br>
<a href="http://dannorth.net/introducing-bdd/" target="_blank">Introducing BDD by Dan North</a><br>
<a href="http://requirejs.org/" target="_blank">RequireJS</a><br>
<a href="https://github.com/amdjs/amdjs-api/wiki/AMD" target="_blank">AMD</a><br>
<a href="http://pivotal.github.com/jasmine/" target="_blank">Jasmine</a><br>
<a href="http://sinonjs.org/" target="_blank">Sinon</a><br>
<a href="https://github.com/derickbailey/jasmine.async" target="_blank">Jasmine.Async</a></p>
<h2>Post Series</h2>
<p><a href="https://github.com/bustardcelly/grocery-ls">grocery-ls github repo</a><br>
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-javascript-part-i" target="_blank">Part I – Introduction</a><br>
<a href="http://custardbelly.com/blog/2012/11/26/the-making-of-a-test-driven-grocery-list-application-in-js-part-ii">Part II – Feature: Add Item</a><br>
<a href="http://custardbelly.com/blog/2012/12/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-iii">Part III – Feature: Mark-Off Item</a><br>
<a href="http://custardbelly.com/blog/2012/12/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-iv">Part IV – Feature: List-Item-Controller</a><br>
<a href="http://custardbelly.com/blog/2012/12/31/the-making-of-a-test-driven-grocery-list-application-in-js-part-v/">Part V – Feature: List-Controller Refactoring</a><br>
<a href="http://custardbelly.com/blog/2013/01/08/the-making-of-a-test-driven-grocery-list-application-in-js-part-vi/" target="_blank">Part VI – Back to Passing</a><br>
<a href="http://custardbelly.com/blog/2013/01/17/the-making-of-a-test-driven-grocery-list-application-in-js-part-vii/">Part VII – Remove Item</a><br>
<a href="http://custardbelly.com/blog/2013/01/22/the-making-of-a-test-driven-grocery-list-application-part-viii/">Part VIII – Bug Fixing</a><br>
<a href="http://custardbelly.com/blog/2013/02/15/the-making-of-a-test-driven-grocery-list-application-in-js-part-ix/">Part IX – Persistence</a><br>
<a href="http://custardbelly.com/blog/2013/03/06/the-making-of-a-test-driven-grocery-list-application-in-js-part-x/">Part X – It Lives!</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/amd/" title="View all posts in AMD" rel="category tag">AMD</a>,  <a href="http://custardbelly.com/blog/category/javascript/" title="View all posts in JavaScript" rel="category tag">JavaScript</a>,  <a href="http://custardbelly.com/blog/category/requirejs/" title="View all posts in RequireJS" rel="category tag">RequireJS</a>,  <a href="http://custardbelly.com/blog/category/grocery-ls/" title="View all posts in grocery-ls" rel="category tag">grocery-ls</a>,  <a href="http://custardbelly.com/blog/category/jasmine/" title="View all posts in jasmine" rel="category tag">jasmine</a>,  <a href="http://custardbelly.com/blog/category/unit-testing/" title="View all posts in unit-testing" rel="category tag">unit-testing</a>.</p>
	
	

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">–</span> <abbr class="published" title="2012-12-31T16:13">December 31, 2012</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-686-target"></div>
	<div class="clear"></div>
	
	