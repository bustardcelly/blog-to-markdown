
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2011/03/04/jquery-mobile-couchdb-part-7-2-%e2%80%93-authorization-and-validation/" title="Permanent link to jQuery Mobile + CouchDB: Part 7.2 – Authorization and Validation" rel="bookmark" rev="post-394">jQuery Mobile + CouchDB: Part 7.2 – Authorization and Validation</a></h1>
	
	<div class="entry-content full-content">
		<p>In my <a href="http://custardbelly.com/blog/?p=360" target="_blank">previous post</a>, I covered authorization and validation on the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> side. We set up an administrator, created a user or two and established a <strong>user-role</strong> for our <strong>albums</strong> database that will be used in validation on document operations based on the user context of a session. We got to write some code – our <strong>validate_doc_update</strong> – but mainly it was all clicking around and filling in fields in <a href="http://127.0.0.1:5984/_utils/" target="_blank">Futon</a>. Necessary stuff, mind you… but let’s get back to code. More importantly, let’s get back to our <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> application. We didn’t even touch it in the last mini-series in a series.</p>
<p>In this article I am going to address showing a <strong>Log In/Sign Up</strong> dialog in our <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> application. Instead of forcing a user to log in upon first landing on our application (as we saw when setting up <strong>Security</strong> on our database in the past article), we are going to present the dialog when a user tries to perform an operation that requires session and user validation. The way we have set up the <strong>albums</strong> database in <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> is that everyone can view all the <strong>album</strong> documents, but only users of the <strong>albums</strong> database (those assigned with a <strong>user-role</strong> of “<em>albums-user</em>“) are allowed to add new <strong>album</strong> documents and only those associated users of a document are allowed to edit and delete their <strong>album</strong> document. So, from a client-side perspective, the dialog will be shown on <strong>Add</strong>, <strong>Edit</strong> and <strong>Delete</strong> if a previous session for the user has not been established.</p>
<p>Actually, it is probably a little misleading to say we will be doing all this in <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a>. I am actually going to incorporate <a href="http://jquery.com/" target="_blank">jQuery</a> concepts into our <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> application. We are going to present the dialog as a <a href="http://jquery.com/" target="_blank">jQuery</a> <strong>widget</strong> and manage the communication through a <a href="http://jquery.com/" target="_blank">jQuery</a> <strong>plugin</strong> for our application. So as far as the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework is concerned, we won’t be learning anything new per se – we’ll be learning how to incorporate <a href="http://jquery.com/" target="_blank">jQuery</a> <strong>widgets</strong> and <strong>plugins</strong> into our application. In previous articles, the main bulk of <a href="http://jquery.com/" target="_blank">jQuery</a> we have employed has been using accessors and modifiers for elements/events within our <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> application. We have also gotten familiar with the <em>jquery.couch</em> plugin that comes with <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> and handles most (if not all) the communication points we need for our application. So working with the <a href="http://jquery.com/" target="_blank">jQuery</a> library is not all that unfamiliar.</p>
<p>Right. Didn’t i say there will be more coding in this article? What am i doing yammering on? Its time to put your <a href="http://jquery.com/" target="_blank">jQuery</a> hats on, because its about to get a whole lot more fun*!</p>
<p><em>*guarantees not included.</em></p>
<h2>Template</h2>
<p>We are going to create a <strong>login dialog</strong> pretty much as your standard form with the option to either “<em>log in</em>” or “<em>sign up</em>” (if i ever don’t use the space in those and it bothers you, i apologize. its become a little habit). In our planning, we currently want the dialog to appear in at least 3 places based on an operation that requires session and user validation – <strong>Add</strong>, <strong>Edit</strong> and <strong>Delete</strong>. Down the road, there could be more. We could add a login button to some or every page to allow to login at any time within the application. We’ll stick to the 3 operations for now, but in knowing that the same visual piece will be used in multiple places throughout the application, it makes for a good case to use a template for the UI of our login dialog.</p>
<p>We learned about templates on the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> side previously – using <a href="https://github.com/janl/mustache.js/" target="_blank">Mustache</a> and <strong>Partials</strong> to create our views. Same concept. We want to be able to declare some mark-up in one place that will be rendered in the <strong>DOM</strong> upon request from anywhere in the application. To do that, we’ll use the <a href="http://github.com/jquery/jquery-tmpl" target="_blank">jquery.tmpl</a> plugin available at: <a href="http://github.com/jquery/jquery-tmpl" target="_blank">http://github.com/jquery/jquery-tmpl</a>. Why jquery.tmpl? It is simple to use and – though still in beta – is considered an <a href="http://www.borismoore.com/2010/10/jquery-templates-is-now-official-jquery.html" target="_blank">official jQuery plugin</a>, so documentation can be found on the <a href="http://jquery.com/" target="_blank">jQuery</a> site at: <a href="http://api.jquery.com/jquery.tmpl/" target="_blank">http://api.jquery.com/jquery.tmpl/</a>. In any event, make sure to download the jquery.tmpl plugin from <a href="http://github.com/jquery/jquery-tmpl" target="_blank">http://github.com/jquery/jquery-tmpl</a> as we are going to use it for our login dialog.</p>
<p>With <em>jquery.tmpl</em> downloaded and added to the <em>/vendor/couchapp/_attachments/</em> folder of our <strong>albums</strong> <a href="http://couchapp.org/page/index" target="_blank">coucapp</a> directory (in following the examples within this series, for me that directory is <em>/Documents/workspace/custardbelly/couchdb/albums</em>), open up the <em>loader.js</em> file from that same directory and save the following modification to include the <em>jquery.tmpl</em>:</p>
<p><em>/vendor/couchapp/_attachments/loader.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">function</code> <code class="jscript plain">couchapp_load(scripts) {</code></div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">for</code> <code class="jscript plain">(</code><code class="jscript keyword">var</code> <code class="jscript plain">i=0; i &lt; scripts.length; i++) {</code></div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.write(</code><code class="jscript string">'&lt;script src="'</code><code class="jscript plain">+scripts[i]+</code><code class="jscript string">'"&gt;&lt;\/script&gt;'</code><code class="jscript plain">)</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number5 index4 alt2"><code class="jscript plain">};</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="jscript plain">couchapp_load([</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"/_utils/script/sha1.js"</code><code class="jscript plain">,</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"/_utils/script/json2.js"</code><code class="jscript plain">,</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"vendor/couchapp/jquery-1.4.4.js"</code><code class="jscript plain">,</code></div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"/_utils/script/jquery.couch.js"</code><code class="jscript plain">,</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"vendor/couchapp/jquery.couch.app.js"</code><code class="jscript plain">,</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"vendor/couchapp/jquery.couch.app.util.js"</code><code class="jscript plain">,</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"vendor/couchapp/jquery.mustache.js"</code><code class="jscript plain">,</code></div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"vendor/couchapp/jquery.evently.js"</code><code class="jscript plain">,</code></div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"vendor/couchapp/jquery.mobile-1.0a2.js"</code><code class="jscript plain">,</code></div><div class="line number17 index16 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"vendor/couchapp/jquery.tmpl.js"</code></div><div class="line number18 index17 alt1"><code class="jscript plain">]);</code></div></pre></div>
<p>Pretty straight forward; just adding the <em>jquery.tmpl</em> <strong>plugin</strong> to be loaded into the <strong>DOM</strong>. Now we need to declare the mark-up for our <strong>login dialog</strong>. We’ll just add it to our main page and its usage will be revealed later. For now, open up the <em>/_attachments/index.html</em> file and save the following script tag and content between the previously declared script tags for the <em>loader.js</em> and our application script:</p>
<div><pre><div class="line number52 index0 alt1"><code class="xml plain">&lt;</code><code class="xml keyword">script</code> <code class="xml color1">src</code><code class="xml plain">=</code><code class="xml string">"vendor/couchapp/loader.js"</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">script</code><code class="xml plain">&gt;</code></div><div class="line number53 index1 alt2 highlighted"><code class="xml plain">&lt;</code><code class="xml keyword">script</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"loginSignupDialog"</code> <code class="xml color1">type</code><code class="xml plain">=</code><code class="xml string">"text/x-jquery-tmpl"</code><code class="xml plain">&gt;</code></div><div class="line number54 index2 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">role</code><code class="xml plain">=</code><code class="xml string">"dialog"</code> <code class="xml color1">data-backbtn</code><code class="xml plain">=</code><code class="xml string">"false"</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-dialog ui-body-a"</code><code class="xml plain">&gt;</code></div><div class="line number55 index3 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-header ui-bar-a ui-corner-top ui-overlay-shadow"</code><code class="xml plain">&gt;</code></div><div class="line number56 index4 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">h1</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-title"</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">h1</code><code class="xml plain">&gt;</code></div><div class="line number57 index5 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">a</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"dialogCloseButton"</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#"</code> <code class="xml color1">data-icon</code><code class="xml plain">=</code><code class="xml string">"delete"</code> <code class="xml color1">data-iconpos</code><code class="xml plain">=</code><code class="xml string">"notext"</code> <code class="xml color1">style</code><code class="xml plain">=</code><code class="xml string">"left: 15px; top: .4em; position: absolute;"</code> <code class="xml plain">/&gt;</code></div><div class="line number58 index6 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number59 index7 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"content"</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-body-c ui-corner-bottom ui-overlay-shadow"</code><code class="xml plain">&gt;</code></div><div class="line number60 index8 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">p</code><code class="xml plain">&gt;You need to be logged in to do that!&lt;/</code><code class="xml keyword">p</code><code class="xml plain">&gt;</code></div><div class="line number61 index9 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">form</code> <code class="xml color1">action</code><code class="xml plain">=</code><code class="xml string">"#"</code> <code class="xml color1">method</code><code class="xml plain">=</code><code class="xml string">"post"</code><code class="xml plain">&gt;</code></div><div class="line number62 index10 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">label</code> <code class="xml color1">for</code><code class="xml plain">=</code><code class="xml string">"username"</code><code class="xml plain">&gt;Username:&lt;/</code><code class="xml keyword">label</code><code class="xml plain">&gt;</code></div><div class="line number63 index11 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">input</code> <code class="xml color1">type</code><code class="xml plain">=</code><code class="xml string">"text"</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">"username"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"username"</code> <code class="xml color1">value</code><code class="xml plain">=</code><code class="xml string">""</code>&nbsp; <code class="xml plain">/&gt;</code></div><div class="line number64 index12 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">label</code> <code class="xml color1">for</code><code class="xml plain">=</code><code class="xml string">"password"</code><code class="xml plain">&gt;Password:&lt;/</code><code class="xml keyword">label</code><code class="xml plain">&gt;</code></div><div class="line number65 index13 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">input</code> <code class="xml color1">type</code><code class="xml plain">=</code><code class="xml string">"password"</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">"password"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"password"</code> <code class="xml color1">value</code><code class="xml plain">=</code><code class="xml string">""</code> <code class="xml plain">/&gt;</code></div><div class="line number66 index14 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">a</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"submitButton"</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#"</code> <code class="xml color1">type</code><code class="xml plain">=</code><code class="xml string">"submit"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"button"</code> <code class="xml color1">data-theme</code><code class="xml plain">=</code><code class="xml string">"b"</code><code class="xml plain">&gt;Submit&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;</code></div><div class="line number67 index15 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">hr</code><code class="xml plain">/&gt;</code></div><div class="line number68 index16 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">a</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"optionLinkButton"</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#"</code> <code class="xml plain">/&gt;</code></div><div class="line number69 index17 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">form</code><code class="xml plain">&gt;</code></div><div class="line number70 index18 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number71 index19 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"footer"</code> <code class="xml plain">/&gt;</code></div><div class="line number72 index20 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number73 index21 alt2 highlighted"><code class="xml plain">&lt;/</code><code class="xml keyword">script</code><code class="xml plain">&gt;</code></div><div class="line number74 index22 alt1"><code class="xml plain">&lt;</code><code class="xml keyword">script</code> <code class="xml color1">type</code><code class="xml plain">=</code><code class="xml string">"text/javascript"</code> <code class="xml color1">charset</code><code class="xml plain">=</code><code class="xml string">"utf-8"</code><code class="xml plain">&gt;</code></div><div class="line number75 index23 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">$db = $.couch.db("albums");</code></div></pre></div>
<p>The <strong>loginSignupDialog</strong> template looks pretty familiar if you have been following along in this series. It is just a hacked up <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page dialog with a form – looks pretty much what our <em>albumdelete.html</em> <strong>template</strong> we created before but with a form in it. You may notice that the header and <strong>optionLinkButton</strong> have no textual content. That will be updated based on the state of the dialog (login or signup). We’ll get to that later. What is important is to know that this template declaration can be rendered using the following:</p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">$(</code><code class="jscript string">"#loginSignupDialog"</code><code class="jscript plain">).tmpl()</code></div></pre></div>
<p>Once it has been rendered it can be added to the <strong>DOM</strong> as you normally would with <a href="http://jquery.com/" target="_blank">jQuery</a> (eg, <em>appendTo</em>()), but since we are developing in the context of a <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> application, we will treating it as a page in the application. Things to remember and will act upon later.</p>
<p>Also important to note is the type attribute of the <strong>template</strong> declaration – <em>text/x-jquery-tmpl</em>. That is so the <strong>HTML</strong> parser knows to treat that markup as a string and not try to parse and add to the <strong>DOM</strong>. Without that type, you likely will get a parse error when viewing your application in a browser. The plugin does not search for the explicit type value of <em>text/x-jquery-tmpl</em> in order to due its rendering, it just needs to have some denotation for the browser engine to recognize not to render the content to the <strong>DOM</strong> – <em>text/x-jquery-tmpl</em> is just easier to recognize what is being reserved as a <a href="http://jquery.com/" target="_blank">jQuery</a> template by human readers.</p>
<h2>Organization and Re-use</h2>
<p>Up to this point in the series, if you have been following along, the extent of our working with <a href="http://jquery.com/" target="_blank">jQuery</a> has been in accessing and modifying the <strong>DOM</strong>. We’ve used the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> API mainly to listen for events and change pages. The extent of working with the <a href="http://jquery.com/" target="_blank">jQuery Mobile</a> framework has been more under the hood – which i believe is the intent – though we have employed some hacks to get things to work as we would like. So, the <strong>JavaScript</strong> we have done up until this point has been to manipulate the <strong>DOM</strong> associated with a particular view – we created our <strong>Partials</strong> as quasi-view controllers and we have some script related to the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> pages we have defined in <em>index.html</em>.</p>
<p>That’s fine. I might do some things a little different if this was going to get my seal of approval, but we were having fun. I’m gonna get a little more organized now, however, and use some great functionality and <strong>API</strong> available to us just by loading <a href="http://jquery.com/">jQuery</a> and <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> that we have been foolishly ignoring. Not really ignoring… we just never had a really strong use case to address it until now.</p>
<p>We are going to employ two architectural concepts of jQuery in order to present our login dialog and authenticate session with our <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance: <strong>widgets</strong> and <strong>plugins</strong>.</p>
<p>Before we dive into some code, perhaps I should clarify how I interpret each concept as really they can be somewhat interchangeable and used in the same fashion. For instance they both can target an element like so:</p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">$(</code><code class="jscript string">"#myElement"</code><code class="jscript plain">).something();</code></div></pre></div>
<p>It is typically the <em>something</em>() invocation, for me, that sets them apart (aside from the code behind the <em>something</em>()). If it is a directive to manipulate the element or its ancestry in the <strong>DOM</strong>, then it is a plugin. If it is a call to decorate the element in such a way that it looks and behaves in a manner usually not associated with that element, then i consider it a <strong>widget</strong> <em>(in fact, as we will discuss later, there is more to this in terms of a factory/builder plugin for widgets)</em>. Say for instance: <strong>$(”#myElement”)</strong>.<em>slider</em>() would manipulate the contents of <strong>#myElement</strong> to behave like a slider control.</p>
<p>And then of course, plugins can declare a global access variable and define an <strong>API</strong>, as we have seen with <strong>$.mobile</strong> (<em>jquery-mobile-1.0a2.js</em>) and <strong>$.couch</strong> (<em>jquery.couch.js</em>), which takes the <strong>plugin</strong> concept from being more of a “utility” method on element(s) to that of a library.</p>
<p>Of course, I could be totally off-base in how i interpret these concepts and am open to discussion. If you have different interpretations or more insight please leave a comment.</p>
<h2>Widget</h2>
<p>Truthfully, a <strong>widget</strong> is more tied with the <a href="http://jqueryui.com/" target="_blank">jQuery UI</a> library. Included in the development-bundle source for <a href="http://jqueryui.com/" target="_blank">jQuery UI</a> is a <em>jquery.ui.widget</em> script that defines the <strong>widget</strong> factory/builder and the defined UI <strong>widget</strong> elements with the <strong>jquery.ui.*</strong> namespaced file name. We are not going to load the <a href="http://jqueryui.com/" target="_blank">jQuery UI</a> library as well, since <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> basically contains that script from <em>jquery.ui.widget</em> and extends it to <strong>mobile.widget</strong> to preform some string manipulation on the data attribute. In fact, most of the controls (and even page!) that are “mobilized” are widgets.</p>
<p>So we have <strong>$.widget</strong> at our disposal (thanks to <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a>). We’ll use the <strong>$.widget</strong> factory to create a <strong>login dialog</strong> widget to provide functional logic to our <strong>login template</strong> create previously in this article. In this sense, you can think of the <strong>login dialog widget</strong>, itself, as a sort of presenter. We can go about mucking around with the layout and such of our template and wire up our widget to respond to events from elements in our view.</p>
<p>Before we dive right in to some code, I wanted to touch on some finer points so when we take a look at how our <strong>login dialog widget</strong> is created we might have a clearer understanding of its construction. <strong>$.widget</strong> is considered a factory method to create custom widgets and is an extension of <strong>$.Widget</strong> (capital W). <strong>$.Widget</strong> itself acts as sort of a builder. Upon widget-ization of an element, <em>_init</em>() and <em>_create</em>() hook methods are invoked and available for override in our custom <strong>widget</strong>. There are also some methods for options, enablement, and for triggering events (<em>_trigger</em>()) to name a few. But most importantly, there is a <em>destroy</em>() method. To squash any memory leaks, we must tidy up our mess. </p>
<p>So, to break it down, <strong>$.Widget</strong> provides a lifecycle method template and is the builder of our <strong>widget</strong>. <strong>$.widget</strong> is a factory method for creating custom widgets and allows us to widget-ize elements based on the name of our widget. <em>What the hell does that mean?</em> If we create a widget using the <strong>$.widget</strong> factory and provide it a name of “<em>albums.loginDialog</em>“, we can widget-ize our template as such:</p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">$(</code><code class="jscript string">"#loginSignupDialog"</code><code class="jscript plain">).tmpl().loginDialog()</code></div></pre></div>
<p>In fact, that is essentially what we are going to do… but we first lets cover how we’re going to do it. For some extra reading, this is a great article form <a href="http://jqueryui.com/" target="_blank">jQuery UI</a> explaining the widget factory: <a href="http://jqueryui.com/docs/Developer_Guide" target="_blank">http://jqueryui.com/docs/Developer_Guide</a>. There is also this excellent write up i found by <a href="http://www.erichynds.com" target="_blank">Eric Hynds</a>: <a href="http://www.erichynds.com/jquery/tips-for-developing-jquery-ui-widgets/" target="_blank">http://www.erichynds.com/jquery/tips-for-developing-jquery-ui-widgets/</a>.</p>
<p>Less talk. More code. Open up your favorite editor and save the following snippet as <em>jquery.albums.loginDialog.js</em> in the <em>/_attachments/script</em> directory of the <strong>albums</strong> <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> (for me that directory is <em>/Documents/workspace/custardbelly/couchdb/albums</em>):</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">(</code><code class="jscript keyword">function</code><code class="jscript plain">( $ ) {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">$.widget( </code><code class="jscript string">"albums.loginDialog"</code><code class="jscript plain">, {</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">options: {</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">state: 0, </code><code class="jscript comments">// 0 - log in state. 1 - sign up state.</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">loginText: </code><code class="jscript string">"Log In"</code><code class="jscript plain">,</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">signUpText: </code><code class="jscript string">"Sign Up"</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">_create: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">ops = </code><code class="jscript keyword">this</code><code class="jscript plain">.options;</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">$element = </code><code class="jscript keyword">this</code><code class="jscript plain">.element;</code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Current page reference.</code></div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">currentPage = $.mobile.activePage;</code></div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">pageLink = currentPage.attr( </code><code class="jscript string">"id"</code> <code class="jscript plain">);</code></div><div class="line number18 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// It is an internal page link.</code></div><div class="line number19 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( pageLink.indexOf( </code><code class="jscript string">".html"</code> <code class="jscript plain">) == -1 ) pageLink = </code><code class="jscript string">"#"</code> <code class="jscript plain">+ pageLink;</code></div><div class="line number20 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">closeButton = $element.find( </code><code class="jscript string">"div[class*='ui-header'] a#dialogCloseButton"</code> <code class="jscript plain">)</code></div><div class="line number21 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">.attr( </code><code class="jscript string">"href"</code><code class="jscript plain">, pageLink );</code></div><div class="line number22 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Hold reference in custom data expando.</code></div><div class="line number23 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$element.data(</code><code class="jscript string">"previous"</code><code class="jscript plain">, pageLink );</code></div><div class="line number24 index23 alt1">&nbsp;</div><div class="line number25 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Wrap the content in a dialog page.</code></div><div class="line number26 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">wrapper = </code><code class="jscript keyword">this</code><code class="jscript plain">._wrapDialog( $element );</code></div><div class="line number27 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Wire interactions.</code></div><div class="line number28 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">._wire();</code></div><div class="line number29 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">._changeState( ops.state );</code></div><div class="line number30 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// For some reason, i have to add it to the DOM in order to changePage() to it.</code></div><div class="line number31 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"body[class*=\"ui-mobile-viewport\"]"</code><code class="jscript plain">).append(wrapper);</code></div><div class="line number32 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.mobile.changePage( [currentPage, wrapper], </code><code class="jscript string">"pop"</code><code class="jscript plain">, </code><code class="jscript keyword">false</code> <code class="jscript plain">);</code></div><div class="line number33 index32 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number34 index33 alt1">&nbsp;</div><div class="line number35 index34 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">_setOption: </code><code class="jscript keyword">function</code><code class="jscript plain">( key, value ) {</code></div><div class="line number36 index35 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">._changeState( ( key == </code><code class="jscript string">"state"</code> <code class="jscript plain">) ? value : </code><code class="jscript keyword">this</code><code class="jscript plain">.options.state );</code></div><div class="line number37 index36 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">jQuery.Widget.prototype._setOption.apply( </code><code class="jscript keyword">this</code><code class="jscript plain">, arguments );</code></div><div class="line number38 index37 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number39 index38 alt2">&nbsp;</div><div class="line number40 index39 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">_wrapDialog: </code><code class="jscript keyword">function</code><code class="jscript plain">( dialogElement ) {</code></div><div class="line number41 index40 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Page wrapper usually created on external page.</code></div><div class="line number42 index41 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">dialogPage = $(</code><code class="jscript string">"&lt;div data-role=\"page\"&gt;"</code><code class="jscript plain">);</code></div><div class="line number43 index42 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">dialogPage.append( dialogElement );</code></div><div class="line number44 index43 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">dialogPage.page();</code></div><div class="line number45 index44 alt2">&nbsp;</div><div class="line number46 index45 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">dialogPage.bind( </code><code class="jscript string">"pagebeforeshow"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number47 index46 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">dialogPage.unbind( </code><code class="jscript string">"pagebeforeshow"</code> <code class="jscript plain">);</code></div><div class="line number48 index47 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">h = parseFloat(dialogPage.innerHeight());</code></div><div class="line number49 index48 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">h -= ( parseFloat(dialogElement.css(</code><code class="jscript string">"border-top-width"</code><code class="jscript plain">)) + parseFloat(dialogElement.css(</code><code class="jscript string">"border-bottom-width"</code><code class="jscript plain">)) );</code></div><div class="line number50 index49 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// define the height based on innerHeight of wrapping parent page and the border styles applied to a dialog.</code></div><div class="line number51 index50 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">dialogElement.css( </code><code class="jscript string">"height"</code><code class="jscript plain">, h + </code><code class="jscript string">"px"</code> <code class="jscript plain">);</code></div><div class="line number52 index51 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number53 index52 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">dialogPage.bind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number54 index53 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">dialogPage.unbind( </code><code class="jscript string">"pagehide"</code> <code class="jscript plain">);</code></div><div class="line number55 index54 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">dialogPage.empty();</code></div><div class="line number56 index55 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">dialogPage.remove();</code></div><div class="line number57 index56 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number58 index57 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">dialogPage;</code></div><div class="line number59 index58 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number60 index59 alt1">&nbsp;</div><div class="line number61 index60 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">_changeState: </code><code class="jscript keyword">function</code><code class="jscript plain">( state ) {</code></div><div class="line number62 index61 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">mainText = ( state == 0 ) ? </code><code class="jscript keyword">this</code><code class="jscript plain">.options.loginText : </code><code class="jscript keyword">this</code><code class="jscript plain">.options.signUpText;</code></div><div class="line number63 index62 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">optionText = ( state == 0 ) ? </code><code class="jscript keyword">this</code><code class="jscript plain">.options.signUpText : </code><code class="jscript keyword">this</code><code class="jscript plain">.options.loginText;</code></div><div class="line number64 index63 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">$element = </code><code class="jscript keyword">this</code><code class="jscript plain">.element;</code></div><div class="line number65 index64 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">header = $element.find( </code><code class="jscript string">"div[class*='ui-header']"</code> <code class="jscript plain">);</code></div><div class="line number66 index65 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">page = $element.find( </code><code class="jscript string">"div[data-role='content']"</code> <code class="jscript plain">);</code></div><div class="line number67 index66 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">title = header.find( </code><code class="jscript string">"[class*='ui-title']"</code> <code class="jscript plain">);</code></div><div class="line number68 index67 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">optionLinkButton =&nbsp; page.find( </code><code class="jscript string">"#optionLinkButton"</code> <code class="jscript plain">);</code></div><div class="line number69 index68 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">submitButton = page.find( </code><code class="jscript string">"a[aria-label='submit']"</code> <code class="jscript plain">);</code></div><div class="line number70 index69 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">title.html( mainText );</code></div><div class="line number71 index70 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">optionLinkButton.html( optionText + </code><code class="jscript string">"?"</code> <code class="jscript plain">);</code></div><div class="line number72 index71 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">submitButton.html( mainText );</code></div><div class="line number73 index72 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">submitButton.buttonMarkup();</code></div><div class="line number74 index73 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number75 index74 alt2">&nbsp;</div><div class="line number76 index75 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">_wire: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number77 index76 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">ref = </code><code class="jscript keyword">this</code><code class="jscript plain">;</code></div><div class="line number78 index77 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">$element = ref.element;</code></div><div class="line number79 index78 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">ops = ref.options;</code></div><div class="line number80 index79 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">page = $element.find(</code><code class="jscript string">"div[data-role='content']"</code><code class="jscript plain">);</code></div><div class="line number81 index80 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">optionLinkButton = page.find( </code><code class="jscript string">"#optionLinkButton"</code> <code class="jscript plain">);</code></div><div class="line number82 index81 alt1">&nbsp;</div><div class="line number83 index82 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">optionLinkButton.bind( </code><code class="jscript string">"click"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(event) {</code></div><div class="line number84 index83 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">event.preventDefault();</code></div><div class="line number85 index84 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// toggle state.</code></div><div class="line number86 index85 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">ref._setOption( </code><code class="jscript string">"state"</code><code class="jscript plain">, ( ops.state == 1 ) ? 0 : 1 );</code></div><div class="line number87 index86 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">false</code><code class="jscript plain">;</code></div><div class="line number88 index87 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number89 index88 alt2">&nbsp;</div><div class="line number90 index89 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$element.bind( </code><code class="jscript string">"submit"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">(event) {</code></div><div class="line number91 index90 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">event.preventDefault();</code></div><div class="line number92 index91 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">username = $element.find( </code><code class="jscript string">"input#username"</code> <code class="jscript plain">).val();</code></div><div class="line number93 index92 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">password = $element.find( </code><code class="jscript string">"input#password"</code> <code class="jscript plain">).val();</code></div><div class="line number94 index93 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">uievent = ( ops.state == 0 ) ? </code><code class="jscript string">"login"</code> <code class="jscript plain">: </code><code class="jscript string">"signup"</code><code class="jscript plain">;</code></div><div class="line number95 index94 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">ui = {name:username, password:password};</code></div><div class="line number96 index95 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">ref._trigger( uievent, {type:uievent}, ui );</code></div><div class="line number97 index96 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">false</code><code class="jscript plain">;</code></div><div class="line number98 index97 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number99 index98 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number100 index99 alt1">&nbsp;</div><div class="line number101 index100 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">_unwire: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number102 index101 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">$element = </code><code class="jscript keyword">this</code><code class="jscript plain">.element;</code></div><div class="line number103 index102 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">page = $element.find( </code><code class="jscript string">"div[data-role='content']"</code> <code class="jscript plain">);</code></div><div class="line number104 index103 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">optionLinkButton =&nbsp; page.find( </code><code class="jscript string">"#optionLinkButton"</code> <code class="jscript plain">);</code></div><div class="line number105 index104 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">optionLinkButton.unbind( </code><code class="jscript string">"click"</code> <code class="jscript plain">);</code></div><div class="line number106 index105 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$element.unbind( </code><code class="jscript string">"submit"</code> <code class="jscript plain">);</code></div><div class="line number107 index106 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number108 index107 alt1">&nbsp;</div><div class="line number109 index108 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">close: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number110 index109 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">$element = </code><code class="jscript keyword">this</code><code class="jscript plain">.element;</code></div><div class="line number111 index110 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">._trigger( </code><code class="jscript string">"close"</code><code class="jscript plain">, {type:</code><code class="jscript string">"close"</code><code class="jscript plain">} );</code></div><div class="line number112 index111 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.mobile.changePage( $element.data(</code><code class="jscript string">"previous"</code><code class="jscript plain">), undefined, </code><code class="jscript keyword">false</code> <code class="jscript plain">);</code></div><div class="line number113 index112 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number114 index113 alt1">&nbsp;</div><div class="line number115 index114 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">destroy: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number116 index115 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">._unwire();</code></div><div class="line number117 index116 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// jQuery Mobile keeps adding a Submit button substitue to the template upon show,</code></div><div class="line number118 index117 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Lets remove it here.</code></div><div class="line number119 index118 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">$element = </code><code class="jscript keyword">this</code><code class="jscript plain">.element;</code></div><div class="line number120 index119 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">page = $element.find( </code><code class="jscript string">"div[data-role='content']"</code> <code class="jscript plain">);</code></div><div class="line number121 index120 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">submitButton = page.find( </code><code class="jscript string">"a[aria-label='submit']"</code> <code class="jscript plain">);</code></div><div class="line number122 index121 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">submitButton.remove();</code></div><div class="line number123 index122 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// super destroy.</code></div><div class="line number124 index123 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">jQuery.Widget.prototype.destroy.call( </code><code class="jscript keyword">this</code> <code class="jscript plain">);</code></div><div class="line number125 index124 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.element = </code><code class="jscript keyword">null</code><code class="jscript plain">;</code></div><div class="line number126 index125 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number127 index126 alt2">&nbsp;</div><div class="line number128 index127 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number129 index128 alt2">&nbsp;</div><div class="line number130 index129 alt1"><code class="jscript plain">})(jQuery)</code></div></pre></div>
<p>You wanted code? You got it <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley">  I am not going to go into explaining the under-workings of <strong>$.widget</strong> or <strong>$.Widget</strong> but more the work we have here that relates to <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> and our application. Again, if you are curious, <a href="http://jqueryui.com/" target="_blank">jQuery UI</a> has some great documentation at <a href="http://jqueryui.com/docs/Developer_Guide" target="_blank">http://jqueryui.com/docs/Developer_Guide</a> and you can also look at the <strong>JavaScript</strong> source for <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a>. That is chock full of widgets. And then there is this awesome write up by <a href="http://www.erichynds.com" target="_blank">Eric Hynds</a>: <a href="http://www.erichynds.com/jquery/tips-for-developing-jquery-ui-widgets/" target="_blank">http://www.erichynds.com/jquery/tips-for-developing-jquery-ui-widgets/</a>.</p>
<p>Now, let’s step through it… If you are being introduced to <a href="http://jquery.com/" target="_blank">jQuery</a> by this article series: <strong>a)</strong> i hope i have not mislead you in my explanations and <strong>b)</strong> this might be the first time you have seen this anonymous function declaration:</p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">(</code><code class="jscript keyword">function</code><code class="jscript plain">( $ ) {</code></div><div class="line number2 index1 alt1"><code class="jscript plain">...</code></div><div class="line number3 index2 alt2"><code class="jscript plain">})(jQuery)</code></div></pre></div>
<p>There is more going on here (conflict resolution) than i will explain, but in essence this is a self-executing method that has a reference to <a href="http://jquery.com/" target="_blank">jQuery</a>. Basically, upon load any code within this anonymous function will be run and have access to <a href="http://jquery.com/" target="_blank">jQuery</a> using the <strong>$</strong> token; once <em>jquery.albums.loginDialog.js</em> is loaded, we invoke the <strong>$.widget</strong> factory method to create a <strong>widget</strong> accessible via <em>loginDialog</em>() on an element reference:</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<div><pre><div class="line number3 index0 alt2"><code class="jscript plain">$.widget( </code><code class="jscript string">"albums.loginDialog"</code><code class="jscript plain">, {</code></div><div class="line number4 index1 alt1"><code class="jscript plain">...</code></div><div class="line number5 index2 alt2"><code class="jscript plain">} );</code></div></pre></div>
<p>The second argument to <strong>$.widget</strong> – the whole big object – is basically the meat of our <strong>widget</strong>; its got some declared default options, overidden inherited methods and some other private and public methods to make our <strong>loginDialog</strong> work. Our options are just some default values to set the initial state (either to <em>login</em> or <em>signup</em>) and the textual content associated with the state. Our <strong>login dialog</strong> isn’t going to be very pretty or contain much content other than a form and a way to switch between <em>login</em> and <em>signup</em>.</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<div><pre><div class="line number5 index0 alt2"><code class="jscript plain">options: {</code></div><div class="line number6 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">state: 0, </code><code class="jscript comments">// 0 - log in state. 1 - sign up state.</code></div><div class="line number7 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">loginText: </code><code class="jscript string">"Log In"</code><code class="jscript plain">,</code></div><div class="line number8 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">signUpText: </code><code class="jscript string">"Sign Up"</code></div><div class="line number9 index4 alt2"><code class="jscript plain">},</code></div></pre></div>
<p>When it enters <em>_create</em>() (inheritance call from <strong>$.Widget</strong>), is when we do some real magic:</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<div><pre><div class="line number13 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">$element = </code><code class="jscript keyword">this</code><code class="jscript plain">.element;</code></div><div class="line number14 index1 alt1">&nbsp;</div><div class="line number15 index2 alt2"><code class="jscript comments">// Current page reference.</code></div><div class="line number16 index3 alt1"><code class="jscript keyword">var</code> <code class="jscript plain">currentPage = $.mobile.activePage;</code></div><div class="line number17 index4 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">pageLink = currentPage.attr( </code><code class="jscript string">"id"</code> <code class="jscript plain">);</code></div><div class="line number18 index5 alt1"><code class="jscript comments">// It is an internal page link.</code></div><div class="line number19 index6 alt2"><code class="jscript keyword">if</code><code class="jscript plain">( pageLink.indexOf( </code><code class="jscript string">".html"</code> <code class="jscript plain">) == -1 ) pageLink = </code><code class="jscript string">"#"</code> <code class="jscript plain">+ pageLink;</code></div><div class="line number20 index7 alt1"><code class="jscript keyword">var</code> <code class="jscript plain">closeButton = $element.find( </code><code class="jscript string">"div[class*='ui-header'] a#dialogCloseButton"</code> <code class="jscript plain">)</code></div><div class="line number21 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">.attr( </code><code class="jscript string">"href"</code><code class="jscript plain">, pageLink );</code></div><div class="line number22 index9 alt1"><code class="jscript comments">// Hold reference in custom data expando.</code></div><div class="line number23 index10 alt2"><code class="jscript plain">$element.data(</code><code class="jscript string">"previous"</code><code class="jscript plain">, pageLink );</code></div></pre></div>
<p>The target element (the one widget-ized by calling <strong>$(”#myElement”)</strong>.<em>loginDialog</em>()) is accessed using the this keyword and is available through the life of the <strong>widget</strong>. In order to get a reference to the current page prior to opening the <strong>loginDialog</strong>, we access the id value of <strong>$.mobile</strong>.<em>activePage</em> and determine if it is an external or internal page. We then pass that as the href value for the close button on the <strong>loginDialog</strong> and add a <strong>data-previous</strong> attribute to the target element. </p>
<p>After the previous page has been determined to return to after login or signup, we then wrap the <strong>dialog template</strong> element in a page <strong>div</strong> listen for events, change the state to the default defined in options and change the page to the <strong>loginDialog</strong>:</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<div><pre><div class="line number25 index0 alt2"><code class="jscript comments">// Wrap the content in a dialog page.</code></div><div class="line number26 index1 alt1"><code class="jscript keyword">var</code> <code class="jscript plain">wrapper = </code><code class="jscript keyword">this</code><code class="jscript plain">._wrapDialog( $element );</code></div><div class="line number27 index2 alt2"><code class="jscript comments">// Wire interactions.</code></div><div class="line number28 index3 alt1"><code class="jscript keyword">this</code><code class="jscript plain">._wire();</code></div><div class="line number29 index4 alt2"><code class="jscript keyword">this</code><code class="jscript plain">._changeState( ops.state );</code></div><div class="line number30 index5 alt1"><code class="jscript comments">// For some reason, i have to add it to the DOM in order to changePage() to it.</code></div><div class="line number31 index6 alt2"><code class="jscript plain">$(</code><code class="jscript string">"body[class*=\"ui-mobile-viewport\"]"</code><code class="jscript plain">).append(wrapper);</code></div><div class="line number32 index7 alt1"><code class="jscript plain">$.mobile.changePage( [currentPage, wrapper], </code><code class="jscript string">"pop"</code><code class="jscript plain">, </code><code class="jscript keyword">false</code> <code class="jscript plain">);</code></div></pre></div>
<p>You see that funky append before <strong>$.mobile</strong>.<em>changePage</em>()?</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<div><pre><div class="line number31 index0 alt2"><code class="jscript plain">$(</code><code class="jscript string">"body[class*=\"ui-mobile-viewport\"]"</code><code class="jscript plain">).append(wrapper);</code></div></pre></div>
<p>The comment above that line explains it, but for some reason i couldn’t just switch to this dynamically created page. Instead i had to add it quickly at the end of the body (accessed by the <em>ui-mobile-viewport</em> class) and then was able to switch from the previous page to show a <strong>loginDialog</strong>. No big deal, just something to look out for. </p>
<p>Most of what is in <em>jquery.albums.loginDialog</em>, if you have been following along, may be pretty familiar to you. We do the same sizing on <em>pagebeforeshow</em> and emptying on <em>pagehide</em>, and change values based on state using <a href="http://jquery.com/" target="_blank">jQuery</a>. Your basic fanfare. I just wanted to touch on two more methods in <em>jquery.albums.loginDialog</em>: <em>close</em> and <em>destroy</em>:</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<div><pre><div class="line number109 index0 alt2"><code class="jscript plain">close: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number110 index1 alt1"><code class="jscript keyword">var</code> <code class="jscript plain">$element = </code><code class="jscript keyword">this</code><code class="jscript plain">.element;</code></div><div class="line number111 index2 alt2"><code class="jscript keyword">this</code><code class="jscript plain">._trigger( </code><code class="jscript string">"close"</code><code class="jscript plain">, {type:</code><code class="jscript string">"close"</code><code class="jscript plain">} );</code></div><div class="line number112 index3 alt1"><code class="jscript plain">$.mobile.changePage( $element.data(</code><code class="jscript string">"previous"</code><code class="jscript plain">), undefined, </code><code class="jscript keyword">false</code> <code class="jscript plain">);</code></div><div class="line number113 index4 alt2"><code class="jscript plain">},</code></div><div class="line number114 index5 alt1">&nbsp;</div><div class="line number115 index6 alt2"><code class="jscript plain">destroy: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number116 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">._unwire();</code></div><div class="line number117 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">// jQuery Mobile keeps adding a Submit button substitue to the template upon show,</code></div><div class="line number118 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">// Lets remove it here.</code></div><div class="line number119 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">$element = </code><code class="jscript keyword">this</code><code class="jscript plain">.element;</code></div><div class="line number120 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">page = $element.find( </code><code class="jscript string">"div[data-role='content']"</code> <code class="jscript plain">);</code></div><div class="line number121 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">submitButton = page.find( </code><code class="jscript string">"a[aria-label='submit']"</code> <code class="jscript plain">);</code></div><div class="line number122 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">submitButton.remove();</code></div><div class="line number123 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript comments">// super destroy.</code></div><div class="line number124 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">jQuery.Widget.prototype.destroy.call( </code><code class="jscript keyword">this</code> <code class="jscript plain">);</code></div><div class="line number125 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.element = </code><code class="jscript keyword">null</code><code class="jscript plain">;</code></div><div class="line number126 index17 alt1"><code class="jscript plain">}</code></div></pre></div>
<p>The <em>close</em>() method we have exposed and is not part of <strong>$.Widget</strong>. That just allows access to anyone with a reference to the created <strong>loginDialog</strong> to directly close it (as opposed to explicitly closing it within the dialog). You can see that we change the page by using the previous data value set on the element within <em>_create</em>(). We also dispatch a “<em>close</em>” event using <em>_trigger</em>(). The <em>_trigger</em>() method is part of <strong>$.Widget</strong> and can be bound to like other events, yet the type is slightly different within the context of a <strong>widget</strong>. The type value is actually appended to the <strong>widget</strong> name, so if you were to listen for close on this:</p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">$(</code><code class="jscript string">"#loginSignupDialog"</code><code class="jscript plain">).tmpl().loginDialog().bind( </code><code class="jscript string">"logindialogclose"</code><code class="jscript plain">, handleLoginDialogClose );</code></div></pre></div>
<p>That’s one way to do it, though i often assign handlers by passing in a <strong>callback</strong> object like so:</p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">$(</code><code class="jscript string">"#loginSignupDialog"</code><code class="jscript plain">).tmpl().loginDialog( {</code></div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">close: </code><code class="jscript keyword">function</code><code class="jscript plain">( evt, ui ) {</code></div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">...</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number5 index4 alt2"><code class="jscript plain">});</code></div></pre></div>
<p>We actually trigger two other events within our <strong>loginDialog</strong> – “<em>login</em>” and “<em>signup</em>” – which are dispatched upon submit based on current state. We’ll see how all this is handled a little later on in more code, but i quickly wanted to touch on something that looks odd in the <em>destroy</em>() override:</p>
<p><em>/_attachments/script/jquery.albums.loginDialog.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">$element = </code><code class="jscript keyword">this</code><code class="jscript plain">.element;</code></div><div class="line number2 index1 alt1"><code class="jscript keyword">var</code> <code class="jscript plain">page = $element.find( </code><code class="jscript string">"div[data-role='content']"</code> <code class="jscript plain">);</code></div><div class="line number3 index2 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">submitButton = page.find( </code><code class="jscript string">"a[aria-label='submit']"</code> <code class="jscript plain">);</code></div><div class="line number4 index3 alt1"><code class="jscript plain">submitButton.remove();</code></div></pre></div>
<p>When a form is added top the <strong>DOM</strong> through <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a>, it actually duplicates and hides the originally declared <strong>submit</strong> button and decorates a that duplicate for display. In that decoration, it is given the <strong>aria-label</strong> attribute for accessibility. Not entirely a huge issue, but if you were to show the template form more than once, you would start to see n+ times the amount of submit buttons! So we just remove it in our <em>destroy</em> override and move on.</p>
<p>Alright. Hopefully you are still with me. You may or may not have created your first <a href="http://jquery.com/" target="_blank">jQuery</a> <strong>widget</strong>. Isn’t it glorious or not glorious, respectively? With our <strong>template</strong> and <strong>widget</strong> defined, now begs the question: <em>When do we show this thing?</em> </p>
<h2>Plugin</h2>
<p>So you thought introducing two new concepts (<a href="http://jquery.com/" target="_blank">jQuery</a> <strong>templates</strong> and <strong>widgets</strong>) was enough for one article? Well, in the words of television’s <strong>Emeril</strong>, ‘<em>We’re going to kick it up a notch!</em>‘ That’s actually probably a paraphrase. I don’t know the exact words he said and i don’t feel like googling it. I was just pandering to the developer crowd who enjoys watching cooking shows… Its a low point in this article and i am not proud of it. Let’s keep going.</p>
<p>If we step back and remember why we started doing all this business in this mini-series, we wanted to use validation on operations to our database documents. In the previous article we spoke of <strong>user context</strong>s, and updated our <strong>album</strong> document to require a user field. So, our main intent with this <strong>loginDialog</strong> is to verify a current session and then either login or signup a user. If the session is valid (user previously logged in) then, the user reference is stored and – dependent on the action – used in further transactions.</p>
<p>Now, we could just open the <strong>loginDialog</strong> all willy-nilly, here and there, and try to track down the persisted user across actions, but a saner approach (for me at least) is to encapsulate this logic in a <strong>plugin</strong>. You may be familiar with <a href="http://jquery.com/" target="_blank">jQuery</a> <strong>plugins</strong>… actually we have been using them throughout this whole series. We just haven’t directly looked at how they are made or work. Like I did with our <strong>widget</strong> example, I am not going to go into a discussion of <a href="http://jquery.com/">jQuery</a> <strong>plugins</strong> per se – I am going to try and focus on the task at hand and provide explanations as to how it pertains to our application as a whole. That said, to read more about <a href="http://jquery.com/" target="_blank">jQuery</a> <strong>plugins</strong>, this is always a great place to start: <a href="http://docs.jquery.com/Plugins/Authoring" target="_blank">http://docs.jquery.com/Plugins/Authoring</a>.</p>
<p>Alright, we are going to take a little piecemeal approach to fleshing out our <strong>plugin</strong>, explaining as we go along, and I’ll provide it in its entirety afterward. To start, open up your favorite editor, create a file named <em>jquery.albums.app.js</em> and save it in the <em>/_attachments/script</em> folder of our <strong>albums</strong> <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> directory. Add the following:</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">(</code><code class="jscript keyword">function</code><code class="jscript plain">($) {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">$.albums = $.albums || {};</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">$.extend( $.albums, {</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="jscript plain">})(jQuery)</code></div></pre></div>
<p>That is the start of our <strong>albums</strong> <strong>plugin</strong> which will be accessible by <strong>$.albums</strong>. We’re extending our (hopefully) newly created <strong>$.albums</strong> object to flesh out its public <strong>API</strong>. <strong>$.albums</strong> will serve as a facade/adaptor to the <strong>$.couch</strong> plugin and handle the display and event from the <strong>loginDialog</strong>. So there are roughly five main functions of out <strong>$.albums</strong> plugin:</p>
<ul>
<li>Log In – Direct log in request.</li>
<li>Log Out – Direct log out request</li>
<li>Save Document – Request to Create or Update a document.</li>
<li>Delete Document – Request to Delete a document.</li>
</ul>
<p>The <strong>Log In</strong> and <strong>Log Out</strong> methods mainly interface directly with <strong>$.couch</strong> and won’t deal with any UI. They are just facades to track the logged in user so we can properly send user data when creating or updating documents. The <strong>Save Document</strong> and <strong>Delete Document</strong> methods are more adaptors for <strong>$.couch</strong> communication – checking session and presenting the <strong>loginDialog</strong> if necessary. Update the <em>jquery.albums.app.js</em> with the following:</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">(</code><code class="jscript keyword">function</code><code class="jscript plain">($) {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">$.albums = $.albums || {};</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">$.extend( $.albums, {</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">dialog: undefined,</code></div><div class="line number7 index6 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">database: undefined,</code></div><div class="line number8 index7 alt1 highlighted">&nbsp;</div><div class="line number9 index8 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">logIn: </code><code class="jscript keyword">function</code><code class="jscript plain">( name, password, options ) {</code></div><div class="line number10 index9 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">doLogIn( name, password, options );</code></div><div class="line number11 index10 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number12 index11 alt1 highlighted">&nbsp;</div><div class="line number13 index12 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">logOut: </code><code class="jscript keyword">function</code><code class="jscript plain">( options ) {</code></div><div class="line number14 index13 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">doLogOut( options );</code></div><div class="line number15 index14 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number16 index15 alt1 highlighted">&nbsp;</div><div class="line number17 index16 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">saveDocument: </code><code class="jscript keyword">function</code><code class="jscript plain">( document, options ) {</code></div><div class="line number18 index17 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">checkSession( {</code></div><div class="line number19 index18 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">available: </code><code class="jscript keyword">function</code><code class="jscript plain">( userCtx ) {</code></div><div class="line number20 index19 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.user = user;</code></div><div class="line number21 index20 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.albums.database.saveDoc( document, options );</code></div><div class="line number22 index21 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number23 index22 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">unavailable: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number24 index23 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">showDialog( options );</code></div><div class="line number25 index24 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number26 index25 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number27 index26 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number28 index27 alt1 highlighted">&nbsp;</div><div class="line number29 index28 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deleteDocument: </code><code class="jscript keyword">function</code><code class="jscript plain">( document, options ) {</code></div><div class="line number30 index29 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">checkSession( {</code></div><div class="line number31 index30 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">available: </code><code class="jscript keyword">function</code><code class="jscript plain">( userCtx ) {</code></div><div class="line number32 index31 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.albums.database.removeDoc( document, options );</code></div><div class="line number33 index32 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number34 index33 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">unavailable: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number35 index34 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">showDialog( options );</code></div><div class="line number36 index35 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number37 index36 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number38 index37 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number39 index38 alt2">&nbsp;</div><div class="line number40 index39 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number41 index40 alt2">&nbsp;</div><div class="line number42 index41 alt1"><code class="jscript plain">})(jQuery)</code></div></pre></div>
<p>So there we have our 4 public methods of <strong>$.albums</strong>. We have also added to public properties: <strong>dialog</strong> and <strong>database</strong>. These two will be the targets to the <strong>loginDialog</strong> template and a reference to our <strong>albums</strong> database, respectively. This is so we don’t rely so heavily on globally declared variables to do what we need in our nice little encapsulated <strong>plugin</strong>. In any event, if you have looked at the contents of these methods, they all call other functions that we haven’t declared yet. Lets start with <em>checkSession</em>() in <strong>saveDocument</strong> and <strong>deleteDocument</strong>. Add the following after the <strong>$.extend</strong> declaration and prior to close of <em>function</em>():</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">function</code> <code class="jscript plain">checkSession( options ) {</code></div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">options = options || {};</code></div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.couch.session( {</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( response ) {</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">context = response.userCtx;</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( context.name == </code><code class="jscript keyword">null</code> <code class="jscript plain">) {</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( options.unavailable ) options.unavailable();</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">else</code><code class="jscript plain">{</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( options.available ) options.available( context );</code></div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">( status, error, reason ) {</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( options.unavailable ) options.unavailable();</code></div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number17 index16 alt2"><code class="jscript plain">}</code></div></pre></div>
<p>The <em>checkSession</em>() does just that: request the current session established by our client through the <strong>$.couch</strong> plugin. If the <strong>userCtx</strong> comes back as null, there is no session and no logged in user on our end. We can try this out using <strong>curl</strong> on the command line:</p>
<div><pre><div class="line number1 index0 alt2"><code class="bash plain">&gt; curl -vX GET http:</code><code class="bash plain">//127</code><code class="bash plain">.0.0.1:5984</code><code class="bash plain">/_session</code></div><div class="line number2 index1 alt1"><code class="bash plain">&lt; {</code><code class="bash string">"ok"</code><code class="bash plain">:</code><code class="bash functions">true</code><code class="bash plain">,</code><code class="bash string">"userCtx"</code><code class="bash plain">:{</code><code class="bash string">"name"</code><code class="bash plain">:null,</code><code class="bash string">"roles"</code><code class="bash plain">:[]},</code><code class="bash string">"info"</code><code class="bash plain">:{</code><code class="bash string">"authentication_db"</code><code class="bash plain">:</code><code class="bash string">"_users"</code><code class="bash plain">,</code><code class="bash string">"authentication_handlers"</code><code class="bash plain">:[</code><code class="bash string">"oauth"</code><code class="bash plain">,</code><code class="bash string">"cookie"</code><code class="bash plain">,</code><code class="bash string">"default"</code><code class="bash plain">]}}</code></div></pre></div>
<p>Depending on the value of <strong>userCtx</strong>, <em>checkSession</em>() will invoke an <em>available</em>() or <em>unavailable</em>() <strong>callback</strong> method on the anonymous options argument. The available responder on <em>saveDocument</em>() and <em>deleteDocument</em>() is different – one saves, the other deletes – but if unavailable is entered, they both call <em>showDialog</em>(). Append the following script to <em>jquery.albums.app.js</em> after the <em>checkSession</em>() declaration:</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">function</code> <code class="jscript plain">showDialog( options ) {</code></div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.albums.dialog.loginDialog( {</code></div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">login: </code><code class="jscript keyword">function</code><code class="jscript plain">( evt, ui ) {</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">doLogIn( ui.name, ui.password, {</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( response ) {</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.albums.dialog.loginDialog( </code><code class="jscript string">"close"</code> <code class="jscript plain">);</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">( status, error, reason ) {</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">alert( </code><code class="jscript string">"Error: "</code> <code class="jscript plain">+ error + </code><code class="jscript string">", "</code> <code class="jscript plain">+ reason );</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">signup: </code><code class="jscript keyword">function</code><code class="jscript plain">( evt, ui ) {</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">doSignUp( ui.name, ui.password, {</code></div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( response ) {</code></div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.albums.dialog.loginDialog( </code><code class="jscript string">"close"</code> <code class="jscript plain">);</code></div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number18 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">( status, error, reason ) {</code></div><div class="line number19 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">alert( </code><code class="jscript string">"Error: "</code> <code class="jscript plain">+ error + </code><code class="jscript string">", "</code> <code class="jscript plain">+ reason );</code></div><div class="line number20 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number21 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number22 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number23 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number24 index23 alt1"><code class="jscript plain">}</code></div></pre></div>
<p>Hey! That’s using our <strong>widget</strong>! I don’t know why i seriously get excited when i see that… In any event, there it is in all its glory. The <strong>login template</strong> will be handed to <strong>$.albums</strong> and we’ll widget-ize it within the <em>showDialog</em>() invocation:</p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">$.albums.dialog.loginDialog( {</code></div><div class="line number2 index1 alt1"><code class="jscript plain">...</code></div><div class="line number3 index2 alt2"><code class="jscript plain">});</code></div></pre></div>
<p>If you remember back when we created the <strong>widget</strong>, it will dispatch two events when submitted based on state: <em>login</em> and <em>signup</em>. Here we have added the <strong>callbacks</strong> to those events which in turn call either <em>doLogIn</em>() or <em>doSignUp</em>(). We’ll get to that in a bit, but i wanted to point out the success responders in the anonymous <strong>callback</strong> objects we pass to those methods:</p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( response ) {</code></div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.albums.dialog.loginDialog( </code><code class="jscript string">"close"</code> <code class="jscript plain">);</code></div><div class="line number3 index2 alt2"><code class="jscript plain">}</code></div></pre></div>
<p>If we have passed being logged in/signed up, we close the <strong>loginDialog</strong>. We exposed the <em>close</em>() method in <em>jquery.albums.loginDialog.js</em>, but its important to note that you cannot call <em>close</em>() using dot-notation like a property. The reason is that we are not holding a reference to the <strong>loginDialog</strong>. Calling <strong>$(”#myElement”)</strong>.<em>loginDialog</em>() just decorates the target element on the <strong>DOM</strong>. We can still interface with <strong>$(”#myElement”)</strong> but those methods associated with the <strong>widget</strong> are not then accessible on the target element. So we call a public method through <em>loginDialog</em>().</p>
<p>OK. So <em>doLogin</em>(), <em>doLogout</em>() and <em>doSignUp</em>() are yet to be covered. For some reason i have this convention where if it is considered an internal response to a public invocation i prepend ‘<em>d</em>o’ to the public method name. Some people prefer “<em>_</em>“. To each his own. Just if you are wondering… Let’s tackle the login and logout first, as they are easy. Add the following script to <em>jquery.albums.app.js</em> somewhere after the <strong>$.extend</strong> declaration and prior to the end of the <em>function</em>() block:</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">user; </code><code class="jscript comments">/* _user &gt; document.name */</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript keyword">function</code> <code class="jscript plain">doLogIn( name, password, options ) {</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">options = options || {};</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">loginObj = {</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">name:name,</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">password:password,</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( response ) {</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">user = response.name;</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( options.success ) options.success( response );</code></div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">( status, error, reason ) {</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( options.error ) options.error( status, error, reason );</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.couch.login( loginObj );</code></div><div class="line number17 index16 alt2"><code class="jscript plain">}</code></div><div class="line number18 index17 alt1">&nbsp;</div><div class="line number19 index18 alt2"><code class="jscript keyword">function</code> <code class="jscript plain">doLogOut( options ) {</code></div><div class="line number20 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">options = options || {};</code></div><div class="line number21 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.couch.logout( {</code></div><div class="line number22 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( response ) {</code></div><div class="line number23 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">user = undefined;</code></div><div class="line number24 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( options.success ) options.success( response );</code></div><div class="line number25 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number26 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">( status, error, reason ) {</code></div><div class="line number27 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( options.error ) options.error( status, error, reason );</code></div><div class="line number28 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number29 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">})</code></div><div class="line number30 index29 alt1"><code class="jscript plain">}</code></div></pre></div>
<p>Again, we are just interfacing with the <strong>$.couch</strong> plugin to perform the <em>login</em>() and <em>logout</em>(). The only reason we go through <strong>$.albums</strong> instead of <strong>$.couch</strong> directly is to maintain the <strong>user</strong>, which we have privately declared. That user value is the one assigned to the user field of a document when a new <strong>album</strong> document will be created and saved through <strong>$.albums</strong> using <em>saveDocument</em>().</p>
<p>Alright, <strong>Sign Up</strong> is where the magic happens. Signing a user up through <strong>$.couch</strong> is a little trickier. In <a href="http://127.0.0.1:5984/_utils" target="_blank">Futon</a> it is all easy-peasy as we saw in the last article in this mini-series in a series. Now that we have taken our <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance out of <strong>Admin Party</strong> mode, the <strong>$.couch</strong>.<em>signUp</em>() method won’t work unless we are logged in as an admin. We don’t want to take the approach of <a href="http://127.0.0.1:5984/_utils" target="_blank">Futon</a> for the User Experience for our little application here. Our application shouldn’t act as an admin console to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database as well as its current function of just adding, updating and deleting <strong>album</strong> documents. </p>
<p>We going to secretly log in as an admin behind the scenes and set our new user up for gold and start adding documents. So, <strong>Sign Up</strong> is actually going to be a series of commands just to sign someone up, assign their proper <strong>user-role</strong> and create their session to allow them to start working with <strong>album</strong> documents. That sequence in readable terms is:</p>
<ol>
<li>Log In as Admin</li>
<li>Sign Up new User</li>
<li>Open new User document</li>
<li>Add “albums-user” User Role to new User</li>
<li>Log Out as Admin</li>
<li>Log In as new User</li>
</ol>
<p>Maybe the <em>jquery.couch</em> plugin has changed since the last revision i checked out, but that is the order of things to <em>signup</em> and <em>login</em> a new user as far as i understand. The signature for <strong>$.couch</strong>.<em>signUp</em>() method has no arguments for administration to do this more streamlined, so we are going to create a chain of commands to signup a new user a little more efficiently. Now, in actuality, i would turn to a server-side developer and ask pretty-please that they implement a proxy in whatever language to do this and not handle it all in <strong>JavaScript</strong> (especially since we are going to expose our admin credentials – <em>HIDE YOUR CHILDREN</em>!), but we’re having fun and not going to production with this, right? We’re taking some liberties to explore what we have…</p>
<p>Now, if you have not figured out yet in following these articles, i can get a little anal. But it isn’t about everything. I seem to get focused on one thing that really irks me. And one of those things is deeply nested anonymous <strong>callbacks</strong>. Sure i am guilty of doing it and when i do it i feel dirty, but i usually let it go if its not nesting too deep. This sequence of actions for <strong>Sign Up</strong>, however, i can foresee being really ugly if we just went with anonymous <strong>callback</strong> objects down the line. So what i did was create <strong>Queue</strong> and <strong>Command</strong> “classes” to keep my sanity. The following is the script for that. Open a new document in your favorite editor (we’ll get back to <em>jquery.albums.app.js</em> in a bit) and save the following script as <em>command_queue.js</em> in <em>/_attachments/script</em>:</p>
<p><em>/_attachments/script/command_queue.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">(</code><code class="jscript keyword">function</code><code class="jscript plain">(window) {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">Commandable() {}</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">Commandable.prototype.execute = </code><code class="jscript keyword">function</code><code class="jscript plain">( data ){};</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">Queue( ops ) {</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.options = ops || {};</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.list = [];</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.command;</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.addCommand = </code><code class="jscript keyword">function</code><code class="jscript plain">( command ) {</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">length = </code><code class="jscript keyword">this</code><code class="jscript plain">.list.length;</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( length &gt; 0 ) {</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.list[length-1].nextCommand = </code><code class="jscript keyword">this</code><code class="jscript plain">;</code></div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.list.push( command );</code></div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number18 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number19 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">q = Queue.prototype = </code><code class="jscript keyword">new</code> <code class="jscript plain">Commandable();</code></div><div class="line number20 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">q.options = undefined;</code></div><div class="line number21 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">q.list = undefined;</code></div><div class="line number22 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">q.command = undefined;</code></div><div class="line number23 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">q.constructor = Queue;</code></div><div class="line number24 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">q.execute = </code><code class="jscript keyword">function</code><code class="jscript plain">( data ) {</code></div><div class="line number25 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( </code><code class="jscript keyword">this</code><code class="jscript plain">.list.length &gt; 0 ) {</code></div><div class="line number26 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.command = </code><code class="jscript keyword">this</code><code class="jscript plain">.list.shift();</code></div><div class="line number27 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.command.execute( data );</code></div><div class="line number28 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number29 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">else</code> <code class="jscript plain">{</code></div><div class="line number30 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.command = undefined;</code></div><div class="line number31 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( </code><code class="jscript keyword">this</code><code class="jscript plain">.options.complete ) {</code></div><div class="line number32 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.options.complete();</code></div><div class="line number33 index32 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number34 index33 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number35 index34 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number36 index35 alt1">&nbsp;</div><div class="line number37 index36 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">Command( target, args, ops ) {</code></div><div class="line number38 index37 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.target = target;</code></div><div class="line number39 index38 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.args = args || [];</code></div><div class="line number40 index39 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.options = ops || {};</code></div><div class="line number41 index40 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.nextCommand = undefined;</code></div><div class="line number42 index41 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number43 index42 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">c = Command.prototype = </code><code class="jscript keyword">new</code> <code class="jscript plain">Commandable();</code></div><div class="line number44 index43 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">c.constructor = Command;</code></div><div class="line number45 index44 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">c.getCommandOptions = </code><code class="jscript keyword">function</code><code class="jscript plain">( options, nextCommand ) {</code></div><div class="line number46 index45 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">responder = {</code></div><div class="line number47 index46 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">ops: options,</code></div><div class="line number48 index47 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( response ) {</code></div><div class="line number49 index48 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( options &amp;&amp; options.success ) options.success( response );</code></div><div class="line number50 index49 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( nextCommand ) {</code></div><div class="line number51 index50 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">nextCommand.execute( response );</code></div><div class="line number52 index51 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number53 index52 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number54 index53 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">( status, error, reason ) {</code></div><div class="line number55 index54 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( options &amp;&amp; options.error ) options.error( status, error, reason );</code></div><div class="line number56 index55 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number57 index56 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number58 index57 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">$.extend( {}, </code><code class="jscript keyword">this</code><code class="jscript plain">.options, responder );</code></div><div class="line number59 index58 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number60 index59 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">c.execute = </code><code class="jscript keyword">function</code><code class="jscript plain">( data ) {</code></div><div class="line number61 index60 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.args.push( </code><code class="jscript keyword">this</code><code class="jscript plain">.getCommandOptions( </code><code class="jscript keyword">this</code><code class="jscript plain">.options, </code><code class="jscript keyword">this</code><code class="jscript plain">.nextCommand ) );</code></div><div class="line number62 index61 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">this</code><code class="jscript plain">.target.apply( </code><code class="jscript keyword">this</code><code class="jscript plain">, </code><code class="jscript keyword">this</code><code class="jscript plain">.args );</code></div><div class="line number63 index62 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number64 index63 alt1">&nbsp;</div><div class="line number65 index64 alt2"><code class="jscript plain">window.Queue = Queue;</code></div><div class="line number66 index65 alt1"><code class="jscript plain">window.Command = Command;</code></div><div class="line number67 index66 alt2">&nbsp;</div><div class="line number68 index67 alt1"><code class="jscript plain">}(window));</code></div></pre></div>
<p>I’m not going to say it’s sophisticated by any means, but this is a simple implementation to allow us to chain commands together. That is done by adding <strong>Commands</strong> to the <strong>Queue</strong> using <em>addCommand</em>(), which then appends a command using the <em>nextCommand</em> property of the previous (if available) <strong>Command</strong>. Both <strong>Queue</strong> and <strong>Command</strong> have a method called <em>execute</em>() (as extensions of <strong>Commandable</strong>). Executing a <strong>Queue</strong> will start the chain of commands; executing a <strong>Command</strong> will invoke whatever <strong>target</strong> method supplied in the constructor. If this needs more explanation, please leave a comment. We’ll see how we use this by implementing our <em>doSignUp</em>() method in <em>jquery.albums.app.js</em>. Open up <em>jquery.albums.app.js</em> in your favorite editor and add the following script somewhere after the <strong>$.execute</strong> declaration and before the end of the <em>function</em>() block:</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">function</code> <code class="jscript plain">doSignUp( name, password, options ) {</code></div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">options = options || {};</code></div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">queueOptions = {</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">complete: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( options.success ) options.success();</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">queue = </code><code class="jscript keyword">new</code> <code class="jscript plain">Queue( queueOptions );</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">queue.addCommand( </code><code class="jscript keyword">new</code> <code class="jscript plain">Command( $.albums.logIn, [</code><code class="jscript string">"toddanderson"</code><code class="jscript plain">, </code><code class="jscript string">"admin123"</code><code class="jscript plain">] ) );</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">queue.addCommand( </code><code class="jscript keyword">new</code> <code class="jscript plain">Command( $.couch.signup, [{name:name}, password] ) );</code></div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">queue.addCommand( </code><code class="jscript keyword">new</code> <code class="jscript plain">OpenUserDocCommand() );</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">queue.addCommand( </code><code class="jscript keyword">new</code> <code class="jscript plain">AssignRoleCommand() );</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">queue.addCommand( </code><code class="jscript keyword">new</code> <code class="jscript plain">Command( $.albums.logOut ) );</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">queue.addCommand( </code><code class="jscript keyword">new</code> <code class="jscript plain">Command( $.albums.logIn, [name, password], options ) );</code></div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">queue.execute();</code></div><div class="line number16 index15 alt1"><code class="jscript plain">}</code></div></pre></div>
<p>There we have our sequence of command described earlier. You can see how we pass the target method and arguments to the <strong>Command</strong> to be executed and the queue of commands is assembled using <strong>Queue</strong>:<em>addCommand</em>(). Again, our admin credentials are exposed and available to all – I do not recommend this practice in real life. Its just us here. So, there are two commands there in the middle that we haven’t discussed and aren’t declared in <em>command_queue.js</em>. They are specific to our <strong>albums</strong> application, so we will define them in <em>jquery.albums.app.js</em>. With the file still open, add the following script after (or before) the <em>doSignUp</em>() declaration:</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">function</code> <code class="jscript plain">OpenUserDocCommand( target, args, options ) {}</code></div><div class="line number2 index1 alt1"><code class="jscript plain">OpenUserDocCommand.prototype = </code><code class="jscript keyword">new</code> <code class="jscript plain">Command();</code></div><div class="line number3 index2 alt2"><code class="jscript plain">OpenUserDocCommand.prototype.execute = </code><code class="jscript keyword">function</code><code class="jscript plain">( data ) {</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">$userDB = $.couch.db(</code><code class="jscript string">"_users"</code><code class="jscript plain">);</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$userDB.openDoc( data.id, </code><code class="jscript keyword">this</code><code class="jscript plain">.getCommandOptions( </code><code class="jscript keyword">this</code><code class="jscript plain">.options, </code><code class="jscript keyword">this</code><code class="jscript plain">.nextCommand ) );</code></div><div class="line number6 index5 alt1"><code class="jscript plain">}</code></div><div class="line number7 index6 alt2">&nbsp;</div><div class="line number8 index7 alt1"><code class="jscript keyword">function</code> <code class="jscript plain">AssignRoleCommand( target, args, options ) {}</code></div><div class="line number9 index8 alt2"><code class="jscript plain">AssignRoleCommand.prototype = </code><code class="jscript keyword">new</code> <code class="jscript plain">Command();</code></div><div class="line number10 index9 alt1"><code class="jscript plain">AssignRoleCommand.prototype.execute = </code><code class="jscript keyword">function</code><code class="jscript plain">( data ) {</code></div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">data.roles = [</code><code class="jscript string">"albums-user"</code><code class="jscript plain">];</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">$userDB = $.couch.db(</code><code class="jscript string">"_users"</code><code class="jscript plain">);</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$userDB.saveDoc( data, </code><code class="jscript keyword">this</code><code class="jscript plain">.getCommandOptions( </code><code class="jscript keyword">this</code><code class="jscript plain">.options, </code><code class="jscript keyword">this</code><code class="jscript plain">.nextCommand ) );</code></div><div class="line number14 index13 alt1"><code class="jscript plain">}</code></div></pre></div>
<p>Nothing too crazy going on in <strong>OpenUserDocCommand</strong> or <strong>AssignRoleCommand</strong>, just needed to do some work with the <strong>_users</strong> database of our <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance as an admin.</p>
<p>Guess what? That’s it! We’re done with <em>jquery.albums.app.js</em>. Whew! If you have stuck around, i am quite humbled. Seriously. A lot of code and rambling on. I don’t know if i would have made it. Anyway, here is <em>jquery.albums.app.js</em> in full:</p>
<p><em>/_attachments/script/jquery.albums.app.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">(</code><code class="jscript keyword">function</code><code class="jscript plain">($) {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">$.albums = $.albums || {};</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">$.extend( $.albums, {</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">dialog: undefined,</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">database: undefined,</code></div><div class="line number8 index7 alt1">&nbsp;</div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">logIn: </code><code class="jscript keyword">function</code><code class="jscript plain">( name, password, options ) {</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">doLogIn( name, password, options );</code></div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number12 index11 alt1">&nbsp;</div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">logOut: </code><code class="jscript keyword">function</code><code class="jscript plain">( options ) {</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">doLogOut( options );</code></div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number16 index15 alt1">&nbsp;</div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">saveDocument: </code><code class="jscript keyword">function</code><code class="jscript plain">( document, options ) {</code></div><div class="line number18 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">checkSession( {</code></div><div class="line number19 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">available: </code><code class="jscript keyword">function</code><code class="jscript plain">( userCtx ) {</code></div><div class="line number20 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.user = user;</code></div><div class="line number21 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.albums.database.saveDoc( document, options );</code></div><div class="line number22 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number23 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">unavailable: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number24 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">showDialog( options );</code></div><div class="line number25 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number26 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number27 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number28 index27 alt1">&nbsp;</div><div class="line number29 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">deleteDocument: </code><code class="jscript keyword">function</code><code class="jscript plain">( document, options ) {</code></div><div class="line number30 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">checkSession( {</code></div><div class="line number31 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">available: </code><code class="jscript keyword">function</code><code class="jscript plain">( userCtx ) {</code></div><div class="line number32 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.albums.database.removeDoc( document, options );</code></div><div class="line number33 index32 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number34 index33 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">unavailable: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number35 index34 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">showDialog( options );</code></div><div class="line number36 index35 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number37 index36 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number38 index37 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number39 index38 alt2">&nbsp;</div><div class="line number40 index39 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number41 index40 alt2">&nbsp;</div><div class="line number42 index41 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">user; </code><code class="jscript comments">/* _user &gt; document.name */</code></div><div class="line number43 index42 alt2">&nbsp;</div><div class="line number44 index43 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">OpenUserDocCommand( target, args, options ) {}</code></div><div class="line number45 index44 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">OpenUserDocCommand.prototype = </code><code class="jscript keyword">new</code> <code class="jscript plain">Command();</code></div><div class="line number46 index45 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">OpenUserDocCommand.prototype.execute = </code><code class="jscript keyword">function</code><code class="jscript plain">( data ) {</code></div><div class="line number47 index46 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">$userDB = $.couch.db(</code><code class="jscript string">"_users"</code><code class="jscript plain">);</code></div><div class="line number48 index47 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$userDB.openDoc( data.id, </code><code class="jscript keyword">this</code><code class="jscript plain">.getCommandOptions( </code><code class="jscript keyword">this</code><code class="jscript plain">.options, </code><code class="jscript keyword">this</code><code class="jscript plain">.nextCommand ) );</code></div><div class="line number49 index48 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number50 index49 alt1">&nbsp;</div><div class="line number51 index50 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">AssignRoleCommand( target, args, options ) {}</code></div><div class="line number52 index51 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">AssignRoleCommand.prototype = </code><code class="jscript keyword">new</code> <code class="jscript plain">Command();</code></div><div class="line number53 index52 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">AssignRoleCommand.prototype.execute = </code><code class="jscript keyword">function</code><code class="jscript plain">( data ) {</code></div><div class="line number54 index53 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">data.roles = [</code><code class="jscript string">"albums-user"</code><code class="jscript plain">];</code></div><div class="line number55 index54 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">$userDB = $.couch.db(</code><code class="jscript string">"_users"</code><code class="jscript plain">);</code></div><div class="line number56 index55 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$userDB.saveDoc( data, </code><code class="jscript keyword">this</code><code class="jscript plain">.getCommandOptions( </code><code class="jscript keyword">this</code><code class="jscript plain">.options, </code><code class="jscript keyword">this</code><code class="jscript plain">.nextCommand ) );</code></div><div class="line number57 index56 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number58 index57 alt1">&nbsp;</div><div class="line number59 index58 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">checkSession( options ) {</code></div><div class="line number60 index59 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">options = options || {};</code></div><div class="line number61 index60 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.couch.session( {</code></div><div class="line number62 index61 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( response ) {</code></div><div class="line number63 index62 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">context = response.userCtx;</code></div><div class="line number64 index63 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( context.name == </code><code class="jscript keyword">null</code> <code class="jscript plain">) {</code></div><div class="line number65 index64 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( options.unavailable ) options.unavailable();</code></div><div class="line number66 index65 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number67 index66 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">else</code><code class="jscript plain">{</code></div><div class="line number68 index67 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( options.available ) options.available( context );</code></div><div class="line number69 index68 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number70 index69 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number71 index70 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">( status, error, reason ) {</code></div><div class="line number72 index71 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( options.unavailable ) options.unavailable();</code></div><div class="line number73 index72 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number74 index73 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number75 index74 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number76 index75 alt1">&nbsp;</div><div class="line number77 index76 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">doLogIn( name, password, options ) {</code></div><div class="line number78 index77 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">options = options || {};</code></div><div class="line number79 index78 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">loginObj = {</code></div><div class="line number80 index79 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">name:name,</code></div><div class="line number81 index80 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">password:password,</code></div><div class="line number82 index81 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( response ) {</code></div><div class="line number83 index82 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">user = response.name;</code></div><div class="line number84 index83 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( options.success ) options.success( response );</code></div><div class="line number85 index84 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number86 index85 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">( status, error, reason ) {</code></div><div class="line number87 index86 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( options.error ) options.error( status, error, reason );</code></div><div class="line number88 index87 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number89 index88 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number90 index89 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.couch.login( loginObj );</code></div><div class="line number91 index90 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number92 index91 alt1">&nbsp;</div><div class="line number93 index92 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">doLogOut( options ) {</code></div><div class="line number94 index93 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">options = options || {};</code></div><div class="line number95 index94 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.couch.logout( {</code></div><div class="line number96 index95 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( response ) {</code></div><div class="line number97 index96 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">user = undefined;</code></div><div class="line number98 index97 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( options.success ) options.success( response );</code></div><div class="line number99 index98 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number100 index99 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">( status, error, reason ) {</code></div><div class="line number101 index100 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( options.error ) options.error( status, error, reason );</code></div><div class="line number102 index101 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number103 index102 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">})</code></div><div class="line number104 index103 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number105 index104 alt2">&nbsp;</div><div class="line number106 index105 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">doSignUp( name, password, options ) {</code></div><div class="line number107 index106 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">options = options || {};</code></div><div class="line number108 index107 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">queueOptions = {</code></div><div class="line number109 index108 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">complete: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number110 index109 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">if</code><code class="jscript plain">( options.success ) options.success();</code></div><div class="line number111 index110 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number112 index111 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number113 index112 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">queue = </code><code class="jscript keyword">new</code> <code class="jscript plain">Queue( queueOptions );</code></div><div class="line number114 index113 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">queue.addCommand( </code><code class="jscript keyword">new</code> <code class="jscript plain">Command( $.albums.logIn, [</code><code class="jscript string">"toddanderson"</code><code class="jscript plain">, </code><code class="jscript string">"admin123"</code><code class="jscript plain">] ) );</code></div><div class="line number115 index114 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">queue.addCommand( </code><code class="jscript keyword">new</code> <code class="jscript plain">Command( $.couch.signup, [{name:name}, password] ) );</code></div><div class="line number116 index115 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">queue.addCommand( </code><code class="jscript keyword">new</code> <code class="jscript plain">OpenUserDocCommand() );</code></div><div class="line number117 index116 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">queue.addCommand( </code><code class="jscript keyword">new</code> <code class="jscript plain">AssignRoleCommand() );</code></div><div class="line number118 index117 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">queue.addCommand( </code><code class="jscript keyword">new</code> <code class="jscript plain">Command( $.albums.logOut ) );</code></div><div class="line number119 index118 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">queue.addCommand( </code><code class="jscript keyword">new</code> <code class="jscript plain">Command( $.albums.logIn, [name, password], options ) );</code></div><div class="line number120 index119 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">queue.execute();</code></div><div class="line number121 index120 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number122 index121 alt1">&nbsp;</div><div class="line number123 index122 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">showDialog( options ) {</code></div><div class="line number124 index123 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.albums.dialog.loginDialog( {</code></div><div class="line number125 index124 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">login: </code><code class="jscript keyword">function</code><code class="jscript plain">( evt, ui ) {</code></div><div class="line number126 index125 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">doLogIn( ui.name, ui.password, {</code></div><div class="line number127 index126 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( response ) {</code></div><div class="line number128 index127 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.albums.dialog.loginDialog( </code><code class="jscript string">"close"</code> <code class="jscript plain">);</code></div><div class="line number129 index128 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number130 index129 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">( status, error, reason ) {</code></div><div class="line number131 index130 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">alert( </code><code class="jscript string">"Error: "</code> <code class="jscript plain">+ error + </code><code class="jscript string">", "</code> <code class="jscript plain">+ reason );</code></div><div class="line number132 index131 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number133 index132 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number134 index133 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number135 index134 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">signup: </code><code class="jscript keyword">function</code><code class="jscript plain">( evt, ui ) {</code></div><div class="line number136 index135 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">doSignUp( ui.name, ui.password, {</code></div><div class="line number137 index136 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( response ) {</code></div><div class="line number138 index137 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.albums.dialog.loginDialog( </code><code class="jscript string">"close"</code> <code class="jscript plain">);</code></div><div class="line number139 index138 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number140 index139 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">( status, error, reason ) {</code></div><div class="line number141 index140 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">alert( </code><code class="jscript string">"Error: "</code> <code class="jscript plain">+ error + </code><code class="jscript string">", "</code> <code class="jscript plain">+ reason );</code></div><div class="line number142 index141 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number143 index142 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number144 index143 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number145 index144 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number146 index145 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number147 index146 alt2">&nbsp;</div><div class="line number148 index147 alt1"><code class="jscript plain">})(jQuery)</code></div></pre></div>
<p>Now before you run off, kiss your significant other and tell him/her that you will soon be billionaires, we have a little more work to do to get this up and running in our <strong>Albums</strong>  application.</p>
<h2>Loader and Index</h2>
<p>We kind of went off the deep-end there and dove right into code that code stand on its own outside of our current design of the <strong>Albums</strong> application. That’s good, but now we gotta reel it back in and wire it up. To start, lets add our new scripts in the <em>loader</em>. Open up <em>/vendor/couchapp/_attachments/loader.js</em> and save the following modifications:</p>
<p><em>/vendor/couchapp/_attachments/loader.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">function</code> <code class="jscript plain">couchapp_load(scripts) {</code></div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">for</code> <code class="jscript plain">(</code><code class="jscript keyword">var</code> <code class="jscript plain">i=0; i &lt; scripts.length; i++) {</code></div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.write(</code><code class="jscript string">'&lt;script src="'</code><code class="jscript plain">+scripts[i]+</code><code class="jscript string">'"&gt;&lt;\/script&gt;'</code><code class="jscript plain">)</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number5 index4 alt2"><code class="jscript plain">};</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="jscript plain">couchapp_load([</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"/_utils/script/sha1.js"</code><code class="jscript plain">,</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"/_utils/script/json2.js"</code><code class="jscript plain">,</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"vendor/couchapp/jquery-1.4.4.js"</code><code class="jscript plain">,</code></div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"/_utils/script/jquery.couch.js"</code><code class="jscript plain">,</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"vendor/couchapp/jquery.couch.app.js"</code><code class="jscript plain">,</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"vendor/couchapp/jquery.couch.app.util.js"</code><code class="jscript plain">,</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"vendor/couchapp/jquery.mustache.js"</code><code class="jscript plain">,</code></div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"vendor/couchapp/jquery.evently.js"</code><code class="jscript plain">,</code></div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"vendor/couchapp/jquery.mobile-1.0a2.js"</code><code class="jscript plain">,</code></div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"vendor/couchapp/jquery.tmpl.js"</code><code class="jscript plain">,</code></div><div class="line number18 index17 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"script/command_queue.js"</code><code class="jscript plain">,</code></div><div class="line number19 index18 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"script/jquery.albums.app.js"</code><code class="jscript plain">,</code></div><div class="line number20 index19 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript string">"script/jquery.albums.loginDialog.js"</code></div><div class="line number21 index20 alt2"><code class="jscript plain">]);</code></div></pre></div>
<p>We’ve just added the last three files we have been working on: the <em>command_queue</em> script and our <strong>$.albums</strong> plugin and <strong>loginDialog</strong> widget. Now we’re going to make some modifications to the inline script on our <em>index.html</em> document. In a <a href="http://custardbelly.com/blog/?p=332" target="_blank">previous article</a> we hooked up the saving of a new album document to the internal <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> <strong>addAlbum</strong> page, and were using the <em>jquery.couch</em> plugin directly to save the document. Now we are just going to go through our <strong>$.albums</strong> plugin to perform that action which will open the <strong>loginDialog</strong> if a session is currently not available on our client. Open the <em>/_attachments/index.html</em> file in your favorite editor and save the following modifications in the <em>handleDocumentReady</em>() function:</p>
<p><em>/attachments/index.html</em></p>
<div><pre><div class="line number79 index0 alt2"><code class="jscript keyword">function</code> <code class="jscript plain">handleDocumentReady()</code></div><div class="line number80 index1 alt1"><code class="jscript plain">{</code></div><div class="line number81 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#home"</code><code class="jscript plain">).bind( </code><code class="jscript string">"pagebeforeshow"</code><code class="jscript plain">, refreshAlbums );</code></div><div class="line number82 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">refreshAlbums();</code></div><div class="line number83 index4 alt2">&nbsp;</div><div class="line number84 index5 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Set database reference and dialog template on albums.</code></div><div class="line number85 index6 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.extend( $.albums, {</code></div><div class="line number86 index7 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">database: $db,</code></div><div class="line number87 index8 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">dialog:&nbsp; $(</code><code class="jscript string">"#loginSignupDialog"</code><code class="jscript plain">).tmpl()</code></div><div class="line number88 index9 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number89 index10 alt2">&nbsp;</div><div class="line number90 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#addSubmitButton"</code><code class="jscript plain">).live( </code><code class="jscript string">"click"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">( event ) {</code></div><div class="line number91 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">event.preventDefault();</code></div><div class="line number92 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">document = {};</code></div><div class="line number93 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.artist = $(</code><code class="jscript string">"input#addArtistField"</code><code class="jscript plain">).val();</code></div><div class="line number94 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.title = $(</code><code class="jscript string">"input#addTitleField"</code><code class="jscript plain">).val();</code></div><div class="line number95 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.description = $(</code><code class="jscript string">"textarea#addDescriptionField"</code><code class="jscript plain">).val();</code></div><div class="line number96 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.creation_date = ( </code><code class="jscript keyword">new</code> <code class="jscript plain">Date() ).getTime();</code></div><div class="line number97 index18 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.albums.saveDocument( document, {</code></div><div class="line number98 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number99 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.mobile.changePage( </code><code class="jscript string">"#home"</code><code class="jscript plain">, </code><code class="jscript string">"slidedown"</code><code class="jscript plain">, </code><code class="jscript keyword">true</code><code class="jscript plain">, </code><code class="jscript keyword">true</code> <code class="jscript plain">);</code></div><div class="line number100 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number101 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">( status, error, reason ) {</code></div><div class="line number102 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">alert( </code><code class="jscript string">"Cannot save new document.\n"</code> <code class="jscript plain">+ status + </code><code class="jscript string">", "</code> <code class="jscript plain">+ reason + </code><code class="jscript string">", "</code> <code class="jscript plain">+ error );</code></div><div class="line number103 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number104 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number105 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">false</code><code class="jscript plain">;</code></div><div class="line number106 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number107 index28 alt2">&nbsp;</div><div class="line number108 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#addAlbum"</code><code class="jscript plain">).bind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number109 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"input#addArtistField"</code><code class="jscript plain">).val( </code><code class="jscript string">""</code> <code class="jscript plain">);</code></div><div class="line number110 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"input#addTitleField"</code><code class="jscript plain">).val( </code><code class="jscript string">""</code> <code class="jscript plain">);</code></div><div class="line number111 index32 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"textarea#addDescriptionField"</code><code class="jscript plain">).val( </code><code class="jscript string">""</code> <code class="jscript plain">);</code></div><div class="line number112 index33 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number113 index34 alt2"><code class="jscript plain">}</code></div></pre></div>
<p>Not that much to change. First we assign the default properties for the dialog <strong>template</strong> and database reference for our <strong>$.albums</strong> plugin and then we replace the call to save the document using <em>jquery.couch</em> to that of our <strong>$.albums</strong> plugin. Ta-da! Now we can add new documents as a logged in user.</p>
<p>There is, however, two more places that we need to interact with our <strong>$.albums</strong> plugin: the <strong>edit</strong> page and the <strong>delete</strong> page. Without modifying those and with the new authorization and validation we have introduced, we’d only be able to create and read documents… </p>
<p><em>Oh nos! There are tons of albums that i entered in late at night in a different state of mind! I am second guessing my decision on wanting <strong>Hall &amp; Oates</strong>‘</em> War Babies! </p>
<p>These are the type of exclamations i am assuming are going through your head… because i would never…</p>
<h2>album-delete and album-edit</h2>
<p>If you go way back in this article series and have been following along, you may remember that we create quasi-view controllers for our <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> <strong>template</strong> pages and included the as <strong>partials</strong> in the <strong>show function</strong>. There are two that we need to modify with our recent changes to using the <strong>$.albums</strong> plugin to verify session: <em>/_attachments/script/album-delete-dialog.js</em> and <em>/_attachments/script/album-edit-page.js</em>. They will be small changes, but once deployed will give our application a little more security on who can perform modifications on <strong>album</strong> documents.</p>
<p>Open up <em>/_attachments/script/album-delete-dialog.js</em> in your favorite editor and save the following change to the <em>handleDelete</em>() function:</p>
<p><em>/_attachments/script/album-delete-dialog.js</em></p>
<div><pre><div class="line number32 index0 alt1"><code class="jscript keyword">function</code> <code class="jscript plain">handleDelete( event )</code></div><div class="line number33 index1 alt2"><code class="jscript plain">{</code></div><div class="line number34 index2 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">event.preventDefault();</code></div><div class="line number35 index3 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#dialogContent"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number36 index4 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// First open doc based on ID in order to get full document.</code></div><div class="line number37 index5 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$db.openDoc( docId, {</code></div><div class="line number38 index6 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( document ) {</code></div><div class="line number39 index7 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Then use the opened doc as reference to remove.</code></div><div class="line number40 index8 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.albums.deleteDocument( document, {</code></div><div class="line number41 index9 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number42 index10 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.mobile.changePage( </code><code class="jscript string">"#home"</code><code class="jscript plain">, </code><code class="jscript string">"slide"</code><code class="jscript plain">, </code><code class="jscript keyword">true</code><code class="jscript plain">, </code><code class="jscript keyword">true</code> <code class="jscript plain">);</code></div><div class="line number43 index11 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number44 index12 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number45 index13 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">alert( </code><code class="jscript string">"Could not remove document with id: "</code> <code class="jscript plain">+ docId );</code></div><div class="line number46 index14 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number47 index15 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number48 index16 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number49 index17 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number50 index18 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">alert( </code><code class="jscript string">"Could not find document with id: "</code> <code class="jscript plain">+ docId );</code></div><div class="line number51 index19 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number52 index20 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number53 index21 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">false</code><code class="jscript plain">;</code></div><div class="line number54 index22 alt1"><code class="jscript plain">}</code></div></pre></div>
<p>Open up <em>/_attachments/script/album-edit-page.js</em> in your favorite editor and save the following change to <em>saveDocument</em>():</p>
<p><em>/_attachments/script/album-edit-page.js</em></p>
<div><pre><div class="line number42 index0 alt1"><code class="jscript keyword">function</code> <code class="jscript plain">saveDocument( document )</code></div><div class="line number43 index1 alt2"><code class="jscript plain">{</code></div><div class="line number44 index2 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.albums.saveDocument( document, {</code></div><div class="line number45 index3 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( response )&nbsp; {</code></div><div class="line number46 index4 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">updateEditableAlbum( document );</code></div><div class="line number47 index5 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">navigateToAlbumPage( document._id );</code></div><div class="line number48 index6 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number49 index7 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">( status, error, reason ) {</code></div><div class="line number50 index8 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">alert( </code><code class="jscript string">"Cannot save document: "</code> <code class="jscript plain">+ document._id + </code><code class="jscript string">"\n"</code> <code class="jscript plain">+ reason );</code></div><div class="line number51 index9 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number52 index10 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number53 index11 alt2"><code class="jscript plain">}</code></div></pre></div>
<p>That’s all! basically moved away from actions through the reference to our <strong>albums</strong> database to using the <strong>$.albums</strong> plugin. Finally. Now let’s push all this to our <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance so we can play around with it.</p>
<h2>Deployment</h2>
<p>If you remember from the last article when we introduced authorization, we need to pass our credentials when we push our couchapp to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance:</p>
<div><pre><div class="line number1 index0 alt2"><code class="bash plain">couchapp push albums http:</code><code class="bash plain">//toddanderson</code><code class="bash plain">:admin123@127.0.0.1:5984</code><code class="bash plain">/albums</code></div></pre></div>
<p>You’ll will have to replace to username and password, but once we have pushed we can now checkout our application at <a href="http://127.0.0.1:5984/albums/_design/albums/index.html" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html</a>. If you visit your application and try to either add, edit or delete a document and have not previously logged in, you will see something on the following:</p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_7_2_2.png" alt="Log In"><br>
<em>[Log In]</em></p>
<p><img src="http://www.custardbelly.com/blog/images/couchapp_7_2_1.png" alt="Log In"><br>
<em>[Sign Up]</em></p>
<h2>Conclusion</h2>
<p>We have come a long way! We now have authorization and user validation in our <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> <strong>albums</strong> application ensuring that a user must be logged in to create a new <strong>album</strong> document and that the owner of a document is the only one that can make modifications or delete the document from the database. Fun stuff.</p>
<p>I think this is going to be the last article of this series. Of course if this application were to go live, it would need a lot more work. For instance, the ability to log in and log out persisted on every page and information about who is logged in, etc. – but i will leave that up to you if you want to keep going. Hope you had fun and gleaned some useful information that i hope is not misleading.</p>
<p>Thanks again if you have actually took the time to follow along in this series. I am truly humbled if you sat through it all.</p>
<p>Cheers!</p>
<p><em>[Note] This post was written against the following software versions:</em><br>
<strong>CouchDB </strong>– 1.0.1<br>
<strong>CouchApp</strong> – 0.7.2<br>
<strong>jQuery</strong> – 1.4.4<br>
<strong>jQuery Mobile</strong> – 1.0a2<br>
<strong>jQuery Templates Plugin</strong> 1.0.0pre<br>
<em>If you have found this post and any piece has moved forward, hopefully the examples are still viable/useful. I will not be updating the examples in this post in parellel with updates to any of the previously mentioned software, unless explicitly noted.</em></p>
<p><strong>Articles in this series:</strong></p>
<ol>
<li><a href="http://custardbelly.com/blog/?p=244" target="_blank">Getting Started</a></li>
<li><a href="http://custardbelly.com/blog/?p=278" target="_blank">Displaying a page detail of a single album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=297" target="_blank">Templates and Mustache</a></li>
<li><a href="http://custardbelly.com/blog/?p=318" target="_blank">Displaying an editable page of an album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=332" target="_blank">Creating and Adding an album document.</a></li>
<li><a href="http://custardbelly.com/blog/?p=344" target="_blank">Deleting an album document</a></li>
<li><a href="http://custardbelly.com/blog/?p=360" target="_blank">Authorization and Validation – Part 1</a></li>
<li><a href="http://custardbelly.com/blog/?p=394">Authorization and Validation – Part 2</a></li>
</ol>
<p><a href="http://custardbelly.com/downloads/couchapp/jqm_couchdb_albums.zip">Full source for albums couchapp available here</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/couchdb/" title="View all posts in CouchDB" rel="category tag">CouchDB</a>,  <a href="http://custardbelly.com/blog/category/jquery/" title="View all posts in jquery" rel="category tag">jquery</a>,  <a href="http://custardbelly.com/blog/category/jquery-mobile/" title="View all posts in jquery-mobile" rel="category tag">jquery-mobile</a>.</p>
	
	

	<!--/by-line-->

	<div id="post-comments-394-target"></div>
	<div class="clear"></div>
	
	