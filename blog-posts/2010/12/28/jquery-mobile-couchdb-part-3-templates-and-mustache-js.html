
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2010/12/28/jquery-mobile-couchdb-part-3-templates-and-mustache-js/" title="Permanent link to jQuery Mobile + CouchDB: Part 3 – Templates and Mustache.js" rel="bookmark" rev="post-297">jQuery Mobile + CouchDB: Part 3 – Templates and Mustache.js</a></h1>
	
	<div class="entry-content full-content">
		<p>In the <a href="http://custardbelly.com/blog/?p=278" target="_blank">previous post</a>, I covered displaying a document from a <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database  in the context of a <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page. A difference between <strong>local</strong> vs <strong>external</strong> <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> pages was discussed, and it was concluded that external pages was beneficial for the client-side application. In finding this happy medium, I also talked about <em>show functions</em> in <strong>CouchDB</strong> and how they serve up documents upon request.</p>
<p>In this article, I am going to cover another aspect of delivering <strong>HTML</strong> content from <strong>CouchDB</strong> – <em>templates</em>. While doing so, I will modify the current document views to provide a cleaner solution (imo) for delivering and rendering document-based <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> pages. Hopefully, this will set the basis for creating additional views for the application…</p>
<h2>Templates</h2>
<p>In the previous post, I covered using <strong>show function</strong>s to deliver <strong>HTML</strong> content as a <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page from a <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance. From the previous <strong>show function</strong> example for the <strong>Albums</strong> application, I basically constructed a string that would be interpreted as <strong>HTML</strong> mark-up using the values from the document. While this is a perfectly valid solution, its probably not the best if we want to reuse parts of that <strong>HTML</strong> or if the mark-up gets a little too unwieldy for string manipulation based on the request. To provide a little sanity as we start making more page documents for the application, we going to start using <strong>templates</strong> to stub out the mark-up of an <strong>HTML</strong> document and fill content dynamically from the <strong>show function</strong>s.</p>
<h3><a href="https://github.com/janl/mustache.js" target="_blank">mustache.js</a></h3>
<p>If you have been following along in the tutorials, you may remember that in the <em>loader.js</em> script there were a few <strong>JavaScript</strong> files being loaded that were not being referenced within the current application. One of those was <em>mustache.js</em>. I didn’t talk about it at the time and I said we could probably get rid of it for now, but might as well leave it in… hopefully you left it in. If not, you’re screwed. Kidding <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley"> </p>
<p>I don’t want to go into a <a href="https://github.com/janl/mustache.js" target="_blank">mustache</a> explanation as there are already some great articles out there – especially this one from <a href="http://blog.couchone.com/post/622014913/mustache-js" target="_blank">CouchOne</a> – but I will say that <em>mustache.js</em> is a templating engine for rendering any type of content. For our purposes, we are going to use the <em>to_html</em>() function of <strong>Mustache</strong> to marry our dynamic album document values with an <strong>HTML</strong> template and deliver pages from our respective <strong>show function</strong>s from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database.</p>
<h3>Album Page Template</h3>
<p>Our previous version of <em>album.js</em> from the <em>/show</em> directory of our <strong>Albums</strong> <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> looked like the following:</p>
<p><em>/show/album.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">function</code><code class="jscript plain">(doc, req) {</code></div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">html = </code><code class="jscript string">"&lt;div data-role=\"page\" id=\"albumview\"&gt;"</code> <code class="jscript plain">+</code></div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;div data-role=\"header\" id=\"albumheader\"&gt;"</code> <code class="jscript plain">+</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;h2 class=\"albumtitle\"&gt;"</code> <code class="jscript plain">+ doc.title + </code><code class="jscript string">"&lt;\/h2&gt;"</code> <code class="jscript plain">+</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;\/div&gt;"</code> <code class="jscript plain">+</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;div data-role=\"content\" id=\"albumcontent\"&gt;"</code> <code class="jscript plain">+</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;h2 class=\"artist\"&gt;"</code> <code class="jscript plain">+ doc.artist + </code><code class="jscript string">"&lt;\/h2&gt;"</code> <code class="jscript plain">+</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;p class=\"title\"&gt;"</code> <code class="jscript plain">+ doc.title + </code><code class="jscript string">"&lt;\/p&gt;"</code> <code class="jscript plain">+</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;p class=\"description\"&gt;"</code> <code class="jscript plain">+ doc.description + </code><code class="jscript string">"&lt;\/p&gt;"</code> <code class="jscript plain">+</code></div><div class="line number10 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;\/div&gt;"</code> <code class="jscript plain">+</code></div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;div data-role=\"footer\" \/&gt;"</code> <code class="jscript plain">+</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;\/div&gt;"</code><code class="jscript plain">;</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">html;</code></div><div class="line number14 index13 alt1"><code class="jscript plain">}</code></div></pre></div>
<p>That served our purpose at the time, but such string manipulation for each page we are going to serve up makes my eyes bleed <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley">  As such, we will use <em>mustache.js</em> to populate document values in an <strong>HTML</strong> template. First order of business: Remove that string construct from <em>/shows/album.js</em> and put it into a <strong>template</strong>, replacing the values with <strong>{{mustache}}</strong> directives.</p>
<p>Create a new directory called <em>templates</em> in your <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> directory for the <strong>Albums</strong> application (for me that is at <em>/Documents/workspace/custardbelly/couchdb/albums</em>). Create a new <strong>HTML</strong> document in your favorite text editor and save the following as <em>album.html</em> in the <em>/templates</em> directory:</p>
<p><em>/templates/album.html</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"page"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albumview"</code> <code class="xml color1">data-position</code><code class="xml plain">=</code><code class="xml string">"inline"</code> <code class="xml color1">data-back</code><code class="xml plain">=</code><code class="xml string">"true"</code><code class="xml plain">&gt;</code></div><div class="line number2 index1 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"header"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albumheader"</code><code class="xml plain">&gt;</code></div><div class="line number3 index2 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">h1</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"albumtitle"</code><code class="xml plain">&gt;{{title}}&lt;/</code><code class="xml keyword">h1</code><code class="xml plain">&gt;</code></div><div class="line number4 index3 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">a</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#home"</code> <code class="xml color1">data-icon</code><code class="xml plain">=</code><code class="xml string">"grid"</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-btn-right"</code><code class="xml plain">&gt;Home&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;</code></div><div class="line number5 index4 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number6 index5 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"content"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albumcontent"</code> <code class="xml color1">data-identity</code><code class="xml plain">=</code><code class="xml string">"{{document}}"</code><code class="xml plain">&gt;</code></div><div class="line number7 index6 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">h2</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"artist"</code><code class="xml plain">&gt;{{artist}}&lt;/</code><code class="xml keyword">h2</code><code class="xml plain">&gt;</code></div><div class="line number8 index7 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">p</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"title"</code><code class="xml plain">&gt;{{title}}&lt;/</code><code class="xml keyword">p</code><code class="xml plain">&gt;</code></div><div class="line number9 index8 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">p</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"description"</code><code class="xml plain">&gt;{{description}}&lt;/</code><code class="xml keyword">p</code><code class="xml plain">&gt;</code></div><div class="line number10 index9 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number11 index10 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"footer"</code> <code class="xml plain">/&gt;</code></div><div class="line number12 index11 alt1"><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div></pre></div>
<p>Essentially, we have just moved our mark-up from one document to another; the difference being that we are now employing <strong>{{mustache}}</strong>s as placeholders for dynamic content values. You may notice that the names used in the mustaches are just the property names of the document – similar to the previous <em>albums.js</em> example. In fact there are the property names of the object that will be passed to the <a href="https://github.com/janl/mustache.js" target="_blank">Mustache</a> engine to generate our page.</p>
<p>Some added <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> element content has been added to the new <em>album</em> page document, as well. We added the <strong>data-position</strong> and <strong>data-back</strong> attributes to the <em>page</em> <strong>div</strong> in order to preserve the back button and add a <strong>Home</strong> page button to the header. This will allow us to always be able to get back to the <em>index.html</em> <strong>Home</strong> page from an <em>album page</em>.</p>
<div><pre><div class="line number1 index0 alt2"><code class="xml plain">&lt;</code><code class="xml keyword">a</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#home"</code> <code class="xml color1">data-icon</code><code class="xml plain">=</code><code class="xml string">"grid"</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-btn-right"</code><code class="xml plain">&gt;Home&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;</code></div></pre></div>
<p>We will need to modify the <em>page</em> <strong>div</strong> in <em>index.html</em> to have an <strong>id</strong> value of “home”, but setting that hash as the <strong>href</strong> for the <strong>Home</strong> button in the header of our <em>album page</em> will, essentially, enable that link to direct the user back to the page content of the parenting document -<em>index.html</em>.</p>
<p>In <em>album.html</em> we have also declared a <strong>data-identity</strong> for the content <strong>div</strong> and provided a <em>{{document}}</em> value. This will be the <em>document._id</em> from the <em>album.js</em> <strong>show function</strong> and we will later see how it will be used. Back to our <em>album.js</em> document…</p>
<h3>Album Page Show Function</h3>
<p>Open up the <em>/show/album.js</em> document in your favorite text editor and make replace the current content with the following:</p>
<p><em>/show/album.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">function</code><code class="jscript plain">(doc, req) {</code></div><div class="line number2 index1 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">Mustache = require(</code><code class="jscript string">"vendor/couchapp/lib/mustache"</code><code class="jscript plain">);</code></div><div class="line number3 index2 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">stash = {</code></div><div class="line number4 index3 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">artist: doc.artist,</code></div><div class="line number5 index4 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">title : doc.title,</code></div><div class="line number6 index5 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">description: doc.description,</code></div><div class="line number7 index6 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document: doc._id</code></div><div class="line number8 index7 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number9 index8 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">Mustache.to_html(</code><code class="jscript keyword">this</code><code class="jscript plain">.templates.album, stash);</code></div><div class="line number10 index9 alt1"><code class="jscript plain">}</code></div></pre></div>
<p>As mentioned previously, <a href="http://couchapp.org/page/index" target="_blank">CouchApp</a> includes the <a href="https://github.com/janl/mustache.js" target="_blank">Mustache</a> <strong>JavaScript</strong> file automatically when generating a new <strong>couchapp</strong> application. In this example we first assign a reference to the <strong>Mustache</strong> module through a <em>require()</em> call for the file in the <em>vendor/couchapp/lib</em> directory. A generic <em>stash</em> object is created to assign property values that are dynamically populated into the <em>album.html</em> template (previous snippet) using the <strong>Mustache</strong>:<em>to_html</em> method.</p>
<p>I am not entirely clear on how it is possible to reference files and directories with the <strong>this</strong> keyword in a <strong>show function</strong>, but i can only assume that <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> has generated an object tree based on the file structure from which one can access values. If you do know, please leave a comment. In any event, the template file and the defining object are the first two arguments for <strong>Mustache</strong>:<em>to_html</em>. Upon request for an <em>album</em> document, this will return the <em>album.html</em> page dynamically populated with the values for the document related to the <em>id</em> in the request <strong>URL</strong> (eg. <a href="http://127.0.0.1:5984/albums/_design/albums/index.html#_show/album/db04eb7e5c845ee0aa791ae1ed000fe8" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html#_show<br>
/album/db04eb7e5c845ee0aa791ae1ed000fe8</a>).</p>
<h3>Hiccup</h3>
<p>There may be a slight problem in this solution however…. Though <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> does request-cacheing based on header <strong>ETag</strong>s on documents, <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> also does cacheing of pages (or rather it accesses ‘pages’ already loaded into the <strong>DOM</strong>). So there may be a time that an album has been edited during the application session and <strong>jQuery Mobile</strong> serves up old information as it never went back out the make a <strong>GET</strong> request to <strong>CouchDB</strong>, utilizing this <strong>show function</strong>. We could make a request for the document each time the page is shown in the <strong>DOM</strong> using the <em>jquery.couch</em> library, but that may be unnecessary overhead; not to mention a waste of the templating engine.</p>
<p>Another solution, and one I think is viable and worth consideration, is to remove the page from the <a href="http://jquerymobile.com/" target="_blank">jquery Mobile</a> page cache when this page is hidden in the view (when you navigate to another page). In order to do so, we will need to access the cached page in the <strong>DOM</strong> using <strong>JavaScript</strong>. Instead of adding this <strong>JavaScript</strong> directly in the <strong>HTML</strong> template file, we will use another templating feature available in <a href="https://github.com/janl/mustache.js" target="_blank">Mustache</a> – <strong>Partials</strong>.</p>
<h2>Partials</h2>
<p><strong>Partials</strong> are, essentially, just a way to include common mark-up or code or what have you into the target <strong>template</strong> page. It’s important to remember that partials are rendered in first so any <strong>{{mustache}}</strong>s in the partial file will also be filled. For the purposes of our example application, we are just going to include mark-up to load a script. It may be a little overkill at the moment, but I wanted to show the use of partials as they can be very handy.</p>
<p>Open up your favorite text editor and save the following snippet as <em>scripts.html</em> in <em>/templates/partials/album</em>.</p>
<p><em>/templates/partials/album/scripts.html</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="xml plain">&lt;</code><code class="xml keyword">script</code> <code class="xml color1">src</code><code class="xml plain">=</code><code class="xml string">"../../script/album-page.js"</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">script</code><code class="xml plain">&gt;</code></div></pre></div>
<p><em>[<strong>02-06-2010</strong>: Thank you to Steve and Stacy Braxton for leaving a comment noting that the filepath to scripts.html for the album page was incorrectly shown in italics. The correct filepath is now displayed. Thanks!]</em></p>
<p>Real boring stuff and not using the full breath of what <strong>Partials</strong> can do. Basically we are just loading in an associated <strong>JavaScript</strong> file with our page from the <strong>show function</strong>. Great. Now we have to create another file. I know, I know. It may appear convoluted, but in my head it is much cleaner and organized. The script we are about to create, could be included in this <strong>partial</strong> or in the <strong>template</strong>, but i prefer to work with another separate <strong>JavaScript</strong> file whose purpose I know based on its extension – its got script in it.</p>
<h3>album-page.js</h3>
<p>You may have looked at the path in the <strong>src</strong> attribute value from the <strong>Partial</strong> we just created and noticed that it is a relative path that goes out a couple directories. That is going back to the <em>_attachments</em> directory to access the <em>album-page.js</em> file from the <em>script</em> folder. The <em>_attachments</em> directory also houses the style folder in which we added the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> styles in the first post.</p>
<p>We’re going to create an add the <em>album-page.js</em> file to the <em>/_attachments/script</em> directory and it will provide the ability to access and clear the page from the page cache of <strong>jQuery Mobile</strong> so as to always serve up a the page from <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> (based on its own cacheing mechanism) using the show function. Open up your favorite text editor and save the following snippet as <em>album-page.js</em> in <em>/_attachments/script</em>:</p>
<p><em>/_attachments/script/album-page.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">AlbumPageController = </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number2 index1 alt1">&nbsp;</div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handleView()</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript comments">// Watch for bound hide of page to clear from cache.</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumcontent"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">albumPage = $(document.getElementById(</code><code class="jscript string">"_show/album/"</code> <code class="jscript plain">+ docId));</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">albumPage.bind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, handlePageViewHide );</code></div><div class="line number9 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">function</code> <code class="jscript plain">handlePageViewHide()</code></div><div class="line number12 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number13 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumcontent"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number14 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">albumPageCache =&nbsp; $(document.getElementById(</code><code class="jscript string">"_show/album/"</code> <code class="jscript plain">+ docId));</code></div><div class="line number15 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">albumPageCache.unbind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, handlePageViewHide );</code></div><div class="line number16 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">albumPageCache.empty();</code></div><div class="line number17 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">albumPageCache.remove();</code></div><div class="line number18 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">{</code></div><div class="line number21 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">initialize : </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number22 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).live( </code><code class="jscript string">"pageshow"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number23 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"div[data-role='page']"</code><code class="jscript plain">).die( </code><code class="jscript string">"pageshow"</code> <code class="jscript plain">);</code></div><div class="line number24 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">handleView();</code></div><div class="line number25 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number26 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number27 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number28 index27 alt1"><code class="jscript plain">}();</code></div><div class="line number29 index28 alt2">&nbsp;</div><div class="line number30 index29 alt1"><code class="jscript keyword">function</code> <code class="jscript plain">handlePageViewReady()</code></div><div class="line number31 index30 alt2"><code class="jscript plain">{</code></div><div class="line number32 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">AlbumPageController.initialize();</code></div><div class="line number33 index32 alt2"><code class="jscript plain">}</code></div><div class="line number34 index33 alt1"><code class="jscript plain">$().ready( handlePageViewReady );</code></div></pre></div>
<p>In essence, we are just creating a view controller for our <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page served up from the <strong>show function</strong>. Once the page is recognized as part of the <strong>DOM</strong>, the controller is initialized and an event handler is assigned to the <em>pageshow</em> event for the current page – the <em>album.html</em> served up. We access the page in the <strong>DOM</strong> using the standard <strong>data-role</strong> attribute value for a <strong>jQuery Mobile</strong> page. I stumbled upon this solution from these two forum posts – <a href="http://forum.jquery.com/topic/force-page-update" target="_blank">http://forum.jquery.com/topic/force-page-update</a> and <a href="http://forum.jquery.com/topic/binding-events-to-buttons-in-a-dialog" target="_blank">http://forum.jquery.com/topic/binding-events-to-buttons-in-a-dialog</a> – and seem to be the current agreed upon solution for accessing a loading <strong>jQuery Mobile</strong> page. </p>
<p>Now, it should be noted that setting that handler will actually set a handler on all <strong>div</strong>s with the <strong>data-role</strong> attributed as “page”. But since we are only concerned with the <em>pageshow</em> event, we know that the current target is the <em>album page</em>. Once that event is captured, we remove the handler and assign a <em>pagehide</em> event handler to clear the page from the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> (ie. <strong>DOM</strong>) cache and remove the elements from the <strong>DOM</strong>.</p>
<p>Since the <em>album page</em> is an external page (defined in the script in <em>index.html</em> when building the list items), its registered in the <strong>DOM</strong> and accessed using the <em>_show</em> path based on the document ID. So, when the page is fully loaded we access that page recognized in the <strong>DOM</strong> using the <em>getElementById</em>() method:</p>
<div><pre><div class="line number6 index0 alt1"><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumcontent"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number7 index1 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">albumPage = $(document.getElementById(</code><code class="jscript string">"_show/album/"</code> <code class="jscript plain">+ docId));</code></div></pre></div>
<p>Accessing the page as such, we can empty all its elements and remove it once the page has been fully hidden from the view in the page transition of jQuery Mobile:</p>
<div><pre><div class="line number13 index0 alt2"><code class="jscript keyword">var</code> <code class="jscript plain">docId = $(</code><code class="jscript string">"#albumcontent"</code><code class="jscript plain">).data(</code><code class="jscript string">"identity"</code><code class="jscript plain">);</code></div><div class="line number14 index1 alt1"><code class="jscript keyword">var</code> <code class="jscript plain">albumPageCache =&nbsp; $(document.getElementById(</code><code class="jscript string">"_show/album/"</code> <code class="jscript plain">+ docId));</code></div><div class="line number15 index2 alt2"><code class="jscript plain">albumPageCache.unbind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, handlePageViewHide );</code></div><div class="line number16 index3 alt1"><code class="jscript plain">albumPageCache.empty();</code></div><div class="line number17 index4 alt2"><code class="jscript plain">albumPageCache.remove();</code></div></pre></div>
<p>That essentially will make a request each time to <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> for the album document page and not rely on the cacheing of pages within <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a>. This will also open up the ability to assign and manage handlers for other events, such a requesting pages for editing a document… but we’ll broach that subject in another post <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_wink.gif" alt=";)" class="wp-smiley">  For now, let’s go back and update our <em>album.js</em> and <em>album.html</em> documents to include the <strong>partial</strong>.</p>
<p><em>[<strong>01-28-2010</strong>: Thank you to IR for leaving a comment alerting me to the fact that i totally missed out on updating the neccessary files after creating the partial]</em></p>
<h3>Modifying album.js and album.html</h3>
<p>Open up <em>/shows/album.js</em> in your favorite text editor and make the following modification to pass the <strong>partial</strong> directory in <strong>Mustache</strong>.<em>to_html</em>():</p>
<p><em>/shows/album.js</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">function</code><code class="jscript plain">(doc, req) {</code></div><div class="line number2 index1 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">Mustache = require(</code><code class="jscript string">"vendor/couchapp/lib/mustache"</code><code class="jscript plain">);</code></div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">stash = {</code></div><div class="line number4 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">artist: doc.artist,</code></div><div class="line number5 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">title : doc.title,</code></div><div class="line number6 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">description: doc.description,</code></div><div class="line number7 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document: doc._id</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">};</code></div><div class="line number9 index8 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">Mustache.to_html(</code><code class="jscript keyword">this</code><code class="jscript plain">.templates.album, stash, </code><code class="jscript keyword">this</code><code class="jscript plain">.templates.partials.album);</code></div><div class="line number10 index9 alt1"><code class="jscript plain">}</code></div></pre></div>
<p>That last argument in <em>to_html</em>() will allow you to stub out the documents included in the <em>/album</em> folder of the <strong>partials</strong> directory in the <em>album.html</em> template. We’ll need to update that document as well for our <em>scripts</em> <strong>partial</strong> to be included.</p>
<p>Open up <em>/templates/album.html</em> and make the following modification:</p>
<p><em>/templates/album.html</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"page"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albumview"</code> <code class="xml color1">data-position</code><code class="xml plain">=</code><code class="xml string">"inline"</code> <code class="xml color1">data-back</code><code class="xml plain">=</code><code class="xml string">"true"</code><code class="xml plain">&gt;</code></div><div class="line number2 index1 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"header"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albumheader"</code><code class="xml plain">&gt;</code></div><div class="line number3 index2 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">h1</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"albumtitle"</code><code class="xml plain">&gt;{{title}}&lt;/</code><code class="xml keyword">h1</code><code class="xml plain">&gt;</code></div><div class="line number4 index3 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">a</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#home"</code> <code class="xml color1">data-icon</code><code class="xml plain">=</code><code class="xml string">"grid"</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-btn-right"</code><code class="xml plain">&gt;Home&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;</code></div><div class="line number5 index4 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number6 index5 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"content"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albumcontent"</code> <code class="xml color1">data-identity</code><code class="xml plain">=</code><code class="xml string">"{{document}}"</code><code class="xml plain">&gt;</code></div><div class="line number7 index6 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">h2</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"artist"</code><code class="xml plain">&gt;{{artist}}&lt;/</code><code class="xml keyword">h2</code><code class="xml plain">&gt;</code></div><div class="line number8 index7 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">p</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"title"</code><code class="xml plain">&gt;{{title}}&lt;/</code><code class="xml keyword">p</code><code class="xml plain">&gt;</code></div><div class="line number9 index8 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">p</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"description"</code><code class="xml plain">&gt;{{description}}&lt;/</code><code class="xml keyword">p</code><code class="xml plain">&gt;</code></div><div class="line number10 index9 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number11 index10 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"footer"</code> <code class="xml plain">/&gt;</code></div><div class="line number12 index11 alt1"><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number13 index12 alt2 highlighted"><code class="xml plain">{{&gt;scripts}}</code></div></pre></div>
<p>A slight modification to the syntax on how you would include object property values, the <strong>partial</strong> is included by appending the name of the <strong>partial</strong> document to include with a <em>greater than</em> character. That will essentially write the content of the document inline in the <strong>template</strong> where it is declared.</p>
<p>Now we just need to make a small modification to the <em>index.html</em> file and then deploy our modified application to the <strong>CouchDB</strong> instance so we can view our wonderful changes (which won’t look like we changed a thing).</p>
<h3>Modifying index.html</h3>
<p>We added a <strong>Home</strong> button to the header bar of the <em>album page</em> so we could always navigate back to the <strong>Home</strong> page. Currently the <em>album page</em> is accessible from the album list on the <strong>Home</strong> page, but who knows, maybe that won’t always be the case in the future. In any event, we made the change and assigned the <strong>href</strong> value for the <strong>Home</strong> page button with the <em>#home</em> anchor. Currently that will go nowhere. We’ll set that as the div id on the main <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page in <em>index.html</em>.</p>
<p>Open up the <em>/_attachments/index.html</em> file in your favorite text editor and make the following modifications the #home <strong>page div</strong>:</p>
<p><em>/_attachments/index.html</em></p>
<div><pre><div class="line number9 index0 alt2 highlighted"><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"home"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"page"</code><code class="xml plain">&gt;</code></div><div class="line number10 index1 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"header"</code><code class="xml plain">&gt;&lt;</code><code class="xml keyword">h1</code><code class="xml plain">&gt;Albums&lt;/</code><code class="xml keyword">h1</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number11 index2 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"content"</code><code class="xml plain">&gt;</code></div><div class="line number12 index3 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">ul</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albums"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"listview"</code> <code class="xml color1">data-theme</code><code class="xml plain">=</code><code class="xml string">"c"</code> <code class="xml color1">data-dividertheme</code><code class="xml plain">=</code><code class="xml string">"b"</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">ul</code><code class="xml plain">&gt;</code></div><div class="line number13 index4 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number14 index5 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"footer"</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-bar"</code><code class="xml plain">&gt;&lt;</code><code class="xml keyword">h4</code><code class="xml plain">&gt;a list of albums&lt;/</code><code class="xml keyword">h4</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number15 index6 alt2"><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div></pre></div>
<p><em>[<strong>02-05-2010</strong>: Thank you to Otetz for leaving a comment about the missing call to refresh the list prior to shoe on the index.html file]</em><br>
With <em>index.html</em> still open in your favorite text editor, add the following line to the <em>handleDocumentReady</em>() method in the inline <strong>JavaScript</strong>:</p>
<div><pre><div class="line number22 index0 alt1"><code class="plain plain">function handleDocumentReady()</code></div><div class="line number23 index1 alt2"><code class="plain plain">{</code></div><div class="line number24 index2 alt1 highlighted"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">$("#home").bind( "pagebeforeshow", refreshAlbums );</code></div><div class="line number25 index3 alt2"><code class="plain spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain plain">refreshAlbums();</code></div></pre></div>
<p>Save that, and now we can add a <strong>Home</strong> button to any page and will always be directed back to that <strong>div</strong> with the list of albums from our <strong>CouchDB</strong> database. Cool. Time to deploy.</p>
<h2>Deployment</h2>
<p>We modified our show function to use templates and created a script to empty the page and its elements from the <strong>DOM</strong> upon hide within the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> context and are assured that each access of an album document will contain the latest changes. With these modifications saved, we can now push to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database using the <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> utility. Open a terminal and navigate to the directory where you create your <strong>CouchApp</strong> applications (for me that is <em>/Documents/workspace/custardbelly/couchdb</em> and in there i have a folder named <em>albums</em> which is the <strong>CouchApp</strong> application directory for these examples). Enter the following command to push the changes to the <strong>CouchDB</strong> instance:</p>
<div><pre><div class="line number1 index0 alt2"><code class="bash plain">couchapp push albums http:</code><code class="bash plain">//127</code><code class="bash plain">.0.0.1:5984</code><code class="bash plain">/albums</code></div></pre></div>
<p>If all was successful and you now go to <a href="http://127.0.0.1:5984/albums/_design/albums/index.html" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html</a>, we’ll still have our old familiar list and still access each album by clicking on a list item. Basically it performs exactly as it had before, but we cleaned up a little on our end… a benefit to us as the developer and a benefit to the user though not visually noticeable… it still looks rather ugly <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley"> </p>
<h2>Conclusion</h2>
<p>We delved a little deeper into how to serve up pages from <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> using <strong>templates</strong> and <strong>partials</strong> (thanks to <a href="https://github.com/janl/mustache.js" target="_blank">Mustache</a>!) and also touched on accessing pages from <strong>DOM</strong> cache in the context of <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> framework. All nice stuff, but nothing really has changed in how the application worked for the end user. We ensured that <em>album page</em>s always had the correct and latest content, but we haven’t opened up the possibility to edit the document and commit changes. That’s to come <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley">  Just wanted to lay the groundwork for easing into adding more pages to our application. Hopefully you found some of this useful.</p>
<p><em>[Note] This post was written against the following software versions:</em><br>
<strong>CouchDB </strong>– 1.0.1<br>
<strong>CouchApp</strong> – 0.7.2<br>
<strong>jQuery</strong> – 1.4.4<br>
<strong>jQuery Mobile</strong> – 1.0a2<br>
<em>If you have found this post and any piece has moved forward, hopefully the examples are still viable/useful. I will not be updating the examples in this post in parellel with updates to any of the previously mentioned software, unless explicitly noted.</em></p>
<p><strong>Articles in this series:</strong></p>
<ol>
<li><a href="http://custardbelly.com/blog/?p=244" target="_blank">Getting Started</a></li>
<li><a href="http://custardbelly.com/blog/?p=278" target="_blank">Displaying a page detail of a single album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=297" target="_blank">Templates and Mustache</a></li>
<li><a href="http://custardbelly.com/blog/?p=318" target="_blank">Displaying an editable page of an album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=332" target="_blank">Creating and Adding an album document.</a></li>
<li><a href="http://custardbelly.com/blog/?p=344" target="_blank">Deleting an album document</a></li>
<li><a href="http://custardbelly.com/blog/?p=360" target="_blank">Authorization and Validation – Part 1</a></li>
<li><a href="http://custardbelly.com/blog/?p=394">Authorization and Validation – Part 2</a></li>
</ol>
<p><a href="http://custardbelly.com/downloads/couchapp/jqm_couchdb_albums.zip">Full source for albums couchapp here.</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/couchdb/" title="View all posts in CouchDB" rel="category tag">CouchDB</a>,  <a href="http://custardbelly.com/blog/category/jquery/" title="View all posts in jquery" rel="category tag">jquery</a>,  <a href="http://custardbelly.com/blog/category/jquery-mobile/" title="View all posts in jquery-mobile" rel="category tag">jquery-mobile</a>.</p>
	
	

	<p class="by-line">
		<span class="author vcard full-author">
			<span class="by alt-font">By</span> <a class="url fn" href="http://custardbelly.com/blog/author/todd-anderson/" title="View all posts by todd anderson">todd anderson</a>		</span>
		<span class="date full-date"><span class="ndash alt-font">–</span> <abbr class="published" title="2010-12-28T10:21">December 28, 2010</abbr></span>
	</p><!--/by-line-->

	<div id="post-comments-297-target"></div>
	<div class="clear"></div>
	
	