<?xml version="1.0" encoding="UTF-8"?>
<rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[Todd Anderson]]></title><description><![CDATA[ramblings about making things for web, mobile, desktop and land.]]></description><link>https://www.custardbelly.com/blog</link><generator>RSS for Node</generator><lastBuildDate>Thu, 31 Mar 2016 02:37:59 GMT</lastBuildDate><atom:link href="https://www.custardbelly.com/blog/index.xml" rel="self" type="application/rss+xml"/><author><![CDATA[Todd Anderson]]></author><item><title><![CDATA[Building a Custom PiRate Radio]]></title><description><![CDATA[<h1 id="introduction">Introduction</h1>
<p>Some time back - and judging from the post date, literally a couple of years ago - I bookmarked a post from <a href="http://makezine.com/">Make:</a> titled <a href="http://makezine.com/projects/raspberry-pirate-radio/">Raspberry Pirate Radio</a>. I&#39;ve always been interested in custom radio projects with microcontrollers. I&#39;ve built various started kits for FM and AM radios to hone my soldering chops, and my favorite radio project so far has been <a href="http://www.thepublicrad.io/">The Public Radio</a>. <em>I use it daily. Go get one</em>. In fact, I have a personal radio project that I have been working on for longer back then the mentioned post; a bit ambitious for my skill level at the time I started it, but some day I hope to blog about it here...</p>
<p>In any event, I have had <a href="http://makezine.com/projects/raspberry-pirate-radio/">the Pirate Radio post</a> in the back of my mind for a while, waiting for the resources and time to implement. As of recent, I was able to get it assembled and working and have been very happy! I went a little outside of the steps described here, <a href="http://makezine.com/projects/raspberry-pirate-radio/">http://makezine.com/projects/raspberry-pirate-radio/</a> - more specifically, not using the image they created and manually setting up my system - and wanted to document what I did in case others are curious.</p>
<iframe width="420" height="315" src="https://www.youtube.com/embed/aBu2tyXOWnU" frameborder="0" allowfullscreen></iframe>

<p><em>I like my old school rap. I apologize to Mr. Ness; there was no offense, just showing off the band change...</em></p>
<h1 id="specs">Specs</h1>
<p>The ending solution has the following specs:</p>
<h2 id="hardware">Hardware</h2>
<ul>
<li><a href="https://www.raspberrypi.org/products/model-a-plus/">Raspberry Pi A+</a></li>
<li><a href="http://www.amazon.com/Sandisk-MicroSDHC-Memory-Card-Adapter/dp/B000WH6H1M">8GB MicroSD Card</a></li>
<li><a href="https://www.pi-supply.com/product/pi-supply-raspberry-pi-power-switch/?v=7516fd43adaa">Pi Supply Switch</a></li>
</ul>
<p>I could go down to a <strong>Raspberry Pi A</strong> model and most likely a lower SD Card size if I changed the target OS, but I was using what I already had available to me.</p>
<p>Additionally, the <a href="https://www.pi-supply.com/product/pi-supply-raspberry-pi-power-switch/?v=7516fd43adaa">Pi Supply Switch</a> is not a requirement - I just wanted a way to safely shutdown the Pi without have to explicitly <em>pull the plug</em>.</p>
<h2 id="software">Software</h2>
<ul>
<li><a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian Jessie</a></li>
<li><a href="https://trac.ffmpeg.org/wiki/CompilationGuide/Ubuntu">ffmpeg</a></li>
<li><a href="http://www.icrobotics.co.uk/wiki/index.php/Turning_the_Raspberry_Pi_Into_an_FM_Transmitter">PiFM</a> <em>(included in the <a href="https://github.com/Make-Magazine/PirateRadio/blob/master/PirateRadio.py">PirateRadio Gtihub repository</a>)</em>.</li>
<li><a href="https://github.com/Make-Magazine/PirateRadio/blob/master/PirateRadio.py">PirateRadio</a></li>
<li><a href="https://www.pi-supply.com/pi-supply-switch-v1-1-code-examples/?v=7516fd43adaa">Pi Supply Soft Shutdown</a></li>
</ul>
<h1 id="raspberry-pi-os-set-up">Raspberry Pi OS Set Up</h1>
<p>I used a <a href="https://www.raspberrypi.org/products/model-b-plus/">Rasbperry Pi B+</a> when setting up the system. Eventually, I moved the SD Card with the necessary software onto a <a href="https://www.raspberrypi.org/products/model-a-plus/">Raspberry Pi A+</a>, but will probably at some point transfer it to a <a href="https://www.raspberrypi.org/products/model-a/">Raspberry Pi A</a>, seeing as the GPIO requirements are a minimum; pin <em>4</em> is used for the antenna and pins <em>7</em> &amp; <em>8</em> are used for the Pi Supply shutdown.</p>
<p>The exact Pi model that I used to setup the system is not a requirement. However, I did need something that I could connect an ethernet cable - and eventually a WiFi dongle - to, so that I could SSH into the Pi and install the necessary software and test; that meant I needed at least the following on the board:</p>
<ul>
<li>An Ethernet port</li>
<li>2 USB ports - one for the WiFi dongle, the other for the Flash Drive</li>
</ul>
<p>I usually have a spare <strong>B</strong> or <strong>B+</strong> lying around for such a purpose.</p>
<h2 id="raspbian-jessie">Raspbian Jessie</h2>
<p>In order to get the target OS onto the MicroSD Card, I downloaded an image of <a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian Jessie</a> image, plugged my SD Card into <a href="https://www.adafruit.com/products/939">this lovely USB MicroSD Card Writer from adafruit</a> and followed the graciously provided script from <a href="https://github.com/RayViljoen/Raspberry-PI-SD-Installer-OS-X">https://github.com/RayViljoen/Raspberry-PI-SD-Installer-OS-X</a>. <em>Be sure to heed the warnings!</em></p>
<h2 id="expand-the-filesystem">Expand the Filesystem</h2>
<p>After flashing the image to the MicroSD card, I inserted into my Pi - for this stage in the project, that was the <a href="https://www.raspberrypi.org/products/model-b-plus/">Rasbperry Pi B+</a> - and plugged in both an Ethernet chord and the power supply.</p>
<p><em>I additionally used a WiFi dongle and setup my WPA configuration so I didn&#39;t have to work so close to my router in the living room, but that is not entirely necessary and such instructions will not be included in this article.</em></p>
<p>After the Pi powered up, I SSH&#39;d into it:</p>
<pre><code><span class="hljs-variable">$ </span>ssh pi<span class="hljs-variable">@10</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.x
</code></pre><p><em>Provide the actually local IP of your Pi in placement of <code>10.0.0.x</code>. You can use tools such as <a href="http://angryip.org/download/#mac">Angry Ip Scanner</a> or <a href="https://itunes.apple.com/us/app/fing-network-scanner/id430921107?mt=8">Fing</a> to find its local IP on your network.</em></p>
<p>Once logged in, I issued:</p>
<pre><code><span class="hljs-variable">$ </span>raspi-config
</code></pre><p>From the console prompt GUI, I clicked <code>Enter/Return</code> on the entry for <em>Expand Filesystem</em>; after which, it asked if I wanted to reboot - I selected <code>Yes</code>.</p>
<p><em>You can update whichever other configurations you desire, with a recommendation to <code>Change Your User Password</code>.</em></p>
<h2 id="install-some-required-libs">Install some required libs</h2>
<p>After the PI reboots, SSH back into it and issue:</p>
<pre><code>$ <span class="hljs-built_in">sudo</span> apt-get update
$ <span class="hljs-built_in">sudo</span> apt-get upgrade
$ <span class="hljs-built_in">sudo</span> apt-get install git
</code></pre><p>I additionally installed <code>vim</code>:</p>
<pre><code>$ <span class="hljs-built_in">sudo</span> apt-get install vim
</code></pre><p>but, I have been known to get by with straight <code>vi</code> (which does not require any additional installation) if need be :)</p>
<h1 id="ffmpeg">FFMPEG</h1>
<p>The next thing to do is to build and install <a href="https://trac.ffmpeg.org">ffmpeg</a>. If you are unware of <strong>ffmpeg</strong>, it is software that allows for - among other things - playback of audio and video. It is the basis of playback for <a href="http://www.icrobotics.co.uk/wiki/index.php/Turning_the_Raspberry_Pi_Into_an_FM_Transmitter">PiFM</a> which is the C library that is run by the <a href="https://github.com/Make-Magazine/PirateRadio/blob/master/PirateRadio.py">PirateRadio</a> python script.</p>
<p>I followed the following guide from FFMPEG regarding installation on Ubuntu: <a href="https://trac.ffmpeg.org/wiki/CompilationGuide/Ubuntu">https://trac.ffmpeg.org/wiki/CompilationGuide/Ubuntu</a>, knowing I was only concerned with the following assemblers and codecs:</p>
<ul>
<li>YASM</li>
<li>libfdk-aac</li>
<li>libmp3lame</li>
</ul>
<h2 id="building-and-installing">Building and Installing</h2>
<p>SSH into the Pi and issue:</p>
<pre><code>$ sudo apt<span class="hljs-attribute">-get</span> <span class="hljs-attribute">-y</span> <span class="hljs-subst">--</span>force<span class="hljs-attribute">-yes</span> install autoconf automake build<span class="hljs-attribute">-essential</span> libass<span class="hljs-attribute">-dev</span> libfreetype6<span class="hljs-attribute">-dev</span> <span class="hljs-subst">\</span>
  libsdl1<span class="hljs-number">.2</span><span class="hljs-attribute">-dev</span> libtheora<span class="hljs-attribute">-dev</span> libtool libva<span class="hljs-attribute">-dev</span> libvdpau<span class="hljs-attribute">-dev</span> libvorbis<span class="hljs-attribute">-dev</span> libxcb1<span class="hljs-attribute">-dev</span> libxcb<span class="hljs-attribute">-shm0</span><span class="hljs-attribute">-dev</span> <span class="hljs-subst">\</span>
  libxcb<span class="hljs-attribute">-xfixes0</span><span class="hljs-attribute">-dev</span> pkg<span class="hljs-attribute">-config</span> texinfo zlib1g<span class="hljs-attribute">-dev</span>

$ mkdir ~/ffmpeg_sources
$ mkdir ~/ffmpeg_build

$ cd /usr/src
$ sudo git clone git:<span class="hljs-comment">//source.ffmpeg.org/ffmpeg.git</span>
$ cd ffmpeg
$ sudo <span class="hljs-built_in">.</span>/configure <span class="hljs-subst">--</span>prefix<span class="hljs-subst">=</span><span class="hljs-string">"$HOME/ffmpeg_build"</span> <span class="hljs-subst">--</span>pkg<span class="hljs-attribute">-config</span><span class="hljs-attribute">-flags</span><span class="hljs-subst">=</span><span class="hljs-string">"--static"</span> <span class="hljs-subst">--</span>extra<span class="hljs-attribute">-cflags</span><span class="hljs-subst">=</span><span class="hljs-string">"-I$HOME/ffmpeg_build/include"</span> <span class="hljs-subst">--</span>extra<span class="hljs-attribute">-ldflags</span><span class="hljs-subst">=</span><span class="hljs-string">"-L$HOME/ffmpeg_build/lib"</span> <span class="hljs-subst">--</span>arch<span class="hljs-subst">=</span>armel <span class="hljs-subst">--</span>target<span class="hljs-attribute">-os</span><span class="hljs-subst">=</span>linux <span class="hljs-subst">--</span>enable<span class="hljs-attribute">-gpl</span> <span class="hljs-subst">--</span>enable<span class="hljs-attribute">-libmp3lame</span> <span class="hljs-subst">--</span>enable<span class="hljs-attribute">-libfdk</span><span class="hljs-attribute">-aac</span> <span class="hljs-subst">--</span>enable<span class="hljs-attribute">-nonfree</span>

$ sudo make
$ sudo make install
</code></pre><p>Essentially, we are getting the required dependencies, setting up and defining the <code>source</code> and <code>build</code> directories for our custom FFMPEG install, and then building and installing it.</p>
<p>Once complete, <strong>and it will take a long while - few hours for me</strong>, you&#39;ll need to update the <code>PATH</code> environment variable to include the new FFMPEG install:</p>
<pre><code><span class="hljs-variable">$ </span>vim ~<span class="hljs-regexp">/.profile</span>
</code></pre><p>Add:</p>
<pre><code><span class="hljs-constant">PATH</span>=<span class="hljs-variable">$PATH</span><span class="hljs-symbol">:/home/pi/ffmpeg_build/bin</span>
</code></pre><p>Then source:</p>
<pre><code>$ <span class="hljs-built_in">source</span> ~/.profile
</code></pre><p>Additionally, you will want to symlink to the <code>usr/bin</code> directory:</p>
<pre><code>$ <span class="hljs-built_in">sudo</span> ln <span class="hljs-operator">-s</span> /home/pi/ffmpeg_build/bin/ffmpeg /usr/bin/ffmpeg
</code></pre><h2 id="checking">Checking</h2>
<p>To test that <strong>ffmpeg</strong> is available form the command line, do a quick test to find its location:</p>
<pre><code>which ffmpeg
</code></pre><p>If a path to your install or symlink directory is printed in the console, you are good to proceed.</p>
<h1 id="pirateradio">PirateRadio</h1>
<p>Now it is time to grab and update the <a href="https://github.com/Make-Magazine/PirateRadio">PirateRadio</a> script.</p>
<h2 id="cloning">Cloning</h2>
<p>I cloned and modified it in the <code>/opt</code> directory, but you can place it wherever you prefer - just note that the startup script will point to the <code>/opt</code> location when we arrive to that section.</p>
<pre><code><span class="hljs-variable">$ </span>cd /opt
<span class="hljs-variable">$ </span>sudo mkdir pirateradio
<span class="hljs-variable">$ </span>sudo chown -<span class="hljs-constant">R</span> <span class="hljs-symbol">pi:</span>pi pirateradio

<span class="hljs-variable">$ </span>cd /opt/pirateradio
<span class="hljs-variable">$ </span>git clone <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/</span><span class="hljs-constant">Make</span>-<span class="hljs-constant">Magazine</span>/<span class="hljs-constant">PirateRadio</span>.git .
</code></pre><h2 id="modifying">Modifying</h2>
<p>Once <code>clone</code>&#39;d, modify a few lines of the <strong>PirateRadio.py</strong> file to conform to our current setup:</p>
<pre><code><span class="hljs-variable">$ </span>vim <span class="hljs-constant">PirateRadio</span>.py
</code></pre><p>Modify the following variable declaration to point to the <code>pirateradio.conf</code> of the current directory:</p>
<pre><code><span class="hljs-setting">config_location = <span class="hljs-value"><span class="hljs-string">"/opt/pirateradio/pirateradio.conf"</span></span></span>
</code></pre><p>Modify the <em>uncommented</em> <strong>fm_process</strong> defined to point to the relative <strong>pifm</strong> library:</p>
<pre><code>fm_process = subprocess.Popen([<span class="hljs-string">"./pifm"</span>,<span class="hljs-string">"-"</span>,str(frequency),<span class="hljs-string">"44100"</span>, <span class="hljs-string">"stereo"</span> <span class="hljs-keyword">if</span> play_stereo <span class="hljs-keyword">else</span> <span class="hljs-string">"mono"</span>], <span class="hljs-keyword">stdin</span>=music_pipe_r, <span class="hljs-keyword">stdout</span>=dev_null)
</code></pre><p>Additionally, I had to <strong>remove all additional <code>fallback=x</code> arguments</strong>.</p>
<h2 id="configuration-update">Configuration Update</h2>
<p>Now that we modified the location that the <a href="https://github.com/Make-Magazine/PirateRadio">PirateRadio</a> script is looking for the configuration, we need to update the configuration to look for the appropriate target directory for music files to access and play.</p>
<pre><code><span class="hljs-variable">$ </span>vim pirateradio.conf
</code></pre><p>Modify the following line:</p>
<pre><code><span class="hljs-attribute">music_dir </span>=<span class="hljs-string"> /media/pi</span>
</code></pre><p>Because we installed <a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian Jessie</a>, we know that any USB drive installed into a USB port will auto-mount <code>dev/sda1</code> to <code>/media/pi</code>. I additionally, loaded a USB stick with audio files and optionally names the stick <code>RADIOPI</code> - so I extended the <code>music_dir</code> configuraation property as such:</p>
<pre><code><span class="hljs-attribute">music_dir </span>=<span class="hljs-string"> /media/pi/RADIOPI</span>
</code></pre><p>As mentioned before, with <a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian Jessie</a> installed, the USB stick will be auto-mounted if plugged in to a port prior to provided power supply to the board.</p>
<h1 id="-optional-pi-supply-soft-shutdown">[OPTIONAL] Pi Supply Soft Shutdown</h1>
<p>I also added a <a href="https://www.pi-supply.com/product/pi-supply-raspberry-pi-power-switch/?v=7516fd43adaa">Pi Supply Switch</a> to my board.</p>
<p>This is optional, but it allows for shutdown without having to explicitly pull the power supply from my board when I no longer wanted it to run. Something I was interested in with regards to corrupting the mounted USB, and also because I wanted to try it out :) <em>As a side note, I have been pretty happy and would recommend it - only complaints are that it is a bit &quot;bulky&quot;</em>.</p>
<p>If you decide to add a <a href="https://www.pi-supply.com/product/pi-supply-raspberry-pi-power-switch/?v=7516fd43adaa">Pi Supply Switch</a> as well, follow the instructions from their site - <a href="https://www.pi-supply.com/pi-supply-switch-v1-1-code-examples/?v=7516fd43adaa">https://www.pi-supply.com/pi-supply-switch-v1-1-code-examples/?v=7516fd43adaa</a> - by adding the &quot;soft shutdown&quot; script to your system and follow this instructions to add it to the <code>/etc/rc.local</code> script.</p>
<h1 id="adding-to-startup">Adding to Startup</h1>
<p>Add the script to start-up the Pi so that, whenever power is supplied, the broadcast will kick off and be picked up the default <strong>88.9</strong> band by a radio reciever.</p>
<p>Add it to <code>init.d</code>:</p>
<pre><code>$ <span class="hljs-built_in">cd</span> /etc/init.d
$ <span class="hljs-built_in">sudo</span> touch pirateradio
$ <span class="hljs-built_in">sudo</span> chmod +x pirateradio
$ <span class="hljs-built_in">sudo</span> vim pirateradio
</code></pre><p>Paste in the following to <code>/etc/init.d/pirateradio</code>:</p>
<pre><code><span class="hljs-shebang">#! /bin/sh</span>
<span class="hljs-comment"># /etc/init.d/pirateradio</span>

<span class="hljs-comment">### BEGIN INIT INFO</span>
<span class="hljs-comment"># Provides:          pirateradio</span>
<span class="hljs-comment"># Required-Start:    $network</span>
<span class="hljs-comment"># Required-Stop:     $network</span>
<span class="hljs-comment"># Default-Start:     2 3 4 5</span>
<span class="hljs-comment"># Default-Stop:      0 1 6</span>
<span class="hljs-comment"># Short-Description: Start PirateRadio at boot</span>
<span class="hljs-comment"># Description:       PirateRadio script will start / stop a program a boot / shutdown.</span>
<span class="hljs-comment">### END INIT INFO</span>

<span class="hljs-keyword">case</span> <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> <span class="hljs-keyword">in</span>
  start)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Starting PirateRadio"</span>
    mount /dev/sda1 /media/pi/RADIOPI/
    <span class="hljs-built_in">cd</span> /opt/pirateradio
    python PirateRadio.py &amp;&gt;/dev/null
    ;;
  stop)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Stopping PirateRadio"</span>
    umount /dev/sda1
    kill `pgrep <span class="hljs-operator">-f</span> ffmpeg\(.*\)\/pi`
    kill `pgrep <span class="hljs-operator">-f</span> pifm`
    ;;
  *)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Usage: /etc/init.d/pirateradio {start|stop}"</span>
    <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span>
    ;;
<span class="hljs-keyword">esac</span>

<span class="hljs-keyword">exit</span> <span class="hljs-number">0</span>
</code></pre><p>Then save and add to start-up:</p>
<pre><code>$ <span class="hljs-built_in">sudo</span> update-rc.d pirateradio defaults
$ <span class="hljs-built_in">sudo</span> /etc/init.d/pirateradio start
</code></pre><h2 id="reboot">Reboot</h2>
<p>At this point, you could reboot:</p>
<pre><code>$ <span class="hljs-built_in">sudo</span> shutdown -r now
</code></pre><p>And once the Pi is up again, and the USB stick has been pointed and the startup script run (takes about 5 - 10 seconds for me):</p>
<ol>
<li>Find your favorate radio reciever (for FM frequencies)</li>
<li>Tune the radio to <strong>88.9</strong></li>
<li>Get down to your favorite tunes!</li>
</ol>
<h3 id="additional-note">Additional Note</h3>
<p>If you used and setup the <a href="https://www.pi-supply.com/pi-supply-switch-v1-1-code-examples/?v=7516fd43adaa">Pi Supply Shutdown</a> you won&#39;t need to unplug and plug back in the power supply to the Pi when deciding to stop broadcasting music from the USB stick on your PI to the FM frequency - just simply press the soft or hard shutdown buttons.</p>
<h1 id="conclusion">Conclusion</h1>
<p>I had a lot of fun building this custom &quot;local&quot; radio station based off the <a href="http://makezine.com/projects/raspberry-pirate-radio/">Raspberry Pirate Radio</a> post from a few years back. With a little customization, I was able to set it up the way I wanted while incorporating the <a href="https://www.pi-supply.com/pi-supply-switch-v1-1-code-examples/?v=7516fd43adaa">Pi Supply Shutdown</a> peripheral.</p>
<p>I love music and talk radio and this project was just a continuation of different presentations of which I can access - and, dare I say, harness - that fascination. Hopefully, I will one day finish my one long standing project and have that posted up here as well :) Time will tell.</p>
<p>Until then, I submit to you this admission:</p>
<iframe width="420" height="315" src="https://www.youtube.com/embed/A8HT4kkBjD8" frameborder="0" allowfullscreen></iframe>
]]></description><link>https://www.custardbelly.com/blog/blog-posts/2016/03/30/piradio/index.html</link><guid isPermaLink="true">https://www.custardbelly.com/blog/blog-posts/2016/03/30/piradio/index.html</guid><dc:creator><![CDATA[Todd Anderson]]></dc:creator><pubDate>Invalid Date</pubDate></item><item><title><![CDATA[Getting Secure:  Transferring a domain to AWS and enabling HTTPS under nginx]]></title><description><![CDATA[<h1 id="introduction">Introduction</h1>
<p>I recently decided to put this site under HTTPS after reading this article/interview with <a href="https://helloanselm.com/">Anselm Hannemann</a> on <strong>CSS-Tricks</strong>:</p>
<p>&gt; <a href="https://css-tricks.com/interview-web-security" target="_blank">https://css-tricks.com/interview-web-security/</a></p>
<p>I had already been interested in moving to HTTPS with the advent of an open Certificate Authority, <a href="https://letsencrypt.org/">Let&#39;s Encrypt</a>, and my growing fascination with <a href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API">Service Workers</a>, which will only work under HTTPS. Not sure if I would ever have a need for offline support for this site, but it never could hurt to mess around.</p>
<p>In any event, I had decided it was time to explore putting <a href="https://www.custardbelly.com/blog" target="_blank">custardbelly.com</a> under HTTPS - please don&#39;t poke around, it needs a major update - and as I went about trying to set <a href="https://letsencrypt.org/" target="_blank">Let&#39;s Encrypt</a> up on my current (<em>now old</em>) VPS host I was running into road blocks of predetermined OS&#39;es and dependencies that were beyond my control, which can happen if you entrust hosting your domains through a general VPS provider.</p>
<p>To have more control over my environment, I decided to use the Amazon Web Services (<strong>AWS</strong>) knowledge I have gained from working intimately with it in my current job/role and spin up an EC2 instance to dedicate to my site - moving it off the VPS I previously had.</p>
<p>In doing so, I wanted to share my process and experiences to any of you that may be wondering how to do the same. As the title suggests but does not entirely convey, my process involved:</p>
<ul>
<li><a href="#moving-a-domain-to-an-ec2-instance">Moving a domain to an EC2 instance</a></li>
<li><a href="#transferring-dns-records">Transferring DNS records from a VPS to Amazon Route 53</a></li>
<li><a href="#setting-up-nginx">Setting up nginx to serve my site</a></li>
<li><a href="#generating-certificates-from-lets-encrypt">Generating certificates from</a> <a href="https://letsencrypt.org/">Let&#39;s Encrypt</a></li>
<li><a href="#setting-up-my-site-to-be-served-under-https">Setting up my site to be served under HTTPS</a></li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#references">References</a></li>
</ul>
<hr>

<h1 id="moving-a-domain-to-an-ec2-instance">Moving a Domain to an EC2 Instance</h1>
<p>This series of steps is essentially moving any files served by my previous VPS host to an EC2 instance on AWS. Because the site and its blog are all static files, it was a simple matter of moving - or rather pulling - my files to a new server.</p>
<h2 id="setting-up-an-ec2-instance">Setting up an EC2 Instance</h2>
<p>If you don&#39;t already have an Amazon Web Services (AWS) account, you can sign up for one here: <a href="https://aws.amazon.com/" target="_blank">https://aws.amazon.com/</a>.</p>
<blockquote>
<p>I wont go into any detail about what AWS is, how to set up an account and the pricing models, so please review all documentation if you are curious.</p>
</blockquote>
<p>Once you have signed in:</p>
<ol>
<li>Navigate to the <strong>Compute:EC2</strong> space</li>
<li>Once the <em>EC2 Dashboard</em> select <strong>Launch Instance</strong><br> <img style="width: 100%; max-width: 240px; border: 1px solid #999; padding: 10px;" src="https://www.custardbelly.com/images/https_ec2_launch_instance.png" alt="EC2 Launch Instance"></li>
<li>Select the <strong>Ubuntu Server 14.04 LTS (HVM)</strong> instance from the list of AMIs</li>
<li>Choose the <strong>t2.micro</strong> item from the <em>Instance Type</em> selection screen</li>
<li>Click <strong>Next: Configure Instance Details</strong></li>
<li>Leave the default form entries and click <strong>Next: Add Storage</strong></li>
<li>Leave the default form entries and click <strong>Next: Tag Instance</strong></li>
<li>From the <em>Key/Value</em> form, enter in the name related to your site into the <strong>Value</strong> field. In my case, I entered <code>custardbelly.com</code>, but it does not have to specifically be your domain name.</li>
<li>Click <strong>Next: Configure Security Group</strong></li>
<li>Under <em>Assign a security group</em>, select <strong>Create new security group</strong><ul>
<li>You will need to create security group with - at least - the following ports available: <code>22</code>, <code>80</code>, <code>443</code></li>
</ul>
</li>
<li>Use the <strong>Add Rule</strong> button to add protocol types and ports<br><img style="width: 100%; max-width: 360px; border: 1px solid #999; padding: 10px;" src="https://www.custardbelly.com/images/https_security_group.png" alt="EC2 Security Groups"></li>
<li>Click <strong>Review and Launch</strong></li>
<li>On the next page, accept the review and click <strong>Launch</strong></li>
<li>If you do not already have a key pair on your system through your AWS account that you want to associated with your site, then <strong>Create a new key pair</strong>; otherwise, <strong>Choose an existin key pair</strong>.</li>
</ol>
<p>Once accepting the license agreement, you should be redirected to the <em>EC2 Dashboard:Instances</em> page and see your new instance listed - most likely spinning up with an <em>Initializing...</em> note.</p>
<p>We&#39;ll wait until that is finished initializing before SSH&#39;ing into it, but before we do that, we can assign an Elastic IP to the instance so that the IP is not potentially change by AWS at any time.</p>
<h2 id="defining-an-elastic-ip">Defining an Elastic IP</h2>
<p>By associating an Elastic IP to an AWS instance, you are essentially reserving a static IP for your instance that won&#39;t change as long as it is associated in your account.</p>
<blockquote>
<p>I won&#39;t go into detail about Elastic IPs, so please refer to the documentation if interested: <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html" target="_blank">http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html</a>.</p>
</blockquote>
<p>To assign an Elastic IP to your newly launched instance:</p>
<ol>
<li>From the <em>EC2 Dashboard</em> select the <strong>Network &amp; Security: Elastic IPs</strong> from the left-hand tree menu</li>
<li>Select <strong>Allocate New Address</strong></li>
<li>From the modal window, click <strong>Yes, Allocate</strong></li>
<li>Click on the newlly added address in the listing</li>
<li>From the <em>Actions</em> button, above the listing_, select <strong>Associate Address</strong></li>
<li>In the <em>Associate Address</em> dialog, start typing the name Value giving to the newly launched instance in the <strong>Instance</strong> field</li>
<li>Once you see the entry for your newly launched instance from the previous section, select it and fill the <strong>Instance</strong> field value<ul>
<li>In my case, that is <code>custardbelly.com</code></li>
</ul>
</li>
<li>Click <strong>Associate</strong></li>
<li>Upon association of the new Elastic IP, you should see your <strong>Instance</strong> show up in the listing entry</li>
</ol>
<p>At this point, if you navigate back to <strong>Instances:Instances</strong> from the <em>EC2 Dashboard</em>, you should see your newly launched instance listed, and the <strong>Public IP</strong> field should display the associated Elastic IP and appear in blue.</p>
<h2 id="site-files">Site Files</h2>
<p>The main site files are hand curated and live in a <a href="https://github.com/bustardcelly/custardbelly-dot-com" target="_blank">github repo</a>. The blog site is generated from markdown and has its own <a href="https://github.com/bustardcelly/blog-to-markdown" target="_blank">github repo</a>, as well; its a bit overblown for its purpose now, but at the time it was used as a tooling system to generate markdown from Wordpress post as described in <a href="https://www.custardbelly.com/blog/blog-posts/2014/01/03/so-long-wordpress/index.html" target="_blank">a previous article</a>.</p>
<p>Using the newly associated IP for the instance and the key generated, I SSH&#39;d into the box and pulled down my site sources. For example:</p>
<pre><code>$ ssh ~/<span class="hljs-preprocessor">.ssh</span>/custardbelly<span class="hljs-preprocessor">.pem</span> ubuntu@xxx<span class="hljs-preprocessor">.xxx</span><span class="hljs-preprocessor">.xxx</span><span class="hljs-preprocessor">.xxx</span>
</code></pre><p>Since this blog and the main site are static files and all it took was to do some <code>git clone</code>&#39;s on my new instance and move some things to their respective places. But first I had to install <code>git</code>:</p>
<pre><code>$ <span class="hljs-built_in">sudo</span> apt-get update
$ <span class="hljs-built_in">sudo</span> apt-get install git
</code></pre><p>Once I installed <strong>git</strong> and pulled down my repos, I moved the main site files to <code>/var/www/custardbelly.com/public_html</code> and the blog files to <code>/var/www/blog</code>. Then I added a sym-link from <code>/var/www/custardbelly.com/public_html/blog</code> to <code>/var/www/blog</code>, so that whenever I needed to get updates to the blog on my server, I didn&#39;t have to fuddle about in the main site&#39;s directory.</p>
<blockquote>
<p>This was a rudimentary first pass on getting my site and blog set up. In the future, I will add deployment strategies to these repositories, either in the form of a Continuous Integration server or with tools such as <a href="https://github.com/shipitjs/shipit" target="_blank">shipit</a>. Props to <a href="https://twitter.com/kylekellogg" target="_blank">Kyle Kellogg</a> on opening my eyes to it.</p>
</blockquote>
<p><em>If you do not maintain your site in a Version Control System (VCS), you may need to go through other avenues to get your site files onto the instance...</em></p>
<p>With the site and blog files up on the new instance, it was time to tell the world to look there when they requested it.</p>
<hr>

<h1 id="transferring-dns-records">Transferring DNS Records</h1>
<p>When defining DNS Records for my website, I had used the administrative control panel provided by my previous VPS host to register my domain; it was pretty straight-forward and allowed me to easily enter in the records to my domain name provider.</p>
<p>Now, when broaching the subject of Domain Name Servers (DNS) and how your browser actually resolves a request with a domain name to an IP, my eyes start to glaze over and the mind wonders. In other words, I am of no authority to actually speak on the topic so I hope you check out some of these articles for a better understanding:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Domain_Name_System" target="_blank">https://en.wikipedia.org/wiki/Domain_Name_System</a></li>
<li><a href="https://webhostinggeeks.com/guides/dns/" target="_blank">https://webhostinggeeks.com/guides/dns/</a></li>
<li><a href="https://pressable.com/blog/2014/12/23/dns-record-types-explained/" target="_blank">https://pressable.com/blog/2014/12/23/dns-record-types-explained/</a></li>
<li><a href="https://www.youtube.com/watch?v=3EvjwlQ43_4" target="_blank">DNS Resolution, Step By Step (video)</a></li>
</ul>
<p>That said, with what little I do understand, I know I needed to associate DNS records - specifically NS values - with my domain name purchased from my current Domain Name Provider.</p>
<blockquote>
<p>I use <a href="https://directnic.com/" target="_blank">directnic</a> to buy my domains, but I won&#39;t go into how you define the DNS values for your domain because I am certain it will differ from provider to provider.</p>
</blockquote>
<p>Neverless, I had to go into the administrative console of my Domain Name Provider account and assign the DNS records created in the next sections using <strong>Amazon Route 53</strong>.</p>
<h2 id="amazon-route-53">Amazon Route 53</h2>
<p>Until I started investigating moving my site to an EC2 Instance so I had more control over how my site is served, I honestly never heard of <strong>Amazon Route 53</strong>. The <a href="http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/Welcome.html">dcoumentation for Amazon Route 53</a> states that it provides three main functions:</p>
<ul>
<li>Domain Registration</li>
<li>Domain Name System (DNS) service</li>
<li>Health checking</li>
</ul>
<p>I am only concerned about the DNS service side of the Route 53 as I have already purchased my domain and don&#39;t consider my site <em>critical</em> enough to set up CloudWatch for alarms on my site not being available.</p>
<blockquote>
<p>When I went about moving my domain service to Amazon Route 53, I referred to the following documentation: <a href="http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/MigratingDNS.html" target="_blank">http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/MigratingDNS.html</a>.</p>
</blockquote>
<p>I won&#39;t rehash the listing of steps for what I performed from the link above, because they are pretty much what I followed. The only difference was I didn&#39;t obtain a DNS configuration from my DNS Provider and import it. Instead I:</p>
<ol>
<li>Created a new <em>Hosted Zone</em></li>
<li>Upon creation, selected <em>Create Record Set</em></li>
<li>Created a Record Set with <strong>Type: A - IPv4 Address</strong> with a value of the Elastic IP of the AWS Instance set up previously</li>
<li>Clicked <em>Create</em></li>
<li>Created a Record Set with <strong>Type: CNAME</strong> with the <code>www</code> name and a value of the naked domain</li>
<li>Clicked <em>Create</em></li>
</ol>
<p>I then had a <em>Hosted Zone</em> for <code>custardbelly.com</code> with 3 record entries for: <strong>NS</strong>, <strong>A</strong> and <strong>CNAME</strong>.</p>
<p>After creating a <em>Hosted Zone</em> in Amazon Route 53, I took the auto-generated <strong>NS</strong> values (there were 4 in total) and set those as the the <em>Nameserver</em> records for my domain on my Domain Name registrar.</p>
<p><img style="width: 100%; max-width: 280px; border: 1px solid #999; padding: 10px;" alt="DNS records in DNR" src="https://custardbelly.com/images/https_dns_records.png"></p>
<h2 id="check-with-dig">Check with dig</h2>
<p>The new DNS for my domain got resolved rather quickly compared to the many times I have done this for domains before; it look about 3 minutes, but I think I got lucky. Anyway, I checked using the <code>dig</code> utility to make sure it was up and associated with the Elastic IP I assigned:</p>
<pre><code><span class="hljs-variable">$ </span>dig custardbelly.com
</code></pre><p>Response:</p>
<pre><code>; &lt;&lt;&gt;&gt; DiG 9<span class="hljs-class">.8</span><span class="hljs-class">.3-P1</span> &lt;&lt;&gt;&gt; custardbelly<span class="hljs-class">.com</span>
;; global options<span class="hljs-value">: +cmd
;</span>; Got answer<span class="hljs-value">:
;</span>; -&gt;&gt;<span class="hljs-tag">HEADER</span>&lt;&lt;- opcode<span class="hljs-value">: QUERY, status: NOERROR, id: <span class="hljs-number">58244</span>
;</span>; flags<span class="hljs-value">: qr rd ra;</span> QUERY<span class="hljs-value">: <span class="hljs-number">1</span>, ANSWER: <span class="hljs-number">1</span>, AUTHORITY: <span class="hljs-number">0</span>, ADDITIONAL: <span class="hljs-number">0</span>

;</span>; QUESTION <span class="hljs-tag">SECTION</span><span class="hljs-value">:
;</span>custardbelly<span class="hljs-class">.com</span>.    IN  <span class="hljs-tag">A</span>

;; ANSWER <span class="hljs-tag">SECTION</span><span class="hljs-value">:
custardbelly.com. <span class="hljs-number">300</span> IN  A xxx.xxx.xxx.xxx

;</span>; Query <span class="hljs-tag">time</span><span class="hljs-value">: <span class="hljs-number">105</span> msec
;</span>; SERVER<span class="hljs-value">: <span class="hljs-number">75.75</span>.<span class="hljs-number">75.75</span><span class="hljs-hexcolor">#53</span>(<span class="hljs-number">75.75</span>.<span class="hljs-number">75.75</span>)
;</span>; WHEN<span class="hljs-value">: Wed Feb <span class="hljs-number">10</span> <span class="hljs-number">20</span>:<span class="hljs-number">39</span>:<span class="hljs-number">01</span> <span class="hljs-number">2016</span>
;</span>; MSG SIZE  rcvd<span class="hljs-value">: <span class="hljs-number">50</span></span>
</code></pre><p>The Elastic IP associated with the AWS Instance I set up for my site is now shown as the <strong>A</strong> response from a <code>dig</code> request - the same I defined in the <strong>A</strong> field of my <em>Hosted Zone</em> record in Amazon Route 53.</p>
<hr>

<h1 id="setting-up-nginx">Setting Up nginx</h1>
<p>Even though the DNS resolves the domain to the IP assocated with the AWS Instance, there is nothing - at the moment, during this setup - to be displayed when making a request from a browser.</p>
<h2 id="installation">Installation</h2>
<p>To install <strong>nginx</strong> on the new box, I ssh&#39;d into the box and issued the following:</p>
<pre><code>$ <span class="hljs-built_in">sudo</span> apt-get install nginx
</code></pre><p>That should install <strong>nginx</strong> and start the service, with its default configuration on port 80. I visited my site again - at <a href="http://custardbelly.com">http://custardbelly.com</a> - and saw the following page:</p>
<p><img style="width: 100%; max-width: 340px; border: 1px solid #999; padding: 10px;" alt="Default nginx page" src="https://custardbelly.com/images/https_nginx_page.png"></p>
<p>In order to point to the files I uploaded for my site, I needed to then add <code>custardbelly.com</code> to the <em>sites-available</em> and <em>sites-enabled</em> directories of the <strong>nginx</strong> configuration install.</p>
<h2 id="configuration">Configuration</h2>
<p>By default, <strong>nginx</strong> sets up the site on port 80 by defining a <em>default</em> configuration defined in <strong>/etc/nginx/sites-available</strong> and exposed in <strong>/etc/nginx/sites-enabled</strong>. In order to get nginx to point to the site files I uploaded to <strong>/var/www/custardbelly.com/public_html</strong> in a previous section of this post, I need to add a new file to <strong>/etc/nginx/sites-available</strong> and sym-link it in <strong>/etc/nginx/sites-enabled</strong>.</p>
<p>To do that, I ssh&#39;d into my box and:</p>
<pre><code>$ <span class="hljs-built_in">sudo</span> service nginx stop
$ <span class="hljs-built_in">sudo</span> touch /etc/nginx/sites-available/custardbelly.com
$ <span class="hljs-built_in">sudo</span> vim /etc/nginx/sites-available/custardbelly.com
</code></pre><p>And in <strong>vim</strong> editor, entered the following:</p>
<pre><code>server {
  listen <span class="hljs-number">80</span> default_server<span class="hljs-comment">;</span>
  listen [::]:<span class="hljs-number">80</span> default_server<span class="hljs-comment">;</span>

  server_name custardbelly<span class="hljs-preprocessor">.com</span> www<span class="hljs-preprocessor">.custardbelly</span><span class="hljs-preprocessor">.com</span><span class="hljs-comment">;</span>

  root /var/www/custardbelly<span class="hljs-preprocessor">.com</span>/public_html<span class="hljs-comment">;</span>
  index index<span class="hljs-preprocessor">.html</span> index<span class="hljs-preprocessor">.htm</span><span class="hljs-comment">;</span>
}
</code></pre><p>I wrote and quit out of the <strong>vim</strong> editor, then removed the <em>default</em> and added <em>custardbelly.com</em> to the <strong>sites-enabled</strong>:</p>
<pre><code>$ sudo rm <span class="hljs-attribute">-f</span> /etc/nginx/sites<span class="hljs-attribute">-enabled</span>/default
$ sudo ln <span class="hljs-attribute">-s</span> /etc/nginx/sites<span class="hljs-attribute">-available</span>/custardbelly<span class="hljs-built_in">.</span>com /etc/nginx/sites<span class="hljs-attribute">-enabled</span>/custardbelly<span class="hljs-built_in">.</span>com
</code></pre><p>After adding <code>custardbelly.com</code> to the enabled site for <strong>nginx</strong> and exposed on port 80, I restarted <strong>nginx</strong>:</p>
<pre><code>$ <span class="hljs-built_in">sudo</span> service nginx start
</code></pre><p>Now navigating in a browser to <a href="http://custardbelly.com">http://custardbelly.com</a> - or its <em>www</em> domain - resulted in being served up the index page moved to <strong>/var/www/custardbelly.com/public_html/index.html</strong>.</p>
<p>With the non-secure site files setup under <strong>nginx</strong>, it was time to generate a certificate and serve the site under <strong>https</strong>.</p>
<hr>

<h1 id="generating-certificates-from-let-s-enrypt">Generating Certificates from Let&#39;s Enrypt</h1>
<p><a href="https://letsencrypt.org/">Let&#39;s Encrypt</a> is a relatively recent Certificate Authority (CA) that boasts being free, automated and open. Essentially, it allows you to manage certificates for your site - to be hosted under HTTPS - without having to go through a 3rd-party vendor.</p>
<p>To generate a certificate through <a href="https://letsencrypt.org/">Let&#39;s Encrypt</a> for my domain - both naked and <strong>www</strong> - I cloned the repo and issued a cert for my &quot;standalone&quot; webserver... but first I stopped <strong>nginx</strong> again:</p>
<pre><code>$ <span class="hljs-built_in">sudo</span> service nginx stop
</code></pre><p>... then:</p>
<pre><code>$ git clone https://github<span class="hljs-preprocessor">.com</span>/letsencrypt/letsencrypt
$ cd letsencrypt
$ ./letsencrypt-auto certonly --standalone --email support@yourdomain<span class="hljs-preprocessor">.com</span> -d custardbelly<span class="hljs-preprocessor">.com</span> -d www<span class="hljs-preprocessor">.custardbelly</span><span class="hljs-preprocessor">.com</span>
</code></pre><blockquote>
<p><code>support@yourdomain.com</code> should be an actual email address at which you want to be notified in case of certificate expiration.</p>
</blockquote>
<p>I then verified that the cert for <code>custardbelly.com</code> was created by issuing:</p>
<pre><code>$ sudo ls /etc/letsencrypt/live/

<span class="hljs-keyword">...</span>

&gt; root root <span class="hljs-number">4096</span> Feb  <span class="hljs-number">10</span> <span class="hljs-number">19</span>:<span class="hljs-number">39</span> custardbelly.com
</code></pre><p>The <code>custardbelly.com</code> is a directory with key files to be used in defining how to provide SSL for your server in the configurations, as described in the next section.</p>
<h2 id="updating-nginx-site-configuration">Updating nginx Site Configuration</h2>
<p>Now that I generated a cert using <a href="https://letsencrypt.org/">Let&#39;s Encrypt</a> to be able to serve my site under HTTPS, it was time to update the site configuration for <strong>nginx</strong>.</p>
<p>I opened up my <strong>/etc/nginx/sites-available/custardbelly.com</strong> file and edited it to include a redirect to HTTPS:</p>
<pre><code>server {
  listen <span class="hljs-number">80</span> default_server<span class="hljs-comment">;</span>
  listen [::]:<span class="hljs-number">80</span> default_server ipv6only=on<span class="hljs-comment">;</span>

  server_name www<span class="hljs-preprocessor">.custardbelly</span><span class="hljs-preprocessor">.com</span> custardbelly<span class="hljs-preprocessor">.com</span><span class="hljs-comment">;</span>

  return <span class="hljs-number">301</span> https://www<span class="hljs-preprocessor">.custardbelly</span><span class="hljs-preprocessor">.com</span>$request_uri<span class="hljs-comment">;</span>
}

server {
  listen [::]:<span class="hljs-number">443</span> ssl<span class="hljs-comment">;</span>
  listen <span class="hljs-number">443</span> ssl<span class="hljs-comment">;</span>

  ssl_certificate /etc/letsencrypt/live/custardbelly<span class="hljs-preprocessor">.com</span>/fullchain<span class="hljs-preprocessor">.pem</span><span class="hljs-comment">;</span>
  ssl_certificate_key /etc/letsencrypt/live/custardbelly<span class="hljs-preprocessor">.com</span>/privkey<span class="hljs-preprocessor">.pem</span><span class="hljs-comment">;</span>

  root /var/www/custardbelly<span class="hljs-preprocessor">.com</span>/public_html<span class="hljs-comment">;</span>
  index index<span class="hljs-preprocessor">.html</span> index<span class="hljs-preprocessor">.htm</span><span class="hljs-comment">;</span>
}
</code></pre><p>Essentially, I am forwarding all requests on port <strong>80</strong> to <strong>443</strong>. You will also note the entries for <code>ssl_certificate</code> and <code>ssl_certificate_key</code> which point to the cert generated using <a href="https://letsencrypt.org/">Let&#39;s Encrypt</a>.</p>
<blockquote>
<p>This is a very rudmentary example of what your site configuration should look like under nginx, but am keeping the minimum in relation to the task at hand.</p>
</blockquote>
<p>I then restarted <strong>nginx</strong>:</p>
<pre><code>$ <span class="hljs-built_in">sudo</span> service nginx start
</code></pre><p>Navigating to <a href="https://www.custardbelly.com/blog">https://www.custardbelly.com/blog</a> in a browser and it showed up! Checked to make sure that the redirect under HTTP request worked as well and, sure enough, my site is now accessible under HTTPS :)</p>
<p>Now the only issue at this point is that a lot of my resources in pages point to HTTP endpoints directly... that is a sore point for a lot of browsers and results in the dreaded <span style="color: #ff0000;"><strong>Mixed Content</strong></span>.</p>
<hr>

<h1 id="setting-up-my-site-to-be-served-under-https">Setting up my site to be served under HTTPS</h1>
<p>Once you move your site to be served up under HTTPS and then point your favorite browser to your site, you may find that it does not look or function as it did previously - as it did for me. That was because a lot of the resources on the pages of my site were being blocked because the site under HTTPS was trying to make requests for content under HTTPS; such resources were CSS files, Javascript files, images, etc.</p>
<p>If you were to open up Console panel of the developer tools in your browser when pointing to your site under HTTPS, you most likely will see a lot of <span style="color: #ff0000;"><strong>Mixed Content</strong></span> entries. In my case, Google Chrome was blocking requests over differing protocols, even if I was making calls relative to the page (i.e., not cross-site).</p>
<p>Luckily enough, for me, I was using templates for my blog and only had to change the link references in a single template and regenerate all my posts. Once I had done that, all the pages rendered as they did previously when served under HTTP.</p>
<blockquote>
<p>Read more about Mixed Content and Google Chrome <a href="https://developers.google.com/web/fundamentals/security/prevent-mixed-content/what-is-mixed-content">here</a>.</p>
</blockquote>
<hr>

<h1 id="conclusion">Conclusion</h1>
<p>Getting this site under HTTPS using using <a href="https://aws.amazon.com/">Amazon Web Services</a> to host and <a href="https://letsencrypt.org/">Let&#39;s Encrypt</a> to secure was quick and painless - in just a few hours I was up and running!</p>
<p>Hopefully this article will help anyone else out there interested in moving their site from HTTP to HTTPS. Good luck!</p>
<blockquote>
<p>If you do find any content no longer available, please let me know in the comments. Much appreciated!</p>
</blockquote>
<hr>

<h1 id="references">References</h1>
<ul>
<li><a href="https://https.cio.gov/">https://https.cio.gov/</a></li>
<li><a href="https://www.smashingmagazine.com/2016/02/breaking-it-down-to-the-bits-how-the-internet-dns-and-https-work/">https://www.smashingmagazine.com/2016/02/breaking-it-down-to-the-bits-how-the-internet-dns-and-https-work/</a></li>
<li><a href="http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/Welcome.html">http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/Welcome.html</a></li>
<li><a href="http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/MigratingDNS.html">http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/MigratingDNS.html</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-14-04-lts">https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-14-04-lts</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-14-04">https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-14-04</a></li>
<li><a href="https://developers.google.com/web/fundamentals/security/prevent-mixed-content/what-is-mixed-content">https://developers.google.com/web/fundamentals/security/prevent-mixed-content/what-is-mixed-content</a></li>
</ul>
]]></description><link>https://www.custardbelly.com/blog/blog-posts/2016/02/04/http-to-https/index.html</link><guid isPermaLink="true">https://www.custardbelly.com/blog/blog-posts/2016/02/04/http-to-https/index.html</guid><dc:creator><![CDATA[Todd Anderson]]></dc:creator><pubDate>Invalid Date</pubDate></item><item><title><![CDATA[flood-pi: Flood detection on Raspberry Pi]]></title><description><![CDATA[<p>A lot has happened over the course current year. Among the biggest changes, we left Boston for Vermont! We have begun to settle in here in the beatuiful Champlain Valley and, of course, my oldest is enrolled in hockey lessons - a sport i know very little about, but am excited to learn from him.</p>
<p>As is expected from a big move, we have found outselves in different surroundings and different living spaces. We are no longer 4 people cramped in a tiny 2-bedroom condo along the train line in Brighton, MA; we are now 4 people in a ranch house with noone above or below us to complain about taking off their loud shoes when the baby is sleeping. </p>
<p>While the extra space of a house is wonderful, tit comes with additional maintenance and care over renting an apartment. For instance, we never had a basement in our previous apartments and never had to worry about flooding or failures in a sump pump. Now we do. And we have had a handful of instances when it has occurred. While it is true that we have and will continue to have qualified people locate the source of the problem, I thought - in the meantime - it would be a fun little project to setup something that could alert me to possible water starting to accumulate in the basement.</p>
<p><img src="https://custardbelly.com/images/flood_pi_flood.jpg" alt="a flood!"></p>
<p>And from that <a href="https://github.com/bustardcelly/flood-pi">flood-pi</a> was born!</p>
<h2 id="flood-pi">flood-pi</h2>
<p><strong>flood-pi</strong> is an open source Python project meant to be run on a <a href="http://www.raspberrypi.org/">Raspberry Pi</a>. The Github repo for <a href="https://github.com/bustardcelly/flood-pi">flood-pi</a> has some more technical details, but essential <strong>flood-pi</strong> detects a &quot;flood&quot; by reading an analog value from a circuit completed by water.</p>
<p>The basic premise is that two leads with copper plates at the end (originally nails in my prototype) are set level to the floor of the basement and spaced about a inch apart from each other. One lead is connected to the power while the other lead is connected to the between the first pin of the mcp3008 and the ground. As water comes between the leads (most likely from the start of a flood), the circuit is complete and a reading from 0 to 1024 is read through the ADC. Some low values may come in but should be considered not a &quot;positive&quot; detection. As well, some high values may come in which typically means that somehow the leads started touching each other and be considered not a &quot;positive&quot; detection, either. In correlation to the distance between the leads, there is a middleground of values that would be considered a &quot;positive&quot; detection.</p>
<p>When a &quot;positive&quot; detection occurs, <strong>flood-pi</strong> then sends out an email to alert me. Then I can take appropriate action.</p>
<p><em>There is no analog in on <a href="http://www.raspberrypi.org/">Raspberry Pi</a>, but i have set up projects reading potentiometers using the <a href="https://learn.adafruit.com/reading-a-analog-in-and-controlling-audio-volume-with-the-raspberry-pi">mcp3008 as described here on adafruit</a>, so I knew i could use that setup for this project.</em></p>
<h3 id="project">project</h3>
<p>Here&#39;s some pictures of the project:</p>
<p>The leads.</p>
<p><img src="https://custardbelly.com/images/flood_pi_leads.jpg" alt="leads"></p>
<p><a href="http://www.raspberrypi.org/">Raspberry Pi</a>, running <a href="http://www.raspberrypi.org/downloads/">Debian-Wheezy</a> with the <a href="https://github.com/bustardcelly/flood-pi">flood-pi</a> program running as a daemon. <a href="http://www.edimax.com/edimax/merchandise/merchandise_detail/data/edimax/global/wireless_adapters_n150/ew-7811un">Edimax WiFi adapter</a> for the interweb-bings and email-ery.</p>
<p><img src="https://custardbelly.com/images/flood_pi_rasp.jpg" alt="pi"></p>
<p>The mcp3008 on its own breakout. (<strong>i soldered it up all by myself!</strong>)</p>
<p><img src="https://custardbelly.com/images/flood_pi_mcp3008.jpg" alt="mcp3008"></p>
<h3 id="installation">installation</h3>
<p>Here&#39;s some pictures of its installation in the basement:</p>
<p><img src="https://custardbelly.com/images/flood_pi_install3.jpg" alt="full install"></p>
<p><img src="https://custardbelly.com/images/flood_pi_install1.jpg" alt="module install"></p>
<p><img src="https://custardbelly.com/images/flood_pi_install2.jpg" alt="lead install"></p>
<p>We, thankfully, haven&#39;t been able to get a <em>true</em> &quot;positive&quot; reading since its installation, but I have submersed the leads in water for a short time to ensure i was being sent emails :)</p>
<h2 id="flood-pi-admin">flood-pi-admin</h2>
<p>I couldn&#39;t just stop at getting emails. I am empoyed as a software developer by trade, so I <em>had</em> to keep writing software.</p>
<p>I wanted to aggregate the readings from <a href="https://github.com/bustardcelly/flood-pi">flood-pi</a> and get an overview of its workings (or failure of workings if it may come to that). I don&#39;t know if there could be any patterns found from the data as to when the sump pump fails or whatnot, but more data can&#39;t hurt, can it?</p>
<p>As such, <a href="https://github.com/bustardcelly/flood-pi-admin">flood-pi-admin</a> was born!</p>
<h3 id="about-flood-pi-admin">about flood-pi-admin</h3>
<p><a href="https://github.com/bustardcelly/flood-pi-admin">flood-pi-admin</a> is a NodeJS-based server that provides a RESTful API for POSTing and accessing daatbeing reported by <a href="https://github.com/bustardcelly/flood-pi">flood-pi</a>. There is more detailed information on the <a href="https://github.com/bustardcelly/flood-pi-admin">Github repo for the project</a>, but it has endpoints for the <strong>flood-pi</strong> detector to post confiuguration and reading data as well as two main routes for accessing information about past and current conditions. </p>
<p><strong>It&#39;s pretty bare-bones at the moment, but i plan to add new features as they are required (or requested).</strong></p>
<h3 id="charts">charts</h3>
<p>The landing page and <em>/level?range=(day|week|year|all)</em> provide chart data with the level readings:</p>
<p><img src="https://custardbelly.com/images/flood_pi_chart.png" alt="chart data"></p>
<p>The red band across the middle of the chart is the &quot;positive&quot; value range provided from the <strong>flood-pi</strong> and should be considered possible flood detection. As mentioned previously, lower values may come in but not high enough to be considered &quot;positive&quot;; additionally, high values may come in which may actually mean that the leads have somehow started touching each other rather than completing the circuit with water.</p>
<h3 id="isitflooded">isitflooded</h3>
<p>There is also a direct page at <em>/isitflooded</em> that will let you know if it is currently considered flooded or not:</p>
<p><img src="https://custardbelly.com/images/flood_pi_no.png" alt="current detection"></p>
<p>It also reports last reporting time and whether or not it should alert you to the <a href="https://github.com/bustardcelly/flood-pi">flood-pi</a> no longer reporting information.</p>
<h2 id="conclusion">conclusion</h2>
<p>I had a lot of fun taking a small idea of being notified the nextr time their is water in the basement and transferring it to an actual physical devices that can send out emails upon completion of a circuit. Plus, i got better at soldering - i know the ADC breakout is a small assembly, but it made me happy the way it turned out.</p>
<p>If you have occasional water in your basement and have an interest in <a href="http://www.raspberrypi.org/">Raspberry Pi</a>, i hope you check out the <a href="https://github.com/bustardcelly/flood-pi">flood-pi</a> program and install it. And if you have yourself a VPS, feel free to also setup the <a href="https://github.com/bustardcelly/flood-pi-admin">flood-pi-admin</a> on it to access level reading data.</p>
<p>Now, onto the next little pet project i have in mind:)</p>
<p>Cheers!</p>
]]></description><link>https://www.custardbelly.com/blog/blog-posts/2014/12/4/flood-pi/index.html</link><guid isPermaLink="true">https://www.custardbelly.com/blog/blog-posts/2014/12/4/flood-pi/index.html</guid><dc:creator><![CDATA[Todd Anderson]]></dc:creator><pubDate>Invalid Date</pubDate></item><item><title><![CDATA[gulp-rev-append: simple cache-busting plugin]]></title><description><![CDATA[<p>I just released <a href="https://www.npmjs.org/package/gulp-rev-append">gulp-rev-append</a>, a simple cache-busting plugin for <a href="http://gulpjs.org">gulp</a> that appends a query-string file hash to script and stylesheet dependencies in HTML files.</p>
<p>There are <a href="https://www.npmjs.org/search?q=gulp-rev">several other cache-busting plugins</a> currently available by some awesome developers and I suggest you look at those to fit your project&#39;s need.</p>
<p>For my particular project in which I decided to create the <a href="https://www.npmjs.org/package/gulp-rev-append">gulp-rev-append</a> plugin, I was looking to:</p>
<ul>
<li>enable cache-busting by appending a file hash on query string</li>
<li>not require additionally markup commenting to declare dependencies to be modified</li>
<li>not generate an additional manifest to be a dependency in file access for production-level application</li>
</ul>
<p>I was trying to develop a simple web-based mobile site on a desktop while testing on devices and cache-ing was giving me a headache. I did not want to modify my workflow and build to accommodate an addition cache-manifest, nor did I foresee my work requirng a more robust cache-busting technique that the other plugins provided. </p>
<p><em>If this project was to be in millions of hands out in production, I would certainly use a file revving solution such as <a href="https://www.npmjs.org/package/gulp-rev">https://www.npmjs.org/package/gulp-rev</a>.</em></p>
<h2 id="usage">Usage</h2>
<p>The <a href="https://github.com/bustardcelly/gulp-rev-append">gulp-rev-append</a> plugins allows for appending a query-string file hash to dependencies declared in html files defined using the following regex: <code>(?:href|src)=&quot;(.*)[\?]rev=(.*)[\&quot;]</code></p>
<p>That&#39;s fancy talk for any stylesheet or script declarations that are declared in an html file such as the following:</p>
<pre><code><span class="hljs-doctype">&lt;!doctype html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">link</span> <span class="hljs-attribute">rel</span>=<span class="hljs-value">"stylesheet"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text/css"</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"style/style-one.css?rev=@@hash"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"script/script-one.js?rev=@@hash"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"script/script-two.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>hello, world!<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"script/script-three.js?rev=@@hash"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span>
</code></pre><p>will turn into something similar as the following after running <code>gulp-rev-append</code>:</p>
<pre><code><span class="hljs-doctype">&lt;!doctype html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">link</span> <span class="hljs-attribute">rel</span>=<span class="hljs-value">"stylesheet"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text/css"</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"style/style-one.css?rev=d65aaba987e9c1eefeb4be9cfd34e0de"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"script/script-one.js?rev=17a5da6c8a2d875cf48aefb722eefa07"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"script/script-two.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>hello, world!<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"script/script-three.js?rev=5cadf43edba6a97980d42331f9fffd17"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span>
</code></pre><p>Any subsequent runs of the <code>gulp-rev-append</code> file will change the output <em>only</em> if the target file(s) declared have been modified. This is because the revision hash is computed using the target file contents.</p>
<p>The only requirement is that the dependency to be appended with the hash be declared using <code>?rev=</code>. The <code>@@hash</code> is not required, and any value will be overriden as the dependency file contents change.</p>
<h3 id="installation">Installation</h3>
<pre><code>$ npm install gulp<span class="hljs-attribute">-rev</span><span class="hljs-attribute">-append</span> <span class="hljs-subst">--</span>save<span class="hljs-attribute">-dev</span>
</code></pre><h3 id="declaration">Declaration</h3>
<p><em>gulpfile.js</em></p>
<pre><code><span class="hljs-keyword">var</span> rev = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gulp-rev-append'</span>);

gulp.task(<span class="hljs-string">'rev'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  gulp.src(<span class="hljs-string">'./index.html'</span>)
    .pipe(rev())
    .pipe(gulp.dest(<span class="hljs-string">'.'</span>));
});
</code></pre><h3 id="execution">Execution</h3>
<pre><code><span class="hljs-variable">$ </span>gulp rev
</code></pre><h2 id="a-word-of-warning">A word of warning</h2>
<p>Using query strings to cache-bust dependencies isn&#39;t fool proof. These are some great articles that explain why:</p>
<p><a href="https://developers.google.com/speed/docs/best-practices/caching?csw=1#LeverageProxyCaching">Google | Leverage Proxy Cache Article</a><br><a href="http://www.stevesouders.com/blog/2008/08/23/revving-filenames-dont-use-querystring/">Steve Souders | Revving Filenames: don&#39;t use querystring</a></p>
<p>As mentioned previously, file revving is a more robust cache-busting technique and there is already a great <a href="http://gulpjs.org">gulp</a> plugin out there called <a href="https://www.npmjs.org/package/gulp-rev">https://www.npmjs.org/package/gulp-rev</a> to fit your development needs.</p>
<h2 id="project">project</h2>
<p><a href="https://github.com/bustardcelly/gulp-rev-append">gulp-rev-append</a></p>
<p>Cheers.</p>
]]></description><link>https://www.custardbelly.com/blog/blog-posts/2014/03/18/gulp-rev-append/index.html</link><guid isPermaLink="true">https://www.custardbelly.com/blog/blog-posts/2014/03/18/gulp-rev-append/index.html</guid><dc:creator><![CDATA[Todd Anderson]]></dc:creator><pubDate>Invalid Date</pubDate></item><item><title><![CDATA[Running Browser-Based CucumberJS Specs in Testling]]></title><description><![CDATA[<p>In my <a href="https://custardbelly.com/blog/blog-posts/2014/02/10/cucumberjs-tests-browser/index.html">previous</a> <a href="https://custardbelly.com/blog/blog-posts/2014/02/12/cucumberjs-browser-update/index.html">posts</a> I discuss bringing <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> specs to the browser using the <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> CLI tool. In this post I intend to address how to use the format reporting options of the <strong>cucumberjs-browser</strong> tool to enable integration with the <a href="https://ci.testling.com/">testling</a> automated cross-browser testing tool to run your specs in various browser environment targets that you may not have installed on your own system.</p>
<h2 id="requirements">Requirements</h2>
<p>For the purposes of this article, it is assumed that you are knowledgable of <a href="http://nodejs.org">node</a> and <a href="http://npmjs.org">npm</a> and familiar with creating feature specs for <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a>. </p>
<p>To view examples of features and step definitions for a browser-based application, please visit the <a href="https://github.com/bustardcelly/cucumberjs-examples">cucumberjs-examples</a> repo, from which this post will use to demonstrate integrating the generated testrunner from <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> with <a href="https://ci.testling.com/">testling</a>.</p>
<h2 id="cucumberjs-browser">cucumberjs-browser</h2>
<p>The <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> CLI tool provides the ability to run your feature specs in the browser by bundling your features, steps and support files - written in the usual way you would - to be run and evaluated at runtime by the browser-based <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> testrunner</p>
<p>To install <strong>cucumberjs-browser</strong>:</p>
<pre><code>$ npm install <span class="hljs-attribute">-g</span> cucumberjs<span class="hljs-attribute">-browser</span>
</code></pre><p><em>you may need to <code>sudo</code></em></p>
<p>After installation, the <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> will be accessible on the command-line using <code>cucumberjs-browser</code> and can be run within any directory that has <strong>Features</strong> and <strong>Step Definitions</strong> (along with optional support files) that can be consumed by <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a>.</p>
<p>The <strong>cucumberjs-browser</strong> CLI tool can be run with the following options:</p>
<pre><code>$ <span class="hljs-tag">cucumberjs-browser</span> <span class="hljs-attr_selector">[-o outdir]</span> <span class="hljs-attr_selector">[-f format]</span> <span class="hljs-attr_selector">[--tmpl template]</span> <span class="hljs-attr_selector">[--features features]</span>
</code></pre><p>Though it is strongly encouraged to provide a custom template using the <code>--tmpl</code> option, for the purpose of this article, we will focus on the format (<code>-f</code>) option. As of the writing of this article, the following format options are available:</p>
<ul>
<li>ui</li>
<li>tap</li>
<li>testem</li>
<li>saucelabs</li>
</ul>
<p>For the purpose of this article, we will be discussing the <a href="http://en.wikipedia.org/wiki/Test_Anything_Protocol">TAP</a> format option value.</p>
<p><em>For more infromation about other format options, please visit the latest <a href="https://github.com/bustardcelly/cucumberjs-browser/wiki/Formats">documentation regarding formats</a> on the <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a>.</em></p>
<h2 id="tap">TAP</h2>
<p>The <a href="http://en.wikipedia.org/wiki/Test_Anything_Protocol">Test Anything Protocol</a> is a specification for reporting test information. The benefit of using such a specification is that it can be consumed by any test harness that recognizes it.</p>
<p>You can output <strong>TAP</strong> reports from <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> using the <code>tap</code> value for the foromat option:</p>
<pre><code>$ cucumberjs<span class="hljs-attribute">-browser</span> <span class="hljs-attribute">-f</span> tap
</code></pre><p>Running this command will generate the necessary files to print <a href="http://en.wikipedia.org/wiki/Test_Anything_Protocol">TAP</a> test results in the console when loaded by a browser.</p>
<p>If you were to open the generated testrunner file in a browser using the example from <a href="https://github.com/bustardcelly/cucumberjs-examples">cucumberjs-examples</a>, you would see something like the following if you were to open the browser console:</p>
<pre><code>TAP <span class="hljs-property">version</span> <span class="hljs-number">13</span>
<span class="hljs-comment"># Submit of valid item adds item to list</span>
ok <span class="hljs-number">1</span> I have opened <span class="hljs-keyword">the</span> grocery <span class="hljs-type">list</span> <span class="hljs-type">application</span>
ok <span class="hljs-number">2</span> I have an empty grocery <span class="hljs-type">list</span> view
ok <span class="hljs-number">3</span> I provide a valid grocery <span class="hljs-type">list</span> <span class="hljs-property">item</span> <span class="hljs-property">name</span>
ok <span class="hljs-number">4</span> I select <span class="hljs-keyword">to</span> add an <span class="hljs-property">item</span>
ok <span class="hljs-number">5</span> The <span class="hljs-property">item</span> <span class="hljs-keyword">is</span> added <span class="hljs-keyword">to</span> <span class="hljs-keyword">the</span> grocery <span class="hljs-type">list</span> view
<span class="hljs-comment"># Submit of valid item adds item to collection</span>
ok <span class="hljs-number">6</span> I have opened <span class="hljs-keyword">the</span> grocery <span class="hljs-type">list</span> <span class="hljs-type">application</span>
ok <span class="hljs-number">7</span> I have an empty grocery <span class="hljs-type">list</span> view
ok <span class="hljs-number">8</span> I provide a valid grocery <span class="hljs-type">list</span> <span class="hljs-property">item</span> <span class="hljs-property">name</span>
ok <span class="hljs-number">9</span> I select <span class="hljs-keyword">to</span> add an <span class="hljs-property">item</span>
ok <span class="hljs-number">10</span> The <span class="hljs-property">item</span> <span class="hljs-keyword">is</span> accessible <span class="hljs-keyword">from</span> <span class="hljs-keyword">the</span> grocery <span class="hljs-type">list</span> collection
<span class="hljs-comment"># Item added to grocery list</span>
ok <span class="hljs-number">11</span> I have opened <span class="hljs-keyword">the</span> grocery <span class="hljs-type">list</span> <span class="hljs-type">application</span>
ok <span class="hljs-number">12</span> I have an empty grocery <span class="hljs-type">list</span>
ok <span class="hljs-number">13</span> I add an <span class="hljs-property">item</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">the</span> <span class="hljs-type">list</span>
ok <span class="hljs-number">14</span> The grocery <span class="hljs-type">list</span> <span class="hljs-keyword">contains</span> a single <span class="hljs-property">item</span>
<span class="hljs-comment"># Item accessible from grocery list</span>
ok <span class="hljs-number">15</span> I have opened <span class="hljs-keyword">the</span> grocery <span class="hljs-type">list</span> <span class="hljs-type">application</span>
ok <span class="hljs-number">16</span> I have an empty grocery <span class="hljs-type">list</span>
ok <span class="hljs-number">17</span> I add an <span class="hljs-property">item</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">the</span> <span class="hljs-type">list</span>
ok <span class="hljs-number">18</span> I can access <span class="hljs-keyword">that</span> <span class="hljs-property">item</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">the</span> grocery <span class="hljs-type">list</span>

<span class="hljs-number">1.</span><span class="hljs-number">.18</span>
<span class="hljs-comment"># tests 18</span>
<span class="hljs-comment"># pass  18</span>

<span class="hljs-comment"># ok</span>
</code></pre><p>It should be noted that the <code>tap</code> listener for <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> uses the excellent <a href="https://github.com/substack/tape">tape</a> module.</p>
<h2 id="testling">testling</h2>
<p>I can&#39;t say enough how much I appreciate <a href="https://ci.testling.com/">testling</a>. You can install <strong>testling</strong> locally to run tests on the browsers installed on your system or use their remote service to run tests against various browsers that may not be available to you, yet are required as targets for your current project.</p>
<h3 id="local">local</h3>
<p>You can install <a href="https://ci.testling.com/">testling</a> to be run locally:</p>
<pre><code><span class="hljs-variable">$ </span>npm install -g testling
</code></pre><p>To run it, change directories into the generated files from <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> and run the following command:</p>
<pre><code><span class="hljs-variable">$ </span>cd browser-test
<span class="hljs-variable">$ </span>testling
</code></pre><p>That will consume a local <code>package.json</code> file and read a <code>testling</code> entry with options associated with running the generated html file againsta installed browsers on your system:</p>
<p><em>/browser-test/package.json</em></p>
<pre><code>{
<span class="hljs-keyword">...</span>

  <span class="hljs-string">"testling"</span> : {
    <span class="hljs-string">"html"</span> : <span class="hljs-string">"cucumber-testrunner.html"</span>,
    <span class="hljs-string">"browsers"</span> : [
        <span class="hljs-string">"chrome/latest"</span>,
        <span class="hljs-string">"firefox/latest"</span>,
        <span class="hljs-string">"safari/latest"</span>
    ]
  },

<span class="hljs-keyword">...</span>
}
<span class="hljs-keyword">...</span>
</code></pre><p>Truthfully, I never run <a href="https://ci.testling.com/">testling</a> locally. The main reasons being </p>
<p><strong>a)</strong> I can automate the running of specs on locally installed browsers easier with other tools (this is for another post :) )<br><strong>b)</strong> Testling provides a bigger benefit in providing tests against browsers I would otherwise have to install VMs for.</p>
<p>That said, I don&#39;t want ot pursuade you from using <strong>testling</strong> locally if it provides benefit in your workflow.</p>
<h3 id="remote">remote</h3>
<p>To use the remote service that <a href="https://ci.testling.com/">testling</a> provides, you still define the <code>testling</code> property in your <code>package.json</code> for the project as described above, but you additionally have to provide a webhook for your <strong>git</strong> repo in order to invoke the test harness. Upon a <code>PUSH</code> to your repository, <a href="https://ci.testling.com/">testling</a> will run the specified HTML file under the listed target browsers and report results based on the <a href="http://en.wikipedia.org/wiki/Test_Anything_Protocol">Test Anything Protocol</a> output printed to <code>console</code>.</p>
<p>In addition to providing a great service, you also get the option of adding a nice looking badge to your project.</p>
<p><img src="https://custardbelly.com/blog/images/testling-1.png" alt="testling harness output"></p>
<p>This badge was produced by pushing an update to the <a href="https://github.com/bustardcelly/cucumberjs-examples">cucumberjs-examples</a> exampe repo with a defined webhook. (If you followed along in the previous articles, you will note that the failing IE tests are due to the use of <code>Object.create</code> in source without a polyfill).</p>
<p>_The process of adding a webhook to your project is described in better detail in the <a href="https://ci.testling.com/guide/quick_start">testling documentation</a>._</p>
<h3 id="donate">donate</h3>
<p>If you do use <a href="https://ci.testling.com/">testling</a> in any fashion, I implore you to <a href="https://ci.testling.com/donate">donate to the cause</a> :)</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this article I introduced how the <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> CLI tool can be used to generate a browser-based testrunner to report tests in <a href="http://en.wikipedia.org/wiki/Test_Anything_Protocol">TAP</a> format and integrate the invaluable <a href="https://ci.testling.com/">testling</a> service to run the tests on various browsers that may not be at your disposal otherwise.</p>
<p>While <a href="https://ci.testling.com/">testling</a> provides one consumer endpoint, using the <a href="http://en.wikipedia.org/wiki/Test_Anything_Protocol">TAP</a> specification in reporting test results can easily be consumed by another test harness of your choice.</p>
<p>For more information on running <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> in the browser and/or to report any issues, please visit the <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> repository.</p>
]]></description><link>https://www.custardbelly.com/blog/blog-posts/2014/02/18/cucumberjs-testling/index.html</link><guid isPermaLink="true">https://www.custardbelly.com/blog/blog-posts/2014/02/18/cucumberjs-testling/index.html</guid><dc:creator><![CDATA[Todd Anderson]]></dc:creator><pubDate>Invalid Date</pubDate></item><item><title><![CDATA[Caddis: The On-The-Fly JSON RESTful Server]]></title><description><![CDATA[<p>Recently I released a new node-based CLI tool called <a href="https://github.com/bustardcelly/caddis">caddis</a>. It allows you to start a server - as a daemon - on localhost and dynamically add routes and JSON responses. Once stopped, any work is wiped; it is purely in-memory, session based. </p>
<p>The impetus for its creation was a requirement to easily mock service APIs to be called in a test environment without regards to libraries or languages in which the environment is run. </p>
<p>To be more specific, for a recent project I am using the wonderful <a href="http://calaba.sh/">calabash-ios</a> framework to define <a href="http://cukes.info/">cucumber</a> specs in <a href="https://www.ruby-lang.org/en/">Ruby</a> that drive automated integration tests for an <strong>iOS</strong> project in the simulator. Creating <a href="https://github.com/bustardcelly/caddis">caddis</a> allows me to easily mock service requests that the <strong>iOS</strong> application will make and validate the expected result of scenarios in <a href="http://cukes.info/">cucumber</a>.</p>
<h2 id="installation-usage">Installation &amp; Usage</h2>
<p><a href="https://github.com/bustardcelly/caddis">caddis</a> is available through npm. It is recommended that you install globally:</p>
<pre><code><span class="hljs-variable">$ </span>npm install -g caddis
</code></pre><p><em>&gt; you may need to <code>sudo</code></em></p>
<p>To use <a href="https://github.com/bustardcelly/caddis">caddis</a> </p>
<pre><code>$ caddis start
$ curl -X POST -d <span class="hljs-string">'{"</span>method<span class="hljs-string">":"</span>GET<span class="hljs-string">", "</span>uri<span class="hljs-string">":"</span>/foo<span class="hljs-string">", "</span>response<span class="hljs-string">":{"</span>bar<span class="hljs-string">":"</span>baz<span class="hljs-string">"}}'</span> http:<span class="hljs-comment">//localhost:3001/api --header "Content-Type:application/json"</span>
</code></pre><p>Visit <a href="http://localhost:3001/foo">http://localhost:3001/foo</a>, prints:</p>
<pre><code><span class="hljs-rules">{
  <span class="hljs-rule"><span class="hljs-attribute">bar</span>:<span class="hljs-value"> <span class="hljs-string">'baz'</span>
</span></span></span>}
</code></pre><pre><code><span class="hljs-variable">$ </span>caddis stop
</code></pre><p>Visit <a href="http://localhost:3001/foo">http://localhost:3001/foo</a>, Not Found.</p>
<h3 id="options">Options</h3>
<pre><code>$ caddis -h

usage: caddis [action]

Starts <span class="hljs-operator">a</span> server <span class="hljs-keyword">at</span> <span class="hljs-keyword">http</span>://localhost:<span class="hljs-number">3001</span> <span class="hljs-keyword">as</span> <span class="hljs-operator">a</span> daemon, exposing <span class="hljs-operator">an</span> api <span class="hljs-built_in">to</span> <span class="hljs-built_in">post</span> JSON <span class="hljs-built_in">to</span> <span class="hljs-operator">in</span> order <span class="hljs-built_in">to</span> mock <span class="hljs-operator">a</span> RESTful service.

actions:
  start               Start Caddis <span class="hljs-keyword">at</span> <span class="hljs-keyword">http</span>://localhost:<span class="hljs-number">3001</span>
  stop                Stop <span class="hljs-operator">a</span> previously started Caddis daemon
options:
  -h                  Display this help menu
</code></pre><h2 id="what-">What?</h2>
<p><img src="https://custardbelly.com/images/caddis.jpg" alt="Caddis Fly Lure"><br>A caddis is a moth-like insect often used as models for fly lures in fishing.</p>
<p>The <a href="https://github.com/bustardcelly/caddis">caddis</a> CLI tool is used to start and stop a RESTful JSON service with the ability to POST route configuration and responses, on-the-fly, for mocking and testing purposes.</p>
<p><em>It may be a stretch, but there&#39;s wit in there somewhere...</em></p>
<h2 id="why-">Why?</h2>
<p>There are other projects I have been a part of, such as <a href="https://github.com/infrared5/madmin">madmin</a>, that allow for dynamically creating RESTful APIs through a User Interface and allows for persistance through I/O.</p>
<p>Recently, I was involved with mocking a service layer for unit testing purposes and found that the manual curation of such an API was too tedious for the task at hand - I wanted the process to be much more fluid and simple.</p>
<p>In this particular instance I needed to:</p>
<ol>
<li>Start a server in setup/before</li>
<li>Dynamically add a route to the service with mock JSON response</li>
<li>Run the test</li>
<li>Shut down the server in teardown/after</li>
</ol>
<p>Fairly simple, and most of all I didnt want any artifacts lying around - in other words I didn&#39;t need for any routes that I dynamically created to stick around on my local disk after the tests were done.</p>
<p>As such, <a href="https://github.com/bustardcelly/caddis">caddis</a> was born.</p>
<h2 id="how">How</h2>
<p>As mentioned briefly above, <a href="https://github.com/bustardcelly/caddis">caddis</a> is a CLI tool. It is recommended to install globally:</p>
<pre><code><span class="hljs-variable">$ </span>npm install -g caddis
</code></pre><p><em>&gt; you may need to <code>sudo</code></em></p>
<p>Once installed, you can start the service (currently defaults to <a href="http://localhost:3001">http://localhost:3001</a>) and begin POSTing route configurations in JSON. Here is an example using cUrl that dynamically adds a GET route at <code>/foo</code> with a simple JSON payload of <code>{&quot;bar&quot;:&quot;baz&quot;}</code>:</p>
<pre><code>$ curl -X POST -d <span class="hljs-string">'{"</span>method<span class="hljs-string">":"</span>GET<span class="hljs-string">", "</span>uri<span class="hljs-string">":"</span>/foo<span class="hljs-string">", "</span>response<span class="hljs-string">":{"</span>bar<span class="hljs-string">":"</span>baz<span class="hljs-string">"}}'</span> http:<span class="hljs-comment">//localhost:3001/api --header "Content-Type:application/json"</span>
</code></pre><p>You are not confiuned to cUrl - you can use whatever networking library in whatever language you are writing your tests in and the server can handle all modern RESTful methods:</p>
<ul>
<li>GET</li>
<li>POST</li>
<li>PUT</li>
<li>DELETE</li>
</ul>
<p>When you are finished, simply stop the <a href="https://github.com/bustardcelly/caddis">caddis</a> server:</p>
<pre><code><span class="hljs-variable">$ </span>caddis stop
</code></pre><h2 id="conclusion">Conclusion</h2>
<p>I hope this was a useful introduction to what <a href="https://github.com/bustardcelly/caddis">caddis</a> has to offer and that you may find it beneficial in your testing in some way.</p>
<p>You can visit the project on github at: <a href="https://github.com/bustardcelly/caddis">https://github.com/bustardcelly/caddis</a></p>
]]></description><link>https://www.custardbelly.com/blog/blog-posts/2014/02/25/introducing-caddis/index.html</link><guid isPermaLink="true">https://www.custardbelly.com/blog/blog-posts/2014/02/25/introducing-caddis/index.html</guid><dc:creator><![CDATA[Todd Anderson]]></dc:creator><pubDate>Invalid Date</pubDate></item><item><title><![CDATA[BDD in JavaScript V: CucumberJS and The Browser, II]]></title><description><![CDATA[<p><em>&quot;Whoa. Whoa. Whoa. You can&#39;t just use roman numerals all over the place in your post titles...&quot;</em></p>
<p>In the <a href="https://custardbelly.com/blog/blog-posts/2014/02/10/cucumberjs-tests-browser/index.html">previous article</a> I addressed the available libraries and practices to have your <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> specs running in a browser environment, as well as introduced a new project begun by me: <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a>.</p>
<p>I had originally had the entirety of this post in the previous post, but felt that it was a little bit of information overload. As such, I decided to split them into two posts.</p>
<p>The intent of this article is to address incorporating <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> into our current Grocery List Application example and continue developing features that involve User Interaction with the DOM.</p>
<h3 id="-gt-code">&gt; code</h3>
<p>Supported files related to this and any subsequent posts on this topic will be available at:<br><a href="https://github.com/bustardcelly/cucumberjs-examples">https://github.com/bustardcelly/cucumberjs-examples</a></p>
<h2 id="cucumberjs-browser">cucumberjs-browser</h2>
<p>The <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> CLI tool was created to provide a means in which to write my <strong>Features</strong>, <strong>Step Definitions</strong> and support files as I normally would for a project, and bundle them to be run in a browser and provide custom reporting.</p>
<p>First order of business for incorporating the <strong>cucumberjs-browser</strong> tool into the Grocery List applicaiton project we have been working through in this series is to install the tool:</p>
<pre><code><span class="hljs-variable">$npm</span> install <span class="hljs-attribute">-g</span> cucumberjs<span class="hljs-attribute">-browser</span>
</code></pre><p>(you may need to <code>sudo</code>) </p>
<p>That should install the tool and now be accessible from the command line. The <a href="https://github.com/bustardcelly/cucumberjs-browser/blob/master/README.md">README</a> is the best place to find the most up-to-date infromation about the tool, but the general usage is as follows:</p>
<pre><code>$ <span class="hljs-tag">cucumberjs-browser</span> <span class="hljs-attr_selector">[-o outdir]</span> <span class="hljs-attr_selector">[-f format]</span> <span class="hljs-attr_selector">[--tmpl template]</span> <span class="hljs-attr_selector">[--features features]</span>
</code></pre><p>We&#39;ll get into how we will use it with our project and the options in a bit, but before then...</p>
<h2 id="fail-first">Fail first</h2>
<p>In a pervious article in this series, we added an <code>add-item</code> feature that detailed the scenarios of adding and accessible an item from a collection of the Grocery List application. This is still a valid logical feature that normally I would not modify to incorporate User Interaction when incorporating <strong>Features</strong> related to the application being browser-based. Instead, I would create a new <strong>Feature</strong> that details how a User can add and view new item in a browser environment.</p>
<p>Let&#39;s define our spec:</p>
<p><em>/features/add-item-view.feature</em></p>
<pre><code>Feature: Shopper can add <span class="hljs-keyword">and</span> view new <span class="hljs-property">item</span> <span class="hljs-keyword">in</span> Grocery List
  As a shopper using <span class="hljs-keyword">the</span> browser-based app
  I want <span class="hljs-keyword">to</span> add an <span class="hljs-property">item</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">my</span> grocery <span class="hljs-type">list</span> view
  So <span class="hljs-keyword">that</span> I can remember <span class="hljs-keyword">to</span> buy <span class="hljs-keyword">that</span> <span class="hljs-property">item</span> <span class="hljs-keyword">at</span> <span class="hljs-keyword">the</span> grocery store

  Background: Grocery List Application <span class="hljs-keyword">is</span> Open
    Given I have opened <span class="hljs-keyword">the</span> grocery <span class="hljs-type">list</span> <span class="hljs-type">application</span>

  Scenario: Submit <span class="hljs-keyword">of</span> valid <span class="hljs-property">item</span> adds <span class="hljs-property">item</span> <span class="hljs-keyword">to</span> <span class="hljs-type">list</span>
    Given I have an empty grocery <span class="hljs-type">list</span> view
    When I provide a valid grocery <span class="hljs-type">list</span> <span class="hljs-property">item</span> <span class="hljs-property">name</span>
    And I select <span class="hljs-keyword">to</span> add an <span class="hljs-property">item</span>
    Then The <span class="hljs-property">item</span> <span class="hljs-keyword">is</span> added <span class="hljs-keyword">to</span> <span class="hljs-keyword">the</span> grocery <span class="hljs-type">list</span> view

  Scenario: Submit <span class="hljs-keyword">of</span> valid <span class="hljs-property">item</span> adds <span class="hljs-property">item</span> <span class="hljs-keyword">to</span> collection
    Given I have an empty grocery <span class="hljs-type">list</span> view
    When I provide a valid grocery <span class="hljs-type">list</span> <span class="hljs-property">item</span> <span class="hljs-property">name</span>
    And I select <span class="hljs-keyword">to</span> add an <span class="hljs-property">item</span>
    Then The <span class="hljs-property">item</span> <span class="hljs-keyword">is</span> accessible <span class="hljs-keyword">from</span> <span class="hljs-keyword">the</span> grocery <span class="hljs-type">list</span> collection
</code></pre><p>We have declared two <strong>Scenarios</strong> that define the <strong>Feature</strong> criteria in which a User interacts with DOM elements to add and view a new item to the Grocery List application.</p>
<p>Running that produces the expected <code>undefined</code> steps notification:</p>
<pre><code>$ npm run test
<span class="hljs-preprocessor">.UUU</span><span class="hljs-preprocessor">.UUUU</span><span class="hljs-preprocessor">.UUUU</span>........

<span class="hljs-number">4</span> scenarios (<span class="hljs-number">2</span> undefined, <span class="hljs-number">2</span> passed)
<span class="hljs-number">21</span> steps (<span class="hljs-number">10</span> undefined, <span class="hljs-number">11</span> passed)
</code></pre><h3 id="given-i-have-an-empty-grocery-list-view">Given I have an empty grocery list view</h3>
<p>We have a few things we need to address, but before we get into the nitty-gritty, let&#39;s turn this <span style="color:red;">red</span> in true TDD fashion while filling out our API expectation of the <em>Given</em> in each of the <strong>Scenarios</strong></p>
<p>_/features/step<em>definitions/add-item-view.steps.js</em></p>
<pre><code><span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>);

module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
<span class="hljs-pi">  'use strict'</span>;

  <span class="hljs-keyword">this</span>.World = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../support/world'</span>).World;

  <span class="hljs-keyword">this</span>.Given(<span class="hljs-regexp">/^I have an empty grocery list view$/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
    <span class="hljs-keyword">this</span>.emptyGroceryListView();
    assert.equal(<span class="hljs-keyword">this</span>.getGroceryListView().childNodes.length, <span class="hljs-number">0</span>);
    callback();
  });

});
</code></pre><pre><code>$ npm run test
.F.F.F........

(::) failed steps (::)
<span class="hljs-keyword">...</span>
Failing scenarios:
/Users/toddanderson/Documents/workspace/custardbelly/cucumberjs-example/features/add-item-view.feature:<span class="hljs-number">9</span> <span class="hljs-comment"># Scenario: Select of Add Item opens input</span>
/Users/toddanderson/Documents/workspace/custardbelly/cucumberjs-example/features/add-item-view.feature:<span class="hljs-number">14</span> <span class="hljs-comment"># Scenario: Submit of valid item adds item to list</span>
/Users/toddanderson/Documents/workspace/custardbelly/cucumberjs-example/features/add-item-view.feature:<span class="hljs-number">20</span> <span class="hljs-comment"># Scenario: Submit of valid item adds item to collection</span>

<span class="hljs-number">5</span> scenarios (<span class="hljs-number">3</span> failed, <span class="hljs-number">2</span> passed)
<span class="hljs-number">22</span> steps (<span class="hljs-number">3</span> failed, <span class="hljs-number">8</span> skipped, <span class="hljs-number">11</span> passed)
</code></pre><p>Huge explosion. Red everywhere. Dogs and cats, living together. Mass hysteria.</p>
<p>That&#39;s good, we expect the world to crash with nothing to support our claims of an &quot;empty grocery list view&quot;. What does that even mean in the current context? We haven&#39;t even a web page to view our Grocery List. These all are issues we need to address in resolving just this single <strong>Step Definition</strong>.</p>
<h2 id="client-side-script">Client-Side Script</h2>
<p>This is a good point to discuss the client-side script that will act as our main entry point for the browser-based Grocery List Application. </p>
<p>If you have been following along with the examples in this series, we have been slowly building up specs for our Grocery List Application, yet it has been done so while testing under the <a href="http://nodejs.org">Node</a>-based <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> CLI tool. Nothing wrong with that, and in fact we have a good starting point in which we can ensure that a proper collection model is maintained with regards to adding and accessing items.</p>
<p>However, now we are moving to a browser environment and need to address how we will load and interact with our application within the browser context. Because we have been developing node modules (to be tested under CucumberJS specs) which utilize the <a href="http://wiki.commonjs.org/wiki/Modules/1.1">CommonJS module format</a> we can easily bundle our scripts for the browser using the wonderful <a href="http://browserify.org/">browserify</a> tool.</p>
<p><em>Disclaimer: Hats off to <a href="http://benclinkinbeard.com/">Ben Clinkenbeard</a> for finally persuading me to look into <a href="http://browserify.org/">browserify</a> over my years-long obsession with <a href="http://requirejs.org/">RequireJS</a>.</em></p>
<h3 id="browserify">Browserify</h3>
<p>It is too much for this article to address <a href="http://browserify.org/">browserify</a> and its history and attributes. There are several articles that are google-able that explain what <strong>browserify</strong> is, how to use it, and its virtues and disadvantages over AMD. I implore you to check them out and make a sound judgement as it relates to your team and project requirements.</p>
<p>That said, I have found <a href="http://browserify.org/">browserify</a> extremely beneficial and am going to use it for the examples in this series in delivering the client-side scripts.</p>
<p>First order of business is to install <strong>browserify</strong> as you would any project-local node module:</p>
<pre><code><span class="hljs-variable">$ </span>npm install browserify
</code></pre><p>Now we need to define how we want our module to be bundled for the browser. If we are talking a single entry point - which most main files are - I prefer to define a global name to assign our module so it is easily accessible on the DOM. Keeping in mind that we are primarily bundling our code so we can do TDD, we define an proper output directory that won&#39;t get mixed up with our distribution:</p>
<pre><code>$ mkdir test/script &amp;&amp; \
  node node_modules/<span class="hljs-preprocessor">.bin</span>/browserify script/app<span class="hljs-preprocessor">.js</span> -o test/script/app<span class="hljs-preprocessor">.js</span> -s grocerylist
</code></pre><p>With that command, we created the output directory for our main file - <code>app.js</code> - and bundled the <em>script/app.js</em> file with any dependencies (which currently were only <em>script/model/grocery-list.js</em>). As well, our module is accessible on the <code>window</code> object as <code>grocerylist</code>.</p>
<h2 id="index-file">Index File</h2>
<p>So we have our bundled scripts and an exposed entry to our application through <code>window.grocerylist</code>, and now we need a way to access and view the application - an html file.</p>
<p>Because we will be using the <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> tool to bundle our features and specs to be run under a browser environment, we will copy and modify the default template shipped with that tool to suit our needs for our application.</p>
<p>At this stage, we are simply going to add a <code>script</code> tag for our application bundle we created in the previous section:</p>
<p><em>template/testrunner.html</em></p>
<pre><code><span class="hljs-doctype">&lt;!doctype html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">http-equiv</span>=<span class="hljs-value">"Content-Type"</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">"text/html;charset=utf-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"lib/cucumber.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"features.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
    <span class="vbscript">&lt;% _.<span class="hljs-keyword">each</span>(modules, <span class="hljs-keyword">function</span>(module) { %&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"&lt;%= module.filepath %&gt;"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
    <span class="vbscript">&lt;% }); %&gt;</span>
    <span class="vbscript">&lt;% <span class="hljs-keyword">if</span>(listener.exists) { %&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"script/&lt;%= listener.filename %&gt;"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
    <span class="vbscript">&lt;% }; %&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="javascript">
      (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(window)</span> {</span>

        <span class="hljs-comment">// Need to concat all *.features &gt; browserify.standalone = cukefeatures</span>
        <span class="hljs-keyword">var</span> features = window.cukefeatures.split(<span class="hljs-string">'&amp;crarr'</span>).join(<span class="hljs-string">'\n'</span>);

        <span class="hljs-comment">// Need to concat all support + step_definitions, and export as a function</span>
        <span class="hljs-keyword">var</span> support = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
          <span class="hljs-keyword">this</span>.Given = <span class="hljs-keyword">this</span>.When = <span class="hljs-keyword">this</span>.Then = <span class="hljs-keyword">this</span>.defineStep;
          <span class="hljs-comment">// Would be put on window if /support/world found.</span>
          <span class="hljs-keyword">if</span>(<span class="hljs-string">'world'</span> <span class="hljs-keyword">in</span> window) {
            <span class="hljs-keyword">this</span>.World = window[<span class="hljs-string">'world'</span>].World;
          }
          &lt;% _.each(steps, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(step)</span> {</span> %&gt;
          window[<span class="hljs-string">'&lt;%= step.name %&gt;'</span>].call(<span class="hljs-keyword">this</span>);
          <span class="xml"><span class="vbscript">&lt;% }); %&gt;</span>
        };

        var runtime = Cucumber(features, support);
        <span class="vbscript">&lt;% <span class="hljs-keyword">if</span>(listener.exists) { %&gt;</span>
        runtime.attachListener(window.cukelistener.instance());
        <span class="vbscript">&lt;% }; %&gt;</span>
        runtime.start(function(){
          <span class="vbscript">&lt;% <span class="hljs-keyword">if</span>(listener.exists) { %&gt;</span>
          window.cukelistener.instance().complete();
          <span class="vbscript">&lt;% } <span class="hljs-keyword">else</span> { %&gt;</span>
          console.log(Array.prototype.slice.call(arguments));
          <span class="vbscript">&lt;% }; %&gt;</span>
        });
      }(window));
    </span></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"./script/app.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span>
</code></pre><p>Most of what is in this page template is copied from the <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> project. The only addition - at this point - is the script appended within the <code>body</code> that will load our app bundle.</p>
<p>If we were to run the <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> tool and generate our bundled app, specs and template:</p>
<pre><code>$ cucumberjs<span class="hljs-attribute">-browser</span> <span class="hljs-attribute">-o</span> test <span class="hljs-subst">--</span>tmpl template/testrunner<span class="hljs-built_in">.</span>html <span class="hljs-attribute">-f</span> tap
</code></pre><p>That will generate the JavaScript bundle files for the <strong>Features</strong>, <strong>Step Definitions</strong> and support files we have been creating and curating in this series, along with the templated HTML file with our resources defined and place them in a <em>/test</em> directory.</p>
<p>If we were to open that HTML file - <em>/test/cucumberjs-testrunner.html</em> - and opened the Console of our developer tools, we would see a <a href="http://en.wikipedia.org/wiki/Test_Anything_Protocol">TAP</a> report of our test... <span style="color: red;">failing</span> :)</p>
<p>If we were to change the format option:</p>
<pre><code>$ cucumberjs<span class="hljs-attribute">-browser</span> <span class="hljs-attribute">-o</span> test <span class="hljs-subst">--</span>tmpl template/testrunner<span class="hljs-built_in">.</span>html <span class="hljs-attribute">-f</span> ui
</code></pre><p>We would see those same <span style="color:red;">failing</span> tests, but this time on the DOM.</p>
<div style="width: 100%; overflow-x: scroll; background-color:#fff; text-align: center;">
  <img src="https://custardbelly.com/blog/images/cucumberjs-browser-2.png" alt="cucumberjs in the browser, failing">
</div>

<p>We have gone from failing on the command line to failing in the browser... isn&#39;t it glorious :)</p>
<h2 id="automate-all-the-things">Automate all the things</h2>
<p>We had <a href="https://custardbelly.com/blog/blog-posts/2014/01/29/cucumberjs-build/index.html">previously automated our testing</a> under the node-based environment; it was a simple as setting up a file watcher and issuing a command to run the <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> CLI tool on change.</p>
<p>Our process has now become a little more involved, but not anything too complex (<em>thanks to the wonderful <a href="https://www.npmjs.org/">npm</a> community!</em>) that an automated build and test procedure couldn&#39;t be implemented. The only difference is that feedback will now reside in the DOM and/or Console of a browser - so instead of coding in an editor and watching it fail on the command line, we are now going to need to focus on failures reported in the browser as we TDD.</p>
<h3 id="watch-script">watch script</h3>
<p>Just as we had done in a <a href="https://custardbelly.com/blog/blog-posts/2014/01/29/cucumberjs-build/index.html">previous article</a>, we are going to create a new script that will essentially do the following:</p>
<ol>
<li>start a livereload server</li>
<li>start a local server to serve the testrunner</li>
<li>launch the testrunner in a browser</li>
<li>bundle the app and run the cucumberjs-browser tool</li>
<li>watch and reload the testrunner in the browser on change to source files</li>
</ol>
<p>To accomplish this task, we are going to use a couple more npm modules; in particular:</p>
<ol>
<li><a href="https://github.com/mklabs/tiny-lr">tiny-lr</a></li>
<li><a href="https://github.com/senchalabs/connect">connect</a></li>
<li><a href="https://github.com/jjrdn/node-open">open</a></li>
</ol>
<p>I invite you to go check each of those projects out as I won&#39;t go into much detail about each of them in this article. It should be noted, however, that you will need to install the <a href="http://livereload.com/">LiveReload</a> <a href="http://feedback.livereload.com/knowledgebase/articles/86242-how-do-i-install-and-use-the-browser-extensions-">browser extension(s)</a> in order to properly use the <code>watch</code> script:</p>
<p><em>cuke-browser-watcher.js</em></p>
<pre><code>#!<span class="hljs-regexp">/usr/</span>bin/env node
<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> watch = <span class="hljs-built_in">require</span>(<span class="hljs-string">'node-watch'</span>);
<span class="hljs-keyword">var</span> child_process = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>);
<span class="hljs-keyword">var</span> mkdirp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mkdirp'</span>);
<span class="hljs-keyword">var</span> browserify = <span class="hljs-built_in">require</span>(<span class="hljs-string">'browserify'</span>);

<span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);
<span class="hljs-keyword">var</span> tinylr = <span class="hljs-built_in">require</span>(<span class="hljs-string">'tiny-lr'</span>);
<span class="hljs-keyword">var</span> connect = <span class="hljs-built_in">require</span>(<span class="hljs-string">'connect'</span>);
<span class="hljs-keyword">var</span> open = <span class="hljs-built_in">require</span>(<span class="hljs-string">'open'</span>);
<span class="hljs-keyword">var</span> S = <span class="hljs-built_in">require</span>(<span class="hljs-string">'string'</span>);

<span class="hljs-keyword">var</span> outdir = <span class="hljs-string">'test'</span>;
<span class="hljs-keyword">var</span> browserCukes;

<span class="hljs-keyword">var</span> livereloadPort = <span class="hljs-number">35729</span>;
<span class="hljs-keyword">var</span> connectPort = <span class="hljs-number">8080</span>;
<span class="hljs-keyword">var</span> JS_EXT = <span class="hljs-regexp">/^.*\.js/i</span>;
<span class="hljs-keyword">var</span> options = [<span class="hljs-string">'-f'</span>, <span class="hljs-string">'ui'</span>,
               <span class="hljs-string">'-o'</span>, outdir,
               <span class="hljs-string">'--tmpl'</span>, <span class="hljs-string">'template/testrunner.html'</span>];

<span class="hljs-comment">// [TASKS]</span>
<span class="hljs-comment">// a. re-bundle the app.</span>
<span class="hljs-keyword">var</span> bundleApplication = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f, callback)</span> {</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    browserify(__dirname + <span class="hljs-string">'/script/app.js'</span>)
      .bundle({
        standalone: <span class="hljs-string">'app'</span>
      })
      .pipe(fs.createWriteStream(path.resolve(outdir + <span class="hljs-string">'/script/app.js'</span>)))
      .on(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        console.log(<span class="hljs-string">'changed app.js...'</span>);
        <span class="hljs-keyword">if</span>(callback) {
          callback();
        }
      });
  };
};
<span class="hljs-comment">// b. rerun cucumberjs-browser tool.</span>
<span class="hljs-keyword">var</span> cuke = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(f, callback)</span> {</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> filename = S(path.basename(f, <span class="hljs-string">'.js'</span>).split(<span class="hljs-string">'.'</span>).join(<span class="hljs-string">'-'</span>)).camelize().s;
    browserCukes = child_process.spawn(<span class="hljs-string">'cucumberjs-browser'</span>, options)
      .on(<span class="hljs-string">'exit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        console.log(<span class="hljs-string">'changed '</span> + filename + <span class="hljs-string">'...'</span>);
        <span class="hljs-keyword">if</span>(callback) {
          callback();
        }
      });
  };
};

<span class="hljs-comment">// 1. Recursive mkdir /test/script if not exist.</span>
mkdirp.sync(outdir + <span class="hljs-string">'/script'</span>);

<span class="hljs-comment">// 2. Create tiny-livereload server.</span>
<span class="hljs-keyword">var</span> lr = tinylr();
lr.listen(livereloadPort, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  console.log(<span class="hljs-string">'livereload listening on '</span> + livereloadPort + <span class="hljs-string">'...'</span>);
});

<span class="hljs-comment">// 3. Start server on localhost.</span>
<span class="hljs-keyword">var</span> app = connect().use(connect.static(__dirname + <span class="hljs-string">'/test'</span>));
<span class="hljs-keyword">var</span> server = http.createServer(app).listen(connectPort, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  console.log(<span class="hljs-string">'local server started on '</span> + connectPort + <span class="hljs-string">'...'</span>);
  console.log(<span class="hljs-string">'Note: Remember to start the livereload browser extension!'</span>);
  console.log(<span class="hljs-string">'http://feedback.livereload.com/knowledgebase/articles/86242-how-do-i-install-and-use-the-browser-extensions-'</span>);
  cuke(<span class="hljs-string">'./features/support/world'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    bundleApplication(<span class="hljs-string">'./script/app.js'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      open(<span class="hljs-string">'http://localhost:'</span> + connectPort + <span class="hljs-string">'/cucumber-testrunner.html'</span>);  
    })();
  })();
});

<span class="hljs-comment">// 4. Watch source and generate bundles.</span>
watch([<span class="hljs-string">'./features'</span>, <span class="hljs-string">'./script'</span>], {recursive:<span class="hljs-literal">true</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(filename)</span> {</span>
  <span class="hljs-comment">// Used to resolve when running operation(s) are complete.</span>
  <span class="hljs-keyword">var</span> resolver;
  <span class="hljs-keyword">var</span> running = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> resolveWatch = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(limit)</span> {</span>
    <span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span>;
    running = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">if</span>(++count === limit) {
        count = <span class="hljs-number">0</span>;
        running = <span class="hljs-literal">false</span>;
      }
      <span class="hljs-keyword">else</span> {
        running = <span class="hljs-literal">true</span>;
      }
    };
  };

  <span class="hljs-keyword">if</span>(!running &amp;&amp; filename.match(JS_EXT)) {
    <span class="hljs-keyword">var</span> bundleAppInvoke = bundleApplication(filename, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      lr.changed({
        body: {
          files: [<span class="hljs-string">'script/app'</span>]
        }
      });
      resolver();
    });
    <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/^script?/i</span>.test(filename)) {
      resolver = resolveWatch(<span class="hljs-number">1</span>);
      bundleAppInvoke();
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/^features?/i</span>.test(filename)) {
      resolver = resolveWatch(<span class="hljs-number">2</span>);
      cuke(filename, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        lr.changed({
          body: {
            files: [filename]
          }
        });
        resolver();
        bundleAppInvoke();
      })();
    }
  }

});
</code></pre><p>This <code>watch</code> script is very similar to the one we created previously. Aside from moving the bundler tasks outside of the <code>watch()</code>, the main difference is that we now start a <code>tiny-livereload</code> server and <code>http</code> server running on port 8080 before starting the <code>watch</code> task.</p>
<p>Running this will also automatically launch the testrunner in your default browser. It is important to note that, in order for the reload on file change to work, you must enable the <a href="http://livereload.com/">LiveReload</a> <a href="http://feedback.livereload.com/knowledgebase/articles/86242-how-do-i-install-and-use-the-browser-extensions-">browser extension for that browser</a>.</p>
<p>As we have done before, we can add this to our package <code>scripts</code>:</p>
<p><em>package.json</em></p>
<pre><code>{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"cucumberjs-examples"</span>,
<span class="hljs-keyword">...</span>
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"test"</span>: <span class="hljs-string">"node node_modules/.bin/cucumber-js"</span>,
    <span class="hljs-string">"watch"</span>: <span class="hljs-string">"node cuke-watcher.js"</span>,
    <span class="hljs-string">"watch-browser"</span>: <span class="hljs-string">"node cuke-browser-watcher"</span>
  }
<span class="hljs-keyword">...</span>
}
</code></pre><p>Open up the terminal and enter the following command:</p>
<pre><code><span class="hljs-variable">$ </span>npm run watch-browser
</code></pre><p>... and we are all set to keep TDD&#39;ing with an automated <code>watch</code> script that will reload the browser on change to our step definitions and application source files!</p>
<h2 id="back-to-passing">Back to Passing</h2>
<p>We side-stepped our development to address a few key issues: bundling scripts for the browser and automating tests against <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a>. With our <code>watch</code> script up and running, we can see we are in the <span style="color:red;">red</span> still - let&#39;s start turning steps <span style="color:green">green</span> :)</p>
<p>First order of business is that our first <strong>Given</strong> step for the Add Item View <strong>Feature</strong> is interfacing with a currently non-existant API on the <strong>World</strong>. We eschewed the need for an additional Web Driver library which would provide a conventient API through a browser facade. At this stage, I think we can reasonably have our <strong>World</strong> provide that API and not need to include more external libraries. </p>
<p><em>It might even be a reasonable discussion that such Web Drivers are not needed at all in such circumstances, but I won&#39;t go there for the moment as that gets into a discussion about integration testing vs unit testing and BDD practice - ie, a can of worms ;)</em></p>
<h3 id="modifying-our-world">Modifying Our World</h3>
<p>Now that we know we are running our tests in the browser, we have access to the global <code>window</code> and can reference the DOM without restriction to running <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> under <a href="http://nodejs.org">node</a>.</p>
<p>Let&#39;s modify our <strong>World</strong> to expose the API we are invoking from our <strong>Given</strong> in the Add Item View __Feature:</p>
<p><em>/features/support/world.js</em></p>
<pre><code><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> World = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">World</span><span class="hljs-params">(callback)</span> {</span>

  <span class="hljs-keyword">this</span>.window = window;
  <span class="hljs-keyword">this</span>.app = window.app;
  <span class="hljs-keyword">this</span>.groceryListApplication = <span class="hljs-literal">undefined</span>;

  <span class="hljs-keyword">this</span>.openGroceryList = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.app.newSession();
  };
  <span class="hljs-keyword">this</span>.createGroceryItem = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'apple'</span>;
  };

  <span class="hljs-keyword">this</span>.emptyGroceryListView = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.app.empty();
  };

  callback();

};

module.exports.World = World;
</code></pre><p>There is actually a quite bit changed from our previous <strong>World</strong>:</p>
<ol>
<li>Removed <code>require()</code> of app module</li>
<li>Added access to <code>app</code> reference on <code>window</code> from our browserified bundle</li>
<li>Changed reference to <code>app</code> that creates a new session</li>
<li>Added <code>emptyGroceryListView</code> method to World</li>
</ol>
<p>So we took the <strong>World</strong> into a browser environment with its referencing the app, but we are still (as expected) failing - this time alerting us to:</p>
<p><span style="color:red;">- Cannot call method &#39;newSession&#39; of undefined at World.openGroceryList</span></p>

<p>which is stemming from our previously defined <strong>Background</strong> step definition:</p>
<pre><code><span class="hljs-keyword">Background</span>: Grocery <span class="hljs-keyword">List</span> Application is <span class="hljs-keyword">Open</span>
  Given <span class="hljs-keyword">I</span> have opened the grocery list application
</code></pre><p>This actually stems from a much larger problem: accessing the the application module on the <code>window</code> before it has finished being loaded by the browser. As such, we will need to modify this step definition to ensure that the DOM has completed load before we can move forward in interactinf with the <strong>World</strong> API that now exposes communication to the DOM.</p>
<p>_/features/step<em>definitions/background-open-application.step.js</em></p>
<pre><code><span class="hljs-pi">'use strict'</span>;
<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>);

module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>

  <span class="hljs-keyword">this</span>.World = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../support/world'</span>).World;

  <span class="hljs-keyword">this</span>.Given(<span class="hljs-regexp">/^I have opened the grocery list application$/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
    (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(world)</span> {</span>
      world.domload(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        world.groceryListApplication = world.openGroceryList();
        assert(world.groceryListApplication, <span class="hljs-string">'Grocery List Application is required to be open for editability.'</span>);
        callback();
      });
    }(<span class="hljs-keyword">this</span>));
  });

};
</code></pre><p>Now we are offloading our assertion and callback to the complete of DOM load through the <strong>World</strong> to ensure that we have successfully loaded the application.</p>
<p>This will now fail on <span style="color: red;">- Object #&lt;World&gt; has no method &#39;domload&#39;</span>, so let&#39;s get that fixed up:</p>
<p><em>/features/support/world.js</em></p>
<pre><code><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> World = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">World</span><span class="hljs-params">(callback)</span> {</span>

  <span class="hljs-keyword">this</span>.window = process.browser ? window : {};
  <span class="hljs-keyword">this</span>.app = <span class="hljs-literal">undefined</span>;
  <span class="hljs-keyword">this</span>.groceryListApplication = <span class="hljs-literal">undefined</span>;

  <span class="hljs-keyword">var</span> defineGlobals = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(w, doc)</span> {</span>
    <span class="hljs-keyword">this</span>.app = w.app;
  };

  <span class="hljs-keyword">this</span>.domload = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
    (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(world)</span> {</span>
      <span class="hljs-keyword">if</span>(document.readyState === <span class="hljs-string">'complete'</span>) {
        defineGlobals.call(world, window, document);
        callback();  
      }
      <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> delegate = document.addEventListener ? <span class="hljs-string">'addEventListener'</span> : <span class="hljs-string">'attachEvent'</span>;
        <span class="hljs-keyword">var</span> eventType = document.addEventListener ? <span class="hljs-string">'load'</span> : <span class="hljs-string">'onload'</span>;
        window[delegate](eventType, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
          defineGlobals.call(world, window, document);
          callback();
        });
      }
    }(<span class="hljs-keyword">this</span>));
  };

  <span class="hljs-keyword">this</span>.openGroceryList = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.app.newSession();
  };
  <span class="hljs-keyword">this</span>.createGroceryItem = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'apple'</span>;
  };

  callback();

};

module.exports.World = World;
</code></pre><p>Woohoo! Now we are back with the exception <span style="color: red;">Object #&lt;World&gt; has no method &#39;emptyGroceryListView&#39;</span> that got us in this mess... <em>BUT</em> the previous tests we had <span style="color: green;">passing</span> are now passing again :)</p>
<p>For the sake of getting too &quot;noisy&quot; with code and explanations, for the following edits - unless an explanation is deemed worthy - I will just roll along with modifications to the test and source and show the series of <span style="color: red;">failures</span>.</p>
<p><em>/features/support/world.js</em></p>
<pre><code><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> World = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">World</span><span class="hljs-params">(callback)</span> {</span>

  <span class="hljs-keyword">this</span>.window = process.browser ? window : {};
  <span class="hljs-keyword">this</span>.app = <span class="hljs-literal">undefined</span>;
  <span class="hljs-keyword">this</span>.groceryListApplication = <span class="hljs-literal">undefined</span>;

...

  <span class="hljs-keyword">this</span>.emptyGroceryListView = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.groceryListApplication.empty();
  };

  callback();

};

module.exports.World = World;
</code></pre><p><span style="color: red;">- Object #&lt;World&gt; has no method &#39;empty&#39; at World.emptyGroceryListView</span></p>

<p><em>/script/app.js</em></p>
<pre><code><span class="hljs-keyword">...</span>

var application = {
  init: <span class="hljs-keyword">function</span>(list) {
    this.list = list;
    <span class="hljs-keyword">return</span> this;
  },
  empty: <span class="hljs-keyword">function</span>() {
    this.list.empty();
  }
};

<span class="hljs-keyword">...</span>
</code></pre><p><span style="color: red;">- Object #&lt;World&gt; has no method &#39;getGroceryListView&#39; at World</span></p>

<p><em>/features/support/world.js</em></p>
<pre><code><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> World = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">World</span><span class="hljs-params">(callback)</span> {</span>

  <span class="hljs-keyword">this</span>.window = process.browser ? window : {};
  <span class="hljs-keyword">this</span>.app = <span class="hljs-literal">undefined</span>;
  <span class="hljs-keyword">this</span>.groceryListApplication = <span class="hljs-literal">undefined</span>;

...

  <span class="hljs-keyword">this</span>.getGroceryListView = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.groceryListApplication.$listview;
  };

  callback();

};

module.exports.World = World;
</code></pre><p><span style="color: red;">- Cannot read property &#39;childNodes&#39; of undefined at World</span></p>

<p><em>/script/app.js</em></p>
<pre><code><span class="hljs-keyword">...</span>

var application = {
  init: <span class="hljs-keyword">function</span>(list) {
    this.list = list;
    this.$listview = document.querySelector(<span class="hljs-string">'#grocery-list'</span>);
    <span class="hljs-keyword">return</span> this;
  },
  empty: <span class="hljs-keyword">function</span>() {
    var gl = this.$listview;
    <span class="hljs-keyword">while</span> (gl.hasChildNodes()) {
      gl.removeChild(gl.lastChild);
    }
    this.list.empty();
  }
};

<span class="hljs-keyword">...</span>
</code></pre><p><span style="color: red;">- Cannot read property &#39;childNodes&#39; of null at World</span></p>

<p><em>/template/testrunner.html</em></p>
<pre><code><span class="hljs-doctype">&lt;!doctype html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
    ...
    <span class="hljs-tag">&lt;<span class="hljs-title">ul</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"grocery-list"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"./script/app.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span>
</code></pre><p>And we are back to <span style="color: green;">green</span>!... and <span style="color: rgb(117, 117, 37);">pending</span>. Let&#39;s move on to our next step definition:</p>
<h3 id="when-i-provide-a-valid-grocery-list-item-name">When I provide a valid grocery list item name</h3>
<p>_/features/step<em>definitions/add-item-view.steps.js</em></p>
<pre><code><span class="hljs-keyword">...</span>

var enteredItem;

this.Given(/^I have an empty grocery list view$/, <span class="hljs-keyword">function</span>(callback) {
  this.emptyGroceryListView();
  assert.equal(this.getGroceryListView().childNodes.length, <span class="hljs-number">0</span>);
  callback();
});

this.When(/^I provide a valid grocery list item name$/, <span class="hljs-keyword">function</span>(callback) {
  enteredItem = this.createGroceryItem();
  this.enterNewGorceryListItem(enteredItem);
  callback();
});

<span class="hljs-keyword">...</span>
</code></pre><p>Back in the <span style="color: red;">red</span>!  </p>
<p><span style="color: red;">- Object #&lt;World&gt; has no method &#39;enterNewGorceryListItem&#39; at World</span></p>

<p><em>/features/support/world.js</em></p>
<pre><code><span class="hljs-keyword">var</span> World = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">World</span><span class="hljs-params">(callback)</span> {</span>

  <span class="hljs-keyword">this</span>.window = process.browser ? window : {};
  <span class="hljs-keyword">this</span>.app = <span class="hljs-literal">undefined</span>;
  <span class="hljs-keyword">this</span>.groceryListApplication = <span class="hljs-literal">undefined</span>;

  <span class="hljs-keyword">var</span> defineGlobals = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(w, doc)</span> {</span>
    <span class="hljs-keyword">this</span>.app = w.app;
  };

...

  <span class="hljs-keyword">this</span>.enterNewGorceryListItem = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span> {</span>
    <span class="hljs-keyword">this</span>.groceryListApplication.enterNewItem(item);
  };

  callback();

};

module.exports.World = World;
</code></pre><p><span style="color: red;">- Object #&lt;Object&gt; has no method &#39;enterNewItem&#39; at World.enterNewGorceryListItem</span></p>

<p><em>/script/app.js</em></p>
<pre><code><span class="hljs-keyword">...</span>

var application = {
  init: <span class="hljs-keyword">function</span>(list) {
    this.list = list;
    this.$listview = document.querySelector(<span class="hljs-string">'#grocery-list'</span>);
    this.$itemInputView = document.querySelector(<span class="hljs-string">'#item-input'</span>);
    <span class="hljs-keyword">return</span> this;
  },
  empty: <span class="hljs-keyword">function</span>() {
    var gl = this.$listview;
    <span class="hljs-keyword">while</span> (gl.hasChildNodes()) {
      gl.removeChild(gl.lastChild);
    }
    this.list.empty();
  },
  enterNewItem: <span class="hljs-keyword">function</span>(item) {
    this.$itemInputView.value = item;
  }
};

<span class="hljs-keyword">...</span>
</code></pre><p><span style="color: red;">- Cannot set property &#39;value&#39; of null at Object.application.enterNewItem</span></p>

<p><em>/template/testrunner.html</em></p>
<pre><code><span class="hljs-doctype">&lt;!doctype html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
    ...
    <span class="hljs-tag">&lt;<span class="hljs-title">ul</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"grocery-list"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">form</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">label</span> <span class="hljs-attribute">for</span>=<span class="hljs-value">"itemInput"</span>&gt;</span>Item name:<span class="hljs-tag">&lt;/<span class="hljs-title">label</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"item-input"</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"itemInput"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">item</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"./script/app.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span>
</code></pre><p>Back to <span style="color: rgb(117, 117, 37);">pending</span>! Next step:</p>
<h3 id="and-i-select-to-add-an-item">And I select to add an item</h3>
<p>_/features/step<em>definitions/add-item-view.steps.js</em></p>
<pre><code><span class="hljs-keyword">...</span>

this.When(/^I select to add an item$/, <span class="hljs-keyword">function</span>(callback) {
  this.clickAddGroceryListItem();
  callback();
});

<span class="hljs-keyword">...</span>
</code></pre><p><span style="color: red;">- Object #&lt;World&gt; has no method &#39;clickAddGroceryListItem&#39; at World.</span></p>

<p><em>/features/support/world.js</em></p>
<pre><code><span class="hljs-keyword">var</span> World = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">World</span><span class="hljs-params">(callback)</span> {</span>

  <span class="hljs-keyword">this</span>.window = process.browser ? window : {};
  <span class="hljs-keyword">this</span>.app = <span class="hljs-literal">undefined</span>;
  <span class="hljs-keyword">this</span>.groceryListApplication = <span class="hljs-literal">undefined</span>;

  <span class="hljs-keyword">var</span> defineGlobals = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(w, doc)</span> {</span>
    <span class="hljs-keyword">this</span>.app = w.app;
  };

...

  <span class="hljs-keyword">this</span>.createClickEvent = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> event = document.createEvent(<span class="hljs-string">'MouseEvents'</span>);
    event.initEvent(<span class="hljs-string">'click'</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);
    <span class="hljs-keyword">return</span> event;
  };

  <span class="hljs-keyword">this</span>.clickAddGroceryListItem = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> clickevent = <span class="hljs-keyword">this</span>.createClickEvent();
    <span class="hljs-keyword">this</span>.groceryListApplication.$addbutton.dispatchEvent(clickevent);
  };

...

  callback();

};

module.exports.World = World;
</code></pre><p><span style="color: red;">- Cannot call method &#39;dispatchEvent&#39; of undefined at World.clickAddGroceryListItem</span></p>

<p><em>/script/app.js</em></p>
<pre><code><span class="hljs-keyword">var</span> application = {
  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(list)</span> {</span>
    this.<span class="hljs-keyword">list</span> = <span class="hljs-keyword">list</span>;
    this.<span class="hljs-variable">$listview</span> = document.querySelector(<span class="hljs-string">'#grocery-list'</span>);
    this.<span class="hljs-variable">$itemInputView</span> = document.querySelector(<span class="hljs-string">'#item-input'</span>);
    this.<span class="hljs-variable">$addbutton</span> = document.querySelector(<span class="hljs-string">'#add-button'</span>);
    <span class="hljs-keyword">return</span> this;
  },
  <span class="hljs-keyword">empty</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> gl = this.<span class="hljs-variable">$listview</span>;
    <span class="hljs-keyword">while</span> (gl.hasChildNodes()) {
      gl.removeChild(gl.lastChild);
    }
    this.<span class="hljs-keyword">list</span>.<span class="hljs-keyword">empty</span>();
  },
  enterNewItem: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span> {</span>
    this.<span class="hljs-variable">$itemInputView</span>.value = item;
  }
};
</code></pre><p><span style="color: red;">- Cannot call method &#39;dispatchEvent&#39; of null at World.clickAddGroceryListItem</span></p>

<p><em>/template/testrunner.html</em></p>
<pre><code><span class="hljs-doctype">&lt;!doctype html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
    ...
    <span class="hljs-tag">&lt;<span class="hljs-title">ul</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"grocery-list"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">form</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">label</span> <span class="hljs-attribute">for</span>=<span class="hljs-value">"itemInput"</span>&gt;</span>Item name:<span class="hljs-tag">&lt;/<span class="hljs-title">label</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"item-input"</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"itemInput"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">item</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">button</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"add-button"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"button"</span>&gt;</span>add<span class="hljs-tag">&lt;/<span class="hljs-title">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"./script/app.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span>
</code></pre><p>Back to <span style="color: rgb(117, 117, 37);">pending</span>! We&#39;re getting into assertion territory :) Next step:</p>
<h3 id="then-the-item-is-added-to-the-grocery-list-view">Then The item is added to the grocery list view</h3>
<p>_/features/step<em>definitions/add-item-view.steps.js</em></p>
<pre><code><span class="hljs-keyword">...</span>

this.Then(/^The item is added to the grocery list view$/, <span class="hljs-keyword">function</span>(callback) {
  assert.equal(this.getGroceryListViewItemAtIndex(<span class="hljs-number">0</span>), enteredItem, <span class="hljs-string">'Entered item should be first in empty list.'</span>);
  callback();
});

<span class="hljs-keyword">...</span>
</code></pre><p><span style="color: red;">- Object #&lt;World&gt; has no method &#39;getGroceryListViewItemAtIndex&#39; at World</span></p>

<p><em>/features/support/world.js</em></p>
<pre><code>var World = <span class="hljs-keyword">function</span> World(callback) {

  this.window = process.browser ? window : {};
  this.app = undefined;
  this.groceryListApplication = undefined;

  var defineGlobals = <span class="hljs-keyword">function</span>(w, doc) {
    this.app = w.app;
  };

<span class="hljs-keyword">...</span>

  this.getGroceryListViewItemAtIndex = <span class="hljs-keyword">function</span>(index) {
    <span class="hljs-keyword">return</span> this.groceryListApplication.$listview.childNodes[index].textContent;
  }

<span class="hljs-keyword">...</span>

  callback();

};

module.exports.World = World;
</code></pre><p><span style="color: red;">- Cannot read property &#39;textContent&#39; of undefined at World.getGroceryListViewItemAtIndex</span></p>

<p><em>/script/app.js</em></p>
<pre><code>...

<span class="hljs-keyword">var</span> application = {
  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(list)</span> {</span>
    this.<span class="hljs-keyword">list</span> = <span class="hljs-keyword">list</span>;
    this.<span class="hljs-variable">$listview</span> = document.querySelector(<span class="hljs-string">'#grocery-list'</span>);
    this.<span class="hljs-variable">$itemInputView</span> = document.querySelector(<span class="hljs-string">'#item-input'</span>);
    this.<span class="hljs-variable">$addbutton</span> = document.querySelector(<span class="hljs-string">'#add-button'</span>);
    (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(app)</span> {</span>
      app.<span class="hljs-variable">$addbutton</span>.addEventListener(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
        <span class="hljs-keyword">var</span> item = app.<span class="hljs-variable">$itemInputView</span>.value;
        app.addItemToView(item);
      });
    }(this));
    <span class="hljs-keyword">return</span> this;
  },
  <span class="hljs-keyword">empty</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> gl = this.<span class="hljs-variable">$listview</span>;
    <span class="hljs-keyword">while</span> (gl.hasChildNodes()) {
      gl.removeChild(gl.lastChild);
    }
    this.<span class="hljs-keyword">list</span>.<span class="hljs-keyword">empty</span>();
  },
  enterNewItem: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span> {</span>
    this.<span class="hljs-variable">$itemInputView</span>.value = item;
  },
  addItemToView: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span> {</span>
    <span class="hljs-keyword">var</span> li = document.createElement(<span class="hljs-string">'li'</span>);
    <span class="hljs-keyword">var</span> text = document.createTextNode(item);
    li.appendChild(text);
    this.<span class="hljs-variable">$listview</span>.appendChild(li);
  }
};

...
</code></pre><p>By adding a <code>click</code> handler to the <code>button</code>, we are updating the view by adding a <code>li</code> element to the list view.</p>
<p>And we&#39;re back to <span style="color: rgb(117, 117, 37);">pending</span>! One last step:</p>
<h3 id="then-the-item-is-accessible-from-the-grocery-list-collection">Then The item is accessible from the grocery list collection</h3>
<p>_/features/step<em>definitions/add-item-view.steps.js</em></p>
<pre><code><span class="hljs-keyword">...</span>

this.Then(/^The item is accessible from the grocery list collection$/, <span class="hljs-keyword">function</span>(callback) {
  assert.equal(this.groceryListApplication.list.getItemIndex(enteredItem), <span class="hljs-number">0</span>, <span class="hljs-string">'Added item should be found at first index.'</span>);
  callback();
});

<span class="hljs-keyword">...</span>
</code></pre><p>Utilizing the <code>getItemIndex()</code> method we created in passing the collection features from a previous article, we get back to failing.</p>
<p><span style="color: red;">- Added item should be found at first index. at World</span></p>
<p><em>/script/app.js</em></p>
<pre><code><span class="hljs-keyword">...</span>

var application = {
  init: <span class="hljs-keyword">function</span>(list) {
    this.list = list;
    this.$listview = document.querySelector(<span class="hljs-string">'#grocery-list'</span>);
    this.$itemInputView = document.querySelector(<span class="hljs-string">'#item-input'</span>);
    this.$addbutton = document.querySelector(<span class="hljs-string">'#add-button'</span>);
    (<span class="hljs-keyword">function</span>(app) {
      app.$addbutton.addEventListener(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(event) {
        var item = app.$itemInputView.value;
        app.addItemToView(item);
        app.list.add(item);
      });
    }(this));
    <span class="hljs-keyword">return</span> this;
  },
  <span class="hljs-keyword">...</span>
};

<span class="hljs-keyword">...</span>
</code></pre><p>In adding a call to <code>list.add()</code> in the button handler within we just defined an update to the view, we bring ourselves to full <span style="color: green;">green</span>!</p>
<div style="width: 100%; overflow-x: scroll; background-color:#fff; text-align: center;">
  <img src="https://custardbelly.com/blog/images/cucumberjs-browser-3.png" alt="cucumberjs in the browser, passing">
</div>

<h2 id="considerations">Considerations</h2>
<p>If you have following along in getting these new browser-based <strong>Features</strong> to pass in that environment, I have taken some liberties with regards to architecture and process with the hopes to not add noise to the task at hand.</p>
<p>In reality, we should consider the next phase as a <em>Refactor</em>. The particular areas in which I see issues that I would address and.or discuss with my team are:</p>
<ul>
<li>Implementing view update based on collection events</li>
<li>Templatize-ing the main view to be wrapped in production and injecting as a partial to the testrunner template</li>
<li>Building the application to be deployed as a web-based application and User Tested</li>
</ul>
<p>I am sure there are more, and that you have a few ideas as well, but these are at least three aspects of the architecture of the project and product that can be tackled with assurance now that we have a test harness for the features criteria :)</p>
<h2 id="conclusion">Conclusion</h2>
<p>If you made it down this far, I do appreciate you taking the time to follow along - I know this was a bit of a long one.</p>
<p>I hoped to have demonstrated the process of going from <strong>Features</strong> to <strong>Step Definitions</strong> to implementation code to pass criteria all while living in a real browser environment using the <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> and test automation. On the surface, it may seem like quite a process, but my personal experience is that BDD forces you into thinking about minimilistic design while putting your code under a test harness from which you can maintain and add new features with assurance.</p>
<p>Source for examples related to this post can be found in the <a href="https://github.com/bustardcelly/cucumberjs-examples/tree/0.5.0.post">0.5.0.post tag on my Github account</a>.</p>
<h2 id="to-come">To Come</h2>
<p>There are a few extra productivity tidbits I have picked up while working with the wondeful <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> tool in developing several applications for both the web and server.</p>
<p>Who knows... I have had a blast going through the articles in this series demonstrating TDD using the BDD tool, <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a>. I might just continue to evolve the example to a fully-functional application just as I had done in the <a href="https://custardbelly.com/blog/blog-pages/category/grocery-ls.html">Making of a Test-Driven Grocery List Application</a> series which focused on the <a href="http://jasmine.github.io/2.0/introduction.html">Jasmine</a> library.</p>
<p>Additionally, I am invested in the <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> I created during (and as a result) of this series and hope to write some more articles on its structure, usage and any additions/fixes that are made and I welcome you to help me in making <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> a great tool in being able run your specs in a real browser environment without having to change your current workflow in defining <strong>Features</strong>, <strong>Step Definitions</strong> and support files.</p>
<p>Cheers!</p>
]]></description><link>https://www.custardbelly.com/blog/blog-posts/2014/02/12/cucumberjs-browser-update/index.html</link><guid isPermaLink="true">https://www.custardbelly.com/blog/blog-posts/2014/02/12/cucumberjs-browser-update/index.html</guid><dc:creator><![CDATA[Todd Anderson]]></dc:creator><pubDate>Invalid Date</pubDate></item><item><title><![CDATA[BDD in JavaScript IV: CucumberJS and The Browser]]></title><description><![CDATA[<p>In my <a href="https://custardbelly.com/blog/blog-posts/2014/01/29/cucumberjs-build/index.html">previous post</a> in this series detailing how I use <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a>, I addressed a few common build tools in JavaScript to automate the watching and running of tests. While beneficial to a proper agile workflow, I did not introduce any new concepts or development information directly associated with using CucumberJS, itself.</p>
<p>In this article, I intend to take on a pretty meaty subject - running your cukes in the browser. It is a subject I have grappled with for some time and have tried different solutions, eventually <a href="https://github.com/bustardcelly/cucumberjs-browser">creating my own</a>. </p>
<h3 id="-gt-code">&gt; code</h3>
<p>Supported files related to this and any subsequent posts on this topic will be available at:<br><a href="https://github.com/bustardcelly/cucumberjs-examples">https://github.com/bustardcelly/cucumberjs-examples</a></p>
<p><em>Disclaimer: I did not start out this series to promote the <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> tool. In fact, it came to life as a result of this series :)</em></p>
<h2 id="why-the-browser">Why The Browser</h2>
<p><a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> is built on <a href="http://nodejs.org">Node</a>. As such, the CLI tool that we have been running to verify our tests in previous articles is living in that environment. </p>
<p>This is well and good if we were creating an application that was intended to live within Node. However, what if we are building an application that is to live inside the browser, which is often the case for me as a, primarily, Front End Developer? How do we go from <strong>Features</strong> detailing DOM interaction to passing <strong>Step Definitions</strong> that require a browser environment using <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a>?</p>
<h2 id="options">Options</h2>
<p>The following options are those I have found or been alerted to by the community. I have used a few of them to much benefit, but felt there was always one or two things that kept me from truly embracing them as a good solution. I hope to showcase their strengths and weaknesses to allow you to make a more informed decision on what may be the best for your team.</p>
<h3 id="writing-specs-in-the-dom">Writing Specs in the DOM</h3>
<p>Example: <a href="https://github.com/cucumber/cucumber-js/blob/master/example/index.html">https://github.com/cucumber/cucumber-js/blob/master/example/index.html</a>.</p>
<p>This is an example from the <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> team that demonstrates how to define <strong>Features</strong> and <strong>Step Definitions</strong> in <code>textarea</code> elements. These are read and evaluated at runtime by the bundled browser-based CucumberJS library, with the assertions being printed to the DOM as well.</p>
<p>A reasonable approach, and much of its implementation was an inspiration for my <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> tool (addressed later). My main issue with incorporating this into my development and testing workflow is the break in having my <strong>Features</strong>, <strong>Step Definitions</strong> and test support as entities residing in separate files as we have done in the examples of previous articles in this series. Instead of curating <strong>Features</strong> in a much more organized way involving the file system, I would need to maintain them in the textual values defined for <code>textarea</code>s in a web page. My workflow just seemed interrupted in doing so; I could not directly relate a Ticket in our Issue Tracker with a <strong>Feature</strong> file and its associated <strong>Step</strong> file(s).</p>
<h3 id="zombiejs">ZombieJS</h3>
<p>There are small examples on the landing page for <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> repo that are fairly easy to follow and there is a great example <a href="http://www.antonydenyer.co.uk/">Antony Denyer</a> as well: <a href="https://github.com/antonydenyer/zombiejsplayground">https://github.com/antonydenyer/zombiejsplayground</a>.</p>
<p>The <a href="http://zombie.labnotes.org/">ZombieJS</a> API is actually quite easy to understand and use and have incorporated using Zombie in a couple of my projects. The main issue I have in using Zombie in all my projects is &quot;trust&quot;. Not trust in Zombie as a good tool, trust in that the assertions are cross-browser; under the covers, it is a mixture of the DOM library <a href="http://jsdom.org/">JSDom</a>, <a href="https://github.com/brianmcd/contextify">Contextify</a> for V8 execution and various other - very excellent, I should say - libraries that are used to &#39;emulate&#39; a browser in a headless manner.</p>
<p>Again, I don&#39;t want that explanation to take away from the excellent tool that <a href="http://zombie.labnotes.org/">ZombieJS</a> is and its usefulness and benefits it has provided me in previous (and future) projects. Infact, while I was <a href="https://twitter.com/_toddanderson_/status/414210165001699328">extolling its virtues over twitter</a>, <a href="https://twitter.com/s9tpepper">Omar Gonzalez</a> reminded me that it is best to run tests in browsers and tipped me to his project <a href="https://github.com/s9tpepper/karma-cucumberjs">karma-cucumberjs</a>.</p>
<p>Omar was right. While it has a nice API and is quick and easy to get working, it is not a real browser. In the end, I may have false positives and if I was to go to production with my application that requires cross-browser support, issues may arise that the tests did not catch under Zombie.</p>
<h3 id="karma-cucumberjs">karma-cucumberjs</h3>
<p>As mentioned in the previous section, respected TDD&#39;er <a href="https://twitter.com/s9tpepper">Omar Gonzalez</a> has a project - <a href="https://github.com/s9tpepper/karma-cucumberjs">karma-cucumberjs</a> - that allows you to define Cucumber specs for the browser and provides an adapter for the <a href="http://karma-runner.github.io/0.10/index.html">Karma</a> testrunner.</p>
<p>Now, I have not personally tried it (apologies, Omar!), nor do I use <a href="http://karma-runner.github.io/0.10/index.html">Karma</a>. Both are filed under <code>Things to Look Into</code>. I will say, what kept me from jumping in and testing the waters was similar to the reason for not using the <a href="https://github.com/cucumber/cucumber-js/blob/master/example/index.html">DOM example</a> provided by the <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> team: I had to write my <strong>Step Definitions</strong> differently than I normally would - specifically, I would have to wrap them in a <code>addStepDefinitions</code> function.</p>
<p>Again, a viable solution from a venerable developer whom I trust, but I have not personally used because I wanted to keep my workflow relatively the same as I would in defining <strong>Features</strong> and <strong>Step Definitions</strong> for specs don&#39;t need to know about or run under a browser environment.</p>
<h3 id="cucumberjs-browser">cucumberjs-browser</h3>
<p>Not finding a solution that afforded me to simply deploy my <strong>Features</strong>, <strong>Steps Definitions</strong> and subsequent support files to be run in the browser, I decided to make one that would allow me to; and so <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> was born.</p>
<p>In basic terms, what <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> does is bundle the <strong>Features</strong>, <strong>Step Definitions</strong> and any support files into standalone modules (using <a href="http://browserify.org/">browserify</a>) and defines them for a page using a <a href="http://lodash.com/docs">lodash</a> template. Included, as well, is the bundled library from <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a>. </p>
<p>When the page is loaded in any browser, the specs are run just as they normally would be from the command line. Through the CLI options, you have the ability to define a listener that will handle the passing and failing of steps. _Current support for <a href="http://en.wikipedia.org/wiki/Test_Anything_Protocol">TAP</a> in console and basic UI. More to come..._</p>
<p>The <a href="https://github.com/bustardcelly/cucumberjs-browser/blob/master/README.md">README</a> is probably the best place to start as it will be kept more up to date than this post in the future, but here is a quick rundown:</p>
<h4 id="installation">Installation</h4>
<p>You install <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> globally through npm:</p>
<pre><code>$ npm install <span class="hljs-attribute">-g</span> cucumberjs<span class="hljs-attribute">-browser</span>
</code></pre><h4 id="usage">Usage</h4>
<p>To run the tool, you can use the following options:</p>
<pre><code>$ <span class="hljs-tag">cucumberjs-browser</span> <span class="hljs-attr_selector">[-o outdir]</span> <span class="hljs-attr_selector">[-f format]</span> <span class="hljs-attr_selector">[--tmpl template]</span> <span class="hljs-attr_selector">[--features features]</span>
</code></pre><p>There are defaults for each of these options and you most likely will only really need to provide a custom template to be used based on the requirements of your project. The basic one that ships with the tool does nothing but load and run your specs: <a href="https://github.com/bustardcelly/cucumberjs-browser/blob/master/template/cucumber-testrunner.template">cucumber-testrunner.template</a>. This should be a jumping off point in which you add your css and scripts and anything else required to get your tests passing. Again, it uses <a href="http://lodash.com/docs">lodash</a> to generate the page, so bear that in mind.</p>
<h4 id="output">Output</h4>
<p>If we were to run <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> against the current work we have been doing in this series and then open any browser, we would be presented with something like the following:</p>
<div style="width: 100%; overflow-x: scroll; background-color:#fff; text-align: center;">
  <img src="https://custardbelly.com/blog/images/cucumberjs-browser-1.png" alt="cucumberjs in the browser">
</div>

<h2 id="conclusion">Conclusion</h2>
<p>For this post, I had originally started updating the example we have been working through in this series to incoprate User Interaction with the application in a browser with <span style="color: red;">failing</span> tests everywhere... it made me smile :) But, I felt it was extending the length of this post to a point in which it was becoming information overload.</p>
<p>As such, I am in the middle of a follow up post in how to utilize <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a> for our current Grocery List Application example in delivering a test-driven browser-based application supported by <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> specs.</p>
<p>At the very least, I hope this post highlighted some possible solutions for testing in the browser and will draw you back to the following post where i go more in depth about working with <a href="https://github.com/bustardcelly/cucumberjs-browser">cucumberjs-browser</a>. &#39;Til then...</p>
]]></description><link>https://www.custardbelly.com/blog/blog-posts/2014/02/10/cucumberjs-tests-browser/index.html</link><guid isPermaLink="true">https://www.custardbelly.com/blog/blog-posts/2014/02/10/cucumberjs-tests-browser/index.html</guid><dc:creator><![CDATA[Todd Anderson]]></dc:creator><pubDate>Invalid Date</pubDate></item><item><title><![CDATA[BDD in JavaScript III: CucumberJS and Test Automation]]></title><description><![CDATA[<p>In my <a href="https://custardbelly.com/blog/blog-posts/2014/01/22/cucumberjs-world/index.html">previous post</a> I addressed the concepts of the <strong>World</strong> context and <strong>Background</strong> scenario. I am going to pause in actually working with <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> in delivering code in a BDD manner for this article and address another vital part of the development process: <strong>Automation</strong>.</p>
<h3 id="-gt-code">&gt; code</h3>
<p>Supported files related to this and any subsequent posts on this topic will be available at:<br><a href="https://github.com/bustardcelly/cucumberjs-examples">https://github.com/bustardcelly/cucumberjs-examples</a></p>
<h2 id="why-automate-">Why Automate?</h2>
<p>The benefit of automation is in time saved. If we can pinpoint tasks that we do repetitively during development and automate them, we can save large amounts of time that could be put back into doing more coding, thinking, learning, laughing, beering - the list goes on.</p>
<p>While going through the basics of <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> in the previous articles, I was demonstrating how I use the tool to TDD from the outside-in and constantly hopping back and forth from my code editor to the terminal to run this simple command over and over:</p>
<pre><code><span class="hljs-variable">$ </span>node node_modules/.bin/cucumber-js
</code></pre><p>Now, I am pretty good at <code>CMD+TAB</code> - not to brag - but I would much prefer to get feedback on my tests instantly as I describe my asserts and modify my code. If we automate the running of <strong>Cucumber</strong> on file change, we can start seeing results quicker and we can take that time removed from manually switching between editor and terminal and running commands and put that time back into thinking how to design our code more cleanly :)</p>
<p>This automation and instant feedback really shows its worth in the <strong>Refactor</strong> phase in which you have previously implemented code to pass the criteria in a <strong>Feature</strong>.</p>
<h2 id="task-automation-and-javascript">Task Automation and JavaScript</h2>
<p>When talking about build tools and task automation for JavaScript projects, there are roughly 3 types of task runners that are brought up:</p>
<ol>
<li><a href="http://gruntjs.com/">Grunt</a></li>
<li><a href="http://gulpjs.com/">Gulp</a></li>
<li><a href="http://substack.net/task_automation_with_npm_run">npm run</a></li>
</ol>
<p>There are additional tools that have been around for some time - particularly, in the past I have used <a href="http://ant.apache.org/">Ant</a> and <a href="http://www.gnu.org/software/make/">Make</a> for my build process - but, generally speaking, these are the prevelant tools of the trade in JavaScript as it stands today. </p>
<p>Some people think that each oppose each other, but I lean toward utilizing one or the others based on its merits and the requirements of a project. I have several on-going projects, both professional and personal, and each project actually incorporates one of each of these. I will discuss my thoughts on the value of each tool within each section in which I set up automation for our <a href="https://github.com/cucumber/cucumber-js">Cucumber</a> tests.</p>
<h2 id="npm-run">Npm run</h2>
<p>I&#39;ll start off with the basics. By basics, I mean that there is no additonal tool required to install and get up and running with our test automation; we have everything already installed that we need: node &amp; npm.</p>
<h3 id="benifits">Benifits</h3>
<p><a href="https://twitter.com/substack">James Halliday</a> had previously written a <a href="http://substack.net/task_automation_with_npm_run">great post</a> addressing the use of <code>npm run</code> in task automation, and I agree in so far as keeping things simple. The benefits of defining tasks in the <code>scripts</code> tag of your <code>package.json</code> file are <strong>a) simplicity</strong> and <strong>b) no additional tooling</strong>. I do have the reservations that the &quot;simplicity&quot; vanishes if you have to eventually maintain dozens of tasks - some that may be similar with different arguments - and continually want to run series and parallels. </p>
<p>When your build process becomes more complex, <a href="https://twitter.com/substack">James Halliday</a> does mention moving it to a bash file, but I would argue to perhaps look at a more robust solution with the tools described previously (and in more detail later in this article).</p>
<h3 id="usage">Usage</h3>
<p>If we were to simply take the process of running our tests as we have in previous articles, we can modify our <code>package.json</code> file by adding the following <code>scripts</code> tag and task:</p>
<p><em>package.json</em></p>
<pre><code>{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"cucumberjs-examples"</span>,
  <span class="hljs-keyword">...</span>
  <span class="hljs-string">"scripts"</span>: {
      <span class="hljs-string">"test"</span>: <span class="hljs-string">"node node_modules/.bin/cucumber-js"</span>
  }
  <span class="hljs-keyword">...</span>
}
</code></pre><p>Plain and simple. To run it, we&#39;d hop over to our terminal:</p>
<pre><code>$ npm run test

<span class="hljs-subst">&gt;</span> cucumberjs<span class="hljs-attribute">-examples</span>@<span class="hljs-number">0.1</span><span class="hljs-number">.0</span> test /Users/toddanderson/Documents/workspace/custardbelly/cucumberjs<span class="hljs-attribute">-example</span>
<span class="hljs-subst">&gt;</span> node node_modules<span class="hljs-subst">/</span><span class="hljs-built_in">.</span>bin/cucumber<span class="hljs-attribute">-js</span>
<span class="hljs-attribute">...</span><span class="hljs-attribute">...</span><span class="hljs-built_in">..</span>

<span class="hljs-number">2</span> scenarios (<span class="hljs-number">2</span> passed)
<span class="hljs-number">8</span> steps (<span class="hljs-number">8</span> passed)
</code></pre><p>Same result. We get to type less now, so that&#39;s good. However, we are not really automating the process for running our tests. As mentioned previously, we are looking for the benefit of automating the running of our tests on change to <strong>Step Definitions</strong> and code.</p>
<p>As such, we create a simple node script that will watch our <code>script</code> and <code>feature/step_definitions</code> and run the <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> CLI tool on each change:</p>
<p><strong>cuke-watcher.js</strong></p>
<pre><code>#!<span class="hljs-regexp">/usr/</span>bin/env node
<span class="hljs-keyword">var</span> watch = <span class="hljs-built_in">require</span>(<span class="hljs-string">'node-watch'</span>);
<span class="hljs-keyword">var</span> child_process = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>);
<span class="hljs-keyword">var</span> running = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">var</span> cucumber;

<span class="hljs-keyword">var</span> JS_EXT = <span class="hljs-regexp">/^.*\.js/i</span>;
<span class="hljs-keyword">var</span> options = [<span class="hljs-string">'node_modules/.bin/cucumber-js'</span>, 
               <span class="hljs-string">'features'</span>, 
               <span class="hljs-string">'-r'</span>, <span class="hljs-string">'features/step_definitions'</span>,
               <span class="hljs-string">'-f'</span>, <span class="hljs-string">'pretty'</span>];

watch([<span class="hljs-string">'./features/step_definitions'</span>, <span class="hljs-string">'script'</span>], {recursive:<span class="hljs-literal">true</span>}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(filename)</span> {</span>

  <span class="hljs-keyword">if</span>(!running &amp;&amp; filename.match(JS_EXT)) {

    running = <span class="hljs-literal">true</span>;

    cucumber = child_process.spawn(<span class="hljs-string">'node'</span>, options)
                    .on(<span class="hljs-string">'exit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                      running = <span class="hljs-literal">false</span>;
                    });

    cucumber.stdout.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> {</span>
      console.log(<span class="hljs-built_in">String</span>(d));
    });

    cucumber.stderr.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> {</span>
      console.error(<span class="hljs-built_in">String</span>(d));
    });

  }

});
</code></pre><p>We are using the wonderful <a href="https://npmjs.org/package/node-watch">node-watch</a> module that is a convenient wrapper to <code>fs.watch</code>, and upon change, we spawn the <strong>Cucumber</strong> tool as a child process. Running <strong>Cucumber</strong> as a child process allows it to exit its own process without having to exit the <code>watch</code> process, which would kill all automation.</p>
<p>Modify our <code>package.json</code> to invoke this script:</p>
<p><em>package.json</em></p>
<pre><code>{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"cucumberjs-examples"</span>,
  <span class="hljs-keyword">...</span>
  <span class="hljs-string">"scripts"</span>: {
      <span class="hljs-string">"test"</span>: <span class="hljs-string">"node node_modules/.bin/cucumber-js"</span>,
      <span class="hljs-string">"watch"</span>: <span class="hljs-string">"node cuke-watcher.js"</span>
  }
  <span class="hljs-keyword">...</span>
}
</code></pre><p>And run it in the terminal:</p>
<pre><code><span class="hljs-variable">$ </span>npm run watch
</code></pre><p>And you will see the cursor flash with the <code>watch</code> process running. If you were to modify any of the <strong>Step Definition</strong> or source files of our current <a href="https://github.com/bustardcelly/cucumberjs-examples">Grocery List</a> example project, you would see <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> run and produce the same results as before - the only difference is that it is now waiting for you to modify them again so it can run again.</p>
<p>It will continue to <code>watch</code> and run tests until you exit the process, most commonly done by focusing on the terminal and hitting <code>CTRL+C</code>.</p>
<h2 id="grunt">Grunt</h2>
<p>Up until a few years ago, I  stuck with what I knew best and preferred to maintain builds for my JavaScript projects using <a href="http://www.gnu.org/software/make/">Make</a>. After having the fortunate opportunity to hear <a href="http://benalman.com/">Ben Alman</a> speak and demonstrate <a href="http://gruntjs.com/">Grunt</a> at <a href="http://2013.texasjavascript.com/">TXJS</a> in 2012, I decided to give <strong>Grunt</strong> a real try - and I have, for the most part, not looked back.</p>
<p><a href="http://gruntjs.com/">Grunt</a> is my go-to task automation tool for large projects that involve various complex tasks for developing, testing and deployment. For the most part, if my tasks are not solely based on files, I will incorporate <strong>Grunt</strong> into my project. </p>
<p>Along with a solid history and great documentation, there is also a very active community that creates task plugins for <strong>Grunt</strong>: <a href="http://gruntjs.com/plugins">http://gruntjs.com/plugins</a>. You can find virtually anything you need, and if for some odd reason you can&#39;t, you can create one: <a href="http://gruntjs.com/creating-plugins">Creating Grunt Plugins Docs</a>.</p>
<p><em>It is too much for this article to get into a discussion about <strong>Grunt</strong> and its concepts, so please read the <a href="http://gruntjs.com/getting-started">documentation</a> on their site for clarity. In this section I intend to address how to use <strong>Grunt</strong> to automate the tests we have been developing in this series.</em></p>
<h3 id="usage">Usage</h3>
<p>Just as we setup a watcher for our <strong>Step Definitions</strong> and scripts for our <code>npm run</code> example, we will be using 2 <a href="http://gruntjs.com/">Grunt</a> plugin tasks provided by the wonderful development community:</p>
<ul>
<li><a href="https://github.com/gruntjs/grunt-contrib-watch">grunt-contrib-watch</a> - maintained by the contributors for gruntjs</li>
<li><a href="https://github.com/s9tpepper/grunt-cucumber-js">grunt-cucumber</a> - maintained by venerable developer <a href="https://twitter.com/s9tpepper">Omar Gonzalez</a></li>
</ul>
<p>I will assume you have <a href="http://gruntjs.com/getting-started">Grunt installed properly</a> and start with the <code>Gruntfile</code>:</p>
<p><em>Gruntfile.js</em></p>
<pre><code>module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(grunt)</span> {</span>
<span class="hljs-pi">  'use strict'</span>;

  grunt.initConfig({
    pkg: grunt.file.readJSON(<span class="hljs-string">'package.json'</span>),
    watch: {
      cucumber: {
        files: [<span class="hljs-string">'features/**/*.js'</span>, <span class="hljs-string">'script/**/*.js'</span>],
        tasks: [<span class="hljs-string">'cucumberjs'</span>]
      }
    },
    cucumberjs: {
      src: <span class="hljs-string">'features'</span>,
      options: {
        steps: <span class="hljs-string">'features/step_definitions'</span>,
        format: <span class="hljs-string">'pretty'</span>
      }
    }
  });

  grunt.loadNpmTasks(<span class="hljs-string">'grunt-contrib-watch'</span>);
  grunt.loadNpmTasks(<span class="hljs-string">'grunt-cucumber'</span>);

  grunt.registerTask(<span class="hljs-string">'watch-tests'</span>, <span class="hljs-string">'Starts a watch for test automation.'</span>, [<span class="hljs-string">'watch:cucumber'</span>]);

};
</code></pre><p>Within the <code>Gruntfile</code> we have configured <code>cucumberjs</code> task with the same arguments we have been using in previous examples and configured a <code>watch</code> task to listen for changes to JavaScript files in the <em>features</em> and <em>script</em> directories.</p>
<p>Additionally, we have defined a <code>watch-tests</code> task which we can invoke using <strong>Grunt</strong> from the command line:</p>
<pre><code><span class="hljs-variable">$ </span>grunt watch-tests
</code></pre><p>Running that will do, essentially, what we have done using <code>npm run</code> in the previous section: the <code>watch</code> process will be active and execute the <strong>Cucumber</strong> specs upon a change to JavaScript files in the target directories. To stop the task from running, focus on the terminal and <code>CTRL+C</code> to exit the process.</p>
<h2 id="gulp">Gulp</h2>
<p><a href="http://gulpjs.com/">Gulp</a> is a (relatively) new-comer to the JavaScript-based task runner ecosystem. Like <a href="http://gruntjs.com/">Grunt</a>, it is a task-based build tool that has <a href="https://github.com/gulpjs/gulp/blob/master/README.md">good documentation</a> and a lively community <a href="http://gratimax.github.io/search-gulp-plugins/">contributing plugins</a>. All good things.</p>
<p><a href="http://gulpjs.com/">Gulp</a>&#39;s build system uses <a href="http://nodejs.org/api/stream.html">streams</a> which allows you to pipe multiple tasks together. As well, the tasks defined in the <code>gulpfile</code> are the code itself - as opposed to <strong>Grunt</strong> in which you provide a configuration for your tasks that are consumed by <strong>Grunt</strong> and provided to the targetted plugin through a task registry.</p>
<p>There are <a href="http://blog.ponyfoo.com/2014/01/09/gulp-grunt-whatever">plenty</a> of <a href="http://www.100percentjs.com/just-like-grunt-gulp-browserify-now/">other articles</a> <a href="http://jaysoo.ca/2014/01/27/gruntjs-vs-gulpjs/">contrasting the two</a>, so I won&#39;t rehash them here. I will say that I choose <strong>Gulp</strong> over <strong>Grunt</strong> in projects where the build requirements are strictly focused on files - ie, take these files, do something to them (min, concat) and put them in this directory.</p>
<p><strong>As a side note: I highly recommend <a href="https://twitter.com/substack">James Halliday</a>&#39;s excellent <a href="https://github.com/substack/stream-handbook">stream-handbook</a> to get a better understanding of streams in <a href="http://nodejs.org">node</a>.</strong></p>
<h3 id="usage">Usage</h3>
<p>The <a href="http://gratimax.github.io/search-gulp-plugins/">plugin community</a> for <a href="http://gulpjs.com/">Gulp</a> is fairly active, but as I mentioned previously <strong>Gulp</strong>&#39;s system is really based on streams. As such, I don&#39;t intend to see a plugin for running <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> tests specifically, as we have with <a href="https://github.com/s9tpepper/grunt-cucumber-js">grunt-cucumber</a> - nor do intend to make one or continue to look for one: I don&#39;t think such a plugin is well suited to <strong>Gulp</strong>.</p>
<p>That&#39;s said, we can certainly set up a <code>watch</code> task on our <strong>Step Definitions</strong> and scripts just as we have in the previous examples!</p>
<p><strong>gulpfile.js</strong></p>
<pre><code><span class="hljs-keyword">var</span> gulp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gulp'</span>);
<span class="hljs-keyword">var</span> watch = <span class="hljs-built_in">require</span>(<span class="hljs-string">'gulp-watch'</span>);
<span class="hljs-keyword">var</span> child_process = <span class="hljs-built_in">require</span>(<span class="hljs-string">'child_process'</span>);

<span class="hljs-keyword">var</span> cucumber;
<span class="hljs-keyword">var</span> running = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">var</span> options = [<span class="hljs-string">'node_modules/.bin/cucumber-js'</span>,
               <span class="hljs-string">'features'</span>, 
               <span class="hljs-string">'-r'</span>, <span class="hljs-string">'features/step_definitions'</span>,
               <span class="hljs-string">'-f'</span>, <span class="hljs-string">'pretty'</span>];

gulp.task(<span class="hljs-string">'cucumber'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">if</span>(!running) {
    running = <span class="hljs-literal">true</span>;
    cucumber = child_process.spawn(<span class="hljs-string">'node'</span>, options)
                    .on(<span class="hljs-string">'exit'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                      running = <span class="hljs-literal">false</span>;
                    });
    cucumber.stdout.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> {</span>
      console.log(<span class="hljs-built_in">String</span>(d));
    });

    cucumber.stderr.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(d)</span> {</span>
      console.error(<span class="hljs-built_in">String</span>(d));
    });
  }
});

gulp.task(<span class="hljs-string">'watch-tests'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  gulp.src([<span class="hljs-string">'features/**/*.js'</span>, <span class="hljs-string">'script/**/*.js'</span>])
      .pipe(watch(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        gulp.run(<span class="hljs-string">'cucumber'</span>);
      }));
});
</code></pre><p>Running that is very similar to how we ran our <strong>Grunt</strong> task:</p>
<pre><code><span class="hljs-variable">$ </span>gulp watch-tests
</code></pre><p>As you may notice, this example fairly similar to the <code>npm run</code> example shown previously. The main difference is that we pipe the streams through the <code>gulp-watch</code> plugin which triggers <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> as a child process upon change to targetted files.</p>
<h2 id="conclusion">Conclusion</h2>
<p>So, which one should you use? Whichever! They each have their merits and it should be discussed with your team in alignment with the requirements for the current project.</p>
<p>It was my intent to showcase how to incoporate automated testing with <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> using the three most popular task runner / build tools so we can devote more time to thinking about design instead of hopping from our code editor to the terminal for each change to our <strong>Step Definitions</strong>.</p>
<p>I didn&#39;t introduce any new concepts related to <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a>, itself, but felt it necessary to address automation at this stage within the series as I feel it is a vital part to Test-Driven Development and the Agile process and something that should be addressed in the early stages of a project.</p>
<p>That said, I look forward to the next article where we get to write more tests and which I intend to introduce running tests in a browser environment :)</p>
<p>Source for examples related to this post can be found in the <a href="https://github.com/bustardcelly/cucumberjs-examples/tree/0.3.0.post">0.3.0.post tag on my Github account</a>.</p>
]]></description><link>https://www.custardbelly.com/blog/blog-posts/2014/01/29/cucumberjs-build/index.html</link><guid isPermaLink="true">https://www.custardbelly.com/blog/blog-posts/2014/01/29/cucumberjs-build/index.html</guid><dc:creator><![CDATA[Todd Anderson]]></dc:creator><pubDate>Invalid Date</pubDate></item><item><title><![CDATA[BDD in JavaScript II: CucumberJS, the World and Background]]></title><description><![CDATA[<p>In <a href="https://custardbelly.com/blog/blog-posts/2014/01/08/bdd-in-js-cucumberjs/index.html">my previous post</a>, I demonstrated how I use <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> - the JavaScript port of the <a href="http://cukes.info/">Cucumber</a> BDD testing tool - in developing Test-Driven code. I walked through going from a <span style="color:red;">failing</span> feature with two scenarios to a <span style="color:green;">passing</span> cuke, while taking care to only add enough code that would make the assertions pass and refactoring as I went along under the assurance of a test harness.</p>
<p>There are a few topics that I didn&#39;t address in the previous post that I utilize in my testing process that I wanted to touch on in this post as any further articles I may write on the subject of <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a> most likely will reference them. These are:</p>
<ul>
<li>the World<del>, chico, and everything in it.</del></li>
<li>Background</li>
</ul>
<h3 id="-gt-code">&gt; code</h3>
<p>Supported files related to this and any subsequent posts on this topic will be available at:<br><a href="https://github.com/bustardcelly/cucumberjs-examples">https://github.com/bustardcelly/cucumberjs-examples</a></p>
<h2 id="world">World</h2>
<p>The <strong>World</strong> brings context to your <strong>Scenarios</strong>.</p>
<p>In the examples from <a href="https://custardbelly.com/blog/blog-posts/2014/01/08/bdd-in-js-cucumberjs/index.html">my previous post</a> variables were declared locally to the module export and available for reference within each <strong>Step</strong>. This may be suitable for some cases, but can cause issues or provide false results if you are not aware that those values last across the life cycle of <em>all</em> the <strong>Steps</strong> declared in that module. In other words, they are not reset for each <strong>Scenario</strong>.</p>
<p>To bring context to each <strong>Scenario</strong>, you can use the <strong>World</strong> constructor within which you can define various properties and methods that may be relevant in setting up the environment under test for each <strong>Scenario</strong>. Additonally, you access the defined <strong>World</strong> within each <strong>Step</strong> using the <code>this</code> keyword - just as you are familiar to in referencing context scope within JavaScript.</p>
<h3 id="example">Example</h3>
<p>If I were to take the complete steps module for the <em>Add Item</em> <strong>Feature</strong> from the <a href="https://github.com/bustardcelly/cucumberjs-examples/blob/0.1.0.post/features/step_definitions/add-item.steps.js">previous example</a> and modify it to incorporate a <strong>World</strong> context, it would look something like the following:</p>
<p>_/features/step<em>definitions/add-item.steps.js</em></p>
<pre><code><span class="hljs-pi">'use strict'</span>;
<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>);

module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>

  <span class="hljs-keyword">var</span> listItem;

  <span class="hljs-keyword">this</span>.World = <span class="hljs-built_in">require</span>(process.cwd() + <span class="hljs-string">'/features/support/world'</span>).World;

  <span class="hljs-keyword">this</span>.Given(<span class="hljs-regexp">/^I have an empty grocery list$/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
    <span class="hljs-keyword">this</span>.myList = <span class="hljs-keyword">this</span>.createNewGroceryList();
    callback();
  });

  <span class="hljs-keyword">this</span>.When(<span class="hljs-regexp">/^I add an item to the list$/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
    listItem = <span class="hljs-keyword">this</span>.createGroceryItem();
    <span class="hljs-keyword">this</span>.myList.add(listItem);
    callback();
  });

  <span class="hljs-keyword">this</span>.Then(<span class="hljs-regexp">/^The grocery list contains a single item$/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
    assert.equal(<span class="hljs-keyword">this</span>.myList.getAll().length, <span class="hljs-number">1</span>, <span class="hljs-string">'Grocery List should grow by one item.'</span>);
    callback();
  });

  <span class="hljs-keyword">this</span>.Then(<span class="hljs-regexp">/^I can access that item from the grocery list$/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
    assert.notEqual(<span class="hljs-keyword">this</span>.myList.getItemIndex(listItem), -<span class="hljs-number">1</span>, <span class="hljs-string">'Added item should be found at non-negative index.'</span>);
    callback();
  });

};
</code></pre><p>You will notice that in place of the <code>myList</code> variable declaration is a definition of the <strong>World</strong> context that will be the context for each <strong>Step</strong> in a <strong>Scenario</strong>. The <strong>World</strong> constructor is run at the start of each <strong>Scenario</strong>. As such, any properties have a life-cycle within the <strong>Steps</strong> of each <strong>Scenario</strong> that may be defined in this <strong>Feature</strong>. Again, this differs from the previous implementation where <code>myList</code> had a life-cycle through <em>all</em> the <strong>Steps</strong> of the module. </p>
<p><em>Note: The life of <code>this.myList</code> is realistically the same as the function local <code>myList</code> in the previous example, since it was being reassigned a new instance of <code>GroceryList</code> for each <strong>Scenario</strong>.</em></p>
<p>Additionally, you may notice that I have offloaded the creation or declaration of items to factory methods on the <strong>World</strong> - it&#39;s just a habit or best practice of mine and allows me to &quot;hide&quot; such implementation details within a single context so I can focus more closely on the assertion rules.</p>
<p>The <strong>World</strong> that is referenced in this <strong>Steps</strong> module is pulled in from the <em>/features/support</em> directory:</p>
<p><em>/features/support/world.js</em></p>
<pre><code><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> GroceryList = <span class="hljs-built_in">require</span>(process.cwd() + <span class="hljs-string">'/script/model/grocery-list'</span>);

<span class="hljs-keyword">var</span> World = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">World</span><span class="hljs-params">(callback)</span> {</span>

  <span class="hljs-keyword">this</span>.myList = <span class="hljs-literal">undefined</span>;
  <span class="hljs-keyword">this</span>.createNewGroceryList = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> GroceryList.create();
  };
  <span class="hljs-keyword">this</span>.createGroceryItem = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'apple'</span>;
  };

  callback();

};

module.exports.World = World;
</code></pre><p>This defines the <strong>World</strong> constructor on the <code>module.exports</code> and, when is invoked by <a href="https://github.com/cucumber/cucumber-js">CucumberJS</a>, is provided a <code>callback</code> delegate that you invoke when you are done &quot;prepping&quot; your <strong>World</strong> context. There are other support hooks, such as <em>BeforeEach()</em> and <em>AfterEach()</em> that are available, but I won&#39;t discuss them in this article.</p>
<p>If we were to run our tests now:</p>
<pre><code>$ node_modules<span class="hljs-subst">/</span><span class="hljs-built_in">.</span>bin/cucumber<span class="hljs-attribute">-js</span>

<span class="hljs-attribute">...</span><span class="hljs-attribute">...</span>

<span class="hljs-number">2</span> scenarios (<span class="hljs-number">2</span> passed)
<span class="hljs-number">6</span> steps (<span class="hljs-number">6</span> passed)
</code></pre><p>We arrive at the same result as before: <span style="color:green;">passing</span>.</p>
<h4 id="-gt-aside">&gt; aside</h4>
<p>This example may seem a little superfluos in its demonstration of the benefits of a <strong>World</strong> context, but - for the sake of continuity - I wanted to show how I would modify the previous example to incorporate the <strong>World</strong>. As well, we will be building off of this structure when we approach incorporating tests within a browser context.</p>
<h2 id="background">Background</h2>
<p>The <strong>Background</strong> is part of the <a href="http://docs.behat.org/guides/1.gherkin.html">Gherkin DSL</a> that allows you to provide an overarching context for all <strong>Scenarios</strong> defined in a <strong>Feature</strong>. It is defined in your feature spec and details <strong>Steps</strong> to be run prior to each <strong>Scenario</strong> defined within the same spec. <em>It should be noted that if you use the Before Hooks the <strong>Background</strong> steps are run after those hook methods.</em></p>
<p>I use <strong>Background</strong> mainly to provide an environmental context for my <strong>Feature</strong>. With the state of JavaScript today - and sometimes wearing the full-stack developer hat - it is not uncommon that I would be writing a <a href="http://nodejs.org">node</a> module for the server-side along with browser-based modules for the client-side within the same project. Additionally, with the various module libraries and build tools available from the community today, I am sometimes developing libraries that provide a module for both the browser and <a href="http://nodejs.org">node</a>! Crazy mixed up world. But I digress...</p>
<p>The point being: <strong>Background</strong> is useful, in my testing workflow, in setting up a <strong>Feature</strong> with the context of running the Tests under <a href="http://nodejs.org">node</a> or in a browser.</p>
<p>We could modify the existing <strong>Feature</strong> created in the <a href="https://custardbelly.com/blog/blog-posts/2014/01/08/bdd-in-js-cucumberjs/index.html">previous post</a> to include a <strong>Background</strong> used in defining the environment:</p>
<p><em>/features/add-item.feature</em></p>
<pre><code>Feature: Shopper can add an <span class="hljs-property">item</span> <span class="hljs-keyword">to</span> their Grocery List
  As a shopper
  I want <span class="hljs-keyword">to</span> add an <span class="hljs-property">item</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">my</span> grocery <span class="hljs-type">list</span>
  So <span class="hljs-keyword">that</span> I can remember <span class="hljs-keyword">to</span> buy <span class="hljs-keyword">that</span> <span class="hljs-property">item</span> <span class="hljs-keyword">at</span> <span class="hljs-keyword">the</span> grocery store

  Background:
    Given I have opened <span class="hljs-keyword">the</span> grocery <span class="hljs-type">list</span> <span class="hljs-type">application</span>

  Scenario: Item added <span class="hljs-keyword">to</span> grocery <span class="hljs-type">list</span>
    Given I have an empty grocery <span class="hljs-type">list</span>
    When I add an <span class="hljs-property">item</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">the</span> <span class="hljs-type">list</span>
    Then The grocery <span class="hljs-type">list</span> <span class="hljs-keyword">contains</span> a single <span class="hljs-property">item</span>

  Scenario: Item accessible <span class="hljs-keyword">from</span> grocery <span class="hljs-type">list</span>
    Given I have an empty grocery <span class="hljs-type">list</span>
    When I add an <span class="hljs-property">item</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">the</span> <span class="hljs-type">list</span>
    Then I can access <span class="hljs-keyword">that</span> <span class="hljs-property">item</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">the</span> grocery <span class="hljs-type">list</span>
</code></pre><p>I have set up my <strong>Background</strong> to explicitly state that I have opened up the application we are building. If you have been following along, we actually had never even created a main application file - we were just testing a collection model. So this brings a little more real-life context to the situation at hand; we are in the process of building an application that people will use and interact with.</p>
<p>Within the <strong>Background</strong> you can add additional steps, such as <em>And</em>, <em>But</em>, <em>When</em> and <em>Then</em>, yet I try to stick to only having a <em>Given</em> followed by one or two <em>And</em>&#39;s or <em>But</em>&#39;s.</p>
<p>If we were to run that now:</p>
<pre><code>$ node_modules/.bin/cucumber-js

U-U-

<span class="hljs-number">2</span> scenarios (<span class="hljs-number">2</span> <span class="hljs-literal">undefined</span>)
<span class="hljs-number">8</span> steps (<span class="hljs-number">2</span> <span class="hljs-literal">undefined</span>, <span class="hljs-number">6</span> skipped)

You can implement step definitions <span class="hljs-keyword">for</span> <span class="hljs-literal">undefined</span> steps <span class="hljs-keyword">with</span> these snippets:

<span class="hljs-keyword">this</span>.Given(<span class="hljs-regexp">/^I have opened the grocery list application$/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
  <span class="hljs-comment">// express the regexp above with the code you wish you had</span>
  callback.pending();
});
</code></pre><p>We&#39;d see that neither of the <em>Scenarios</em> are entered and we are alerted to an undefined step definition.</p>
<h3 id="background-step-definition">Background Step Definition</h3>
<p>I have a tendency to separate my background step definitions from my scenario step definitions - in both separate files and file naming convention. In other words, I would not add this step to the _/features/step<em>definitions/add-item.steps.js</em>. The main reason being that I reuse the same background step definitions across many features. As such, I place these steps in a separate file that is prefixed with <strong>background-</strong>:</p>
<p>_/features/step<em>definitions/background-open-application.steps.js</em></p>
<pre><code><span class="hljs-pi">'use strict'</span>;
<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>);

module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>

  <span class="hljs-keyword">this</span>.World = <span class="hljs-built_in">require</span>(process.cwd() + <span class="hljs-string">'/features/support/world'</span>).World;

  <span class="hljs-keyword">this</span>.Given(<span class="hljs-regexp">/^I have opened the grocery list application$/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
    <span class="hljs-comment">// express the regexp above with the code you wish you had</span>
    callback.pending();
  });

};
</code></pre><p>Similar to how we just modified the Add Item <strong>Feature</strong>, we are defining our world and we now have a pending <strong>Step</strong> to assert as passing. Technically I save the assertions for the <em>Then</em> <strong>Steps</strong>, but when I work with <strong>Background</strong>&#39;s I consider them pretty vital to the <strong>Scenarios</strong> environment. Therefore, most of my <strong>Background</strong>&#39;s have assertions, or in the very least, asynchronous requests which invoke the callback on completion. <em>(A better example of this will be in a following post when I address testing under a browser)</em>.</p>
<p>Let&#39;s define how we expect the application to be started in the <strong>World</strong> and what sort of validation we expect to assert that, in fact, we have opened the grocery list application so that we can edit its collection:</p>
<p>_/features/step<em>definitions/background-open-application.steps.js</em></p>
<pre><code><span class="hljs-pi">'use strict'</span>;
<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>);

module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>

  <span class="hljs-keyword">this</span>.World = <span class="hljs-built_in">require</span>(process.cwd() + <span class="hljs-string">'/features/support/world'</span>).World;

  <span class="hljs-keyword">this</span>.Given(<span class="hljs-regexp">/^I have opened the grocery list application$/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
    <span class="hljs-keyword">this</span>.groceryListApplication = <span class="hljs-keyword">this</span>.openGroceryList();
    assert(<span class="hljs-keyword">this</span>.groceryListApplication, <span class="hljs-string">'Grocery List Application is required to be open for editability.'</span>);
    callback();
  });

};
</code></pre><p>Running that will <span style="color:red;">fail</span> both or our scenarios due to exceptions on the <strong>World</strong>:</p>
<pre><code>$ node_modules/.bin/cucumber-js

F-F-

(::) failed steps (::)

TypeError: Object #&lt;World&gt; <span class="hljs-keyword">has</span> no <span class="hljs-function"><span class="hljs-keyword">method</span> '<span class="hljs-title">openGroceryList</span>'

<span class="hljs-title">Failing</span> <span class="hljs-title">scenarios</span>:</span>
/Users/toddanderson/Documents/workspace/custardbelly/cucumberjs-example/features/<span class="hljs-keyword">add</span>-item.feature:<span class="hljs-number">9</span> # Scenario: Item added <span class="hljs-keyword">to</span> grocery list
/Users/toddanderson/Documents/workspace/custardbelly/cucumberjs-example/features/<span class="hljs-keyword">add</span>-item.feature:<span class="hljs-number">14</span> # Scenario: Item accessible <span class="hljs-keyword">from</span> grocery list

<span class="hljs-number">2</span> scenarios (<span class="hljs-number">2</span> failed)
<span class="hljs-number">8</span> steps (<span class="hljs-number">2</span> failed, <span class="hljs-number">6</span> skipped)
</code></pre><p>We&#39;ll modify our <strong>World</strong> to handle such properties and perform operations with regards to how we design the act of &quot;opening&quot; a new grocery list application. </p>
<p><em>Note: As mentioned previously in this and past articles, such details are really meant for a team discussion in architecture of the application. As such, I am taking liberties here in how I would go about providing as little code as possible to make the tests pass while adhering to my current design principles.</em></p>
<p><em>/features/support/world.js</em></p>
<pre><code><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> application = <span class="hljs-built_in">require</span>(process.cwd() + <span class="hljs-string">'/script/app'</span>);
<span class="hljs-keyword">var</span> GroceryList = <span class="hljs-built_in">require</span>(process.cwd() + <span class="hljs-string">'/script/model/grocery-list'</span>);

<span class="hljs-keyword">var</span> World = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">World</span><span class="hljs-params">(callback)</span> {</span>

  <span class="hljs-keyword">this</span>.groceryListApplication = <span class="hljs-literal">undefined</span>;
  <span class="hljs-keyword">this</span>.myList = <span class="hljs-literal">undefined</span>;

  <span class="hljs-keyword">this</span>.openGroceryList = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> application.newSession();
  };
  <span class="hljs-keyword">this</span>.createNewGroceryList = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> GroceryList.create();
  };
  <span class="hljs-keyword">this</span>.createGroceryItem = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'apple'</span>;
  };

  callback();

};

module.exports.World = World;
</code></pre><p>The <strong>World</strong> has been modified with the previously expected properties from our <strong>Background</strong> step and defines the creation of a new application through the <code>newSession</code> method on the <code>application</code> module. However, that module does not exist:</p>
<pre><code><span class="hljs-variable">$ </span>node_modules/.bin/cucumber-js

<span class="hljs-class"><span class="hljs-keyword">module</span>.<span class="hljs-title">js</span>:340</span>
    throw err;
          ^
<span class="hljs-constant">Error</span><span class="hljs-symbol">:</span> <span class="hljs-constant">Cannot</span> find <span class="hljs-class"><span class="hljs-keyword">module</span> '/<span class="hljs-title">Users</span>/<span class="hljs-title">toddanderson</span>/<span class="hljs-title">Documents</span>/<span class="hljs-title">workspace</span>/<span class="hljs-title">custardbelly</span>/<span class="hljs-title">cucumberjs</span>-<span class="hljs-title">example</span>/<span class="hljs-title">script</span>/<span class="hljs-title">app</span>'</span>
</code></pre><p>Let&#39;s quickly create the main application module:</p>
<p><em>/script/app.js</em></p>
<pre><code><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> application = {
  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-comment">// stub.</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }
};

module.exports = {
  newSession: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.create(application).init();
  }
};
</code></pre><p>In this module, we have defined the factory method <code>newSession</code> which generates a new <code>application</code> instance and returns the reference from a call to <code>init()</code>.</p>
<p>If we were to run our tests again:</p>
<pre><code>$ node_modules<span class="hljs-subst">/</span><span class="hljs-built_in">.</span>bin/cucumber<span class="hljs-attribute">-js</span>

<span class="hljs-attribute">...</span><span class="hljs-attribute">...</span><span class="hljs-built_in">..</span>

<span class="hljs-number">2</span> scenarios (<span class="hljs-number">2</span> passed)
<span class="hljs-number">8</span> steps (<span class="hljs-number">8</span> passed)
</code></pre><p>We are back to <span style="color:green;">green</span>!</p>
<h3 id="take-a-breather">take a breather</h3>
<p>Alright, we just added some environment context to our tests using the <strong>Background</strong> and <em>Given</em> step(s), and are bringing more solidarity to the actual testing environment in so much as we have started to address the concept that the grocery list is to be interacted with from an application. This concept was known and assumed before, yet in our previous example, we did not address an actual <strong>User Role</strong> (<em>The Shopper</em>) in context - we simply made sure that our gorcery list collection model was able to receive and retain an item.</p>
<p>That&#39;s fine, we were getting started; we had some tasks and we are not going to throw away our work.</p>
<p>However, our previous example and step definitions should be modified to address the <strong>User</strong> interacting with the application, in so much as operations being acted upon in context to an open grocery list application.</p>
<h3 id="get-back-to-work">get back to work</h3>
<p>That last section was all very wordy. Basically the whole <code>myList</code> business that is going on the <strong>World</strong> and references in the Add Item <strong>Feature</strong> steps that we just did previously in this article, I want that to go away. I want to interact with a list instance held on the application.</p>
<h3 id="refactorying">Refactorying</h3>
<p>The first modification is in the Add Item <strong>Feature</strong> steps:</p>
<p>_/features/step<em>definitions/add-item.steps.js</em></p>
<pre><code><span class="hljs-pi">'use strict'</span>;
<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>);

module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>

  <span class="hljs-keyword">var</span> listItem;

  <span class="hljs-keyword">this</span>.World = <span class="hljs-built_in">require</span>(process.cwd() + <span class="hljs-string">'/features/support/world'</span>).World;

  <span class="hljs-keyword">this</span>.Given(<span class="hljs-regexp">/^I have an empty grocery list$/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
    <span class="hljs-keyword">this</span>.groceryListApplication.list.empty();
    callback();
  });

  <span class="hljs-keyword">this</span>.When(<span class="hljs-regexp">/^I add an item to the list$/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
    listItem = <span class="hljs-keyword">this</span>.createGroceryItem();
    <span class="hljs-keyword">this</span>.groceryListApplication.list.add(listItem);
    callback();
  });

  <span class="hljs-keyword">this</span>.Then(<span class="hljs-regexp">/^The grocery list contains a single item$/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
    assert.equal(<span class="hljs-keyword">this</span>.groceryListApplication.list.getAll().length, <span class="hljs-number">1</span>, <span class="hljs-string">'Grocery List should grow by one item.'</span>);
    callback();
  });

  <span class="hljs-keyword">this</span>.Then(<span class="hljs-regexp">/^I can access that item from the grocery list$/</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
    assert.notEqual(<span class="hljs-keyword">this</span>.groceryListApplication.list.getItemIndex(listItem), -<span class="hljs-number">1</span>, <span class="hljs-string">'Added item should be found at non-negative index.'</span>);
    callback();
  });

};
</code></pre><p>We have removed all references to the <code>myList</code> property that we added to <strong>World</strong> and replaced it with references to the <code>groceryListApplication.list</code> property.</p>
<pre><code>$ node_modules/.bin/cucumber-js

.F-.F-

(::) failed steps (::)

TypeError: Cannot call <span class="hljs-function"><span class="hljs-keyword">method</span> '<span class="hljs-title">empty</span>' <span class="hljs-title">of</span> <span class="hljs-title">undefined</span></span>
</code></pre><p>Back to <span style="color:red;">failing</span> at the first <strong>Step</strong> in each <strong>Scenario</strong>; the reason being that the application instance has no <code>list</code> property.</p>
<p><em>/script/app.js</em></p>
<pre><code><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> GroceryList = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./model/grocery-list'</span>);

<span class="hljs-keyword">var</span> application = {
  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(list)</span> {</span>
    <span class="hljs-keyword">this</span>.list = list;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }
};

module.exports = {
  newSession: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> newList = GroceryList.create();
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.create(application).init(newList);
  }
};
</code></pre><p>In modifying the <code>app</code> module, we have designed it so that when <code>newSession</code> is invoked, a new instance of <code>GroceryList</code> is passed in.</p>
<p>Run that:</p>
<pre><code>$ node_modules/.bin/cucumber-js

.F-.F-

(::) failed steps (::)

TypeError: Object #&lt;Object&gt; <span class="hljs-keyword">has</span> no <span class="hljs-function"><span class="hljs-keyword">method</span> '<span class="hljs-title">empty</span>'</span>
</code></pre><p>… and we have no <code>empty</code> method on the <code>GroceryList</code>.</p>
<p><em>/script/model/grocery-list.js</em></p>
<pre><code><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> groceryList = {
  empty: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.list.length = <span class="hljs-number">0</span>;
  },
  add: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span> {</span>
    <span class="hljs-keyword">this</span>.list.push(item);
  },
  getAll: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.list;
  },
  getItemIndex: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> {</span>
    <span class="hljs-keyword">var</span> index = <span class="hljs-keyword">this</span>.list.length;
    <span class="hljs-keyword">while</span>(--index &gt; -<span class="hljs-number">1</span>) {
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.list[index] === value) {
        <span class="hljs-keyword">return</span> index;
      }
    }
    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
  }
};

module.exports = {
  create: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.create(groceryList, {
      <span class="hljs-string">'list'</span>: {
        value: [],
        writable: <span class="hljs-literal">false</span>,
        enumerable: <span class="hljs-literal">true</span>  
      }
    });
  }
};
</code></pre><p>We added the <code>empty</code> method to the <code>groceryList</code> object which essentially just clears the underlying <code>Array</code> instance.</p>
<p>Run the tests again:</p>
<pre><code>$ node_modules<span class="hljs-subst">/</span><span class="hljs-built_in">.</span>bin/cucumber<span class="hljs-attribute">-js</span>

<span class="hljs-attribute">...</span><span class="hljs-attribute">...</span><span class="hljs-built_in">..</span>

<span class="hljs-number">2</span> scenarios (<span class="hljs-number">2</span> passed)
<span class="hljs-number">8</span> steps (<span class="hljs-number">8</span> passed)
</code></pre><p>And we are back to <span style="color:green;">green</span>! Successful reactor… so far :)</p>
<p>We have carefully moved our collection model that is under test to the application, but we have some lingering and unneccessary code in our <strong>World</strong>. <em>I love removing code.</em></p>
<p>Here is our now cleaned up <strong>World</strong>:</p>
<p><em>/features/support/world.js</em></p>
<pre><code><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> application = <span class="hljs-built_in">require</span>(process.cwd() + <span class="hljs-string">'/script/app'</span>);

<span class="hljs-keyword">var</span> World = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">World</span><span class="hljs-params">(callback)</span> {</span>

  <span class="hljs-keyword">this</span>.groceryListApplication = <span class="hljs-literal">undefined</span>;

  <span class="hljs-keyword">this</span>.openGroceryList = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> application.newSession();
  };
  <span class="hljs-keyword">this</span>.createGroceryItem = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'apple'</span>;
  };

  callback();

};

module.exports.World = World;
</code></pre><p>Woohoo!</p>
<h2 id="conclusion">Conclusion</h2>
<p>I set out to address a few concepts associated with CucumberJS that I use regurlarly, but in doing so, I ended up modifying and refactoring the current example :) That wasn&#39;t the original intent when I started this post, but I was having fun.</p>
<ul>
<li>The <strong>World</strong> is useful in defining context for each <strong>Scenario</strong>. I often use it to also hold factory and general operation methods that may be called across many different <strong>Scenarios</strong></li>
<li><strong>Background</strong> is useful in defining environment context across <strong>Scenarios</strong> in separate <strong>Features</strong>. I often use it to assert that the proper environment is available before stepping into the <strong>Scenarios</strong>.</li>
</ul>
<p>I think the work we went through in this post will be very beneficial when I introduce running tests under a browser. Stay tuned…</p>
<p>Source for examples related to this post can be found in the <a href="https://github.com/bustardcelly/cucumberjs-examples/tree/0.2.0post">0.2.0.post tag on my Github account</a>.</p>
]]></description><link>https://www.custardbelly.com/blog/blog-posts/2014/01/22/cucumberjs-world/index.html</link><guid isPermaLink="true">https://www.custardbelly.com/blog/blog-posts/2014/01/22/cucumberjs-world/index.html</guid><dc:creator><![CDATA[Todd Anderson]]></dc:creator><pubDate>Invalid Date</pubDate></item></channel></rss>