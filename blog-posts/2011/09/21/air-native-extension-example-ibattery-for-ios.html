
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2011/09/21/air-native-extension-example-ibattery-for-ios/" title="Permanent link to AIR Native Extension Example: iBattery for iOS" rel="bookmark" rev="post-474">AIR Native Extension Example: iBattery for iOS</a></h1>
	
	<div class="entry-content full-content">
		<h2>Introduction</h2>
<p>The most exciting new feature <a href="http://blogs.adobe.com/flashplatform/2011/09/announcing-flash-player-11-and-air-3.html" target="_blank">coming to Adobe AIR</a> to me is the ability to compile against a library that can communicate with a device natively. Though some of the Stage* API opens a whole new world of rendering improvements, the inclusion of <a href="http://www.adobe.com/devnet/air/articles/extending-air.html" target="_blank">Native extensions for Adobe AIR</a> (NE) relieves the wishing and waiting of what will be exposed at the device level in future <strong>AIR SDK</strong> releases; we can now extend the <strong>Runtime</strong> ourselves. With the arrival of <strong>Native extensions</strong>, the possibilities of what can be achieved with a mobile <strong>AIR</strong> application grow larger; and certainly with that, so does complexity in design and the requirement to develop with mobile performance in mind. </p>
<p>Keeping the complexities and performance in check (and to calm myself down from excitement of the endless possibilities) I decided to give it a quick test-run by creating a <strong>Native Extension</strong> that I thought was sorely missing from the <strong>Adobe AIR SDK</strong> – battery information on iOS. In all seriousness, getting up and running and accessing the battery information of my iPhone from an application <strong>AIR</strong> application was rather painless and – dare i say it – easier than i expected. I intend to give a quick walk through of how I went about creating the <strong>iBattery Native Extension</strong> and how to use it in an AIR application.</p>
<h3>Disclaimer</h3>
<p>I am going to assume you are familiar with setting up an <strong>Apple Developer</strong> account and downloading the SDK and won’t even go into the headache of provisioning profiles and the deployment process for an <strong>iOS</strong> application. I am also going to assume that you are familiar with using the recent <strong>Flex 4.5 SDK</strong> to create mobile Flex applications. The application in this example is in no way complex, but I am not going to cover how the pieces of the application work – only how you can compile against and include an <strong>Native extension for Adobe AIR</strong>.</p>
<h3>Source</h3>
<p>If you are curious or just want to jump to code, I created a <a href="https://github.com/bustardcelly/iBattery" target="_blank">github repo</a> with all the source as well as deployment builds or if you just came here for the <strong>Native Extension</strong> and know your way around you can download <a href="http://www.custardbelly.com/downloads/air/ane/ibatteryextension.ane.zip">ibatteryextension.ane</a> directly.</p>
<h2>Requirements</h2>
<ul>
<li><a href="http://opensource.adobe.com/wiki/display/flexsdk/Download+Flex+4.5" target="_blank">Flex 4.5.1 SDK</a></li>
<li><a href="http://labs.adobe.com/technologies/flashplatformruntimes/air3/" target="_blank">AIR 3 Runtime and SDK (Release Candidate)</a></li>
<li><a href="http://developer.apple.com/devcenter/ios/index.action" target="_blank">iOS SDK</a></li>
</ul>
<p>Also, take a look at these excellent articles:</p>
<ul>
<li><a href="http://www.adobe.com/devnet/air/articles/extending-air.html" target="_blank">Extending Adobe AIR by Oliver Goldman</a></li>
<li><a href="http://renaun.com/blog/2011/09/why-native-extensions-for-air/" target="_blank">Why Native Extensions for AIR</a></li>
<li><a href="http://www.adobe.com/content/dam/Adobe/en/devnet/devices/pdfs/DevelopingActionScriptExtensionsForAdobeAIR.pdf" target="_blank">Developing ActionScript Extensions for Adobe AIR</a></li>
<li><a href="http://www.adobe.com/devnet/air/native-extensions-for-air.html" target="_blank">Native Extensions for Adobe AIR</a> in the AIR Developer Center</li>
</ul>
<p><em>I am not going to cover how to get this going with any IDEs (eg. <strong>Flash Builder 4.5</strong>). I will show you how to do all this from the command line. There are some niceties with IDEs that will separate you from invoking the command line tools of the <strong>SDK</strong> directly, but sometimes it is nice to see what is going on behind the scenes.</em></p>
<p>I went about downloading the <strong>Flex 4.5 SDK</strong> and unzipping it somewhere on my local disk, then downloaded the <strong>Adobe AIR SDK</strong> and overlaid it on the <strong>Flex SDK</strong> using the instructions here: <a href="http://kb2.adobe.com/cps/495/cpsid_49532.html" target="_blank">How To Overlay the AIR SDK</a>. For the purposes of the examples in this article let’s just say that <strong>SDK</strong> is located on my machine at: <strong>/Users/todd/SDKs/flex_4.5_air_3rc1</strong>.</p>
<p>The whole iOS &amp; Xcode set up, you are on your own. Sorry, not to be mean. There is some great information already out there and i want to keep this article more focused on <strong>Native Extensions for Adobe AIR</strong> and not to prevent hair-loss developing for iOS.</p>
<h2>Moving Pieces</h2>
<p>There are three major portions to create an AIR application utilizing the <strong>Native Extension for Adobe AIR</strong>:</p>
<ol>
<li>Native code compiled for target platform.</li>
<li>Flex library project to deploy the Native Extension for Adobe AIR.</li>
<li>Mobile AIR application.</li>
</ol>
<p>Depending on your target device/platform, the language and generated library on the native-side can vary and really is covered well in <a href="http://www.adobe.com/devnet/air/articles/extending-air.html#articlecontentAdobe_numberedheader_4" target="_blank">Oliver Goldman’s article</a>. For the purposes of this example, the native part involved me writing some C/Obj-C and creating a static library (.a file). The Flex library project is actually two-fold; I created a library that interfaced with the <a href="http://help.adobe.com/en_US/FlashPlatform/beta/reference/actionscript/3/flash/external/ExtensionContext.html " target="_blank">flash.external.ExtensionContext</a>, then generated an <strong>.ane</strong> file from the <strong>SWC</strong> and static library. The <strong>Mobile AIR</strong> application is then compiled against this <strong>Native Extension</strong> and the <strong>.ane</strong> library file is included in the generated <strong>.ipa</strong> file.</p>
<h2>Native</h2>
<p>I am not that much of an C/Objective-C developer. I have developed and deployed a handful of iOS applications in the past (some reaching the <strong>AppStore</strong>), but honestly have not touched it in quite some time. So I have some history, but cannot speak at length on how things work and why. Let’s just say, for the example in this article, that I knew enough to get in and get out and carry on on the <strong>ActionScript</strong> side of things.</p>
<p>When creating a native extension targeting the iOS platform, you’ll write some C code (which can call Obj-C) and deploy a static library with a <strong>.a</strong> extension. What i did was create a new Library project in Xcode, imported the header file included with the <strong>AIR SDK</strong> (found at <strong>/include/FlashRuntimeExtensions.h</strong>) and added a <strong>.m</strong> (Obj-C implementation) file to the project that will serve as the implementation of the native context and expose the API for accessing the battery life and information of the iOS device:</p>
<div><pre><div class="line number1 index0 alt2"><code class="cpp comments">// Access battery life.</code></div><div class="line number2 index1 alt1"><code class="cpp plain">FREObject GetBatteryLife(FREContext ctx, </code><code class="cpp keyword bold">void</code><code class="cpp plain">* funcData, uint32_t argc, FREObject argv[]) {</code></div><div class="line number3 index2 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">UIDevice *device = [UIDevice currentDevice];</code></div><div class="line number4 index3 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">[device setBatteryMonitoringEnabled:YES];</code></div><div class="line number5 index4 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">float</code> <code class="cpp plain">life = [device batteryLevel];</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">FREObject retVal;</code></div><div class="line number8 index7 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">FRENewObjectFromDouble( life, &amp;retVal );</code></div><div class="line number9 index8 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">retVal;</code></div><div class="line number10 index9 alt1"><code class="cpp plain">}</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="cpp comments">// Access info about battery</code></div><div class="line number13 index12 alt2"><code class="cpp plain">FREObject GetBatteryInfo(FREContext ctx, </code><code class="cpp keyword bold">void</code><code class="cpp plain">* funcData, uint32_t argc, FREObject argv[]) {</code></div><div class="line number14 index13 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">UIDevice *device = [UIDevice currentDevice];</code></div><div class="line number15 index14 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">[device setBatteryMonitoringEnabled:YES];</code></div><div class="line number16 index15 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp color1 bold">int</code> <code class="cpp plain">info = [device batteryState];</code></div><div class="line number17 index16 alt2">&nbsp;</div><div class="line number18 index17 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">FREObject retVal;</code></div><div class="line number19 index18 alt2"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp plain">FRENewObjectFromInt32( info, &amp;retVal );</code></div><div class="line number20 index19 alt1"><code class="cpp spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="cpp keyword bold">return</code> <code class="cpp plain">retVal;</code></div><div class="line number21 index20 alt2"><code class="cpp plain">}</code></div></pre></div>
<p>Boiled down and abstracted in thinking on the <strong>ActionScript</strong> side of things, the API of this native library exposes two methods: <em>GetBatteryLife</em> and <em>GetBatteryInfo</em>. Each return a numerical value related to their context: a Number representing the percent of battery life left on the device and an Integer representing battery state, respectively. The relation of the Number value to percent is fairly straight-forward. The Integer returned from <em>[[UIDevice currentDevice] batteryState]</em> relates to the various “states” that the battery can be in, and they are:</p>
<ul>
<li>0 : Unknown</li>
<li>1 : Unplugged</li>
<li>2 : Charging</li>
<li>3 : Full</li>
</ul>
<p>The <strong>FREObject</strong> is covered more properly by <a href="http://www.adobe.com/devnet/air/articles/extending-air.html#articlecontentAdobe_numberedheader_4" target="_blank">Oliver Goldman in his article</a>, and I just blindly assume that the <a href="http://help.adobe.com/en_US/FlashPlatform/beta/reference/actionscript/3/flash/external/ExtensionContext.html ">ExtensionContext</a> of the <strong>AIR SDK</strong> knows how to interpret this value for me so I can cast as an <strong>ActionScript</strong> type and move on. We’ll see how that happens in the next section.</p>
<h2>The Native Extension</h2>
<p>The previous section lightly covered the native side of things and generated a static library file that will be used to compile an <strong>Native Extension</strong> (NE) library that will be used by an AIR application to access battery information of an iOS device it is deployed to. Creating the <strong>Native Extension</strong> file (.ane) is actually a two step process:</p>
<ol>
<li>Create a Flash library project compiled against AIR libraries and expose an API that interfaces with the native library through <a href="http://help.adobe.com/en_US/FlashPlatform/beta/reference/actionscript/3/flash/external/ExtensionContext.html " target="_blank">ExtensionContext</a>.</li>
<li>Use the ADT command line tool with to generate an .ane file compiled against the library SWC and the native library.</li>
</ol>
<p>The <a href="http://help.adobe.com/en_US/FlashPlatform/beta/reference/actionscript/3/flash/external/ExtensionContext.html " target="_blank">flash.external.ExtensionContext</a> from the <strong>AIR SDK</strong> is your main access point to the native library. Essentially, you create a new instance of an <strong>ExtensionContext</strong> using an ID defined in an extension descriptor file compiled into the <strong>Native Extension</strong>. For the <strong>iBattery Native Extension</strong>, this is what my extension descriptor file looks like:</p>
<div><pre><div class="line number1 index0 alt2"><code class="xml plain">&lt;</code><code class="xml keyword">extension</code> <code class="xml color1">xmlns</code><code class="xml plain">=</code><code class="xml string">"<a href="http://ns.adobe.com/air/extension/2.5">http://ns.adobe.com/air/extension/2.5</a>"</code><code class="xml plain">&gt;</code></div><div class="line number2 index1 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">id</code><code class="xml plain">&gt;com.custardbelly.ibattery&lt;/</code><code class="xml keyword">id</code><code class="xml plain">&gt;</code></div><div class="line number3 index2 alt2"><code class="xml spaces">&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">versionNumber</code><code class="xml plain">&gt;1&lt;/</code><code class="xml keyword">versionNumber</code><code class="xml plain">&gt;</code></div><div class="line number4 index3 alt1"><code class="xml spaces">&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">platforms</code><code class="xml plain">&gt;</code></div><div class="line number5 index4 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">platform</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">"iPhone-ARM"</code><code class="xml plain">&gt;</code></div><div class="line number6 index5 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">applicationDeployment</code><code class="xml plain">&gt;</code></div><div class="line number7 index6 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">nativeLibrary</code><code class="xml plain">&gt;libAIRExtensionC.a&lt;/</code><code class="xml keyword">nativeLibrary</code><code class="xml plain">&gt;</code></div><div class="line number8 index7 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">initializer</code><code class="xml plain">&gt;ExtInitializer&lt;/</code><code class="xml keyword">initializer</code><code class="xml plain">&gt;</code></div><div class="line number9 index8 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">finalizer</code><code class="xml plain">&gt;ExtFinalizer&lt;/</code><code class="xml keyword">finalizer</code><code class="xml plain">&gt;</code></div><div class="line number10 index9 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">applicationDeployment</code><code class="xml plain">&gt;</code></div><div class="line number11 index10 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">platform</code><code class="xml plain">&gt;</code></div><div class="line number12 index11 alt1"><code class="xml spaces">&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">platforms</code><code class="xml plain">&gt;</code></div><div class="line number13 index12 alt2"><code class="xml plain">&lt;/</code><code class="xml keyword">extension</code><code class="xml plain">&gt;</code></div></pre></div>
<p>Highlighted in that snippet are some important bits. The <strong>id</strong> node value will be used to create a new <strong>ExtensionContext</strong> instance. The <strong>nativeLibrary</strong> node value is the native library created in the previous section. For this example, it is also of note that we have defined the <em>iPhone-ARM</em> platform as a target, as well. This extension descriptor file describes the association of id to native library that the <strong>ExtensionContext</strong> will look up upon instantiation. To create an <strong>ExtensionContext</strong>:</p>
<p><em>com.cusardbelly.air.extensions.battery.ios.Battery</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">_extensionContext = ExtensionContext.createExtensionContext( </code><code class="jscript string">"com.custardbelly.ibattery"</code><code class="jscript plain">, </code><code class="jscript string">"main"</code> <code class="jscript plain">);</code></div></pre></div>
<p>… and then use the <strong>call</strong>() method to invoke the corresponding method exposed in the native library. For the purposes of the example in this article, and for the <strong>iBattery Native Extension</strong>, I basically exposed the same API that was on the native side:</p>
<p><em>com.cusardbelly.air.extensions.battery.ios.Battery</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript plain">public </code><code class="jscript keyword">function</code> <code class="jscript plain">getBatteryLife():Number</code></div><div class="line number2 index1 alt1"><code class="jscript plain">{</code></div><div class="line number3 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">_extensionContext.call( </code><code class="jscript string">'GetBatteryLife'</code> <code class="jscript plain">) as Number;</code></div><div class="line number4 index3 alt1"><code class="jscript plain">}</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="jscript plain">public </code><code class="jscript keyword">function</code> <code class="jscript plain">getBatteryState():int</code></div><div class="line number7 index6 alt2"><code class="jscript plain">{</code></div><div class="line number8 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript plain">_extensionContext.call( </code><code class="jscript string">'GetBatteryInfo'</code> <code class="jscript plain">) as int;</code></div><div class="line number9 index8 alt2"><code class="jscript plain">}</code></div></pre></div>
<p>With my API done, I compiled the library into a SWC:</p>
<div><pre><div class="line number1 index0 alt2"><code class="bash plain">&gt; </code><code class="bash plain">/Users/todd/SDKs/flex_4</code><code class="bash plain">.5_air_3rc1</code><code class="bash plain">/bin/compc</code> <code class="bash plain">-output build</code><code class="bash plain">/iBattery</code><code class="bash plain">.swc -load-config+=ibattery_lib.config +configname=airmobile</code></div></pre></div>
<p>If you are unfamiliar with using the command line tools of the SDK, I used the compc tool which is used to generate SWC files. The <strong>iBattery.swc</strong> file is generated and placed in a build directory and is compiled against an additional custom config (which just defines source location) and the <strong>+configname=airmobile</strong> directive. That’s actually a little fun tidbit. If you want to generate a SWC or SWF that uses the AIR mobile libraries, just add <strong>+configname=airmobile</strong> and they’ll be compiled against for you without defining them in an additional config file.</p>
<p>I then took the iBattery.swc and unzipped it to get the <strong>library.swf</strong> file. This is necessary for generating a <strong>Native Extension</strong> file (.ane) using the <strong>ADT</strong> command line tool:</p>
<div><pre><div class="line number1 index0 alt2"><code class="bash plain">&gt; </code><code class="bash plain">/Users/todd/SDKs/flex_4</code><code class="bash plain">.5_air_3rc1</code><code class="bash plain">/bin/adt</code> <code class="bash plain">-package -target ane ..</code><code class="bash plain">/release/ibatteryextension</code><code class="bash plain">.ane extension.xml -swc iBattery.swc -platform iPhone-ARM library.swf libAIRExtensionC.a</code></div></pre></div>
<p>That generates an <strong>ibatteryextension.ane</strong> in a release directory and defines the target SWC library and platform as well as compiling in the descriptor, SWF library and native library.</p>
<p>That <strong>Native extension</strong> is then used as one would as SWC library in an AIR Mobile application to interface with the native library. You need to compile against the .ane and include it in an extension directory within the AIR application.</p>
<h2>The AIR Mobile Application</h2>
<p>The application I created to showcase the <strong>iBattery Native Extension</strong> is pretty dead simple. Again, I am assuming you have some knowledge of a mobile AIR application and its pieces. There are a ton of great articles out there that can help in developing an AIR application targeting mobile, so I won’t  provide any more explanations in this article, I just wanted to show you quickly how the communication works and the requirements for compilation of the application.</p>
<p>To being I just have a main <em>ViewNavigatorApplication</em> that defines a single view:</p>
<p><em>iBatteryExample.mxml</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="xml plain">&lt;?</code><code class="xml keyword">xml</code> <code class="xml color1">version</code><code class="xml plain">=</code><code class="xml string">"1.0"</code> <code class="xml color1">encoding</code><code class="xml plain">=</code><code class="xml string">"utf-8"</code><code class="xml plain">?&gt;</code></div><div class="line number2 index1 alt1"><code class="xml plain">&lt;</code><code class="xml keyword">s:ViewNavigatorApplication</code> <code class="xml color1">xmlns:fx</code><code class="xml plain">=</code><code class="xml string">"<a href="http://ns.adobe.com/mxml/2009">http://ns.adobe.com/mxml/2009</a>"</code></div><div class="line number3 index2 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color1">xmlns:s</code><code class="xml plain">=</code><code class="xml string">"<a href="library://ns.adobe.com/flex/spark">library://ns.adobe.com/flex/spark</a>"</code></div><div class="line number4 index3 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color1">firstView</code><code class="xml plain">=</code><code class="xml string">"BatteryTestView"</code><code class="xml plain">&gt;</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="xml plain">&lt;/</code><code class="xml keyword">s:ViewNavigatorApplication</code><code class="xml plain">&gt;</code></div></pre></div>
<p>… and the <em>BatteryTestView</em> provides a UI to request the battery information on the device and does all the communication through the <strong>ActionScript</strong> side of the <strong>Native Extension</strong> library generated previously:</p>
<p><em>BatteryTestView.mxml</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="xml plain">&lt;?</code><code class="xml keyword">xml</code> <code class="xml color1">version</code><code class="xml plain">=</code><code class="xml string">"1.0"</code> <code class="xml color1">encoding</code><code class="xml plain">=</code><code class="xml string">"utf-8"</code><code class="xml plain">?&gt;</code></div><div class="line number2 index1 alt1"><code class="xml plain">&lt;</code><code class="xml keyword">s:View</code> <code class="xml color1">xmlns:fx</code><code class="xml plain">=</code><code class="xml string">"<a href="http://ns.adobe.com/mxml/2009">http://ns.adobe.com/mxml/2009</a>"</code></div><div class="line number3 index2 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color1">xmlns:s</code><code class="xml plain">=</code><code class="xml string">"<a href="library://ns.adobe.com/flex/spark">library://ns.adobe.com/flex/spark</a>"</code></div><div class="line number4 index3 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color1">title</code><code class="xml plain">=</code><code class="xml string">"BatteryTestView"</code> <code class="xml color1">creationComplete</code><code class="xml plain">=</code><code class="xml string">"handleCreationComplete();"</code><code class="xml plain">&gt;</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">fx:Script</code><code class="xml plain">&gt;</code></div><div class="line number7 index6 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">&lt;![CDATA[</code></div><div class="line number8 index7 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">import com.custardbelly.air.extensions.battery.ios.Battery;</code></div><div class="line number9 index8 alt2">&nbsp;</div><div class="line number10 index9 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">protected var _batteryExtension:Battery;</code></div><div class="line number11 index10 alt2">&nbsp;</div><div class="line number12 index11 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">protected function handleCreationComplete():void</code></div><div class="line number13 index12 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">{</code></div><div class="line number14 index13 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">_batteryExtension = new Battery();</code></div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">lifeButton.addEventListener( MouseEvent.CLICK, handleLifeRequest, false, 0, true );</code></div><div class="line number17 index16 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">infoButton.addEventListener( MouseEvent.CLICK, handleInfoRequest, false, 0, true );</code></div><div class="line number18 index17 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">}</code></div><div class="line number19 index18 alt2">&nbsp;</div><div class="line number20 index19 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">protected function handleLifeRequest( evt:Event ):void</code></div><div class="line number21 index20 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">{</code></div><div class="line number22 index21 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">try {</code></div><div class="line number23 index22 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">console.appendText( "Battery Life Percentage: " );</code></div><div class="line number24 index23 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">console.appendText( ( _batteryExtension.getBatteryLife() * 100 ).toString() + "%\n" );</code></div><div class="line number25 index24 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">}</code></div><div class="line number26 index25 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">catch( e:Error )</code></div><div class="line number27 index26 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">{</code></div><div class="line number28 index27 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">console.appendText( "Error: " + e.message );</code></div><div class="line number29 index28 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">}</code></div><div class="line number30 index29 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">}</code></div><div class="line number31 index30 alt2">&nbsp;</div><div class="line number32 index31 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">protected function handleInfoRequest( evt:Event ):void</code></div><div class="line number33 index32 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">{</code></div><div class="line number34 index33 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">console.appendText( "Battery State: " + ( _batteryExtension.getBatteryState() ).toString() + "\n" );</code></div><div class="line number35 index34 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">}</code></div><div class="line number36 index35 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml color2">]]&gt;</code></div><div class="line number37 index36 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">fx:Script</code><code class="xml plain">&gt;</code></div><div class="line number38 index37 alt1">&nbsp;</div><div class="line number39 index38 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">s:layout</code><code class="xml plain">&gt;</code></div><div class="line number40 index39 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">s:VerticalLayout</code> <code class="xml color1">paddingLeft</code><code class="xml plain">=</code><code class="xml string">"10"</code> <code class="xml color1">paddingRight</code><code class="xml plain">=</code><code class="xml string">"10"</code> <code class="xml color1">paddingTop</code><code class="xml plain">=</code><code class="xml string">"10"</code> <code class="xml color1">paddingBottom</code><code class="xml plain">=</code><code class="xml string">"10"</code> <code class="xml plain">/&gt;</code></div><div class="line number41 index40 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">s:layout</code><code class="xml plain">&gt;</code></div><div class="line number42 index41 alt1">&nbsp;</div><div class="line number43 index42 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">s:TextArea</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"console"</code> <code class="xml color1">width</code><code class="xml plain">=</code><code class="xml string">"100%"</code> <code class="xml color1">height</code><code class="xml plain">=</code><code class="xml string">"100%"</code> <code class="xml color1">editable</code><code class="xml plain">=</code><code class="xml string">"false"</code> <code class="xml color1">text</code><code class="xml plain">=</code><code class="xml string">"Hello World!"</code> <code class="xml plain">/&gt;</code></div><div class="line number44 index43 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">s:HGroup</code> <code class="xml color1">width</code><code class="xml plain">=</code><code class="xml string">"100%"</code> <code class="xml color1">height</code><code class="xml plain">=</code><code class="xml string">"24"</code> <code class="xml color1">verticalAlign</code><code class="xml plain">=</code><code class="xml string">"middle"</code><code class="xml plain">&gt;</code></div><div class="line number45 index44 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">s:Button</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"lifeButton"</code> <code class="xml color1">label</code><code class="xml plain">=</code><code class="xml string">"get life"</code> <code class="xml plain">/&gt;</code></div><div class="line number46 index45 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">s:Button</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"infoButton"</code> <code class="xml color1">label</code><code class="xml plain">=</code><code class="xml string">"get info"</code> <code class="xml plain">/&gt;</code></div><div class="line number47 index46 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">s:HGroup</code><code class="xml plain">&gt;</code></div><div class="line number48 index47 alt1">&nbsp;</div><div class="line number49 index48 alt2"><code class="xml plain">&lt;/</code><code class="xml keyword">s:View</code><code class="xml plain">&gt;</code></div></pre></div>
<p>Access to the <strong>ActionScript</strong> API from the <strong>Native Extension</strong> is available just as if you were developing against an external SWC library, and I created a new instance of a <em>Battery</em> to request life and information of the device which is then just printed out in a text area:</p>
<p><em>BatteryTestView.mxml</em></p>
<div><pre><div class="line number14 index0 alt1"><code class="jscript plain">_batteryExtension = </code><code class="jscript keyword">new</code> <code class="jscript plain">Battery();</code></div></pre></div>
<div><pre><div class="line number34 index0 alt1"><code class="jscript plain">console.appendText( </code><code class="jscript string">"Battery State: "</code> <code class="jscript plain">+ ( _batteryExtension.getBatteryState() ).toString() + </code><code class="jscript string">"\n"</code> <code class="jscript plain">);</code></div></pre></div>
<p>To generate my AIR application for iOS, was a two step process. First, I generated the application SWF targeting AIR mobile:</p>
<div><pre><div class="line number1 index0 alt2"><code class="bash plain">&gt; </code><code class="bash plain">/Users/todd/SDKs/flex_4</code><code class="bash plain">.5_air_3rc1</code><code class="bash plain">/bin/mxmlc</code> <code class="bash plain">+configname=airmobile -output build</code><code class="bash plain">/iBatteryExample</code><code class="bash plain">.swf src</code><code class="bash plain">/iBatteryExample</code><code class="bash plain">.mxml -load-config+=battery_app.config</code></div></pre></div>
<p>Again i used the <strong>+configname=airmobile</strong> directive to include the mobile SWC from the Adobe AIR SDK without defining the dependencies in an additional config file. I did, however, have an additional config file that defined the <strong>Native Extension</strong> (.ane file) to compile against as an external library:</p>
<p><em>battery_app.config</em></p>
<div><pre><div class="line number1 index0 alt2"><code class="xml plain">&lt;?</code><code class="xml keyword">xml</code> <code class="xml color1">version</code><code class="xml plain">=</code><code class="xml string">"1.0"</code><code class="xml plain">?&gt;</code></div><div class="line number2 index1 alt1"><code class="xml plain">&lt;</code><code class="xml keyword">flex-config</code> <code class="xml color1">xmlns</code><code class="xml plain">=</code><code class="xml string">"<a href="http://www.adobe.com/2006/flex-config">http://www.adobe.com/2006/flex-config</a>"</code><code class="xml plain">&gt;</code></div><div class="line number3 index2 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">compiler</code><code class="xml plain">&gt;</code></div><div class="line number4 index3 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">external-library-path</code> <code class="xml color1">append</code><code class="xml plain">=</code><code class="xml string">"true"</code><code class="xml plain">&gt;</code></div><div class="line number5 index4 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">path-element</code><code class="xml plain">&gt;ext/ibatteryextension.ane&lt;/</code><code class="xml keyword">path-element</code><code class="xml plain">&gt;</code></div><div class="line number6 index5 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">external-library-path</code><code class="xml plain">&gt;</code></div><div class="line number7 index6 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">compiler</code><code class="xml plain">&gt;</code></div><div class="line number8 index7 alt1"><code class="xml plain">&lt;/</code><code class="xml keyword">flex-config</code><code class="xml plain">&gt;</code></div></pre></div>
<p>That generated an <em>iBatteryExample.swf</em> which was then used alongside an application descriptor file to compile and generate the <strong>.ipa</strong> file (application installer file for iOS). We can create that using the <strong>ADT</strong> command line tool:</p>
<div><pre><div class="line number1 index0 alt2"><code class="bash plain">&gt; </code><code class="bash plain">/Users/todd/SDKs/flex_4</code><code class="bash plain">.5_air_3rc1</code><code class="bash plain">/bin/adt</code> <code class="bash plain">-package -target ipa-</code><code class="bash functions">test</code><code class="bash plain">-interpreter -provisioning-profile {path.to}.mobileprovision -storetype pkcs12 -keystore {path.to}.developer_identity.p12 -storepass {pass} ..</code><code class="bash plain">/release/iBatteryExample</code><code class="bash plain">.ipa iBatteryExample-app.xml iBatteryExample.swf -extdir ..</code><code class="bash plain">/ext/</code></div></pre></div>
<p>There are two things in this command that you should note. First off, you will need to replace the <em>{path.to}</em> and <em>{pass}</em> tokens to point to your iOS developer files and password, respectively. Second is the <em>-extdir</em> option. This defines where the application can locate the <strong>Native Extension</strong> (.ane file).</p>
<p>And that was pretty much it for the application. Pretty basic, but a rather quick way to get up and running to allow someone to find information about their battery on an iOS device.</p>
<h2>Conclusion</h2>
<p>The addition of <strong>Native Extensions for Adobe AIR</strong> to the AIR SDK opens a lot of doors not only for native device integration but also to the experience you can provide in a mobile AIR application – with the biggest takeaway (as a developer) being that we no longer have to wait and see what gets exposed to us at the device-level in future <strong>AIR SDK</strong> releases. We can just write our own native extension now.</p>
<p>Hopefully this article provided some insight on how to quickly get up and running in creating your own Native Extensions and how to incorporate them into your mobile AIR application. And it should be noted that though this example was iOS specific, the native library for an <strong>Native Extension for Adobe AIR</strong> is in no way restricted to that platform and you should really check out <a href="http://www.adobe.com/devnet/air/articles/extending-air.html#articlecontentAdobe_numberedheader_4" target="_blank">Oliver Goldman’s excellent article, Extending Adobe AIR on the Adobe DevNet</a>.</p>
<p>The source discussed in this article can be found on <strong>github</strong> at <a href="https://github.com/bustardcelly/iBattery">http://github.com/bustardcelly/iBattery</a> and the <a href="http://www.custardbelly.com/downloads/air/ane/ibatteryextension.ane.zip" target="_blank">ibatteryextension.ane</a> itself (if you’d like to use it in your application) can be downloaded from this link.</p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/air/" title="View all posts in AIR" rel="category tag">AIR</a>,  <a href="http://custardbelly.com/blog/category/as3/" title="View all posts in AS3" rel="category tag">AS3</a>,  <a href="http://custardbelly.com/blog/category/flex/" title="View all posts in Flex" rel="category tag">Flex</a>,  <a href="http://custardbelly.com/blog/category/flex-4-5/" title="View all posts in Flex 4.5" rel="category tag">Flex 4.5</a>,  <a href="http://custardbelly.com/blog/category/native-extension-for-adobe-air/" title="View all posts in Native Extension for Adobe AIR" rel="category tag">Native Extension for Adobe AIR</a>.</p>
	
	

	<!--/by-line-->

	<div id="post-comments-474-target"></div>
	<div class="clear"></div>
	
	