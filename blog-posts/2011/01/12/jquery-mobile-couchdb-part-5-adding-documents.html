
	
	<h1 class="entry-title full-title"><a href="http://custardbelly.com/blog/2011/01/12/jquery-mobile-couchdb-part-5-adding-documents/" title="Permanent link to jQuery Mobile + CouchDB: Part 5 – Adding Documents" rel="bookmark" rev="post-332">jQuery Mobile + CouchDB: Part 5 – Adding Documents</a></h1>
	
	<div class="entry-content full-content">
		<p>In my <a href="http://custardbelly.com/blog/?p=318" target="_blank">previous post</a>, I addressed editing documents using a form in <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> and updating the document in the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database using the <em>jquery.couch</em> plugin. So far, if you have been following along, the posts have only addressed the <em>RU</em> of <strong>CRUD</strong> (<strong>C</strong>reate <strong>R</strong>ead <strong>U</strong>pdate <strong>D</strong>elete) from the client application aspect. The list of albums are read upon launch, with a single album read on detail, and last post addressed updating a target document. Its high-time we start throwing <strong>C</strong> &amp; <strong>D</strong> into that mix… but hold on. One at a time. First one will be fun. The second one will make you cry. That’s not true.</p>
<p>In this article I am going to address the ability to create a new album document, which in and of itself is not entirely different from editing. While doing so, I will address adding a button bar as a <strong>footer</strong> using <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> grid layout and a few tidbits here and there to get things to work, as well as continue to gush over the beauty of using a document-oriented database system… because there’s changes ahead!</p>
<p><strong>In the following examples, I will assume that you have been following along from previous posts and present updates to existing code</strong>.</p>
<h2>Adding Documents</h2>
<p>In the previous posts, I discussed the difference between <strong>internal</strong> and <strong>external</strong> pages in <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> and made a fair assessment (i hope) to create the pages of our client application as externally-loaded into the <strong>DOM</strong>. This allows us to see the beauty of <strong>templates</strong> and <strong>show functions</strong> and peek a little into how a <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance, which is an <strong>HTTP</strong> server itself, can be used to serve up a client the communicates with a target <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database.</p>
<p>Well, we are not going to do that for the <em>album add</em> page. Instead, we will declare the page <strong>internally</strong> and not worry about removing it form the <strong>DOM</strong> to prevent page caching. The reason is that, though it will look very similar to the <em>album edit</em> page in mark-up, it differs slightly in its usage. The <em>album add</em> page has no document association and is not served up based on a document <strong>id</strong>. So using a <strong>show function</strong> would essentially return a 404. We could have it as an external page, but I got to thinking… will we need the ability for a user to hit the <em>album add</em> page outside of the context of the client application? Meaning, should we restrict the ability to add documents to a single client? I am choosing to, but you can certainly run with it and make it external. For me it makes more sense to only allow the <em>index.html</em> to be hit and the sole starting point for the <strong>Albums</strong> application.</p>
<p>To start, open up that old <em>index.html</em> file from the <em>/_attachments</em> directory in your favorite text editor. We are initially just going to modify the page declarations in the <strong>body</strong> tag, so the following modifications are a subset of lines from the <em>index.html</em>. The whole file will be presented later; for now save the following changes:</p>
<p><em>_attachments/index.html</em></p>
<div><pre><div class="line number8 index0 alt1"><code class="xml plain">&lt;</code><code class="xml keyword">body</code><code class="xml plain">&gt;</code></div><div class="line number9 index1 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"home"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"page"</code><code class="xml plain">&gt;</code></div><div class="line number10 index2 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"header"</code><code class="xml plain">&gt;&lt;</code><code class="xml keyword">h1</code><code class="xml plain">&gt;Albums&lt;/</code><code class="xml keyword">h1</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number11 index3 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"content"</code><code class="xml plain">&gt;</code></div><div class="line number12 index4 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">ul</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albums"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"listview"</code> <code class="xml color1">data-theme</code><code class="xml plain">=</code><code class="xml string">"c"</code> <code class="xml color1">data-dividertheme</code><code class="xml plain">=</code><code class="xml string">"b"</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">ul</code><code class="xml plain">&gt;</code></div><div class="line number13 index5 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number14 index6 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"footer"</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-bar"</code><code class="xml plain">&gt;&lt;</code><code class="xml keyword">h4</code><code class="xml plain">&gt;a list of albums&lt;/</code><code class="xml keyword">h4</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number15 index7 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number16 index8 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"addAlbum"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"page"</code><code class="xml plain">&gt;</code></div><div class="line number17 index9 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"header"</code><code class="xml plain">&gt;&lt;</code><code class="xml keyword">h1</code><code class="xml plain">&gt;Add Album&lt;/</code><code class="xml keyword">h1</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number18 index10 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"content"</code><code class="xml plain">&gt;</code></div><div class="line number19 index11 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">form</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albumAddForm"</code> <code class="xml color1">action</code><code class="xml plain">=</code><code class="xml string">"#"</code> <code class="xml color1">method</code><code class="xml plain">=</code><code class="xml string">"get"</code><code class="xml plain">&gt;</code></div><div class="line number20 index12 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"fieldcontain"</code><code class="xml plain">&gt;</code></div><div class="line number21 index13 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">label</code> <code class="xml color1">for</code><code class="xml plain">=</code><code class="xml string">"artist"</code><code class="xml plain">&gt;Artist:&lt;/</code><code class="xml keyword">label</code><code class="xml plain">&gt;</code></div><div class="line number22 index14 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">input</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"addArtistField"</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">"artist"</code> <code class="xml color1">type</code><code class="xml plain">=</code><code class="xml string">"text"</code> <code class="xml plain">/&gt;</code></div><div class="line number23 index15 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number24 index16 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"fieldcontain"</code><code class="xml plain">&gt;</code></div><div class="line number25 index17 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">label</code> <code class="xml color1">for</code><code class="xml plain">=</code><code class="xml string">"title"</code><code class="xml plain">&gt;Title:&lt;/</code><code class="xml keyword">label</code><code class="xml plain">&gt;</code></div><div class="line number26 index18 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">input</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"addTitleField"</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">"title"</code> <code class="xml color1">type</code><code class="xml plain">=</code><code class="xml string">"text"</code> <code class="xml plain">/&gt;</code></div><div class="line number27 index19 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number28 index20 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"fieldcontain"</code><code class="xml plain">&gt;</code></div><div class="line number29 index21 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">label</code> <code class="xml color1">for</code><code class="xml plain">=</code><code class="xml string">"description"</code><code class="xml plain">&gt;Description:&lt;/</code><code class="xml keyword">label</code><code class="xml plain">&gt;</code></div><div class="line number30 index22 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">textarea</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"addDescriptionField"</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">"description"</code> <code class="xml color1">cols</code><code class="xml plain">=</code><code class="xml string">"40"</code> <code class="xml color1">rows</code><code class="xml plain">=</code><code class="xml string">"8"</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">textarea</code><code class="xml plain">&gt;</code></div><div class="line number31 index23 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number32 index24 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-body ui-body-b"</code><code class="xml plain">&gt;</code></div><div class="line number33 index25 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">fieldset</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-grid-a"</code><code class="xml plain">&gt;</code></div><div class="line number34 index26 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-block-a"</code><code class="xml plain">&gt;</code></div><div class="line number35 index27 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">a</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#home"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"addCancelButton"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"button"</code> <code class="xml color1">data-theme</code><code class="xml plain">=</code><code class="xml string">"d"</code><code class="xml plain">&gt;Cancel&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;</code></div><div class="line number36 index28 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number37 index29 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-block-b"</code><code class="xml plain">&gt;</code></div><div class="line number38 index30 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">a</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"addSubmitButton"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"button"</code> <code class="xml color1">data-theme</code><code class="xml plain">=</code><code class="xml string">"a"</code><code class="xml plain">&gt;Submit&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;</code></div><div class="line number39 index31 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number40 index32 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">fieldset</code><code class="xml plain">&gt;</code></div><div class="line number41 index33 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number42 index34 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">form</code><code class="xml plain">&gt;</code></div><div class="line number43 index35 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number44 index36 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number45 index37 alt2"><code class="xml plain">&lt;/</code><code class="xml keyword">body</code><code class="xml plain">&gt;</code></div></pre></div>
<p>As i mentioned earlier, if you have been following along with the previous posts, the <strong>addAlbum</strong> page is very similar to the <strong>external</strong> <em>album edit</em> page (created in the last post); the only difference being that the fields/buttons have different <strong>id</strong>s and the header is left to default in displaying the <strong>Back</strong> button.</p>
<p>There is associated script with the internal <strong>addAlbum</strong> page that handles submitting a new album document to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database, and there is no time like the present to shut me up and dive right in. Make the following changes to the previously created <em>handleDocumentReady</em>() <strong>JavaScript</strong> method within <em>index.html</em>:</p>
<p><em>_attachments/index.html</em></p>
<div><pre><div class="line number51 index0 alt2"><code class="jscript keyword">function</code> <code class="jscript plain">handleDocumentReady()</code></div><div class="line number52 index1 alt1"><code class="jscript plain">{</code></div><div class="line number53 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#home"</code><code class="jscript plain">).bind( </code><code class="jscript string">"pagebeforeshow"</code><code class="jscript plain">, refreshAlbums );</code></div><div class="line number54 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">refreshAlbums();</code></div><div class="line number55 index4 alt2">&nbsp;</div><div class="line number56 index5 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#addSubmitButton"</code><code class="jscript plain">).live( </code><code class="jscript string">"click"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">( event ) {</code></div><div class="line number57 index6 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">event.preventDefault();</code></div><div class="line number58 index7 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">document = {};</code></div><div class="line number59 index8 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.artist = $(</code><code class="jscript string">"input#addArtistField"</code><code class="jscript plain">).val();</code></div><div class="line number60 index9 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.title = $(</code><code class="jscript string">"input#addTitleField"</code><code class="jscript plain">).val();</code></div><div class="line number61 index10 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.description = $(</code><code class="jscript string">"textarea#addDescriptionField"</code><code class="jscript plain">).val();</code></div><div class="line number62 index11 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.creation_date = ( </code><code class="jscript keyword">new</code> <code class="jscript plain">Date() ).getTime();</code></div><div class="line number63 index12 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$db.saveDoc( document, {</code></div><div class="line number64 index13 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number65 index14 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.mobile.changePage( </code><code class="jscript string">"#home"</code><code class="jscript plain">, </code><code class="jscript string">"slidedown"</code><code class="jscript plain">, </code><code class="jscript keyword">true</code><code class="jscript plain">, </code><code class="jscript keyword">true</code> <code class="jscript plain">);</code></div><div class="line number66 index15 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number67 index16 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number68 index17 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">alert( </code><code class="jscript string">"Cannot save new document."</code> <code class="jscript plain">);</code></div><div class="line number69 index18 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number70 index19 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number71 index20 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">false</code><code class="jscript plain">;</code></div><div class="line number72 index21 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number73 index22 alt2"><code class="jscript plain">}</code></div></pre></div>
<p>Essentially, we add a <em>click</em> event handler to the <strong>submit button</strong>, create a new document object, fill in the proper fields then use the <strong>$db</strong> instance (established on load as the albums databased from the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance) to save the new document. You may notice that saving a new document and updating an existing document are both done using the same function from the <strong>jquery.couch</strong> plugin: <em>saveDoc</em>(). That function will check for an <strong>_id</strong> on the document object (first argument) and determine if a <strong>POST</strong> or <strong>PUT</strong> is required. That is all handled internally in <em>saveDoc</em>() so you don’t have to worry.</p>
<h3>creation_date</h3>
<p>You may have also noticed that i said “proper fields” and the document object has a property that was not on the previous documents we created from the first post. Where did this <strong>creation_date</strong> property come from? And why won’t it throw an error on save? Short answer: we are working with a document-oriented database, so we are not tied to a schema and a pre-defined set of fields in a table. So anything can be added to any document?! Isn’t that a little wild-west?! Maybe, but we are making a pretty focused client application here where we know what fields we want to present to the user; but it is a good point and a solid argument to not keep your <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance in <a href="http://guide.couchdb.org/draft/security.html" target="_blank">admin-party</a> and to create good <a href="http://guide.couchdb.org/draft/validation.html" target="_blank">validation functions</a>. For now, we are not concerned about security or validation and are having some fun.</p>
<p>OK, so why did we add <strong>creation_date</strong>? The reason is related to the <strong>map function</strong> for <em>/views/albums</em>. If you remember way back to the <a href="http://custardbelly.com/blog/?p=244" target="_blank">first article</a>, we created a <strong>map function</strong> for our <strong>albums view</strong> that basically returned a key and value. The key being the <strong>_id</strong> of each document. That key is used to sort the returned array of documents. That key is also automatically generated for us when we create a new document. Hence, a case could be made that the order of added documents will not correlate to the descending order of the sorted key list (<strong>_id</strong> of each document in the database). In order to be able to properly present the list of albums in the order that they were added to the database, the <strong>creation_date</strong> property is now being added to each new document. I use the time in milliseconds as the value for <strong>creation_date</strong> because i feel that most (if not all) client-side languages will know how to use that number and format the date as required.</p>
<h3>Updating albums view</h3>
<p>Well… now there is the issue of returning and displaying album documents sorted by <strong>creation_date</strong>. Fortunately it is an easy issue to resolve: we are going to update the key value returned from the <strong>map function</strong> of the <strong>albums view</strong>.</p>
<p>Open up <em>/views/albums/map.js</em> in your favorite text editor and change the previously-saved <em>emit</em>() invocation to the following:</p>
<p>/views/albums/map.js</p>
<div><pre><div class="line number1 index0 alt2"><code class="jscript keyword">function</code><code class="jscript plain">(doc) {</code></div><div class="line number2 index1 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;</code><code class="jscript plain">emit( ( </code><code class="jscript keyword">new</code> <code class="jscript plain">Date(doc.creation_date) ).getTime(), doc );</code></div><div class="line number3 index2 alt2"><code class="jscript plain">}</code></div></pre></div>
<p>We are now using the <strong>creation_date</strong> property as the key for each document to return. <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> will sort on this key and return a list of documents from the <strong>albums</strong> database in our <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> instance. You may notice that we are resolving to a new instance of <strong>Date</strong> using the <strong>creation_date</strong> property value and then returning the same value using <em>getTime</em>(). Seems a little superfluous. However, it is just a sort of future-proofing if a requirement comes down the pipe that <strong>creation_date</strong> needs to be saved in some other format. Who knows.</p>
<h3>Sorting</h3>
<p>If we were to push our changes and requested the list of album documents, you would notice that the documents are sorted by <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> in ascending order (oldest <strong>creation_date</strong> first). Now, we could create a <strong>reduce function</strong> to return the list in descending order, but i don’t think that is the best use of <strong>reduce</strong> seeing as we can easily using <strong>JavaScript</strong> to reverse the array upon response. So, I am going to make you open up <em>index.html</em> again and add one line with the <em>refreshAlbums</em>() <strong>JavaScript</strong> method:</p>
<p><em>/_attachments/index.html</em></p>
<div><pre><div class="line number83 index0 alt2"><code class="jscript keyword">function</code> <code class="jscript plain">refreshAlbums()</code></div><div class="line number84 index1 alt1"><code class="jscript plain">{</code></div><div class="line number85 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#albums"</code><code class="jscript plain">).empty();</code></div><div class="line number86 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$db.view(</code><code class="jscript string">"albums/albums"</code><code class="jscript plain">, {</code></div><div class="line number87 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( data ) {</code></div><div class="line number88 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">i;</code></div><div class="line number89 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">album;</code></div><div class="line number90 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">artist;</code></div><div class="line number91 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">title;</code></div><div class="line number92 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">description;</code></div><div class="line number93 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">listItem;</code></div><div class="line number94 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">header;</code></div><div class="line number95 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">albumLink;</code></div><div class="line number96 index13 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">data.rows.reverse();</code></div><div class="line number97 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">for</code><code class="jscript plain">( i </code><code class="jscript keyword">in</code> <code class="jscript plain">data.rows )</code></div><div class="line number98 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number99 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">album = data.rows[i].value;</code></div><div class="line number100 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">artist = album.artist;</code></div><div class="line number101 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">title = album.title;</code></div><div class="line number102 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">description = album.description;</code></div><div class="line number103 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">externalPage = </code><code class="jscript string">"_show/album/"</code> <code class="jscript plain">+ album._id;</code></div><div class="line number104 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">listItem = </code><code class="jscript string">"&lt;li class=\"album\"&gt;"</code> <code class="jscript plain">+</code></div><div class="line number105 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;a href=\""</code> <code class="jscript plain">+ externalPage + </code><code class="jscript string">"\"&gt;"</code> <code class="jscript plain">+</code></div><div class="line number106 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;h2 class=\"artist\"&gt;"</code> <code class="jscript plain">+ artist + </code><code class="jscript string">"&lt;\/h2&gt;"</code> <code class="jscript plain">+</code></div><div class="line number107 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;\/a&gt;"</code> <code class="jscript plain">+</code></div><div class="line number108 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;p class=\"title\"&gt;"</code> <code class="jscript plain">+ title + </code><code class="jscript string">"&lt;\/p&gt;"</code> <code class="jscript plain">+</code></div><div class="line number109 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;p class=\"description\"&gt;"</code> <code class="jscript plain">+ description + </code><code class="jscript string">"&lt;\/p&gt;"</code> <code class="jscript plain">+</code></div><div class="line number110 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;\/li&gt;"</code><code class="jscript plain">;</code></div><div class="line number111 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#albums"</code><code class="jscript plain">).append( listItem );</code></div><div class="line number112 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number113 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#albums"</code><code class="jscript plain">).listview( </code><code class="jscript string">"refresh"</code> <code class="jscript plain">);</code></div><div class="line number114 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number115 index32 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number116 index33 alt1"><code class="jscript plain">}</code></div></pre></div>
<p>That’s it! Just reverse the returned rows of album documents from the view request and we have a descending list of albums we have added to the database based on <strong>creation_date</strong>.</p>
<p>Now the only problem is we have no way of accessing the <strong>addAlbum</strong> page! Don’t fret. We’re going to add a button bar to the <strong>footer</strong> of the <strong>#home</strong> page that will take us there.</p>
<h2>Updating #home Footer</h2>
<p>We are going to update the default (<strong>#home</strong>) <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page for our application to display a button bar in the <strong>footer</strong>. Originally, we just had some text there as a placeholder, but seeing as we want to ability to add album documents from the list view will replace that text with a <strong>navbar</strong> containing a single button – the <strong>add button</strong> – that will navigate the user to the <em>album add</em> page we created in the previous section of this article. Doing so will involve a couple user experience issues that we will address and uncover a few more <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> goodies.</p>
<p>Open up <em>/_attachments/index.html</em> in your favorite editor and save the following modifications to the <strong>#home</strong> page:</p>
<p><em>/_attachments/index.html</em></p>
<div><pre><div class="line number9 index0 alt2"><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"home"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"page"</code><code class="xml plain">&gt;</code></div><div class="line number10 index1 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"header"</code> <code class="xml color1">data-position</code><code class="xml plain">=</code><code class="xml string">"fixed"</code><code class="xml plain">&gt;&lt;</code><code class="xml keyword">h1</code><code class="xml plain">&gt;Albums&lt;/</code><code class="xml keyword">h1</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number11 index2 alt2"><code class="xml spaces">&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"content"</code><code class="xml plain">&gt;</code></div><div class="line number12 index3 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">ul</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albums"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"listview"</code> <code class="xml color1">data-theme</code><code class="xml plain">=</code><code class="xml string">"c"</code> <code class="xml color1">data-dividertheme</code><code class="xml plain">=</code><code class="xml string">"b"</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">ul</code><code class="xml plain">&gt;</code></div><div class="line number13 index4 alt2"><code class="xml spaces">&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number14 index5 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"footer"</code> <code class="xml color1">data-position</code><code class="xml plain">=</code><code class="xml string">"fixed"</code><code class="xml plain">&gt;</code></div><div class="line number15 index6 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"navbar"</code><code class="xml plain">&gt;</code></div><div class="line number16 index7 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">ul</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-grid-a"</code><code class="xml plain">&gt;</code></div><div class="line number17 index8 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">li</code> <code class="xml color1">style</code><code class="xml plain">=</code><code class="xml string">"width:100%;"</code><code class="xml plain">&gt;&lt;</code><code class="xml keyword">a</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#addAlbum"</code> <code class="xml color1">data-transition</code><code class="xml plain">=</code><code class="xml string">"slideup"</code> <code class="xml color1">data-icon</code><code class="xml plain">=</code><code class="xml string">"plus"</code><code class="xml plain">&gt;Add Album&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">li</code><code class="xml plain">&gt;</code></div><div class="line number18 index9 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">ul</code><code class="xml plain">&gt;</code></div><div class="line number19 index10 alt2 highlighted"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number20 index11 alt1 highlighted"><code class="xml spaces">&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number21 index12 alt2"><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div></pre></div>
<p>The first thing you may notice is that we have added a <strong>data-position</strong> attribute to the <strong>header</strong> and <strong>footer</strong>. With a value of “<em>fixed</em>“, the<a href="http://jquerymobile.com/" target="_blank"> jQuery Mobile</a> framework will ensure that they are always in place (<strong>header</strong> at top, <strong>footer</strong> at bottom) without regards to scrolling. This will treat the content list as the scrollable area, so when our list grows with all the new album documents that we create a user will always see and be able to access the <strong>header</strong> and <strong>footer</strong> (with the <strong>add button</strong>).</p>
<p>Aside from the <strong>data-position</strong> attribution, we added a <strong>navbar</strong> as the content for the <strong>footer</strong>. The content of the <strong>navbar</strong> is a list with a single item with its navigational reference to the <strong>addAlbum</strong> <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> page we created previously. Assigning a <a href="http://jquerymobile.com/demos/1.0a2/#docs/content/content-grids.html" target="_blank">grid</a> class to the list will layout its items in a sequently manner. We set the <strong>width</strong> style rule directly for the list item because styling of list items for a <strong>navbar</strong> are limited to at least 2 items in the <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a>. To get around that and have a single button, we just set it to have the width of the <strong>navbar</strong>. Then we also got all fancy with transitions and icons on the link within the list item <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley"> </p>
<p>The only drawback to this solution is that we dynamically fill our list upon load. Unfortunately this updates the y position of the <strong>footer</strong> by (<em>n*list item height</em>). So if we kept our page like this, we’d lose the <strong>footer</strong> off the page once the list is filled <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_sad.gif" alt=":(" class="wp-smiley">  Wait, don’t leave… we can easily fix that!</p>
<p>With the <em>/_attachments/index.html</em> file still open in your favorite text editor, add the following line after the list <em>refresh</em>():</p>
<p><em>/_attachments/index.html</em></p>
<div><pre><div class="line number83 index0 alt2"><code class="jscript keyword">function</code> <code class="jscript plain">refreshAlbums()</code></div><div class="line number84 index1 alt1"><code class="jscript plain">{</code></div><div class="line number85 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#albums"</code><code class="jscript plain">).empty();</code></div><div class="line number86 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$db.view(</code><code class="jscript string">"albums/albums"</code><code class="jscript plain">, {</code></div><div class="line number87 index4 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">( data ) {</code></div><div class="line number88 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">i;</code></div><div class="line number89 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">album;</code></div><div class="line number90 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">artist;</code></div><div class="line number91 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">title;</code></div><div class="line number92 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">description;</code></div><div class="line number93 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">listItem;</code></div><div class="line number94 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">header;</code></div><div class="line number95 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">albumLink;</code></div><div class="line number96 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">data.rows.reverse();</code></div><div class="line number97 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">for</code><code class="jscript plain">( i </code><code class="jscript keyword">in</code> <code class="jscript plain">data.rows )</code></div><div class="line number98 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">{</code></div><div class="line number99 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">album = data.rows[i].value;</code></div><div class="line number100 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">artist = album.artist;</code></div><div class="line number101 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">title = album.title;</code></div><div class="line number102 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">description = album.description;</code></div><div class="line number103 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">externalPage = </code><code class="jscript string">"_show/album/"</code> <code class="jscript plain">+ album._id;</code></div><div class="line number104 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">listItem = </code><code class="jscript string">"&lt;li class=\"album\"&gt;"</code> <code class="jscript plain">+</code></div><div class="line number105 index22 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;a href=\""</code> <code class="jscript plain">+ externalPage + </code><code class="jscript string">"\"&gt;"</code> <code class="jscript plain">+</code></div><div class="line number106 index23 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;h2 class=\"artist\"&gt;"</code> <code class="jscript plain">+ artist + </code><code class="jscript string">"&lt;\/h2&gt;"</code> <code class="jscript plain">+</code></div><div class="line number107 index24 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;\/a&gt;"</code> <code class="jscript plain">+</code></div><div class="line number108 index25 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;p class=\"title\"&gt;"</code> <code class="jscript plain">+ title + </code><code class="jscript string">"&lt;\/p&gt;"</code> <code class="jscript plain">+</code></div><div class="line number109 index26 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;p class=\"description\"&gt;"</code> <code class="jscript plain">+ description + </code><code class="jscript string">"&lt;\/p&gt;"</code> <code class="jscript plain">+</code></div><div class="line number110 index27 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;p class=\"date\"&gt;"</code> <code class="jscript plain">+ </code><code class="jscript keyword">new</code> <code class="jscript plain">Date( album.creation_date ) + </code><code class="jscript string">"&lt;\/p&gt;"</code> <code class="jscript plain">+</code></div><div class="line number111 index28 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript string">"&lt;\/li&gt;"</code><code class="jscript plain">;</code></div><div class="line number112 index29 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#albums"</code><code class="jscript plain">).append( listItem );</code></div><div class="line number113 index30 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number114 index31 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#albums"</code><code class="jscript plain">).listview( </code><code class="jscript string">"refresh"</code> <code class="jscript plain">);</code></div><div class="line number115 index32 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.fixedToolbars.show();</code></div><div class="line number116 index33 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number117 index34 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number118 index35 alt1"><code class="jscript plain">}</code></div></pre></div>
<p>The <strong>fixedToolbars</strong> controller is available from <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> with several public methods exposed for dealing with the <strong>header</strong> and <strong>footer</strong> toolbars. We are using <em>show</em>() to force an update in placement once the list has been refreshed. This will affectively put the <strong>footer</strong> (with its add button) back to the bottom where it belongs and is accessible. Hack? Maybe. But it works for now (see versions at end of post <img src="http://custardbelly.com/blog/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley"> ).</p>
<p>So that is it… except for one thing. </p>
<h3>Finishing Up</h3>
<p>I can be a stickler. The <strong>addAlbum</strong> page is not removed from the <strong>DOM</strong> once navigated away from like the other pages we have created. We did that previously to ensure we were getting the correct returns from the <strong>show function</strong> based on document <strong>_id</strong>; <a href="http://jquerymobile.com/" target="_blank">jQuery Mobile</a> was caching those pages in the <strong>DOM</strong> so it never went back out with the update <strong>_id</strong>. However, our case here is a little different. </p>
<p>The <strong>addAlbum</strong> page is not associated with a document upon view. It just saves a document to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database using the <em>jquery.couch</em> plugin. As such, if a user navigates away from the page – either from an explicit cancel/close or directed back to <strong>#home</strong> upon save success – we should clear out those input fields. Otherwise, when a user navigates to the <strong>addAlbum</strong> page again, we’ll always see the last input. That shouldn’t be the case. The user should start fresh each time. To do that, we’ll just listen to when the page is hidden in the <strong>DOM</strong> and clear the fields.</p>
<p>With <em>/_attachments/index.html</em> still open in your favorite text editor, save the following modifications to the <em>handleDocumentReady</em>() <strong>JavaScript</strong> function:</p>
<p><em>/_attachments/index.html</em></p>
<div><pre><div class="line number57 index0 alt2"><code class="jscript keyword">function</code> <code class="jscript plain">handleDocumentReady()</code></div><div class="line number58 index1 alt1"><code class="jscript plain">{</code></div><div class="line number59 index2 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#home"</code><code class="jscript plain">).bind( </code><code class="jscript string">"pagebeforeshow"</code><code class="jscript plain">, refreshAlbums );</code></div><div class="line number60 index3 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">refreshAlbums();</code></div><div class="line number61 index4 alt2">&nbsp;</div><div class="line number62 index5 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#addSubmitButton"</code><code class="jscript plain">).live( </code><code class="jscript string">"click"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">( event ) {</code></div><div class="line number63 index6 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">event.preventDefault();</code></div><div class="line number64 index7 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">var</code> <code class="jscript plain">document = {};</code></div><div class="line number65 index8 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.artist = $(</code><code class="jscript string">"input#addArtistField"</code><code class="jscript plain">).val();</code></div><div class="line number66 index9 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.title = $(</code><code class="jscript string">"input#addTitleField"</code><code class="jscript plain">).val();</code></div><div class="line number67 index10 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.description = $(</code><code class="jscript string">"textarea#addDescriptionField"</code><code class="jscript plain">).val();</code></div><div class="line number68 index11 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">document.creation_date = ( </code><code class="jscript keyword">new</code> <code class="jscript plain">Date() ).getTime();</code></div><div class="line number69 index12 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$db.saveDoc( document, {</code></div><div class="line number70 index13 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">success: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number71 index14 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$.mobile.changePage( </code><code class="jscript string">"#home"</code><code class="jscript plain">, </code><code class="jscript string">"slidedown"</code><code class="jscript plain">, </code><code class="jscript keyword">true</code><code class="jscript plain">, </code><code class="jscript keyword">true</code> <code class="jscript plain">);</code></div><div class="line number72 index15 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">},</code></div><div class="line number73 index16 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">error: </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number74 index17 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">alert( </code><code class="jscript string">"Cannot save new document."</code> <code class="jscript plain">);</code></div><div class="line number75 index18 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">}</code></div><div class="line number76 index19 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number77 index20 alt2"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript keyword">return</code> <code class="jscript keyword">false</code><code class="jscript plain">;</code></div><div class="line number78 index21 alt1"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number79 index22 alt2">&nbsp;</div><div class="line number80 index23 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"#addAlbum"</code><code class="jscript plain">).bind( </code><code class="jscript string">"pagehide"</code><code class="jscript plain">, </code><code class="jscript keyword">function</code><code class="jscript plain">() {</code></div><div class="line number81 index24 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"input#addArtistField"</code><code class="jscript plain">).val( </code><code class="jscript string">""</code> <code class="jscript plain">);</code></div><div class="line number82 index25 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"input#addTitleField"</code><code class="jscript plain">).val( </code><code class="jscript string">""</code> <code class="jscript plain">);</code></div><div class="line number83 index26 alt2 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">$(</code><code class="jscript string">"textarea#addDescriptionField"</code><code class="jscript plain">).val( </code><code class="jscript string">""</code> <code class="jscript plain">);</code></div><div class="line number84 index27 alt1 highlighted"><code class="jscript spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="jscript plain">});</code></div><div class="line number85 index28 alt2"><code class="jscript plain">}</code></div></pre></div>
<p>Similarly to how we listened for navigation away from the other <strong>external</strong> pages, we assign an even handler for the “<em>pagehide</em>” event and clear the input fields. That will be invoked upon back/cancel and successful commit (via the <strong>$.mobile</strong>.<em>changePage</em>() method), so we can ensure that the fields are always presented empty upon hitting the <strong>addAlbum</strong> page.</p>
<p>So we are all on the same page (pun… intended?), here is the updated <em>/_attachments/index.html</em> file in all its modified glory:</p>
<div><pre><div class="line number1 index0 alt2"><code class="xml plain">&lt;!DOCTYPE html&gt;</code></div><div class="line number2 index1 alt1"><code class="xml plain">&lt;</code><code class="xml keyword">html</code><code class="xml plain">&gt;</code></div><div class="line number3 index2 alt2"><code class="xml spaces">&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">head</code><code class="xml plain">&gt;</code></div><div class="line number4 index3 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">title</code><code class="xml plain">&gt;My Albums&lt;/</code><code class="xml keyword">title</code><code class="xml plain">&gt;</code></div><div class="line number5 index4 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">link</code> <code class="xml color1">rel</code><code class="xml plain">=</code><code class="xml string">"stylesheet"</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"style/main.css"</code> <code class="xml color1">type</code><code class="xml plain">=</code><code class="xml string">"text/css"</code><code class="xml plain">&gt;</code></div><div class="line number6 index5 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">link</code> <code class="xml color1">rel</code><code class="xml plain">=</code><code class="xml string">"stylesheet"</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"style/jquery.mobile-1.0a2.css"</code> <code class="xml color1">type</code><code class="xml plain">=</code><code class="xml string">"text/css"</code><code class="xml plain">/&gt;</code></div><div class="line number7 index6 alt2"><code class="xml spaces">&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">head</code><code class="xml plain">&gt;</code></div><div class="line number8 index7 alt1"><code class="xml spaces">&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">body</code><code class="xml plain">&gt;</code></div><div class="line number9 index8 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"home"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"page"</code><code class="xml plain">&gt;</code></div><div class="line number10 index9 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"header"</code> <code class="xml color1">data-position</code><code class="xml plain">=</code><code class="xml string">"fixed"</code><code class="xml plain">&gt;&lt;</code><code class="xml keyword">h1</code><code class="xml plain">&gt;Albums&lt;/</code><code class="xml keyword">h1</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number11 index10 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"content"</code><code class="xml plain">&gt;</code></div><div class="line number12 index11 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">ul</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albums"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"listview"</code> <code class="xml color1">data-theme</code><code class="xml plain">=</code><code class="xml string">"c"</code> <code class="xml color1">data-dividertheme</code><code class="xml plain">=</code><code class="xml string">"b"</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">ul</code><code class="xml plain">&gt;</code></div><div class="line number13 index12 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number14 index13 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"footer"</code> <code class="xml color1">data-position</code><code class="xml plain">=</code><code class="xml string">"fixed"</code><code class="xml plain">&gt;</code></div><div class="line number15 index14 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"navbar"</code><code class="xml plain">&gt;</code></div><div class="line number16 index15 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">ul</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-grid-a"</code><code class="xml plain">&gt;</code></div><div class="line number17 index16 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">li</code> <code class="xml color1">style</code><code class="xml plain">=</code><code class="xml string">"width:100%;"</code><code class="xml plain">&gt;&lt;</code><code class="xml keyword">a</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#addAlbum"</code> <code class="xml color1">data-transition</code><code class="xml plain">=</code><code class="xml string">"slideup"</code> <code class="xml color1">data-icon</code><code class="xml plain">=</code><code class="xml string">"plus"</code><code class="xml plain">&gt;Add Album&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">li</code><code class="xml plain">&gt;</code></div><div class="line number18 index17 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">ul</code><code class="xml plain">&gt;</code></div><div class="line number19 index18 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number20 index19 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number21 index20 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number22 index21 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"addAlbum"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"page"</code><code class="xml plain">&gt;</code></div><div class="line number23 index22 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"header"</code><code class="xml plain">&gt;&lt;</code><code class="xml keyword">h1</code><code class="xml plain">&gt;Add Album&lt;/</code><code class="xml keyword">h1</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number24 index23 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"content"</code><code class="xml plain">&gt;</code></div><div class="line number25 index24 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">form</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"albumAddForm"</code> <code class="xml color1">action</code><code class="xml plain">=</code><code class="xml string">"#"</code> <code class="xml color1">method</code><code class="xml plain">=</code><code class="xml string">"get"</code><code class="xml plain">&gt;</code></div><div class="line number26 index25 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"fieldcontain"</code><code class="xml plain">&gt;</code></div><div class="line number27 index26 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">label</code> <code class="xml color1">for</code><code class="xml plain">=</code><code class="xml string">"artist"</code><code class="xml plain">&gt;Artist:&lt;/</code><code class="xml keyword">label</code><code class="xml plain">&gt;</code></div><div class="line number28 index27 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">input</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"addArtistField"</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">"artist"</code> <code class="xml color1">type</code><code class="xml plain">=</code><code class="xml string">"text"</code> <code class="xml plain">/&gt;</code></div><div class="line number29 index28 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number30 index29 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"fieldcontain"</code><code class="xml plain">&gt;</code></div><div class="line number31 index30 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">label</code> <code class="xml color1">for</code><code class="xml plain">=</code><code class="xml string">"title"</code><code class="xml plain">&gt;Title:&lt;/</code><code class="xml keyword">label</code><code class="xml plain">&gt;</code></div><div class="line number32 index31 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">input</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"addTitleField"</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">"title"</code> <code class="xml color1">type</code><code class="xml plain">=</code><code class="xml string">"text"</code> <code class="xml plain">/&gt;</code></div><div class="line number33 index32 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number34 index33 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"fieldcontain"</code><code class="xml plain">&gt;</code></div><div class="line number35 index34 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">label</code> <code class="xml color1">for</code><code class="xml plain">=</code><code class="xml string">"description"</code><code class="xml plain">&gt;Description:&lt;/</code><code class="xml keyword">label</code><code class="xml plain">&gt;</code></div><div class="line number36 index35 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">textarea</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"addDescriptionField"</code> <code class="xml color1">name</code><code class="xml plain">=</code><code class="xml string">"description"</code> <code class="xml color1">cols</code><code class="xml plain">=</code><code class="xml string">"40"</code> <code class="xml color1">rows</code><code class="xml plain">=</code><code class="xml string">"8"</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">textarea</code><code class="xml plain">&gt;</code></div><div class="line number37 index36 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number38 index37 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-body ui-body-b"</code><code class="xml plain">&gt;</code></div><div class="line number39 index38 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">fieldset</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-grid-a"</code><code class="xml plain">&gt;</code></div><div class="line number40 index39 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-block-a"</code><code class="xml plain">&gt;</code></div><div class="line number41 index40 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">a</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#home"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"addCancelButton"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"button"</code> <code class="xml color1">data-theme</code><code class="xml plain">=</code><code class="xml string">"d"</code><code class="xml plain">&gt;Cancel&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;</code></div><div class="line number42 index41 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number43 index42 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">div</code> <code class="xml color1">class</code><code class="xml plain">=</code><code class="xml string">"ui-block-b"</code><code class="xml plain">&gt;</code></div><div class="line number44 index43 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">a</code> <code class="xml color1">href</code><code class="xml plain">=</code><code class="xml string">"#"</code> <code class="xml color1">id</code><code class="xml plain">=</code><code class="xml string">"addSubmitButton"</code> <code class="xml color1">data-role</code><code class="xml plain">=</code><code class="xml string">"button"</code> <code class="xml color1">data-theme</code><code class="xml plain">=</code><code class="xml string">"a"</code><code class="xml plain">&gt;Submit&lt;/</code><code class="xml keyword">a</code><code class="xml plain">&gt;</code></div><div class="line number45 index44 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number46 index45 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">fieldset</code><code class="xml plain">&gt;</code></div><div class="line number47 index46 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number48 index47 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">form</code><code class="xml plain">&gt;</code></div><div class="line number49 index48 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number50 index49 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">div</code><code class="xml plain">&gt;</code></div><div class="line number51 index50 alt2"><code class="xml spaces">&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">body</code><code class="xml plain">&gt;</code></div><div class="line number52 index51 alt1"><code class="xml spaces">&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">script</code> <code class="xml color1">src</code><code class="xml plain">=</code><code class="xml string">"vendor/couchapp/loader.js"</code><code class="xml plain">&gt;&lt;/</code><code class="xml keyword">script</code><code class="xml plain">&gt;</code></div><div class="line number53 index52 alt2"><code class="xml spaces">&nbsp;&nbsp;</code><code class="xml plain">&lt;</code><code class="xml keyword">script</code> <code class="xml color1">type</code><code class="xml plain">=</code><code class="xml string">"text/javascript"</code> <code class="xml color1">charset</code><code class="xml plain">=</code><code class="xml string">"utf-8"</code><code class="xml plain">&gt;</code></div><div class="line number54 index53 alt1">&nbsp;</div><div class="line number55 index54 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">$db = $.couch.db("albums");</code></div><div class="line number56 index55 alt1">&nbsp;</div><div class="line number57 index56 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">function handleDocumentReady()</code></div><div class="line number58 index57 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">{</code></div><div class="line number59 index58 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">$("#home").bind( "pagebeforeshow", refreshAlbums );</code></div><div class="line number60 index59 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">refreshAlbums();</code></div><div class="line number61 index60 alt2">&nbsp;</div><div class="line number62 index61 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">$("#addSubmitButton").live( "click", function( event ) {</code></div><div class="line number63 index62 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">event.preventDefault();</code></div><div class="line number64 index63 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">var document = {};</code></div><div class="line number65 index64 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">document.artist = $("input#addArtistField").val();</code></div><div class="line number66 index65 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">document.title = $("input#addTitleField").val();</code></div><div class="line number67 index66 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">document.description = $("textarea#addDescriptionField").val();</code></div><div class="line number68 index67 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">document.creation_date = ( new Date() ).getTime();</code></div><div class="line number69 index68 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">$db.saveDoc( document, {</code></div><div class="line number70 index69 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">success: function() {</code></div><div class="line number71 index70 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">$.mobile.changePage( "#home", "slidedown", true, true );</code></div><div class="line number72 index71 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">},</code></div><div class="line number73 index72 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">error: function() {</code></div><div class="line number74 index73 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">alert( "Cannot save new document." );</code></div><div class="line number75 index74 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">}</code></div><div class="line number76 index75 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">});</code></div><div class="line number77 index76 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">return false;</code></div><div class="line number78 index77 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">});</code></div><div class="line number79 index78 alt2">&nbsp;</div><div class="line number80 index79 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">$("#addAlbum").bind( "pagehide", function() {</code></div><div class="line number81 index80 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">$("input#addArtistField").val( "" );</code></div><div class="line number82 index81 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">$("input#addTitleField").val( "" );</code></div><div class="line number83 index82 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">$("textarea#addDescriptionField").val( "" );</code></div><div class="line number84 index83 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">});</code></div><div class="line number85 index84 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">}</code></div><div class="line number86 index85 alt1">&nbsp;</div><div class="line number87 index86 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">function refreshAlbums()</code></div><div class="line number88 index87 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">{</code></div><div class="line number89 index88 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">$("#albums").empty();</code></div><div class="line number90 index89 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">$db.view("albums/albums", {</code></div><div class="line number91 index90 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">success: function( data ) {</code></div><div class="line number92 index91 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">var i;</code></div><div class="line number93 index92 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">var album;</code></div><div class="line number94 index93 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">var artist;</code></div><div class="line number95 index94 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">var title;</code></div><div class="line number96 index95 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">var description;</code></div><div class="line number97 index96 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">var listItem;</code></div><div class="line number98 index97 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">var header;</code></div><div class="line number99 index98 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">var albumLink;</code></div><div class="line number100 index99 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">data.rows.reverse();</code></div><div class="line number101 index100 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">for( i in data.rows )</code></div><div class="line number102 index101 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">{</code></div><div class="line number103 index102 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">album = data.rows[i].value;</code></div><div class="line number104 index103 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">artist = album.artist;</code></div><div class="line number105 index104 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">title = album.title;</code></div><div class="line number106 index105 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">description = album.description;</code></div><div class="line number107 index106 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">externalPage = "_show/album/" + album._id;</code></div><div class="line number108 index107 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">listItem = "&lt;</code><code class="xml keyword">li</code> <code class="xml plain">class=\"album\"&gt;" +</code></div><div class="line number109 index108 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">"&lt;</code><code class="xml keyword">a</code> <code class="xml plain">href=\"" + externalPage + "\"&gt;" +</code></div><div class="line number110 index109 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">"&lt;</code><code class="xml keyword">h2</code> <code class="xml plain">class=\"artist\"&gt;" + artist + "&lt;\/h2&gt;" +</code></div><div class="line number111 index110 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">"&lt;\/a&gt;" +</code></div><div class="line number112 index111 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">"&lt;</code><code class="xml keyword">p</code> <code class="xml plain">class=\"title\"&gt;" + title + "&lt;\/p&gt;" +</code></div><div class="line number113 index112 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">"&lt;</code><code class="xml keyword">p</code> <code class="xml plain">class=\"description\"&gt;" + description + "&lt;\/p&gt;" +</code></div><div class="line number114 index113 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">"&lt;\/li&gt;";</code></div><div class="line number115 index114 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">$("#albums").append( listItem );</code></div><div class="line number116 index115 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">}</code></div><div class="line number117 index116 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">$("#albums").listview( "refresh" );</code></div><div class="line number118 index117 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">$.fixedToolbars.show();</code></div><div class="line number119 index118 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">}</code></div><div class="line number120 index119 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">});</code></div><div class="line number121 index120 alt2"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">}</code></div><div class="line number122 index121 alt1"><code class="xml spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="xml plain">$(document).ready( handleDocumentReady );</code></div><div class="line number123 index122 alt2">&nbsp;</div><div class="line number124 index123 alt1"><code class="xml spaces">&nbsp;&nbsp;</code><code class="xml plain">&lt;/</code><code class="xml keyword">script</code><code class="xml plain">&gt;</code></div><div class="line number125 index124 alt2"><code class="xml plain">&lt;/</code><code class="xml keyword">html</code><code class="xml plain">&gt;</code></div></pre></div>
<h3>Deployment</h3>
<p>We modified our application to utilize a <strong>show function</strong> to serve the <em>albumadd</em> page up within a <a href="http://jquerymobile.com/" target="_blank">jquery Mobile</a> application. With these changes saved, we can now push to the <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> database using the <a href="http://couchapp.org/page/index" target="_blank">couchapp</a> utility. Open a terminal and navigate to the directory where you create your <strong>CouchApp</strong> applications (for me that is <em>/Documents/workspace/custardbelly/couchdb</em> and in there i have a folder named <em>albums</em> which is the <strong>CouchApp</strong> application directory for these examples). Enter the following command to push the changes to the <strong>CouchDB</strong> instance:</p>
<div><pre><div class="line number1 index0 alt2"><code class="bash plain">couchapp push albums http:</code><code class="bash plain">//127</code><code class="bash plain">.0.0.1:5984</code><code class="bash plain">/albums</code></div></pre></div>
<p>If all was successful and you now go to <a href="http://127.0.0.1:5984/albums/_design/albums/index.html" target="_blank">http://127.0.0.1:5984/albums/_design/albums/index.html</a>, we’ll still have our old familiar list and our new <strong>navbar</strong> items in the <strong>footer</strong>. Click the <strong>Add Album</strong> button to open the form and save some information. The document should be saved to the <strong>CouchDB</strong> database and the application will direct you back to the <strong>#home</strong> page with the updated list of albums.</p>
<p><em>index.html#addAlbum</em><br>
<img src="http://www.custardbelly.com/blog/images/couchapp_add_album.png"></p>
<p><em>index.html#home</em><br>
<img src="http://www.custardbelly.com/blog/images/couchapp_new_list.png"></p>
<h3>Conclusion</h3>
<p>In this article, we added another important piece to working with documents from a database – <strong>Create</strong>. Along the way  we uncovered a little about view maps from <a href="http://couchdb.apache.org/" target="_blank">CouchDB</a> and how they are sorted. We also found that the <strong>jquery.couch</strong> plugin handles create and update of documents through the same method – <em>saveDoc</em>() – on a database instance. As well, as it pertains to visible changes, we employed fixed toolbars, added custom <strong>footer</strong> content and discussed a little about the decision between using <strong>internal</strong> and <strong>external</strong> pages as it pertains to <em>User Experience</em> and application design. Hopefully, it all worked out. </p>
<p>Next up: we got the <strong>CRU</strong>… we need to the <strong>D</strong>.</p>
<p><em>[Note] This post was written against the following software versions:</em><br>
<strong>CouchDB </strong>– 1.0.1<br>
<strong>CouchApp</strong> – 0.7.2<br>
<strong>jQuery</strong> – 1.4.4<br>
<strong>jQuery Mobile</strong> – 1.0a2<br>
<em>If you have found this post and any piece has moved forward, hopefully the examples are still viable/useful. I will not be updating the examples in this post in parellel with updates to any of the previously mentioned software, unless explicitly noted.</em></p>
<p><strong>Articles in this series:</strong></p>
<ol>
<li><a href="http://custardbelly.com/blog/?p=244" target="_blank">Getting Started</a></li>
<li><a href="http://custardbelly.com/blog/?p=278" target="_blank">Displaying a page detail of a single album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=297" target="_blank">Templates and Mustache</a></li>
<li><a href="http://custardbelly.com/blog/?p=318" target="_blank">Displaying an editable page of an album.</a></li>
<li><a href="http://custardbelly.com/blog/?p=332" target="_blank">Creating and Adding an album document.</a></li>
<li><a href="http://custardbelly.com/blog/?p=344" target="_blank">Deleting an album document</a></li>
<li><a href="http://custardbelly.com/blog/?p=360" target="_blank">Authorization and Validation – Part 1</a></li>
<li><a href="http://custardbelly.com/blog/?p=394">Authorization and Validation – Part 2</a></li>
</ol>
<p><a href="http://custardbelly.com/downloads/couchapp/jqm_couchdb_albums.zip">Full source for albums couchapp here.</a></p>
		<div class="clear"></div>
	</div><!-- .entry-content-->
	
	<p class="filed categories alt-font tight">Posted in <a href="http://custardbelly.com/blog/category/couchdb/" title="View all posts in CouchDB" rel="category tag">CouchDB</a>,  <a href="http://custardbelly.com/blog/category/jquery/" title="View all posts in jquery" rel="category tag">jquery</a>,  <a href="http://custardbelly.com/blog/category/jquery-mobile/" title="View all posts in jquery-mobile" rel="category tag">jquery-mobile</a>.</p>
	
	

	<!--/by-line-->

	<div id="post-comments-332-target"></div>
	<div class="clear"></div>
	
	